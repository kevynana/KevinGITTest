-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
footer NEW_HDR NEW_FTR
-*04/24/17 DLV S-32644 - New view created for ABTPEXOP
-*05/25/17 -    DLV     - S-34806 - Updated add collection to balance
-*                                  ABEXCH2 and ABLDCO
-* 08/07/2017 RSB S-38044 Place the footer datetime stamp text in a separate file to be -INCLUDED in the stylesheets

-* File SMRYRPT.FEX
-**********************************************************************
-**********************************************************************

SET ASNAMES = ON
-RUN

-INCLUDE SETECHO




DEFINE FILE TOPTVL1
 AC_AMT   /D12.2   = IF TKT_SORT NE LAST TKT_SORT THEN ADDCOLLECT ELSE 0;
 AP_DAYS  /D9      = IF TKT_NUM NE LAST TKT_NUM THEN NEW_ADV_PURCH ELSE 0;
 FARE     /D12.2CS = (FARE_PAID * (-1));
 PNLTY_AMT/D12.2CS = 0;
 ORGSALE  /D12.2CS =  IF TKT_NUM NE LAST TKT_NUM THEN FARE_PAID2 ELSE 0;
 C_ITIN2  /A67     = IF C_ITIN EQ ' ' THEN 'MISCELL. CHARGE -MCO' ELSE C_ITIN;
END
TABLE FILE TOPTVL1
  PRINT  
  TKT_DATE
  C_ITIN2 AS 'C_ITIN'  
  AP_DAYS
  TKT_NUM 
  DOC_NUMBER 
  DOC_TYPE
  EXCHG_SALE
  ADDCOLLECT
  EX_FLAG
  VAL_AIRLINE
  PNLTY_AMT
  AC_AMT
  FST_DPT_DATE
  FARE 
  ORGSALE
  NET_TKT_CNT
  PASSNGR_NAME
  PNR_LOCATOR
  TKT_PURCH
  EXG_ISS
  PEXG_ISS1 AS 'PEXG_ISS'
  INTL_DOM AS 'IDOM' 
BY XPSNGR_NM 
BY TKT_NUM NOPRINT
BY TKT_SORT

BY TRN_DATE
WHERE EX_FLAG NE ' '
ON TABLE HOLD AS EXHOLD FORMAT FOCUS
END
-RUN   



 

-*
 
DEFINE FILE TOPTVL1
 PNLTY_AMT/D12.2  = IF TKT_SORT NE LAST TKT_SORT THEN AIRLINE_FEE ELSE 0;
 DOCNBR   /A9     = EDIT(DOC_NUMBER, '$999999999');
 AP_DAYS /D9      = IF TKT_NUM NE LAST TKT_NUM THEN NEW_ADV_PURCH ELSE 0;
 FARE    /D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN FARE_PAID2 ELSE 0;
 ORGSALE /D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN ORG_SALE ELSE 0;
-* AC_AMT  /D12.2CS = IF ORGSALE GT FARE THEN 0 ELSE FARE - ORGSALE;
 AC_AMT/D12.2CS = IF ORGSALE EQ 0 THEN 0 ELSE
                  IF ORGSALE GT FARE THEN 0 ELSE FARE - ORGSALE;
 C_ITIN2 /A67     = IF C_ITIN EQ ' ' THEN 'MISCELL. CHARGE -MCO' ELSE C_ITIN;
END
-*
TABLE FILE TOPTVL1
PRINT  
  TKT_DATE 
  C_ITIN2 AS 'C_ITIN'  
  AP_DAYS
  TKT_NUM 
  DOC_NUMBER 
-*
-* RBaker 3/02/2016 - add DOC_TYPE for new logic in EX_CNT define.
  DOC_TYPE
-* RBaker 3/04/2016 - add EXCHG_SALE and ADDCOLLECT for determining 'OUT OF POCKET EXPENSES' or OFARE.
  EXCHG_SALE
  LST.ADDCOLLECT
-*
  EX_FLAG
  VAL_AIRLINE 
  PNLTY_AMT
  AC_AMT 
  FST_DPT_DATE
  FARE 
  ORGSALE
  NET_TKT_CNT
  PASSNGR_NAME
  PNR_LOCATOR
  TKT_PURCH
  EXG_ISS
  PEXG_ISS1 AS 'PEXG_ISS'
  INTL_DOM AS 'IDOM'
BY XPSNGR_NM 
BY TKT_SORT
BY TRN_DATE 
WHERE ((EXCHG_SALE NE ' ') AND (SEG_COUNT GE 0)) OR
((EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0)) 
WHERE EX_FLAG EQ ' '
ON TABLE HOLD AS EXHOLD2 FORMAT FOCUS
END
-RUN





-*

-SET &HLDPATH=TEMPPATH(50,'A50');
-SET &HNKA=&HLDPATH || 'EXHOLD.FOC';
-SET &HNKB=&HLDPATH || 'EXHOLD2.FOC';
-RUN

-SET &FILENAME = 'EXHOLD'; 
-RUN

-DOS STATE &HNKA
-SET &HOLDFILEA = IF &RETCODE.EVAL EQ 0 THEN &HNKA | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKB
-SET &HOLDFILEB = IF &RETCODE.EVAL EQ 0 THEN &HNKB | ' AS ' | &FILENAME ELSE ' ';

USE ADD 
&HOLDFILEA
&HOLDFILEB
END
-RUN


TABLE FILE EXHOLD
SUM
  TKT_NUM
  PASSNGR_NAME
  TKT_DATE 
  FST_DPT_DATE
  EX_FLAG
  TRN_DATE
  AP_DAYS
  FARE 
  C_ITIN  
  AC_AMT
  PNLTY_AMT
  VAL_AIRLINE 
  ORGSALE
  NET_TKT_CNT
  PNR_LOCATOR
  TKT_PURCH
  EXG_ISS
  PEXG_ISS
  IDOM
-*
-* RBaker 3/02/2016 - add DOC_TYPE for new logic in EX_CNT define.
  DOC_TYPE
-* RBaker 3/04/2016 - add EXCHG_SALE and ADDCOLLECT for determining 'OUT OF POCKET EXPENSES' or OFARE.
  EXCHG_SALE
  LST.ADDCOLLECT
-*
BY XPSNGR_NM  
BY TKT_SORT
BY TKT_NUM NOPRINT
BY DOC_NUMBER  
BY TKT_DATE NOPRINT
BY TRN_DATE NOPRINT
ON TABLE HOLD AS EXAIRHLD
END
-RUN





-*

DEFINE FILE EXAIRHLD ADD
 TRN_DT/MDYY = IF EX_FLAG NE ' ' THEN TRN_DATE ELSE '        ';
 ADD_COLL/D12.2CS = IF EX_FLAG EQ ' ' THEN AC_AMT ELSE 0;
-* XPSNGR_NM/A10 = EDIT(PASSNGR_NAME, '9999999999');
 KEY/A1 = 'A';
 KEY2/A1 = 'B';
-*03/18/16 - DEB - ADDED FARE DEFINE
FARE/D12.2CS = IF EX_FLAG EQ 'P' OR 'F' THEN ORGSALE ELSE FARE;
END
-*
TABLE FILE EXAIRHLD
SUM 
 TKT_NUM
 PASSNGR_NAME  
 TKT_DATE  
 FST_DPT_DATE  
 EX_FLAG  
 TRN_DT    
 AP_DAYS  
 FARE  
 C_ITIN  
 ADD_COLL 
 PNLTY_AMT  
 TKT_SORT 
 DOC_NUMBER
-*
-* RBaker 3/02/2016 - add DOC_TYPE for new logic in EX_CNT define.
 DOC_TYPE
-* RBaker 3/04/2016 - add EXCHG_SALE and ADDCOLLECT for determining 'OUT OF POCKET EXPENSES' or OFARE.
  EXCHG_SALE
  LST.ADDCOLLECT
-*
 EX_FLAG
 NET_TKT_CNT
 PNR_LOCATOR
 TKT_PURCH
 EXG_ISS
 PEXG_ISS
 IDOM
BY XPSNGR_NM 
BY KEY
BY TKT_NUM  
BY TRN_DATE
WHERE EX_FLAG NE ' '
ON TABLE HOLD AS EXHOLD3 FORMAT FOCUS
END
-RUN





TABLE FILE EXAIRHLD
SUM 
 TKT_NUM
 PASSNGR_NAME  
 TKT_DATE  
 FST_DPT_DATE  
 EX_FLAG  
 TRN_DT    
 AP_DAYS  
 FARE  
 C_ITIN  
 ADD_COLL 
 PNLTY_AMT  
 TKT_SORT 
 DOC_NUMBER
 DOC_TYPE
  EXCHG_SALE
 LST.ADDCOLLECT 
 EX_FLAG
 NET_TKT_CNT
 PNR_LOCATOR
 TKT_PURCH
 EXG_ISS
 PEXG_ISS
 IDOM
BY XPSNGR_NM 
BY KEY2 AS 'KEY' 
BY TKT_NUM  
BY TRN_DATE
WHERE EX_FLAG EQ ' '
ON TABLE HOLD AS EXHOLD4 FORMAT FOCUS
END
-RUN


-*


USE CLEAR *
-RUN

-SET &HLDPATH=TEMPPATH(50,'A50');
-SET &HNKC=&HLDPATH || 'EXHOLD3.FOC';
-SET &HNKD=&HLDPATH || 'EXHOLD4.FOC';
-RUN

-SET &FILENAME = 'EXHOLD3'; 
-RUN

-DOS STATE &HNKC
-SET &HOLDFILEC = IF &RETCODE.EVAL EQ 0 THEN &HNKC | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKD
-SET &HOLDFILED = IF &RETCODE.EVAL EQ 0 THEN &HNKD | ' AS ' | &FILENAME ELSE ' ';

USE ADD 
&HOLDFILEC
&HOLDFILED  
END
-RUN

DEFINE FILE EXHOLD3
 PEX_FLAG  /A1     = IF PEXG_ISS NE 0 THEN 'Y' ELSE 'N';
 PEX_FLAG1 /A1     = IF  PEX_FLAG EQ 'Y' THEN 'Y' ELSE 'N';
 PEX_FLAG2 /A1     = IF PEX_FLAG EQ 'Y' AND PEX_FLAG1 EQ 'Y'  THEN 'Y' ELSE 'N';
 PEX_FLAG3 /A1     = IF PEX_FLAG2 EQ 'Y' AND PEX_FLAG NE LAST PEX_FLAG THEN 'Y' ELSE 'N';
 PEX_CNT2  /D12CS  = IF PEX_FLAG3 EQ 'Y' THEN PEXG_ISS ELSE 0;
 NPEX_FLAG5/A1     = IF TKT_NUM NE LAST TKT_NUM THEN 'Y' ELSE
                     IF TKT_NUM EQ LAST TKT_NUM AND EX_FLAG NE LAST EX_FLAG THEN 'Y' ELSE  'N'  ;
 NPEX_CNT2 /D12CS  = IF NPEX_FLAG5 EQ 'Y' THEN PEXG_ISS ELSE 0;
 PEX_CNT   /D12CS  = IF NPEX_CNT2 EQ 0 AND PEX_CNT2 NE 0 THEN PEX_CNT2 ELSE NPEX_CNT2;
 OFARE2/D12.2C = IF  (EXCHG_SALE EQ ' ') THEN FARE ELSE ADDCOLLECT;
       
END
-*
TABLE FILE EXHOLD3
PRINT TKT_NUM
 PASSNGR_NAME  
 TKT_DATE  
 FST_DPT_DATE  
 EX_FLAG  
 TRN_DT    
 AP_DAYS  
 FARE  
 C_ITIN  
 ADD_COLL 
 PNLTY_AMT  
 TKT_SORT 
 DOC_NUMBER
 DOC_TYPE
 EXCHG_SALE
 ADDCOLLECT
 EX_FLAG
 NET_TKT_CNT
 PNR_LOCATOR
 TKT_PURCH
 EXG_ISS
 PEXG_ISS
 PEX_FLAG
 PEX_FLAG1
 PEX_FLAG2
 PEX_FLAG3
 NPEX_FLAG5
 PEX_CNT
 NPEX_CNT2
 IDOM
 TKT_NUM
 OFARE2
BY XPSNGR_NM 
BY TKT_NUM
BY KEY
BY TRN_DATE
ON TABLE HOLD AS EXHOLD5
END
-RUN

DEFINE FILE EXHOLD5
OFARE/D12.2C = IF (TKT_NUM EQ LAST TKT_NUM) AND (EX_FLAG EQ 'P') THEN OFARE2 ELSE
               IF (TKT_NUM NE LAST TKT_NUM) THEN OFARE2 ELSE 0;
END
TABLE FILE EXHOLD5
PRINT TKT_NUM
 PASSNGR_NAME  
 TKT_DATE  
 FST_DPT_DATE  
 EX_FLAG  
 TRN_DT    
 AP_DAYS  
 FARE  
 C_ITIN  
 ADD_COLL 
 PNLTY_AMT  
 TKT_SORT 
 DOC_NUMBER
 DOC_TYPE
 EXCHG_SALE
 ADDCOLLECT
 EX_FLAG
 NET_TKT_CNT
 PNR_LOCATOR
 TKT_PURCH
 EXG_ISS
 PEXG_ISS
 PEX_FLAG
 PEX_FLAG1
 PEX_FLAG2
 PEX_FLAG3
 NPEX_FLAG5
 PEX_CNT
 NPEX_CNT2
 IDOM
 TKT_NUM
 OFARE2
 OFARE
 OFARE AS 'TOFARE'
 KEY
 TRN_DATE
BY XPSNGR_NM 
BY TKT_NUM
BY EX_FLAG
ON TABLE HOLD AS EXHOLD6
END
-RUN


TABLE FILE EXHOLD6
SUM EXG_ISS PEXG_ISS FARE   PNLTY_AMT ADD_COLL  OFARE TOFARE
BY PASSNGR_NAME
ON TABLE HOLD AS RANKHLD1
END
-RUN
 



-SET &&RANK_METH = TOFARE;

 


TABLE FILE RANKHLD1
SUM EXG_ISS PEXG_ISS FARE   PNLTY_AMT ADD_COLL  OFARE
RANKED BY HIGHEST &&RANK_METH
BY PASSNGR_NAME
ON TABLE HOLD AS RNKHLD2
END
-RUN




-SET &&RANK_LIMIT = 30;

DEFINE FILE RNKHLD2
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  LIST/D9 = (LAST LIST + 1);
  CRANKX/A11 = FTOA(LIST, '(D9)', 'A11');
  CRANK/A9 = EDIT(CRANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE 
                  IF LIST GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                  CRANK;
  RANK_VAL/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE
                IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE
                ARANK;
  RANK_LAB1/A60 = IF RANK_VAL NE 'ALL OTHER' THEN &&RANK_LABEL1
                  ELSE 'ALL OTHER';
  RANK_LABEL1/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2
                      ELSE ' ';
  RANK_LABEL3/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3
                      ELSE ' ';
NOWTOD/A8 WITH RANK = HHMMSS (NOWTOD);
END
-RUN

 





-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADER' ELSE 'HDREXLS'; 
-SET &&PASTYS = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE &&SMSTY;
-RUN
DEFINE FILE RNKHLD2
 NOWTOD   /A8 WITH TKT_NUM = HHMMSS (NOWTOD);


END
TABLE FILE RNKHLD2
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;


 

    &&S_SUBJ1
    &&S_SUBJ2
    &&S_SUBJ3
    &&S_SUBJ4
    &&S_SUBJ5
    &&S_SUBJ6
    &&S_SUBJ7
    &&S_SUBJ8
    &&S_SUBJ9
    &&S_SUBJ10
    
-*BY
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
   
-*ON
   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10

 


-SET &FTR_AddlLines = 5; 
FOOTING BOTTOM
"</2"
"THE FEES COLUMN ARE FORFEIT/PENALTY AMOUNTS"
"AIRLINE FEES ARE INCLUDED IN FEES ALONG WITH FORFEITED AMOUNTS"
-*"FARE PAID IS THE NET AMOUNT OF NEW EXCHANGE SALE MINUS ORIGINAL SALE AMOUNT"
-*"FARE PAID INCLUDES FEES"
-*
-INCLUDE FOOTERSM
-* 
-*******
-OTHER1
-*******

-* ON TABLE COLUMN-TOTAL
-*ON TABLE SET STYLE &&SMSTY
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**********************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
 

-XLSTYP;
ON TABLE SET STYLE *
-INCLUDE &&PASTYS
-IF &&DRILLABLE EQ 'N' GOTO SKIP_DRILL2;
-INCLUDE &&DSTY

-SKIP_DRILL2

ENDSTYLE
&&OUTLINE1
&&SUMMDEST
&&OUTLINE2
END
-RUN

-IF &&DRILLABLE EQ 'Y' GOTO SKIP_R31P;

EX REPORT_3

-SKIP_R31P
-GOTO XXIT 





-XXIT

