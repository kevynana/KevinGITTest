-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* Created for the new quarterly review - JK 8/2/05
-******************************************************************************
-INCLUDE SETECHO
SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-*-SET &SVGFILE = ' ';
-*-SET &&GIF.&SVGFILE= ' ';
-*-SET &IDFLG = ' ';
-*-SET &GRAPHSAVE = ' ';
-*-SET &&CARIG = ' ';

DEFINE FILE &&EXTRACT 

FARE_PAID/D12     = SEG_AMT + SEG_TAX;
  
NET_TKT_CNT/D12    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (SEG_COUNT EQ 1) AND
                           (FARE_PAID GE 0) AND
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (SEG_COUNT EQ -1) AND
                           (EX_FLAG EQ 'F')
                         THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (SEG_COUNT EQ -1) AND 
                           (RF_FLAG EQ 'F')
                         THEN (-1) ELSE 0;
CLIENTCODE/A8 = '&&ROLLUP.EVAL'; 
TKT_AMOUNT/D12    = TICKET_AMT + TAX_AMT;
DECLINE_AMT/D12    = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         TKT_AMOUNT - LOWEST_AMT;
DISSAVINGS/D12.2  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST; 
              
                         
SPACE/A1 = '-';
SPACE1/A1 = ' ';
REF_DESC/A40 = LCWORD(40, REFUSAL_DESC, REF_DESC);
REASON/A45 = REFUSE_CODE||SPACE1|SPACE|SPACE1|REF_DESC;



-INCLUDE QRFTRANA
-* TRAN/QY = TRN_DATE;
END


TABLEF FILE &&EXTRACT
PRINT AIR_MAIN.INTL_DOM AS 'INT_DOM' 
      FARE_PAID
      NET_TKT_CNT
      CLIENTCODE AS 'ROLLUP_CODE'      
      TKT_AMOUNT
      DECLINE_AMT
      DISSAVINGS
      CURRENT
      PRIOR
      PYTD       
      REFUSE_CODE
      REF_DESC      
      REASON
      SEG_LOWEST
      TRAN
      TRN_DATE
      YEAR
WHERE (TRN_DATE GE '&&FROMDT.EVAL') AND (TRN_DATE LE '&&TODT.EVAL') OR
      (TRN_DATE GE '&&FXDATE.EVAL') AND (TRN_DATE LE '&&TXDATE.EVAL')
WHERE VOID.VOID_DATE EQ 0
-IF &&INTDOM EQ 'T' THEN GOTO SKIPIT;
WHERE AIR_MAIN.INTL_DOM EQ '&&INTDOM.EVAL'

-SKIPIT
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-INCLUDE RPTPARMS

ON TABLE HOLD AS BASELSD
END
-RUN

-SET &&NOLSTSAV = IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-IF &LINES EQ 0 THEN GOTO NOLSTSAV;

TABLE FILE BASELSD
SUM DISSAVINGS  
    REASON
    FARE_PAID
    NET_TKT_CNT
    PYTD CURRENT
BY ROLLUP_CODE
BY YEAR
BY TRAN
BY REFUSE_CODE
ON TABLE HOLD AS BHOLD1
END
-RUN


TABLE FILE BHOLD1
PRINT ROLLUP_CODE YEAR TRAN REFUSE_CODE DISSAVINGS REASON FARE_PAID NET_TKT_CNT PYTD CURRENT
ON TABLE SAVE
END
-RUN

MODIFY FILE QRLS
FIXFORM ROLLUP_CODE/8 YEAR/4 TRAN/7 REFUSE_CODE/2 DISSAVINGS/12 REASON/45 FARE_PAID/12 NET_TKT_CNT/12 PYTD/1 CURRENT/1
MATCH ROLLUP_CODE YEAR TRAN REFUSE_CODE
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN


TABLE FILE QRLS
SUM DISSAVINGS 
    REASON
BY ROLLUP_CODE    
BY YEAR
BY REFUSE_CODE
WHERE ROLLUP_CODE EQ '&&BASEROLL.EVAL'
WHERE CURRENT EQ 'Y'
ON TABLE HOLD AS RNKHLD1
END
-RUN

-SET &&NOLSTSAV = IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-IF &LINES EQ 0 THEN GOTO NOLSTSAV;

TABLE FILE RNKHLD1
SUM DISSAVINGS
    REASON
RANKED BY HIGHEST DISSAVINGS NOPRINT 
BY ROLLUP_CODE
BY YEAR
BY REFUSE_CODE
ON TABLE HOLD AS RNKHLD2
END
-RUN

DEFINE FILE RNKHLD2
  LIST/D9 = IF REFUSE_CODE NE LAST REFUSE_CODE
            THEN (LAST LIST + 1) ELSE LAST LIST;
  DRANK/D9 = RANK;
  ARANK/A11 = FTOA(DRANK, '(D9)', ARANK);
  ARANK1/A9 = EDIT(ARANK, '$$999999999');
  RANK_VALUE/A9 = IF LIST GT 7 THEN 'Other' ELSE ARANK1;
  RANK_LABEL/A9 = IF RANK_VALUE NE 'Other' THEN REFUSE_CODE
                      ELSE 'Other';
 END
-RUN
 
TABLE FILE RNKHLD2
SUM DISSAVINGS
    REASON
BY ROLLUP_CODE
BY RANK_VALUE
BY RANK_LABEL
ON TABLE HOLD AS RNKHLD3
END
-RUN


DEFINE FILE RNKHLD3
REF_CD/A2 = EDIT(RANK_LABEL, '99$$$$$$$');
RC/A4 =  '''' |REF_CD|'''';
END
TABLE FILE RNKHLD3
PRINT RC
BY RANK_LABEL NOPRINT
WHERE RANK_VALUE NE 'Other'
WHERE DISSAVINGS NE 0
ON TABLE SAVE AS TOPLS
END
-RUN


-SET &&NOLSTSV2 = IF &LINES EQ 0 THEN 'N' ELSE 'Y';

-IF &LINES EQ 0 THEN GOTO NOLSTSAV1;



TABLE FILE BASELSD
BY TRAN
ON TABLE HOLD AS BASETRAN
END
-RUN

-NOLSTSAV 

-NOLSTSAV1