-* File PRGEQTRN.FEX

SET ASNAMES=ON

-* CHANGE THE FOLLOWING TWO DATES TO THE START OF THE NEXT QUARTER
-* NOT PURGED

-* UPDATE QUARTER TO CORRECT QUARTER THAT NEEDS TO BE PURGED

-SET &&PRGDATE = '''2009/07/01''';
-SET &&DATEPRG = '''07/01/2009''';
-SET &&DATPATH = 'D:\STEVE\PURGE\NEW\';
-SET &&QTR = '0';


-* -GOTO STOP

COPY D:\TNT\TTRACKER\SUDATA\ROLLUP.* D:\STEVE\PURGE\NEW\
COPY D:\TNT\TTRACKER\SYSTEM\DATA\INDUSTRY.* D:\STEVE\PURGE\NEW\
END


USE
D:\STEVE\PURGE\NEW\ROLLUP.FOC AS ROLLUP
D:\STEVE\PURGE\NEW\INDUSTRY.FOC AS INDUSTRY
END

TABLE FILE ROLLUP
PRINT ROLLUP PR_STAMP
BY ROLLUP NOPRINT
ON TABLE HOLD
END
-RUN

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP=' ';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END

TABLE FILE ROLLUP
PRINT ROLLUP
      PR_STAMP
      COMP
BY ROLLUP NOPRINT
WHERE UPD_ENABLE EQ 'X'
WHERE QTR_ENABLE EQ 'X'
WHERE ROLLUP NE 'TOTAL-R'
WHERE ROLLUP NE 'USG-R'
WHERE START_DATE LT &&DATEPRG.EVAL
ON TABLE HOLD
END
-RUN

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP='W';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END

-PRGLOOP
USE
D:\STEVE\PURGE\NEW\ROLLUP.FOC AS ROLLUP
END

TABLE FILE ROLLUP
PRINT ROLLUP COMP
BY ROLLUP NOPRINT
WHERE RECORDLIMIT EQ 1
WHERE PR_STAMP EQ 'W'
ON TABLE SAVE AS CUSTS
END
-IF &RECORDS EQ 0 GOTO STOP;
-RUN
-READ CUSTS &&ROLLUP.A8 &&COMP.A6.
-RUN

-SET &&COPYF = 'D:\TNT\TTRACKER\DATA\*'||&&QTR||&&COMP|||'.FOC';
-SET &&COPYM = 'D:\TNT\TTRACKER\DATA\*'||&&QTR||&&COMP|||'.MAS';
-SET &&COPYOLD = 'D:\STEVE\PURGE\OLD\';
-SET &&COPYNEW = 'D:\STEVE\PURGE\NEW\';

COPY &&COPYF &&COPYOLD
COPY &&COPYM &&COPYOLD
COPY &&COPYF &&COPYNEW
COPY &&COPYM &&COPYNEW

TABLE FILE ROLLUP
PRINT ROLLUP
      PR_STAMP
BY ROLLUP NOPRINT
WHERE ROLLUP EQ '&&ROLLUP'
ON TABLE HOLD
END
MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP='Z';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN

-SET &&PRGSEG = &&COPYNEW||'S' || &&QTR || &&COMP;
-SET &&PRGMKT = &&COPYNEW||'M' || &&QTR || &&COMP;
-SET &&PRGDST = &&COPYNEW||'D' || &&QTR || &&COMP;
-SET &&PRGAIR = &&COPYNEW||'A' || &&QTR || &&COMP;
-SET &&PRGCAR = &&COPYNEW||'C' || &&QTR || &&COMP;
-SET &&PRGHTL = &&COPYNEW||'H' || &&QTR || &&COMP;
-SET &&PRGTKT = &&COPYNEW||'T' || &&QTR || &&COMP;


-TYPE PRGSEG &&PRGSEG
-TYPE PRGMKT &&PRGMKT
-TYPE PRGDST &&PRGDST
-TYPE PRGAIR &&PRGAIR
-TYPE PRGCAR &&PRGCAR
-TYPE PRGHTL &&PRGHTL
-TYPE PRGTKT &&PRGTKT


-********************************

-*=======================================================================
-*                 CREATE DATA FILES FOR PROCESSING
-*=======================================================================

CREATE FILE &&PRGSEG
CREATE FILE &&PRGMKT
CREATE FILE &&PRGDST
CREATE FILE &&PRGAIR
CREATE FILE &&PRGCAR
CREATE FILE &&PRGHTL
CREATE FILE &&PRGTKT
-RUN

SET ASNAMES=ON
DEFINE FILE ROLLUP
XL01/A1 = 'Z' ;
END
TABLE FILE ROLLUP
BY ROLLUP NOPRINT
PRINT ROLLUP AS 'ROLLUP_CODE'
      XL01   AS 'PR_STAMP'
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE HOLD
END
MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
-GOTO PRGLOOP
-RUN
-*======================================================================

-STOP

USE
D:\STEVE\PURGE\NEW\ROLLUP.FOC AS ROLLUP
END

DEFINE FILE ROLLUP
NEW_DATE/MDYY = &&DATEPRG.EVAL
END

TABLE FILE ROLLUP
PRINT ROLLUP NEW_DATE AS 'START_DATE'
WHERE PR_STAMP EQ 'Z'
ON TABLE HOLD
END

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP=' ';
ON MATCH UPDATE PR_STAMP
ON MATCH UPDATE START_DATE
ON NOMATCH REJECT
DATA ON HOLD
END

-* -SET &&FILE = 'D:\STEVE\PURGE\OLD\'||&&PRGDATE||'.ZIP';

-* -DOS PKZIP25 -ADD &&FILE D:\STEVE\PURGE\OLD\*.*
-* -RUN

-* -DOS DEL /Q D:\STEVE\PURGE\OLD\*.FOC
-* -RUN

-* -DOS DEL /Q D:\STEVE\PURGE\OLD\*.MAS
-* -RUN

-TYPE EXITING

-EXIT

-***********************
-* Copy to GOTHAM GRINDS to Update in Production
-* Update ROLLQTR

-* Need to update ROLLQTR with the correct date ranges
TABLE FILE ROLLQTR
PRINT ROLLUP Q5FMDT Q5TODT
ON TABLE HOLD
END

MODIFY FILE ROLLQTR
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE Q5FMDT='20110101';
ON MATCH UPDATE Q5FMDT
ON MATCH COMPUTE Q5TODT='20100331';
ON MATCH UPDATE Q5TODT
ON NOMATCH REJECT
DATA ON HOLD
END
-EXIT



































