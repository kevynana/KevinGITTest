-************************************************************************************
-
-************************************************************************************
-* JK - Updated to pass passenger name selection from screen if utilized
-* DV - Updated to check for presence of misc fee and presence of 
-*      name selection and updated code if multiple selections made 12/13/13
-* 4/11/14 - DEB - ADDED TASF_TKT_NUM 
-* 6/18/14 - DEB - ADDED GOTO TO SKIP TASF_TKT_NUM IF DVSETF IS BEING RAN
-*                 BECAUSE THIS FIELD IS NOT ON THE COMPOUND REPORT
-* 9/26/14 - DEB - CORRECTED ISSUE WITH MISC FEE FILE NOT WORKING CORRECTLY

-DEFAULT &&TOTPAX = 0;
-DEFAULT &&PAXN1 = ' ';
-DEFAULT &&PAXN2 = ' ';
-DEFAULT &&PAXN3 = ' ';
-DEFAULT &&PAXN4 = ' ';
-DEFAULT &&PAXN5 = ' ';
-INCLUDE SETECHO 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-IF '&&SETF.EVAL' EQ 'HREXPNS' THEN GOTO CCspec;


TABLE FILE PFHOLDM
PRINT TRN_TYPE TRN_DATE FEE_SRC FEE_AMT PAY_METHOD CREDIT_CARD FST_DPT_DATE CNT TASF_TKT_NUM
BY MISC_KEY
WHERE MISC_KEY NE ' '
ON TABLE HOLD AS MISCFEE
END
-RUN

-SET &&MFEE = IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';

-* CHECK FOR NAME SELECTION

TABLE FILE BRPTFLDS
-*PRINT SEG AIRFLDS.PASSENGER
PRINT AIRFLDS.SEQ_NO PASSENGER
IF INST_KEY EQ &&IKEY
ON TABLE HOLD  
END
-RUN
 
DEFINE FILE HOLD
PAXL/I2 = ARGLEN(33, PASSENGER, 'I2');
PAXN/A12 = EDIT(PASSENGER, '999999999999');
END
TABLE FILE HOLD
PRINT  PAXN
ON TABLE SAVE AS PKEY 
END
-RUN
 


-IF &LINES EQ 0 THEN GOTO XEXIT;
-SET &PAXCNT = &LINES;
-SET &&TOTPAX = &LINES;
-SET &CNT = 1;
-REPEAT TOEND &LINES TIMES     
-READ PKEY NOCLOSE  &PAXN.A12.
-SET &&PAXN.&CNT = &PAXN;
 
-SET &CNT = &CNT + 1;
-TOEND
-CLOSE PKEY

-XEXIT;
-SET &&MFEEPAX = IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';
 

-GOTO Continue;

-CCspec
TABLE FILE PFHOLDM
PRINT TRN_TYPE TRN_DATE FEE_SRC FEE_AMT PAY_METHOD CREDIT_CARD FST_DPT_DATE CNT TASF_TKT_NUM
BY MISC_KEY
WHERE MISC_KEY NE ' '
WHERE CREDIT_CARD CONTAINS '3122361602'
ON TABLE HOLD AS MISCFEE
END
-RUN
-Continue

 

-IF '&&MFEE.EVAL' EQ 'N'  THEN GOTO MiscXXIT;
 
DEFINE FILE MISCFEE
PASSNGR_NAME/A33 = EDIT(MISC_KEY, '$$$$$$$999999999999999999999999999999999');
INVOICE_NUM/A7= EDIT(MISC_KEY, '9999999');
TEST/A35 = EDIT(MISC_KEY, '$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99999999999999999999999999999999999');
XL01/I2 = POSIT(MISC_KEY, 75, '4', 1, 'I2');
TEST2/I2= POSIT(TEST, 35, '-', 1, 'I2'); 
DASH3/A15 = GETTOK(TEST, 35, 3, '-', 15, DASH3);
DASH2/A15 = GETTOK(TEST, 35, 2, '-', 15, DASH2);
DASH4/A60 = '                                                            ';
CATEGORY/A15 = '               ';
LEVEL1/A15 = EDIT(TEST, '$$$$$$999999999999999');
PNR_LOCATOR/A6 = '      ';
TKT_NUM/A30 = '                              ';
TSORT/A11 = '           ';
TYPE/A3 = 'SAL';
XFST_DT/MDYY         = FST_DPT_DATE;
DATE2/MDYY = FST_DPT_DATE;
DATA_V1/A9 = '*********';
DV_NUM2/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
DV_NUM/A15 = IF DV_NUM2 EQ ' ' THEN ' ' ELSE DATA_V || DV_NUM2;
AMOUNT/D12.2CS = FEE_AMT;
TTL_COUNT/D12CS = CNT;
ACCT/A8 = '        ';
LEVEL_DESC/A60 = '                                                            ';
GEO_ZONE/A3 = '   ';
TRIP_PURPOSE/A2 = '  ';
TRP_DESC/A40 = '                                        ';
NAME/A3 = '   ';
STATUS/A1 = 'O';
FLAG/A1 = 'M';
CITY1/A25 = 'MISC SVC FEE'; 

SEG/A2 = '  ';
XTRAN_DT/MDYY = TRN_DATE;
BLANK20/A20 = '                    ';
BLANK50/A50 = '                                                  ';
END
TABLE FILE MISCFEE
PRINT PASSNGR_NAME
   PNR_LOCATOR
   XTRAN_DT AS 'TRAN_DATE'
 
   TKT_NUM
   TSORT
   TYPE
   SEG
   NAME
   XFST_DT AS 'DATE'
   DATE2
   CITY1
   DV_NUM
   AMOUNT
   TTL_COUNT
   ACCT
   INVOICE_NUM
   STATUS
   LEVEL_DESC
   LEVEL1
   DASH2 AS 'LEVEL2'
   DASH3 AS 'LEVEL3'
   DASH4 AS 'LEVEL4'
   BLANK20 AS 'LEVEL5'
   BLANK20 AS 'LEVEL6'
   BLANK50 AS 'LEVEL7'
   GEO_ZONE
   TRIP_PURPOSE
   TRP_DESC
   TASF_TKT_NUM
BY FLAG
BY PASSNGR_NAME NOPRINT
ON TABLE HOLD  
END
-RUN


TABLE FILE HOLD
PRINT PASSNGR_NAME
   PNR_LOCATOR
   TRAN_DATE
    TKT_NUM
   TSORT
   TYPE
   SEG
   NAME
   DATE
   DATE2
   CITY1
   DV_NUM
   AMOUNT
   TTL_COUNT
   ACCT
   INVOICE_NUM
   STATUS
   LEVEL_DESC
   LEVEL1
   LEVEL2
   LEVEL3
   LEVEL4
   LEVEL5
   LEVEL6
   LEVEL7
   GEO_ZONE
   TRIP_PURPOSE
   TRP_DESC
   TASF_TKT_NUM
BY FLAG
BY PASSNGR_NAME NOPRINT
ON TABLE HOLD AS HOLDMA FORMAT FOCUS
END
-RUN  



-IF '&&SETF.EVAL' EQ 'DVEXPNS' THEN GOTO NextFile;


TABLE FILE HOLDMA
PRINT PASSNGR_NAME
BY PASSNGR_NAME NOPRINT
ON TABLE SAVE AS PAXFILE
END
-RUN

-READ PAXFILE &&PN.33


TABLE FILE HOLDMA
PRINT PASSNGR_NAME
   PNR_LOCATOR
   TRAN_DATE 
   TKT_NUM
   TSORT
   TYPE
   SEG
   NAME
   DATE
   DATE2
   CITY1
   DV_NUM
   AMOUNT
   TTL_COUNT
   ACCT
   INVOICE_NUM
   STATUS
   LEVEL_DESC
   LEVEL1
   LEVEL2
   LEVEL3
   LEVEL4
   LEVEL5
   LEVEL6
   LEVEL7
   GEO_ZONE
   TRIP_PURPOSE
   TRP_DESC
   TASF_TKT_NUM
   
-*   FEE_AMT
BY FLAG
BY PASSNGR_NAME NOPRINT
-IF '&&MFEEPAX.EVAL' EQ 'N' GOTO NOPAXWHR;
-*WHERE '&&PAX.EVAL' EQ '&&PN.EVAL'
-IF &&TOTPAX.EVAL EQ 1 THEN GOTO ONEPX;
-IF &&TOTPAX.EVAL EQ 2 THEN GOTO TWOPX;
-IF &&TOTPAX.EVAL EQ 3 THEN GOTO THREEPX;
-IF &&TOTPAX.EVAL EQ 4 THEN GOTO FOURPX;
-IF &&TOTPAX.EVAL EQ 5 THEN GOTO FIVEPX;
-ONEPX;
IF PASSNGR_NAME CONTAINS   &&PAXN1.EVAL 
-GOTO NOPAXWHR
-TWOPX;
IF PASSNGR_NAME CONTAINS   &&PAXN1.EVAL  OR  &&PAXN2.EVAL 
-GOTO NOPAXWHR
-THREEPX;
IF PASSNGR_NAME CONTAINS   &&PAXN1.EVAL  OR  &&PAXN2.EVAL  OR  &&PAXN3.EVAL 
-GOTO NOPAXWHR
-FOURPX;
IF PASSNGR_NAME CONTAINS   &&PAXN1.EVAL  OR  &&PAXN2.EVAL  OR  &&PAXN3.EVAL  OR  &&PAXN4.EVAL 
-GOTO NOPAXWHR
-FIVEPX
IF PASSNGR_NAME CONTAINS   &&PAXN1.EVAL  OR &&PAXN2.EVAL  OR &&PAXN3.EVAL  OR  &&PAXN4.EVAL  OR  &&PAXN5.EVAL 
-NOPAXWHR   


ON TABLE HOLD AS HOLDM FORMAT FOCUS 
END
-RUN
 

-GOTO MiscXXIT

-NextFile




 
 

TABLE FILE HOLDMA
PRINT PASSNGR_NAME 
   PNR_LOCATOR
   TRAN_DATE 
   TKT_NUM
   TSORT
   TYPE
   SEG
   NAME
   DATE
   DATE2
   CITY1
   DV_NUM
   AMOUNT
   TTL_COUNT
   ACCT
   INVOICE_NUM
   STATUS
   LEVEL_DESC
   LEVEL1
   LEVEL2    
   LEVEL3
   LEVEL4
   LEVEL5
   GEO_ZONE
   TRIP_PURPOSE
   TRP_DESC
   TASF_TKT_NUM
-*   FEE_AMT
BY FLAG
BY PASSNGR_NAME NOPRINT
-IF '&&MFEEPAX.EVAL' EQ 'N' GOTO NOPAXWHR;
-*WHERE '&&PAX.EVAL' EQ '&&PN.EVAL'
-IF &&TOTPAX.EVAL EQ 1 THEN GOTO ONEPX;
-IF &&TOTPAX.EVAL EQ 2 THEN GOTO TWOPX;
-IF &&TOTPAX.EVAL EQ 3 THEN GOTO THREEPX;
-IF &&TOTPAX.EVAL EQ 4 THEN GOTO FOURPX;
-IF &&TOTPAX.EVAL EQ 5 THEN GOTO FIVEPX;
-ONEPX;
IF PASSNGR_NAME CONTAINS   &&PAXN1.EVAL 
-GOTO NOPAXWHR
-TWOPX;
IF PASSNGR_NAME CONTAINS   &&PAXN1.EVAL  OR  &&PAXN2.EVAL 
-GOTO NOPAXWHR
-THREEPX;
IF PASSNGR_NAME CONTAINS   &&PAXN1.EVAL  OR  &&PAXN2.EVAL  OR  &&PAXN3.EVAL 
-GOTO NOPAXWHR
-FOURPX;
IF PASSNGR_NAME CONTAINS   &&PAXN1.EVAL  OR  &&PAXN2.EVAL  OR  &&PAXN3.EVAL  OR  &&PAXN4.EVAL 
-GOTO NOPAXWHR
-FIVEPX
IF PASSNGR_NAME CONTAINS   &&PAXN1.EVAL  OR &&PAXN2.EVAL  OR &&PAXN3.EVAL  OR  &&PAXN4.EVAL  OR  &&PAXN5.EVAL 
-NOPAXWHR   


 
ON TABLE HOLD AS HOLDM FORMAT FOCUS 

END
-RUN





-MiscXXIT

 

 



 
