-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-INCLUDE SETECHO
-* This extract was created for the Refundable/Non-Refundable
-* Report that breaks out exchanges prior/after departure
-* JK 11/21/02 ADDED DEFINES TO BE ABLE TO SHOW METX NEW REF/NON
-* Added the following defines for Black and Veatch
-* Ex_prior_cnt/Ex_prior_fare/Ex_after_cnt JK 6/4/04
-* ADDED CODE FOR GLOBAL CURRENCY 1/19/05 - DV
-* Changed AUTO_REPORT to NONREF_FLAG - TRX issue - SAC - 06/22/07
-* ADDED TRANTYPE INCLUDE - JK 12/15/14 STORY ID S-06492


SET ASNAMES = ON
-SET HOLDATTR = ON;
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';
-SET &WHATDATE = IF '&&DATETYPE.EVAL' EQ 'I' THEN 'TRN_DATE' ELSE 'FST_DPT_DATE';
DEFINE FILE &&EXTRACT
  
  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;
  LEVEL_DESC/A60 = &&LDESC;
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
 EX_COUNT/D8CS =        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN 1 ELSE 0;
 EX_FARE/D12.2CS =      IF (TICKET_CODE EQ '1') AND
                           (EX_FLAG EQ 'F') THEN FARE_PAID ELSE 0;
 TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
 TRAN_MONTH/MT        = &WHATDATE;
 XDPT_DOW/W           = &WHATDATE;
 XDPT_DT/MDYY         = &WHATDATE;
 XPSNGR_NM/A15        = EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
 XTRAN_DT/MDYY        = &WHATDATE;
 NON_REF/A1 = NONREF_FLAG;
 MNON_REF/A1 = NONREF_FLAG;
 TKT_AMT/D12.2CS = TICKET_AMT + TAX_AMT;
 FLAG/A1 = 'A';

-* ****DEFINES ON PREVIOUS DEFINES****
  NON_REF_FEE/D12.2CS = IF (EMBARK EQ 'FP2' OR 'FP3') AND 
                          (NON_REF EQ 'N') THEN FARE_PAID ELSE 0;
  MNON_REF_FEE/D12.2CS = IF (EMBARK EQ 'FP2' OR 'FP3') AND 
                          (MNON_REF EQ 'N') THEN FARE_PAID ELSE 0;
  NON_CNT/D8CS = IF NON_REF EQ 'N' THEN NET_TKT_CNT ELSE 0;
  MNON_CNT/D8CS = IF MNON_REF EQ 'N' THEN NET_TKT_CNT ELSE 0;
  NON_FARE/D12.2CS = IF NON_REF EQ 'N' THEN FARE_PAID ELSE 0;
  MNON_FARE/D12.2CS = IF MNON_REF EQ 'N' THEN FARE_PAID ELSE 0;
  NEX_PRIOR_CNT/D8CS = IF (NON_REF EQ 'N') AND (TRN_DATE LE DPT_DATE) 
                       THEN EX_COUNT ELSE 0;
  EX_PRIOR_CNT/D8CS = IF TRN_DATE LE DPT_DATE THEN EX_COUNT ELSE 0;
  MNEX_PRIOR_CNT/D8CS = IF (MNON_REF EQ 'N') AND (TRN_DATE LE DPT_DATE) 
                       THEN EX_COUNT ELSE 0;  
  EX_PRIOR_FARE/D12.2CS = IF TRN_DATE LE DPT_DATE THEN EX_FARE ELSE 0;  
  MNEX_PRIOR_FARE/D12.2CS = IF (MNON_REF EQ 'N') AND (TRN_DATE LE DPT_DATE)
                              THEN EX_FARE ELSE 0;
  NEX_PRIOR_FARE/D12.2CS = IF (NON_REF EQ 'N') AND (TRN_DATE LE DPT_DATE)
                              THEN EX_FARE ELSE 0;
  NEX_AFTER_CNT/D8CS = IF (NON_REF EQ 'N') AND (TRN_DATE GT DPT_DATE)
                       THEN EX_COUNT ELSE 0;
  EX_AFTER_CNT/D8CS = IF TRN_DATE GT DPT_DATE THEN EX_COUNT ELSE 0;
  MNEX_AFTER_CNT/D8CS = IF (MNON_REF EQ 'N') AND (TRN_DATE GT DPT_DATE)
                       THEN EX_COUNT ELSE 0;
  NEX_AFTER_FARE/D12.2CS = IF (NON_REF EQ 'N') AND (TRN_DATE GT DPT_DATE)
                       THEN EX_FARE ELSE 0;
  EX_AFTER_FARE/D12.2CS = IF TRN_DATE GT DPT_DATE THEN EX_FARE ELSE 0;
  MNEX_AFTER_FARE/D12.2CS = IF (MNON_REF EQ 'N') AND (TRN_DATE GT DPT_DATE)
                       THEN EX_FARE ELSE 0;
  REF_CNT/D8CS = IF NON_REF NE 'N' THEN NET_TKT_CNT ELSE 0;
  MREF_CNT/D8CS = IF MNON_REF NE 'N' THEN NET_TKT_CNT ELSE 0;
  REF_FARE/D12.2CS = IF NON_REF NE 'N' THEN FARE_PAID ELSE 0;
  MREF_FARE/D12.2CS = IF MNON_REF NE 'N' THEN FARE_PAID ELSE 0;
  DPT_DAY/A3           = DECODE XDPT_DOW (1 'MON' 2 'TUE' 3 'WED'
                                 4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
  TKT_RANGE/A15 = IF (TKT_AMT GT 0) AND (TKT_AMT LE 300) THEN '$0 - 300' ELSE
                  IF (TKT_AMT GE 301) AND (TKT_AMT LE 400) THEN '$301 - $400'
                  ELSE IF (TKT_AMT GE 401) THEN '$401 +';
                     
-INCLUDE TRANTYPE                     
  
END
-RUN

TABLEF FILE &&EXTRACT
PRINT 
  AIR_KEY   
  AIRLINE
  AIRLINE_NAME  
  CLASS
  DPT_TIME
  EMB_CTY.CITY_NAME    AS 'EMB_CTY_NM'  
  EX_COUNT
  FARE_PAID 
  FARE_BAS
  FLAG
  LEVEL_DESC    
  NET_TKT_CNT
  NEX_AFTER_CNT
  EX_AFTER_CNT
  MNEX_AFTER_CNT
  NEX_AFTER_FARE
  EX_AFTER_FARE
  MNEX_AFTER_FARE
  NEX_PRIOR_CNT
  EX_PRIOR_CNT
  MNEX_PRIOR_CNT
  NEX_PRIOR_FARE
  EX_PRIOR_FARE
  MNEX_PRIOR_FARE
  NON_REF
  MNON_REF
  NON_CNT
  MNON_CNT
  NON_FARE
  MNON_FARE
  NON_REF_FEE
  MNON_REF_FEE
  REFUSE_CODE     
  REFUSE_KEY
  REFUSAL_DESC
  RTE_CTY.CITY_NAME    AS 'RTE_CTY_NM'  
  REF_CNT
  MREF_CNT
  REF_FARE
  MREF_FARE
  SEG_NBR
  TKT_DATE
  TKT_NUM
  TKT_RANGE 
  TKT_SORT
  TKT_TYPE  
  TRAN_MONTH
  TRN_DATE     
  XDPT_DT   
  XTRAN_DT  
  XPSNGR_NM
-INCLUDE &AIRDATES
WHERE VOID_DATE EQ 0
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS

ON TABLE HOLD AS DOMNREF

END
-RUN

TABLE FILE DOMNREF
PRINT AIR_KEY   
  AIRLINE
  AIRLINE_NAME  
  CLASS
  DPT_TIME
  EMB_CTY_NM    
  EX_COUNT
  FARE_PAID 
  FARE_BAS
  FLAG
  LEVEL_DESC    
  NET_TKT_CNT
  NEX_AFTER_CNT
  EX_AFTER_CNT
  MNEX_AFTER_CNT
  NEX_AFTER_FARE
  EX_AFTER_FARE
  MNEX_AFTER_FARE
  NEX_PRIOR_CNT
  EX_PRIOR_CNT
  MNEX_PRIOR_CNT
  NEX_PRIOR_FARE
  EX_PRIOR_FARE
  MNEX_PRIOR_FARE
  NON_REF
  MNON_REF
  NON_CNT
  MNON_CNT
  NON_FARE
  MNON_FARE
  NON_REF_FEE
  MNON_REF_FEE
  REFUSE_CODE     
  REFUSE_KEY
  REFUSAL_DESC
  RTE_CTY_NM    
  REF_CNT
  MREF_CNT
  REF_FARE
  MREF_FARE
  SEG_NBR
  TKT_NUM
  TKT_RANGE 
  TKT_SORT
  TKT_TYPE  
  TRAN_MONTH
  TRN_DATE     
  XDPT_DT   
  XTRAN_DT  
  XPSNGR_NM
BY TKT_DATE
ON TABLE HOLD AS DOMNONR FORMAT FOCUS INDEX TKT_DATE
END
-RUN

-* Global Reporting JOIN
JOIN DOMNONR.TKT_DATE IN DOMNONR TO GLOBAL.DATE IN GLOBAL AS J1


DEFINE FILE DOMNONR
NAMEC/A30 = CNAME;

-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
PAID_FAREX/D20.6 = FARE_PAID * CURR1X;
FEE_NONRX/D20.6 = NON_REF_FEE * CURR1X;
FEE_MNONRX/D20.6 = MNON_REF_FEE * CURR1X;
FARE_NONX/D20.6 = NON_FARE * CURR1X;
FARE_MNONX/D20.6 = MNON_FARE * CURR1X;
FARE_EX_PRX/D20.6 = EX_PRIOR_FARE * CURR1X;
FARE_MNEX_PRX/D20.6 = MNEX_PRIOR_FARE * CURR1X;
FARE_NEX_PRX/D20.6 = NEX_PRIOR_FARE * CURR1X;
FARE_EX_AFTRX/D20.6 = EX_AFTER_FARE * CURR1X;
FARE_NEX_AFTRX/D20.6 = NEX_AFTER_FARE * CURR1X;
FARE_MNEX_AFTRX/D20.6 = MNEX_AFTER_FARE * CURR1X;
FARE_REFX/D20.6 = REF_FARE * CURR1X;
FARE_MREFX/D20.6 = MREF_FARE * CURR1X;
 

END
-RUN 

TABLE FILE DOMNONR
PRINT AIR_KEY   
  AIRLINE
  AIRLINE_NAME  
  CLASS
  DPT_TIME
  EMB_CTY_NM    
  EX_COUNT
  FARE_PAID 
  FARE_BAS
  FLAG
  LEVEL_DESC    
  NET_TKT_CNT
  NEX_AFTER_CNT
  EX_AFTER_CNT
  MNEX_AFTER_CNT
  NEX_AFTER_FARE
  EX_AFTER_FARE
  MNEX_AFTER_FARE
  NEX_PRIOR_CNT
  EX_PRIOR_CNT
  MNEX_PRIOR_CNT
  NEX_PRIOR_FARE
  EX_PRIOR_FARE
  MNEX_PRIOR_FARE
  NON_REF
  MNON_REF
  NON_CNT
  MNON_CNT
  NON_FARE
  MNON_FARE
  NON_REF_FEE
  MNON_REF_FEE
  REFUSE_CODE     
  REFUSE_KEY
  REFUSAL_DESC
  RTE_CTY_NM    
  REF_CNT
  MREF_CNT
  REF_FARE
  MREF_FARE
  SEG_NBR
  TKT_DATE
  TKT_NUM
  TKT_RANGE 
  TKT_SORT
  TKT_TYPE  
  TRAN_MONTH
  TRN_DATE     
  XDPT_DT   
  XTRAN_DT  
  XPSNGR_NM
  NAMEC 
  PAID_FAREX/D16.SCS
  FEE_NONRX/D16.2CS
  FEE_MNONRX/D16.2CS
  FARE_NONX/D16.2CS
  FARE_MNONX/D16.2CS
  FARE_EX_PRX/D16.2CS
  FARE_MNEX_PRX/D16.2CS
  FARE_NEX_PRX/D16.2CS 
  FARE_EX_AFTRX/D16.2CS
  FARE_NEX_AFTRX/D16.2CS
  FARE_MNEX_AFTRX/D16.2CS
  FARE_REFX/D16.2CS
  FARE_MREFX/D16.2CS
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS NOND
END
-RUN 

