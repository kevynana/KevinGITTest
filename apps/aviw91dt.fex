
-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* View Created to Produce Conagra reports with 3 or more occurrences.
-* 0-13 Advanced with 3 or more occurrences, Lost savings $200 or more
-* with 3 or more occurrences, Non Visa Usage with 3 or more occurrences
-* Created by JK 10/8/03
-*  02/02/2015  REJ  S-05681 Changes to the no data report to prepare for the Available
-*                           Report changes.  Rollup Code is being removed from BRPTINST in
-*                           ER5, so I'm removing the reference to the ROLLUP_CODE in that report.
-*4/24/2017-JEM-S-33318-updated logic for no records report
-* 08/04/2017 - JEM - S-37368 Updated LOW_AMT field to use SRT_DT instead of TKT_SORT
-*09/28/2017 - JEM - S-35422 Place the footer date/time stamp text in a separate file to be -INCLUDED in the stylesheets

-********************************************************************
SET ASNAMES=ON
-RUN

TABLE FILE &&RPT_HOLD
SUM DISSAVINGS AS 'DTSAVE'	
  FARE_PAID AS 'TFARE'	
  NET_TKT_CNT AS 'TTKT'	 
  SEG_AMT AS 'TSAMT'
  SEG_LOWEST  AS 'TLOW'
  SEG_TAX AS 'TSTAX'
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS AIRHOLD1
END
-RUN

TABLE FILE &&RPT_HOLD
PRINT 
  AIRLINE
  CCARD6
  LEVEL1	
  NEW_ADV_PURCH
  REFUSAL_DESC	
  REFUSE_CODE
  SEG_COUNT	
  TKT_NUM	
  TKT_TYPE
  XDPT_DT	
  XTRAN_DT	
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
BY SEG_NBR
ON TABLE HOLD AS XTWO
END
-RUN

MATCH FILE XTWO
PRINT AIRLINE
      CCARD6	
      LEVEL1	
      NEW_ADV_PURCH
      REFUSAL_DESC	
      REFUSE_CODE
      SEG_COUNT	
      TKT_NUM	
      TKT_TYPE
      XDPT_DT	
      XTRAN_DT
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
BY SEG_NBR
ON TABLE HOLD
RUN
FILE AIRHOLD1
PRINT DTSAVE	
      TFARE	
      TLOW
      TSAMT
      TSTAX	
      TTKT	
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
AFTER MATCH HOLD AS AIRHOLD2 OLD-OR-NEW
END
-RUN

TABLE FILE AIRHOLD2
PRINT AIRLINE
      CCARD6
      LEVEL_DESC	
      LEVEL1	
      NEW_ADV_PURCH
      REFUSAL_DESC	
      REFUSE_CODE
      SEG_COUNT	
      TKT_NUM	
      TKT_TYPE
      TRN_DATE
      XDPT_DT	
      XTRAN_DT
      DTSAVE
      TFARE
      TLOW
      TSAMT
      TSTAX
      TTKT
      XDPT_DT
      XPSNGR_NM
      XTRAN_DT
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD3
END
-RUN


TABLE FILE AIRHOLD3
SUM TTKT AS 'TTKT1'
BY XPSNGR_NM
ON TABLE HOLD AS XNAMES
END
-RUN

MATCH FILE AIRHOLD3
PRINT AIRLINE
      CCARD6
      LEVEL_DESC	
      LEVEL1	
      NEW_ADV_PURCH
      REFUSAL_DESC	
      REFUSE_CODE
      SEG_COUNT	
      SEG_NBR
      TKT_NUM	
      TKT_TYPE
      TKT_SORT
      TRN_DATE
      XDPT_DT	
      XTRAN_DT
      DTSAVE
      TFARE
      TLOW
      TSAMT
      TSTAX
      TTKT
      XDPT_DT
      XPSNGR_NM
      XTRAN_DT
BY XPSNGR_NM
ON TABLE HOLD
RUN
FILE XNAMES
SUM TTKT1
BY XPSNGR_NM
AFTER MATCH HOLD AS NAMEST OLD-OR-NEW
END
-RUN


DEFINE FILE NAMEST
PSNGR_CNT/A1=IF TTKT1 GE 3 THEN 'Y' ELSE 'N';
END
TABLE FILE NAMEST
PRINT AIRLINE
      CCARD6
      LEVEL_DESC	
      LEVEL1	
      NEW_ADV_PURCH
      REFUSAL_DESC	
      REFUSE_CODE
      SEG_COUNT	
      TKT_NUM	
      TKT_TYPE
      XDPT_DT	
      XTRAN_DT
      DTSAVE
      TRN_DATE
      TFARE
      TLOW
      TSAMT
      TSTAX
      TTKT
      XDPT_DT
      XPSNGR_NM
      XTRAN_DT
WHERE PSNGR_CNT EQ 'Y'
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS MULTIOFF
END
-RUN

-IF &&NRECDT EQ 'Y' THEN GOTO NORECORDS;


DEFINE FILE MULTIOFF

  NET_TKT_CNT/D9S = IF (SEG_NBR EQ '01') THEN  TTKT ELSE 0;
  RADV_PURCH/I8CS = IF (SEG_NBR EQ '01') THEN NEW_ADV_PURCH ELSE 0;
  XT_DTE/A8=EDIT(TRN_DATE);
  XTKT_SRT/A10 = EDIT(TKT_SORT,'9999999999$');
 -* ****DEFINES ON PREVIOUS DEFINES****
  SRT_DT/A100 = TKT_SORT||XT_DTE||LEVEL_DESC||XPSNGR_NM;
  FARE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TFARE ELSE 0;
  NOWTOD/A8 WITH TKT_SORT = HHMMSS(NOWTOD);
  XTS_FLAG/A1 = ' ';
  LOST_SAV_AMT/D10.2CS = IF SRT_DT NE LAST SRT_DT THEN DTSAVE ELSE 0;
  LOW_AMT/D10.2CS = IF SRT_DT NE LAST SRT_DT THEN TLOW ELSE 0;
END


TABLE FILE MULTIOFF
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
-*
-**********************************************************************
-* Print statement with fields passed from the user profile database
-**********************************************************************
-*
&&PRINT1
&&PRINT2
&&PRINT3
&&PRINT4
&&PRINT5
&&PRINT6
&&PRINT7
&&PRINT8
&&PRINT9
&&PRINT10
-*
-**********************************************************************
-* By statements (one per field)
-**********************************************************************
-*
&&BY1
&&BY2
&&BY3
&&BY4
&&BY5
&&BY6
&&BY7
&&BY8
&&BY9
&&BY10
-*
-**********************************************************************
-* On Table statements for code appropriate to On Table commands
-**********************************************************************
-*
&&BREAKOPTION
&&ONTABLE1
&&ONTABLE2
&&ONTABLE3
&&ONTABLE4
&&ONTABLE5
&&ONTABLE6
&&ONTABLE7
&&ONTABLE8
&&ONTABLE9
&&ONTABLE10
-*
-**********************************************************************
-* Report specific footer(s)
-**********************************************************************
-*
-INCLUDE FOOTERDT
-*
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**************************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
-INCLUDE &&PASTYD
ENDSTYLE
-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN

-GOTO XXIT

-NORECORDS
 
-SET &INST_KEY = &&IKEY;

TABLE FILE BRPTINST
PRINT PAIR_DB RPT_GROUP RPT_STREAM GLOBAL_PARM USE_PARM INST_KEY
WHERE INST_KEY EQ &INST_KEY
ON TABLE SAVE AS PAIRDB
END
-RUN

-READ PAIRDB &PAIRDB.A1. &RPTGRP.A3. &RPTSTREAM.A8. &SETFILE.A8. &VIEW.A8.
-CLOSE PAIRDB
 
-SET &RPTGRP = '&RPTGRP.EVAL';
-SET &VIEW = '&VIEW.EVAL';
-SET &STREAM = '&RPTSTREAM.EVAL';

-SET &HEADER = IF &RPTGRP EQ 'ADD' THEN 'NORECHDRDD' ELSE 'NORECHDR';
-RUN


-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN &HEADER ELSE  
-              IF &RPTGRP EQ 'ADD' THEN 'HDREXLSDD' ELSE 
-              IF &STREAM EQ 'AIR_BNM' THEN 'HDREXLSDD' ELSE 'HDREXLS';

-RUN


-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE 'NORECSTY';

JOIN SET_KEY IN BRPTINST TO SET_KEY IN BRPT_SET AS J1
-RUN

DEFINE FILE BRPTINST
EMPTY/A35 = 'NO RECORDS FOUND FOR THIS SELECTION';
NOWTOD/A8 WITH INST_KEY = HHMMSS (NOWTOD);
END
TABLE FILE BRPTINST
-INCLUDE &&PAHDR
PRINT EMPTY AS 'REPORT,MESSAGE'
BY ROLLUP_CODE AS 'ROLLUP,CODE'
BY RPT_NAME AS 'REPORT,NAME'
BY SELECT_LEV AS 'BREAK,LEVEL'
IF INST_KEY EQ &&IKEY
IF RECORDLIMIT EQ 1
-INCLUDE FOOTERDT
ON TABLE SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET PAGE-NUM OFF
ON TABLE SET STYLE *
-INCLUDE &&PASTYD
ENDSTYLE
 
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN
-XXIT
