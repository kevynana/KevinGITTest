
-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-*                     FOCEXEC: AIRRPT
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE

-*9/30/03        DEB                CARRIED THROUGHT EMB_APT_CD RTE_APT_CD 
-*11/25/03       JOY                ADDED CLASS
-*11/09/04       DEB                ADDED CODE FOR GLOBAL CURRENCY
-*6/30/05        DEB                CARRIED THROUGH TRIP_LENGTH
-*9/22/06        DEB                CARRIED THROUGH NEW_ADV_PUR
-*3/24/08        DEB                ADDED CODE FOR CGTOPSLT 
-*2/4/14         DEB                ADDED DEFINE FOR FINAL HOLD FILE SO DATE
-*                                  FIELDS APPEARED CORRECTLY IN EXCEL
-*4/14/14        DEB                CORRECTED DRILLDOWN
-*5/23/14        DEB                ADDED EX5 TO RADV_PURCH DEFINE
-*6/18/15        DEB   S-09823   Coreected issue causing drill down not to work 
-* 6/18/15       DEB   S-09837   CARRIED THROUGH ONL_TKTS DEFINE FOR TMTOPTVL
-* 7/23/2015     DEB   S-10025   Added Pref airline % TMTOPTVL
-* 7/30/15 -  S-10619  added routine for KWTOPDIS 
-* S-12153-JM Corrected Drilldown Font Error 10/14/15
-*11/24/15  Joy    S-07987  Corrected for running Currency Enabled Version
-*12/16/15 - JEM - S-13286 Updated to allow reports to sort/subtotal by id-levels
-*02/10/16 - JEM - S-15559 Added logic for new report KYTOPTVL
-*07/12/16   RSB   S-20630 - New Employee ID database field
-*                           Changed LEVEL1 to EMP_ID in the Defines
-*                           Added EMP_ID to the Table requests
-*07/21/16   DLV   S-20630  Added KWTOPDIS TO &SORT1 routine
-*8/15/16    JEM   S-23085 Added NTLTPTVL to current goto logic and carried through level3
-*11/01/16 - DLV -  S-26024 - Added code for KWTPTLEN to set ranking method
-* 08/04/2017 - JEM - S-37368 Updated LOW_AMT field to use SRT_DT instead of TKT_SORT

-**************************************************************************
 
SET ASNAMES = ON
-RUN
-INCLUDE SETECHO 


-IF &&CURRENCY EQ 'USD' THEN GOTO NEXT;


-SET &&SUBHEAD = <NAMEC;
-SET &FPAID_CUR = 'FARE,PAID, (' | &&CURRENCY || ')';
-SET &&PRINT6='GFARE_AMT/D16.2CS AS ' | '''&FPAID_CUR.EVAL''';
-SET &&PRINT8='TOTAL_KILO AS ''TOTAL,KLMTRS''';

-NEXT;

-IF &&SETF EQ 'HDTPVOID' THEN GOTO HDTPVOID;

-IF &&SETF EQ 'CGTOPSLT' OR 'KWTOPDIS' THEN GOTO NEXT3;

 

-IF &&SETF NE 'KEAIRSUM' THEN GOTO NEXT2;

TABLE FILE TOPTVL
SUM NET_TKT_CNT 
    MRK_TKT_CNT
    FARE_PAID
    PAID_FAREX/D16.2CS
    KILO 
    NEW_SEG_MILES
    TRP_LEN
    TON_C02
BY PASSNGR_NAME
ON TABLE HOLD AS HOLD1
END
-RUN



TABLE FILE HOLD1
PRINT NET_TKT_CNT
      MRK_TKT_CNT
      FARE_PAID
      NEW_SEG_MILES
      KILO
      PAID_FAREX
      TRP_LEN      
      PASSNGR_NAME
      TON_C02
RANKED BY &&RANK_ORDER &&RANK_METH NOPRINT
ON TABLE HOLD AS RNKHLD1
END 
-RUN

TABLE FILE TOPTVL
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      EMAIL_ADR
      DISSAVINGS
      FARE_PAID
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL_DESC
      MRK_TKT_CNT
      NAMEC
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      ONL_TKTS
      OTFLAG
      PAID_FAREX/D16.2CS
      PASSNGR_NAME
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM 
      TKT_SORT
      TKT_TYPE
      TON_C02
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
BY LEVEL3
ON TABLE HOLD AS HOLD5
END 
-RUN

TABLE FILE TOPTVL
SUM NET_TKT_CNT AS 'TTKT'
    MRK_TKT_CNT AS 'TSEG'
    FARE_PAID AS 'TFARE'
    PAID_FAREX/D16.2CS AS 'TGFARE'
    KILO AS 'TKILO'
    NEW_SEG_MILES AS 'TMILE'
    DISSAVINGS AS 'TLOSS'
    TRP_LEN AS 'TLEN'
    TON_C02 AS 'TC02'
BY LEVEL3
BY TKT_SORT
BY TRN_DATE   
ON TABLE HOLD AS HOLD2
END
-RUN

DEFINE FILE RNKHLD1
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  LIST/D9 = (LAST LIST + 1);
  CRANKX/A11 = FTOA(LIST, '(D9)', 'A11');
  CRANK/A9 = EDIT(CRANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE 
                  IF LIST GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                  CRANK;
  RANK_VAL/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE
                IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE
                ARANK;
  RANK_LAB1/A80 = IF RANK_VAL NE 'ALL OTHER' THEN &&RANK_LABEL1
                  ELSE 'ALL OTHER';
  RANK_LABEL1/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2
                      ELSE ' ';
  RANK_LABEL3/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3
                      ELSE ' ';
END
-RUN 

TABLE FILE RNKHLD1
PRINT   MRK_TKT_CNT
      NET_TKT_CNT
      FARE_PAID
      NEW_SEG_MILES
      KILO
      PAID_FAREX
      TRP_LEN
      LEVEL3
      RANK_VALUE 
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      PASSNGR_NAME
      TON_C02
BY LEVEL3
ON TABLE HOLD AS RNKHLD2
END
-RUN


MATCH FILE HOLD2
PRINT TTKT
    TFARE
    TLOSS
    TMILE
    TKT_SORT
    TRN_DATE
    TKILO
    TGFARE
    TLEN
    TSEG
    PASSNGR_NAME
    TC02
BY LEVEL3   
ON TABLE HOLD
RUN
FILE RNKHLD2
SUM NET_TKT_CNT
    MRK_TKT_CNT
    FARE_PAID
    PAID_FAREX
    KILO
    NEW_SEG_MILES
    TRP_LEN
    RANK_VALUE
    RANK_LABEL1
    RANK_LABEL2
    RANK_LABEL3
    PASSNGR_NAME
    TON_C02
BY LEVEL3    
AFTER MATCH HOLD AS XONE OLD-OR-NEW
END
-RUN


MATCH FILE HOLD5
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL_DESC    
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      NEW_SEG_MILES
      ONL_TKTS
      OTFLAG
      PAID_FAREX
      PASSNGR_NAME
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM 
      TKT_TYPE
      TRN_DATE
      TON_C02
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
      TRP_LEN
BY LEVEL3
BY TKT_SORT
ON TABLE HOLD
RUN
FILE XONE
SUM TLOSS
    TMILE
    RANK_LABEL1
    RANK_LABEL2
    RANK_LABEL3
    RANK_VALUE
    PASSNGR_NAME
    TTKT
    TFARE
    TGFARE
    TKILO
    TLEN
    TSEG
    TC02
BY LEVEL3
BY TKT_SORT
AFTER MATCH HOLD AS XTWO OLD-OR-NEW
END

-GOTO NextStep;


-NEXT2 

-SET &&SORT1 = IF '&&SETF.EVAL' EQ 'ABTOPTVL' OR 'ABTOPTV1' OR 'TMTOPTVL' OR 'KYTOPTVL' OR 'NTLTPTVL' 
- OR 'KWTPTLEN' THEN ' ' ELSE 'BY LEVEL_DESC';
-RUN




TABLE FILE TOPTVL
SUM NET_TKT_CNT 
    MRK_TKT_CNT
    EMAIL_ADR
    FARE_PAID
    PAID_FAREX/D16.2CS
    KILO 
    NEW_SEG_MILES
    TRP_LEN
    TON_C02
    EMAIL_ADR
    BB_06
    LEVEL4
    EMP_ID
    LEVEL1
    LEVEL3
    LEVEL_DESC
-*BY LEVEL_DESC
&&SORT1
BY PASSNGR_NAME 
-IF &&SETF NE 'HDTPVOID' THEN GOTO NOWhere1;
WHERE VOID_DATE NE 0
-NOWhere1;
ON TABLE HOLD AS HOLD1
END
-RUN

-IF '&&SETF.EVAL' NE 'BBTOPTVL' THEN GOTO NoSet;

-SET &&RANK_METH = 'BB_06';

-NoSet
 

-IF '&&SETF.EVAL' NE 'KWTPTLEN' THEN GOTO NOset2;
-SET &&RANK_METH = TRP_LEN;
-GOTO SKIPNEXT;

-NOset2;

-IF &&SETF EQ 'GASEGCNT' OR 'KBSEGCNT' THEN GOTO SPECIAL ELSE GOTO SKIPNEXT;

-SPECIAL

-*-SET &&RANK_METH = MRK_TKT_CNT;
-SET &&RANK_METH = IF '&&RANK_METH.EVAL' EQ 'NET_TKT_CNT' THEN 'MRK_TKT_CNT' ELSE &&RANK_METH;

-SKIPNEXT


TABLE FILE HOLD1
PRINT NET_TKT_CNT
      MRK_TKT_CNT
      EMAIL_ADR
      FARE_PAID
      NEW_SEG_MILES
      KILO
      PAID_FAREX
      TRP_LEN   
      TON_C02
      EMAIL_ADR
      BB_06
      LEVEL4
      EMP_ID
      LEVEL1
      LEVEL3
RANKED BY &&RANK_ORDER &&RANK_METH NOPRINT
BY PASSNGR_NAME
ON TABLE HOLD AS RNKHLD1
END 
-RUN

-GOTO 1stRank;

-HDTPVOID


TABLE FILE TOPTVL
SUM NET_TKT_CNT AS 'TTKT'
    VOID_CNT
BY PASSNGR_NAME
ON TABLE HOLD AS AIRHOLD1
END
-RUN


TABLE FILE TOPTVL
SUM NET_TKT_CNT 
    MRK_TKT_CNT
    FARE_PAID
    PAID_FAREX/D16.2CS
    KILO 
    NEW_SEG_MILES
    TRP_LEN
    TON_C02
    EMAIL_ADR
    BB_06
    LEVEL4
BY PASSNGR_NAME 
WHERE VOID_DATE NE 0
ON TABLE HOLD AS HOLD1
END
-RUN


MATCH FILE HOLD1
PRINT NET_TKT_CNT
      MRK_TKT_CNT
      FARE_PAID
      PAID_FAREX
      KILO
      NEW_SEG_MILES
      TRP_LEN
      TON_C02
      EMAIL_ADR
      BB_06
      LEVEL4
BY PASSNGR_NAME
ON TABLE HOLD
RUN 
FILE AIRHOLD1
SUM TTKT
    VOID_CNT
BY PASSNGR_NAME
AFTER MATCH HOLD AS MATCHONE OLD-OR-NEW
END
-RUN

TABLE FILE MATCHONE
SUM NET_TKT_CNT
      MRK_TKT_CNT
      FARE_PAID
      PAID_FAREX
      KILO
      NEW_SEG_MILES
      TRP_LEN
      TTKT
      VOID_CNT
      TON_C02
      EMAIL_ADR
      BB_06
      LEVEL4
COMPUTE VPT/P8.1 = IF ((TTKT LT 1) AND (TTKT GT (-1))) THEN 0 ELSE
         (NET_TKT_CNT/TTKT)*100; 
BY PASSNGR_NAME
ON TABLE HOLD AS AIRHOLD3
END
-RUN

-SET &&RANK_METH = VPT;

TABLE FILE AIRHOLD3
PRINT NET_TKT_CNT
      MRK_TKT_CNT
      FARE_PAID
      NEW_SEG_MILES
      KILO
      PAID_FAREX
      TRP_LEN    
      TON_C02
      EMAIL_ADR
      BB_06
      LEVEL4
RANKED BY &&RANK_ORDER &&RANK_METH NOPRINT
BY PASSNGR_NAME
ON TABLE HOLD AS RNKHLD1
END 
-RUN



-1stRank;

DEFINE FILE RNKHLD1
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  LIST/D9 = (LAST LIST + 1);
  CRANKX/A11 = FTOA(LIST, '(D9)', 'A11');
  CRANK/A9 = EDIT(CRANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE 
                  IF LIST GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                  CRANK;
  RANK_VAL/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE
                IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE
                ARANK;
  RANK_LAB1/A80 = IF RANK_VAL NE 'ALL OTHER' THEN &&RANK_LABEL1
                  ELSE 'ALL OTHER';
  RANK_LABEL1/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2
                      ELSE ' ';
  RANK_LABEL3/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3
                      ELSE ' ';
END
-RUN 

TABLE FILE RNKHLD1
PRINT PASSNGR_NAME
      MRK_TKT_CNT
      NET_TKT_CNT
      FARE_PAID
      NEW_SEG_MILES
      KILO
      PAID_FAREX
      TRP_LEN
      TON_C02
      EMAIL_ADR
      BB_06
BY RANK_LABEL1
BY RANK_LABEL2
BY RANK_LABEL3
BY RANK_VALUE
ON TABLE HOLD AS RNKHLD2
END
-RUN


TABLE FILE TOPTVL
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      BB_06
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL_DESC
      MRK_TKT_CNT
      NAMEC
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      ONL_TKTS
      OTFLAG
      PAID_FAREX/D16.2CS
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM   
      TKT_PURCH
      TKT_SORT
      TKT_TYPE
      TON_C02
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
      EMAIL_ADR
BY PASSNGR_NAME
-IF &&SETF NE 'HDTPVOID' THEN GOTO NOwhere2;
WHERE VOID_DATE NE 0
-NOwhere2;
ON TABLE HOLD AS HOLD5
END 
-RUN

TABLE FILE TOPTVL
SUM NET_TKT_CNT AS 'TTKT'
    MRK_TKT_CNT AS 'TSEG'
    FARE_PAID AS 'TFARE'
    PAID_FAREX/D16.2CS AS 'TGFARE'
    KILO AS 'TKILO'
    NEW_SEG_MILES AS 'TMILE'
    DISSAVINGS AS 'TLOSS'
    TRP_LEN AS 'TLEN'
    TON_C02 AS 'TC02'
    TKT_PURCH AS 'TPUR'
    BB_06 AS 'TBB_06'
BY PASSNGR_NAME
BY TKT_SORT
BY TRN_DATE 
-IF &&SETF NE 'HDTPVOID' THEN GOTO NOwhere3;
WHERE VOID_DATE NE 0
-NOwhere3;
ON TABLE HOLD AS HOLD2
END
-RUN

 
MATCH FILE HOLD2
PRINT TTKT
    TFARE
    TLOSS
    TMILE
    TKT_SORT
    TRN_DATE
    TKILO
    TGFARE
    TLEN
    TSEG
    TC02
    TPUR
    TBB_06
BY PASSNGR_NAME
ON TABLE HOLD
RUN
FILE RNKHLD2
SUM NET_TKT_CNT
    MRK_TKT_CNT
    FARE_PAID
    PAID_FAREX
    KILO
    NEW_SEG_MILES
    TRP_LEN
    RANK_VALUE
    RANK_LABEL1
    RANK_LABEL2
    RANK_LABEL3
    TON_C02
    EMAIL_ADR
BY PASSNGR_NAME
AFTER MATCH HOLD AS XONE OLD-OR-NEW
END
-RUN


MATCH FILE HOLD5
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      BB_06
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL_DESC    
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      NEW_SEG_MILES
      ONL_TKTS
      OTFLAG
      PAID_FAREX
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM 
      TKT_PURCH
      TKT_TYPE
      TON_C02
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
      TRP_LEN
BY PASSNGR_NAME
BY TKT_SORT
ON TABLE HOLD
RUN
FILE XONE
SUM TLOSS
    TMILE
    RANK_LABEL1
    RANK_LABEL2
    RANK_LABEL3
    RANK_VALUE
    TTKT
    TFARE
    TGFARE
    TKILO
    TLEN
    TSEG
    TC02
    EMAIL_ADR
    TBB_06
    TPUR
BY PASSNGR_NAME
BY TKT_SORT
AFTER MATCH HOLD AS XTWO OLD
END
-RUN

-GOTO NextStep;




-NEXT3

-SET &SORT1 = IF '&&SETF.EVAL' EQ 'CGTOPSLT' OR 'KWTOPDIS' THEN EMP_ID ELSE LEVEL2;
-RUN

 
DEFINE FILE TOPTVL
PAX_NM/A33 = IF EMP_ID EQ 'DEFB' OR 'CANCORP' OR 'CONCORP' OR '8888888' 
             OR '1111111' THEN ' ' ELSE PASSNGR_NAME;
END
TABLE FILE TOPTVL
SUM NET_TKT_CNT 
    MRK_TKT_CNT
    FARE_PAID
    PAID_FAREX/D16.2CS
    KILO 
    NEW_SEG_MILES
    TRP_LEN
    PAX_NM AS 'PASSNGR_NAME'
    EMP_ID
    LEVEL1
    LEVEL2
-*BY EMP_ID 
BY &SORT1
BY PAX_NM
ON TABLE HOLD AS HOLD1
END
-RUN

TABLE FILE HOLD1
PRINT NET_TKT_CNT
      MRK_TKT_CNT
      FARE_PAID
      NEW_SEG_MILES
      KILO
      PAID_FAREX
      TRP_LEN      
      PASSNGR_NAME
      PAX_NM
      EMP_ID
      LEVEL1
      LEVEL2
RANKED BY &&RANK_ORDER &&RANK_METH NOPRINT
ON TABLE HOLD AS RNKHLD1
END 
-RUN

TABLE FILE TOPTVL
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL_DESC
      MRK_TKT_CNT
      NAMEC
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      ONL_TKTS
      OTFLAG
      PAID_FAREX/D16.2CS
      PASSNGR_NAME
      PAX_NM
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
-*BY EMP_ID
BY &SORT1
BY PAX_NM
ON TABLE HOLD AS HOLD5
END 
-RUN

TABLE FILE TOPTVL
SUM NET_TKT_CNT AS 'TTKT'
    MRK_TKT_CNT AS 'TSEG'
    FARE_PAID AS 'TFARE'
    PAID_FAREX/D16.2CS AS 'TGFARE'
    KILO AS 'TKILO'
    NEW_SEG_MILES AS 'TMILE'
    DISSAVINGS AS 'TLOSS'
    TRP_LEN AS 'TLEN'
    PASSNGR_NAME
-*BY EMP_ID
BY &SORT1
BY PAX_NM
BY TKT_SORT
BY TRN_DATE   
ON TABLE HOLD AS HOLD2
END
-RUN

DEFINE FILE RNKHLD1
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  LIST/D9 = (LAST LIST + 1);
  CRANKX/A11 = FTOA(LIST, '(D9)', 'A11');
  CRANK/A9 = EDIT(CRANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE 
                  IF LIST GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                  CRANK;
  RANK_VAL/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE
                IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE
                ARANK;
  RANK_LAB1/A80 = IF RANK_VAL NE 'ALL OTHER' THEN &&RANK_LABEL1
                  ELSE 'ALL OTHER';
  RANK_LABEL1/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2 ELSE ' ';
  RANK_LABEL3/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3 ELSE ' ';
END
-RUN 

TABLE FILE RNKHLD1
PRINT   MRK_TKT_CNT
      NET_TKT_CNT
      FARE_PAID
      NEW_SEG_MILES
      KILO
      PAID_FAREX
      TRP_LEN
      RANK_VALUE 
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      PASSNGR_NAME
      PAX_NM
-*BY EMP_ID
BY &SORT1
ON TABLE HOLD AS RNKHLD2
END
-RUN


MATCH FILE HOLD2
PRINT TTKT
    TFARE
    TLOSS
    TMILE
    TKT_SORT
    TRN_DATE
    TKILO
    TGFARE
    TLEN
    TSEG
    PASSNGR_NAME
-*BY EMP_ID
BY &SORT1
BY PAX_NM
ON TABLE HOLD
RUN
FILE RNKHLD2
SUM NET_TKT_CNT
    MRK_TKT_CNT
    FARE_PAID
    PAID_FAREX
    KILO
    NEW_SEG_MILES
    TRP_LEN
    RANK_VALUE
    RANK_LABEL1
    RANK_LABEL2
    RANK_LABEL3
    PASSNGR_NAME
-*BY EMP_ID
BY &SORT1
BY PAX_NM
AFTER MATCH HOLD AS XONE OLD-OR-NEW
END
-RUN


MATCH FILE HOLD5
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL_DESC    
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      NEW_SEG_MILES
      ONL_TKTS
      OTFLAG
      PAID_FAREX
      PASSNGR_NAME
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
      TRP_LEN
-*BY EMP_ID
BY &SORT1
BY PAX_NM
BY TKT_SORT
ON TABLE HOLD
RUN
FILE XONE
SUM TLOSS
    TMILE
    RANK_LABEL1
    RANK_LABEL2
    RANK_LABEL3
    RANK_VALUE
    PASSNGR_NAME
    TTKT
    TFARE
    TGFARE
    TKILO
    TLEN
    TSEG
-*BY EMP_ID
BY &SORT1
BY PAX_NM
BY TKT_SORT
AFTER MATCH HOLD AS XTWO OLD-OR-NEW
END


TABLE FILE XTWO
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD   
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL_DESC
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      NEW_SEG_MILES
      ONL_TKTS
      OTFLAG
      PAID_FAREX
      PASSNGR_NAME
      PAX_NM
      SAVINGS
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      RANK_VALUE
      REFUSE_CODE
      RTE_APT_CD
      RTE_APT_NM  
      TKT_NUM     
      TKT_TYPE
      TRP_LEN
      TRN_DATE
      TLOSS
      TTKT
      TFARE
      TGFARE
      TKILO
      TLEN
      TMILE
      TSEG
-*      TC02
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD4
END
-RUN

-GOTO NoJoin



-NextStep

-IF &&SETF EQ 'KWTRVLR' GOTO KWRPT;
-IF &&SETF EQ 'TMTOPTVL' GOTO TMOBIL;

TABLE FILE XTWO
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      BB_06
      CLASS
      EMB_APT_CD   
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL_DESC
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      NEW_SEG_MILES
      ONL_TKTS
      OTFLAG
      PAID_FAREX
      PASSNGR_NAME
      SAVINGS
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      RANK_VALUE
      REFUSE_CODE
      RTE_APT_CD
      RTE_APT_NM  
      TKT_NUM 
      TKT_PURCH
      TKT_TYPE
      TON_C02
      TRP_LEN
      TRN_DATE
      TC02
      TLOSS
      TTKT
      TFARE
      TGFARE
      TKILO
      TLEN
      TMILE
      TSEG
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
      EMAIL_ADR
      TPUR
      TBB_06
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD4
END
-RUN


-IF &&SETF NE 'DVTOPTVL' THEN GOTO NoJoin;
-IF &&SETF EQ 'TMTOPTVL' THEN GOTO TMOBIL;

-JOIN
JOIN AIRLINE IN AIRHOLD4 TO AIRLINE IN AIRLINE AS J1
-RUN

-GOTO FinalHOLD


-TMOBIL

-INCLUDE PREFAIRPCT 
-RUN


MATCH FILE XTWO
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      BB_06
      CLASS
      EMB_APT_CD   
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      NEW_SEG_MILES
      ONL_TKTS
      OTFLAG
      PAID_FAREX
      SAVINGS
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      RANK_VALUE
      REFUSE_CODE
      RTE_APT_CD
      RTE_APT_NM  
      SEG_NBR
      TKT_PURCH
      TKT_SORT
      TKT_TYPE
      TON_C02
      TRP_LEN
      TRN_DATE
      TC02
      TLOSS
      TTKT
      TFARE
      TGFARE
      TKILO
      TLEN
      TMILE
      TSEG
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
      EMAIL_ADR
      TPUR
      TBB_06
BY LEVEL_DESC
BY PASSNGR_NAME
BY TKT_NUM
ON TABLE HOLD
RUN
FILE PAXPRFHLD
SUM PREF_AIR
BY LEVEL_DESC
BY PASSNGR_NAME
BY TKT_NUM
AFTER MATCH HOLD AS XTHREE OLD-OR-NEW
END
-RUN

TABLE FILE XTHREE
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      BB_06
      CLASS
      EMB_APT_CD   
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      LEVEL_DESC
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      NEW_SEG_MILES
      ONL_TKTS
      OTFLAG
      PAID_FAREX
      PASSNGR_NAME
      SAVINGS
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      RANK_VALUE
      REFUSE_CODE
      RTE_APT_CD
      RTE_APT_NM  
      TKT_NUM 
      TKT_PURCH
      TKT_TYPE
      TON_C02
      TRP_LEN
      TRN_DATE
      TC02
      TLOSS
      TTKT
      TFARE
      TGFARE
      TKILO
      TLEN
      TMILE
      TSEG
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
      EMAIL_ADR
      TPUR
      TBB_06
      PREF_AIR
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD4
END
-RUN

-NoJoin

-FinalHOLD;

-IF &&SETF EQ 'GATP50K' THEN GOTO MILESET;


DEFINE FILE AIRHOLD4
-IF &&SETF NE 'BBTOPTVL' THEN GOTO SKIPbb;
TKT_PUR/D9S = IF (SEG_NBR EQ '01') THEN TPUR ELSE 0;
TPUR_BB06/D9S = IF (SEG_NBR EQ '01') THEN TBB_06 ELSE 0;
-SKIPbb
NET_TKT_CNT/D9S = IF (SEG_NBR EQ '01') THEN  TTKT ELSE 0;
PASNGR_NAME/A33 = IF TKT_NUM NE LAST TKT_NUM THEN PASSNGR_NAME ELSE ' ';
REASON_CD/A2 =  IF TKT_NUM NE LAST TKT_NUM THEN REFUSE_CODE ELSE ' ';
TICKET_NMBR/A10 = IF TKT_NUM NE LAST TKT_NUM THEN TKT_NUM ELSE ' ';
XT_DTE/A8 = EDIT(TRN_DATE);
XTKT_SRT/A10 = EDIT(TKT_SORT,'9999999999$');
XTRAN_DTE/MDYY = IF TKT_NUM NE LAST TKT_NUM THEN XTRAN_DT ELSE 0;


-* ****DEFINES ON PREVIOUS DEFINES****
SRT_DT/A120 = TKT_SORT||XT_DTE||PASSNGR_NAME;
GFARE_AMT/D16.2CS = IF SRT_DT NE LAST SRT_DT THEN TGFARE ELSE 0;
FARE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TFARE ELSE 0;
LOST_SAV_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TLOSS ELSE 0;
RADV_PURCH/I8CS = IF (EMB_APT_CD EQ 'FP2' OR 'EX1' OR 'RF1' OR 'EX5') THEN 0
  ELSE IF (TKT_TYPE EQ 'P-RF' OR 'P-EX') THEN 0
  ELSE IF (SEG_NBR EQ '00') THEN 0
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT GE 0) THEN NEW_ADV_PURCH
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT LT 0) 
  THEN NEW_ADV_PURCH * (-1) ELSE 0;
TOTAL_MILES/D8CS = IF TKT_SORT NE LAST TKT_SORT THEN TMILE ELSE 0;
TOTAL_KILOS/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TKILO ELSE 0;
TRIP_LEN/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TLEN ELSE 0;
TOTAL_SEG/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TSEG ELSE 0;
DVRNK_LBL1/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE 'ALL OTHER';
BB_FARE/D12.2CS = IF EMP_ID EQ 'BB' THEN FARE_AMT ELSE 0;
NB_FARE/D12.2CS = IF EMP_ID EQ 'NB' THEN FARE_AMT ELSE 0;    
-*
-* 7/20/16 - RSB - Modified the IF statement for BVTPTVLC, the report was erroring out on the drill-down.
-IF (&&SETF NE 'ABTPTVLC') AND (&&SETF NE 'BVTPTVLC') THEN GOTO NotThis;
TOTAL_C02/D9.2CS = IF TKT_SORT NE LAST TKT_SORT THEN TC02 ELSE 0;
-NotThis
NOWTOD/A8 WITH RANK_VALUE = HHMMSS (NOWTOD);
XTS_FLAG/A1 = IF XTKT_SRT NE LAST XTKT_SRT THEN 'Y' ELSE 'N';
  D_DATE/A8MDYY = XDPT_DT;
  DDATM/A2 = EDIT(D_DATE,'99');
  DDATD/A2 = EDIT(D_DATE, '$$99');
  DDATY/A4 = EDIT(D_DATE, '$$$$9999');
  DDATE2/A10 = IF XDPT_DT EQ ' ' THEN ' ' ELSE DDATM || '/' || DDATD || '/' || DDATY;
  X_DATE/A8MDYY = XTRAN_DT;
  XDATM/A2 = EDIT(X_DATE,'99');
  XDATD/A2 = EDIT(X_DATE, '$$99');
  XDATY/A4 = EDIT(X_DATE, '$$$$9999');
  XTDATE2/A10 = XDATM || '/' || XDATD || '/' || XDATY;
  XTDATE3/A10 = IF TKT_NUM NE LAST TKT_NUM THEN XTDATE2 ELSE ' ';
-IF &&SETF EQ 'HDTPVOID' THEN GOTO SKIPdefine;
ONTKT/D8CS = IF TKT_SORT NE LAST TKT_SORT THEN ONL_TKTS ELSE 0;
-SKIPdefine;
-IF &&SETF NE 'TMTOPTVL' THEN GOTO NOprf;
PREF_TKT/D12CS = IF TKT_NUM NE LAST TKT_NUM  THEN PREF_AIR ELSE 0;
-NOprf;
END
-RUN

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADAIR' ELSE 'HDREXLS'; 
-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'DTEXL' ELSE &&DTSTY;
-RUN

-IF '&&SETF.EVAL' NE 'KWTRVLR' GOTO CONTRPT;

-KWRPT;

TABLE FILE XTWO
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      BB_06
      CLASS
      EMB_APT_CD   
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL_DESC
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      NEW_SEG_MILES
      OTFLAG
      PAID_FAREX
      PASSNGR_NAME
      SAVINGS
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      RANK_VALUE
      REFUSE_CODE
      RTE_APT_CD
      RTE_APT_NM  
      TKT_NUM 
      TKT_PURCH
      TKT_TYPE
      TON_C02
      TRP_LEN
      TRN_DATE
      TC02
      TLOSS
      TTKT
      TFARE
      TGFARE
      TKILO
      TLEN
      TMILE
      TSEG
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
      EMAIL_ADR
      TPUR
      TBB_06
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD4A
END
-RUN

DEFINE FILE AIRHOLD4A
NET_TKT_CNT/D9S = IF (SEG_NBR EQ '01') THEN  TTKT ELSE 0;
TKT_PUR/D9S = IF (SEG_NBR EQ '01') THEN TPUR ELSE 0;
TPUR_BB06/D9S = IF (SEG_NBR EQ '01') THEN TBB_06 ELSE 0;
PASNGR_NAME/A33 = IF TKT_NUM NE LAST TKT_NUM THEN PASSNGR_NAME ELSE ' ';
REASON_CD/A2 =  IF TKT_NUM NE LAST TKT_NUM THEN REFUSE_CODE ELSE ' ';
TICKET_NMBR/A10 = IF TKT_NUM NE LAST TKT_NUM THEN TKT_NUM ELSE ' ';
XT_DTE/A8 = EDIT(TRN_DATE);
XTKT_SRT/A10 = EDIT(TKT_SORT,'9999999999$');
XTRAN_DTE/MDYY = IF TKT_NUM NE LAST TKT_NUM THEN XTRAN_DT ELSE 0;


-* ****DEFINES ON PREVIOUS DEFINES****
SRT_DT/A120 = TKT_SORT||XT_DTE||PASSNGR_NAME;
GFARE_AMT/D16.2CS = IF SRT_DT NE LAST SRT_DT THEN TGFARE ELSE 0;
FARE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TFARE ELSE 0;
LOST_SAV_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TLOSS ELSE 0;
RADV_PURCH/I8CS = IF (EMB_APT_CD EQ 'FP2' OR 'EX1' OR 'RF1' OR 'EX5') THEN 0
  ELSE IF (TKT_TYPE EQ 'P-RF' OR 'P-EX') THEN 0
  ELSE IF (SEG_NBR EQ '00') THEN 0
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT GE 0) THEN NEW_ADV_PURCH
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT LT 0) 
  THEN NEW_ADV_PURCH * (-1) ELSE 0;
TOTAL_MILES/D8CS = IF TKT_SORT NE LAST TKT_SORT THEN TMILE ELSE 0;
TOTAL_KILOS/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TKILO ELSE 0;
TRIP_LEN/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TLEN ELSE 0;
TOTAL_SEG/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TSEG ELSE 0;
DVRNK_LBL1/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE 'ALL OTHER';
BB_FARE/D12.2CS = IF EMP_ID EQ 'BB' THEN FARE_AMT ELSE 0;
NB_FARE/D12.2CS = IF EMP_ID EQ 'NB' THEN FARE_AMT ELSE 0;                      
-IF &&SETF NE 'ABTPTVLC' THEN GOTO NotThis;
TOTAL_C02/D9.2CS = IF TKT_SORT NE LAST TKT_SORT THEN TC02 ELSE 0;
-NotThis                      
NOWTOD/A8 WITH RANK_VALUE = HHMMSS (NOWTOD);
XTS_FLAG/A1 = IF XTKT_SRT NE LAST XTKT_SRT THEN 'Y' ELSE 'N';

END
-RUN

TABLE FILE AIRHOLD4A
SUM NET_TKT_CNT AS 'TKT_CNT'
BY PASSNGR_NAME
WHERE TOTAL NET_TKT_CNT EQ 1
ON TABLE HOLD AS JOY
END
-RUN

MATCH FILE AIRHOLD4A
PRINT TICKET_NMBR XTRAN_DTE TKT_TYPE REASON_CD EMB_APT_NM RTE_APT_NM SEG_NBR XTKT_SRT TKT_SORT TRN_DATE
      XDPT_DT DPT_TIME CLASS FARE_AMT AIRLINE NET_TKT_CNT TOTAL_MILES TRN_DATE RANK_VALUE NOWTOD XTS_FLAG
BY PASSNGR_NAME
ON TABLE HOLD
RUN
FILE JOY
SUM TKT_CNT
BY PASSNGR_NAME
AFTER MATCH HOLD AS JOY1 OLD-AND-NEW
END
-RUN

TABLE FILE JOY1
PRINT TICKET_NMBR XTRAN_DTE TKT_TYPE REASON_CD EMB_APT_NM RTE_APT_NM SEG_NBR XTKT_SRT TKT_SORT TRN_DATE
      XDPT_DT DPT_TIME CLASS FARE_AMT AIRLINE NET_TKT_CNT TOTAL_MILES RANK_VALUE NOWTOD XTS_FLAG
BY PASSNGR_NAME
ON TABLE HOLD AS AIRHOLD4
END
-RUN


-CONTRPT;
-ONLRPT

-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*7/31/00     IBISTL-KR             ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERDT
-**************************************************************************


-IF &&DRILLED_RUN EQ 'N' GOTO SKIP_DRIL;
-************************************************************
-* INCLUDE PROGRAM TO GEN WHERE STATEMENTS
-************************************************************
-SET &&DRILLRPT = 'AIRHOLD4';
-INCLUDE DRILWHRS
-SKIP_DRIL
-************************************************************

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADAIR' ELSE 'HDREXLS'; 
-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'DTEXL' ELSE &&DTSTY;
-RUN

TABLE FILE AIRHOLD4
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
-*
-**********************************************************************
-* Print statement with fields passed from the user profile database
-**********************************************************************
-*
&&PRINT1
&&PRINT2
&&PRINT3
&&PRINT4
&&PRINT5
&&PRINT6
&&PRINT7
&&PRINT8
&&PRINT9
&&PRINT10

-*
-**********************************************************************
-* By statements (one per field)
-**********************************************************************
-*
&&BY1
&&BY2
&&BY3
&&BY4
&&BY5
&&BY6
&&BY7
&&BY8
&&BY9
&&BY10
BY XTS_FLAG NOPRINT


-*
-*********************************************************************
-*DATE           NAME               DESCRIPTION 
-*8/18/00      IBISTL-KR            INCLUDE WHERE STATEMENTS WHEN
-*                                  DRILLED_RUN EQ 'Y'.
-*********************************************************************
-*
-**********************************************************************
-* Where statements for Drilled Report
-**********************************************************************
-*

-IF &&DRILLED_RUN EQ 'N' GOTO SKIP_WHR;
-INCLUDE &&DRILLWHR
-SKIP_WHR
-*
-**********************************************************************
-* On Table statements for code appropriate to On Table commands
-**********************************************************************
-*
&&ONTABLE1
&&ONTABLE2
&&ONTABLE3
&&ONTABLE4
&&ONTABLE5
&&ONTABLE6
&&ONTABLE7
&&ONTABLE8
&&ONTABLE9
&&ONTABLE10
-*
-**********************************************************************
-* Report specific footer(s)
-**********************************************************************
-*
-INCLUDE FOOTERDT
-*
-*ON TABLE SET STYLE &&DTSTY
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**************************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
-INCLUDE &&PASTYD
ENDSTYLE
-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN
-*

-* REJ EX RESTART 
-*-*-EXIT
-GOTO XXIT;

-MILESET
TABLE FILE AIRHOLD4
SUM NEW_SEG_MILES AS 'TMILE1'
BY PASSNGR_NAME
ON TABLE HOLD AS GA501
END
-RUN

TABLE FILE AIRHOLD4
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD   
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL_DESC
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      OTFLAG
      PAID_FAREX
      PASSNGR_NAME
      SAVINGS
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      RANK_VALUE
      REFUSE_CODE
      RTE_APT_CD
      RTE_APT_NM  
      TKT_NUM     
      TKT_TYPE
      TRP_LEN
      TRN_DATE
      TLOSS
      TTKT
      TFARE
      TGFARE
      TKILO
      TLEN
      TMILE
      TSEG
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
      TKT_SORT
      SEG_NBR
BY PASSNGR_NAME
ON TABLE HOLD AS GA50AA
END
-RUN

MATCH FILE GA50AA
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD   
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL_DESC
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      OTFLAG
      PAID_FAREX
      PASSNGR_NAME
      SAVINGS
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      RANK_VALUE
      REFUSE_CODE
      RTE_APT_CD
      RTE_APT_NM  
      TKT_NUM     
      TKT_TYPE
      TRP_LEN
      TRN_DATE
      TLOSS
      TTKT
      TFARE
      TGFARE
      TKILO
      TLEN
      TMILE
      TSEG
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
      TKT_SORT
      SEG_NBR
BY PASSNGR_NAME
ON TABLE HOLD
RUN
FILE GA501
SUM TMILE1
BY PASSNGR_NAME
AFTER MATCH HOLD AS AIRHOLD4A OLD-AND-NEW
END
-RUN

TABLE FILE AIRHOLD4A
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD   
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL_DESC
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      OTFLAG
      PAID_FAREX
      PASSNGR_NAME
      SAVINGS
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      RANK_VALUE
      REFUSE_CODE
      RTE_APT_CD
      RTE_APT_NM  
      TKT_NUM     
      TKT_TYPE
      TRP_LEN
      TRN_DATE
      TLOSS
      TTKT
      TFARE
      TGFARE
      TKILO
      TLEN
      TMILE
      TMILE1
      TSEG
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
      TKT_SORT
      SEG_NBR
BY PASSNGR_NAME
WHERE TMILE1 GE 50000
ON TABLE HOLD AS AIRHOLD5A1
END
-RUN

TABLE FILE AIRHOLD5A1
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD   
      EMB_APT_NM
      FARE_PAID
      DISSAVINGS
      KILO
      EMP_ID
      LEVEL1
      LEVEL2
      LEVEL_DESC
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NEW_ADV_PUR
      OTFLAG
      PAID_FAREX
      PASSNGR_NAME
      SAVINGS
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      RANK_VALUE
      REFUSE_CODE
      RTE_APT_CD
      RTE_APT_NM  
      TKT_NUM     
      TKT_TYPE
      TRP_LEN
      TRN_DATE
      TLOSS
      TTKT
      TFARE
      TGFARE
      TKILO
      TLEN
      TMILE
      TMILE1
      TSEG
      DPT_TIME
      XDPT_DT
      XTRAN_DT 
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD5A
END
-RUN


DEFINE FILE AIRHOLD5A
NET_TKT_CNT/D9S = IF (SEG_NBR EQ '01') THEN  TTKT ELSE 0;
PASNGR_NAME/A33 = IF TKT_NUM NE LAST TKT_NUM THEN PASSNGR_NAME ELSE ' ';
REASON_CD/A2 =  IF TKT_NUM NE LAST TKT_NUM THEN REFUSE_CODE ELSE ' ';
TICKET_NMBR/A10 = IF TKT_NUM NE LAST TKT_NUM THEN TKT_NUM ELSE ' ';
XT_DTE/A8 = EDIT(TRN_DATE);
XTKT_SRT/A10 = EDIT(TKT_SORT,'9999999999$');
XTRAN_DTE/MDYY = IF TKT_NUM NE LAST TKT_NUM THEN XTRAN_DT ELSE 0;


-* ****DEFINES ON PREVIOUS DEFINES****
SRT_DT/A100 = TKT_SORT||XT_DTE||PASSNGR_NAME;
GFARE_AMT/D16.2CS = IF SRT_DT NE LAST SRT_DT THEN TGFARE ELSE 0;
FARE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TFARE ELSE 0;
LOST_SAV_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TLOSS ELSE 0;
RADV_PURCH/I8CS = IF (EMB_APT_CD EQ 'FP2' OR 'EX1' OR 'RF1' OR 'EX5') THEN 0
  ELSE IF (TKT_TYPE EQ 'P-RF' OR 'P-EX') THEN 0
  ELSE IF (SEG_NBR EQ '00') THEN 0
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT GT 0) THEN NEW_ADV_PURCH
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT LT 0) 
  THEN NEW_ADV_PURCH * (-1) ELSE 0;
TOTAL_MILES/D8CS = IF TKT_SORT NE LAST TKT_SORT THEN TMILE ELSE 0;
TOTAL_KILOS/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TKILO ELSE 0;
TRIP_LEN/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TLEN ELSE 0;
TOTAL_SEG/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TSEG ELSE 0;

NOWTOD/A8 WITH RANK_VALUE = HHMMSS (NOWTOD);
XTS_FLAG/A1 = IF XTKT_SRT NE LAST XTKT_SRT THEN 'Y' ELSE 'N';

END
-RUN


 
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*7/31/00     IBISTL-KR             ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERDT
-**************************************************************************


-IF &&DRILLED_RUN EQ 'N' GOTO SKIP_DRIL;
-************************************************************
-* INCLUDE PROGRAM TO GEN WHERE STATEMENTS
-************************************************************
-SET &&DRILLRPT = 'AIRHOLD5A';
-INCLUDE DRILWHRS
-SKIP_DRIL
-************************************************************

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADAIR' ELSE 'HDREXLS'; 
-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'DTEXL' ELSE &&DTSTY;
-RUN

TABLE FILE AIRHOLD5A
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
-*
-**********************************************************************
-* Print statement with fields passed from the user profile database
-**********************************************************************
-*
&&PRINT1
&&PRINT2
&&PRINT3
&&PRINT4
&&PRINT5
&&PRINT6
&&PRINT7
&&PRINT8
&&PRINT9
&&PRINT10

-*
-**********************************************************************
-* By statements (one per field)
-**********************************************************************
-*
&&BY1
&&BY2
&&BY3
&&BY4
&&BY5
&&BY6
&&BY7
&&BY8
&&BY9
&&BY10
BY XTS_FLAG NOPRINT


-*
-*********************************************************************
-*DATE           NAME               DESCRIPTION 
-*8/18/00      IBISTL-KR            INCLUDE WHERE STATEMENTS WHEN
-*                                  DRILLED_RUN EQ 'Y'.
-*********************************************************************
-*
-**********************************************************************
-* Where statements for Drilled Report
-**********************************************************************
-*
-IF &&DRILLED_RUN EQ 'N' GOTO SKIP_WHR;
-INCLUDE &&DRILLWHR
-SKIP_WHR
-*
-**********************************************************************
-* On Table statements for code appropriate to On Table commands
-**********************************************************************
-*
&&ONTABLE1
&&ONTABLE2
&&ONTABLE3
&&ONTABLE4
&&ONTABLE5
&&ONTABLE6
&&ONTABLE7
&&ONTABLE8
&&ONTABLE9
&&ONTABLE10
-*
-**********************************************************************
-* Report specific footer(s)
-**********************************************************************
-*
-INCLUDE FOOTERDT
-*
-*ON TABLE SET STYLE &&DTSTY
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**************************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
-INCLUDE &&PASTYD
ENDSTYLE
-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN
-*

-* REJ EX RESTART 
-*-*-EXIT

-XXIT;
