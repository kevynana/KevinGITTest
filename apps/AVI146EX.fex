-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-*06/06/17 - JEM - S-19164 Created for new report ABPFSSM
-********************************************************************
-INCLUDE SETECHO
SET ASNAMES = ON
-SET HOLDATTR = ON;
-* SET TEMPERASE = OFF
-SET &&IDLEVELBREAK = '';



-SET &RPARM = &&WEB_PATH || 'RPTPARMS.fex';

-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

-INCLUDE IDLEVROLLDEF
-RUN


DEFINE FILE &&EXTRACT

 CARD4/A4=EDIT(CREDIT_CARD, '$$$$$$$$$$$$$9999');

  CLASS_CAT/A15 = DECODE CL_CAT ('F' 'FIRST'     'P' 'PREMIUM ECONOMY'   
  			        'D' 'DEFAULT'   'B' 'BUSINESS'
  			        'E' 'ECONOMY'   'U'  'UPGRADE' 
                                ' ' 'DEFAULT');                           
  
  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;

  IBOOK/A42 = DOD_DESC;
  

  LEVEL_DESC1/A80 = &&LDESC;
 
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
 
  NEW_ADV_PURCH/D9    = ADV_PURCH;

  TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';

  XDPT_DT/MDYY         = DPT_DATE;
  XPSNGR_NM/A15        = 
    EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;



 
-INCLUDE TRANTYPE 
-INCLUDE IDLEVDEFINE 
 
               
END
-RUN

TABLEF FILE &&EXTRACT
PRINT AIR_KEY
  AIRLINE   
  ARR_TIME
  CARD4 
  CITYPAIR.EMBARK      AS 'EMB_APT_CD'   
  CLASS_CAT   
  DPT_TIME  
  EMBARK
  EMB_APT.AIRPORT_NAME AS 'EMB_APT_NM'
  FARE_PAID 
  FLIGHT
  LEVEL_DESC    
  EMP_ID    
  LEVEL1
  LEVEL2    
  LEVEL3 
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  NET_TKT_CNT   
  NEW_ADV_PURCH 
  PASSNGR_NAME 
  REFUSE_CODE
  ROUTE
  RTE_APT.AIRPORT_NAME AS 'RTE_APT_NM'  
  SEG_NBR   
  TKT_NUM   
  TKT_SORT  
  TKT_TYPE  
  TRN_DATE
  XDPT_DT   
  XPSNGR_NM
  XTRAN_DT
  
-INCLUDE &AIRDATES

-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10

 
-INCLUDE &RPARM
-* -INCLUDE RPTPARMS

ON TABLE HOLD AS RPT_HOLD

END
-RUN

TABLE FILE RPT_HOLD
PRINT AIRLINE   
  ARR_TIME
  CLASS_CAT 
  CARD4 AS 'CC_NUM'
  DPT_TIME  
  EMBARK
  EMB_APT_CD
  EMB_APT_NM
  FARE_PAID 
  FLIGHT
  LEVEL_DESC    
  EMP_ID    
  LEVEL1
  LEVEL2    
  LEVEL3 
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  NET_TKT_CNT   
  NEW_ADV_PURCH 
  PASSNGR_NAME 
  REFUSE_CODE
  ROUTE
  RTE_APT_NM
  SEG_NBR   
  TKT_NUM   
  TKT_SORT  
  TKT_TYPE  
  TRN_DATE
  XDPT_DT   
  XPSNGR_NM
  XTRAN_DT
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS RPT_HOLD1
END
-RUN


TABLE FILE ROLLUP_SQL
PRINT COMP
IF ROLLUP EQ '&&ROLLUP.EVAL'
ON TABLE HOLD AS COMPANY
END
-RUN

-* Access FSXXXX database

-READ COMPANY &&COMP.A8
-SET &&COMPNY = &&COMP.EVAL;
-CLOSE COMPANY

-SET &&COMPUA = '&&WFSRV1.EVAL' || '\TNT\TTRACKER\DATA\FS'|| '&&COMPNY.EVAL';

-RUN

 
TABLE FILE &&COMPUA
PRINT FEE_AMOUNT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
BY ATPCO_CODE
ON TABLE HOLD AS FSHOLD FORMAT FOCUS INDEX ATPCO_CODE
END
-RUN


TABLE FILE FS_REASON
PRINT FS_DESCRIPTION
BY ATPCO_CODE
ON TABLE HOLD AS FSDHOLD FORMAT FOCUS INDEX ATPCO_CODE
END
-RUN


JOIN ATPCO_CODE IN FSHOLD TO ALL ATPCO_CODE IN FSDHOLD AS JFS
-RUN


TABLE FILE FSHOLD
PRINT ATPCO_CODE FS_DESCRIPTION FEE_AMOUNT 
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS FSHOLD2
END
-RUN


MATCH FILE RPT_HOLD1
PRINT AIRLINE   
  ARR_TIME
  CC_NUM
  CLASS_CAT   
  DPT_TIME  
  EMBARK
  EMB_APT_CD
  EMB_APT_NM
  FARE_PAID 
  FLIGHT
  LEVEL_DESC    
  EMP_ID    
  LEVEL1
  LEVEL2    
  LEVEL3 
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  NET_TKT_CNT   
  NEW_ADV_PURCH 
  PASSNGR_NAME 
  REFUSE_CODE
  ROUTE
  RTE_APT_NM
  SEG_NBR   
  TKT_NUM   
  TKT_SORT  
  TKT_TYPE  
  TRN_DATE
  XDPT_DT   
  XPSNGR_NM
  XTRAN_DT
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD 
RUN
FILE FSHOLD2
PRINT ATPCO_CODE FS_DESCRIPTION FEE_AMOUNT 
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
AFTER MATCH HOLD AS RPT_HOLD2 OLD-AND-NEW
END
-RUN



TABLE FILE RPT_HOLD2
SUM CNT.FEE_AMOUNT AS 'FEE_CNT'
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS RPT_HOLD3
END
-RUN

MATCH FILE RPT_HOLD2
PRINT AIRLINE   
  ARR_TIME
  ATPCO_CODE
  CC_NUM
  CLASS_CAT 
  DPT_TIME  
  EMBARK
  EMB_APT_CD
  EMB_APT_NM
  FARE_PAID 
  FEE_AMOUNT
  FLIGHT
  FS_DESCRIPTION
  LEVEL_DESC    
  EMP_ID    
  LEVEL1
  LEVEL2    
  LEVEL3 
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  NET_TKT_CNT   
  NEW_ADV_PURCH 
  PASSNGR_NAME 
  REFUSE_CODE
  ROUTE
  RTE_APT_NM
  SEG_NBR   
  TKT_NUM   
  TKT_SORT  
  TKT_TYPE  
  TRN_DATE
  XDPT_DT   
  XPSNGR_NM
  XTRAN_DT
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD
RUN
FILE RPT_HOLD3
SUM FEE_CNT
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS &&RPT_HOLD
END
-RUN










