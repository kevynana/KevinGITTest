-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-SET &&OV1_MAIN = &&WEB_PATH || 'OV1_MAIN.FOC';
-RUN
FILEDEF OV1_MAIN DISK &&OV1_MAIN
-RUN

CREATE FILE OV1_MAIN
-RUN

SET ASNAMES=ON

DEFINE FILE OVMXLHLD
FARE_PAID/D12.2 = SEG_AMT + SEG_TAX ;

CY/A1 = IF TRN_DATE GE &&FROMDT.EVAL AND
           TRN_DATE LE &&TODT.EVAL THEN 'Y' ELSE 'N';
PY/A1 =  IF TRN_DATE GE &&FXDATE.EVAL AND
               TRN_DATE LE &&TXDATE.EVAL THEN 'Y' ELSE 'N';

NET_TKT_CNT/D12      = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
RSN/A30 =  IF REFUSE_CODE EQ 'AS' THEN 'CARRIER PREFERENCE' ELSE
           IF REFUSE_CODE EQ 'TS' THEN 'TIME NOT CONVENIENT' ELSE
           IF REFUSE_CODE EQ 'NR' THEN 'MORE COSTLY/REF TKT CLS' ELSE
           IF REFUSE_CODE EQ 'AA' OR 'CX' THEN 
                             'ALT ARPT/CONNEC REJECTED' ELSE
           IF REFUSE_CODE EQ 'AP' THEN 'BKG LESS THAN 7 DAYS' ELSE
                             'OTHER';
TRSN1/A5 = 'TOTAL';
                  

-* DEFINES ON PREVIOUS DEFINES
DISSAVINGS/D12.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST;

-* DEFINES ON PREVIOUSLY DEFINED DEFINES
CLST/D12.2CS = IF CY EQ 'Y' THEN DISSAVINGS ELSE 0;
PLST/D12.2CS = IF PY EQ 'Y' THEN DISSAVINGS ELSE 0;
CTKT/D12 = IF CY EQ 'Y' THEN NET_TKT_CNT ELSE 0;
PTKT/D12 = IF PY EQ 'Y' THEN NET_TKT_CNT ELSE 0;
END
-RUN

TABLE FILE OVMXLHLD
 SUM CLST CTKT PLST PTKT
BY RSN
WHERE RSN EQ 'CARRIER PREFERENCE'
ON TABLE HOLD AS OVLST1
END
-RUN


TABLE FILE OVMXLHLD
SUM CLST CTKT PLST PTKT
BY RSN
WHERE RSN EQ 'TIME NOT CONVENIENT'
ON TABLE HOLD AS OVLST2
END
-RUN

TABLE FILE OVMXLHLD
SUM CLST CTKT PLST PTKT
BY RSN
WHERE RSN EQ 'MORE COSTLY/REF TKT CLS'
ON TABLE HOLD AS OVLST3
END
-RUN

TABLE FILE OVMXLHLD
SUM CLST CTKT PLST PTKT
BY RSN
WHERE RSN EQ 'ALT ARPT/CONNEC REJECTED'
ON TABLE HOLD AS OVLST4
END
-RUN

TABLE FILE OVMXLHLD
SUM CLST CTKT PLST PTKT
BY RSN
WHERE RSN EQ 'BKG LESS THAN 7 DAYS'
ON TABLE HOLD AS OVLST5
END
-RUN

TABLE FILE OVMXLHLD
SUM CLST CTKT PLST PTKT
BY RSN
WHERE RSN EQ 'OTHER'
ON TABLE HOLD AS OVLST6
END
-RUN

TABLE FILE OVMXLHLD
SUM CLST CTKT PLST PTKT
BY TRSN1
ON TABLE HOLD AS OVLST7
END
-RUN

DEFINE FILE OVLST1
CATEGORY/A30 = 'LOST AIRLINE SAVINGS';
CAT_ORDER/I2 = 5;
END
-RUN

TABLE FILE OVLST1
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'VOL_CURR' AND 
CLST/D15 AS 'TKT_CURR' AND PTKT/D15 AS 'VOL_PRIOR' 
AND PLST/D15 AS 'TKT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
ON TABLE HOLD AS OVLOST1
END
-RUN

TABLE FILE OVLOST1
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR
      AND VOL_PRIOR AND TKT_PRIOR
ON TABLE HOLD AS OVLOSTA
END
MODIFY FILE OV1_MAIN
FIXFORM FROM OVLOSTA
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTA
END
-RUN

DEFINE FILE OVLST2
CATEGORY/A30 = 'LOST AIRLINE SAVINGS';
CAT_ORDER/I2 = 5;
END
-RUN

TABLE FILE OVLST2
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'VOL_CURR' AND 
CLST/D15 AS 'TKT_CURR' AND PTKT/D15 AS 'VOL_PRIOR' 
AND PLST/D15 AS 'TKT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
ON TABLE HOLD AS OVLOST2
END
-RUN

TABLE FILE OVLOST2
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR
      AND VOL_PRIOR AND TKT_PRIOR
ON TABLE HOLD AS OVLOSTB
END
MODIFY FILE OV1_MAIN
FIXFORM FROM OVLOSTB
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTB
END
-RUN

DEFINE FILE OVLST3
CATEGORY/A30 = 'LOST AIRLINE SAVINGS';
CAT_ORDER/I2 = 5;
END
-RUN

TABLE FILE OVLST3
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'VOL_CURR' AND 
CLST/D15 AS 'TKT_CURR' AND PTKT/D15 AS 'VOL_PRIOR' 
AND PLST/D15 AS 'TKT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
ON TABLE HOLD AS OVLOST3
END
-RUN

TABLE FILE OVLOST3
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR
      AND VOL_PRIOR AND TKT_PRIOR
ON TABLE HOLD AS OVLOSTC
END
MODIFY FILE OV1_MAIN
FIXFORM FROM OVLOSTC
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTC
END
-RUN

DEFINE FILE OVLST4
CATEGORY/A30 = 'LOST AIRLINE SAVINGS';
CAT_ORDER/I2 = 5;
END
-RUN

TABLE FILE OVLST4
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'VOL_CURR' AND 
CLST/D15 AS 'TKT_CURR' AND PTKT/D15 AS 'VOL_PRIOR' 
AND PLST/D15 AS 'TKT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
ON TABLE HOLD AS OVLOST4
END
-RUN

TABLE FILE OVLOST4
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR
      AND VOL_PRIOR AND TKT_PRIOR
ON TABLE HOLD AS OVLOSTD
END
MODIFY FILE OV1_MAIN
FIXFORM FROM OVLOSTA
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTD
END
-RUN

DEFINE FILE OVLST5
CATEGORY/A30 = 'LOST AIRLINE SAVINGS';
CAT_ORDER/I2 = 5;
END
-RUN

TABLE FILE OVLST5
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'VOL_CURR' AND 
CLST/D15 AS 'TKT_CURR' AND PTKT/D15 AS 'VOL_PRIOR' 
AND PLST/D15 AS 'TKT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
ON TABLE HOLD AS OVLOST5
END
-RUN

TABLE FILE OVLOST5
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR
      AND VOL_PRIOR AND TKT_PRIOR
ON TABLE HOLD AS OVLOSTE
END
MODIFY FILE OV1_MAIN
FIXFORM FROM OVLOSTE
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTE
END
-RUN

DEFINE FILE OVLST6
CATEGORY/A30 = 'LOST AIRLINE SAVINGS';
CAT_ORDER/I2 = 5;
END
-RUN

TABLE FILE OVLST6
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'VOL_CURR' AND 
CLST/D15 AS 'TKT_CURR' AND PTKT/D15 AS 'VOL_PRIOR' 
AND PLST/D15 AS 'TKT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
ON TABLE HOLD AS OVLOST6
END
-RUN

TABLE FILE OVLOST6
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR
      AND VOL_PRIOR AND TKT_PRIOR
ON TABLE HOLD AS OVLOSTF
END
MODIFY FILE OV1_MAIN
FIXFORM FROM OVLOSTF
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTF
END
-RUN

DEFINE FILE OVLST7
CATEGORY/A30 = 'LOST AIRLINE SAVINGS';
CAT_ORDER/I2 = 5;
END
-RUN

TABLE FILE OVLST7
PRINT CATEGORY/A30 AND TRSN1/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'VOL_CURR' AND 
CLST/D15 AS 'TKT_CURR' AND PTKT/D15 AS 'VOL_PRIOR' 
AND PLST/D15 AS 'TKT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
ON TABLE HOLD AS OVLOST7
END
-RUN

TABLE FILE OVLOST7
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR
      AND VOL_PRIOR AND TKT_PRIOR
ON TABLE HOLD AS OVLOSTG
END
MODIFY FILE OV1_MAIN
FIXFORM FROM OVLOSTG
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTG
END
-RUN




