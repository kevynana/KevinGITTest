-*1/04/17-JEM-S-23779-Created for new Bonus Point file ABP2PBS



-INCLUDE SETECHO

FILEDEF RPTPARMS CLEAR
-RUN

EX CARUSE
-RUN

-SET &&RPTGRP = 'CAR';
EX UDIDGEN
-RUN

DEFINE FILE BRPTINST
  RT/A3 = 'CAR';
END
TABLE FILE BRPTINST
PRINT RT AS 'RPT_GROUP'
BY INST_KEY
ON TABLE SAVE AS AIRACH00
END
-RUN
MODIFY FILE BRPTINST
LOG DUPL MSG OFF
FIXFORM INST_KEY/7 RPT_GROUP/3
MATCH INST_KEY
  ON MATCH UPDATE RPT_GROUP
DATA ON AIRACH00
END
-RUN

MODIFY FILE BRPTFLDS
LOG DUPL MSG OFF
FIXFORM INST_KEY/7 CAR.ID/1 CAR.INCL1/1 
REPOSITION INST_KEY
MATCH INST_KEY
  ON MATCH CONTINUE
  ON NOMATCH INCLUDE
MATCH * KEYS SEG CAR
  ON NOMATCH INCLUDE
  ON MATCH UPDATE CAR.INCL1
DATA ON AIRACH00
END
-RUN

EX CODEGEN
-RUN

-SET &CARDATES = &&WEB_PATH || 'CARDATES.fex';


DEFINE FILE &&EXTRACT
BOOKINGS/P12 = IF NUM_DAYS GT 0 THEN 1 ELSE IF NUM_DAYS LT 0 THEN (-1) ELSE 0;

 HIER1/A15 = AROLL_LEV1;
 HIER2/A32 = AROLL_LEV1||'|'||AROLL_LEV2;
 HIER3/A50 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3;
 HIER4/A66 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4;
 HIER5/A85 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5;
 HIER6/A100 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6;
 HIER7/A120 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7;
 HIER8/A135 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8;
 HIER9/A151 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9;
 HIER10/A168 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10;       
 HIER11/A185 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11;
 HIER12/A202 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12;
 HIER13/A219 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12||'|'||AROLL_LEV13;
 HIER14/A236 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12||'|'||AROLL_LEV13||'|'||AROLL_LEV14;
 HIER15/A255 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12||'|'||AROLL_LEV13||'|'||AROLL_LEV14||'|'||AROLL_LEV15;
 
 
 
 HIERA/A255 = IF AROLL_LEV15 NE ' ' THEN HIER15 ELSE
             IF AROLL_LEV14 NE ' ' THEN HIER14 ELSE
             IF AROLL_LEV13 NE ' ' THEN HIER13 ELSE
             IF AROLL_LEV12 NE ' ' THEN HIER12 ELSE
             IF AROLL_LEV11 NE ' ' THEN HIER11 ELSE
             IF AROLL_LEV10 NE ' ' THEN HIER10 ELSE
             IF AROLL_LEV9 NE ' ' THEN HIER9 ELSE
             IF AROLL_LEV8 NE ' ' THEN HIER8 ELSE
             IF AROLL_LEV7 NE ' ' THEN HIER7 ELSE
             IF AROLL_LEV6 NE ' ' THEN HIER6 ELSE
             IF AROLL_LEV5 NE ' ' THEN HIER5 ELSE
             IF AROLL_LEV4 NE ' ' THEN HIER4 ELSE
             IF AROLL_LEV3 NE ' ' THEN HIER3 ELSE
             IF AROLL_LEV2 NE ' ' THEN HIER2 ELSE HIER1;

  HIER/A255 = IF AROLL_LEV2 EQ AROLL_LEV3 THEN HIER2 ELSE HIERA;          



  FLAG/A1 = 'C';
  BOOKINGS/P8 = IF NUM_DAYS GT 0 THEN 1 ELSE IF NUM_DAYS LT 0 THEN (-1) ELSE 0;
  LEVEL_DESC/A60 = &&LDESC;
  MIR_SEQ1/A1 = EDIT(MIR_SEQ, '9$$$$$');
  
  RENTAL_DAYS/P12S = IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                   ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;
  RES_ST/A1 = EDIT(RESV_STATUS, '$9');
  TKTNC/A10 = IF TKT_NUM EQ '0000000000' THEN 'CAR ONLY' ELSE TKT_NUM;
  RES_SYS/A1 = IF MIR_SEQ1 EQ 'X' THEN 'S' ELSE 'A';
  FLAGC/A1 = IF TKTNC NE ' ' THEN 'Y' ELSE 'N';
                    
END
-RUN

TABLEF FILE &&EXTRACT
PRINT AIRPORT_CODE AS 'PICKUP_APT'
      BOOKINGS
      CAR_KEY
      CAR_TYPE
      FLAGC
      FLAG      
      INVOICE_DATE
      PASSNGR_NAME
      PICKUP_CITY  
      PICKUP_DATE      
      PNR_LOCATOR
      RENTAL_DAYS
      TKTNC
      TKT_NUM
      RES_ST
      RES_SYS
      RESV_STATUS
      ROLLUP_CODE AS 'ROLLCDC'
      VENDOR_CODE   
      
-* WHERE (INVOICE_DATE GE '&&FROMDT.EVAL') AND (INVOICE_DATE LE '&&TODT.EVAL') 
-IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB;
WHERE INVOICE_DATE GE '20150126'    
-NOTMOB;
-IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB;
WHERE INVOICE_DATE GE '20150409'
-NOCB;
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
-* &&WHERE10
-INCLUDE &CARDATES
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDCA
END

DEFINE FILE RPTHLDCA
CAR_TYPE1/A1 = EDIT(CAR_TYPE, '9');
CAR_TYPE2/A2 = EDIT(CAR_TYPE, '99');
CAR_TYPE3/A3 = EDIT(CAR_TYPE, '999');
CAR_TYPE4/A4 = EDIT(CAR_TYPE, '9999');
END
TABLE FILE RPTHLDCA
PRINT BOOKINGS
      CAR_KEY
      CAR_TYPE
      CAR_TYPE1
      CAR_TYPE2
      CAR_TYPE3
      CAR_TYPE4
      FLAG      
      INVOICE_DATE
      PASSNGR_NAME
      PICKUP_CITY  
      PICKUP_DATE 
      PNR_LOCATOR
      RENTAL_DAYS
      TKTNC
      TKT_NUM
      RES_ST
      RES_SYS
      RESV_STATUS
      VENDOR_CODE   
BY ROLLCDC 
ON TABLE HOLD AS RPTHLDC FORMAT FOCUS INDEX ROLLCDC
END



TABLE FILE P2P_ROLLUP_BONUS
PRINT BACK_OFFICE_ID VENDOR BEGIN_DATE END_DATE CATEGORY_ID AS 'CAT_ID' P2P_PARMS1 P2P_PARMS2 P2P_DESCRIPTION AS 'VEND_DESC' CITY_PAIR POINT_TYPE 
BY ROLLUP_CODE
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
WHERE VENDOR_TYPE EQ 'C'
ON TABLE HOLD AS NWBONUSC FORMAT FOCUS INDEX ROLLUP_CODE
END

-SET &PAIRRECSC=IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-RUN 

JOIN CLEAR *
-RUN

JOIN ROLLCDC IN RPTHLDC TO ALL ROLLUP_CODE IN NWBONUSC AS JBC
-RUN


DEFINE FILE RPTHLDC
            
BONUS_CARA/I5 = IF '&PAIRRECSC.EVAL' EQ 'N' THEN 0 ELSE
                IF (VENDOR EQ VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ ' ') AND (P2P_PARMS2 EQ ' ') THEN 1 ELSE
                IF (VENDOR EQ VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE4) AND (P2P_PARMS2 EQ ' ') THEN 1 ELSE
                IF (VENDOR EQ VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE3) AND (P2P_PARMS2 EQ ' ') THEN 1 ELSE
                IF (VENDOR EQ VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE2) AND (P2P_PARMS2 EQ ' ') THEN 1 ELSE
                IF (VENDOR EQ VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE1) AND (P2P_PARMS2 EQ ' ') THEN 1 ELSE        
                IF (VENDOR EQ VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ ' ') AND (P2P_PARMS2 EQ PICKUP_CITY) THEN 1 ELSE 
                IF (VENDOR EQ VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE4) AND (P2P_PARMS2 EQ PICKUP_CITY) THEN 1 ELSE 
                IF (VENDOR EQ VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE3) AND (P2P_PARMS2 EQ PICKUP_CITY) THEN 1 ELSE 
                IF (VENDOR EQ VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE2) AND (P2P_PARMS2 EQ PICKUP_CITY) THEN 1 ELSE 
                IF (VENDOR EQ VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE1) AND (P2P_PARMS2 EQ PICKUP_CITY) THEN 1 ELSE 0;
                
BONUS_CARB/I5 = IF '&PAIRRECSC.EVAL' EQ 'N' THEN 0 ELSE                
                IF (VENDOR NE VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE4) AND (P2P_PARMS2 EQ ' ') THEN 1 ELSE 
                IF (VENDOR NE VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE3) AND (P2P_PARMS2 EQ ' ') THEN 1 ELSE 
                IF (VENDOR NE VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE2) AND (P2P_PARMS2 EQ ' ') THEN 1 ELSE 
                IF (VENDOR NE VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE1) AND (P2P_PARMS2 EQ ' ') THEN 1 ELSE                 
                IF (VENDOR NE VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ ' ') AND (P2P_PARMS2 EQ PICKUP_CITY) THEN 1 ELSE 
                IF (VENDOR NE VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE4) AND (P2P_PARMS2 EQ PICKUP_CITY) THEN 1 ELSE 
                IF (VENDOR NE VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE3) AND (P2P_PARMS2 EQ PICKUP_CITY) THEN 1 ELSE
                IF (VENDOR NE VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE2) AND (P2P_PARMS2 EQ PICKUP_CITY) THEN 1 ELSE                
                IF (VENDOR NE VENDOR_CODE) AND (PICKUP_DATE FROM BEGIN_DATE TO END_DATE) AND (P2P_PARMS1 EQ CAR_TYPE1) AND (P2P_PARMS2 EQ PICKUP_CITY) THEN 1 ELSE 0; 
                
            
END

TABLE FILE RPTHLDC
SUM BONUS_CARA BONUS_CARB BOOKINGS RENTAL_DAYS POINT_TYPE VENDOR_CODE VENDOR CAR_TYPE P2P_PARMS1 P2P_PARMS2 CITY_PAIR POINT_TYPE INVOICE_DATE 
COMPUTE BONUS_CAR1/A1 = IF BONUS_CARA GT 0 THEN 'Y' ELSE 'N';  
COMPUTE BONUS_CAR2/A1 = IF BONUS_CARB GT 0 THEN 'Y' ELSE 'N';
BY FLAG
BY PNR_LOCATOR
BY TKTNC AS 'TKT_NUM'
BY PICKUP_DATE
BY PICKUP_CITY
BY RES_SYS
BY CAT_ID
BY VEND_DESC
WHERE BONUS_CARA NE 0 OR BONUS_CARB NE 0
-* WHERE TOTAL BONUS_CAR2 EQ 'Y'
ON TABLE HOLD AS RPTHLDC1
END


DEFINE FILE RPTHLDC1

CBONUS/P12 = IF BONUS_CAR1 EQ 'Y' AND POINT_TYPE EQ 'B' THEN BOOKINGS ELSE 
             IF BONUS_CAR1 EQ 'Y' AND POINT_TYPE EQ 'D' THEN RENTAL_DAYS ELSE 
             IF BONUS_CAR2 EQ 'Y' AND POINT_TYPE EQ 'B' THEN BOOKINGS ELSE
             IF BONUS_CAR2 EQ 'Y' AND POINT_TYPE EQ 'D' THEN RENTAL_DAYS ELSE 0;
CMULTIP/P12 = IF CBONUS EQ 0 THEN 0 ELSE
              IF POINT_TYPE EQ 'B' THEN BOOKINGS ELSE 
              IF POINT_TYPE EQ 'D' THEN RENTAL_DAYS ELSE 0;             
             
END

TABLE FILE RPTHLDC1
PRINT CBONUS BOOKINGS RENTAL_DAYS POINT_TYPE CMULTIP INVOICE_DATE
BY PNR_LOCATOR
BY TKT_NUM
BY RES_SYS
BY CAT_ID
BY VEND_DESC
WHERE CBONUS NE 0
ON TABLE HOLD AS CARHLD
END

-* -NOCBONUS1;

-IF &RECORDS NE 0 THEN GOTO SETA ELSE GOTO SETA1;

-SETA
-SET &&CARDATA='Y';
-GOTO XXIT;

-SETA1
-SET &&CARDATA='N';
-GOTO XXIT;


-XXIT;



 
 
 











