-*9/14/16-JEM-S-23779-Created for new Bonus Point file ABP2PBS
-*09/26/2017 - DLV - S-37268 - UPDATED defines ND_EMB ND_DPT

-INCLUDE SETECHO
SET ASNAMES = ON
SET EMPTYREPORT=ON
-SET HOLDATTR = ON;
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';
-RUN

DEFINE FILE &&EXTRACT
  CC/A2 = EDIT(CREDIT_CARD, '99');
  21ADV/A1 = IF ADV_PURCH GE 21 THEN '+' ELSE ' ';
  14ADV/A1 = IF ADV_PURCH GE 14 THEN '+' ELSE ' ';
  7ADV/A1 =  IF ADV_PURCH GE 7  THEN '+' ELSE ' ';
  ONLA/A1 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN '+' ELSE ' ';
  PREF_CC/A1 = IF CC EQ 'AX' THEN 'Y' ELSE 'N';
  LEVEL_DESC/A60 = &&LDESC;
  EX_FARE/D12.2CM = IF SEG_NBR EQ '01' THEN EXCH_NET_FARE ELSE 0;
  EX_RF_FLAG/A1 = IF VOID_DATE NE 0 THEN ' ' ELSE 
                  IF (((RF_FLAG EQ 'F' OR 'P') AND (EMBARK NE 'EX1' OR 'FP2' OR 'EX5') AND (SEG_COUNT LE 0)) OR (EMBARK EQ 'RF1')) THEN 'R' ELSE
                  IF (((EXSALE NE ' ') AND (SEG_COUNT GE 0)) OR ((EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (RF_FLAG EQ ' ')))  THEN 'E' ELSE ' ';
  FARE_PAID1/D12.2CM = SEG_AMT + SEG_TAX;
  FARE_PAID/D12.2C = IF DOC_NUMBER NE '0000000000' THEN EX_FARE ELSE FARE_PAID1;
  HTL_BKD/A1 = IF TKT_NUM NE ' ' THEN '+' ELSE ' ';
-* HTL_BKD/A1 = IF HOTEL_FLAG NE ' ' THEN '+' ELSE ' ';
  NET_TKT_CNT/D8CS   = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID1 GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  RO_FLAG/A1 = IF RNDT_FLAG EQ 'Y' THEN 'R' ELSE 'O';                           
  TKT_PURCH/D8.2C      = IF (TICKET_CODE EQ '1') AND
                             (SEG_NBR EQ '01') AND
                             (FARE_PAID GE 0) AND
                             (SEG_COUNT EQ 1) AND 
                             (CONJ_REL EQ 1) THEN 1 ELSE 0;
  TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';                       
XTRAN_DT/MDYY = TRN_DATE;
TVL_DTE/MDYY = FST_DPT_DATE;
TKTS/A1 = EDIT(TKT_SORT, '$$$$$$$$$$9');

FLAGA/A1 = IF TKT_NUM NE ' ' THEN 'Y' ELSE 'N';

MIR_SEQ1/A1 = EDIT(MIR_SEQ, '9$$$$$');

-* Defines on Previous Defines


  DISSAVINGS/P12.2CM = IF EMBARK EQ 'DT1' THEN 0 ELSE FARE_PAID1-SEG_LOWEST;
-*   DECLINE_AMT/D12.2C   = IF EMBARK EQ 'DT1' THEN 0 ELSE
-*                          TKT_AMOUNT - LOWEST_AMT;
  VASAVINGS/D12.2CSM = SEG_DISCOUNT - FARE_PAID;
  NEW_STAY/P9 = IF RO_FLAG EQ 'O' THEN 0 ELSE STAY;
  RES_SYS/A1 = IF MIR_SEQ1 EQ 'X' THEN 'S' ELSE 'A';

 -*HIER15_FLAG/A1 = IF AROLL_LEV15 NE ' ' AND AROLL_LEV14 NE ' ' AND AROLL_LEV13 NE ' '
 HIER1/A15 = AROLL_LEV1;
 HIER2/A32 = AROLL_LEV1||'|'||AROLL_LEV2;
 HIER3/A50 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3;
 HIER4/A66 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4;
 HIER5/A85 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5;
 HIER6/A100 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6;
 HIER7/A120 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7;
 HIER8/A135 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8;
 HIER9/A151 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9;
 HIER10/A168 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10;       
 HIER11/A185 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11;
 HIER12/A202 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12;
 HIER13/A219 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12||'|'||AROLL_LEV13;
 HIER14/A236 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12||'|'||AROLL_LEV13||'|'||AROLL_LEV14;
 HIER15/A255 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12||'|'||AROLL_LEV13||'|'||AROLL_LEV14||'|'||AROLL_LEV15;
 
 
 
 HIERA/A255 = IF AROLL_LEV15 NE ' ' THEN HIER15 ELSE
             IF AROLL_LEV14 NE ' ' THEN HIER14 ELSE
             IF AROLL_LEV13 NE ' ' THEN HIER13 ELSE
             IF AROLL_LEV12 NE ' ' THEN HIER12 ELSE
             IF AROLL_LEV11 NE ' ' THEN HIER11 ELSE
             IF AROLL_LEV10 NE ' ' THEN HIER10 ELSE
             IF AROLL_LEV9 NE ' ' THEN HIER9 ELSE
             IF AROLL_LEV8 NE ' ' THEN HIER8 ELSE
             IF AROLL_LEV7 NE ' ' THEN HIER7 ELSE
             IF AROLL_LEV6 NE ' ' THEN HIER6 ELSE
             IF AROLL_LEV5 NE ' ' THEN HIER5 ELSE
             IF AROLL_LEV4 NE ' ' THEN HIER4 ELSE
             IF AROLL_LEV3 NE ' ' THEN HIER3 ELSE
             IF AROLL_LEV2 NE ' ' THEN HIER2 ELSE HIER1;

-IF '&&ROLLUP.EVAL' NE 'TMOBIL-R' GOTO STDHIER;             
  HIER/A255 = HIER4;         
-GOTO DNEHIER;

-STDHIER;          
  HIER/A255 = IF AROLL_LEV2 EQ AROLL_LEV3 THEN HIER2 ELSE HIERA;          

-DNEHIER;

TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';

DOC_NUM1/A10 = DOC_NUMBER;
EMBARK1/A3 = SUBSTR(176, C_ITIN, 1, 3, 3, EMBARK1); 
EMBARK2/A3 = SUBSTR(176, C_ITIN, 5, 7, 3, EMBARK2); 
EMBARK3/A3 = SUBSTR(176, C_ITIN, 9, 11, 3, EMBARK3); 
EMBARK4/A3 = SUBSTR(176, C_ITIN, 13, 15, 3, EMBARK4); 
DIRECT/A1 = IF EMBARK3 EQ ' ' THEN 'D' ELSE IF EMBARK1 EQ EMBARK3 THEN 'D' ELSE 'I';  
D_EMB/A25 = CITYPAIR.EMBARK;
D_RTE/A25 = CITYPAIR.ROUTE;
-*ND_EMB/A25=NDO_APT.ND_ORG;
-*ND_RTE/A25=NDD_APT.ND_DST;
ND_EMB/A25=ND_ORG;
ND_RTE/A25=ND_DST;

DIR_APTS/A51=D_EMB||'-'||D_RTE;
NDIR_APTS/A51=ND_EMB||'-'||ND_RTE;

-INCLUDE TRANTYPE
END
-RUN


TABLEF FILE &&EXTRACT
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      DOC_NUMBER
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
 WHERE VOID_DATE EQ 0
 WHERE EMBARK NE 'DT1' OR 'DT2' OR 'DT4' OR 'EX1' OR 'EX5' OR 'FP2' OR 'FP3' OR 'RF1' 
 WHERE EX_FLAG EQ ' '
 WHERE EXCHG_SALE EQ ' '
 WHERE RF_FLAG EQ ' '
 -IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB;
 WHERE TRN_DATE GE '20150126'
 -NOTMOB;
 -IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB;
 WHERE TRN_DATE GE '20150409'
 -NOCB;
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE &AIRDATES
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDSSM
END
-RUN


DEFINE FILE RPTHLDSSM
FLAG/A1 = 'A';
END
-RUN
TABLE FILE RPTHLDSSM
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
BY TKT_NUM 
ON TABLE HOLD AS RPTHLDSS1M FORMAT FOCUS 
END
-RUN



-* EXTRACT NEW EXCHANGE SALE RECORD

TABLEF FILE &&EXTRACT
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      DOC_NUMBER AS 'DOC_NUM'
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
 WHERE VOID_DATE EQ 0
 WHERE EMBARK NE 'DT1' OR 'DT2' OR 'DT4' OR 'EX1' OR 'EX5' OR 'FP2' OR 'FP3' OR 'RF1'  
 WHERE EX_FLAG EQ ' '
 WHERE EXCHG_SALE NE ' '
-IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB1;
 WHERE TRN_DATE GE '20150126'
 -NOTMOB1;
 -IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB1;
 WHERE TRN_DATE GE '20150409'
 -NOCB1;
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE &AIRDATES
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDNEM
END
-RUN


DEFINE FILE RPTHLDNEM
FLAG/A1 = 'A';
END
-RUN
TABLE FILE RPTHLDNEM
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
BY TKT_NUM 
ON TABLE HOLD AS RPTHLDNE1M FORMAT FOCUS 
END

TABLE FILE RPTHLDNEM
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      DOC_NUMBER AS 'DOC_NUM'
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
BY DOC_NUMBER 
ON TABLE HOLD AS RPTHLDNE2M
END
-RUN


DEFINE FILE RPTHLDNE2M
DOCN/A12 = ''''||DOC_NUMBER||'''';
END
TABLE FILE RPTHLDNE2
SUM DOCN
BY DOC_NUMBER NOPRINT
ON TABLE SAVE AS NEXCHHLDM
END
-RUN



-* EXTRACT OLD EXCHANGE SALE RECORD

TABLEF FILE &&EXTRACT
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      DOC_NUMBER
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM AS 'DOC_NUM' 
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
 WHERE VOID_DATE EQ 0
 WHERE EMBARK NE 'DT1' OR 'DT2' OR 'DT4' OR 'EX1' OR 'EX5' OR 'FP2' OR 'FP3' OR 'RF1' 
 WHERE EX_FLAG NE ' '
 -* WHERE EXCHG_SALE EQ ' '
-IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB2;
 WHERE TKT_DATE GE '20150126'
 -NOTMOB2;
 -IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB2;
 WHERE TKT_DATE GE '20150409'
 -NOCB2;
 -********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-* -INCLUDE &AIRDATES
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDOEM
END
-RUN


DEFINE FILE RPTHLDOEM
FLAG/A1 = 'A';
END
-RUN


TABLE FILE RPTHLDOEM
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
BY TKT_NUM 
WHERE DOC_NUM IN FILE NEXCHHLDM
ON TABLE HOLD AS RPTHLDOE1M FORMAT FOCUS
END
-RUN


-* EXTRACT REFUND RECORDS THAT THE TRANSACTION DATE OCCURRED BEFORE THE TRAVEL DATE
TABLEF FILE &&EXTRACT
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      DOC_NUMBER
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM AS 'DOC_NUM' 
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
 WHERE VOID_DATE EQ 0
 WHERE RF_FLAG NE ' '
 -********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE &AIRDATES
WHERE TRN_DATE LE FST_DPT_DATE
-IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB3;
 WHERE TKT_DATE GE '20150126'
 -NOTMOB3;
 -IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB3;
 WHERE TKT_DATE GE '20150409'
 -NOCB3;
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDRBM
END
-RUN


TABLE FILE RPTHLDRBM
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
BY TKT_NUM
ON TABLE HOLD AS RPTHLDRB1M FORMAT FOCUS
END
-RUN

-* EXTRACT REFUND RECORDS THAT THE TRANSACTION DATE OCCURRED AFTER THE TRAVEL DATE
TABLEF FILE &&EXTRACT
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      DOC_NUMBER
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM AS 'DOC_NUM' 
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      TKT_DATE
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
 WHERE VOID_DATE EQ 0
 WHERE RF_FLAG NE ' '
 -********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-* -INCLUDE &AIRDATES
-* WHERE FST_DPT_DATE GE TRN_DATE
WHERE TRN_DATE GE &&FROMDT AND TRN_DATE LE &&TODT
WHERE TRN_DATE GE FST_DPT_DATE
-IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB4;
 WHERE TKT_DATE GE '20150126'
 -NOTMOB4;
 -IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB4;
 WHERE TKT_DATE GE '20150409'
 -NOCB4;
 -INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDRAM
END
-RUN

TABLE FILE RPTHLDRAM
SUM 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
BY TKT_NUM
-* -INCLUDE &AIRDATES
ON TABLE HOLD AS RPTHLDRAA1M
END
-RUN


TABLE FILE RPTHLDRAA1M
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DIRECT
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
      TRN_DATE
BY TKT_NUM
ON TABLE HOLD AS RPTHLDRA1M FORMAT FOCUS 
END
-RUN





-SET &HLDPATH=TEMPPATH(50,'A50');
-SET &HNKAM=&HLDPATH || 'RPTHLDSS1M.FOC';
-SET &HNKBM=&HLDPATH || 'RPTHLDNE1M.FOC';
-SET &HNKCM=&HLDPATH || 'RPTHLDOE1M.FOC';
-SET &HNKDM=&HLDPATH || 'RPTHLDRB1M.FOC';
-SET &HNKEM=&HLDPATH || 'RPTHLDRA1M.FOC';
-RUN


-SET &FILENAME = 'RPTHLDSS1M'; 
-RUN

-DOS STATE &HNKAM
-SET &HOLDFILEAM = IF &RETCODE.EVAL EQ 0 THEN &HNKAM | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKBM
-SET &HOLDFILEBM = IF &RETCODE.EVAL EQ 0 THEN &HNKBM | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKCM
-SET &HOLDFILECM = IF &RETCODE.EVAL EQ 0 THEN &HNKCM | ' AS ' | &FILENAME ELSE ' ';
 
-DOS STATE &HNKDM
-SET &HOLDFILEDM = IF &RETCODE.EVAL EQ 0 THEN &HNKDM | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKEM
-SET &HOLDFILEEM = IF &RETCODE.EVAL EQ 0 THEN &HNKEM | ' AS ' | &FILENAME ELSE ' ';

USE ADD 
&HOLDFILEAM
&HOLDFILEBM
&HOLDFILECM
&HOLDFILEDM
&HOLDFILEEM
END
-RUN


TABLE FILE RPTHLDSS1M
PRINT EX_RF_FLAG
      FST_DPT_DATE 
      PASSNGR_NAME
      PNR_LOCATOR
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      VAL_AIRLINE 
      EX_FLAG
      EXCHG_SALE
      TKT_SORT
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      ROLLUP_CODE
      TKT_NUM
      DIRECT
      ORG_APC
      DST_APC
      C_ITIN
      ROLLUP_CODE
      DIR_APTS
      NDIR_APTS
      TRN_DATE
BY AIR_KEY
ON TABLE HOLD AS MXTWO 
END
-RUN
-GOTO XXIT;





-IF &RECORDS NE 0 THEN GOTO SETA ELSE GOTO SETA1;

-SETA
-SET &&AIRDATA='Y';
-GOTO XXIT;

-SETA1
-SET &&AIRDATA='N';
-GOTO XXIT;


-XXIT;



 

 

















