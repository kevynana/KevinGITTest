-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* Created for the new quarterly review -  
-* Changed to use CITYPAIR.INTL_DOM vs. AIR_MAIN - Steve - 02/26/2007 
-******************************************************************************
-INCLUDE SETECHO
SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-SET &&GIF.&SVGFILE= ' ';
-SET &&GIF.&SVGFILE2=  ' ';
-SET &IDFLG = ' ';
-SET &SVGFILE = ' ';
-SET &GRAPHSAVE = ' ';
-SET &&CARIG = ' ';

-SET &SVGFILE2 = ' ';
-SET &GRAPHSAVE2 = ' ';
-SET &&CARIG2 = ' ';
-SET &XY1 = ' ';
-SET &XY2 = ' ';


DEFINE FILE &&EXTRACT 

FARE_PAID/D12.2=SEG_AMT + SEG_TAX ;
MRK_CNT/D8     = IF (TICKET_CODE EQ '1') AND
                     (FARE_PAID GE 0) AND
                     (SEG_COUNT EQ 1) AND 
                     (CONJ_REL EQ 1) THEN 1 ELSE 
                  IF (TICKET_CODE EQ '1') AND
                     (EX_FLAG NE ' ') THEN (-1) ELSE 
                  IF (TICKET_CODE EQ '1') AND
                     (RF_FLAG NE ' ') THEN (-1) ELSE 0;     
NEW_SEG_MILES/D10 = SEG_MILES;

CLIENTCODE/A8 = '&&ROLLUP.EVAL';                       
-INCLUDE QRFTRANA

END

TABLEF FILE &&EXTRACT
PRINT CITYPAIR.INTL_DOM AS 'INT_DOM'
      AIRLINE
      AIRLINE_NAME
      CURRENT
      FARE_PAID
      MRK_CNT
      CLIENTCODE AS 'ROLLUP_CODE'  
      NEW_SEG_MILES
      PRIOR
      PYTD
      TRAN
      YEAR
      TRN_DATE
WHERE (TRN_DATE GE '&&FROMDT.EVAL') AND (TRN_DATE LE '&&TODT.EVAL') OR
      (TRN_DATE GE '&&FXDATE.EVAL') AND (TRN_DATE LE '&&TXDATE.EVAL')      
WHERE VOID.VOID_DATE EQ 0 
-IF &&INTDOM EQ 'T' THEN GOTO SKIP;
WHERE CITYPAIR.INTL_DOM EQ '&&INTDOM.EVAL'
-SKIP
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-INCLUDE RPTPARMS

ON TABLE HOLD AS DOMCARI 
END
-RUN
-SET &&NOCRA = IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-IF &LINES EQ 0 THEN GOTO NOCRA;

-* Set up year variables for graph legend
TABLE FILE DOMCARI
SUM YEAR
BY YEAR NOPRINT 
ON TABLE SAVE 
END
-RUN


-SET &CNT = IF &LINES EQ 1 THEN 2 ELSE 1;
-REPEAT TOEND &LINES TIMES
-READ SAVE &XY.4.
-SET &XY.&CNT = '&XY.EVAL';
-SET &CNT = &CNT + 1;
-TOEND
-CLOSE SAVE
-TYPE &XY1 &XY2


-IF &LINES EQ 2 THEN GOTO TWOYEARS;
DEFINE FILE DOMCARI
-INCLUDE QRGET1YR
END
  
TABLE FILE DOMCARI
SUM YEAR1
BY YEAR NOPRINT
ON TABLE SAVE AS SAVE1YR
END
-RUN
-READ SAVE1YR &XY1.4.
-TYPE &XY1
-TWOYEARS


DEFINE FILE DOMCARI
  
CMAMT/P12.2  = IF CURRENT EQ 'Y' THEN FARE_PAID ELSE 0;
PMAMT/P12.2  = IF PYTD EQ 'Y' THEN FARE_PAID ELSE 0;
CMCNT/D8  = IF CURRENT EQ 'Y' THEN MRK_CNT ELSE 0;
PMCNT/D8  = IF PYTD EQ 'Y' THEN MRK_CNT ELSE 0;
CMILE/D10  = IF CURRENT EQ 'Y' THEN NEW_SEG_MILES ELSE 0;
PMILE/D10  = IF PYTD EQ 'Y' THEN NEW_SEG_MILES ELSE 0;
AIRLINEN/A12 = LCWORD (12, AIRLINE_NAME, AIRLINEN);
FLAG/A1 = 'A';
END


TABLE FILE DOMCARI 
 SUM CMAMT
     PMAMT
     CMCNT
     PMCNT
     CMILE
     PMILE 
     FLAG
 BY ROLLUP_CODE    
 BY AIRLINE
 BY AIRLINEN
ON TABLE HOLD AS DCARI2
END
-RUN


TABLE FILE DCARI2
 PRINT *
RANKED BY HIGHEST CMCNT NOPRINT
ON TABLE HOLD AS DCARI3 
END
-RUN


-SET &RECFOUND = &RECORDS;



DEFINE FILE DCARI3
  LIST/D9 = IF AIRLINE NE LAST AIRLINE
            THEN (LAST LIST + 1) ELSE LAST LIST;
  DRANK/D9 = RANK;
  ERANK/D9 = IF RANK EQ LAST RANK THEN (RANK + 1) ELSE RANK;
  FRANK/D9 = IF ERANK EQ LAST ERANK THEN (ERANK + 1) ELSE ERANK;
  GRANK/D9 = IF FRANK EQ LAST FRANK THEN (FRANK + 1) ELSE FRANK;
  ARANK/A11 = FTOA(DRANK, '(D9)', ARANK);
-*   ARANK/A11 = FTOA(GRANK, '(D9)', ARANK);

  ARANK1/A9 = EDIT(ARANK, '$$999999999');
  RANK_VALUE/A9 = IF LIST GT 10 THEN 'Other' ELSE ARANK1;

  RANK_LABEL/A12 = IF RANK_VALUE NE 'Other' THEN AIRLINEN 
                      ELSE 'Other';
  RANK_LABEL2/A9 = IF RANK_VALUE NE 'Other' THEN AIRLINE
                      ELSE 'Other';    
  LINE/A5 = ' ';
-*  ACRLN/A25 = IF GRANK EQ 1 THEN '         ' | RANK_LABEL ELSE 
-*                 IF GRANK EQ 2 THEN '        ' | RANK_LABEL ELSE
-*                 IF GRANK EQ 3 THEN '       ' | RANK_LABEL ELSE
-*                 IF GRANK EQ 4 THEN '      ' | RANK_LABEL ELSE
-*                 IF GRANK EQ 5 THEN '     ' | RANK_LABEL ELSE
-*                 IF GRANK EQ 6 THEN '    ' | RANK_LABEL ELSE
-*                 IF GRANK EQ 7 THEN '   ' | RANK_LABEL ELSE
-*                 IF GRANK EQ 8 THEN '  ' | RANK_LABEL ELSE
-*                 IF GRANK EQ 9 THEN ' ' | RANK_LABEL ELSE RANK_LABEL;
 RANK_VAL/A1 =  IF GRANK EQ '1' OR '2' OR '3' THEN 'Y' ELSE 'N';
 PAAMT/D12 = IF RANK_VAL EQ 'Y' THEN CMAMT ELSE 0;              
END
-RUN

-IF &RECFOUND EQ 0 GOTO AROUNDCARI;

TABLE FILE DCARI3
SUM CMAMT
    PMAMT
    AIRLINE
BY ROLLUP_CODE    
-* BY ACRLN
BY RANK_VALUE  
BY RANK_LABEL2      
ON TABLE HOLD AS DCARI4
END
-RUN


-SET &IDFLG = &&INTDOM;
-SET &SVGFILE = 'CARI' | &IDFLG;
-SET &GRAPHSAVE = 'ON GRAPH HOLD AS &SVGFILE.EVAL FORMAT SVG';
-SET &&CARIG = '&SVGFILE.EVAL' | .SVG ;

-IF &&SKIPGRAPH EQ 'Y' THEN GOTO AROUNDCARI;
DEFINE FILE DCARI4
-*  RANKLABEL1/A12 = LJUST(12,RANK_LABEL,RANKLABEL);
 RANKLABEL/A5 = EDIT(RANK_LABEL2,'99999$$$$');
END
  
GRAPH FILE DCARI4
SUM CMAMT AS 'Fare Paid &XY2.EVAL'
    PMAMT AS 'Fare Paid &XY1.EVAL' 
ACROSS RANKLABEL AS ' ' 
ON GRAPH SET LOOKGRAPH VBAR
ON GRAPH SET BARNUMB OFF
ON GRAPH SET 3D OFF
ON GRAPH SET VZERO ON
ON GRAPH SET GRID OFF
ON GRAPH SET GRAPHSTYLE *
setGraphType(17);
setLegendDisplay(true);
-* setLegendPosition(1);
setLegendPosition(1);
setFontSizeAbsolute(getLegendText(),true);
setAutofit(getLegendText(),false);
setFontSize(getLegendText(),12);
setFontStyle(getLegendText(),0);
setLegendMarkerPosition(1);
setO1LabelDisplay(true);
setFontSizeAbsolute(getO1Label(),true); 
setAutofit(getO1Label(),false);
setFontStyle(getO1Label(),0);
setFontSize(getO1Label(),12);
setO1LabelRotate(3);
setO1MajorGridDisplay(false);
-* setLineWidth(get01MajorGrid(),4);
-* setO1MajorGridStyle(3);
setO1MinorGridDisplay(false);
setFontSizeAbsolute(getY1Label(),true);
setAutofit(getY1Label(),false);
setY1LabelDisplay(true);
setY1LabelFormat(6);
-* setY1MajorGridDisplay(false);
-* setY1AxisLineDisplay(false);

-* setO1MajorTickStyle(3);
setFontSize(getY1Label(),12);
setFontStyle(getY1Label(),0);
setY1AxisSide(0);

setTextJustHoriz(getSubtitle(), 1);
setSubtitleString("Fare Paid by Air Carrier");
setFontSizeAbsolute(getSubtitle(),true);
setAutofit(getSubtitle(),false);
setFontSize(getSubtitle(),12);
setFontStyle(getSubtitle(),0);
setTitleString(" ");

-* setTextJustHoriz(getTitle(), 1);
-* setTitleString("Fare Paid by Air Carrier");
-* setFontSizeAbsolute(getTitle(),true);
-* setAutofit(getTitle(),false);
-* setFontSize(getTitle(),12);
-* setFontStyle(getTitle(),0);
-* setSubtitleString(" ");
setSeriesFillColor(0, new Color, 0 64 128));
setSeriesFillColor(1, new Color, 115 160 247));
ENDSTYLE
&GRAPHSAVE 
-* ON GRAPH HOLD AS CARID FORMAT SVG
END
-RUN
-SET &&GIF.&SVGFILE=IF &LINES GT 0 THEN 'Y' ELSE 'N';

-AROUNDCARI



TABLE FILE DCARI3
SUM CMCNT AS 'TCCNT'
    PMCNT AS 'TPCNT'
BY FLAG
ON TABLE HOLD AS HOLDONE
END
-RUN

TABLE FILE DCARI3
SUM CMCNT
    PMCNT
    RANK_LABEL2
BY FLAG
BY RANK_LABEL
-* BY ACRLN
ON TABLE HOLD AS HOLDTWO
END
-RUN


MATCH FILE HOLDTWO
PRINT CMCNT
      PMCNT
      RANK_LABEL
      RANK_LABEL2
-*       ACRLN
BY FLAG
ON TABLE HOLD
RUN
FILE HOLDONE
SUM TCCNT
    TPCNT
BY FLAG
AFTER MATCH HOLD AS HOLD3 OLD-OR-NEW
END
-RUN

TABLE FILE HOLD3
SUM CMCNT
    PMCNT
COMPUTE PCTCUR/P3 = IF ((TCCNT LT 1) AND (TCCNT GT (-1))) THEN 0 ELSE
                             ((CMCNT/TCCNT)*100); 
COMPUTE PCTPR/P3 =  IF ((TPCNT LT 1) AND (TPCNT GT (-1))) THEN 0 ELSE
                             ((PMCNT/TPCNT)*100);    
BY RANK_LABEL2
-* BY ACRLN
ON TABLE HOLD AS HOLD4
END
-RUN

-SET &SVGFILE2 = 'CARIP' | &IDFLG;
-SET &GRAPHSAVE2 = 'ON GRAPH HOLD AS &SVGFILE2.EVAL FORMAT SVG';
-SET &&CARIG2 = '&SVGFILE2.EVAL' | .SVG ;

-IF &&SKIPGRAPH EQ 'Y' THEN GOTO AROUNDCARIP;
DEFINE FILE HOLD4
 RANKLABEL/A5 = EDIT(RANK_LABEL2,'99999$$$$');
END
GRAPH FILE HOLD4
SUM PCTCUR AS '% of Total Markets &XY2.EVAL'
      PCTPR AS '% of Total Markets &XY1.EVAL'
ACROSS RANKLABEL AS ' '
ON GRAPH SET LOOKGRAPH VBAR
ON GRAPH SET BARNUMB OFF
ON GRAPH SET 3D OFF
ON GRAPH SET VZERO ON
ON GRAPH SET GRID OFF
ON GRAPH SET GRAPHSTYLE *
setGraphType(17);
setLegendDisplay(true);
-* setLegendPosition(1);
setLegendPosition(1);
setFontSizeAbsolute(getLegendText(),true);
setAutofit(getLegendText(),false);
setFontSize(getLegendText(),12);
setFontStyle(getLegendText(),0);
setLegendMarkerPosition(1);
setO1LabelDisplay(true);
setFontSizeAbsolute(getO1Label(),true); 
setAutofit(getO1Label(),false);
setFontStyle(getO1Label(),0);
setFontSize(getO1Label(),12);
setO1LabelRotate(3);
setO1MajorGridDisplay(false);
setO1MinorGridDisplay(false);
setFontSizeAbsolute(getY1Label(),true);
setAutofit(getY1Label(),false);
setY1LabelDisplay(true);
setY1LabelFormat(1);
setFontSize(getY1Label(),12);
setFontStyle(getY1Label(),0);
setY1AxisSide(0);
setTextJustHoriz(getSubtitle(), 1);
setSubtitleString("Usage Percentage by Air Carrier");
setFontSizeAbsolute(getSubtitle(),true);
setAutofit(getSubtitle(),false);
setFontSize(getSubtitle(),12);
setFontStyle(getSubtitle(),0);
setTitleString(" ");
setSeriesFillColor(0, new Color, 0 64 128));
setSeriesFillColor(1, new Color, 115 160 247));
ENDSTYLE 
&GRAPHSAVE2 
END
-RUN

-SET &&GIF.&SVGFILE2=IF &LINES GT 0 THEN 'Y' ELSE 'N';

-AROUNDCARIP


TABLE FILE DCARI3
SUM CMAMT
    CMCNT
    CMILE
    PMAMT
    PMCNT
    PMILE
    PAAMT
 BY ROLLUP_CODE
 BY RANK_VALUE
 BY RANK_LABEL
 BY RANK_LABEL2
 BY RANK_VAL
ON TABLE HOLD AS DCARI4
END
-RUN


DEFINE FILE DCARI4
AIRL/A2 = EDIT(RANK_LABEL2, '99$$$$$$$');
AL/A4 =  '''' |AIRL|'''';
END
TABLE FILE DCARI4
PRINT AL
BY RANK_LABEL2 NOPRINT
WHERE RANK_LABEL2 NE 'Other'
ON TABLE SAVE AS TOPCARI
END
-RUN


DEFINE FILE DCARI4
AIR/A2=  IF RANK_LABEL2 EQ 'Other' THEN ' ' ELSE EDIT(RANK_LABEL2, '99$$$$$$$');
RNK_LBL/A15 = IF RANK_LABEL EQ 'Other' THEN RANK_LABEL ELSE AIR | '-' | RANK_LABEL;
END
TABLE FILE DCARI4
SUM CMAMT
    CMCNT
    CMILE
    PMAMT
    PMCNT
    PMILE
    PAAMT
 BY ROLLUP_CODE
 BY RANK_VALUE
 BY RNK_LBL
ON TABLE HOLD AS DCARI5
END
-RUN



TABLE FILE DCARI5
PRINT ROLLUP_CODE RANK_VALUE RNK_LBL AS 'AIRLINEN' CMAMT CMCNT CMILE PMAMT PMCNT PMILE
ON TABLE SAVE
END
-RUN



MODIFY FILE QRCARIR
FIXFORM ROLLUP_CODE/8 RANK_VALUE/9 AIRLINEN/15 CMAMT/12 CMCNT/8 CMILE/10 PMAMT/12 PMCNT/8 PMILE/10
MATCH ROLLUP_CODE RANK_VALUE AIRLINEN
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN

TABLE FILE DOMCARI
SUM YEAR
BY YEAR NOPRINT
ON TABLE HOLD AS DCARI 
END
-RUN

-NOCRA
