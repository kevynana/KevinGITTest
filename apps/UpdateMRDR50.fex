-**************************************************************************************************
-* UpdateMRDR50.fex
-* Update MR_50 and DR_50 
-* 07/27/15 - DEB - S-10299 COMMENTED OUT SET &ECHO=ALL
-**************************************************************************************************
-*-SET &ECHO=ALL;
-INCLUDE SETECHO
SET ASNAME = ON
-SET &DATAPATH = 'D:\TNT\TTRACKER\DATA\';
FILEDEF LOGROLL DISK D:\TNT\LOGROLL.TXT (APPEND

TABLE FILE ROLLUP
PRINT COMP QTR_ENABLE
BY ROLLUP_CODE
-*WHERE ROLLUP_CODE EQ 'ABCD-R' OR 'TCS-R'
ON TABLE SAVE AS ALLROLLS
END
-RUN
-SET &COUNTER = &LINES;

-REPEAT TOEND &COUNTER TIMES
-READ ALLROLLS  NOCLOSE &&ROLLUP.8. &&COMP.6. &&QTR.1.

-WRITE LOGROLL STARTING ==> &&ROLLUP.EVAL

-IF '&&QTR.EVAL' EQ 'X' THEN GOTO QTR_CLIENTS;

-NONQTR
-SET &MR50    = '&DATAPATH.EVAL' || 'M_' || '&&COMP.EVAL' || '.FOC';
-SET &DR50    = '&DATAPATH.EVAL' || 'D_' || '&&COMP.EVAL' || '.FOC';
-SET &AIRMAIN = '&DATAPATH.EVAL' || 'A_' || '&&COMP.EVAL' || '.FOC';

USE 
&MR50 AS MR_50
&AIRMAIN AS AIR_MAIN
END

TABLE FILE MR_50
PRINT VAL_AIRLINE AS 'AIRLINE'
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
WHERE EMBARK EQ 'RF1' AND AIRLINE EQ ' '
ON TABLE HOLD
END
-RUN
-IF &LINES EQ 0 THEN GOTO CHK_DR50;

MODIFY FILE MR_50
FIXFORM FROM HOLD
MATCH * KEYS SEG CITYPAIR
  ON MATCH UPDATE AIRLINE
DATA ON HOLD
END
-RUN

-CHK_DR50
USE 
&DR50 AS DR_50
&AIRMAIN AS AIR_MAIN
END
TABLE FILE DR_50
PRINT VAL_AIRLINE AS 'AIRLINE'
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
WHERE EMBARK EQ 'RF1' AND AIRLINE EQ ' '
ON TABLE HOLD
END
-RUN
-IF &LINES EQ 0 THEN GOTO DONE_DR50;

MODIFY FILE DR_50
FIXFORM FROM HOLD
MATCH * KEYS SEG CITYPAIR
  ON MATCH UPDATE AIRLINE
DATA ON HOLD
END
-RUN  
  
-DONE_DR50
-GOTO NEXTROLLUP; 
      
-QTR_CLIENTS
-SET &CNT=0;
-REPEAT ENDREPEAT2 12 TIMES

-SET &FN= IF &CNT LE 9 THEN '&CNT.EVAL' 
- ELSE IF &CNT EQ 10 THEN 'Z' ELSE IF &CNT EQ 11 THEN 'Y';

-SET &CNT = &CNT + 1;

-SET &MR50    = '&DATAPATH.EVAL' || 'M' | '&FN.EVAL' || '&&COMP.EVAL' || '.FOC';
-SET &DR50    = '&DATAPATH.EVAL' || 'D' | '&FN.EVAL' || '&&COMP.EVAL' || '.FOC';
-SET &AIRMAIN = '&DATAPATH.EVAL' || 'A' | '&FN.EVAL' || '&&COMP.EVAL' || '.FOC';

USE 
&MR50 AS MR_50
&AIRMAIN AS AIR_MAIN
END

TABLE FILE MR_50
PRINT VAL_AIRLINE AS 'AIRLINE'
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
WHERE EMBARK EQ 'RF1' AND AIRLINE EQ ' '
ON TABLE HOLD
END
-RUN
-IF &LINES EQ 0 THEN GOTO CHK_DR50_2;

MODIFY FILE MR_50
FIXFORM FROM HOLD
MATCH * KEYS SEG CITYPAIR
  ON MATCH UPDATE AIRLINE
DATA ON HOLD
END
-RUN

-CHK_DR50_2
USE 
&DR50 AS DR_50
&AIRMAIN AS AIR_MAIN
END
TABLE FILE DR_50
PRINT VAL_AIRLINE AS 'AIRLINE'
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
WHERE EMBARK EQ 'RF1' AND AIRLINE EQ ' '
ON TABLE HOLD
END
-RUN
-IF &LINES EQ 0 THEN GOTO NEXTQTRFILE;

MODIFY FILE DR_50
FIXFORM FROM HOLD
MATCH * KEYS SEG CITYPAIR
  ON MATCH UPDATE AIRLINE
DATA ON HOLD
END
-RUN  

-NEXTQTRFILE
-ENDREPEAT2

-NEXTROLLUP    

-WRITE LOGROLL DONE ==> &&ROLLUP.EVAL

-TOEND      
-RUN      