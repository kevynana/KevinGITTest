-*6/29/16-JEM-S-16738 Created for new report that shows global data
-*11/7/16-JEM-S-26142-Adding counts/annualized spend fields per Patti 
-*3/02/17-JEM-S-31069-Updating Prior year to date to be Prior annual year 
-*8/29/17-JEM-S-34936 Replaced COMPANY_NAME WITH LEVEL_DESC

-INCLUDE SETECHO
SET ASNAMES = ON


-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED

-*========================================================================


-SET &CARDATES = &&WEB_PATH || 'CARDATES.fex';

DEFINE FILE CR_50
BCDATE/YYMD=&&FROMDT.EVAL;
BCDATE1/MT=BCDATE;
BC_MONTH/MDYY=BCDATE;
BC_YR1/MDYY=DATEMOV(BC_MONTH, 'BOY');
BC_YR/YYMD=BC_YR1;
BCD_NUM/P2 = IF BCDATE1 EQ 'JAN' THEN 1 ELSE
             IF BCDATE1 EQ 'FEB' THEN 2 ELSE
             IF BCDATE1 EQ 'MAR' THEN 3 ELSE
             IF BCDATE1 EQ 'APR' THEN 4 ELSE
             IF BCDATE1 EQ 'MAY' THEN 5 ELSE 
             IF BCDATE1 EQ 'JUN' THEN 6 ELSE
             IF BCDATE1 EQ 'JUL' THEN 7 ELSE
             IF BCDATE1 EQ 'AUG' THEN 8 ELSE
             IF BCDATE1 EQ 'SEP' THEN 9 ELSE
             IF BCDATE1 EQ 'OCT' THEN 10 ELSE
             IF BCDATE1 EQ 'NOV' THEN 11 ELSE 
             IF BCDATE1 EQ 'DEC' THEN 12 ELSE 0;

BPDATE/YYMD=&&FXDATE.EVAL;
BPDATE1/MT=BPDATE;
BP_MONTH/MDYY=BPDATE;
BP_YR1/MDYY=DATEMOV(BP_MONTH, 'BOY');
BP_YR1A/MDYY=DATEMOV(BP_MONTH, 'EOY');

BP_YR/YYMD=BP_YR1;
BP_YRA/YYMD=BP_YR1A;

BPD_NUM/P2 = IF BPDATE1 EQ 'JAN' THEN 1 ELSE
             IF BPDATE1 EQ 'FEB' THEN 2 ELSE
             IF BPDATE1 EQ 'MAR' THEN 3 ELSE
             IF BPDATE1 EQ 'APR' THEN 4 ELSE
             IF BPDATE1 EQ 'MAY' THEN 5 ELSE 
             IF BPDATE1 EQ 'JUN' THEN 6 ELSE
             IF BPDATE1 EQ 'JUL' THEN 7 ELSE
             IF BPDATE1 EQ 'AUG' THEN 8 ELSE
             IF BPDATE1 EQ 'SEP' THEN 9 ELSE
             IF BPDATE1 EQ 'OCT' THEN 10 ELSE
             IF BPDATE1 EQ 'NOV' THEN 11 ELSE 
             IF BPDATE1 EQ 'DEC' THEN 12 ELSE 0;


ROLLCD/A8 = '&&ROLL';
NBR_DAYS/P12C = IF (NUM_DAYS LT 0) AND
                  (NUM_CAR LT 0) THEN
                  (NUM_DAYS * NUM_CAR) * (-1) ELSE
                  (NUM_DAYS * NUM_CAR);

                  
                  
CURRENT/A1 = IF INVOICE_DATE GE &&FROMDT.EVAL AND
                INVOICE_DATE LE &&TODT.EVAL THEN 'Y' ELSE 'N';
                
CYTD/A1 = IF INVOICE_DATE GE BC_YR AND INVOICE_DATE LE &&TODT.EVAL THEN 'Y' ELSE 'N';               
                
                
PRIOR/A1 = IF INVOICE_DATE GE &&FXDATE.EVAL AND
              INVOICE_DATE LE &&TXDATE.EVAL THEN 'Y' ELSE 'N';
              
PYTD/A1 = IF INVOICE_DATE GE BP_YR AND INVOICE_DATE LE &&TXDATE.EVAL THEN 'Y' ELSE 'N';    

PYR/A1 = IF INVOICE_DATE GE BP_YR AND INVOICE_DATE LE BP_YRA THEN 'Y' ELSE 'N';
              
CCVOL/D12.2CSM=IF CURRENT EQ 'Y' THEN RENTAL_AMT ELSE 0;
CCDAY/P12CS = IF CURRENT EQ 'Y' THEN NBR_DAYS ELSE 0;
CYCVOL1/D12.2CSM = IF CYTD EQ 'Y' THEN RENTAL_AMT ELSE 0;
CYCVOL/D12.2CSM = (CYCVOL1/BCD_NUM)*12;


PCVOL/D12.2CSM=IF PRIOR EQ 'Y' THEN RENTAL_AMT ELSE 0;
PCDAY/P12CS = IF PRIOR EQ 'Y' THEN NBR_DAYS ELSE 0;
PYCVOL1/D12.2CSM= IF PYTD EQ 'Y' THEN RENTAL_AMT ELSE 0;
PYCVOL/D12.2CSM = (PYCVOL1/BCD_NUM)*12;

-* NEW PRIOR YEAR FIELDS
PYRCVOL/D12.2CSM = IF PYR EQ 'Y' THEN RENTAL_AMT ELSE 0;
PYRCDAY/P12CS = IF PYR EQ 'Y' THEN NBR_DAYS ELSE 0;


RNR_FLAG/A15 = IF ORIG_SYS EQ 'RA' OR 'R3' THEN 'Radius' ELSE 'Non-radius';

-* DEFINES ON PREVIOUS

LEVEL_DESC/A40 = IF ROLLCD EQ 'CERN-R' THEN AROLL_LEV3 ELSE AROLL_LEV2;

END
TABLE FILE CR_50
PRINT CCVOL
   CCDAY
   CYCVOL1
   CYCVOL
   PCVOL
   PCDAY
   PYCVOL1
   PYCVOL
   RNR_FLAG
   ROLLCD
-*NEW PRIOR YEAR FIELDS
   PYRCVOL
   PYRCDAY   
BY LEVEL_DESC
-* WHERE (INVOICE_DATE GE &&FROMDT.EVAL) AND (INVOICE_DATE LE &&TODT.EVAL) OR
-*       (INVOICE_DATE GE &&FXDATE.EVAL) AND (INVOICE_DATE LE &&TXDATE.EVAL) 
WHERE CATEGORY EQ 'GLOBAL'
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS TCCARH 
END


DEFINE FILE TCCARH
COMP_NAME/A40 = LCWORD(40, LEVEL_DESC, COMP_NAME);
END
TABLE FILE TCCARH
SUM CCVOL
    CCDAY
    CYCVOL
    PCVOL
    PCDAY
    PYCVOL
-*NEW PRIOR YEAR FIELDS
   PYRCVOL
   PYRCDAY    
BY ROLLCD
BY RNR_FLAG
BY COMP_NAME
ON TABLE HOLD AS TCCARH1
END
-RUN

-IF &LINES EQ 0 THEN GOTO NEXTONE;


-*========================================================================
-*   PROCESS EXTRACTED DATA FROM ABOVE
-*========================================================================


MODIFY FILE TCCGLOBAL
FIXFORM FROM TCCARH1
DATA ON TCCARH1
END
-RUN


-NEXTONE

