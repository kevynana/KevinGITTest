SET ASNAMES=ON

-SET &&PRGDATE = '''2009/07/01''';
-SET &&DATEPRG = '''07/01/2009''';
-SET &&DATPATH = 'D:\STEVE\PURGE\NEW\';

-* -GOTO XFER

COPY D:\TNT\TTRACKER\SUDATA\ROLLUP.* D:\STEVE\PURGE\NEW\
COPY D:\TNT\TTRACKER\SYSTEM\DATA\INDUSTRY.* D:\STEVE\PURGE\NEW\
END

USE
D:\STEVE\PURGE\NEW\ROLLUP.FOC AS ROLLUP
END

TABLE FILE ROLLUP
PRINT ROLLUP PR_STAMP
BY ROLLUP NOPRINT
ON TABLE HOLD
END

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP=' ';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END

TABLE FILE ROLLUP
PRINT ROLLUP
      PR_STAMP
      COMP
BY ROLLUP NOPRINT
WHERE UPD_ENABLE EQ 'X'
WHERE QTR_ENABLE EQ ' '
WHERE ROLLUP NE 'TOTAL-R'
WHERE ROLLUP NE 'USG-R'
WHERE ROLLUP NE 'ABCD2-R'
WHERE ROLLUP NE 'ABCD3-R'
WHERE START_DATE LT &&DATEPRG.EVAL
ON TABLE HOLD
END
-RUN

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP='W';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END

-PRGLOOP
USE
D:\STEVE\PURGE\NEW\ROLLUP.FOC AS ROLLUP
END

TABLE FILE ROLLUP
PRINT ROLLUP COMP
BY ROLLUP NOPRINT
WHERE RECORDLIMIT EQ 1
WHERE PR_STAMP EQ 'W'
ON TABLE SAVE AS CUSTS
END
-IF &RECORDS EQ 0 GOTO XFER;
-RUN
-READ CUSTS &&ROLLUP.A8 &&COMP.A6.
-RUN

-SET &&COPYF = 'D:\TNT\TTRACKER\DATA\'||'*_'||&&COMP|||'.FOC';
-SET &&COPYM = 'D:\TNT\TTRACKER\DATA\'||'*_'||&&COMP|||'.MAS';
-SET &&COPYOLD = 'D:\STEVE\PURGE\OLD\';
-SET &&COPYNEW = 'D:\STEVE\PURGE\NEW\';

COPY &&COPYF &&COPYOLD
COPY &&COPYM &&COPYOLD
COPY &&COPYF &&COPYNEW
COPY &&COPYM &&COPYNEW

TABLE FILE ROLLUP
PRINT ROLLUP
      PR_STAMP
BY ROLLUP NOPRINT
WHERE ROLLUP EQ '&&ROLLUP'
ON TABLE HOLD
END
MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP='Z';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN


-SET &&PRGSEG = 'S_' || &&COMP;
-SET &&PRGMKT = 'M_' || &&COMP;
-SET &&PRGDST = 'D_' || &&COMP;
-SET &&PRGAIR = 'A_' || &&COMP;
-SET &&PRGCAR = 'C_' || &&COMP;
-SET &&PRGHTL = 'H_' || &&COMP;
-SET &&PRGTKT = 'T_' || &&COMP;

-TYPE PRGSEG &&PRGSEG
-TYPE PRGMKT &&PRGMKT
-TYPE PRGDST &&PRGDST
-TYPE PRGAIR &&PRGAIR
-TYPE PRGCAR &&PRGCAR
-TYPE PRGHTL &&PRGHTL
-TYPE PRGTKT &&PRGTKT

-SET &&DBUSE = &&DATPATH || &&PRGSEG || '.FOC';
USE
&&DBUSE
END
-RUN

TABLE FILE &&PRGSEG
PRINT TRN_DATE
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
WHERE TRN_DATE LT &&PRGDATE.EVAL;
ON TABLE HOLD AS SEGTRIG1
END
-RUN

TABLE FILE &&PRGSEG
PRINT TRN_DATE
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
WHERE TRN_DATE GE &&PRGDATE.EVAL;
ON TABLE HOLD AS SEGTRIG2
END
-RUN

MODIFY FILE &&PRGSEG
FIXFORM FROM SEGTRIG1
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH DELETE
DATA ON SEGTRIG1
END
-RUN

-SET &&DBUSE = &&DATPATH || &&PRGMKT || '.FOC';
USE
&&DBUSE
END
-RUN

TABLE FILE &&PRGMKT
PRINT TRN_DATE
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
WHERE TRN_DATE LT &&PRGDATE.EVAL;
ON TABLE HOLD AS MKTTRIG
END
-RUN

MODIFY FILE &&PRGMKT
FIXFORM FROM MKTTRIG
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH DELETE
DATA ON MKTTRIG
END
-RUN

-SET &&DBUSE = &&DATPATH || &&PRGDST || '.FOC';
USE
&&DBUSE
END
-RUN

TABLE FILE &&PRGDST
PRINT TRN_DATE
BY AIR_KEY
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
WHERE TRN_DATE LT &&PRGDATE.EVAL;
ON TABLE HOLD AS DSTTRIG
END
-RUN

MODIFY FILE &&PRGDST
FIXFORM FROM DSTTRIG
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH DELETE
DATA ON DSTTRIG
END
-RUN

-TYPE SEG MATCH

-MATCH

MATCH FILE SEGTRIG1
PRINT AIR_KEY TRN_DATE
BY AIR_KEY NOPRINT
RUN
FILE SEGTRIG2
PRINT AIR_KEY
BY AIR_KEY NOPRINT
AFTER MATCH HOLD AS SEGTRIG OLD-NOT-NEW
END
-RUN

TABLE FILE SEGTRIG
SUM TRN_DATE
BY AIR_KEY
ON TABLE HOLD AS AIRTRIG
END
-RUN

TABLE FILE AIRTRIG
PRINT AIR_KEY
BY AIR_KEY NOPRINT
ON TABLE HOLD AS AIRTRIGX
END
-RUN

-SET &&DBUSE = &&DATPATH || &&PRGAIR || '.FOC';
USE
&&DBUSE
END
-RUN

MODIFY FILE &&PRGAIR
FIXFORM FROM AIRTRIGX
MATCH AIR_KEY
ON MATCH DELETE
DATA ON AIRTRIGX
END
-RUN

-SET &&DBUSE = &&DATPATH || &&PRGTKT || '.FOC';
USE
&&DBUSE
END
-RUN

MODIFY FILE &&PRGTKT
FIXFORM FROM AIRTRIGX
MATCH AIR_KEY
ON MATCH DELETE
DATA ON AIRTRIGX
END
-RUN

-SET &&DBUSE = &&DATPATH || &&PRGCAR || '.FOC';
USE
&&DBUSE
END
-RUN

TABLE FILE &&PRGCAR
PRINT PNR_LOCATOR
BY CAR_KEY
WHERE INVOICE_DATE LT &&PRGDATE.EVAL;
ON TABLE HOLD AS CARTRIG1
END
-RUN

TABLE FILE &&PRGCAR
PRINT PNR_LOCATOR
BY CAR_KEY
WHERE INVOICE_DATE GE &&PRGDATE.EVAL;
ON TABLE HOLD AS CARTRIG2
END
-RUN

-TYPE CAR MATCH

-MATCH

MATCH FILE CARTRIG1
PRINT CAR_KEY PNR_LOCATOR
BY CAR_KEY NOPRINT
RUN
FILE CARTRIG2
PRINT CAR_KEY
BY CAR_KEY NOPRINT
AFTER MATCH HOLD AS CARTRIG OLD-NOT-NEW
END
-RUN

TABLE FILE CARTRIG
PRINT CAR_KEY
BY CAR_KEY NOPRINT
ON TABLE HOLD AS CARTRIGX
END
-RUN

MODIFY FILE &&PRGCAR
FIXFORM FROM CARTRIGX
MATCH CAR_KEY
ON MATCH DELETE
DATA ON CARTRIGX
END
-RUN

-SET &&DBUSE = &&DATPATH || &&PRGHTL || '.FOC';
USE
&&DBUSE
END
-RUN

TABLE FILE &&PRGHTL
PRINT PROP_KEY
BY HTL_KEY
WHERE INVOICE_DATE LT &&PRGDATE.EVAL;
ON TABLE HOLD AS HTLTRIG1
END
-RUN

TABLE FILE &&PRGHTL
PRINT PROP_KEY
BY HTL_KEY
WHERE INVOICE_DATE GE &&PRGDATE.EVAL;
ON TABLE HOLD AS HTLTRIG2
END
-RUN

-TYPE HOTEL MATCH

-MATCH

MATCH FILE HTLTRIG1
PRINT HTL_KEY PROP_KEY
BY HTL_KEY NOPRINT
RUN
FILE HTLTRIG2
PRINT HTL_KEY
BY HTL_KEY NOPRINT
AFTER MATCH HOLD AS HTLTRIG OLD-NOT-NEW
END
-RUN

TABLE FILE HTLTRIG
PRINT HTL_KEY
BY HTL_KEY NOPRINT
ON TABLE HOLD AS HTLTRIGX
END
-RUN

MODIFY FILE &&PRGHTL
FIXFORM FROM HTLTRIGX
MATCH HTL_KEY
ON MATCH DELETE
DATA ON HTLTRIGX
END
-RUN

EX PRGERBLD
-RUN

-GOTO PRGLOOP

-XFER

USE
D:\STEVE\PURGE\NEW\ROLLUP.FOC AS ROLLUP
END

DEFINE FILE ROLLUP
NEW_DATE/MDYY = &&DATEPRG.EVAL
END

TABLE FILE ROLLUP
PRINT ROLLUP NEW_DATE AS 'START_DATE'
WHERE PR_STAMP EQ 'Z'
ON TABLE HOLD
END

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP=' ';
ON MATCH UPDATE PR_STAMP
ON MATCH UPDATE START_DATE
ON NOMATCH REJECT
DATA ON HOLD
END

-TYPE EXITING

-STOP
-EXIT











