-*2/10/16 JEM S-15448 commented out set temperase=off 
-*09/08/2017 DLV  S-37268  -Updated DIR_APT_CDD define


-INCLUDE SETECHO
SET ASNAMES = ON 
-SET HOLDATTR = ON;
-*  SET TEMPERASE = OFF
-RUN 

-SET &RPARM = &&WEB_PATH || 'RPTPARMS.fex';

-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';
 


DEFINE FILE &&EXTRACT
  EGEO/A3 = EDIT(TKT_MAIN.GEO_ZONE, '999');
  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;
  LEVEL_DESC/A60      = AROLL_LEV1;
  MRK_TKT_CNT/D8C    = IF (TICKET_CODE EQ '1') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (EX_FLAG NE ' ') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (RF_FLAG NE ' ') THEN (-1) ELSE 0; 
  NET_TKT_CNT/D8C    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;

  NEW_SEG_MILES/D9 = SEG_MILES; 
  NEW_STAY/P9 = STAY;
  NEW_TRIP_LENGTH/D12 = TRIP_LENGTH;
              
 

  REF_EXCH_CNT/D8CS   = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 0 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN 1 ELSE 0;
 RT_FLAG/A3           = IF RNDT_FLAG EQ 'Y' THEN 'RT' ELSE 'OW';                              
 TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  XDPT_DT/MDYY         = DPT_DATE;  
  TKT_AMOUNT/D12.2CS  = TICKET_AMT + TAX_AMT;
  XPSNGR_NM/A15        = 
  EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;
    XFST_DPT/MDYY = FST_DPT_DATE;

  FNL_DT/A8YYMD = FNL_DEST_DEPART_DATE;
 LAST_DATE/A8YYMD = GETTOK(DEPART_DATES, 144, -1, '-', 10, LAST_DATE); 
  LST_DPT_DT/MDYY = LAST_DATE;
-* ****DEFINES ON PREVIOUS DEFINES****
  
  TRIPS/D8CS = IF STAY GT 0 THEN 1 ELSE
               IF STAY LT 0 THEN (-1) ELSE 0;
 DIR_CP_CD/A50        = CITYPAIR.EMBARK||'-'||CITYPAIR.ROUTE;
 -*DIR_APT_CDD/A25 = CITYPAIR.ROUTE;
 DIR_APT_CDD/A3 = EDIT(RTE_APT.ROUTEX, '$$$999');
 ORGDST/A7 = ORG_APC||'-'||DST_APC;
 REF_EXC/A8 = IF TKT_TYPE EQ 'F-RF' THEN 'REFUND' ELSE 
              IF TKT_TYPE EQ 'F-EX' THEN 'EXCHANGE' ELSE ' ';
KILO/D9      = CITYPAIR.SEG_MILES * 1.60934 ;  

 TON_C02/P12.2 = 
   IF ((CITYPAIR.SEG_MILES GE 1) AND (CITYPAIR.MILES LE 300) OR 
            (CITYPAIR.SEG_MILES LE (-1)) AND (CITYPAIR.MILES GE (-300))) THEN
             (CITYPAIR.SEG_MILES * .00029) ELSE 
   IF ((CITYPAIR.SEG_MILES GE 301) AND (CITYPAIR.SEG_MILES LE 1000) OR 
            (CITYPAIR.SEG_MILES LE (-301)) AND (CITYPAIR.SEG_MILES GE (-1001))) THEN 
            (CITYPAIR.SEG_MILES * .00020) ELSE  
   IF ((CITYPAIR.SEG_MILES GE 1001) AND (CITYPAIR.SEG_MILES LE 99999) OR 
            (CITYPAIR.SEG_MILES LE (-1001)) AND (CITYPAIR.SEG_MILES GE (-99999))) THEN 
           (CITYPAIR.SEG_MILES * .00018) ELSE 0;   
                
END
TABLEF FILE &&EXTRACT
PRINT
  AIR_KEY
  AIRLINE
  C_ITIN
  ORG_APC
  DST_APC
  EGEO AS 'OGEO_ZONE'
  EMB_CTY.CITY_NAME    AS 'EMB_CTY_NM'	
  EMBARK
  FARE_PAID
   KILO
  LEVEL_DESC    
  LEVEL1    
  LEVEL2    
  LEVEL3    
  MRK_TKT_CNT
  NEW_SEG_MILES
  NET_TKT_CNT
  NEW_SEG_MILES
  
  ORGDST
  PASSNGR_NAME 
  PNR_LOCATOR
    RTE_CTY.CITY_NAME    AS 'RTE_CTY_NM'	

  SEG_NBR
  TKT_DATE
  TKT_NUM
  TKT_SORT
  TKT_TYPE  
  TKT_AMOUNT
  TON_C02
  TRIPS
  TRIP_LENGTH
  TRN_DATE 
  VAL_AIRLINE
  VAL_AIR.AIRLINE_NAME  
  XDPT_DT 
  XFST_DPT
  XPSNGR_NM
  XTRAN_DT  
  CTRY_COD
  FST_DPT_DATE
  ORG_CNTRY_CODE AS 'OCNTRY_CD'
  DEPART_DATES
  LST_DPT_DT
-INCLUDE &AIRDATES 
WHERE VOID_DATE EQ 0 
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE &RPARM
ON TABLE HOLD AS THOLD1
END
-RUN
  
-SET &&FindData = IF &LINES EQ 0 THEN 'N' ELSE 'Y';
