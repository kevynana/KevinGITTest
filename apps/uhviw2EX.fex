-* Created for the UDID reports
-* 1/30/13 - DEB changed due to expansion of hotel database to
-* include trip purpose
-*12/15/15 - DLV - S-13284   Updated to allow reports to sort/subtotal by id-levels
-*4/26/16-JEM-S-18247 Updated to fix trip purpose error on ABUHTRP


-INCLUDE SETECHO
SET ASNAMES = ON 
-SET HOLDATTR = ON;
-RUN

-SET &&IDLEVELBREAK = '';
-RUN

-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';

-INCLUDE IDLEVROLLDEF
-RUN

DEFINE FILE &&EXTRACT
  CITY_ST/A35 = PROP_CITY||(', '| PROP_STATE);
  LEVEL_DESC1/A60  = &&LDESC;
  IN_DATE/MDYY = CHKIN_DATE;
  INV_DATE/MDYY = INVOICE_DATE;
  NBR_DAYS/D12 =  NUM_DAYS;
  NBR_ROOMS/D12 = NUM_ROOMS;
  NEW_ROOM_RATE/D14.2C = ROOM_RATE;
  NEW_STD_RATE/D14.2C = STD_RATE;
  NEW_TOTAL_AMT/D14.2C = TOTAL_AMT;
  NNROOMS/D12 = IF ((NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)) THEN 
                ((NBR_DAYS*NUM_ROOMS) * (-1)) ELSE NBR_DAYS*NUM_ROOMS;
  OUT_DATE/MDYY = CHKOUT_DATE;
  REASON_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
  RSNCDE/A48=REASON_CD|| '-' ||REFUSAL_DESC;
  XPSNGR_NM/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  PROP_ZIP5/A5=EDIT(PROP_ZIP, '99999$$$$$');
  
-* ****DEFINES ON PREVIOUS DEFINES****
   BOOKINGS/D8 = IF NEW_TOTAL_AMT GT 0 THEN 1 ELSE (-1);
  
   TOTAL_STD/D12.2C = IF ((NNROOMS LT 0) AND (NEW_STD_RATE LT 0))
                      THEN ((NNROOMS * NEW_STD_RATE) * (-1))
                      ELSE NNROOMS * NEW_STD_RATE;

-* ****DEFINES ON PREVIOUS DEFINED DEFINES***
   TOTAL_SLSAV/D12.2C = TOTAL_STD - NEW_TOTAL_AMT;
  TRIP_KEY/A2   = EDIT(TRP_KEY, '$$$$$$$$99');
  TRIPRSN/A10 = IF TRIP_KEY NE ' ' THEN TRIP_KEY ELSE 'ZZZZZZZZZZ';
  TRIP_RSN/A10 = IF TRIPRSN EQ 'ZZZZZZZZZZ' THEN 'NONE GIVEN' ELSE TRIPRSN; 
-INCLUDE IDLEVDEFINE 

  END
-RUN


TABLEF FILE &&EXTRACT
PRINT BOOKINGS	
  CHAIN_NAME
  CITY_ST
  HOTEL_PHONE 	
  HTL_KEY
  IN_DATE 	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS	
  OUT_DATE 	
  PNR_LOCATOR 	
  PROP_ADDRESS
  PROP_CITY
  PROP_NAME 	
  PROP_ZIP5
  PROP_STATE_CD
  RESV_STATUS
  REFUSAL_DESC	
  REFUSE_CODE
  RSNCDE
  TOTAL_SLSAV
  TOTAL_STD
  TRIP_PURPOSE
  TRIP_RSN
  XPSNGR_NM
  
-INCLUDE &HTLDATES
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS

-* ON TABLE HOLD AS HTLHLD
ON TABLE HOLD AS &&RPT_HOLD
END
-RUN


TABLE FILE &&RPT_HOLD
PRINT BOOKINGS
      CHAIN_NAME
      CITY_ST
      HOTEL_PHONE
      HTL_KEY
      IN_DATE
      INVOICE_DATE
      INVOICE_NUM
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL5
      LEVEL6
      LEVEL7
      NBR_DAYS
      NBR_ROOMS
      NEW_ROOM_RATE
      NEW_STD_RATE
      NEW_TOTAL_AMT
      NNROOMS
      OUT_DATE
      PNR_LOCATOR      
      PROP_ADDRESS
      PROP_CITY
      PROP_NAME
      PROP_STATE_CD
      PROP_ZIP5
      RESV_STATUS
      REFUSAL_DESC
      REFUSE_CODE
      RSNCDE
      TOTAL_SLSAV 
      TOTAL_STD
      TRIP_PURPOSE
      TRIP_RSN 
      XPSNGR_NM
BY LEVEL_DESC
ON TABLE HOLD AS HTLHLD
END
-RUN

TABLE FILE &&RPT_HOLD
SUM 
  NBR_DAYS AS 'TDAY'
  NEW_TOTAL_AMT AS 'TAMT'
BY LEVEL_DESC 
ON TABLE HOLD AS HHOLD1
END
-RUN

MATCH FILE HTLHLD
PRINT BOOKINGS
      CHAIN_NAME
      CITY_ST
      HOTEL_PHONE
      HTL_KEY
      IN_DATE
      INVOICE_DATE
      INVOICE_NUM	
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL5
      LEVEL6
      LEVEL7
      NBR_DAYS
      NBR_ROOMS
      NEW_ROOM_RATE
      NEW_STD_RATE
      NEW_TOTAL_AMT
      NNROOMS
      OUT_DATE
      PNR_LOCATOR      
      PROP_ADDRESS
      PROP_CITY
      PROP_NAME
      PROP_STATE_CD
      PROP_ZIP5
      RESV_STATUS
      REFUSAL_DESC
      REFUSE_CODE
      RSNCDE
      TOTAL_SLSAV 
      TOTAL_STD
      TRIP_PURPOSE
      TRIP_RSN 
      XPSNGR_NM
BY LEVEL_DESC
ON TABLE HOLD
RUN
FILE HHOLD1
SUM TDAY
    TAMT
BY LEVEL_DESC
AFTER MATCH HOLD AS XONE OLD-OR-NEW
END
-RUN

TABLE FILE XONE
PRINT BOOKINGS
      CHAIN_NAME
      CITY_ST
      HOTEL_PHONE
      IN_DATE
      INVOICE_DATE
      INVOICE_NUM
      LEVEL_DESC
      NBR_DAYS
      NBR_ROOMS
      NEW_ROOM_RATE
      NEW_STD_RATE
      NEW_TOTAL_AMT
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL5
      LEVEL6
      LEVEL7
      NNROOMS
      OUT_DATE
      PNR_LOCATOR      
      PROP_ADDRESS
      PROP_CITY
      PROP_NAME
      PROP_STATE_CD
      PROP_ZIP5
      RESV_STATUS
      REFUSAL_DESC
      REFUSE_CODE
      RSNCDE
      TOTAL_SLSAV 
      TOTAL_STD
      TRIP_PURPOSE
      TRIP_RSN 
      XPSNGR_NM
      TDAY
      TAMT
BY HTL_KEY
ON TABLE HOLD AS HTLHLD2
END
-RUN

-* -INCLUDE RETUDID