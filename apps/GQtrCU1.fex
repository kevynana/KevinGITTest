-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* Increased the Rank Limit to 10 per Patti Cavlovic - JK 5/11/04

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

DEFINE FILE MR_50  
  FARE_PAID/D12.2 = SEG_AMT + SEG_TAX;
  NET_TKT_CNT/D8.2CS    = IF (TICKET_CODE EQ '1') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (EX_FLAG NE ' ') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (RF_FLAG NE ' ') THEN (-1) ELSE 0;  
END
-RUN

TABLEF FILE MR_50
PRINT FARE_PAID
  NET_TKT_CNT
  TRN_DATE
  AIRLINE_NAME AS 'AIRLINE'
  TKT_DATE
  VOID_DATE 	
WHERE (TRN_DATE GE &&FROMDT.EVAL) AND (TRN_DATE LE &&TODT.EVAL) OR
      (TRN_DATE GE &&FXDATE.EVAL) AND (TRN_DATE LE &&TXDATE.EVAL)
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3

-INCLUDE RPTPARMS
ON TABLE HOLD AS QTRCU
END
-RUN

TABLE FILE QTRCU
PRINT FARE_PAID
  NET_TKT_CNT
  TRN_DATE
  AIRLINE
  VOID_DATE 	
BY TKT_DATE
ON TABLE HOLD AS QTRCU1 FORMAT FOCUS INDEX TKT_DATE
END
-RUN



-* Global Reporting JOIN
JOIN QTRCU1.TKT_DATE IN QTRCU1 TO GLOBAL.DATE IN GLOBAL AS J1


DEFINE FILE QTRCU1
CNAME1/A30 = LCWORD(30, CNAME, CNAME1);
NAMEC/A30 = IF GLOBAL.COUNTRYCODE EQ 'USD' THEN ' ' ELSE CNAME1;

-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
PAID_FAREX/D20.6 = FARE_PAID * CURR1X;


END
-RUN 

TABLE FILE QTRCU1
PRINT FARE_PAID
  NET_TKT_CNT
  TRN_DATE
  AIRLINE
  VOID_DATE 	
  TKT_DATE
  NAMEC
  PAID_FAREX
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS CUHLD1
END
-RUN




DEFINE FILE CUHLD1
CURRENT/A1 = IF TRN_DATE GE &&FROMDT.EVAL AND
                TRN_DATE LE &&TODT.EVAL THEN 'Y' ELSE 'N';
PRIOR/A1 =  IF TRN_DATE GE &&FXDATE.EVAL AND
               TRN_DATE LE &&TXDATE.EVAL THEN 'Y' ELSE 'N';
FLAG/A1 = 'A';
END

TABLE FILE CUHLD1
PRINT CURRENT
  NET_TKT_CNT
  PRIOR	
  VOID_DATE
  NAMEC
BY FLAG
BY AIRLINE
ON TABLE HOLD AS CUHLD2
END
-RUN

DEFINE FILE CUHLD2
CMARK/D15 = IF (CURRENT EQ 'Y') AND (VOID_DATE EQ 0) THEN NET_TKT_CNT ELSE 0;
PMARK/D15 = IF (PRIOR EQ 'Y') AND (VOID_DATE EQ 0) THEN NET_TKT_CNT ELSE 0;
END

TABLE FILE CUHLD2
SUM CMARK
    PMARK
    NAMEC
BY FLAG
BY AIRLINE
ON TABLE HOLD AS CUHLD3
END
-RUN

TABLE FILE CUHLD3
SUM CMARK AS 'TCMARK'
    PMARK AS 'TPMARK'
BY FLAG
ON TABLE HOLD AS MUHLD
END
-RUN


MATCH FILE CUHLD3
PRINT CMARK
      PMARK
      AIRLINE
      NAMEC
BY FLAG
ON TABLE HOLD
RUN
FILE MUHLD
SUM TCMARK
    TPMARK
BY FLAG
AFTER MATCH HOLD AS TCUHLD OLD-OR-NEW
END
-RUN

TABLE FILE TCUHLD
PRINT CMARK
      PMARK
      TCMARK
      TPMARK
      FLAG
      AIRLINE
      NAMEC
RANKED BY HIGHEST CMARK NOPRINT
ON TABLE HOLD AS CUHLD3
END
-RUN

DEFINE FILE CUHLD3
LIST/D9 = IF AIRLINE NE LAST AIRLINE THEN 
           (LAST LIST + 1) ELSE LAST LIST;
  DRANK/D9 = RANK;
  ARANK/A11 = FTOA(DRANK, '(D9)', ARANK);
  ARANK1/A9 = EDIT(ARANK, '$$999999999');
  RANK_VALUE/A9 = IF LIST GT 10 THEN 'OTHER' ELSE ARANK1;
  RANK_LABEL/A30 = IF RANK_VALUE NE 'OTHER' THEN AIRLINE
                      ELSE 'ALL OTHER';
-* DEFINES ON PREVIOS DEFINES
 RANK_LAB/A30 = LCWORD(30, RANK_LABEL, RANK_LAB);
END
-RUN
TABLE FILE CUHLD3
SUM NAMEC   
COMPUTE CMPCT/D15 = IF ((TCMARK LT 1) AND (TCMARK GT (-1))) THEN 0 ELSE
                       ((CMARK/TCMARK)*100);
COMPUTE PMPCT/D15 = IF ((TPMARK LT 1) AND (TPMARK GT (-1))) THEN 0 ELSE
                       ((PMARK/TPMARK)*100);
COMPUTE IDMPCT/D15 = IF ((PMPCT LT 1) AND (PMPCT GT (-1))) THEN 0 ELSE
                        (CMPCT-PMPCT);
BY RANK_VALUE
BY RANK_LAB
ON TABLE HOLD AS CUHLD4
END
-RUN


DEFINE FILE CUHLD4
LABEL/A35 = 'Carrier Usage Percentage';
CATEGORY/A81 = IF NAMEC EQ ' ' THEN LABEL ELSE LABEL||'-'||NAMEC;
CAT_ORDER/I2 = 14;
END
-RUN

TABLE FILE CUHLD4
PRINT CATEGORY/A50 AND RANK_LAB/A50 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CMPCT/D15 AS 'CURRENT' AND
PMPCT/D15 AS 'PRIOR' IDMPCT AS 'IDPERCENT' 
COMPUTE ROW_ORDER/I2 = 1;  
WHERE RANK_LAB NE 'All Other';
ON TABLE HOLD AS CUHLD5
END
-RUN

TABLE FILE CUHLD5
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND CURRENT AND PRIOR AND IDPERCENT
ON TABLE HOLD AS CUHLD6
END
MODIFY FILE GQTRREV1
FIXFORM FROM CUHLD6
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON CUHLD6
END
-RUN

-* Carrier Usage % Graph Creation
DEFINE FILE CUHLD3
LIST/D9 = IF AIRLINE NE LAST AIRLINE THEN 
           (LAST LIST + 1) ELSE LAST LIST;
  DRANK/D9 = RANK;
  ARANK/A11 = FTOA(DRANK, '(D9)', ARANK);
  ARANK1/A9 = EDIT(ARANK, '$$999999999');
  RANK_VALUE/A9 = IF LIST GT 5 THEN 'OTHER' ELSE ARANK1;
  RANK_LABEL/A30 = IF RANK_VALUE NE 'OTHER' THEN AIRLINE
                      ELSE 'ALL OTHER';
-* DEFINES ON PREVIOS DEFINES
 RANK_LAB/A30 = LCWORD(30, RANK_LABEL, RANK_LAB);
END
-RUN

TABLE FILE CUHLD3
SUM     
COMPUTE CMPCT/D15 = IF ((TCMARK LT 1) AND (TCMARK GT (-1))) THEN 0 ELSE
                       ((CMARK/TCMARK)*100);
COMPUTE PMPCT/D15 = IF ((TPMARK LT 1) AND (TPMARK GT (-1))) THEN 0 ELSE
                       ((PMARK/TPMARK)*100);
COMPUTE IDMPCT/D15 = IF ((PMPCT LT 1) AND (PMPCT GT (-1))) THEN 0 ELSE
                        (CMPCT-PMPCT);
BY RANK_VALUE
BY RANK_LAB
ON TABLE HOLD AS CUHLD3G
END
-RUN


GRAPH FILE CUHLD3G
SUM
COMPUTE CMPCT/D12.2 = IF ((TCMARK LT 1) AND (TCMARK GT (-1))) THEN 0 ELSE
                         (CMARK/TCMARK); AS 'Period1'
COMPUTE PMPCT/D12.2 = IF ((TPMARK LT 1) AND (TPMARK GT (-1))) THEN 0 ELSE
                         (PMARK/TPMARK); AS 'Period2'
ACROSS RANK_LAB AS ''
WHERE RANK_LAB NE 'All Other'
ON TABLE SET 3D OFF
ON TABLE SAVE AS CRUSG FORMAT GIF
ON TABLE SET GRAPHSTYLE *
setAutofit(getDataText(),true); 
setDataTextDisplay(true);
setDataTextFormat(3); 
setGraphType(16);
setLegendDisplay(true);
setLegendTextAutofit(true);
setLegendMarkerPosition(2);
setO1LabelDisplay(true);
setFontSizeAbsolute(getO1Label(),true); 
setAutofit(getO1Label(),false);
setFontStyle(getO1Label(),8);
setFontSize(getO1Label(),16);
setO1LabelRotate(0);
setO1MajorGridDisplay(false);
setO1MinorGridDisplay(false);
-* setY1LabelDisplay(true);
-* setY1LabelFormat(3);
-* setAutofit(getY1Label(),true);
-* setFontStyle(getY1Label(),8);
setY1LabelDisplay(true);
setY1LabelFormat(3);
setFontSizeAbsolute(getY1Label(),true);
setFontSize(getY1Label(),16);
setFontStyle(getY1Label(),10);
setY1AxisSide(0);
setY1MajorGridDisplay(false);
setY1MajorGridStyle(0);
setY1MinorGridDisplay(false);
setFontSizeAbsolute(getTitle(),true);
setAutofit(getTitle(),false);
setTitleString("Carrier Usage Percentage");
setTextJustHoriz(getTitle(),1);
setFontStyle(getTitle(),11);
setFontSize(getTitle(),20);
setFontSizeAbsolute(getSubtitle(),true); 
setSubtitleAutofit(false);
setSubtitleString("Per Airline");
setTextJustHoriz(getSubtitle(),1);
setFontStyle(getSubtitle(),11);
setFontSize(getSubtitle(),20);
setSeriesFillColor(0, new Color, 0 64 128));
setSeriesFillColor(1, new Color, 255 255 0));
setSeriesFillColor(2, new Color, 115 160 247));
ENDSTYLE 
END
-RUN


-SET &&G_GIF10=IF &LINES GT 0 THEN 'Y' ELSE 'N'


-* Carrier Usage by Airline Spend Graph Creation
DEFINE FILE CUHLD1
CURRENT/A1 = IF TRN_DATE GE &&FROMDT.EVAL AND
                TRN_DATE LE &&TODT.EVAL THEN 'Y' ELSE 'N';
PRIOR/A1 =  IF TRN_DATE GE &&FXDATE.EVAL AND
               TRN_DATE LE &&TXDATE.EVAL THEN 'Y' ELSE 'N';
FLAG/A1 = 'A';
END

TABLE FILE CUHLD1
PRINT CURRENT
  FARE_PAID
  PRIOR	
  VOID_DATE 
BY FLAG
BY AIRLINE
ON TABLE HOLD AS CUAMT1
END
-RUN

DEFINE FILE CUAMT1
CFARE/D12.2 = IF (CURRENT EQ 'Y') AND (VOID_DATE EQ 0) THEN FARE_PAID ELSE 0;
PFARE/D12.2 = IF (PRIOR EQ 'Y') AND (VOID_DATE EQ 0) THEN FARE_PAID ELSE 0;
END

TABLE FILE CUAMT1
SUM CFARE
    PFARE
BY FLAG
BY AIRLINE
ON TABLE HOLD AS CUAMT2
END
-RUN

TABLE FILE CUAMT2
PRINT CFARE
      PFARE
      FLAG
      AIRLINE
RANKED BY HIGHEST CFARE NOPRINT
ON TABLE HOLD AS CUAMT3
END
-RUN

DEFINE FILE CUAMT3
LIST/D9 = IF AIRLINE NE LAST AIRLINE THEN 
           (LAST LIST + 1) ELSE LAST LIST;
  DRANK/D9 = RANK;
  ARANK/A11 = FTOA(DRANK, '(D9)', ARANK);
  ARANK1/A9 = EDIT(ARANK, '$$999999999');
  RANK_VALUE/A9 = IF LIST GT 5 THEN 'OTHER' ELSE ARANK1;
  RANK_LABEL/A30 = IF RANK_VALUE NE 'OTHER' THEN AIRLINE
                      ELSE 'ALL OTHER';
-* DEFINES ON PREVIOS DEFINES
 RANK_LAB/A30 = LCWORD(30, RANK_LABEL, RANK_LAB);
END
-RUN
TABLE FILE CUAMT3
SUM  CFARE 
     PFARE 
BY RANK_VALUE
BY RANK_LAB
ON TABLE HOLD AS CUAMT4
END
-RUN

GRAPH FILE CUAMT4
SUM CFARE AS 'Period1'
    PFARE AS 'Period2'
ACROSS RANK_LAB AS ''
WHERE RANK_LAB NE 'All Other'
ON TABLE SET 3D OFF
ON TABLE SAVE AS CRUAMT FORMAT GIF
ON TABLE SET GRAPHSTYLE *
setAutofit(getDataText(),true); 
setDataTextDisplay(true);
setDataTextFormat(6); 
setGraphType(16);
setLegendDisplay(true);
setLegendTextAutofit(true);
setLegendMarkerPosition(2);
setO1LabelDisplay(true);
setFontSizeAbsolute(getO1Label(),true); 
setAutofit(getO1Label(),true);
setFontStyle(getO1Label(),8);
setFontSize(getO1Label(),16);
setO1LabelRotate(0);
setO1MajorGridDisplay(false);
setO1MinorGridDisplay(false);
-* setY1LabelDisplay(true);
-* setY1LabelFormat(6);
-* setAutofit(getY1Label(),true);
-* setFontStyle(getY1Label(),8);
setY1LabelDisplay(true);
setY1LabelFormat(6);
setFontSizeAbsolute(getY1Label(),true);
setFontSize(getY1Label(),16);
setFontStyle(getY1Label(),10);
setY1AxisSide(0);
setY1MajorGridDisplay(false);
setY1MajorGridStyle(0);
setY1MinorGridDisplay(false);
setFontSizeAbsolute(getTitle(),true); 
setAutofit(getTitle(),false);
setTitleString("Carrier Usage Amount");
setTextJustHoriz(getTitle(),1);
setFontStyle(getTitle(),11);
setFontSize(getTitle(),20);
setFontSizeAbsolute(getSubtitle(),true); 
setSubtitleAutofit(false);
setSubtitleString("Per Airline");
setTextJustHoriz(getSubtitle(),1);
setFontStyle(getSubtitle(),11);
setFontSize(getSubtitle(),20);
setSeriesFillColor(0, new Color, 0 64 128));
setSeriesFillColor(1, new Color, 255 255 0));
setSeriesFillColor(2, new Color, 115 160 247));
ENDSTYLE 
END
-RUN


-SET &&G_GIF11=IF &LINES GT 0 THEN 'Y' ELSE 'N'











