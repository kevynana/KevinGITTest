
-INCLUDE SETECHO
SET ASNAMES = ON


EX CONCAT_ALL_DBS ROLL=PIPE-R,FID=SEG,CLEAR=Y
-RUN
-SET &&ROLLUP = 'PIPE-R';
-SET &&SETF = 'ABLDCO';
-SET &&OUTFMT = 'EXL2K';
  
SET ASNAMES = ON
-SET HOLDATTR = ON; 
SET TEMPERASE = OFF
-RUN

-SET &&IDLEVELBREAK = '';
-RUN
 
-SET &&AIR_DATES = 'WHERE TRN_DATE GE ''2017/01/01'' AND TRN_DATE LE ''2017/03/01''';

-TYPE &&AIR_DATES
 

-INCLUDE IDLEVROLLDEF
-RUN

DEFINE FILE SR_50
  BASE_FARE/D12.2CS = SEG_AMT - SEG_COM;
  ADDCOLLECT/D12.2CS = EXCH_NET_FARE + EXCH_NET_TAX;
  
-* CLASS_CAT/A8 = DECODE CL_CAT ('F' 'FIRST'     'C' 'COACH'   
-*                              'D' 'DISCOUNT'  'B' 'BUSINESS'
-*                                 ' ' 'OTHER');  


CLASS_CAT/A15 = DECODE CL_CAT ('F' 'FIRST'     'P' 'PREMIUM ECONOMY'   
			        'D' 'DEFAULT'   'B' 'BUSINESS'
			        'E' 'ECONOMY'   'U'  'UPGRADE' 
                                ' ' 'DEFAULT'); 

  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;   
  FARE_PAID2/D12.2CS = TICKET_AMT + TAX_AMT;

  LEVEL_DESC1/A60 = AROLL_DSC3;
  ADV_CAT/A8          = IF (ADV_PURCH LT 7) THEN '0 - 6' ELSE
                        IF (ADV_PURCH LT 14) THEN '07 - 13' ELSE
                        IF (ADV_PURCH LT 21) THEN '14 - 20' ELSE '21 +';
  NET_TKT_CNT/P8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  NEW_ADV_PURCH/D9     = ADV_PURCH;
  NEW_ADV_PURCH1/D9    = IF SEG_NBR EQ '01' THEN ADV_PURCH ELSE 0;

  NEW_SEG_AMT/D12.2CS  = SEG_AMT;
  NEW_SEG_DISC/D12.2CS = SEG_DISC;
  NEW_SEG_LOW/D12.2CS = SEG_LOWEST;
  NEW_SEG_MILES/D9= SEG_MILES;
  ORG_SALE/D12.2CS    = PARENT_FARE + PARENT_TAX;

  OTFLAG/A15 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN 'ONLINE' ELSE 'TRADITIONAL';

  REF_EXCH_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                            (SEG_NBR EQ '01') AND
                            (FARE_PAID GE 0) AND
                            (SEG_COUNT EQ 1) AND 
                            (CONJ_REL EQ 1) THEN 0 ELSE 
                         IF (TICKET_CODE EQ '1') AND
                            (SEG_NBR EQ '01') AND 
                            (EX_FLAG EQ 'F') THEN 1 ELSE 
                         IF (TICKET_CODE EQ '1') AND
                            (SEG_NBR EQ '01') AND
                            (RF_FLAG EQ 'F') THEN 1 ELSE 0;
  SAVINGS/D11.2CS      = SEG_STANDARD - FARE_PAID; 
  TKT_PURCH/D8CS       = IF (TICKET_CODE EQ '1') AND
                            (SEG_NBR EQ '01') AND
                            (FARE_PAID GE 0)  AND                    
                            (SEG_COUNT EQ 1)  AND
                            (CONJ_REL EQ 1) THEN 1 ELSE 0;
  TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                            (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                         IF (SEG_COUNT LE 0) AND 
                            (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                         IF (SEG_COUNT LE 0) AND 
                             (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                         IF (SEG_COUNT LE 0) AND 
                           (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  TKT_TYP2/A10          =   IF EXCHG_SALE NE ' ' AND VOID_DATE EQ 0 THEN 'EXCHG SALE' ELSE 
                            IF TKT_TYPE EQ ' ' AND VOID_DATE NE 0 THEN 'VOID' ELSE
                            IF TKT_TYPE EQ ' ' AND VOID_DATE EQ 0 THEN 'SALE' ELSE
                            IF TKT_TYPE EQ 'P-RF' OR 'F-RF' THEN 'REFUND' ELSE
                            'EXCHANGE';                           
-*  WWF_FSR/A1           = EDIT(LEVEL2,'$$$$$$$$$$$9$$$');
-*  WWF_FSR/A1           = EDIT(LEVEL2,'9');
-* WWF_FSR1/A4            =  EDIT(LEVEL1, '$$$$$$$$$$$9999');
 WWF_FSR1/A4            =  EDIT(EMP_ID, '$$$$$$$$$$$9999');
 WWF_FSR/A1             = EDIT(WWF_FSR1, '9');

  XAP/A8               = EDIT(ADV_PURCH);
  XARR_DT/MDYY         = ARR_DATE;
  XDPT_DT/MDYY         = DPT_DATE;
  XPSNGR_NM/A15        = EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;
  XFST_DTA/A8YYMD     = FST_DEST_DEPART_DATE;
  XFST_DT/MDYY        = XFST_DTA;  
  XFNL_DTA/A8YYMD     = FNL_DEST_ARRIVAL_DATE; 
  XFNL_DT/MDYY        = XFNL_DTA;
  VASAVINGS/D12.2CS    = NEW_SEG_DISC - FARE_PAID;

-* ****DEFINES ON PREVIOUS DEFINES****
  ADV_DAYS/A8        = IF ADV_PURCH LT 21 THEN XAP ELSE ADV_CAT;
  AIRLINE_FEE/D12.2CS = IF EMBARK EQ 'FP2' OR 'FP3' 
     THEN FARE_PAID ELSE 0;
  DISSAVINGS/D11.2CS = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST; 
  TKT_AMT/D12.2CS  = TICKET_AMT + TAX_AMT;
  
  EX_RF_FLAG/A1 = IF VOID_DATE NE 0  THEN ' ' ELSE
                  IF (((RF_FLAG EQ 'F' OR 'P') AND (EMBARK NE 'EX1' OR 'FP2' OR 'EX5') AND (SEG_COUNT LE 0)) OR (EMBARK EQ 'RF1')) THEN 'R' ELSE
                  IF (((EXSALE NE ' ') AND (SEG_COUNT GE 0)) OR ((EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (RF_FLAG EQ ' '))) THEN 'E' ELSE ' ';
 
  SALES_FLAG/A1 = IF RF_FLAG EQ ' ' AND EX_FLAG EQ ' '  AND VOID_DATE EQ 0 THEN 'S' ELSE IF RF_FLAG EQ ' ' AND EX_FLAG EQ ' '  AND VOID_DATE NE 0 THEN 'V' ELSE ' ';
 
  SERV_FLAG/A1 = IF SALES_FLAG EQ 'S' THEN 'S' ELSE
                IF SALES_FLAG EQ 'V' THEN 'V' ELSE
                IF EX_RF_FLAG EQ 'E' THEN 'E' ELSE
                IF EX_RF_FLAG EQ 'R' THEN 'R' ELSE '';  
  
                          
  TRIP_KEY/A2   = EDIT(TRP_KEY, '$$$$$$$$99');
  TRIPRSN/A10 = IF TRIP_KEY NE ' ' THEN TRIP_KEY ELSE 'ZZZZZZZZZZ';
  TRIP_RSN/A10 = IF TRIPRSN EQ 'ZZZZZZZZZZ' THEN 'NONE GIVEN' ELSE TRIPRSN;   
  ONLTKTS/P8CS = IF (OTFLAG EQ 'ONLINE') AND (AIR_MAIN.INTL_DOM EQ 'D') THEN NET_TKT_CNT ELSE 0;
  DTKTS/P8CS = IF (AIR_MAIN.INTL_DOM EQ 'D') THEN NET_TKT_CNT ELSE 0;
  06_TKT/P8CS = IF ADV_CAT EQ '0 - 6' THEN NET_TKT_CNT ELSE 0;
  713_TKT/P8CS = IF ADV_CAT EQ '07 - 13' THEN NET_TKT_CNT ELSE 0;
  1420_TKT/P8CS = IF ADV_CAT EQ '14 - 20' THEN NET_TKT_CNT ELSE 0;
  21_TKT/P8CS = IF ADV_CAT EQ '21 +' THEN NET_TKT_CNT ELSE 0;
  FULL_EXCH/I11 = IF SERV_FLAG EQ 'E' THEN NET_TKT_CNT ELSE 0;
  FULLE_FARE/P15.2 = IF SERV_FLAG EQ 'E' THEN FARE_PAID ELSE 0;
-*  FEXR/P8CS = IF NET_TKT_CNT EQ 0 THEN 0 ELSE (FULL_EXCH*(-1))/NET_TKT_CNT;   
  FEXR/P8CS = IF TKT_PURCH EQ 0 THEN 0 ELSE (FULL_EXCH*(-1))/TKT_PURCH;   
  NFVSV/D12.2CS = VASAVINGS;    
  EXG_ISS/D12CS = IF (EX_FLAG EQ 'F') AND (SEG_COUNT EQ -1) AND (SEG_NBR EQ '01') THEN 1 ELSE 0;
  PEXG_ISS/D12CS = IF (EX_FLAG EQ 'P') AND (TKT_NUM NE LAST TKT_NUM) THEN 1 ELSE 0;
  
-INCLUDE TRANTYPE  
-INCLUDE IDLEVDEFINE  
               
END
 
TABLE FILE SR_50
PRINT  ADDCOLLECT
  ADV_CAT
  ADV_DAYS 
  AGENT_NUM
  AIR_KEY	
  AIR_MAIN.INTL_DOM AS 'INTL_DOM'	
  AIRLINE	
  AIRLINE_FEE	
  AIRLINE_NAME
  AROLL_LEV1
  AROLL_LEV2
  AROLL_LEV3
  AROLL_LEV4
  AROLL_LEV5
  AROLL_DSC3
  AROLL_DSC4
  ARR_TIME
  BASE_FARE
  BR_CL_IDX
  CC_NUM
  C_ITIN
  CL_CAT	
  CLASS	
  CLASS_CAT	
  DISSAVINGS	
  DPT_TIME	
  CITYPAIR.EMBARK      AS 'EMB_APT_CD'	
  CITYPAIR.ROUTE       AS 'RTE_APT_CD'
  DOC_NUMBER
  DTKTS
  EMB_APT.AIRPORT_NAME AS 'EMB_APT_NM'
  EMB_CTY.CITY_NAME    AS 'EMB_CTY_NM'
  EMBARK
  EXCH_NET_FARE EXCH_NET_TAX
  EXCHG_SALE
  EX_FLAG
  EXG_ISS
  EX_RF_FLAG
  FARE_BAS
  FARE_PAID
  FARE_PAID2
  FLIGHT
  FST_DPT_DATE
  FULL_EXCH
  INVOICE_NUM	
  LEVEL_DESC
  EMP_ID
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  NET_TKT_CNT
  NEW_ADV_PURCH	
  NEW_ADV_PURCH1
  NEW_SEG_AMT
  NEW_SEG_DISC	
  NEW_SEG_MILES
  ORG_SALE
  OTFLAG
  ONLTKTS
  PEXG_ISS
  PNR_LOCATOR
  REF_EXCH_CNT
  REFUSAL_DESC	
  REFUSE_CODE	
  REFUSE_KEY   
  ROLLUP_CODE
  ROUTE
  RTE_APT.AIRPORT_NAME AS 'RTE_APT_NM'	
  RTE_CTY.CITY_NAME    AS 'RTE_CTY_NM'
  RTE_CTY.COUNTRY_CODE AS 'RTE_CNTRY_CODE'
  SAVINGS
  SEG_AMT
  SEG_COUNT	
  SEG_DESIG	
  SEG_LOWEST	
  SEG_NBR	
  SEG_STANDARD
  SEG_TAX
  TKT_DATE	
  TKT_NUM
  TKT_PURCH	
  TKT_SORT	
  TKT_TYPE
  TKT_TYP2
  TRN_DATE
  TRIP_PURPOSE
  TRP_REF.TRP_DESC 
  TKT_AMT
  XARR_DT
  XDPT_DT	
  XPSNGR_NM
  XTRAN_DT	
  STD_FARE
  LOWEST_AMT
  VOID_DATE
  TRIP_KEY
  TRIP_RSN
  XFST_DT
  XFNL_DT
  XTRAN_DT
  06_TKT
  713_TKT
  1420_TKT
  21_TKT
  VAL_AIRLINE
  CATEGORY
  AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
  FULL_EXCH
  FEXR
  NEW_SEG_LOW
  NFVSV
-*  EMBARPT.COUNTRY_CODE AS 'ECNTRY'
-*  RTEARPT.COUNTRY_CODE AS 'RCNTRY'
  EMB_CTY.COUNTRY_CODE AS 'ECNTRY'
  RTE_CTY.COUNTRY_CODE AS 'RCNTRY'
  
-INCLUDE &&AIR_DATES
WHERE AROLL_LEV2 EQ 'PIPEB'
WHERE VOID_DATE EQ 0
-*IF TKT_NUM CONTAINS 7732998064 OR 7915877246 OR 7916825870 OR 7917725853
ON TABLE HOLD AS AIRHOLD1
END
-RUN


 


DEFINE FILE AIRHOLD1
PEXG_ISS1/D12CS = IF TKT_NUM NE LAST TKT_NUM THEN PEXG_ISS ELSE 0;
END
-RUN
TABLE FILE AIRHOLD1
SUM PEXG_ISS PEXG_ISS1  
BY TKT_NUM
BY TKT_SORT
BY SEG_NBR
WHERE EX_RF_FLAG EQ 'E'
WHERE TKT_TYPE EQ 'P-EX'
ON TABLE HOLD AS EHLD
END
-RUN

 

MATCH FILE AIRHOLD1
PRINT 
  06_TKT
  1420_TKT
  21_TKT
  713_TKT
  ADDCOLLECT
  ADV_CAT
  ADV_DAYS 
  AGENT_NUM
  AIR_KEY
  AIRLINE
  AIRLINE_FEE
  AIRLINE_NAME
  AROLL_DSC3
  AROLL_DSC4
  AROLL_LEV3
  ARR_TIME
  BASE_FARE
  BR_CL_IDX
  C_ITIN
  CATEGORY
  CC_NUM
  CL_CAT
  CLASS
  CLASS_CAT
  DISSAVINGS
  DOC_NUMBER
  DOM_INTL_CODE 
  DPT_TIME
  DTKTS
  ECNTRY 
  EMB_APT_CD
  EMB_APT_NM
  EMB_CTY_NM
  EMBARK
  EX_FLAG
  EXCHG_SALE
  EXCH_NET_FARE EXCH_NET_TAX
  EXG_ISS
  FARE_BAS
  FARE_PAID
  FARE_PAID2
  FEXR
  FLIGHT
  FST_DPT_DATE
  FULL_EXCH
-*  FULL_EXCH
  INTL_DOM 
  INVOICE_NUM
  LEVEL_DESC
  EMP_ID
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LOWEST_AMT
  NET_TKT_CNT
  NEW_ADV_PURCH
  NEW_ADV_PURCH1
  NEW_SEG_AMT
  NEW_SEG_DISC
  NEW_SEG_LOW
  NEW_SEG_MILES
  NFVSV
  ONLTKTS
  ORG_SALE
  OTFLAG
  PEXG_ISS
  PNR_LOCATOR
  RCNTRY
  REF_EXCH_CNT
  REFUSAL_DESC
  REFUSE_CODE
  REFUSE_KEY   
  ROLLUP_CODE
  ROUTE
  RTE_APT_CD 
  RTE_APT_NM 
  RTE_CNTRY_CODE 
  RTE_CTY_NM 
  SAVINGS
  SEG_AMT
  SEG_COUNT
  SEG_DESIG
  SEG_LOWEST
  SEG_STANDARD
  SEG_TAX
  STD_FARE
  TKT_AMT
  TKT_DATE
  TKT_PURCH
  TKT_TYP2
  TKT_TYPE
  TRIP_KEY
  TRIP_PURPOSE
  TRIP_RSN
  TRN_DATE
  TRP_DESC 
  VAL_AIRLINE
  VOID_DATE
  XARR_DT
  XDPT_DT
  XFNL_DT
  XFST_DT
  XPSNGR_NM
  XTRAN_DT
BY TKT_NUM
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD
RUN
FILE EHLD
PRINT PEXG_ISS1
BY TKT_NUM
BY TKT_SORT
BY SEG_NBR
AFTER MATCH HOLD AS TESTHLD OLD-OR-NEW
END
-RUN  

DEFINE FILE TESTHLD
NWFULL2/D8 = FULL_EXCH * (-1) ;                   
NEWFULL/D8 = IF NWFULL2 GE 0 THEN NWFULL2 ELSE FULL_EXCH;  
END
TABLE FILE TESTHLD
PRINT 
      DTKTS
      DISSAVINGS
      FARE_PAID
      NET_TKT_CNT 
      ONLTKTS
      06_TKT
      713_TKT
      1420_TKT
      21_TKT 
      LEVEL_DESC
      VAL_AIRLINE
      CATEGORY
      FST_DPT_DATE
      DOM_INTL_CODE
      TRN_DATE
      NEWFULL AS 'FULL_EXCH'
      FEXR
      TKT_PURCH
      NEW_ADV_PURCH1
      TKT_NUM
BY ROLLUP_CODE      
ON TABLE HOLD AS XTWO FORMAT FOCUS INDEX ROLLUP_CODE
END
-RUN





TABLE FILE PREFAIR
PRINT ROLLUP_CODE
-*AIRLINE_CODE AIRLINE_CATEGORY TICKET_EFFECTIVE_DATE TICKET_EXPIRATION_DATE TSINT
AIRLINE_CODE AIRLINE_CATEGORY TICKET_EFFECTIVE_DATE TICKET_EXPIRATION_DATE TSINT GROUP_NUMBER DEPART_EFFECTIVE_DATE DEPART_EXPIRATION_DATE

WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE SET ASNAMES ON
ON TABLE HOLD AS NWPREFAIR FORMAT FOCUS INDEX ROLLUP_CODE
END
-RUN 
-SET &PAIRRECS=IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-RUN 



-IF '&PAIRRECS.EVAL' EQ 'N' GOTO NOprefAir;


TABLE FILE NWPREFAIR
SUM GROUP_NUMBER
BY GROUP_NUMBER NOPRINT
WHERE GROUP_NUMBER NE ' '
ON TABLE SAVE AS GROUP1
END
-RUN

-SET &GROUPCK2 = IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';
-IF &GROUPCK2 EQ 'N' THEN GOTO Cont2:

-READ GROUP1 &GN.A9
-CLOSE GROUP1

-Cont2:

JOIN CLEAR *

JOIN ROLLUP_CODE IN XTWO TO ALL ROLLUP_CODE IN NWPREFAIR AS J1
-RUN
 
DEFINE FILE XTWO
-*PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
-*            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND (FST_DPT_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND (AIRLINE_INT_DOM EQ 'B')  THEN 1 ELSE 
-*            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND (FST_DPT_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE 0;
-IF &GROUPCK2 EQ 'Y' THEN GOTO NWPDEFINE2;
PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
             IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B')  THEN 1 ELSE 
            IF  (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') THEN 1 ELSE 
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE 0;
-GOTO FinDefine2;
-NWPDEFINE2;
PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B')  AND (BR_CL_IDX EQ GROUP_NUMBER)  THEN 1 ELSE 
            IF  (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 0;
-FinDefine2
END

TABLE FILE XTWO
SUM DTKTS 
    DISSAVINGS
    FARE_PAID
    NET_TKT_CNT 
    ONLTKTS
    06_TKT
    713_TKT
    1420_TKT
    21_TKT  
    FULL_EXCH
    FEXR   
    PREF_AIRA 
    TKT_PURCH
    COMPUTE PREF_AIR1/A1 = IF PREF_AIRA GT 0 THEN 'P' ELSE 'N';  
BY LEVEL_DESC
BY VAL_AIRLINE
BY TRN_DATE
BY FST_DPT_DATE
BY CATEGORY
BY DOM_INTL_CODE
BY NEW_ADV_PURCH1
ON TABLE HOLD AS XTWOA
END
-RUN

DEFINE FILE XTWOA
PREF_AIR/P12CS = IF PREF_AIR1 EQ 'P' THEN NET_TKT_CNT ELSE 0;
TTLDAYS/D8 = NEW_ADV_PURCH1*NET_TKT_CNT;
END
TABLE FILE XTWOA
SUM DTKTS
    DISSAVINGS
    FARE_PAID
    NET_TKT_CNT 
    ONLTKTS
    06_TKT
    713_TKT
    1420_TKT
    21_TKT  
    FULL_EXCH
    FEXR
 
    PREF_AIR
    TKT_PURCH
    TTLDAYS
BY LEVEL_DESC
ON TABLE HOLD AS AIRHLD2
END
-RUN  
 

-* OBTAIN FORFEIT PENALTY AND ADDL COLLECTION 
TABLE FILE TESTHLD
SUM TKT_NUM XPSNGR_NM DOC_NUMBER EMBARK ROUTE TRN_DATE  
FARE_PAID ORG_SALE AIRLINE_FEE   EX_FLAG  EXCHG_SALE 
 EXCH_NET_FARE EXCH_NET_TAX  ADDCOLLECT FARE_PAID2  

BY LEVEL_DESC  
BY XPSNGR_NM
BY TKT_NUM NOPRINT 
BY DOC_NUMBER NOPRINT
BY TKT_SORT
BY SEG_NBR
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TRN_DATE NOPRINT
WHERE ((EXCHG_SALE NE ' ') AND (SEG_COUNT GE 0)) OR
((EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0)) 
-*WHERE AROLL_DSC3 CONTAINS '(EQUITIES) '
WHERE AROLL_DSC3 CONTAINS 'FXD INC SVC'

WHERE TRN_DATE GE '2017/01/01' AND TRN_DATE LE '2017/03/31'
ON TABLE HOLD AS TESTHLD2
END
-RUN

-GOTO DEB;
TABLE FILE TESTHLD
SUM TKT_NUM XPSNGR_NM DOC_NUMBER EMBARK ROUTE TRN_DATE  
FARE_PAID ORG_SALE AIRLINE_FEE   EX_FLAG  EXCHG_SALE 
 EXCH_NET_FARE EXCH_NET_TAX  ADDCOLLECT FARE_PAID2 TRN_DATE FARE_PAID2 

BY LEVEL_DESC  
BY XPSNGR_NM
BY TKT_NUM NOPRINT 
BY TKT_SORT
BY SEG_NBR
BY DOC_NUMBER NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TRN_DATE NOPRINT
WHERE ((EXCHG_SALE NE ' ') AND (SEG_COUNT GE 0)) OR
((EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0)) 
-*WHERE AROLL_DSC3 CONTAINS '(EQUITIES) '
WHERE AROLL_DSC3 CONTAINS 'FXD INC SVC'

WHERE TRN_DATE GE '2017/01/01' AND TRN_DATE LE '2017/03/31'
ON TABLE HOLD AS TESTHLD2
END
-RUN
-DEB;


DEFINE FILE TESTHLD2
PNLTY_AMT/D12.2 = IF TKT_SORT NE LAST TKT_SORT THEN AIRLINE_FEE ELSE 0;
DOCNBR/A9 = EDIT(DOC_NUMBER, '$999999999');
FARE/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN FARE_PAID2 ELSE 0;
ORGSALE/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN ORG_SALE ELSE 0;
AC_AMT/D12.2CS = IF ORGSALE GT FARE THEN 0 ELSE FARE - ORGSALE;
END
TABLE FILE TESTHLD2
PRINT 
  TRN_DATE 
  TKT_NUM 
  DOC_NUMBER 
  EX_FLAG
  PNLTY_AMT
  AC_AMT 
  FARE 
  ORGSALE
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE 

WHERE EX_FLAG EQ ' ' 
ON TABLE COLUMN-TOTAL
END
-RUN   
-QUIT

ON TABLE HOLD AS EXHOLD2 FORMAT FOCUS
END
-RUN
-GOTO ENDit;
-DEB;
DEFINE FILE TESTHLD2
-*EXCH_NETF/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN EXCH_NET_FARE ELSE 0;
-*EXCH_AMT/D12.2CS = IF (TKT_NUM NE LAST TKT_NUM) AND (EX_FLAG EQ ' ') THEN EXCH_NET_FARE ELSE 0;
EXCH_NETF/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN ADDCOLLECT ELSE 0;
EXCH_AMT/D12.2CS = IF (TKT_NUM NE LAST TKT_NUM) AND (EX_FLAG EQ ' ') THEN ADDCOLLECT ELSE 0;
ADD_COLL/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN ADDCOLLECT ELSE 0;
 FARE2/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN FARE_PAID2 ELSE 0;
 
ORGSALE /D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN ORG_SALE ELSE 0;
AC_AMT  /D12.2CS = IF EX_FLAG NE ' ' THEN 0 ELSE
                    IF ORGSALE GT FARE2 THEN 0 ELSE FARE2 - ORGSALE;
AC_AMT2  /D12.2CS = IF ORGSALE GT FARE2 THEN 0 ELSE FARE2 - ORGSALE;
END
TABLE FILE TESTHLD2
SUM TKT_NUM XPSNGR_NM DOC_NUMBER EMBARK ROUTE TRN_DATE  ADDCOLLECT
FARE_PAID ORG_SALE  ADD_COLL   FARE2 EXCH_NETF EXCH_AMT EX_FLAG  EXCHG_SALE ORGSALE  AIRLINE_FEE  AC_AMT AC_AMT2

BY LEVEL_DESC  
BY XPSNGR_NM
BY TRN_DATE
BY TKT_NUM  
BY EX_FLAG
-*ON TABLE HOLD AS EXCHGFEE     
END
-RUN
-QUIT

DEFINE FILE EXCHGFEE
FLAG/A1 = IF AC_AMT GT 0 OR AIRLINE_FEE GT 0 THEN 'Y' ELSE 'N';
END

TABLE FILE EXCHGFEE
SUM AC_AMT/D12.2 AIRLINE_FEE/D12.2  
BY LEVEL_DESC
BY XPSNGR_NM
BY TRN_DATE
BY TKT_NUM 
BY EX_FLAG
WHERE FLAG EQ 'Y'
ON TABLE PCHOLD FORMAT EXCEL
END
-RUN
-QUIT


TABLE FILE EXCHGFEE
SUM AIRLINE_FEE ADD_COLL
BY LEVEL_DESC
BY XPSNGR_NM
ON LEVEL_DESC SUMMARIZE MULTILINES AS 'TOTAL FOR'
END
-RUN
-QUIT

ON TABLE COLUMN-TOTAL
END
-RUN
-QUIT



DEFINE FILE TESTHLD
PNLTY_AMT/D12.2 = IF TKT_SORT NE LAST TKT_SORT THEN AIRLINE_FEE ELSE 0;
DOCNBR/A9 = EDIT(DOC_NUMBER, '$999999999');
AP_DAYS/D9 = IF TKT_NUM NE LAST TKT_NUM THEN NEW_ADV_PURCH ELSE 0;
FARE/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN FARE_PAID2 ELSE 0;
ORGSALE/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN ORG_SALE ELSE 0;
AC_AMT/D12.2CS = IF ORGSALE GT FARE THEN 0 ELSE FARE - ORGSALE;
C_ITIN2/A67 = IF C_ITIN EQ ' ' THEN 'MISCELL. CHARGE -MCO' ELSE C_ITIN;
END
TABLE FILE TESTHLD
PRINT 
  TKT_DATE 
  C_ITIN2 AS 'C_ITIN'  
  AP_DAYS
  TKT_NUM 
  DOC_NUMBER 
  EX_FLAG
  VAL_AIRLINE 
  PNLTY_AMT
  AC_AMT 
  FST_DPT_DATE
  FARE 
  ORGSALE
  NET_TKT_CNT
  PNR_LOCATOR
  TKT_PURCH
  EXG_ISS
  PEXG_ISS1 AS 'PEXG_ISS'
  INTL_DOM

BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE 
WHERE DOC_NUMBER IN FILE EXCHG
WHERE EX_FLAG EQ ' '

ON TABLE HOLD AS EXHOLD2 FORMAT FOCUS
END
-RUN


TABLE FILE EXHOLD2
SUM AC_AMT PNLTY_AMT 
BY LEVEL_DESC


-*ON TABLE HOLD AS EXCAIR2
END
-RUN 
-QUIT




MATCH FILE AIRHLD2
PRINT DTKTS
    DISSAVINGS
    FARE_PAID
    NET_TKT_CNT 
    ONLTKTS
    06_TKT
    713_TKT
    1420_TKT
    21_TKT  
    FULL_EXCH
    FEXR   
    PREF_AIR
    TKT_PURCH
    TTLDAYS
BY LEVEL_DESC
ON TABLE HOLD
RUN
FILE EXCAIR2
SUM AC_AMT PNLTY_AMT
BY LEVEL_DESC
AFTER MATCH HOLD AS AIRHLD3 OLD-OR-NEW
END
-RUN


TABLE FILE AIRHLD3
PRINT DTKTS
    DISSAVINGS
    FARE_PAID
    NET_TKT_CNT 
    ONLTKTS
    06_TKT
    713_TKT
    1420_TKT
    21_TKT  
    FULL_EXCH
    FEXR   
    PREF_AIR
    TKT_PURCH
    TTLDAYS
    AC_AMT PNLTY_AMT
BY LEVEL_DESC
-*ON TABLE HOLD AS AIRHLD
END
-RUN
-QUIT


