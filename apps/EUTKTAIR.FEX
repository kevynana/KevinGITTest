-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* File TKTAIR.FEX
-********************************************************************

-********************************************************************
-*
-* This program extracts data for the series of basic ticket listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-* 5/18/04 - DEB - ADDED AIRLINE_FEE COLUMN PER MONICA COLLIGAN
-* 10/08/04 - DV - ADDED LEVEL1 LEVEL2 LEVEL3
-* 12/15/04 - DV - ADDED FILEDEF CODE FOR FUJI REPORT
-* 01/04/05 - DV - ADDED CODE FOR GLOBAL CURRENCY 
-* 10/01/05 - DV - ADDED GEO_ZONE
-* ADDED TRANTYPE INCLUDE - JK 12/29/14 STORY ID S-06492
-*4/24/2017-JEM-S-33318-updated logic for no records report

-********************************************************************
-INCLUDE SETECHO 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN


-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';
-SET &WHATDATE = IF '&&DATETYPE.EVAL' EQ 'I' THEN 'TRN_DATE' ELSE 'FST_DPT_DATE';
DEFINE FILE &&EXTRACT
  AIRLN/A30 = AIRLINE_NAME;  
  CTY1/A3 = EDIT(CDIR_ALL, '999');
  CTY2/A25 = CITYPAIR.ROUTE;
  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;
  LEVEL_DESC/A60 = &&LDESC;
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  XDPT_DT/MDYY         = DPT_DATE;
  XPSNGR_NM/A15        = 
    EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;
  XFST_DPT/MDYY = FST_DPT_DATE;

-INCLUDE TRANTYPE

END


TABLEF FILE &&EXTRACT
PRINT AIR_KEY
  AIRLN     
  CONJ_REL
  CTY1
  ORG_APC 
  C_ITIN
  EX_FLAG
  FARE_PAID
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  NET_TKT_CNT 
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  DST_APC  
  SEG_COUNT
  SEG_NBR
  TICKET_CODE
  TKT_DATE
  TKT_NUM
  TKT_SORT
  TKT_TYPE 
  &WHATDATE
  XDPT_DT   
  XTRAN_DT   
  XPSNGR_NM
  XFST_DPT

-INCLUDE &AIRDATES
WHERE VOID_DATE EQ 0

-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
-* &&WHERE7
-* &&WHERE8
-* &&WHERE9
-* &&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS AIRHOLD
END
-RUN


-IF &LINES EQ 0 THEN GOTO NOAIR;

 
 
JOIN AIRHOLD.CTY1 IN AIRHOLD TO EMBCITY.EMB_CITY IN EMBCITY AS J1
-RUN

TABLE FILE AIRHOLD
PRINT AIR_KEY
  AIRLN  
  CONJ_REL 
  ORG_APC
  CITY_NAME AS 'ORIG'
  C_ITIN
  EX_FLAG
  FARE_PAID
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  NET_TKT_CNT 
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  DST_APC
  SEG_COUNT
  SEG_NBR
  TICKET_CODE
  TKT_NUM
  TKT_SORT
  TKT_TYPE 
  &WHATDATE
  XDPT_DT  
  XTRAN_DT  
  XPSNGR_NM
  XFST_DPT
  TKT_DATE
BY DST_APC
ON TABLE HOLD AS AIRHOLD1  
END
-RUN



JOIN AIRHOLD1.DST_APC IN AIRHOLD1 TO AIRPORT.AIRPORT_CODE IN AIRPORT AS J2
-RUN

JOIN AIRPORT.CITY_CODE IN AIRHOLD1 TO CITY.CITY_CODE IN CITY AS J3
-RUN

TABLE FILE AIRHOLD1
PRINT  
  AIRLN AS 'NAME' 
  CONJ_REL 
  ORG_APC
  ORIG
  DST_APC
  CITY_NAME AS 'DEST'
  C_ITIN
  EX_FLAG
  FARE_PAID
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  NET_TKT_CNT 
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  DST_APC
  SEG_COUNT
  SEG_NBR
  TICKET_CODE
-* TKT_NUM
  TKT_SORT
  TKT_TYPE AS 'TYPE'
  &WHATDATE
  XFST_DPT AS 'DATE'
  XTRAN_DT AS 'TRAN_DATE'
  XPSNGR_NM
  TKT_DATE
BY AIR_KEY
BY TKT_NUM
ON TABLE HOLD AS AIRHOLD2
END
-RUN


TABLE FILE AIRHOLD2
SUM FARE_PAID AS 'AMOUNT'
    NET_TKT_CNT/D12CS AS 'TTL_COUNT'
BY PASSNGR_NAME
BY TKT_SORT
BY &WHATDATE
ON TABLE HOLD AS HOLD3
END
-RUN


TABLE FILE AIRHOLD2
PRINT 
  ORG_APC
  ORIG
  DST_APC
  C_ITIN
  DEST
  CONJ_REL
  DATE
  EX_FLAG
  FARE_PAID
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NAME
  NET_TKT_CNT
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_COUNT
  TICKET_CODE
  TKT_NUM
  TRAN_DATE  
  TYPE
BY PASSNGR_NAME NOPRINT
BY TKT_SORT  
BY &WHATDATE
BY SEG_NBR   
ON TABLE HOLD AS XTWO
END
-RUN

MATCH FILE XTWO
PRINT 
  ORG_APC
  ORIG
  DST_APC
  C_ITIN
  DEST
  CONJ_REL
  DATE
  EX_FLAG
  FARE_PAID
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NAME
  NET_TKT_CNT
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_COUNT
  TICKET_CODE
  TKT_NUM
  TRAN_DATE  
  TYPE
BY PASSNGR_NAME NOPRINT
BY TKT_SORT   
BY &WHATDATE
BY SEG_NBR   
ON TABLE HOLD
RUN
FILE HOLD3
PRINT
  AMOUNT
  TTL_COUNT   
BY PASSNGR_NAME   
BY TKT_SORT  
BY &WHATDATE  
AFTER MATCH HOLD AS XTHREE OLD-OR-NEW
END
-RUN


TABLE FILE XTHREE
PRINT 
  AMOUNT
  ORG_APC
  ORIG
  C_ITIN
  DEST
  DST_APC
  CONJ_REL
  DATE
  EX_FLAG
  FARE_PAID
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NAME
  NET_TKT_CNT
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_COUNT
  TICKET_CODE
  TTL_COUNT
  TKT_NUM
  TRAN_DATE  
  TYPE
BY PASSNGR_NAME NOPRINT
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD3
END
-RUN

DEFINE FILE AIRHOLD3
SEG/A2 = SEG_NBR;
TSORT/A11 = TKT_SORT;
END
TABLE FILE AIRHOLD3
SUM
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
-*  TKT_NUM
  TSORT
  TYPE
  SEG
  NAME
  DATE
  ORG_APC
  DEST AS 'CITY2'
  DST_APC
  C_ITIN
  ORIG AS 'CITY1'
  FARE_PAID AS 'AMOUNT'
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
BY TKT_NUM
BY TSORT
ON TABLE HOLD AS AIRHOLD4
END
-RUN




-INCLUDE EUR_ALVL
-RUN



MATCH FILE AIRHOLD4
SUM PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
 
  TSORT
  TYPE
  SEG
  NAME
  DATE
  ORG_APC
  CITY2
  DST_APC
  C_ITIN
  CITY1
  AMOUNT
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
BY TKT_NUM 
ON TABLE HOLD 
RUN
FILE AIR_LVL
SUM LEVEL PCT LEVEL03 LEVEL04 LEVEL05
BY TKT_NUM
BY LEVEL NOPRINT
AFTER MATCH HOLD AS MATCHONE OLD 
END
-RUN




DEFINE FILE MATCHONE
PCT2/D15.2=EDIT(PCT) / 100;
PCT3/D15.2 = IF PCT2 GT 100 THEN 1.00 ELSE PCT2;
PCT4/A15 = IF PCT3 EQ 1.00 OR 0 THEN '100' ELSE PCT;
END
TABLE FILE MATCHONE
PRINT PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TYPE
  NAME
  DATE
  CITY1
  CITY2
  AMOUNT
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL
  PCT4 AS 'PCT'
  LEVEL03
  LEVEL04
  LEVEL05
BY PASSNGR_NAME NOPRINT
BY TKT_NUM NOPRINT
ON TABLE HOLD AS AIRHOLD5
END
-RUN


DEFINE FILE AIRHOLD5
FLAG/A1 = 'A';
END
TABLE FILE AIRHOLD5
PRINT PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TYPE
  NAME
  DATE
  CITY1
  CITY2
  AMOUNT
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL
  PCT
  LEVEL03
  LEVEL04
  LEVEL05
BY FLAG  
BY PASSNGR_NAME NOPRINT
BY TKT_NUM NOPRINT
ON TABLE HOLD AS HOLDA FORMAT FOCUS
END
-RUN


-NOAIR
-SET &&AIRREC=IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';


