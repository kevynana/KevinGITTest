-*=================================================================================================
-* program name: adhocrpt.fex
-* This program acts like rpt_stream until it calls EX &&EXPARM.  Then it should call querygen.fex
-* to geneate an adhoc query, then execute that query.
-* 01/29/2010
-*  02/02/2015  REJ  S-05681 Changes to the no data report to prepare for the Available
-*                           Report changes.  Rollup Code is being removed from BRPTINST in
-*                           ER5, so I'm removing the reference to the ROLLUP_CODE in that report.
-*=================================================================================================
-INCLUDE SETECHO
-DEFAULT &FPARM = ' ';
-DEFAULT &&GLO_CHK='N';

-ALLOTHER;
EX SETDBLS SETFILE=&&SETF
-RUN
-INCLUDE OTHPARMS

-TYPE &&OUTPUTDEST
-IF &&OUTLINE2 EQ 'OFFLINE' THEN GOTO XOFFLINE ELSE GOTO XONLINE;
-RUN

-XONLINE
-TYPE Before ONLINE
-TYPE &&OUTLINE2
-TYPE After ONLINE
-RUN
-GOTO CONT

-XOFFLINE
-SET &&OUTLINE2 = '';
-TYPE Before OFFLINE
-TYPE &&OUTLINE2
-TYPE After OFFLINE
-RUN

-CONT
-SET &&RPT_HOLD = 'RPTHOLD';

-SET &&DRILLSTREAM = 'Y';

-SET &&DRILLABLE = IF (&&SUMFLAG EQ 'Y') AND 
- (&&OUTLINE2 CONTAINS 'PDF' OR 'EXL2K') 
- THEN 'Y' ELSE 'N';

FILEDEF AUSEINCL DISK &&AUSEPASS
-RUN
FILEDEF CUSEINCL DISK &&CUSEPASS
-RUN
FILEDEF HUSEINCL DISK &&HUSEPASS
-RUN
FILEDEF LUSEINCL DISK &&LUSEPASS
-RUN

-INCLUDE SELCATQT
-RUN
-TYPE &&CATQTRPR

EX SUUSES
-RUN

EX &&CATQTRPR
-RUN

FILEDEF AUSEINCL CLEAR
-RUN
FILEDEF CUSEINCL CLEAR
-RUN
FILEDEF HUSEINCL CLEAR
-RUN
FILEDEF LUSEINCL CLEAR
-RUN

-IF '&&RPTTYPE.EVAL' EQ 'AIR' OR '&&RPTTYPE.EVAL' EQ 'ADD' THEN GOTO USEAIR
- ELSE IF '&&RPTTYPE.EVAL' EQ 'CAR' OR '&&RPTTYPE.EVAL' EQ 'CDD' THEN GOTO USECAR
- ELSE IF '&&RPTTYPE.EVAL' EQ 'HTL' OR '&&RPTTYPE.EVAL' EQ 'HDD' THEN GOTO USEHTL
- ELSE IF '&&RPTTYPE.EVAL' EQ 'LIM' OR '&&RPTTYPE.EVAL' EQ 'LDD' THEN GOTO USELIM
- ELSE GOTO NORECORDS;

-USEAIR
EX AIRUSE
-RUN
-GOTO EXTRACTDATA;

-USECAR
EX CARUSE
-RUN
-GOTO EXTRACTDATA;

-USELIM
EX LIMUSE
-RUN
-GOTO EXTRACTDATA;

-USEHTL
EX HTLUSE
-RUN
-GOTO EXTRACTDATA;

-EXTRACTDATA

-TYPE Before Extract
-TYPE &&EXPARM
-*-SET &&FindData = 'Y';

-*-IF '&&UNAME.EVAL' EQ 'lusheng' THEN GOTO debugging;

EX &&EXPARM
-RUN

-GOTO skipdebug;
-debugging
-*EX AVIEW0EX2
-RUN
-skipdebug

-TYPE After Extract
-IF '&&UNAME.EVAL' NE 'lusheng' THEN GOTO NOSTOPIT;
-*TABLE FILE RHOLD1
-*PRINT VOID_STATUS VOID_DATE VOID SEG_COUNT RF_FLAG EX_FLAG TKT_TYPE
-*XTRAN_DT 
-*BY TKT_NUM
-*END
-*-RUN
-*-QUIT
-NOSTOPIT

-IF &&FindData EQ 'N' THEN GOTO NORECORDS;

-SET &&FEXNOW=&&EXPARM;
-INCLUDE ERRORCHK
-IF &&RET GT 1 GOTO XXIT;

-*Generate an adhoc query and run the report 
-*-IF '&&UNAME.EVAL' EQ 'lusheng' THEN GOTO BUILDER2;
EX QueryBuilder
-RUN
-GOTO XXIT

-BUILDER2
-*EX QueryBuilder_LS
-RUN

-GOTO XXIT

-NORECORDS
-INCLUDE SetParmtime
-RUN
-SET &&RPTSUF = 'MSG';
-INCLUDE FDEFRPTS
JOIN SET_KEY IN BRPTINST TO SET_KEY IN BRPT_SET AS J1

DEFINE FILE BRPTINST
  EMPTY/A35 = 'NO RECORDS FOUND FOR THIS SELECTION';
  NOWTOD/A8 WITH INST_KEY = HHMMSS (NOWTOD);
END
TABLE FILE BRPTINST
-INCLUDE HEADAIR
PRINT EMPTY AS 'REPORT,MESSAGE' 
BY ROLLUP_CODE AS 'ROLLUP,CODE'
BY RPT_NAME AS 'REPORT,NAME'
BY SELECT_LEV AS 'BREAK,LEVEL'
IF INST_KEY EQ &&IKEY
IF RECORDLIMIT EQ 1
-INCLUDE FOOTERDT
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET PAGE-NUM OFF
ON TABLE SET STYLE *
-INCLUDE &&DTSTY
ENDSTYLE
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN

-XXIT