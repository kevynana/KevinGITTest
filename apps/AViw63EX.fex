-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* File AVIW63EX.FEX

-****************************************************************************
-* DATE       INITIAL        DESCRIPTION
-* 3/16/01    TANDT-SS       ADD DOD_TYPE TO SELECT INTERNET/NON-INTERNET
-* 6/7/01     TANDT-DB       CHANGED DEFINE DUE TO BALACING ISSUES
-*                           (EX1-EX1)
-* 4/29/02    TANDT SC DB    CHANGED NET_TKT_CNT DEFINE TO CORRECTLY BACK OUT 
-*                           PARTIAL REFUNDS AND EXCHANGES  
-* 7/10/02    TANDT-JK       Changed Ibook define to reflect new standards
-* 6/24/04  JK - Added segmiles and defined miles for each period 
-*12/21/04  DV   CHANGED IBOOK DEFINE TO INCLUDE ADDTL DOD_TYPE
-* 1/19/05  DV   ADDED CODE FOR GLOBAL_CURRENCY
-*10/11/05  DV   CHANGED IBOOK DEFINE TO INCLUDE DOD_TYPE 'H'
-*02/28/13  CHANGED CLASS_CAT DEFINE DUE TO CLASS CATEGORY CHANGES - DV
-*7/30/13   JK Added Advanced Purchase for Kate
-* ADDED TRANTYPE INCLUDE - JK 12/15/14 STORY ID S-06492

-****************************************************************************
-INCLUDE SETECHO
-TYPE EXTRACT1
SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

DEFINE FILE &&EXTRACT
COMM_SEG/D12.2S   = SEG_COM;
-*CP_CL_CAT/A8 = DECODE CL_CAT ('F' 'FIRST'     'C' 'COACH'   
-*                              'D' 'DISCOUNT'  'B' 'BUSINESS');
 CP_CL_CAT/A15 = DECODE CL_CAT ('F' 'FIRST'     'P' 'PREMIUM ECONOMY'   
			        'D' 'DEFAULT'   'B' 'BUSINESS'
			        'E' 'ECONOMY'   'U'  'UPGRADE' 
                                ' ' 'DEFAULT'); 
DEMB_APT/A21=EDIT(EMB_APT.AIRPORT_NAME,'999999999999999999999$$$$');
DIR_CITY_CD/A50 = EMB_CTY.EMB_CITY || '-' || RTE_CTY.RTE_CITY;
DIR_CITY_NM/A50 = EMB_CTY.CITY_NAME | RTE_CTY.CITY_NAME; 
DIR_CP_CD/A50 = CITYPAIR.EMBARK || '-' || CITYPAIR.ROUTE;
DIR_CP_NM/A50 = EMB_APT.AIRPORT_NAME | RTE_APT.AIRPORT_NAME;
DRTE_APT/A21=EDIT(RTE_APT.AIRPORT_NAME,'999999999999999999999$$$$');
EMB_APT/A21=EDIT(NDO_APT.AIRPORT_NAME,'999999999999999999999$$$$');
FARE_PAID/D12.2S  = SEG_AMT;
-*ADDED FOR CONAGRA CITYPAIR REPORT FOR ICG COMMERCE
FARE_BAS1/A1 = EDIT (CLASS, '9');
-* ADDED FOR INTERNET BOOKINGS
IBOOK/A33 = IF DOD_TYPE EQ 'H' OR 'I' OR 'J' THEN 'ONLINE BOOKINGS' ELSE
     IF DOD_TYPE EQ 'M' OR 'X' THEN 'EXCHANGE FROM AN INTERNET BOOKING' ELSE
     IF DOD_TYPE EQ 'A' OR 'L' OR 'N' OR 'S' THEN 'WEB BOOKINGS' ELSE
     'TRADITIONAL BOOKINGS'; 
KILO/D9      = CITYPAIR.SEG_MILES * 1.60934 ;  
LEVEL_DESC/A60 = &&LDESC;
MILES/P9CS = CITYPAIR.SEG_MILES;
ND_CITY_CD/A50 = NDO_CTY.NDO_CITY || '-' || NDD_CTY.NDD_CITY;
ND_CITY_NM/A50 = NDO_CTY.CITY_NAME | NDD_CTY.CITY_NAME;
ND_CP_CD/A50  = NDO_APT.ND_ORG || '-' || NDD_APT.ND_DST;
NET_COMM/D12.2S   = (SEG_AMT - SEG_COM);
-* NET_COMM/D12.2S   = IF (SEG_AMT LT 0) AND (SEG_COM GT 0) THEN 
-*                    (SEG_AMT + SEG_COM) ELSE (SEG_AMT - SEG_COM);
NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (EX_FLAG NE ' ') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (RF_FLAG NE ' ') THEN (-1) ELSE 0;
NET_FARE/D12.2S  = IF (EX_FLAG EQ ' ') AND (RF_FLAG EQ ' ')
                         THEN SEG_AMT ELSE 0;
NEW_SEG_COUNT/D8CS = SEG_COUNT;
NEW_ADV_PURCH/P12    = ADV_PURCH;
-* EW_ADV_PURCH/P12 = IF RF_FLAG EQ ' ' THEN NEW_ADV_PURCH1 ELSE
-*                     IF EX_FLAG EQ ' ' THEN NEW_ADV_PURCH1 ELSE (NEW_ADV_PURCH1 * (-1));
RTE_APT/A21=EDIT(NDD_APT.AIRPORT_NAME,'999999999999999999999$$$$');
TOTAL_FARE/D12.2S = SEG_AMT + SEG_TAX;
VASAVINGS/D11.2CS = SEG_DISCOUNT - TOTAL_FARE;
XPSNGR_NM/A15 = EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
XTRAN_DT/MDYY = TRN_DATE;

-* ****DEFINES ON PREVIOUS DEFINES****

DISSAVINGS/D11.2CS= IF EMBARK EQ 'DT1' THEN 0 ELSE
                         TOTAL_FARE - SEG_LOWEST;

ND_CP_NM/A50 = EMB_APT|'        '|RTE_APT;
ORGDST/A50 = &&ORGDST;
SAVINGS/D11.2CS   = SEG_STANDARD - TOTAL_FARE;  
 P1/A1 = IF (TRN_DATE GE &&FROMDT.EVAL) AND 
            (TRN_DATE LE &&TODT.EVAL) THEN 'Y' ELSE 'N';
 P2/A1 = IF (TRN_DATE GE &&FXDATE.EVAL) AND 
            (TRN_DATE LE &&TXDATE.EVAL) THEN 'Y' ELSE 'N';
            
 P1AP1/P12 = IF P1 EQ 'Y' THEN NEW_ADV_PURCH ELSE 0;
 P2AP1/P12 = IF P2 EQ 'Y' THEN NEW_ADV_PURCH ELSE 0;

 P1FARE/D12.2CS = IF P1 EQ 'Y' THEN FARE_PAID ELSE 0;
 P1CNT/P9CS = IF P1 EQ 'Y' THEN NET_TKT_CNT ELSE 0;
 P1KILO/D9 = IF P1 EQ 'Y' THEN KILO ELSE 0;
 P2KILO/D9 = IF P2 EQ 'Y' THEN KILO ELSE 0;
 P1MILES/P9CS = IF P1 EQ 'Y' THEN MILES ELSE 0;
 P2FARE/D12.2CS = IF P2 EQ 'Y' THEN FARE_PAID ELSE 0;
 P2CNT/P9CS = IF P2 EQ 'Y' THEN NET_TKT_CNT ELSE 0;
 P2MILES/P9CS = IF P2 EQ 'Y' THEN MILES ELSE 0;
 
 P1AP/P12 = IF P1CNT LT 0 THEN P1AP1*(-1) ELSE P1AP1;
 P2AP/P12 = IF P2CNT LT 0 THEN P2AP1*(-1) ELSE P2AP1;

-******** NEW DEFINES TO CORRECT CITY/AIRPORT NAME/CODE ISSUE JK ******

-******* PRODUCES DIRECTIONAL CITY CODES ***************
DIR_CTY_CDO/A25 = EMB_CTY.EMB_CITY;
DIR_CTY_CDD/A25 = RTE_CTY.RTE_CITY;

-******* PRODUCES DIRECTIONAL CITY NAMES ***************
DIR_CTY_NMO/A25 = EMB_CTY.CITY_NAME;
DIR_CTY_NMD/A25 = RTE_CTY.CITY_NAME;

-********* PRODUCES DIRECTIONAL AIRPORT CODES ********
DIR_APT_CDO/A25 = CITYPAIR.EMBARK;
DIR_APT_CDD/A25 = CITYPAIR.ROUTE;

-********* PRODUCES DIRECTIONAL AIRPORT NAMES ********
DIR_APT_NMO/A25 = EMB_APT.AIRPORT_NAME;
DIR_APT_NMD/A25 = RTE_APT.AIRPORT_NAME;

-********* PRODUCES NON-DIRECTIONAL CITY CODES ********
ND_CTY_CDO/A25 = NDO_CTY.NDO_CITY;
ND_CTY_CDD/A25 = NDD_CTY.NDD_CITY;

-********* PRODUCES NON-DIRECTIONAL CITY NAMES ********
ND_CTY_NMO/A25 = NDO_CTY.CITY_NAME;
ND_CTY_NMD/A25 = NDD_CTY.CITY_NAME;

-******** PRODUCES NON-DIRECTIONAL AIRPORT CODES ****
ND_APT_CDO/A25 = NDO_APT.ND_ORG;
ND_APT_CDD/A25 = NDD_APT.ND_DST;

-******** PRODUCES NON-DIRECTIONAL AIRPORT NAMES ****
ND_APT_NMO/A25 = EDIT(NDO_APT.AIRPORT_NAME, '999999999999999999999$$$$');
ND_APT_NMD/A25 = EDIT(NDD_APT.AIRPORT_NAME, '999999999999999999999$$$$');

-INCLUDE TRANTYPE

END
-RUN

TABLEF FILE &&EXTRACT
PRINT 
  AIR_KEY	
  AIRLINE	
  AIRLINE.AIRLINE AS 'AIR_LINE'	
  AIRLINE.AIRLINE_NAME 	
  AR_BRANCH
  CITYPAIR.AIRLINE AS 'CP_AIRLINE'	
  CITYPAIR.CLASS AS 'CP_CLASS'	
  CITYPAIR.EMBARK AS 'CP_EMB'         	
  CITYPAIR.INTL_DOM AS 'INTL_DOM'	
  CITYPAIR.NET_COMM AS 'NET_COMM'	
  CITYPAIR.ROUTE AS 'CP_RTE'	
  CITYPAIR.SEG_MILES/D9C AS 'MILES'	
  CLASS	
  CLS_CAT.CAT_DESC AS 'CAT_DESC'	
  COMM_SEG	
  CP_CL_CAT
  DEMB_APT	
  DISSAVINGS	
  DOC_TYPE
  DRTE_APT	
  EMB_APT
  FARE_BAS1	
  FARE_PAID 
  IBOOK
  KILO
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  ND_CP_CD
  ND_CP_NM
  NET_FARE	
  NET_TKT_CNT	
  NEW_SEG_COUNT	
  ORGDST	
  PASSNGR_NAME
  P1
  P2
  P1AP
  P2AP
  P1CNT
  P2CNT
  P1FARE
  P2FARE
  P1KILO
  P2KILO
  P1MILES
  P2MILES
  REFUSE_KEY	
  RTE_APT	
  SAVINGS	
  SEG_COUNT	
  SEG_NBR
  TKT_DATE	
  TKT_NUM	
  TOTAL_FARE	
  TRN_DATE   	
  VASAVINGS 	
  XPSNGR_NM	
  XTRAN_DT  
-******* NEW FIELDS *********
  DIR_CTY_CDO
  DIR_CTY_CDD
  DIR_CTY_NMO
  DIR_CTY_NMD
  DIR_APT_CDO
  DIR_APT_CDD
  DIR_APT_NMO
  DIR_APT_NMD
  ND_CTY_CDO
  ND_CTY_CDD
  ND_CTY_NMO
  ND_CTY_NMD
  ND_APT_CDO
  ND_APT_CDD
  ND_APT_NMO
  ND_APT_NMD        	    	
WHERE (((TRN_DATE GE &&FROMDT.EVAL) AND (TRN_DATE LE &&TODT.EVAL)) OR
      ((TRN_DATE GE &&FXDATE.EVAL) AND (TRN_DATE LE &&TXDATE.EVAL)))
WHERE VOID_DATE EQ 0
   
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS
ON TABLE HOLD AS TOPMPYR
END
-RUN


TABLE FILE TOPMPYR
PRINT AIR_KEY	
  AIRLINE	
  AIR_LINE	
  AIRLINE_NAME 	
  AR_BRANCH
  CP_AIRLINE	
  CP_CLASS	
  CP_EMB         	
  INTL_DOM	
  NET_COMM	
  CP_RTE	
  MILES	
  CLASS	
  CAT_DESC	
  COMM_SEG	
  CP_CL_CAT
  DEMB_APT	
  DISSAVINGS	
  DOC_TYPE
  DRTE_APT	
  EMB_APT
  FARE_BAS1	
  FARE_PAID  
  IBOOK
  KILO
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  ND_CP_CD
  ND_CP_NM
  NET_FARE	
  NET_TKT_CNT	
  NEW_SEG_COUNT	
  ORGDST	
  PASSNGR_NAME
  P1
  P2
  P1AP
  P2AP  
  P1CNT
  P2CNT
  P1FARE
  P2FARE
  P1KILO
  P2KILO
  P1MILES
  P2MILES
  REFUSE_KEY	
  RTE_APT	
  SAVINGS	
  SEG_COUNT	
  SEG_NBR
  TKT_NUM	
  TOTAL_FARE	
  TRN_DATE   	
  VASAVINGS 	
  XPSNGR_NM	
  XTRAN_DT  
-******* NEW FIELDS *********
  DIR_CTY_CDO
  DIR_CTY_CDD
  DIR_CTY_NMO
  DIR_CTY_NMD
  DIR_APT_CDO
  DIR_APT_CDD
  DIR_APT_NMO
  DIR_APT_NMD
  ND_CTY_CDO
  ND_CTY_CDD
  ND_CTY_NMO
  ND_CTY_NMD
  ND_APT_CDO
  ND_APT_CDD
  ND_APT_NMO
  ND_APT_NMD
BY TKT_DATE 
ON TABLE HOLD AS TOPMPYR1 FORMAT FOCUS INDEX TKT_DATE
END
-RUN

-* Global Reporting JOIN
JOIN TOPMPYR1.TKT_DATE IN TOPMPYR1 TO GLOBAL.DATE IN GLOBAL AS J1


DEFINE FILE TOPMPYR1
NAMEC/A30 = CNAME;

-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
 PAID_FAREX/D20.6 = FARE_PAID * CURR1X;
 FARE_P1X/D20.6 = P1FARE * CURR1X;
 FARE_P2X/D20.6 = P2FARE * CURR1X;
 
END
-RUN  

TABLE FILE TOPMPYR1
PRINT AIR_KEY	
  AIRLINE	
  AIR_LINE	
  AIRLINE_NAME 	
  AR_BRANCH
  CP_AIRLINE	
  CP_CLASS	
  CP_EMB         	
  INTL_DOM	
  NET_COMM	
  CP_RTE	
  MILES	
  CLASS	
  CAT_DESC	
  COMM_SEG	
  CP_CL_CAT
  DEMB_APT	
  DISSAVINGS	
  DOC_TYPE
  DRTE_APT	
  EMB_APT
  FARE_BAS1	
  FARE_PAID  AS 'CP_FARE_PD'
  IBOOK
  KILO
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  ND_CP_CD
  ND_CP_NM
  NET_FARE	
  NET_TKT_CNT	
  NEW_SEG_COUNT	
  ORGDST	
  PASSNGR_NAME
  P1
  P2
  P1AP
  P2AP  
  P1CNT
  P2CNT
  P1FARE
  P2FARE
  P1KILO
  P2KILO
  P1MILES
  P2MILES
  REFUSE_KEY	
  RTE_APT	
  SAVINGS	
  SEG_COUNT	
  SEG_NBR
  TKT_NUM	
  TOTAL_FARE	
  TRN_DATE   	
  VASAVINGS 	
  XPSNGR_NM	
  XTRAN_DT  
-******* NEW FIELDS *********
  DIR_CTY_CDO
  DIR_CTY_CDD
  DIR_CTY_NMO
  DIR_CTY_NMD
  DIR_APT_CDO
  DIR_APT_CDD
  DIR_APT_NMO
  DIR_APT_NMD
  ND_CTY_CDO
  ND_CTY_CDD
  ND_CTY_NMO
  ND_CTY_NMD
  ND_APT_CDO
  ND_APT_CDD
  ND_APT_NMO
  ND_APT_NMD
  PAID_FAREX/D16.2CS
  NAMEC
  FARE_P1X/D16.2CS
  FARE_P2X/D16.2CS
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS TPMPYR
END
-RUN 



-*-QUIT
