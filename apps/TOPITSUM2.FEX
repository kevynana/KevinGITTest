-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* JK Added Level2, Level3 9/16/04
-* DV ADDED CODE FOR GLOBAL CURRENCY 1/6/05
-* DV ADDED SORT BY LEVEL1 FOR CONG 4/7/08
-INCLUDE SETECHO
SET ASNAMES=ON


-IF '&&NOAIRREC.EVAL' EQ 'Y' AND '&&NOCARREC.EVAL' EQ 'Y' AND 
-  '&&NOHTLREC.EVAL' EQ 'Y' THEN GOTO XXITALL;


-SET &&RPTSUF = 'SMY';



-SET &&SORT1 = &&RANK_LABEL1;
-SET &&SORT2 = &&RANK_LABEL2;


-IF '&&SETF.EVAL' EQ 'ITBUSUM' THEN GOTO DEBSUM;
-IF '&&SETF.EVAL' EQ 'ITPAXTV2' THEN GOTO NotThis;
-IF '&&OUTFMT.EVAL' NE 'EXL2K' THEN GOTO NotThis;
SET COMPOUND=BYTOC

-SET &&OUT3 = IF '&&OUTTO.EVAL' EQ 'XB' THEN 'ON TABLE PCHOLD FORMAT EXL2K BYTOC' ELSE
-                                            'ON TABLE SAVE AS SAVREP FORMAT EXL2K BYTOC';
                    
-NotThis;

-INCLUDE FDEFRPTS
-RUN




-SET &&RANK_METH = TOT_SPD;
-SET &&RANK_LIMIT = 9999;

MATCH FILE TPAIRPX
PRINT DISSAVINGS
    DISSAVX 
    FARE_PAID
    KILO 
    LEVEL2
    LEVEL3
    NAMEC
    NET_TKT_CNT
    NEW_SEG_MILES
    PAID_FAREX 
BY &&SORT1
BY &&SORT2
BY LEVEL1
BY XPSNGR_NM   
ON TABLE HOLD
RUN
FILE HOLDHPX
PRINT NAMEC 
  NBR_DAY
  NBR_ROOMS
  NNROOMS
  NEW_TOTAL_AMT
  AMT_TOTALX 
BY &&SORT1
BY &&SORT2
BY LEVEL1
BY XPSNGR_NM   
AFTER MATCH HOLD AS XONE OLD-OR-NEW
END
-RUN

MATCH FILE XONE
PRINT DISSAVINGS
    DISSAVX
    FARE_PAID
    KILO
    LEVEL2
    LEVEL3
    NAMEC
    NET_TKT_CNT
    NEW_SEG_MILES
    NBR_DAY
    NBR_ROOMS
    NNROOMS
    NEW_TOTAL_AMT
    PAID_FAREX
    AMT_TOTALX
BY &&SORT1
BY &&SORT2
BY LEVEL1
BY XPSNGR_NM   
ON TABLE HOLD
RUN
FILE HOLDCPX
PRINT NAMEC
    NBR_DAYS
    NUM_CARS
    RENTAL_DAYS
    NEW_RENTAL_AMT
    AMT_RENTALX 
BY &&SORT1
BY &&SORT2
BY LEVEL1
BY XPSNGR_NM   
AFTER MATCH HOLD AS XTWO OLD-OR-NEW
END
-RUN


DEFINE FILE XTWO
TOT_SPD/D12.2CS = FARE_PAID + NEW_TOTAL_AMT + NEW_RENTAL_AMT;
END
TABLE FILE XTWO
PRINT AMT_RENTALX 
    AMT_TOTALX
    DISSAVINGS
    DISSAVX 
    FARE_PAID
    KILO
    LEVEL2
    LEVEL3
    NAMEC
    NET_TKT_CNT
    NEW_RENTAL_AMT 
    NEW_SEG_MILES
    NNROOMS
    NUM_CARS
    RENTAL_DAYS
    NEW_TOTAL_AMT
    PAID_FAREX
    
RANKED BY &&RANK_ORDER &&RANK_METH 
BY &&SORT1
BY &&SORT2
BY LEVEL1
BY XPSNGR_NM
ON TABLE HOLD AS RNKHLD
END
-RUN 

DEFINE FILE RNKHLD
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  LIST/D9 = (LAST LIST + 1);
  CRANKX/A11 = FTOA(LIST, '(D9)', 'A11');
  CRANK/A9 = EDIT(CRANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE 
                  IF LIST GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                  CRANK;
  RANK_VAL/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE
                IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE
                ARANK;
  RANK_LAB1/A60 = IF RANK_VAL NE 'ALL OTHER' THEN &&RANK_LABEL1
                  ELSE 'ALL OTHER';
  RANK_LABEL1/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2
                      ELSE ' ';
  RANK_LABEL3/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3
                      ELSE ' ';
  BLANK/A5 = '     ';
  NOWTOD/A8 WITH RANK = HHMMSS (NOWTOD);
  LVL1/A15 = IF RANK_VALUE NE 'ALL OTHER' THEN LEVEL1 ELSE ' ';
  LVL2/A15 = IF RANK_VALUE NE 'ALL OTHER' THEN LEVEL2 ELSE ' ';
  XPSNGR_NM2/A12        = 
  EDIT(XPSNGR_NM,'999999999999');
 
END

TABLE FILE RNKHLD
SUM AMT_RENTALX/D16.2CS 
   AMT_TOTALX/D16.2CS
   FARE_PAID
   KILO/D12
   LEVEL1
   LEVEL2
   LEVEL3
   NAMEC
   NET_TKT_CNT
   NEW_SEG_MILES
   NNROOMS
   NEW_TOTAL_AMT
   PAID_FAREX/D16.2CS
   RENTAL_DAY
   NEW_RENTAL_AMT
   CRANK
   ARANK
   RANK_LABEL1
   RANK_LABEL2
   RANK_LABEL3
BY RANK_VALUE
BY &&SORT1
BY &&SORT2
BY LEVEL1
BY XPSNGR_NM
ON TABLE HOLD AS DEBTEST FORMAT ALPHA
END
-RUN
-GOTO Finrpt


-DEBSUM

MATCH FILE TPAIR
PRINT  
    FARE_PAID
BY &&SORT1
BY TRAN_MONTH
ON TABLE HOLD 
RUN
FILE TPHTL
SUM NEW_TOTAL_AMT  
BY &&SORT1
BY TRAN_MONTH
AFTER MATCH HOLD AS TPAIRH OLD-OR-NEW
END
-RUN

MATCH FILE TPAIRH
PRINT   FARE_PAID
      NEW_TOTAL_AMT
BY &&SORT1
BY TRAN_MONTH
ON TABLE HOLD
RUN
FILE TPCAR
SUM  NEW_RENTAL_AMT
BY &&SORT1
BY TRAN_MONTH
AFTER MATCH HOLD AS RNKHLD OLD-OR-NEW
END
-RUN

-GOTO SUMRPT;


 
-Finrpt
-IF &&CURRENCY EQ 'USD' THEN GOTO NEXT;

-SET &&SUBHEAD = <NAMEC;
-SET &GAIR_CUR = 'AIR,COST, (' | &&CURRENCY || ')';
-SET &GAVG_CUR = 'AIR,AVG,COST, (' | &&CURRENCY || ')';
-SET &GDIS_CUR= 'AIR,LOST,SVGS, (' | &&CURRENCY || ')';
-SET &GHTL_CUR= 'HTL,COST, (' | &&CURRENCY || ')';
-SET &GCAR_CUR= 'CAR,COST, (' | &&CURRENCY || ')';
-SET &GHAV_CUR= 'HTL,AVG, (' | &&CURRENCY || ')';
-SET &GCAV_CUR= 'CAR,AVG, (' | &&CURRENCY || ')';
-SET &&S_SUBJ1='SUM NET_TKT_CNT AS ''# AIR,TICKETS'' PAID_FAREX/D16.2CS ';
-SET &&S_SUBJ2='AS ' | '''&GAIR_CUR.EVAL'' COMPUTE AVGA/D16.2CS = IF ';
-SET &&S_SUBJ3='((NET_TKT_CNT LT 1) AND (NET_TKT_CNT GT (-1))) THEN 0 ELSE';
-SET &&S_SUBJ4='(PAID_FAREX/NET_TKT_CNT); AS ' | '''&GAVG_CUR.EVAL''';
-SET &&S_SUBJ5='KILO AS ''AIR,KLMTRS'' DISSAVX/D16.2CS  ';
-SET &&S_SUBJ6='AS ' | '''&GDIS_CUR.EVAL'' BLANK AS '' ''';
-SET &&S_SUBJ7='NNROOMS AS ''HTL,NIGHTS'' AMT_TOTALX/D16.2CS  ';
-SET &&S_SUBJ8='AS ' | '''&GHTL_CUR.EVAL'' COMPUTE AVGH/D16.2CS = IF';
-SET &&S_SUBJ9='((NNROOMS LT 1) AND (NNROOMS GT (-1))) THEN 0 ELSE ';
-SET &&S_SUBJ10='(AMT_TOTALX/NNROOMS); AS ' | '''&GHAV_CUR.EVAL'' ';
-SET &&S_SUBJ13='AMT_RENTALX/D16.2CS AS ' | '''&GCAR_CUR.EVAL'' ';
-SET &&S_SUBJ14='COMPUTE AVGC/D16.2CS = IF ((RENTAL_DAYS LT 1)';
-SET &&S_SUBJ15='AND (RENTAL_DAYS GT (-1))) THEN 0 ELSE ';
-SET &&S_SUBJ16='(AMT_RENTALX/RENTAL_DAYS); AS ' | '''&GCAV_CUR.EVAL'' ';

-NEXT;


 
TABLE FILE RNKHLD
-INCLUDE HEADER 
"&&SUBHEAD"
"</2"

    &&S_SUBJ1
    &&S_SUBJ2
    &&S_SUBJ3
    &&S_SUBJ4
    &&S_SUBJ5
    &&S_SUBJ6
    &&S_SUBJ7
    &&S_SUBJ8
    &&S_SUBJ9
    &&S_SUBJ10
    &&S_SUBJ11
    &&S_SUBJ12
    &&S_SUBJ13
    &&S_SUBJ14
    &&S_SUBJ15
    &&S_SUBJ16
    &&S_SUBJ17
    &&S_SUBJ18
    &&S_SUBJ19
    &&S_SUBJ20
    
-*BY
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
-*ON
   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10


FOOTING BOTTOM
-INCLUDE FOOTERSM

ON TABLE SET PAGE-NUM OFF
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT

ON TABLE SET STYLE *

UNITS=IN, PAGESIZE='Letter', LEFTMARGIN=0.250000, RIGHTMARGIN=0.250000, 
    TOPMARGIN=0.500000, BOTTOMMARGIN=0.250000, SQUEEZE=ON, 
    ORIENTATION=LANDSCAPE, $
TYPE=REPORT, FONT=TIMES NEW ROMAN, SIZE=7, BACKCOLOR=NONE, STYLE=NORMAL, $
-* TYPE=REPORT, WRAP=1,$
TYPE=REPORT, COLUMN=N6, WRAP= .75,$
TYPE=REPORT, COLUMN=N7, WRAP= 1.0,$
TYPE=REPORT, COLUMN=N8, WRAP= 1.0,$
TYPE=REPORT, COLUMN=N9, WRAP= .75,$
TYPE=REPORT, COLUMN=N10, WRAP=1.0,$
TYPE=REPORT, COLUMN=N11, WRAP= 1.5,$
TYPE=REPORT, COLUMN=N12, WRAP= .75,$
TYPE=REPORT, COLUMN=N13, WRAP= .75,$
TYPE=REPORT, COLUMN=N14, WRAP= .75,$
TYPE=REPORT, COLUMN=N15, WRAP= .75,$
TYPE=REPORT, COLUMN=N16, WRAP= .75,$
TYPE=REPORT, COLUMN=N17, WRAP= .75,$
TYPE=REPORT, COLUMN=N18, WRAP= .75,$
TYPE=REPORT, COLUMN=N19, WRAP= .75,$
TYPE=REPORT, COLUMN=N20, WRAP= .75,$
TYPE=REPORT, COLUMN=N21, WRAP= .75,$
TYPE=REPORT, COLUMN=N22, WRAP= .75,$


TYPE=HEADING, LINE=4, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=5, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=6, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=7, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=8, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=10, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=11, SIZE=12, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=HEADING, LINE=12, SIZE=12, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=HEADING, LINE=13, SIZE=10, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $

TYPE=FOOTING, SIZE=7, STYLE=BOLD, COLOR=GREY, $
TYPE=TITLE, STYLE=BOLD, $
TYPE=SUBTOTAL, SIZE=8, STYLE=BOLD,$
-*TYPE=SUBTOTAL, SIZE=8, STYLE=BOLD, N=10, BACKCOLOR=RGB(128 255 255),$
TYPE=GRANDTOTAL, SIZE=8, STYLE=BOLD,$
TYPE=REPORT, IMAGE=&&TNTPIC,  POSITION=(&&TNTDTPOS), SIZE=(&&TNTDTSIZ), $
TYPE=REPORT, IMAGE=&&ROLLPIC, POSITION=(&&ROLDTPOS), SIZE=(&&ROLDTSIZ), $

ENDSTYLE

-IF '&&SETF.EVAL' EQ 'ITPAXTV2' THEN GOTO Step2;
-IF '&&OUTFMT.EVAL' NE 'EXL2K' THEN GOTO Step2;


&&OUT3


-GOTO Finish

-Step2
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2

-Finish
 

-*
END
-RUN

-GOTO XXITALL

-SUMRPT
DEFINE FILE RNKHLD
  NOWTOD/A8 WITH TRAN_MONTH = HHMMSS (NOWTOD);
  BLANK/A5 = '    ';
END
TABLE FILE RNKHLD
-INCLUDE HEADER 
"&&SUBHEAD"
-*"</2"

SUM FARE_PAID AS 'Airline Spend'
    NEW_TOTAL_AMT AS 'Hotel Spend'
    NEW_RENTAL_AMT AS 'Car Spend'
    BLANK AS ' '
BY &&SORT1 AS 'Business Unit'
ACROSS TRAN_MONTH AS ' '

ON TABLE COLUMN-TOTAL

FOOTING BOTTOM
-INCLUDE FOOTERSM

ON TABLE SET PAGE-NUM OFF
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT

ON TABLE SET STYLE *
UNITS=IN, PAGESIZE='Letter', LEFTMARGIN=0.250000, RIGHTMARGIN=0.250000, 
    TOPMARGIN=0.500000, BOTTOMMARGIN=0.250000, SQUEEZE=ON, 
    ORIENTATION=LANDSCAPE, $
TYPE=REPORT, FONT=TIMES NEW ROMAN, SIZE=8, BACKCOLOR=NONE, STYLE=NORMAL, $
TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(255 248 155),$
TYPE=DATA, COLUMN=N3, BACKCOLOR=RGB(164 238 244),$
TYPE=DATA, COLUMN=N4, BACKCOLOR=RGB(255 181 145),$



TYPE=HEADING, LINE=4, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=5, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=6, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=7, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=8, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=10, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=11, SIZE=12, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=HEADING, LINE=12, SIZE=12, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=HEADING, LINE=13, SIZE=10, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=HEADING, LINE=17, SIZE=10, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $

TYPE=FOOTING, SIZE=7, STYLE=BOLD, COLOR=GREY, $
TYPE=TITLE, STYLE=BOLD, $

TYPE=TITLE, STYLE=BOLD, COLUMN=N2, BACKCOLOR=RGB(255 248 155),$
TYPE=TITLE, STYLE=BOLD, COLUMN=N3, BACKCOLOR=RGB(164 238 244),$

TYPE=TITLE, STYLE=BOLD, COLUMN=N4, BACKCOLOR=RGB(255 181 145),$

TYPE=SUBTOTAL, SIZE=8, STYLE=BOLD,$
-*TYPE=SUBTOTAL, SIZE=8, STYLE=BOLD, N=10, BACKCOLOR=RGB(128 255 255),$
TYPE=GRANDTOTAL, SIZE=8, STYLE=BOLD,$
ENDSTYLE
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2

END
-RUN


-XXITALL

 
