-INCLUDE SETECHO
SET ASNAMES = ON;



-GOTO DEB;

-SET &&FROMDT = '2014/12/01';
-SET &&TODT = '2014/12/31';
-SET &&ROLLUP = 'ALL-R';

-SET &WHATDTRNG = 'WHERE (EXPIREDATE GE ''&&FROMDT.EVAL'') AND (EXPIREDATE LE ''&&TODT.EVAL'') AND STATUS_CODE EQ ''X''';

 DEFINE FILE AMN_ITEM
 CLIENT/A8 = '&&ROLLUP.EVAL';
 ISSUEDATE/YYMD = HDATE(DATE_ISSUED, 'YYMD');
 EXPIREDATE/YYMD = HDATE(DATE_EXPIRES, 'YYMD');
-* EXPIREDATE/YYMD = HDATE(STATUS_DATE, 'YYMD');
 APPLYDATE/YYMD = HDATE(DATE_SELECTED, 'YYMD');
 DEPART_DT/YYMD = HDATE(DEPART_DATE, 'YYMD');
 PASSNGR_NM/A33 = EDIT(PAX, '999999999999999999999999999999999');
 TRN_DATE/YYMD = ISSUEDATE;
 FST_DPT_DATE/YYMD = DEPART_DT;
 
-*Selections passed from GUI
 BR_CL_IDX/A8 = CLIENT_BRANCH | CLIENT_CODE;
 PASSNGR_NAME/A33 = EDIT(PAX, '999999999999999999999999999999999');
 TKT_NUM/A10 = TICKET_NUM;
 VAL_AIRLINE/A3 = AIRLINE_CODE;
 AUX_PNR/A14 = AIRLINE_PNR;
 AUX_TKT/A10 = IF EDIT(TKT_NUM, '9') EQ '2' THEN TKT_NUM ELSE ' ';
 CUSED_TOT/D12.2 = IF STATUS_CODE EQ 'S' OR 'U' THEN TICKET_VALUE ELSE 0;
-*  CUSED_TOT/D12.2 = IF STATUS_CODE EQ 'S' OR 'U' AND ASSOC_AMN_ID EQ 0 THEN TICKET_VALUE ELSE
-*                    IF STATUS_CODE EQ 'S' OR 'U' AND ASSOC_AMN_ID GT 0 THEN NEW_TICKET_VALUE ELSE 0;
 XUNUSED_TOT/D12.2 = IF STATUS_CODE EQ 'X' THEN TICKET_VALUE ELSE 0;
END
TABLE FILE AMN_ITEM
PRINT ROLLUP PASSNGR_NAME TYPE_CODE STATUS_CODE APPLYDATE
      AIRLINE_CODE TICKET_VALUE DEPART_DT
      EXPIREDATE NEW_TICKET_NUM NEW_TICKET_VALUE ISSUEDATE CLIENT AUX_TKT  AUX_PNR
      NEW_LEVEL1 NEW_LEVEL2 NEW_LEVEL3 CUSED_TOT XUNUSED_TOT ASSOC_AMN_ID
BY CLIENT
BY STATUS_CODE
BY TKT_NUM
-IF '&&ROLLUP.EVAL' EQ 'OTHER-R' THEN GOTO ChkClinetNUM;
WHERE ROLLUP EQ '&&ROLLUP.EVAL'
-ChkClinetNUM
 
&WHATDTRNG
ON TABLE COLUMN-TOTAL 
WHERE TYPE_CODE NE 'R'
END
-RUN
-QUIT

-INCLUDE DVRUTPARMS
ON TABLE HOLD AS AMNHLD
END
-RUN

-DEB

-SET &&FROMDT = '2014/12/01';
-SET &&TODT = '2014/12/31';
-SET &&ROLLUP = 'ALL-R';


-SET &FMM=EDIT(&&FROMDT,'$$$$$99');
-SET &FMD=EDIT(&&FROMDT,'$$$$$$$$99');
-SET &FMY=EDIT(&&FROMDT,'$$99');
-SET &TOM=EDIT(&&TODT,'$$$$$99');
-SET &TOD=EDIT(&&TODT,'$$$$$$$$99');
-SET &TOY=EDIT(&&TODT,'$$99'); 


-SET &FROMDATE = &FMM || '/' || &FMD || '/' || &FMY;
-SET &TODATE = &TOM || '/' || &TOD || '/' || &TOY;
-TYPE '&FROMDATE.EVAL'
-TYPE '&TODATE.EVAL'


ENGINE SQLMSS SET DEFAULT_CONNECTION AMNData
SQL SQLMSS EX USP_REVIEW_ETTEK_BANX  '&FROMDATE.EVAL', '&TODATE.EVAL', '&&ROLLUP.EVAL';
TABLE FILE SQLOUT
PRINT *
-*ON TABLE HOLD AS AMNHLD2 FORMAT FOCUS
END
-RUN
-QUIT


 



DEFINE FILE AMNHLD2
CLIENT/A8 = EDIT(rollup, '99999999');
TYPE_CODE/A1 = type_code;
STATUS_CODE/A1 = status_code;
PASSNGR_NAME/A33 = EDIT(pax, '999999999999999999999999999999999');
APPLYDATE/YYMD = HDATE(date_selected, 'YYMD');
AIRLINE_CODE/A2 = airline_code;
TICKET_VALUE/D12.2 = ticket_value;
DEPART_DT/YYMD = HDATE(depart_date, 'YYMD');
EXPIREDATE/YYMD = HDATE(date_expires, 'YYMD');
NEW_TICKET_NUM/A10 = new_ticket_num;
NEW_TICKET_VALUE/D12.2 = new_ticket_value;
ISSUEDATE/YYMD = HDATE(date_issued, 'YYMD');
ROLLUP/A8 = CLIENT;
BR_CL_IDX/A8 = client_branch | client_code;
TKT_NUM/A10 = ticket_num;
 AUX_TKT/A10 = IF EDIT(TKT_NUM, '9') EQ '2' THEN TKT_NUM ELSE ' ';
 AUX_PNR/A14 = airline_pnr;
 CUSED_TOT/D12.2 = IF STATUS_CODE EQ 'S' OR 'U' AND APPLYDATE GE '&&FROMDT.EVAL' AND APPLYDATE LE '&&TODT.EVAL' THEN TICKET_VALUE ELSE 0;
 XUNUSED_TOT/D12.2 = IF STATUS_CODE EQ 'X' AND EXPIREDATE GE '&&FROMDT.EVAL' AND EXPIREDATE LE '&&TODT.EVAL' THEN TICKET_VALUE ELSE 0;
NEW_LEVEL1/A15 = EDIT(new_level1, '999999999999999');
NEW_LEVEL2/A15 = EDIT(new_level2, '999999999999999');
NEW_LEVEL3/A15 = EDIT(new_level3, '999999999999999');
ASSOC_AMN_ID/I2 = assoc_amn_id;

END
TABLE FILE AMNHLD2
PRINT ROLLUP PASSNGR_NAME TYPE_CODE STATUS_CODE APPLYDATE
      AIRLINE_CODE TICKET_VALUE DEPART_DT
      EXPIREDATE NEW_TICKET_NUM NEW_TICKET_VALUE ISSUEDATE CLIENT AUX_TKT AUX_PNR
      NEW_LEVEL1 NEW_LEVEL2 NEW_LEVEL3 CUSED_TOT XUNUSED_TOT ASSOC_AMN_ID
BY CLIENT
BY STATUS_CODE
BY TKT_NUM
 
WHERE XUNUSED_TOT NE 0
ON TABLE COLUMN-TOTAL
END
-RUN
-QUIT

ON TABLE HOLD AS AMNHLD
END      
-RUN


TABLE FILE AMNHLD
SUM XUNUSED_TOT
BY CLIENT
BY PASSNGR_NAME
BY TKT_NUM
END
-RUN
-QUIT
