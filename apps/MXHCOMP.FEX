-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-*  02/02/2015  REJ  S-05681 Changes to the no data report to prepare for the Available
-*                           Report changes.  Rollup Code is being removed from BRPTINST in
-*                           ER5, so I'm removing the reference to the ROLLUP_CODE in that report.

-INCLUDE SETECHO

-SET &&DRILLABLE = IF &&DEPLOY EQ 'L' AND EDIT(&&OUTTO,'$9') NE 'B' 
- THEN 'N' ELSE 'Y'; 

CREATE FILE METHFIL
-RUN

SET ASNAMES=ON
EX SETDBLS SETFILE=&&SETF
-RUN
-INCLUDE OTHPARMS

-INCLUDE SetParmtime
-RUN

-IF &&DEPLOY EQ 'W' GOTO SETWEB;
-**********************************************************************
-* DETERMINE IF WE HAVE WEB DEPLOYMENT OR LOCAL STAND ALONE
-* SET PATH FOR SAVING THE SETFILE
-**********************************************************************
-******LOCAL DEPLOYMENT
-SET &&SETFNM= &&LOCPATH || &&DTTMSTRM ||'.FTM';
COPY &&SETF &&SETFNM
-RUN
-GOTO SETFILDEF;

-******WEB DEPLOYMENT
-SETWEB
-SET &&WEBPATH = '&&WEBSRV.EVAL' || '\TTWEB\ ' || &&ROLLUP || '\ '||&&UNAME.EVAL|| '\';
-SET &&SETFNM = &&WEBPATH || &&DTTMSTRM ||'.FTM';

COPY &&VARFWEB &&SETFNM
-INCLUDE SETFPARM
-RUN
-GOTO SETFILDEF;

-SETFILDEF
-INCLUDE APNDSETF
-RUN

-SET &&RPTSUF = 'TTBKHS';
-INCLUDE FDEFRPTS
-RUN

DEFINE FILE METXHFI
BDY/A4 = EDIT(BDATE, '9999$$$$');
BDM/A2 = EDIT(BDATE, '$$$$99$$');
BDD/A2 = EDIT(BDATE, '$$$$$$99');
BDATE1/A10 = BDY|'/'|BDM|'/'|BDD;
EDY/A4 = EDIT(EDATE, '9999$$$$');
EDM/A2 = EDIT(EDATE, '$$$$99$$');
EDD/A2 = EDIT(EDATE, '$$$$$$99');
EDATE1/A10 = EDY|'/'|EDM|'/'|EDD;
END
-RUN

TABLE FILE METXHFI
PRINT MHPAXNAM AS 'PAX_NAME' MHSTATUS AS 'HBKFLAG' MHHTLTOT AS 'HTL_AMT' BDATE1 EDATE1
BY MHEMPID AS 'EMP_NO' 
WHERE (BDATE1 EQ &&FROMDT.EVAL) AND (EDATE1 EQ &&TODT.EVAL)
ON TABLE HOLD AS HHOLD1
END
-RUN

-IF &RECORDS EQ 0 THEN GOTO NORECS;

TABLE FILE HHOLD1
SUM BDATE1 EDATE1
ON TABLE SAVE
END
-RUN

-READ SAVE NOCLOSE &BDATE1.10. &EDATE1.10.
-CLOSE SAVE
-RUN

-*******************************************************
-* Incomplete Occurrences Extract and Modify to METHFIL
-*******************************************************
DEFINE FILE HHOLD1
FLAG/A1 = 'A';
HTL_AMT1/A5= EDIT(HTL_AMT, '99999$$');
HTL_AMT2/A2 = EDIT(HTL_AMT, '$$$$$99');
HTL_AMT3/A8 = HTL_AMT1||'.'|HTL_AMT2;
HTL_AMT4/D12.2CSM = EDIT(HTL_AMT3);
END
-RUN

TABLE FILE HHOLD1
SUM CNT.PAX_NAME AS 'PAXCNT' HTL_AMT4 
BY FLAG
BY HBKFLAG
BY PAX_NAME
WHERE HBKFLAG EQ 'I'
ON TABLE HOLD AS HHOLD2I
END
-RUN


DEFINE FILE HHOLD1
FLAG /A1 = 'A';
END
-RUN

TABLE FILE HHOLD1
SUM CNT.PAX_NAME AS 'TPAXCNT' 
BY FLAG
ON TABLE HOLD AS HHOLDIT
END
-RUN

MATCH FILE HHOLD2I
SUM PAXCNT HBKFLAG HTL_AMT4 
BY FLAG
ON TABLE HOLD
RUN
FILE HHOLDIT
SUM TPAXCNT
BY FLAG
AFTER MATCH HOLD AS HHOLDIT1 OLD-OR-NEW
END
-RUN

TABLE FILE HHOLDIT1
PRINT PAXCNT TPAXCNT HTL_AMT4 AS 'HTL_AMT'
BY HBKFLAG
ON TABLE HOLD AS INCHLD1
END
-RUN

TABLE FILE INCHLD1
PRINT HBKFLAG/A1 PAXCNT/P8 TPAXCNT/P8 HTL_AMT/D12.2
ON TABLE HOLD AS INCHLD
END
-RUN

MODIFY FILE METHFIL
FIXFORM FROM INCHLD
MATCH HBKFLAG
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON INCHLD
END
-RUN


-*********************************************************
-* Non T and T Occurrences Extract and modify to METHFIL
-*********************************************************

DEFINE FILE HHOLD1
FLAG/A1 = 'A';
HTL_AMT1/A5= EDIT(HTL_AMT, '99999$$');
HTL_AMT2/A2 = EDIT(HTL_AMT, '$$$$$99');
HTL_AMT3/A8 = HTL_AMT1||'.'|HTL_AMT2;
HTL_AMT4/D12.2CSM = EDIT(HTL_AMT3);
END
-RUN
TABLE FILE HHOLD1
SUM CNT.PAX_NAME AS 'PAXCNT' HTL_AMT4 
BY FLAG
BY HBKFLAG
BY PAX_NAME
WHERE HBKFLAG EQ 'N'
ON TABLE HOLD AS HHOLD2N
END
-RUN


DEFINE FILE HHOLD1
FLAG /A1 = 'A';
END
-RUN

TABLE FILE HHOLD1
SUM CNT.PAX_NAME AS 'TPAXCNT' 
BY FLAG
ON TABLE HOLD AS HHOLDIT
END
-RUN

MATCH FILE HHOLD2N
SUM PAXCNT HBKFLAG HTL_AMT4 
BY FLAG
ON TABLE HOLD
RUN
FILE HHOLDIT
SUM TPAXCNT
BY FLAG
AFTER MATCH HOLD AS HHOLDIT1 OLD-OR-NEW
END
-RUN

TABLE FILE HHOLDIT1
PRINT PAXCNT TPAXCNT HTL_AMT4 AS 'HTL_AMT'
BY HBKFLAG
ON TABLE HOLD AS NNCHLD1
END
-RUN

TABLE FILE NNCHLD1
PRINT HBKFLAG/A1 PAXCNT/P8 TPAXCNT/P8 HTL_AMT/D12.2
ON TABLE HOLD AS NNCHLD
END
-RUN

MODIFY FILE METHFIL
FIXFORM FROM NNCHLD
MATCH HBKFLAG
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON NNCHLD
END
-RUN


-*****************************************************
-* T and T Occurrences Extract and modify to METXHFIL
-*****************************************************
DEFINE FILE HHOLD1
FLAG/A1 = 'A';
HTL_AMT1/A5= EDIT(HTL_AMT, '99999$$');
HTL_AMT2/A2 = EDIT(HTL_AMT, '$$$$$99');
HTL_AMT3/A8 = HTL_AMT1||'.'|HTL_AMT2;
HTL_AMT4/D12.2CSM = EDIT(HTL_AMT3);
END
-RUN
TABLE FILE HHOLD1
SUM CNT.PAX_NAME AS 'PAXCNT' HTL_AMT4 
BY FLAG
BY HBKFLAG
BY PAX_NAME
WHERE HBKFLAG EQ 'Y'
ON TABLE HOLD AS HHOLD2Y
END
-RUN


DEFINE FILE HHOLD1
FLAG /A1 = 'A';
END
-RUN

TABLE FILE HHOLD1
SUM CNT.PAX_NAME AS 'TPAXCNT' 
BY FLAG
ON TABLE HOLD AS HHOLDIT
END
-RUN

MATCH FILE HHOLD2Y
SUM PAXCNT HBKFLAG HTL_AMT4 
BY FLAG
ON TABLE HOLD
RUN
FILE HHOLDIT
SUM TPAXCNT
BY FLAG
AFTER MATCH HOLD AS HHOLDIT1 OLD-OR-NEW
END
-RUN

TABLE FILE HHOLDIT1
PRINT PAXCNT TPAXCNT HTL_AMT4 AS 'HTL_AMT'
BY HBKFLAG
ON TABLE HOLD AS YNCHLD1
END
-RUN

TABLE FILE YNCHLD1
PRINT HBKFLAG/A1 PAXCNT/P8 TPAXCNT/P8 HTL_AMT/D12.2
ON TABLE HOLD AS YNCHLD
END
-RUN

MODIFY FILE METHFIL
FIXFORM FROM YNCHLD
MATCH HBKFLAG
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON YNCHLD
END
-RUN

DEFINE FILE METHFIL
TTBOOK/A50 = IF HBKFLAG EQ 'Y' THEN 'Travel and Transport Booked Occurrences' ELSE
             IF HBKFLAG EQ 'N' THEN 'Non Travel and Transport Booked Occurrences' ELSE
             'Incomplete Occurrences';
NOWTOD/A8 WITH HBKFLAG = HHMMSS (NOWTOD);
END
-RUN

TABLE FILE METHFIL
SUM PAXCNT AS 'Bookings' 
COMPUTE PCTBOOK/P8.1 = IF TPAXCNT EQ 0 THEN 0 ELSE (PAXCNT/TPAXCNT)*100; AS '% of Bookings'
HTL_AMT/D12.2CSM AS 'Total,Hotel,Amount'
BY HBKFLAG NOPRINT
BY TTBOOK AS ' '
&&OUTLINE1
&&OUTLINE2
ON TTBOOK SKIP-LINE
ON TABLE COLUMN-TOTAL
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
HEADING
-SET &FMM=EDIT(&&FROMDT,'$$$$$$99');
-SET &FMD=EDIT(&&FROMDT,'$$$$$$$$$99');
-SET &FMY=EDIT(&&FROMDT,'$9999');
-SET &TOM=EDIT(&&TODT,'$$$$$$99');
-SET &TOD=EDIT(&&TODT,'$$$$$$$$$99');
-SET &TOY=EDIT(&&TODT,'$9999');
" "
" "
" "
"                                <67 &&ROLLNME"
"BEGIN/END PERIOD:               <67 &&AgencyName"
"&FMM/&FMD/&FMY - &TOM/&TOD/&TOY <67 &&ROLLCS"
"                                <67 &&ROLLCNCT"
"                                <67 &&ROLLPHN"


" "                           
"                                <67 PAGE: <TABPAGENO"
"<12 &&RPT_TTL1"
"<12 &&RPT_TTL2"
"</2"
FOOTING BOTTOM
"MXHCOMP <65 &&FOOTR"
"A REPORT FROM eTTek Review RUN ON &DATE AT <NOWTOD
ON TABLE SET STYLE *
TYPE=DATA, COLUMN=N2, \
URL=&&SRVR.EVAL/ibi_apps/WFServlet? \
(IBIF_ex='MXHCOMPD' HBK=N1 BDATE1='&BDATE1.EVAL' EDATE1='&EDATE1.EVAL'\
 SETFNM='&&DTTMSTRM.EVAL' \
 FPARM='&&DTTMID.EVAL' \
ROLUP='&&ROLLUP' user='&&UNAME'), $

UNITS=IN, PAGESIZE='Letter', LEFTMARGIN=0.500000, RIGHTMARGIN=0.250000, 
    TOPMARGIN=0.500000, BOTTOMMARGIN=0.250000, SQUEEZE=ON, 
    ORIENTATION=LANDSCAPE, $
TYPE=REPORT, FONT=TIMES NEW ROMAN, SIZE=9, BACKCOLOR=NONE, STYLE=NORMAL, $
TYPE=HEADING, OBJECT=TEXT, SIZE=8, COLOR=BLACK, $
TYPE=HEADING, LINE=4, SIZE=10, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=5, SIZE=10, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=6, SIZE=10, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=7, SIZE=10, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=8, SIZE=10, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=10, SIZE=10, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=11, SIZE=12, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=HEADING, LINE=12, SIZE=12, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=FOOTING, SIZE=8, STYLE=BOLD, COLOR=GREY, $
TYPE=TITLE, STYLE=BOLD, $
TYPE=SUBFOOT, SIZE=10, STYLE=BOLD, $
TYPE=SUBTOTAL, SIZE=10, STYLE=BOLD, $
TYPE=REPORT, IMAGE=&&TNTPIC,  POSITION=(&&TNTSMPOS), SIZE=(&&TNTSMSIZ), $
TYPE=REPORT, IMAGE=&&ROLLPIC, POSITION=(&&ROLSMPOS), SIZE=(&&ROLSMSIZ), $
ENDSTYLE
END
-RUN
-GOTO XXIT




-NORECS;
-* REJ ADDED TO TRAP ERRORS
-SET &&FEXNOW=&&EXPARM;
-INCLUDE ERRORCHK
-IF &&RET GT 1 GOTO XXIT;
-* REJ ADDED TO TRAP ERRORS

-SET &&RPTSUF = 'MSG';
-INCLUDE FDEFRPTS
-RUN
JOIN SET_KEY IN BRPTINST TO SET_KEY IN BRPT_SET AS J1
DEFINE FILE BRPTINST
EMPTY/A35 = 'NO RECORDS FOUND FOR THIS SELECTION';
NOWTOD/A8 WITH INST_KEY = HHMMSS (NOWTOD);
END
TABLE FILE BRPTINST
-INCLUDE HEADAIR
PRINT EMPTY AS 'REPORT,MESSAGE' 
BY ROLLUP_CODE AS 'ROLLUP,CODE'
BY RPT_NAME AS 'REPORT,NAME'
BY SELECT_LEV AS 'BREAK,LEVEL'
IF INST_KEY EQ &&IKEY
IF RECORDLIMIT EQ 1
-INCLUDE FOOTERDT
ON TABLE SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET PAGE-NUM OFF
ON TABLE SET STYLE *
-INCLUDE &&DTSTY
ENDSTYLE
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN
-GOTO XXIT

-XXIT
