-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* DEB 7/10/07 - CREATED FOR UP POTENTIAL SVGS REPORT FOR JIM BELL
-* ADDED TRANTYPE INCLUDE - JK 12/30/14 STORY ID S-06492
-*7/11/16 S-20630 DLV  Commented out EMP_ID define
-*4/26/2017-JEM-S-33318-updated logic for no records report


SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';


DEFINE FILE &&EXTRACT 
-*  EMP_ID/A9 = EDIT(LEVEL2,'999999999');
  LEVEL_DESC/A60 = &&LDESC;
  FARE_PAID/D12.2CS = SEG_AMT + SEG_TAX;
  FLAG/A1 = 'A';
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  TKT_AMOUNT/D12.2CS = TICKET_AMT + TAX_AMT;
  XPSNGR_NM/A15        = 
   EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
-* DEFINES ON PREVIOUS DEFINES

UPADV/A1 = IF (ADV_PURCH LT 14) THEN 'Y' ELSE 'N';
UPADV1/A1 = IF (ADV_PURCH GE 14) THEN 'Y' ELSE 'N';
UPADV_TKT/D8CS = IF (UPADV EQ 'Y') THEN NET_TKT_CNT ELSE 0;
UPADV_TKT1/D8CS = IF (UPADV1 EQ 'Y') THEN NET_TKT_CNT ELSE 0;
UPADV_FARE/D12.2CS = IF UPADV EQ 'Y' OR ' ' THEN FARE_PAID ELSE 0;
UPADV_FARE1/D12.2CS = IF UPADV1 EQ 'Y' THEN FARE_PAID ELSE 0;
UPRFNON/A1 = IF NONREF_FLAG EQ 'R' OR ' ' THEN 'Y' ELSE 'N';
UPREF_TKT/D8CS = IF (UPRFNON EQ 'Y') THEN NET_TKT_CNT ELSE 0;
UPNREF_TKT/D8CS = IF (UPRFNON EQ 'N') THEN NET_TKT_CNT ELSE 0;
REF_FARE/D12.2CS = IF NONREF_FLAG EQ 'R' OR ' ' THEN FARE_PAID ELSE 0;
NREF_FARE/D12.2CS = IF NONREF_FLAG EQ 'N' THEN FARE_PAID ELSE 0;
DISSAVINGS/D11.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST;
DECLINE_AMT/D12.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         TKT_AMOUNT - LOWEST_AMT;                         
-* Defines on previous defines                         
LOWTKT/D8CS = IF ((DISSAVINGS LT 1) AND (DISSAVINGS GT (-1))) THEN NET_TKT_CNT
                  ELSE 0;
NONLTKT/D8CS = IF ((DISSAVINGS GT 1) OR (DISSAVINGS LT (-1))) THEN 
                     NET_TKT_CNT ELSE 0;
-INCLUDE TRANTYPE
END
-RUN

TABLEF FILE &&EXTRACT
PRINT AROLL_LEV4
  DISSAVINGS
  FARE_PAID
  FLAG
  LEVEL_DESC
  EMP_ID
  LOWTKT
  NONLTKT
  NET_TKT_CNT
  NREF_FARE
  REF_FARE
  UPADV
  UPADV1
  UPADV_TKT
  UPADV_TKT1
  UPADV_FARE
  UPADV_FARE1
  UPREF_TKT
  UPNREF_TKT
  TKT_DATE
  PASSNGR_NAME
  TKT_NUM
  XPSNGR_NM
WHERE VOID.VOID_DATE EQ 0
-INCLUDE &AIRDATES
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS GRPTHOLD
END
-RUN


TABLE FILE GRPTHOLD
SUM AROLL_LEV4
  DISSAVINGS 
  FARE_PAID 
-*  LEVEL2
  LOWTKT
  NONLTKT
  NET_TKT_CNT 
  NREF_FARE 
  REF_FARE 
  UPADV_TKT 
  UPADV_TKT1
  UPADV_FARE
  UPADV_FARE1
  UPREF_TKT 
  UPNREF_TKT 
  LEVEL_DESC
  PASSNGR_NAME
COMPUTE RATP/P9.2= IF ((UPREF_TKT LT 1) AND
  (UPREF_TKT GT (-1))) THEN 0 ELSE (REF_FARE /UPREF_TKT);
COMPUTE ADVATP/P9.2= IF ((UPADV_TKT LT 1) AND
  (UPADV_TKT GT (-1))) THEN 0 ELSE (UPADV_FARE/UPADV_TKT);  
BY EMP_ID
ON TABLE HOLD AS AIRHOLD1
END
-RUN


TABLE FILE AIRHOLD1
SUM DISSAVINGS AS 'TLSV'
  FARE_PAID AS 'TFARE'
  NET_TKT_CNT AS 'TTKT'
  NREF_FARE AS 'TNFARE'
  REF_FARE AS 'TRFARE'
  UPADV_TKT AS 'TADVTKT'
  UPADV_TKT1 AS 'TADV1TKT'
  UPADV_FARE AS 'TADVFAR'
  UPADV_FARE1 AS 'TADV1FAR'
  UPREF_TKT AS 'TRTKT'
  UPNREF_TKT AS 'TNRTKT' 
BY AROLL_LEV4
ON TABLE HOLD AS AIRHOLD2
END
-RUN


TABLE FILE AIRHOLD2
SUM TLSV
  TFARE
  TTKT
  TNFARE
  TRFARE
  TADVTKT
  TADV1TKT
  TADVFAR
  TADV1FAR
  TRTKT
  TNRTKT
COMPUTE NRATP/P9.2= IF ((TNRTKT LT 1) AND 
  (TNRTKT GT (-1))) THEN 0 ELSE (TNFARE/TNRTKT);
COMPUTE TADVATP/P9.2= IF ((TADV1TKT LT 1) AND
  (TADV1TKT GT (-1))) THEN 0 ELSE (TADV1FAR/TADV1TKT); 
BY AROLL_LEV4  
ON TABLE HOLD AS AIRHOLD3
END
-RUN

MATCH FILE AIRHOLD1
PRINT DISSAVINGS 
  FARE_PAID
  LOWTKT
  NONLTKT
  NET_TKT_CNT 
  NREF_FARE 
  REF_FARE 
  UPADV_TKT 
  UPADV_TKT1 
  UPADV_FARE
  UPADV_FARE1
  UPREF_TKT 
  UPNREF_TKT 
  PASSNGR_NAME
  LEVEL_DESC
  EMP_ID
  RATP
  ADVATP
BY AROLL_LEV4  
ON TABLE HOLD
RUN
FILE AIRHOLD3
SUM  TLSV
  TFARE
  TTKT
  TNFARE
  TRFARE
  TADVTKT
  TADV1TKT
  TADVFAR
  TADV1FAR
  TRTKT
  TNRTKT 
  NRATP
  TADVATP
BY AROLL_LEV4  
AFTER MATCH HOLD AS XONE OLD-AND-NEW
END
-RUN


TABLE FILE XONE
PRINT DISSAVINGS 
  FARE_PAID
  LOWTKT
  NONLTKT
  NET_TKT_CNT 
  NREF_FARE 
  REF_FARE 
  UPADV_TKT 
  UPADV_TKT1
  UPADV_FARE
  UPADV_FARE1
  UPREF_TKT 
  UPNREF_TKT
  RATP
  ADVATP
  TLSV
  TFARE
  TTKT
  TNFARE
  TRFARE
  TADVTKT
  TADV1TKT
  TADVFAR
  TADV1FAR
  TRTKT
  TNRTKT
  NRATP
  TADVATP
  LEVEL_DESC
  PASSNGR_NAME
BY EMP_ID
ON TABLE HOLD AS UPPSA
END
-RUN

-SET &&AIRREC=IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';




