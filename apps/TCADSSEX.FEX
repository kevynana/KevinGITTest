-*7/22/15 - JEK - STORY ID - S-07826 Created for new standard total-r Air Fare Re-Search Report

-INCLUDE SETECHO
SET ASNAMES = ON

-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED
-*========================================================================
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

DEFINE FILE &&EXTRACT
FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;
NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                      IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                      IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;

OTFLAG/A15 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN 'ONLINE' ELSE 'TRADITIONAL';

END

TABLE FILE &&EXTRACT
PRINT 
  FARE_PAID
  NET_TKT_CNT 
  OTFLAG
  REFUSAL_DESC
  SEG_NBR 
  TKT_NUM
  TKT_SORT
BY AIR_KEY  
-INCLUDE &AIRDATES
WHERE VOID_DATE EQ 0
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS TCAD1 
END
-RUN

-IF &LINES EQ 0 THEN GOTO NEXTONE;

DEFINE FILE TCAD1
ROLLCD/A8 = '&&ROLL';
END
TABLE FILE TCAD1
PRINT FARE_PAID/D14.2CS
    NET_TKT_CNT
    OTFLAG
    REFUSAL_DESC
    ROLLCD
    SEG_NBR
BY AIR_KEY
ON TABLE HOLD AS TCAD2 FORMAT FOCUS INDEX AIR_KEY
END

-INCLUDE TCUDAUSE
-RUN

TABLE FILE &&EXTRACT2
SUM NUD_DATA/P12.2CS AS 'DSS'
BY AIR_KEY
WHERE UDID EQ 'DSS'
ON TABLE HOLD AS TCUA1
END


TABLE FILE TCUA1
PRINT DSS
BY AIR_KEY
ON TABLE HOLD AS TCUA2 FORMAT FOCUS INDEX AIR_KEY
END
-RUN

JOIN AIR_KEY IN TCAD2 TO AIR_KEY IN TCUA2 AS JUD1
-RUN

DEFINE FILE TCAD2
AIR_SCSAV/P12.2 = IF SEG_NBR EQ '01' THEN DSS ELSE 0;
AIR_DSS/P12.2CSM = IF NET_TKT_CNT LT 0 THEN 0 ELSE AIR_SCSAV;
ADSS_CNT/P12S = IF AIR_SCSAV NE 0 THEN NET_TKT_CNT ELSE 0;
NTKTS/P12S = NET_TKT_CNT;
END

TABLE FILE TCAD2
PRINT NET_TKT_CNT
      FARE_PAID
      AIR_DSS
      ADSS_CNT
      NTKTS
BY ROLLCD
BY AIR_KEY
BY OTFLAG
BY REFUSAL_DESC
ON TABLE HOLD AS TCAD3
END
-RUN

-* JOIN ROLLCD IN TCAD3 TO ROLLUP IN ROLLUP AS JROLL
-* -RUN

DEFINE FILE TCAD3
 NMB/I5 = NMB + 1;
END

TABLE FILE TCAD3
PRINT FARE_PAID
      NET_TKT_CNT
      AIR_DSS
      ADSS_CNT
      NTKTS
BY ROLLCD
BY NMB
BY OTFLAG
BY REFUSAL_DESC
ON TABLE HOLD AS TCAD3
END

MODIFY FILE TCADSS
FIXFORM FROM TCAD3
MATCH ROLLCD NMB
ON NOMATCH INCLUDE
ON MATCH REJECT
DATA ON TCAD3
END
-RUN

-NEXTONE
