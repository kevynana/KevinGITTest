-*01/09/17-JEM-S-23779-Created for new Bonus Point file ABP2PBS
-*08/09/17-JEM-S-01602-updated -set dates  to correct report from erroring out

-INCLUDE SETECHO
SET ASNAMES=ON


-SET &FMM=EDIT(&&FROMDT,'$$$$$$99');
-SET &FMD=EDIT(&&FROMDT,'$$$$$$$$$99');
-SET &FMY=EDIT(&&FROMDT,'$9999');
-SET &TOM=EDIT(&&TODT,'$$$$$$99');
-SET &TOD=EDIT(&&TODT,'$$$$$$$$$99');
-SET &TOY=EDIT(&&TODT,'$9999');

-SET &&SP = '|';
-SET &&SP3 = IF &&ROLLCNCT EQ ' ' THEN ' ' ELSE &&SP;
-SET &&SP4 = IF &&ROLLPHN EQ ' ' THEN ' ' ELSE &&SP;
-SET &&RCNCT = &&ROLLCNCT.LENGTH;
-SET &&CSL = &&ROLLCS.LENGTH;
-SET &&CSLP = IF &&RCNCT.EVAL GE 10 OR &&CSL.EVAL GE 10 THEN 60 ELSE 68;
-SET &&ROLLCS11 = TRUNCATE(&&ROLLCS);
-SET &&RCNCT1 = TRUNCATE(&&ROLLCNCT);
-SET &&RPTSUF = &TOY.EVAL||&TOM.EVAL||&TOD.EVAL;

DEFINE FILE AIRHLD
FLG/A1 = 'A';
END
TABLE FILE AIRHLD
PRINT ABONUS TRN_DATE CAT_ID VEND_DESC 
BY FLG
BY RES_SYS
BY PNR_LOCATOR
BY TKT_NUM
BY TKT_SORT
ON TABLE HOLD AS AHLD
END
-RUN

DEFINE FILE CARHLD
FLG/A1 = 'C';
END
TABLE FILE CARHLD
PRINT CBONUS CMULTIP INVOICE_DATE AS 'CTRN_DATE' CAT_ID AS 'CCAT_ID' VEND_DESC AS 'CVEND_DESC'
BY FLG
BY RES_SYS
BY PNR_LOCATOR
BY TKT_NUM
ON TABLE HOLD AS CHLD
END

MATCH FILE AHLD
PRINT ABONUS TRN_DATE CAT_ID VEND_DESC 
BY FLG
BY RES_SYS
BY PNR_LOCATOR
BY TKT_NUM
BY TKT_SORT
ON TABLE HOLD
RUN
FILE CHLD
PRINT CBONUS CMULTIP CTRN_DATE CCAT_ID CVEND_DESC
BY FLG
BY RES_SYS
BY PNR_LOCATOR
BY TKT_NUM
AFTER MATCH HOLD AS ACHLD OLD-OR-NEW
END
-RUN

DEFINE FILE ACHLD
TKT1/A10 = IF TKT_NUM EQ 'CAR ONLY' THEN 'CAR ONLY' ELSE TKT_NUM;
TRND1/YYMD = IF TKT1 EQ 'CAR ONLY' THEN CTRN_DATE ELSE
             IF TRN_DATE EQ ' ' THEN CTRN_DATE ELSE TRN_DATE;
CATID1/A10=IF FLG EQ 'A' THEN CAT_ID ELSE CCAT_ID;
VDESC1/A50=IF FLG EQ 'A' THEN VEND_DESC ELSE CVEND_DESC;
END
-RUN
TABLE FILE ACHLD
PRINT ABONUS CBONUS CMULTIP TRND1 CATID1 VDESC1
BY FLG
BY RES_SYS
BY PNR_LOCATOR
BY TKT1
BY TKT_SORT
ON TABLE HOLD AS ACHLD1
END

DEFINE FILE HTLHLD
FLG/A1 = 'H';
END
TABLE FILE HTLHLD
PRINT HBONUS HMULTIP INVOICE_DATE AS 'HTRN_DATE' CAT_ID AS 'HCAT_ID' VEND_DESC AS 'HVEND_DESC'
BY FLG
BY RES_SYS
BY PNR_LOCATOR
BY TKT_NUM AS 'TKT1'
ON TABLE HOLD AS HHLD
END
-RUN



MATCH FILE ACHLD1
PRINT ABONUS CBONUS CMULTIP TRND1 CATID1 VDESC1
BY FLG
BY RES_SYS
BY PNR_LOCATOR
BY TKT1
BY TKT_SORT
ON TABLE HOLD
RUN
FILE HHLD
PRINT HBONUS HMULTIP HTRN_DATE HCAT_ID HVEND_DESC
BY FLG
BY RES_SYS
BY PNR_LOCATOR
BY TKT1
AFTER MATCH HOLD AS AHHLD OLD-OR-NEW
END
-RUN


DEFINE FILE AHHLD
TKT/A10 = IF TKT1 EQ 'HTL ONLY' THEN 'HTL ONLY' ELSE 
          IF TKT1 EQ 'CAR ONLY' THEN 'CAR ONLY' ELSE TKT1;

TRND2/YYMD = IF TKT1 EQ 'HTL ONLY' THEN HTRN_DATE ELSE 
             IF TRND1 EQ ' ' THEN HTRN_DATE ELSE TRND1;
CATID2/A10=IF FLG EQ 'H' THEN HCAT_ID ELSE CATID1;
VDESC2/A50=IF FLG EQ 'H' THEN HVEND_DESC ELSE VDESC1;

MULTIP/P12 = IF FLG EQ 'A' THEN ABONUS ELSE 
             IF FLG EQ 'C' THEN CBONUS ELSE 
             IF FLG EQ 'H' THEN HBONUS ELSE 0;        
END
TABLE FILE AHHLD
PRINT CATID2 VDESC2 MULTIP TRND2
BY RES_SYS
BY PNR_LOCATOR
BY FLG
BY TKT 
BY TKT_SORT 
ON TABLE HOLD AS AHHLD
END
-RUN


-INCLUDE FDEFRPTSP2P1
-RUN


-SET &&OUTLINE2='FORMAT COMT';
-RUN

DEFINE FILE AHHLD
NOWTOD/A8 WITH PNR_LOCATOR = HHMMSS (NOWTOD);
ROLLUP_CODE/A8 = '&&ROLLUP.EVAL';
END
-RUN

TABLE FILE AHHLD
PRINT RES_SYS AS 'GDS' 
      PNR_LOCATOR AS 'PNR LOCATOR' 
      CATID2 AS 'CATEGORY ID' 
      VDESC2 AS 'VENDOR DESCRIPTION' 
      MULTIP AS 'MULTIPLIER' 
      TRND2 AS 'TRANSACTION DATE'
    
BY ROLLUP_CODE NOPRINT    
-* BY RES_SYS NOPRINT   
BY PNR_LOCATOR NOPRINT
BY FLG NOPRINT
-* BY HIER NOPRINT
BY TKT NOPRINT
BY TKT_SORT NOPRINT
HEADING
 "&&DTDESC &FMM/&FMD/&FMY - &TOM/&TOD/&TOY"
"<&&CSLP &&ROLLNME <+0> &&SP <+0> &&ROLLCS11 <+0> &&SP3 <+0> &&RCNCT1 <+0> &&SP4 <+0> &&ROLLPHN"
"</2"
"<10 &&RPT_TTL1"
"<10 &&RPT_TTL2"
"</2"
FOOTING BOTTOM
"eTTek Review &DATE AT <NOWTOD <60 &&FOOTR"
-* ON TABLE SET LINES 60000
ON TABLE SET PAGE-NUM OFF
ON TABLE NOTOTAL
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
UNITS=IN, PAGESIZE='Letter', LEFTMARGIN=1.250000, RIGHTMARGIN=0.250000, 
    TOPMARGIN=1.000000, BOTTOMMARGIN=0.250000, SQUEEZE=ON, 
    ORIENTATION=LANDSCAPE, $
-* TYPE=REPORT, TITLETEXT=EXLOVER, ROWOVERFLOW=OFF,$   
TYPE=REPORT,FONT=ARIAL, SIZE=8, COLOR=BLACK, 
     BACKCOLOR=NONE, STYLE=NORMAL, $


TYPE=FOOTING, SIZE=7, FONT=ARIAL, COLOR=RGB(70 136 177), $
TYPE=TABFOOTING,SIZE=7, FONT=ARIAL, COLOR=RGB(70 136 177), $

TYPE=TITLE, SIZE=8, FONT=ARIAL, JUSTIFY=LEFT, STYLE=BOLD, $
TYPE=HEADING, SIZE=9, STYLE=BOLD, COLOR=RGB(70 136 177), $
TYPE=HEADING, LINE=6, SIZE=10, FONT=ARIAL, STYLE=BOLD, COLOR=RGB(70 136 177), $
TYPE=HEADING, LINE=7, SIZE=10, FONT=ARIAL, STYLE=BOLD, COLOR=RGB(70 136 177), $
TYPE=DATA, JUSTIFY=LEFT, $
TYPE=REPORT, IMAGE=&&TNTPIC, POSITION=(&&TNTTRPOS), SIZE=(&&TNTTRSIZ), $
TYPE=REPORT, IMAGE=&&ROLLPIC, POSITION=(&&ROLTRPOS), SIZE=(&&ROLTRSIZ), $
ENDSTYLE
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN
-GOTO XXIT;

-GOTO JOY


-SET &&SAVEDXLS = '"'| &&TEMPPATH ||&DTTMIID || '.XLS' || '"' ;
-SET &&SAVEDCSV = '"'| &&TEMPPATH ||&DTTMIID || '.CSV' || '"' ;
-RUN

-* assume you have && USERNAME setup already
-* -SET &DESTFILE = "D:\TE\||'&&UNAME.EVAL'|| '\'|'SAVEREP.XLS';
-SET &DESTFILE = '"D:\TE\ |"&&UNAME.EVAL" || "\" | "SAVREP.XLS"';
-* -SET &DESTFILE = &&WEB_PATH || 'SAVREP.XLS';
-RUN

-SET &DESTFILE2 = '"D:\TE\ |"&&UNAME.EVAL" || "\" | "SAVREP.CSV"';
-* -SET &DESTFILE2 = &&WEB_PATH || 'SAVREP.CSV';
-* I think you may use copy command as well
-RUN
-DOS COPY &DESTFILE2
-RUN
-DOS RENAME &DESTFILE &DESTFILE2
-RUN
-DOS COPY &&SAVEDCSV &DESTFILE
-QUIT

-JOY

-IF &RECORDS EQ 0 THEN GOTO NORECORDS ELSE GOTO XXIT;


-NORECORDS
-SET &&RPTSUF = 'MSG';
-INCLUDE FDEFRPTS
-RUN
JOIN SET_KEY IN BRPTINST TO SET_KEY IN BRPT_SET AS J1
DEFINE FILE BRPTINST
EMPTY/A35 = 'NO RECORDS FOUND FOR THIS SELECTION';
NOWTOD/A8 WITH INST_KEY = HHMMSS (NOWTOD);
END
TABLE FILE BRPTINST
-INCLUDE HEADERDD
PRINT EMPTY AS 'REPORT,MESSAGE' 
BY ROLLUP_CODE AS 'ROLLUP,CODE'
BY RPT_NAME AS 'REPORT,NAME'
BY SELECT_LEV AS 'BREAK,LEVEL'
IF INST_KEY EQ &&IKEY
IF RECORDLIMIT EQ 1
-INCLUDE FOOTERDT
ON TABLE SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET PAGE-NUM OFF
ON TABLE SET STYLE *
-INCLUDE &&DTSTY
ENDSTYLE
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN

-XXIT;