SET ASNAMES=ON
USE D:\TNT\TTRACKER\SYSTEM\DATA\QUECHECK.FOC
    D:\TNT\TTRACKER\SUDATA\RPT_QUE.FOC
END
-RUN

JOIN CLEAR AA
JOIN INST_KEY IN RPT_QUE TO INST_KEY IN QUECHECK AS AA

DEFINE FILE RPT_QUE
XL01/YMD = &YMD;
XL02/I1  = QUECHECK.EVENT + 1 ;
END
TABLE FILE RPT_QUE
BY INST_KEY NOPRINT
PRINT INST_KEY AS 'INST_KEY'
      XL01     AS 'IDATE'
      XL02     AS 'EVENT'
IF EX_FLAG EQ 'E'
IF EVENT LT 4
ON TABLE HOLD AS PASS1
END
-IF &RECORDS EQ 0 GOTO STOP ;
-RUN

MODIFY FILE QUECHECK
FIXFORM FROM PASS1
MATCH INST_KEY
ON NOMATCH INCLUDE
ON MATCH UPDATE *
DATA ON PASS1
END

TABLE FILE RPT_QUE
BY INST_KEY NOPRINT
PRINT INST_KEY AS 'INST_KEY'
IF EX_FLAG NE 'Y'
IF QUECHECK.EVENT GT 2
ON TABLE HOLD AS ECHECK
END
-IF &RECORDS EQ 0 GOTO STOP;
MODIFY FILE RPT_QUE
FIXFORM FROM ECHECK
MATCH INST_KEY
ON MATCH COMPUTE EX_FLAG = 'Y' ;
ON MATCH UPDATE EX_FLAG
ON NOMATCH REJECT
DATA ON ECHECK
END
-RUN
DEFINE FILE RPT_QUE
XL01/YMD = &YMD;
END
TABLE FILE RPT_QUE
BY INST_KEY NOPRINT
PRINT INST_KEY AS 'INST_KEY'
IF EVENT GE 4
ON TABLE HOLD AS CLEAN
END
-IF &RECORDS EQ 0 GOTO STOP ;
-RUN
MODIFY FILE RPT_QUE
FIXFORM FROM CLEAN
MATCH INST_KEY
ON MATCH DELETE
DATA ON CLEAN
END
MODIFY FILE QUECHECK
FIXFORM FROM CLEAN
MATCH INST_KEY
ON MATCH DELETE
DATA ON CLEAN
END
-RUN
-STOP
-RUN
-EXIT

