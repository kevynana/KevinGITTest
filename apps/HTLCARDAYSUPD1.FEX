SET ASNAMES=ON

-INCLUDE SETECHO


TABLE FILE ROLLUP
PRINT COMP 
WHERE QTR_ENABLE NE 'X'
WHERE UPD_ENABLE NE ' '
WHERE LOAD_GRP EQ 'W'
WHERE ROLLUP_CODE NE 'TOTAL-R' OR 'ABCD-R' OR 'ABCD2-R' OR 'ABCD3-R'
ON TABLE SAVE AS CUSTOMER
END
-RUN 


-SET &TOTROLLS = &LINES;
 


-GetCount

-SET &CNT = 0;
-REPEAT Loop1 &TOTROLLS TIMES
-READ CUSTOMER NOCLOSE &VAL.6.
-IF &VAL EQ ' ' THEN GOTO Loop1;
-SET &CNT = &CNT + 1;
-SET &COMP.&CNT = &VAL;
-Loop1

-SET &CNT = 1;
-REPEAT Loop2 &TOTROLLS TIMES
-SET &COMPNY = &COMP.&CNT;
-RUN


-SET &DATAPATH='&&DATASRV.EVAL' || '\TNT\TTRACKER\DATA\';
-SET &&COMP1A = 'A_' || '&COMPNY.EVAL';

-SET &&COMP1A1 = '&DATAPATH.EVAL' || 'A_' || '&COMPNY.EVAL' || '.FOC';

-SET &&COMP1S1 = '&DATAPATH.EVAL' || 'S_' || '&COMPNY.EVAL' || '.FOC';

-SET &&COMP1S = 'S_' || '&COMPNY.EVAL';

-SET &&COMP1M1 = '&DATAPATH.EVAL' || 'M_' || '&COMPNY.EVAL' || '.FOC';

-SET &&COMP1M = 'M_' || '&COMPNY.EVAL';

-SET &&COMP1D1 = '&DATAPATH.EVAL' || 'D_' || '&COMPNY.EVAL' || '.FOC';

-SET &&COMP1D = 'D_' || '&COMPNY.EVAL';


USE CLEAR *
-RUN

USE 
&&COMP1A1 AS AIR_MAIN
&&COMP1S1 AS SR_50
&&COMP1M1 AS MR_50
&&COMP1D1 AS DR_50
END
-RUN

-*********************** SEGMENT 

JOIN CLEAR *
JOIN AIR_KEY IN AIR_MAIN TO ALL AIR_KEY IN SR_50 AS JS1
-RUN

TABLE FILE AIR_MAIN
SUM HTL_DAYS CAR_DAYS
BY TKT_NUM
BY EMBARK
BY ROUTE
WHERE SEG_COUNT EQ '-1'
WHERE HTL_DAYS NE 0 OR CAR_DAYS NE 0
ON TABLE HOLD AS SHLD1
END
-RUN

TABLE FILE AIR_MAIN
PRINT AIR_KEY TKT_SORT SEG_NBR
BY TKT_NUM
BY EMBARK
BY ROUTE
WHERE SEG_COUNT EQ '+1'
WHERE STAY NE 0
ON TABLE HOLD AS SHLD2
END
-RUN

MATCH FILE SHLD1
SUM HTL_DAYS CAR_DAYS  
BY TKT_NUM
BY EMBARK
BY ROUTE
ON TABLE HOLD
RUN
FILE SHLD2
PRINT AIR_KEY TKT_SORT SEG_NBR 
BY TKT_NUM
BY EMBARK
BY ROUTE
AFTER MATCH HOLD AS SHLD3 OLD
END
DEFINE FILE SHLD3
HDAYS/I5 = (HTL_DAYS * (-1));
CDAYS/I5 = (CAR_DAYS * (-1));
END
TABLE FILE SHLD3
SUM HDAYS AS 'HTL_DAYS' CDAYS AS 'CAR_DAYS'
BY AIR_KEY 
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS SHLD4
END
-RUN

-* SEGMENT  MODIFY

MODIFY FILE &&COMP1S
LOG NOMATCH MSG OFF
FIXFORM FROM SHLD4
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE HTL_DAYS CAR_DAYS
DATA ON SHLD4
END
-RUN



-***********************  Market *****************************************
JOIN CLEAR *
JOIN AIR_KEY IN AIR_MAIN TO ALL AIR_KEY IN MR_50 AS JM1
-RUN

TABLE FILE AIR_MAIN
SUM HTL_DAYS CAR_DAYS
BY TKT_NUM
BY EMBARK
BY ROUTE
WHERE SEG_COUNT EQ '-1'
WHERE HTL_DAYS NE 0 OR CAR_DAYS NE 0
ON TABLE HOLD AS MHLD1
END
-RUN


TABLE FILE AIR_MAIN
PRINT AIR_KEY TKT_SORT SEG_NBR
BY TKT_NUM
BY EMBARK
BY ROUTE
WHERE SEG_COUNT EQ '+1'
WHERE STAY NE 0
ON TABLE HOLD AS MHLD2
END
-RUN

MATCH FILE MHLD1
SUM HTL_DAYS CAR_DAYS  
BY TKT_NUM
BY EMBARK
BY ROUTE
ON TABLE HOLD
RUN
FILE MHLD2
PRINT AIR_KEY TKT_SORT SEG_NBR 
BY TKT_NUM
BY EMBARK
BY ROUTE
AFTER MATCH HOLD AS MHLD3 OLD
END
DEFINE FILE MHLD3
HDAYS/I5 = (HTL_DAYS * (-1));
CDAYS/I5 = (CAR_DAYS * (-1));
END
TABLE FILE MHLD3
SUM HDAYS AS 'HTL_DAYS' CDAYS AS 'CAR_DAYS'
BY AIR_KEY 
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS MHLD4
END
-RUN

-* MARKET MODIFY

MODIFY FILE &&COMP1M
LOG NOMATCH MSG OFF
FIXFORM FROM MHLD4
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE HTL_DAYS CAR_DAYS
DATA ON MHLD4
END
-RUN


-*************************  Destination *****************************************
JOIN CLEAR *
JOIN AIR_KEY IN AIR_MAIN TO ALL AIR_KEY IN DR_50 AS JD1
-RUN

TABLE FILE AIR_MAIN
SUM HTL_DAYS CAR_DAYS
BY TKT_NUM
BY EMBARK
BY ROUTE
WHERE SEG_COUNT EQ '-1'
WHERE HTL_DAYS NE 0 OR CAR_DAYS NE 0
ON TABLE HOLD AS DHLD1
END
-RUN


TABLE FILE AIR_MAIN
PRINT AIR_KEY TKT_SORT SEG_NBR
BY TKT_NUM
BY EMBARK
BY ROUTE
WHERE SEG_COUNT EQ '+1'
WHERE STAY NE 0
ON TABLE HOLD AS DHLD2
END
-RUN

MATCH FILE DHLD1
SUM HTL_DAYS CAR_DAYS  
BY TKT_NUM
BY EMBARK
BY ROUTE
ON TABLE HOLD
RUN
FILE DHLD2
PRINT AIR_KEY TKT_SORT SEG_NBR 
BY TKT_NUM
BY EMBARK
BY ROUTE
AFTER MATCH HOLD AS DHLD3 OLD
END
DEFINE FILE DHLD3
HDAYS/I5 = (HTL_DAYS * (-1));
CDAYS/I5 = (CAR_DAYS * (-1));
END
TABLE FILE DHLD3
SUM HDAYS AS 'HTL_DAYS' CDAYS AS 'CAR_DAYS'
BY AIR_KEY 
BY EMBARK
BY ROUTE
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS DHLD4
END
-RUN

-* DESTINATION MODIFY

MODIFY FILE &&COMP1D
LOG NOMATCH MSG OFF
FIXFORM FROM DHLD4
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE HTL_DAYS CAR_DAYS
DATA ON DHLD4
END
-RUN


-NEXTONE

-NOUPDATE

-IncLoop2
-SET &CNT = &CNT + 1;
-Loop2
