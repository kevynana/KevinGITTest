-INCLUDE SETECHO
-* Hier_Upd.Fex
-*   Performs the actual Hierarchy update process
-*
-SET &&NOW_CYC = 'HPF';

-INCLUDE ADMRESET
-RUN

-* Build variables for the copying of the AH*, CH*, HH*, HP*, and
-* the HX* databases from the Server to the local machine.
-SET &SPATH = &&SRV_PATH;
-SET &LPATH = &&HPF_PATH;
-RUN
-SET &CPYF_AH = &SPATH.EVAL || &&AH_DB.EVAL;
-SET &CPYT_AH = &LPATH.EVAL || &&AH_DB.EVAL;
-SET &CPYF_CH = &SPATH.EVAL || &&CH_DB.EVAL;
-SET &CPYT_CH = &LPATH.EVAL || &&CH_DB.EVAL;
-SET &CPYF_HH = &SPATH.EVAL || &&HH_DB.EVAL;
-SET &CPYT_HH = &LPATH.EVAL || &&HH_DB.EVAL;
-SET &CPYF_HP = &SPATH.EVAL || &&HIER.EVAL;
-SET &CPYT_HP = &LPATH.EVAL || &&HIER.EVAL;
-SET &CPYF_HX = &SPATH.EVAL || &&XHIER.EVAL;
-SET &CPYT_HX = &LPATH.EVAL || &&XHIER.EVAL;
-SET &CPYF_RQD = &&SRVSU_PATH.EVAL || 'ROLLQTR.FOC';
-SET &CPYT_RQD = &&LOCAPP_PATH.EVAL || 'ROLLQTR.FOC';
-SET &CPYF_RQM = &&SRVSU_PATH.EVAL || 'ROLLQTR.MAS';
-SET &CPYT_RQM = &&LOCAPP_PATH.EVAL || 'ROLLQTR.MAS';
-SET &CPYF_ROD = &&SRVSU_PATH.EVAL || 'ROLLUP.FOC';
-SET &CPYT_ROD = &&LOCAPP_PATH.EVAL || 'ROLLUP.FOC';
-SET &CPYF_ROM = &&SRVSU_PATH.EVAL || 'ROLLUP.MAS';
-SET &CPYT_ROM = &&LOCAPP_PATH.EVAL || 'ROLLUP.MAS';
-RUN

-SET &COPY1 = &&TEMP_PATH || 'COPY1.BAT';
FILEDEF COPY1 DISK &COPY1
-RUN
-WRITE COPY1 COPY &CPYF_AH.EVAL &CPYT_AH.EVAL
-WRITE COPY1 COPY &CPYF_CH.EVAL &CPYT_CH.EVAL
-WRITE COPY1 COPY &CPYF_HH.EVAL &CPYT_HH.EVAL
-WRITE COPY1 COPY &CPYF_HP.EVAL &CPYT_HP.EVAL
-WRITE COPY1 COPY &CPYF_HX.EVAL &CPYT_HX.EVAL
-WRITE COPY1 COPY &CPYF_RQD.EVAL &CPYT_RQD.EVAL
-WRITE COPY1 COPY &CPYF_RQM.EVAL &CPYT_RQM.EVAL
-WRITE COPY1 COPY &CPYF_ROD.EVAL &CPYT_ROD.EVAL
-WRITE COPY1 COPY &CPYF_ROM.EVAL &CPYT_ROM.EVAL
-RUN
-* Execute the DOS Bat file to copy the files
DOS COPY1.BAT
-RUN

-HIER50

-SET &COPY2 = &&TEMP_PATH || 'COPY2.BAT';
FILEDEF COPY2 DISK &COPY2
-RUN
-* Build variables to help copy the databases to a TEMP directory
-* for backup purposes.
-SET &&FTO=&&TMP_PATH || &&HIER ;
-WRITE COPY2 COPY &CPYT_HP.EVAL &&FTO.EVAL
-SET &&FTO=&&TMP_PATH || &&AH_DB ;
-WRITE COPY2 COPY &CPYT_AH.EVAL &&FTO.EVAL
-SET &&FTO=&&TMP_PATH || &&CH_DB ;
-WRITE COPY2 COPY &CPYT_CH.EVAL &&FTO.EVAL
-SET &&FTO=&&TMP_PATH || &&HH_DB ;
-WRITE COPY2 COPY &CPYT_HH.EVAL &&FTO.EVAL
-RUN
-* Execute the DOS Bat file to copy the files
DOS COPY2.BAT
-RUN

-SET &&USE_AH = &&HPF_PATH || &&AH_DB;
-SET &&USE_CH = &&HPF_PATH || &&CH_DB;
-SET &&USE_HH = &&HPF_PATH || &&HH_DB;

USE
  &&USE_HIER AS HIER50
  &&USE_XHIER AS XHIER50
  &&USE_AH AS AH_50
  &&USE_CH AS CH_50
  &&USE_HH AS HH_50
END

-RUN

FILEDEF INSTPASS CLEAR
-RUN

FILEDEF INSTPASS DISK &&INSTPASS
-RUN

-SET &&RCODE =&&ROLLUP;
-SET &&STREAM=&&HFILE;

-IF &&RCODE EQ 'xxxxxxxx' THEN GOTO DELF50;

FILEDEF AUSEINCL DISK &&AUSEPASS
-RUN
FILEDEF CUSEINCL DISK &&CUSEPASS
-RUN
FILEDEF HUSEINCL DISK &&HUSEPASS
-RUN

-* Create input file for CATQTRHP that will contain the Server path to
-* the Company data files
DEFINE FILE CONTROL
SERV_PATH/A60='&SPATH.EVAL';
END
TABLE FILE CONTROL
PRINT SERV_PATH
BY ROLLUP_CODE
ON TABLE HOLD AS HLDCATHP
END
-RUN

EX CATQTRHP
-RUN

FILEDEF AUSEINCL CLEAR
-RUN
FILEDEF CUSEINCL CLEAR
-RUN
FILEDEF DUSEINCL CLEAR
-RUN

-SET &&MAP = 'HIERMAP';
-SET &&USE_MAP = &&COM_PATH || &&MAP;
-SET &&USE_HIERMAP = &&COM_PATH || &&STREAM || '.DAT';
-SET &&TSEG = 'TMPSEG';
-SET &&USE_TSEG = &&COM_PATH || &&TSEG;
-SET &&TCAR = 'TMPCAR';
-SET &&USE_TCAR = &&COM_PATH || &&TCAR;
-SET &&THTL = 'TMPHTL';
-SET &&USE_THTL = &&COM_PATH || &&THTL;

-IF &&STREAM EQ 'HPGUIUPD' THEN GOTO GUIU50;

-TYPE USE HIERMAP - &&USE_HIERMAP

FILEDEF INSTPASS CLEAR
-RUN

FILEDEF HIERIN DISK &&USE_HIERMAP
-RUN

CREATE FILE &&MAP

-RUN

MODIFY FILE &&MAP
FIXFORM LEVEL_CODE/A15 LEVEL_DESC/A30 LEVEL_BOSS/A15
MATCH LEVEL_CODE
  COMPUTE EDATE/YYMD = &&EFF_DATE;
  ON MATCH REJECT
  ON NOMATCH INCLUDE
DATA ON HIERIN
END
-RUN

USE
  &&USE_HIER AS HIER50
  &&USE_XHIER AS XHIER50
  &&USE_AH AS AH_50
  &&USE_CH AS CH_50
  &&USE_HH AS HH_50

-INCLUDE &&AUSEPASS
-INCLUDE &&CUSEPASS
-INCLUDE &&HUSEPASS
END

-RUN

-TYPE Starting HP50LOAD
EX HP50LOAD
-RUN

-TYPE Starting HP50OLD
EX HP50OLD
-RUN

-TYPE Starting BLDKEY50
EX BLDKEY50
-RUN

-TYPE Starting H50_TAG
EX H50_TAG
-RUN

-GUIU50

-RUN

-TYPE Starting Temp Seg Build
EX TSEGBLD
-RUN

-TYPE Starting AIRTAG50
EX AIRTAG50
-RUN

-TYPE Starting Temp Car Build
EX TCARBLD
-RUN

-TYPE Starting CARTAG50
EX CARTAG50
-RUN
-TYPE Starting Temp Htl Build
EX THTLBLD
-RUN

-TYPE Starting HTLTAG50
EX HTLTAG50
-RUN

-* Copy updated files back to the Server
-SET &COPY3 = &&TEMP_PATH || 'COPY3.BAT';
FILEDEF COPY3 DISK &COPY3
-RUN
-WRITE COPY3 COPY &CPYT_AH.EVAL &CPYF_AH.EVAL
-WRITE COPY3 COPY &CPYT_CH.EVAL &CPYF_CH.EVAL
-WRITE COPY3 COPY &CPYT_HH.EVAL &CPYF_HH.EVAL
-WRITE COPY3 COPY &CPYT_HP.EVAL &CPYF_HP.EVAL
-WRITE COPY3 COPY &CPYT_HX.EVAL &CPYF_HX.EVAL
-RUN
-* Execute the DOS Bat file to copy the files
DOS COPY3.BAT
-RUN

-*-EXIT

-RUN

-DELF50

-*-EXIT
