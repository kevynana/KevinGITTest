-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File DVHTL.FEX
-* CREATED FOR DATA VAULT EXPENSE REPORT 
-* CREATED FROM TKTHTL
-********************************************************************

-********************************************************************
-* MODIFICAIONS:
-********************************************************************
-*
-* This program extracts data for the series of basic hotel location listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-* Added Level5 - JK 8/9/13 
-* 4/11/14 - DEB - ADDED TASF_TKT_NUM 
-*10/22/14 - DEB - ADDED LEVEL6
-* 3/29/16 - RSB - S-17009  New version of DVEXPNS called: DVEXPNAG 
-*                          Need to add dummy DEFINE for ASSOC_CONF_NUM to HOLDH extract.
-*
-*7/13/16 -DLV -  S-20630   Added EMP_ID to extract
-* 07/13/17 - DLV - S-36108 - changed TRP_DESC to use TRP_REF.TRP_DESC

-********************************************************************
-INCLUDE SETECHO 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN



-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';

DEFINE FILE &&EXTRACT
  
  BLANK1/A11 = '           ';
  DATA_V1/A9 = '*********';
  DV_NUM2/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
  DV_NUM/A15 = IF DV_NUM2 EQ ' ' THEN ' ' ELSE DATA_V || DV_NUM2;
  LEVEL_DESC/A60 = &&LDESC;
  SEG/A2= '  ';
  CITY_ST/A35 = PROP_CITY||(', '| PROP_STATE);
  IN_DATE/MDYY = CHKIN_DATE;
  INV_DATE/MDYY = INVOICE_DATE;
  NBR_DAYS/D12 =  NUM_DAYS; 
  NNROOMS/D12 = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
  NEW_TOTAL_AMT/D12.2CS = TOTAL_AMT;
  OUT_DATE/MDYY = CHKOUT_DATE;
  PRP_CITY/A25 = PROP_CITY;
  PRP_ST/A25 = PROP_STATE_CD;
  TRIP_PURPOSE/A2 = ' ';
-*  TRP_DESC/A40 = '                                        ';
  TYPE/A3 = 'SAL';
  CHN_CODE/A3 = CHAIN_CODE;
  STATUS/A1 = 'O';
  HTL_CNF/A30 = HHL_CONFIRM;
  TASF_TKT_NUM/A10 = '          '; 
END
-RUN

TABLEF FILE &&EXTRACT
PRINT BR_CL_IDX AS 'ACCT'
  TYPE
  BLANK1 AS 'TSORT'
  DV_NUM
  PRP_CITY AS 'CITY1'
  HTL_KEY
  IN_DATE AS 'DATE'
  INV_DATE AS 'TRAN_DATE'
  INVOICE_DATE
  INVOICE_NUM
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  LEVEL4
  LEVEL5
  LEVEL6
  NEW_TOTAL_AMT AS 'AMOUNT'
  NNROOMS AS 'TTL_COUNT'
  OUT_DATE AS 'DATE2'
  SEG
  PASSNGR_NAME
  PNR_LOCATOR
  CHN_CODE AS 'NAME'
  STATUS
  HTL_CNF AS 'TKT_NUM'
  TRIP_PURPOSE
  TRP_REF.TRP_DESC
  CITY.GEO_ZONE AS 'GEO_ZONE'
  TASF_TKT_NUM
  EMP_ID
-INCLUDE &HTLDATES 

-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-* &&WHERE1
-* &&WHERE2
-* &&WHERE3
-* &&WHERE4
-* &&WHERE5
-* &&WHERE6
-* &&WHERE7
-* &&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS
ON TABLE HOLD AS HTLHOLD

END
-RUN

 


TABLE FILE PFHOLDH
PRINT TRN_TYPE TRN_DATE FEE_SRC FEE_AMT PAY_METHOD CREDIT_CARD FST_DPT_DATE TASF_TKT_NUM
BY HTL_KEY
WHERE HTL_KEY NE ' '
ON TABLE HOLD AS HTLFEE
END
-RUN

-IF &RECORDS EQ 0 THEN GOTO NoHJoin;



-* start of new code

-JoinHFee  
-*-INCLUDE  DVRHTLUSE
-*-RUN


TABLE FILE PFHOLDH
PRINT TRN_TYPE TRN_DATE FEE_SRC FEE_AMT PAY_METHOD CREDIT_CARD FST_DPT_DATE TASF_TKT_NUM
BY HTL_KEY
WHERE HTL_KEY NE ' '
ON TABLE HOLD AS HTLFEE
END
-RUN
 

DEFINE FILE HTLFEE
  HKEY/A71='''' | HTL_KEY | '''';
END

TABLE FILE HTLFEE
PRINT HKEY 
BY HTL_KEY NOPRINT
ON TABLE SAVE AS SAVEH
END
-RUN

DEFINE FILE HR_50

TKT_NUM/A30 = HHL_CONFIRM;
NAME/A3 = CHAIN_CODE;
CITY1/A25 = PROP_CITY;

DATA_V/A9 = '*********';
DV_NUM2/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
DV_NUM/A15 = IF DV_NUM2 EQ ' ' THEN ' ' ELSE DATA_V || DV_NUM2;


IN_DATE/MDYY = CHKIN_DATE;
OUT_DATE/MDYY = CHKOUT_DATE;
LEVEL_DESC/A60 = &&LDESC;
GEO_ZONE/A3 = IF GEO_ZONE EQ ' ' THEN 'USA' ELSE GEO_ZONE;
TRIP_PURPOSE/A2 = ' ';
TRP_DESC/A40 = '                                        ';
TASF_TKT_NUM/A10 = '          ';
END

TABLE FILE HR_50
PRINT 
  PASSNGR_NAME
  PNR_LOCATOR
  INVOICE_DATE
  TKT_NUM

  NAME
  IN_DATE 
  OUT_DATE
  CITY1
  DV_NUM
  BR_CL_IDX 
  INVOICE_NUM
  
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  GEO_ZONE
  TRIP_PURPOSE
  TRP_DESC
  TASF_TKT_NUM
  EMP_ID
BY HTL_KEY
-INCLUDE RPTPARMS
WHERE HTL_KEY IN FILE SAVEH
ON TABLE HOLD AS 'HR50SUB' FORMAT FOCUS INDEX HTL_KEY
END
-RUN

JOIN HTL_KEY IN PFHOLDH TO HTL_KEY IN HR50SUB
DEFINE FILE PFHOLDH
TRAN_DATE/MDYY = INVOICE_DATE;

TSORT/A11 = '           ';
TYPE/A3 = 'SAL';
SEG/A2= '  ';
STATUS/A1 = 'O';
AMOUNT/D12.2CS = FEE_AMT;
END

TABLE FILE PFHOLDH
PRINT 
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TSORT 
  TYPE
  EMP_ID
  SEG    
  NAME
  IN_DATE AS 'DATE'
  OUT_DATE AS 'DATE2'
  CITY1
  DV_NUM
  AMOUNT
  CNT AS 'TTL_COUNT'
  BR_CL_IDX AS 'ACCT'  
  INVOICE_NUM
  STATUS
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  GEO_ZONE
  TRIP_PURPOSE
  TRP_DESC
  TASF_TKT_NUM
BY FLAG
WHERE PASSNGR_NAME NE ' '
ON TABLE HOLD AS HOLDHP FORMAT FOCUS
END
-RUN


JOIN CLEAR *
DEFINE FILE HTLHOLD
GEO_ZONE/A3 = IF GEO_ZONE EQ ' ' THEN 'USA' ELSE GEO_ZONE;
FLAG/A1 = 'H';
END

TABLE FILE HTLHOLD
PRINT 
PASSNGR_NAME
PNR_LOCATOR
TRAN_DATE
TKT_NUM
TSORT
TYPE
EMP_ID
SEG      
NAME
DATE
DATE2
CITY1
DV_NUM
AMOUNT
TTL_COUNT
ACCT
INVOICE_NUM
STATUS
LEVEL_DESC
LEVEL1
LEVEL2
LEVEL3
LEVEL4
LEVEL5
LEVEL6
GEO_ZONE
TRIP_PURPOSE
TRP_DESC
TASF_TKT_NUM
BY FLAG
ON TABLE HOLD
END
-RUN

MODIFY FILE HOLDHP
FIXFORM FROM HOLD
DATA ON HOLD
END
-RUN
-SET &HFILENAME = 'HOLDHP';
-RUN
-*
-**********
-ToHoldHtl
-**********
DEFINE FILE &HFILENAME
 ASSOC_CONF_NUM/A30 = ' ';
END
-*
TABLE FILE &HFILENAME
PRINT PASSNGR_NAME
      PNR_LOCATOR
      TRAN_DATE
      TKT_NUM
      TSORT 
      TYPE
      EMP_ID
      SEG    
      NAME
      DATE
      DATE2
      CITY1
      DV_NUM
      AMOUNT
      TTL_COUNT
      ACCT
      INVOICE_NUM
      STATUS
      LEVEL_DESC
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL5
      LEVEL6
      GEO_ZONE
      TRIP_PURPOSE
      TRP_DESC
      TASF_TKT_NUM
      ASSOC_CONF_NUM
BY FLAG
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN
 -*
-GOTO XXIT1;
-*
-******** 
-NoHJoin
-******** 
DEFINE FILE HTLHOLD
 GEO_ZONE      /A3  = IF GEO_ZONE EQ ' ' THEN 'USA' ELSE GEO_ZONE;
 FLAG          /A1  = 'H';
 FEE_AMT       /D9.2= 0;
 ASSOC_CONF_NUM/A30 = ' ';
END
-*
TABLE FILE HTLHOLD
PRINT PASSNGR_NAME
      PNR_LOCATOR
      TRAN_DATE
      TKT_NUM
      TSORT 
      TYPE
      EMP_ID
      SEG    
      NAME
      DATE
      DATE2
      CITY1
      DV_NUM
      AMOUNT
      TTL_COUNT
      ACCT
      INVOICE_NUM
      STATUS
      LEVEL_DESC
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL5
      LEVEL6
      GEO_ZONE
      TRIP_PURPOSE
      TRP_DESC
      TASF_TKT_NUM
      ASSOC_CONF_NUM
BY FLAG
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN
-*
-SET &&NOHTL = IF &RECORDS EQ 0 THEN 'Y' ELSE 'N';
-*
-*******
-XXIT1
-*******
