-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* Joy Updated Pref_Non define to contain C/P/N/M/L
-* 9/9/14 Updated Pref_non define to use exclude_flags - jk
-* Story ID S-10086 Added &&overdrill flag logic for use in 5.0 to choose to for the report to be drillable or non-drillable - 9/15/15 - JM
-*4/27/2017-JEM-S-33318-updated logic for no records report
-* 08/28/2017 RSB S-38044 Place the footer datetime stamp text in a separate file to be -INCLUDED in the stylesheets

-INCLUDE SETECHO

TABLE FILE CONTROL
PRINT SECURITY_LEVEL
BY ROLLUP_CODE
ON TABLE SAVE AS XROLL
END
-RUN
-READ XROLL &&RLUP.A8.

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN


-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';

DEFINE FILE &&EXTRACT 
  CITY_ST/A35 = PROP_CITY||(' '| PROP_STATE);
  LEVEL_DESC/A60  = &&LDESC;
  NBR_DAYS/D12=NUM_DAYS;
  NBR_ROOMS/D12 = NUM_ROOMS;
  TOTAL_RATE/D14.2C = TOTAL_AMT;
  NNROOMS/D12 = IF ((NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)) THEN 
                ((NBR_DAYS*NUM_ROOMS) * (-1)) ELSE NBR_DAYS*NUM_ROOMS;
  REFUSE_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
  PNP_FLAG/A1 = EDIT(EXCLUDE_FLAGS, '$9');
  PNP_IE/A1 = EDIT(EXCLUDE_FLAGS, '$$9');  
-*  CLC_FLAG/A1 = IF CLIENT_PREF EQ 'C' OR 'P' OR 'N' OR 'M' OR 'L' THEN 'Y' ELSE 'N';
  CLC_FLAG/A1 = IF PNP_FLAG EQ 'I' THEN 'Y' ELSE 'N';
-*  NCLC_FLAG/A1 = IF CLIENT_PREF NE 'C' OR 'P' OR 'N' OR 'M' OR 'L' THEN 'Y' ELSE 'N';
  NCLC_FLAG/A1 = IF PNP_FLAG NE 'I' THEN 'Y' ELSE 'N';
    

-* Defines on Previous Defines
BOOKINGS/D8 = IF TOTAL_RATE GE 0 THEN 1 ELSE (-1);

-* Defines on previously defines defines

NCLCRM/P8CS = IF NCLC_FLAG EQ 'Y' THEN NNROOMS ELSE 0;
CLCRM/P8CS = IF CLC_FLAG EQ 'Y' THEN NNROOMS ELSE 0;

NCLCAM/D12.2CS = IF NCLC_FLAG EQ 'Y' THEN TOTAL_RATE ELSE 0;
CLCAM/D12.2CS = IF CLC_FLAG EQ 'Y' THEN TOTAL_RATE ELSE 0;

NCLCBK/P8CS = IF NCLC_FLAG EQ 'Y' THEN BOOKINGS ELSE 0;
CLCBK/P8CS = IF CLC_FLAG EQ 'Y' THEN BOOKINGS ELSE 0;
END
-RUN

TABLEF FILE &&EXTRACT
PRINT LEVEL_DESC
      NNROOMS
      BOOKINGS
      TOTAL_AMT
      NCLCRM
      CLCRM
      NCLCAM
      CLCAM
      NCLCBK
      CLCBK      
-INCLUDE &HTLDATES  
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-IF &&SETF EQ 'UPTPACLC' OR 'UPTPACL1' THEN GOTO NOEXCL;
WHERE REFUSE_CD NE 'N'
-NOEXCL;
-INCLUDE RPTPARMS
ON TABLE HOLD AS HHOLD
END
-RUN

-IF &RECORDS EQ 0 GOTO NORECORDS;

-IF &&SETF EQ 'UPTPACLC' OR 'UPTPACL1' THEN GOTO ALLHTL;

TABLE FILE HHOLD
SUM NNROOMS
    BOOKINGS
    TOTAL_AMT
    NCLCRM
    CLCRM
    NCLCAM
    CLCAM
    NCLCBK
    CLCBK     
BY LEVEL_DESC  
ON TABLE HOLD AS RPTHOLD
END
-RUN


TABLE FILE RPTHOLD
SUM NNROOMS
    BOOKINGS
    TOTAL_AMT
    NCLCRM
    CLCRM
    NCLCAM
    CLCAM
    NCLCBK
    CLCBK   
RANKED BY HIGHEST 50 TOTAL NCLCRM
BY LEVEL_DESC
ON TABLE HOLD AS RANKH
END
-RUN

DEFINE FILE RANKH
 CNT/I2 = CNT + 1;
 CNT2/I2 = IF CNT LE 50 THEN CNT ELSE 51;
 LEVD/A60 = IF CNT2 LE 50 THEN LEVEL_DESC ELSE 'ALL OTHERS';
END

TABLE FILE RANKH
SUM NNROOMS
    BOOKINGS
    TOTAL_AMT
    NCLCRM
    CLCRM
    NCLCAM
    CLCAM
    NCLCBK
    CLCBK
BY CNT2 
BY LEVD 
BY LEVEL_DESC
ON TABLE HOLD AS HTLHOLD
END
-RUN

-SET &&RPTSUF = 'NONCLCHTL';

-INCLUDE FDEFRPTS
-RUN


DEFINE FILE HTLHOLD
NOWTOD/A8 WITH LEVD = HHMMSS (NOWTOD);
END
-RUN


TABLE FILE HTLHOLD
-INCLUDE HEADER
SUM NNROOMS AS 'Total Room,Nights'
    BOOKINGS AS 'Total,Bookings'
COMPUTE CLCAR/D12.2CSM = IF ((CLCAM LT 1) AND (CLCAM GT (-1))) THEN 0 ELSE (CLCAM/CLCRM);  AS 'Average CLC,Nightly Rate'
COMPUTE CLCP/D12% = IF ((BOOKINGS LT 1) AND (BOOKINGS GT (-1))) THEN 0 ELSE (CLCBK/BOOKINGS)*100; AS '% of Bookings at,CLC Properties'    
COMPUTE NCLCAR/D12.2CSM = IF ((NCLCRM LT 1) AND (NCLCRM GT (-1))) THEN 0 ELSE (NCLCAM/NCLCRM); AS 'Average Non-CLC,Nightly,Rate'
COMPUTE NCLCP/D12% = IF ((BOOKINGS LT 1) AND (BOOKINGS GT (-1))) THEN 0 ELSE (NCLCBK/BOOKINGS)*100; AS '% of Bookings at,NON-CLC Properties'
BY CNT2 NOPRINT
BY LEVD AS 'Hierarchy'
-*
-INCLUDE FOOTERSM
-*
ON TABLE SET PAGE-NUM OFF
ON TABLE RECOMPUTE AS 'TOTAL'
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT

ON TABLE SET STYLE *
-*
-INCLUDE &&SMSTY
-*
-IF &&OVERDRILL EQ 'Y' GOTO OVERDRILL;

TYPE=DATA, COLUMN=N7, \
URL=&&SRVR.EVAL/ibi_apps/WFServlet? \
(IBIF_ex='DRUPNCLC' ROW_LABEL=N2 LSEL='&&LDESC.EVAL'\
 SETFNM='&&DTTMSTRM.EVAL' \
 FPARM='&&DTTMID.EVAL' \
ROLUP='&&ROLLUP' user='&&UNAME'), $

TYPE=DATA, COLUMN=N8, \
URL=&&SRVR.EVAL/ibi_apps/WFServlet? \
(IBIF_ex='DRUPNCLC' ROW_LABEL=N2 LSEL='&&LDESC.EVAL'\
 SETFNM='&&DTTMSTRM.EVAL' \
 FPARM='&&DTTMID.EVAL' \
ROLUP='&&ROLLUP' user='&&UNAME'), $

-**********
-OVERDRILL
-**********
TYPE=REPORT, WRAP= 1,$
-* TYPE=REPORT, COLUMN=N2, WRAP=2,$
TYPE=REPORT, COLUMN=N3, WRAP=0,$

ENDSTYLE
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
-*
END
-RUN
-GOTO XXIT;

-ALLHTL;

TABLE FILE HHOLD
SUM NNROOMS
    BOOKINGS
    TOTAL_AMT
    NCLCRM
    CLCRM
    NCLCAM
    CLCAM
    NCLCBK
    CLCBK     
BY LEVEL_DESC  
ON TABLE HOLD AS RPTHOLD
END
-RUN


TABLE FILE RPTHOLD
SUM NNROOMS
    BOOKINGS
    TOTAL_AMT
    NCLCRM
    CLCRM
    NCLCAM
    CLCAM
    NCLCBK
    CLCBK   
RANKED BY HIGHEST 9999 TOTAL NCLCRM
BY LEVEL_DESC
ON TABLE HOLD AS RANKH
END
-RUN

DEFINE FILE RANKH
 CNT/I5 = CNT + 1;
 CNT2/I5 = IF CNT LE 9999 THEN CNT ELSE 10000;
 LEVD/A60 = IF CNT2 LE 9999 THEN LEVEL_DESC ELSE 'ALL OTHERS';
END

TABLE FILE RANKH
SUM NNROOMS
    BOOKINGS
    TOTAL_AMT
    NCLCRM
    CLCRM
    NCLCAM
    CLCAM
    NCLCBK
    CLCBK
BY CNT2 
BY LEVD 
BY LEVEL_DESC
ON TABLE HOLD AS HTLHOLD
END
-RUN

-SET &&RPTSUF = 'ALLCLCHTL';

-INCLUDE FDEFRPTS
-RUN


DEFINE FILE HTLHOLD
NOWTOD/A8 WITH LEVD = HHMMSS (NOWTOD);
END
-RUN


TABLE FILE HTLHOLD
-INCLUDE HEADER
SUM NNROOMS AS 'Total Room,Nights'
    BOOKINGS AS 'Total,Bookings'
COMPUTE CLCAR/D12.2CSM = IF ((CLCAM LT 1) AND (CLCAM GT (-1))) THEN 0 ELSE (CLCAM/CLCRM);  AS 'Average CLC,Nightly Rate'
COMPUTE CLCP/D12% = IF ((BOOKINGS LT 1) AND (BOOKINGS GT (-1))) THEN 0 ELSE (CLCBK/BOOKINGS)*100; AS '% of Bookings at,CLC Properties'    
COMPUTE NCLCAR/D12.2CSM = IF ((NCLCRM LT 1) AND (NCLCRM GT (-1))) THEN 0 ELSE (NCLCAM/NCLCRM); AS 'Average Non-CLC,Nightly,Rate'
COMPUTE NCLCP/D12% = IF ((BOOKINGS LT 1) AND (BOOKINGS GT (-1))) THEN 0 ELSE (NCLCBK/BOOKINGS)*100; AS '% of Bookings at,NON-CLC Properties'
BY CNT2 NOPRINT
BY LEVD AS 'Hierarchy'
-*
-INCLUDE FOOTERSM
-*
ON TABLE SET PAGE-NUM OFF
ON TABLE RECOMPUTE AS 'TOTAL'
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT

ON TABLE SET STYLE *

-IF &&OVERDRILL EQ 'Y' GOTO OVERDRILL1;


-IF &&SETF EQ 'UPTPACL1' GOTO NODD;


TYPE=DATA, COLUMN=N3, \
URL=&&SRVR.EVAL/ibi_apps/WFServlet? \
(IBIF_ex='DRUPALL' ROW_LABEL=N2 LSEL='&&LDESC.EVAL'\
 SETFNM='&&DTTMSTRM.EVAL' \
 FPARM='&&DTTMID.EVAL' \
ROLUP='&&ROLLUP' user='&&UNAME'), $

TYPE=DATA, COLUMN=N4, \
URL=&&SRVR.EVAL/ibi_apps/WFServlet? \
(IBIF_ex='DRUPALL' ROW_LABEL=N2 LSEL='&&LDESC.EVAL'\
 SETFNM='&&DTTMSTRM.EVAL' \
 FPARM='&&DTTMID.EVAL' \
ROLUP='&&ROLLUP' user='&&UNAME'), $

TYPE=DATA, COLUMN=N5, \
URL=&&SRVR.EVAL/ibi_apps/WFServlet? \
(IBIF_ex='DRUPACLC' ROW_LABEL=N2 LSEL='&&LDESC.EVAL'\
 SETFNM='&&DTTMSTRM.EVAL' \
 FPARM='&&DTTMID.EVAL' \
ROLUP='&&ROLLUP' user='&&UNAME'), $


TYPE=DATA, COLUMN=N6, \
URL=&&SRVR.EVAL/ibi_apps/WFServlet? \
(IBIF_ex='DRUPACLC' ROW_LABEL=N2 LSEL='&&LDESC.EVAL'\
 SETFNM='&&DTTMSTRM.EVAL' \
 FPARM='&&DTTMID.EVAL' \
ROLUP='&&ROLLUP' user='&&UNAME'), $

TYPE=DATA, COLUMN=N7, \
URL=&&SRVR.EVAL/ibi_apps/WFServlet? \
(IBIF_ex='DRUPANCLC' ROW_LABEL=N2 LSEL='&&LDESC.EVAL'\
 SETFNM='&&DTTMSTRM.EVAL' \
 FPARM='&&DTTMID.EVAL' \
ROLUP='&&ROLLUP' user='&&UNAME'), $

TYPE=DATA, COLUMN=N8, \
URL=&&SRVR.EVAL/ibi_apps/WFServlet? \
(IBIF_ex='DRUPANCLC' ROW_LABEL=N2 LSEL='&&LDESC.EVAL'\
 SETFNM='&&DTTMSTRM.EVAL' \
 FPARM='&&DTTMID.EVAL' \
ROLUP='&&ROLLUP' user='&&UNAME'), $

-OVERDRILL1;

-NODD;
-*
-INCLUDE &&SMSTY
-*
ENDSTYLE
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
-*
END
-RUN

-NORECORDS;

-XXIT;



