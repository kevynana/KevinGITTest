-INCLUDE SETECHO
-* File push_rptque_reports_ls.fex
-*   This Focexec will check for scheduled Reports that need to be pushed
-*   each week and each month.
SET BASEURL='&&SRVR.EVAL'
SET EMPTYREPORT=OFF
SET BYDISPLAY=ON
SET LINES=99999
-*SET TEMPERASE = OFF
 
-INCLUDE CLASSPATH
 
-SET &&WPATH1=TEMPPATH(50,'A50');
-SET &&JPATH=STRREP(50,'&&WPATH1.EVAL',1,'\',2,'\\',150,'A150');
 
-SET &TDATE=&YYMD;
-*-SET &TDATE=20080627;
 
 
DEFINE FILE ROLLSET
ROLL_PARM/A16=ROLLUP_CODE || GLOBAL_PARM;
END
TABLE FILE ROLLSET
SUM COMPOUND_RPT
BY ROLL_PARM
ON TABLE HOLD AS HRPARM FORMAT FOCUS INDEX ROLL_PARM
END
-RUN
 
-***************************************************************************
-* Get Individual Reports that were scheduled
-*
JOIN CLEAR *
JOIN INST_KEY IN RPT_QUE TO ALL INST_KEY IN HRPTINST AS J1
JOIN ROLLUP_CODE IN RPT_QUE TO ROLLUP_CODE IN ROLLUP AS J2
JOIN USER_NAME IN RPT_QUE TO USER_NAME IN USRTBL AS J3
JOIN USER_NAME AND ROLLUP_CODE IN RPT_QUE TO USER_NAME AND CLIENT_ID_ROLLUP IN USRROLL AS J4
-RUN
 
DEFINE FILE RPT_QUE CLEAR
EXFEX/A10=IF RPT_SEQ EQ 999 THEN 'WRUNTOTAL' ELSE
            IF RPT_TYPE EQ 'QTR' THEN 'RUN_QTR' ELSE 'WRUNINDV';
-*        IF RPT_TYPE EQ 'QTR' THEN 'QR_RUN_QTR' ELSE 'WRUNINDV';            
RPT_NAMEX/A60=RPT_NAME;
PUSH_EADDRS/A512=EMAIL;
OUTTO/A2=IF DISTRB_FLAG EQ 'T' OR 'E' OR 'B' THEN 'TC' ELSE
         IF DISTRB_FLAG EQ 'EC' THEN 'TC' ELSE
   IF DISTRB_FLAG EQ 'F' THEN 'FC' ELSE DISTRB_FLAG;
STYPE/A1='R';
-*OFORMAT/A10=IF RPT_STREAM NE 'CAP_RPT' THEN OUTPUT_FORMAT ELSE
-*            IF OUTPUT_FORMAT NE 'PDF' OR 'PPT' THEN 'PDF' ELSE OUTPUT_FORMAT;
OFORMAT/A10=OUTPUT_FORMAT;
ROLL_PARM/A16=RPT_QUE.RPT_QUE.ROLLUP_CODE || GLOBAL_PARM;
END
TABLE FILE RPT_QUE
PRINT SET_KEY
      INST_KEY
      INTIME
      OUTTO
      OFORMAT AS OUTPUT_FORMAT
      DATETYPE
      RPT_NAMEX AS RPT_NAME
      FM_DATE
      TO_DATE
      FXDATE
      TXDATE
      CMFM_DATE
      CMTO_DATE
      PMFM_DATE
      PMTO_DATE
      CYFM_DATE
      CYTO_DATE
      PYFM_DATE
      PYTO_DATE
      EXFEX
      ROLLUP_CODE
      PUSH_EADDRS
      STYPE
      RPT_SEQ
      ROLL_PARM
 
   FTP_ADDRESS
   FTP_USER_NAME
   FTP_PWD
 
BY USER_NAME AS SCHED_OWNER
WHERE RPT_QUE.RPT_QUE.INTIME EQ HRPTINST.RPT_INST.INTIME
-*WHERE RPT_SEQ NE 999
WHERE RPT_QUE.RPT_QUE.EX_FLAG EQ 'Y'
ON TABLE SET HOLDLIST PRINTONLY
ON TABLE SET ASNAMES ON
ON TABLE HOLD AS HLDSCHED1
END
-RUN
 
-IF &RECORDS EQ 0 GOTO NOBKUP;
-SET &BKFOLDER = 'd:\Data\rpt_que_backups';
-*APP MAP RQBKUP D:\Data\rpt_que_backups
APP MAP RQBKUP &BKFOLDER.EVAL
APP PREPENDPATH RQBKUP
-RUN
-SET &TI=EDIT(HHMMSS('A10'),'99$99$99');
-SET &FN='RQBKUP/rpt_que_parms' || '&YYMD' || '&TI';
 
TABLE FILE HLDSCHED1
PRINT *
ON TABLE SAVE AS &FN.EVAL FORMAT COMT
END
-RUN
-NOBKUP
 
JOIN CLEAR *
JOIN ROLL_PARM IN HLDSCHED1 TO ROLL_PARM IN HRPARM AS J1
-RUN
 
DEFINE FILE HLDSCHED1
RCFORMAT/A15=IF COMPOUND_RPT NE 'Y' THEN OUTPUT_FORMAT ELSE
            IF OUTPUT_FORMAT EQ 'PPT' THEN 'PPT TEMPLATE' ELSE
            IF OUTPUT_FORMAT EQ 'EXL2K' THEN 'EXCEL TEMPLATE' ELSE OUTPUT_FORMAT;
END
TABLE FILE HLDSCHED1
PRINT SET_KEY
      INST_KEY
      INTIME
      OUTTO
      OUTPUT_FORMAT
      RCFORMAT
      DATETYPE
      RPT_NAME
      FM_DATE
      TO_DATE
      FXDATE
      TXDATE
      CMFM_DATE
      CMTO_DATE
      PMFM_DATE
      PMTO_DATE
      CYFM_DATE
      CYTO_DATE
      PYFM_DATE
      PYTO_DATE
      EXFEX
      ROLLUP_CODE
      PUSH_EADDRS
      STYPE
      RPT_SEQ
      COMPOUND_RPT
     FTP_ADDRESS
   FTP_USER_NAME
   FTP_PWD
 
BY SCHED_OWNER
ON TABLE SET HOLDLIST PRINTONLY
ON TABLE SET ASNAMES ON
ON TABLE HOLD AS RCPARMS0
END
-RUN
 
TABLE FILE RCPARMS0
PRINT SET_KEY
      OUTTO
      OUTPUT_FORMAT
      DATETYPE
      RPT_NAME
      FM_DATE
      TO_DATE
      FXDATE
      TXDATE
      CMFM_DATE
      CMTO_DATE
      PMFM_DATE
      PMTO_DATE
      CYFM_DATE
      CYTO_DATE
      PYFM_DATE
      PYTO_DATE
      EXFEX
      ROLLUP_CODE
      PUSH_EADDRS
      STYPE
      RCFORMAT
   FTP_ADDRESS
   FTP_USER_NAME
   FTP_PWD
BY SCHED_OWNER
BY INST_KEY
BY INTIME
ON TABLE SET HOLDLIST PRINTONLY
ON TABLE SET ASNAMES ON
ON TABLE HOLD AS RCPARMS1
END
-RUN
 
TABLE FILE RCPARMS1
BY SCHED_OWNER
BY ROLLUP_CODE
BY PUSH_EADDRS
WHERE OUTTO NE 'FC'
ON TABLE HOLD AS RCPARMS2 FORMAT ALPHA
END
-RUN

-SET &NSCHEDS = &LINES;
 
-REPEAT SLOOP &NSCHEDS TIMES
 
-READ RCPARMS2 NOCLOSE &SOWN.A20, &RCODE.A8, &EADDRS.A512
DEFINE FILE RCPARMS1
SKEY/A11=EDIT(SET_KEY);
IKEY/A11=EDIT(INST_KEY);
-*SOWN/A10=EDIT(SCHED_OWNER,'9999999999');
SEPEMAIL/A1='';
ESUBJECT/A90='';
EMAILX/A100='';
END
TABLE FILE RCPARMS1
PRINT
      EXFEX
      SCHED_OWNER
      SKEY AS SET_KEY
      IKEY AS INST_KEY
      OUTTO
      OUTPUT_FORMAT
      DATETYPE
      RPT_NAME
      FM_DATE
      TO_DATE
      FXDATE
      TXDATE
      CMFM_DATE
      CMTO_DATE
      PMFM_DATE
      PMTO_DATE
      CYFM_DATE
      CYTO_DATE
      PYFM_DATE
      PYTO_DATE
      ROLLUP_CODE
      STYPE
      RCFORMAT
      SEPEMAIL
      ESUBJECT
      EMAILX
      FTP_ADDRESS
      FTP_USER_NAME
      FTP_PWD
  INTIME
      PUSH_EADDRS
BY RPT_NAME NOPRINT
BY SCHED_OWNER NOPRINT
BY SKEY NOPRINT
BY IKEY NOPRINT
WHERE SCHED_OWNER EQ '&SOWN';
WHERE ROLLUP_CODE EQ '&RCODE';
WHERE PUSH_EADDRS EQ '&EADDRS';
WHERE OUTTO NE 'FC'
ON TABLE SET HOLDLIST PRINTONLY
ON TABLE HOLD AS RCPARMS FORMAT ALPHA
END
-RUN
 

-SET &IFILE='&&JPATH.EVAL' || 'rcparms.ftm';
-RUN
 
-DOS java -cp "&CP.EVAL" com.tandt.rcaster.schedule.EtekPush "&IFILE.EVAL"
-RUN
 
-SLOOP
 
-* Check and schedule any FTP schedules
TABLE FILE RCPARMS1
PRINT SCHED_OWNER
      INST_KEY
   INTIME
WHERE OUTTO EQ 'FC'
ON TABLE HOLD AS RCPARMS3 FORMAT ALPHA
END
-RUN
 
-SET &NSCHEDS = &LINES;
 
-REPEAT FLOOP &NSCHEDS TIMES
 
-READ RCPARMS3 NOCLOSE &SOWN.A20, &IKEY.I7, &ITIME.A18
 
DEFINE FILE RCPARMS1
SKEY/A11=EDIT(SET_KEY);
IKEY/A11=EDIT(INST_KEY);
-*SOWN/A10=EDIT(SCHED_OWNER,'9999999999');
SEPEMAIL/A1='';
ESUBJECT/A90='';
EMAILX/A100='';
END
TABLE FILE RCPARMS1
PRINT
      EXFEX
      SCHED_OWNER
      SKEY AS SET_KEY
      IKEY AS INST_KEY
      OUTTO
      OUTPUT_FORMAT
      DATETYPE
      RPT_NAME
      FM_DATE
      TO_DATE
      FXDATE
      TXDATE
      CMFM_DATE
      CMTO_DATE
      PMFM_DATE
      PMTO_DATE
      CYFM_DATE
      CYTO_DATE
      PYFM_DATE
      PYTO_DATE
      ROLLUP_CODE
      STYPE
      RCFORMAT
      SEPEMAIL
      ESUBJECT
      EMAILX
      FTP_ADDRESS
      FTP_USER_NAME
      FTP_PWD
  INTIME
      PUSH_EADDRS
BY RPT_NAME NOPRINT
BY SCHED_OWNER NOPRINT
BY SKEY NOPRINT
BY IKEY NOPRINT
WHERE SCHED_OWNER EQ '&SOWN';
WHERE INST_KEY EQ &IKEY;
WHERE INTIME EQ '&ITIME';
WHERE OUTTO EQ 'FC'
ON TABLE SET HOLDLIST PRINTONLY
ON TABLE HOLD AS RCPARMS FORMAT ALPHA
END
-RUN
 
-SET &IFILE='&&JPATH.EVAL' || 'rcparms.ftm';
-RUN
 
-DOS java -cp "&CP.EVAL" com.tandt.rcaster.schedule.EtekPush "&IFILE.EVAL"
-RUN
 
-FLOOP
 
-SET &TDAY=EDIT(&MDYY,'99/99/9999');
 
DEFINE FILE RCPARMS1
METHOD/A8=IF OUTTO EQ 'FC' THEN 'FTP' ELSE 'EMAIL';
PUSH_TO/A512=IF OUTTO EQ 'FC' THEN FTP_ADDRESS ELSE PUSH_EADDRS;
END
TABLE FILE RCPARMS1
" "
"eTTek Review Reports"
"Scheduled Reports Being Executed From RPT_QUE"
"for &TDAY"
PRINT
      SET_KEY AS 'Set,Key'
      INST_KEY AS 'Inst,Key'
      RPT_NAME AS 'Report Name'
      OUTPUT_FORMAT AS 'Report,Format'
      DATETYPE AS 'Date,Type'
      FM_DATE AS 'FM_Date'
      TO_DATE AS 'TO_Date'
      FXDATE AS 'FX_Date'
      TXDATE AS 'TX_Date'
      METHOD AS 'Method,Sent'
      PUSH_TO AS 'Push To Addresses'
BY SCHED_OWNER AS 'Schedule,Owner'
BY ROLLUP_CODE AS 'Rollup'
BY PUSH_EADDRS NOPRINT
BY METHOD NOPRINT UNDER-LINE
ON METHOD SUBHEAD
"Schedule created for:"
ON TABLE SET PAGE-NUM OFF
ON TABLE NOTOTAL
ON TABLE PCHOLD FORMAT HTML
ON TABLE SET HTMLCSS ON
ON TABLE SET STYLE *
     UNITS=IN,
     PAGESIZE='Letter',
     LEFTMARGIN=0.250000,
     RIGHTMARGIN=0.250000,
     TOPMARGIN=0.250000,
     BOTTOMMARGIN=0.250000,
     SQUEEZE=ON,
     ORIENTATION=PORTRAIT,
$
TYPE=REPORT,
     FONT='ARIAL',
     SIZE=10,
     COLOR='BLACK',
     BACKCOLOR='NONE',
     STYLE=NORMAL,
$
TYPE=DATA,
     BORDER-TOP=LIGHT,
     BORDER-BOTTOM=LIGHT,
     BORDER-LEFT=LIGHT,
     BORDER-RIGHT=LIGHT,
     BORDER-TOP-COLOR='SILVER',
     BORDER-BOTTOM-COLOR='SILVER',
     BORDER-LEFT-COLOR='SILVER',
     BORDER-RIGHT-COLOR='SILVER',
     SIZE=8,
     BACKCOLOR=( RGB(242 242 242) 'WHITE' ),
$
TYPE=TITLE,
     COLUMN=N9,
     JUSTIFY=CENTER,
     BORDER-TOP=LIGHT,
     BORDER-BOTTOM=LIGHT,
     BORDER-LEFT=LIGHT,
     BORDER-RIGHT=LIGHT,
     BORDER-TOP-STYLE=RIDGE,
     BORDER-BOTTOM-STYLE=RIDGE,
     BORDER-LEFT-STYLE=RIDGE,
     BORDER-RIGHT-STYLE=RIDGE,
     BORDER-TOP-COLOR='SILVER',
     BORDER-BOTTOM-COLOR='SILVER',
     BORDER-LEFT-COLOR='SILVER',
     BORDER-RIGHT-COLOR='SILVER',
$
TYPE=TITLE,
     COLUMN=N7,
     JUSTIFY=CENTER,
     BORDER-TOP=LIGHT,
     BORDER-BOTTOM=LIGHT,
     BORDER-LEFT=LIGHT,
     BORDER-RIGHT=LIGHT,
     BORDER-TOP-STYLE=RIDGE,
     BORDER-BOTTOM-STYLE=RIDGE,
     BORDER-LEFT-STYLE=RIDGE,
     BORDER-RIGHT-STYLE=RIDGE,
     BORDER-TOP-COLOR='SILVER',
     BORDER-BOTTOM-COLOR='SILVER',
     BORDER-LEFT-COLOR='SILVER',
     BORDER-RIGHT-COLOR='SILVER',
$
TYPE=TITLE,
     BORDER-TOP=LIGHT,
     BORDER-BOTTOM=LIGHT,
     BORDER-LEFT=LIGHT,
     BORDER-RIGHT=LIGHT,
     BORDER-TOP-STYLE=RIDGE,
     BORDER-BOTTOM-STYLE=RIDGE,
     BORDER-LEFT-STYLE=RIDGE,
     BORDER-RIGHT-STYLE=RIDGE,
     BORDER-TOP-COLOR='SILVER',
     BORDER-BOTTOM-COLOR='SILVER',
     BORDER-LEFT-COLOR='SILVER',
     BORDER-RIGHT-COLOR='SILVER',
     SIZE=9,
     COLOR='WHITE',
     BACKCOLOR=RGB(154 175 212),
     STYLE=BOLD,
$
TYPE=HEADING,
     SIZE=12,
     COLOR=RGB(36 43 114),
     STYLE=BOLD,
     JUSTIFY=CENTER,
$
TYPE=FOOTING,
     STYLE=BOLD,
$
TYPE=SUBHEAD,
     SIZE=9,
     STYLE=BOLD,
$
-*TYPE=REPORT,
-*     IMAGE=/image/TNTLogo.gif,
-*     POSITION=(0.027778 0.027778),
-*     SIZE=(1.902778 0.652778),
-*$
TYPE=REPORT,
     COLUMN=N15,
     WRAP=8.000000,
$
ENDSTYLE
END
-RUN
 
TABLE FILE HLDSCHED1
BY INST_KEY
BY INTIME
-*WHERE RPT_SEQ NE 888
ON TABLE HOLD AS HLDDEL1
END
-RUN
 
JOIN CLEAR *
-RUN
EX SUUSES
-RUN
 
MODIFY FILE RPT_QUE
FIXFORM FROM HLDDEL1
MATCH INST_KEY INTIME
 ON MATCH DELETE
 ON NOMATCH REJECT
DATA ON HLDDEL1
END
-RUN
 
-*MODIFY FILE HRPTINST
-*FIXFORM FROM HLDDEL1
-*MATCH INST_KEY INTIME
-* ON MATCH DELETE
-* ON NOMATCH REJECT
-*DATA ON HLDDEL1
-*END
-*-RUN
