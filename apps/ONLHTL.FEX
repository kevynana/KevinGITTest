-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-*1/30/14 UPDATED ONLINE/TRADITIONAL DEFINES TO USE ONLINE_TRADITIONAL FIELD INSTEAD OF DOD_TYPE
-*4/24/14  DEB  ADDED LEVEL4
-*4/25/2017-JEM-S-33318-updated logic for no records report

-INCLUDE SETECHO

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN


-SET &&OHFLG = 'N';

DEFINE FILE &&EXTRACT
BKD_ONLINE/A1 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN 'Y' ELSE 'N';
-* BKD_ONLINE/A1 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN 'Y' ELSE 'N';  
CLIENTCODE/A8 = '&&ROLLUP.EVAL';
   XPSNGR_NM/A15        = 
      EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  PAX/A5 = EDIT(XPSNGR_NM, '99999$$$$$$$$$$');
  LINE_DESC/A38 = XPSNGR_NM||TKT_NUM||PNR_LOCATOR|' '|'H';
  HTL_CNF/A30 = HHL_CONFIRM;
  MIR_SEQ1/A1 = EDIT(MIR_SEQ, '9$$$$$');
  
  RES_SYS/A1 = IF MIR_SEQ1 EQ 'X' THEN 'S' ELSE 'A';
  
  PROP_CODE1/A7 = IF RES_SYS EQ 'S' THEN PROP_SABRE_CODE ELSE PROP_APOLLO_CODE;

END


TABLEF FILE &&EXTRACT
PRINT ACCT_TYPE
  AGENT_NUM
  AR_BRANCH
  CHAIN_CODE AS 'VCHN_CODE'
  CHKIN_DATE AS 'PCKUP_CKIN_DT'
  CITY_CODE AS 'CITY'
  CLIENT_NUM
  CLIENTCODE AS 'ROLLUP'
  CREDIT_CARD
  CHKOUT_DATE AS 'DO_CKOUT_DT'
  GRAND_MSTR_CODE
  GROUP_CODE
  HTL_CNF AS 'CONFIRM'
  HOTEL_PHONE AS 'PHONE'
  INVOICE_DATE
  INVOICE_NUM
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LINE_DESC
  MIR_SEQ
  MSTR_GRP_CODE
  PAX
  PMT_TYPE
  PNR_LOCATOR
  PROP_ADDRESS AS 'ADDRESS'
  PROP_CITY AS 'CTY_NAME'
  PROP_CODE1 AS 'PROP_CODE'
  PROP_NAME AS 'VCHN_NAME'
  PROP_STATE_CD AS 'STATE_CODE'
  TOTAL_AMT AS 'AMOUNT'
  RESV_BRANCH
  RESV_STATUS
  TICKET_BRANCH
  TKT_NUM
  XPSNGR_NM
WHERE (INVOICE_DATE GE &&FXDATE.EVAL) AND (INVOICE_DATE LE &&TXDATE.EVAL)
WHERE BKD_ONLINE EQ 'Y'


-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS
ON TABLE HOLD AS HTLHLD
END
-RUN


-SET &&HTLREC=IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';
-IF &LINES EQ 0 THEN GOTO NoHtl;




-* Combine Air and Car files



-IF &&ACFLG EQ 'N' THEN GOTO CkCrFile;

MATCH FILE ONLAIRT
PRINT AIR
BY PNR_LOCATOR
ON TABLE HOLD
RUN
FILE ONCAR
SUM CAR
BY PNR_LOCATOR
AFTER MATCH HOLD AS XONE OLD-OR-NEW
END
-RUN


TABLE FILE XONE
PRINT AIR CAR
BY PNR_LOCATOR  
ON TABLE HOLD AS NOFEEFILE
END
-RUN




-GOTO ChkHtl;


-CkCrFile



-IF &&OCFLG2 EQ 'Y' THEN GOTO NoMatch;


DEFINE FILE ONCAR
CAR/A1 = 'Y';
AIR/A1 = 'N';
END
TABLE FILE ONCAR
PRINT AIR CAR
BY PNR_LOCATOR
ON TABLE HOLD AS NOFEEFILE
END
-RUN





-ChkHtl

DEFINE FILE HTLHLD
FEE/A1 = 'N';
FLAG/A1 = 'H';
END
TABLE FILE HTLHLD
PRINT ACCT_TYPE
  AGENT_NUM
  AR_BRANCH
  VCHN_CODE
  PCKUP_CKIN_DT
  CITY
  CLIENT_NUM
  ROLLUP
  CREDIT_CARD
  DO_CKOUT_DT
  FLAG
  FEE
  GRAND_MSTR_CODE
  GROUP_CODE
  CONFIRM
  PHONE
  INVOICE_DATE
  INVOICE_NUM
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LINE_DESC
  MIR_SEQ
  MSTR_GRP_CODE
  PAX
  PMT_TYPE
  ADDRESS
  CTY_NAME
  PROP_CODE
  VCHN_NAME 
  STATE_CODE 
  AMOUNT
  RESV_BRANCH
  RESV_STATUS
  TICKET_BRANCH
  TKT_NUM
  XPSNGR_NM
BY PNR_LOCATOR
ON TABLE HOLD AS HTLHLD2
END
-RUN




MATCH FILE HTLHLD2
PRINT ACCT_TYPE
  AGENT_NUM
  AR_BRANCH
  VCHN_CODE
  PCKUP_CKIN_DT
  CITY
  CLIENT_NUM
  ROLLUP
  CREDIT_CARD
  DO_CKOUT_DT
  FLAG
  FEE
  GRAND_MSTR_CODE
  GROUP_CODE
  CONFIRM
  PHONE
  INVOICE_DATE
  INVOICE_NUM
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LINE_DESC
  MIR_SEQ
  MSTR_GRP_CODE
  PAX
  PMT_TYPE
  ADDRESS
  CTY_NAME
  PROP_CODE
  VCHN_NAME 
  STATE_CODE 
  AMOUNT
  RESV_BRANCH
  RESV_STATUS
  TICKET_BRANCH
  TKT_NUM
  XPSNGR_NM
BY PNR_LOCATOR
ON TABLE HOLD
RUN
FILE NOFEEFILE
PRINT AIR CAR
BY PNR_LOCATOR
AFTER MATCH HOLD AS HTLHLD3 OLD-AND-NEW
END
-RUN

TABLE FILE HTLHLD3
PRINT ACCT_TYPE
  AGENT_NUM
  AIR
  AR_BRANCH
  VCHN_CODE
  PCKUP_CKIN_DT
  CAR
  CITY
  CLIENT_NUM
  ROLLUP
  CREDIT_CARD
  DO_CKOUT_DT
  FEE
  GRAND_MSTR_CODE
  GROUP_CODE
  CONFIRM
  PHONE
  INVOICE_DATE
  INVOICE_NUM
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LINE_DESC
  MIR_SEQ
  MSTR_GRP_CODE
  PAX
  PMT_TYPE
  PNR_LOCATOR
  ADDRESS
  CTY_NAME
  PROP_CODE
  VCHN_NAME 
  STATE_CODE 
  AMOUNT
  RESV_BRANCH
  RESV_STATUS
  TICKET_BRANCH
  TKT_NUM
  XPSNGR_NM
BY FLAG
ON TABLE HOLD AS WACHTL FORMAT FOCUS
END
-RUN


DEFINE FILE HTLHLD
FLAG/A1 = 'H';
END
TABLE FILE HTLHLD
PRINT ACCT_TYPE
  AGENT_NUM
  AR_BRANCH
  VCHN_CODE
  PCKUP_CKIN_DT
  CITY
  CLIENT_NUM
  ROLLUP
  CREDIT_CARD
  DO_CKOUT_DT
  FLAG
  GRAND_MSTR_CODE
  GROUP_CODE
  CONFIRM
  PHONE
  INVOICE_DATE
  INVOICE_NUM
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LINE_DESC
  MIR_SEQ
  MSTR_GRP_CODE
  PAX
  PMT_TYPE
  ADDRESS
  CTY_NAME
  PROP_CODE
  VCHN_NAME 
  STATE_CODE 
  AMOUNT
  RESV_BRANCH
  RESV_STATUS
  TICKET_BRANCH
  TKT_NUM
  XPSNGR_NM
BY PNR_LOCATOR
ON TABLE HOLD AS HTLHLD4
END
-RUN



MATCH FILE HTLHLD4
PRINT ACCT_TYPE
  AGENT_NUM
  AR_BRANCH
  VCHN_CODE
  PCKUP_CKIN_DT
  CITY
  CLIENT_NUM
  ROLLUP
  CREDIT_CARD
  DO_CKOUT_DT
  FLAG
  GRAND_MSTR_CODE
  GROUP_CODE
  CONFIRM
  PHONE
  INVOICE_DATE
  INVOICE_NUM
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LINE_DESC
  MIR_SEQ
  MSTR_GRP_CODE
  PAX
  PMT_TYPE
  ADDRESS
  CTY_NAME
  PROP_CODE
  VCHN_NAME 
  STATE_CODE 
  AMOUNT
  RESV_BRANCH
  RESV_STATUS
  TICKET_BRANCH
  TKT_NUM
  XPSNGR_NM
BY PNR_LOCATOR
ON TABLE HOLD
RUN
FILE NOFEEFILE
PRINT PNR_LOCATOR
BY PNR_LOCATOR
AFTER MATCH HOLD AS HTLHLD5 OLD-NOT-NEW
END
-RUN



DEFINE FILE HTLHLD5
FEE/A1 = IF TKT_NUM EQ '0000000000' AND PNR_LOCATOR NE LAST PNR_LOCATOR THEN 'Y' ELSE 'N';
CAR/A1 = 'N';
AIR/A1 = 'N';
END
TABLE FILE HTLHLD5
PRINT ACCT_TYPE
  AGENT_NUM
  AIR
  AR_BRANCH
  VCHN_CODE
  PCKUP_CKIN_DT
  CAR
  CITY
  CLIENT_NUM
  ROLLUP
  CREDIT_CARD
  DO_CKOUT_DT
  FEE
  GRAND_MSTR_CODE
  GROUP_CODE
  CONFIRM
  PHONE
  INVOICE_DATE
  INVOICE_NUM
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LINE_DESC
  MIR_SEQ
  MSTR_GRP_CODE
  PAX
  PMT_TYPE
  PNR_LOCATOR
  ADDRESS
  CTY_NAME
  PROP_CODE
  VCHN_NAME 
  STATE_CODE 
  AMOUNT
  RESV_BRANCH
  RESV_STATUS
  TICKET_BRANCH
  TKT_NUM
  XPSNGR_NM
BY FLAG
ON TABLE HOLD AS WOACHTL FORMAT FOCUS
END
-RUN




-IF &LINES EQ 0 THEN GOTO ONEonly;


-SET &HLDPATH=TEMPPATH(50,'A50');
-SET &HA=&HLDPATH || 'WACHTL.FOC';
-SET &HC=&HLDPATH || 'WOACHTL.FOC';

-RUN

USE CLEAR *
-RUN

EX SUUSES
-RUN 

USE ADD 
&HA AS WACHTL
&HC AS WACHTL
END
-RUN


-ONEonly



TABLE FILE WACHTL
PRINT   
   ACCT_TYPE
   ADDRESS
   AGENT_NUM
   AIR
   AMOUNT
   AR_BRANCH
   CAR
   CITY
   CLIENT_NUM
   CONFIRM
   CREDIT_CARD
   CTY_NAME
   DO_CKOUT_DT
   FEE
   GRAND_MSTR_CODE
   GROUP_CODE
   INVOICE_DATE
   INVOICE_NUM
   LEVEL1
   LEVEL2
   LEVEL3
   LEVEL4
   LINE_DESC
   MIR_SEQ
   MSTR_GRP_CODE
   PAX
   PCKUP_CKIN_DT
   PHONE
   PMT_TYPE
   PNR_LOCATOR
   RESV_BRANCH
   RESV_STATUS
   ROLLUP
   STATE_CODE
   TICKET_BRANCH
   TKT_NUM
   VCHN_CODE
   VCHN_NAME
   XPSNGR_NM
BY FLAG
ON TABLE HOLD AS ONLNHTL FORMAT FOCUS
END
-RUN

-GOTO END;



-NoMatch

DEFINE FILE HTLHLD
FEE/A1 = IF TKT_NUM EQ '0000000000' AND PNR_LOCATOR NE LAST PNR_LOCATOR THEN 'Y' ELSE 'N';
FLAG/A1 = 'H';
AIR/A1 = 'N';
CAR/A1 = 'N';
END
TABLE FILE HTLHLD
PRINT   
   ACCT_TYPE
   ADDRESS
   AGENT_NUM
   AIR
   AMOUNT
   AR_BRANCH
   CAR
   CITY
   CLIENT_NUM
   CONFIRM
   CREDIT_CARD
   CTY_NAME
   DO_CKOUT_DT
   FEE
   GRAND_MSTR_CODE
   GROUP_CODE
   INVOICE_DATE
   INVOICE_NUM
   LEVEL1
   LEVEL2
   LEVEL3
   LEVEL4
   LINE_DESC
   MIR_SEQ
   MSTR_GRP_CODE
   PAX
   PCKUP_CKIN_DT
   PHONE
   PMT_TYPE
   PNR_LOCATOR
   RESV_BRANCH
   RESV_STATUS
   ROLLUP
   STATE_CODE
   TICKET_BRANCH
   TKT_NUM
   VCHN_CODE
   VCHN_NAME
   XPSNGR_NM
BY FLAG
ON TABLE HOLD AS ONLNHTL FORMAT FOCUS
END
-RUN




-NoHtl

-END