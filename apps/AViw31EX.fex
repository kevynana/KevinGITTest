-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File AIREXTRT.FEX
-********************************************************************
-* MODIFICAIONS: 
-* 5/22/1998 ADDED TRN_DATE CRITERIA TO WHERE STATEMENTS - LP
-* 7/09/1998 ADDED A DEFINE FOR TICKETLESS MIR TRANSACTIONS - LP
-*11/16/2001 ADDED DEFINE FOR KIMBERLY CLARK LEVEL1      -DB
-* 4/29/2002 CHANGED MRK_TKT_CNT DEFINE TO CORRECTLY BACK OUT PARTIAL
-*           REFUNDS AND EXCHANGES - SC DB
-* 6/12/03   ADDED UPCOST DEFINE - DV 
-* 5/2/05    ADDED CODE FOR GLOBAL CURRENCY - DEB 
-* 3/11/08  Added DSTDOD define - JK
-* 5/19/10  Added code to include highest class of service - Deb
-*03/06/13  CHANGED CLASS_CAT DEFINE DUE TO CLASS CATEGORY CHANGES - DV
-* 6/26/13  Carried through AROLL_LEV2 - Steve
-*1/17/14 UPDATED ONLINE/TRADITIONAL DEFINES TO USE ONLINE_TRADITIONAL FIELD INSTEAD OF DOD_TYPE
-*1/22/14   CARRIED THROUGH RNDT_FLAG - DEB
-*2/14/14 Added EX_FEE Define - JK 
-*12/08/15 - JEM - S-13286 Updated to allow reports to sort/subtotal by id-levels
-* 09/23/16 - DLV - S-25159 - CARRIED THROUGH EMP_ID
-*05/23/17 - JEM - S-34959 - carried through level5 
-*08/29/17 - DLV - S-39186 - ADDED DEFINES  TKT_TYPE_DSC  TKT_RET_DATE 
-*                           ADDED EMB_CNTRY_CODE RTE_CNTRY_CODE FOR QBEAUK
-*09/07/2017 - DLV - S-37268 - Changed ORG_APX define to use ORG_APCX
-*                                     DST_APX define to use DST_APCX

****************************************************
-*
-* This program extracts data for the series of basic ticket listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-*
-********************************************************************
-* -INCLUDE SETECHO 
-INCLUDE SETECHO
SET ASNAMES = ON
-SET HOLDATTR = ON;

-SET &&IDLEVELBREAK = '';


-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

-INCLUDE IDLEVROLLDEF
-RUN

DEFINE FILE &&EXTRACT
ADDCOLLECT/D12.2CS = EXCH_NET_FARE + EXCH_NET_TAX;
  AL_TNUM/A13 = VAL_AIR.AIRLINE_NUM | TKT_NUM;

  BASE_FARE/D12.2CS = SEG_AMT - SEG_COM;
  BOOK_DT/MDYY         = RESV_DATE;
  CARD_NUM/A12=EDIT(CREDIT_CARD, '$$999999999999$$$$');
  CARD1_NUM/A4=EDIT(CREDIT_CARD, '$$$$$$$$$$$$$$9999');
  CARD_NUM1/A16=EDIT(CREDIT_CARD,'$$9999999999999999');
  CASH_CREDIT/A6        = IF (CASH_CREDIT EQ '1') THEN 'CASH' ELSE 'CREDIT';
  CCARD/A4 = EDIT(CREDIT_CARD, '$$9999$$$$$$$$$$$$');
  CCARD1/A4 =EDIT(CREDIT_CARD, '$$$$$$9999$$$$$$$$');
  CCARD2/A6 =EDIT(CREDIT_CARD, '$$999999$$$$$$$$$$');
  CCARD3/A6 =EDIT(CREDIT_CARD, '$$999999$$$$$$$$$$');
  CCARD5/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
-*  CLASS_CAT/A8 = DECODE CL_CAT ('F' 'FIRST'     'C' 'COACH'   
-*                              'D' 'DISCOUNT'  'B' 'BUSINESS');
  CLASS_CAT/A15 = DECODE CL_CAT ('F' 'FIRST'     'P' 'PREMIUM ECONOMY'   
			        'D' 'DEFAULT'   'B' 'BUSINESS'
			        'E' 'ECONOMY'   'U'  'UPGRADE' 
                                ' ' 'DEFAULT'); 
  COM_AMT/D12.2CS = SEG_COM;
  CRD_CRD/A2=EDIT(CREDIT_CARD, '99$$$$$$$$$$$$$$$');
  DEPT_MONTH/MT        = DPT_DATE;
  DIR_CP_CD/A50        = CITYPAIR.EMBARK||'-'||CITYPAIR.ROUTE;
  DODT/A15 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN 'ONLINE' ELSE 'TRADITIONAL';

  DSTDOD/A1            = IF DOD_TYPE EQ 'I' OR 'J' THEN 'I' ELSE ' ';
  DTNPOS/A3 = 'USA';
  DTN_DI/A14 = IF AIR_MAIN.INTL_DOM NE 'I' THEN 'DOMESTIC' ELSE 'INTERNATIONAL';
  BG_CLS_CAT/A1 = IF ADIR_ALL CONTAINS '*F' THEN 'F' ELSE IF ADIR_ALL CONTAINS '*B' THEN 'B' ELSE 
                     IF ADIR_ALL CONTAINS '*C' THEN 'C' ELSE 'D'; 
  KB_LVL1/A6           = IF LEVEL1 EQ '000999' THEN '000999' ELSE
                         EDIT(LEVEL1, '$$$999');
-****************************************************************************
-* 10/3/00  IBISTL-RJ    FIELD WAS BEING TRUNCATED IN FOCUS 6, NEED TO RUN A 
-*                       SUBROUTINE IN WEBFOCUS TO TRUNCATE.
  DIR_CP_NMX/A72 = '(' || CITYPAIR.EMBARK || '/' 
           || CITYPAIR.ROUTE || ') ' | 
           EMB_APT.AIRPORT_NAME ||'---' || RTE_APT.AIRPORT_NAME;
  DIR_CP_NM/A50 = SUBSTR(72,DIR_CP_NMX,1,50,50,'A50');
-*
  EX_FEE/D12.2CS = IF DOD_TYPE EQ 'I' OR 'J' THEN 8.00 ELSE
                   IF DOD_TYPE EQ 'H' THEN 15.00 ELSE 0.00;
  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;
  GROSS_FARE/D12.2CS  = IF (RF_FLAG EQ ' ') AND
                           (EX_FLAG EQ ' ') THEN
                        SEG_AMT + SEG_TAX ELSE 0;
  LEVEL_DESC1/A80      = &&LDESC;
  MIR_TYPE/A24 = DECODE AUX_NON_MIR ('X' 'X-DUAL MIR'
                                    'N' 'N-NON-TICKETING MIR'
                                    'J' 'J-NON-FARING MIR'
                                    'A' 'A-NON-ACCOUNTING MIR'
                                    'B' 'B-ACCOUNTING MIR'
                                    'H' 'H-REGULAR TICKET MIR'
                                    'V' 'V-VOID'
                                    'E' 'E-ELECTRONIC TKT NETWORK'
                                    'L' 'L-ELECTRONIC TKT MIR'
                                    ' ' ' -MANUALLY ENTERED TRANS');
  MRK_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (EX_FLAG NE ' ') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (RF_FLAG NE ' ') THEN (-1) ELSE 0;
  ND_CITY_NM/A50= NDO_CTY.CITY_NAME | NDD_CTY.CITY_NAME;
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  NET_TKT_CNT5/D8CS    = IF (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (EXCHG_SALE EQ ' ') THEN 1 ELSE
                         IF (DOC_TYPE EQ '1') AND
                           (FARE_PAID GE 0) AND
                           (EXCHG_SALE EQ ' ') AND
                           (VOID_DATE EQ 0) THEN 1 ELSE 0; 
 NET_TKT_CNT1/D9 =   IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND 
                     (SEG_COUNT EQ 1) AND (EXCHG_SALE EQ ' ') THEN 1 ELSE 
                     IF (DOC_TYPE EQ '1') AND
                        (EX_FLAG EQ ' ') AND 
                        (EXCHG_SALE NE ' ') THEN 1 ELSE 0;
  
  NEW_ADV_PURCH/D9    = ADV_PURCH;
  NEW_SEG_COUNT/D8CS = SEG_COUNT;
  NEW_SEG_DISC/D12.2CS = SEG_DISC;
  NEW_SEG_MILES/D9= SEG_MILES;
  NOREF_SEG_COUNT/D8CS = IF (RF_FLAG EQ ' ') AND
                            (EX_FLAG EQ ' ') THEN
                           NEW_SEG_COUNT ELSE 0;
  NRFLAG/A15 = IF NONREF_FLAG EQ 'N' THEN 'NON-REFUNDABLE' ELSE
               IF NONREF_FLAG EQ 'R' OR ' '  THEN 'REFUNDABLE' ELSE ' ';
  REF_E_CNT/D8CS      = IF (RF_FLAG NE ' ') OR
                           (EX_FLAG NE ' ') THEN
                            1 ELSE 0;  
  REF_EXCH_CNT/D8CS   = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 0 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN 1 ELSE 0;
  REFEXCH/D12.2CS     = IF (RF_FLAG NE ' ') THEN
                        SEG_AMT + SEG_TAX ELSE 
                        IF (EX_FLAG NE ' ') THEN
                        SEG_AMT + SEG_TAX ELSE 0;                      
  SAVINGS/D11.2CS     = SEG_STANDARD - FARE_PAID;  
  SHUTTLE/A11 = IF (C_ITIN EQ 'BOS-LGA-BOS') AND (VAL_AIRLINE EQ 'US' OR 'DL') THEN 'SHUTTLE' ELSE
             IF (C_ITIN EQ 'BOS-LGA') AND (VAL_AIRLINE EQ 'US' OR 'DL') THEN 'SHUTTLE' ELSE
             IF (C_ITIN EQ 'LGA-BOS') AND (VAL_AIRLINE EQ 'US' OR 'DL') THEN 'SHUTTLE' ELSE
             IF (C_ITIN EQ 'BOS-DCA-BOS') AND (VAL_AIRLINE EQ 'US' OR 'DL') THEN 'SHUTTLE' ELSE
             IF (C_ITIN EQ 'BOS-DCA') AND (VAL_AIRLINE EQ 'US' OR 'DL') THEN 'SHUTTLE' ELSE
             IF (C_ITIN EQ 'DCA-BOS') AND (VAL_AIRLINE EQ 'US' OR 'DL') THEN 'SHUTTLE' ELSE
             IF (C_ITIN EQ 'LGA-DCA-LGA') AND (VAL_AIRLINE EQ 'US' OR 'DL') THEN 'SHUTTLE' ELSE
             IF (C_ITIN EQ 'LGA-DCA') AND (VAL_AIRLINE EQ 'US' OR 'DL') THEN 'SHUTTLE' ELSE
             IF (C_ITIN EQ 'DCA-LGA') AND (VAL_AIRLINE EQ 'US' OR 'DL') THEN 'SHUTTLE' ELSE 'NON-SHUTTLE';   
  TKT_AMOUNT/D12.2CS  = TICKET_AMT + TAX_AMT;
  TKT_PURCH/D8CS      = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 0;
  TKT_CNT/D9CS        = IF (SEG_NBR EQ '01') AND 
                           (FARE_PAID GE 0) AND 
                           (SEG_COUNT EQ 1) THEN 1 ELSE 0;   
  TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE
				IF (VOID_DATE NE 0) THEN 'VOID' ELSE ' ';
  TKT_TYPE_DSC/A40 = IF (TKT_TYPE EQ '' AND EXSALE EQ '') THEN 'Original Sale' ELSE
  IF (TKT_TYPE EQ '' AND EXSALE NE '') THEN 'Exchange Sale'	ELSE
  IF (TKT_TYPE EQ 'F-EX') THEN 'Original Ticket Fully Exchanged' ELSE
  IF (TKT_TYPE EQ 'P-EX')    THEN 'Original Ticket Partially Exchanged' ELSE
  IF (TKT_TYPE EQ 'F-RF')    THEN 'Original Ticket Fully Refunded' ELSE
  IF (TKT_TYPE EQ 'P-RF')    THEN 'Original Ticket Partially Refunded' ELSE
 IF (TKT_TYPE EQ 'VOID')    THEN 'Original Ticket Voided';
 TRAN_MONTH/MT        = TRN_DATE;
  TRAN_YR/YY = TRN_DATE;
  XARR_DOW/W           = ARR_DATE;
  XARR_DT/MDYY         = ARR_DATE;
  XDPT_DOW/W           = DPT_DATE;
  XDPT_DT/MDYY         = DPT_DATE;
  XFST_DPT/MDYY = FST_DPT_DATE;
  XPSNGR_NM/A15        = 
    EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;
  UPCOST/A1 = IF LEVEL1 EQ '0US620' OR '0SP260' OR '098651' OR '098650' OR
                           '098640' OR '098639' OR '098633' OR '098632' OR
                           '098630' OR '098629' OR '098627' OR '098626' OR
                           '098624' OR '098623' OR '098622' OR '098621' OR
                           '098620' OR '098589' OR '098587' OR '098586' OR
                           '098585' OR '098584' OR '098583' OR '098582' OR
                           '098581' OR '098580' OR '098575' OR '098574' OR
                           '098572' OR '098571' OR '098570' OR '098569' OR
                           '098568' OR '098567' OR '098566' OR '098565' OR
                           '098563' OR '098562' OR '098560' OR '098555' OR
                           '098553' OR '098550' OR '098540' OR '098520' OR
                           '030151' OR '030150' THEN 'Y' ELSE 'N';


-* ****DEFINES ON PREVIOUS DEFINES****

  AIRLINE_FEE/D8.2CS = IF EMBARK EQ 'FP2' OR 'FP3' 
     THEN FARE_PAID ELSE 0;
  ARR_DAY/A3           = DECODE XARR_DOW (1 'MON' 2 'TUE' 3 'WED'
                                 4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
  BG_CAT/A8 = DECODE BG_CLS_CAT ('F' 'FIRST'     'C' 'COACH'   
                              'D' 'DISCOUNT'  'B' 'BUSINESS');  
  DISSAVINGS/D11.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST;
  DPT_DAY/A3           = DECODE XDPT_DOW (1 'MON' 2 'TUE' 3 'WED'
                                 4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
  GROSS_DSAVE/D12.2CS = IF (RF_FLAG EQ ' ') AND
                           (EX_FLAG EQ ' ') THEN
                           DISSAVINGS ELSE 0; 
  EXCHGS/D9 = IF (EX_FLAG EQ 'F' OR 'P') AND 
                 (SEG_COUNT LE 0) AND 
                 (EMBARK NE 'DT1' OR 'RF1' OR 'FP3') THEN TKT_CNT ELSE 
              IF (DOC_TYPE EQ '1') AND (EXCHG_SALE EQ 'E') THEN 0 ELSE 
              IF (SEG_COUNT GE 0) AND (EXCHG_SALE NE ' ') THEN TKT_CNT ELSE 0;

-*  Added for Principal Segment Count
-* Added for DTNC air file
-*  AT_FLAG/A1 = EDIT(ND_ORGX, '$$$9'); 
-*  ORG_APX/A4 = ORG_APC || AT_FLAG;
-*  DST_APX/A4 = DST_APC || AT_FLAG;
  ORG_APX/A7 = ORG_APCX;
  DST_APX/A7 = DST_APCX;   
 FLT_LEN1A/A5 = GETTOK(FLIGHT_DURATIONS, 72 , 1, '-', 5, FLT_LEN1A);
  FLT_LEN2A/A5 = GETTOK(FLIGHT_DURATIONS, 72 , 2, '-', 5, FLT_LEN2A);
  FLT_LEN3A/A5 = GETTOK(FLIGHT_DURATIONS, 72 , 3, '-', 5, FLT_LEN3A);
  FLT_LEN4A/A5 = GETTOK(FLIGHT_DURATIONS, 72 , 4, '-', 5, FLT_LEN4A);
  FLT_LEN5A/A5 = GETTOK(FLIGHT_DURATIONS, 72 , 5, '-', 5, FLT_LEN5A);
  FLT_LEN6A/A5 = GETTOK(FLIGHT_DURATIONS, 72 , 6, '-', 5, FLT_LEN6A);
  FLT_LEN7A/A5 = GETTOK(FLIGHT_DURATIONS, 72 , 7, '-', 5, FLT_LEN7A);
  FLT_LEN8A/A5 = GETTOK(FLIGHT_DURATIONS, 72 , 8, '-', 5, FLT_LEN8A);
  FLT_LEN9A/A5 = GETTOK(FLIGHT_DURATIONS, 72 , 9, '-', 5, FLT_LEN9A);
  FLT_LEN10A/A5 = GETTOK(FLIGHT_DURATIONS, 72 , 10, '-', 5, FLT_LEN10A);
 

  FLEN1D/D9.2 = ATODBL(FLT_LEN1A,  '5', FLEN1D);
  FLEN2D/D9.2 = ATODBL(FLT_LEN2A,  '5', FLEN2D);
  FLEN3D/D9.2 = ATODBL(FLT_LEN3A,  '5', FLEN3D);
  FLEN4D/D9.2 = ATODBL(FLT_LEN4A,  '5', FLEN4D);
  FLEN5D/D9.2 = ATODBL(FLT_LEN5A,  '5', FLEN5D);
  FLEN6D/D9.2 = ATODBL(FLT_LEN6A,  '5', FLEN6D);
  FLEN7D/D9.2 = ATODBL(FLT_LEN7A,  '5', FLEN7D);
  FLEN8D/D9.2 = ATODBL(FLT_LEN8A,  '5', FLEN8D);
  FLEN9D/D9.2 = ATODBL(FLT_LEN9A,  '5', FLEN9D);
  FLEN10D/D9.2 = ATODBL(FLT_LEN10A,  '5', FLEN10D);

  FLT_LEN1/D5 = FLEN1D;
  FLT_LEN2/D5 = FLEN2D;
  FLT_LEN3/D5 = FLEN3D;
  FLT_LEN4/D5 = FLEN4D;
  FLT_LEN5/D5 = FLEN5D;
  FLT_LEN6/D5 = FLEN6D;
  FLT_LEN7/D5 = FLEN7D;
  FLT_LEN8/D5 = FLEN8D;
  FLT_LEN9/D5 = FLEN9D;
  FLT_LEN10/D5 = FLEN10D;
  
TOT_LEN/D12 = FLT_LEN1 + FLT_LEN2 + FLT_LEN3 + FLT_LEN4 + FLT_LEN5 + FLT_LEN6 + FLT_LEN7 + FLT_LEN8 + FLT_LEN9 + FLT_LEN10;
TOT_LEN2/D10.6 = IF (TOT_LEN LT 0) AND (TOT_LEN GT (-1)) THEN 0 ELSE TOT_LEN/1440;
 AFST_DEPART_DATE/A8YYMD = FST_DEST_DEPART_DATE;
 IFST_DEPART_DATE/I8YYMD = EDIT(AFST_DEPART_DATE);
 SFST_DEPART_DATE/MDYY = IFST_DEPART_DATE;
 TKT_RET_DATE/MDYY = SFST_DEPART_DATE + TRIP_LENGTH - 1;
 -INCLUDE TRANTYPE
-INCLUDE IDLEVDEFINE 

END
-RUN


TABLEF FILE &&EXTRACT
PRINT ADDCOLLECT
  ADIR_ALL
  AGENT_NUM	
  AIR_KEY	
  AIR_MAIN.INTL_DOM	
  AIRLINE	
  AIRLINE_FEE	
  AIRLINE_NAME	
  AL_TNUM
  AR_BRANCH
  ARR_DAY	
  ARR_TIME
  AROLL_DSC3
  AROLL_LEV2
  AROLL_LEV4
  AUX_NON_MIR	
  BASE_FARE	
  BOOK_DT	
  BR_CL_IDX
  C_ITIN	
  CARD_NUM	
  CARD_NUM1	
  CARD1_NUM
  CASH_CREDIT	
  CCARD	
  CCARD1	
  CCARD2	
  CCARD3	
  CCARD5
  CITYPAIR.EMBARK      AS 'EMB_APT_CD'	
  CITYPAIR.ROUTE       AS 'RTE_APT_CD'	
  CL_CAT	
  CLASS	
  CLASS_CAT	
  CLIENT_NAME
  CLIENT_NUM	
  COM_AMT	
  CRD_CRD	
  CREDIT_CARD	
  DEPT_MONTH	
  DIR_CP_CD	
  DIR_CP_NM	
  DISSAVINGS	
  DOC_TYPE
  DODT
  DOD_TYPE	
  DPT_DAY	
  DPT_TIME
  DST_APX
  DSTDOD
  DTNPOS
  DTN_DI
  EMB_APT.AIRPORT_NAME AS 'EMB_APT_NM'	
  EMB_CTY.CITY_NAME    AS 'EMB_CTY_NM'	
  EMB_CTY.COUNTRY_CODE	
  EMB_CTY.EMB_CITY     AS 'EMB_CTY_CD'
  EMB_CTY.COUNTRY_CODE	AS 'EMB_CNTRY_CODE'

  EMP_ID
  EX_RF_FLAG
  EXCHGS
  EX_FEE
  FARE_BAS	
  FARE_PAID	
  FLIGHT	
  GROSS_DSAVE
  GROSS_FARE	
  GROUP_CODE
  GSA_GTR	
  INT_CODE	
  INVOICE_NUM
  KB_LVL1	
  LEVEL_DESC	
  LEVEL1	
  LEVEL2	
  LEVEL3	
  LEVEL4
  LEVEL5
  MIR_TYPE	
  MRK_TKT_CNT	
  ND_CITY_NM	
  NET_TKT_CNT	
  NET_TKT_CNT1	
  NEW_ADV_PURCH	
  NEW_SEG_COUNT	
  NEW_SEG_DISC	
  NEW_SEG_MILES	
  NOREF_SEG_COUNT
  NRFLAG
  ORG_APX
  PASSNGR_NAME	
  PNR_LOCATOR	
  REF_E_CNT	
  REF_EXCH_CNT	
  REFEXCH	
  REFUSAL_DESC	
  REFUSE_CODE	
  REFUSE_KEY 
  RNDT_FLAG
  RTE_APT.AIRPORT_NAME AS 'RTE_APT_NM'	
  RTE_CTY.CITY_NAME    AS 'RTE_CTY_NM'	
  RTE_CTY.RTE_CITY     AS 'RTE_CTY_CD'
  RTE_CTY.COUNTRY_CODE AS 'RTE_CNTRY_CODE'
  SALES_FLAG
  SAVINGS	
  SEG_AMT	
  SEG_COUNT	
  SEG_DESIG	
  SEG_DISCOUNT	
  SEG_LOWEST	
  SEG_MILES	
  SEG_NBR	
  SEG_STANDARD	
  SEG_TAX	
  SHUTTLE
  STAY	
  TICKET_BRANCH	
  TKT_AMOUNT
  TKT_CL_CAT
  TKT_DATE
  TKT_NUM	
  TKT_PURCH
  TKT_RET_DATE
  TKT_SORT	
  TKT_TYPE
  TKT_TYPE_DSC
  TOT_LEN2
  TOUR_CODE	
  TRAN_MONTH
  TRAN_YR
  TRIP_LENGTH	
  TRIP_PURPOSE
  TRN_DATE
  UPCOST	
  VAL_AIRLINE
  VAL_AIR.AIRLINE_NAME AS 'VAL_ALNM'
  VOID_DATE	 
  XARR_DT	
  XDPT_DT
  XFST_DPT
  XPSNGR_NM	
  XTRAN_DT	


-INCLUDE &AIRDATES

-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS


ON TABLE HOLD AS AIRFILE
END
-RUN

 


 


TABLE FILE AIRFILE
PRINT ADDCOLLECT
  ADIR_ALL
  AGENT_NUM	
  AIR_KEY	
  INTL_DOM	
  AIRLINE	
  AIRLINE_FEE	
  AIRLINE_NAME	
  AL_TNUM
  AR_BRANCH
  ARR_DAY	
  ARR_TIME
  AROLL_DSC3
  AROLL_LEV2
  AROLL_LEV4
  AUX_NON_MIR	
  BASE_FARE	
  BOOK_DT	
  BR_CL_IDX
  C_ITIN	
  CARD_NUM	
  CARD_NUM1	
  CARD1_NUM
  CASH_CREDIT	
  CCARD	
  CCARD1	
  CCARD2	
  CCARD3	
  CCARD5
  EMB_APT_CD	
  RTE_APT_CD	
  CL_CAT	
  CLASS	
  CLASS_CAT	
  CLIENT_NAME
  CLIENT_NUM	
  COM_AMT	
  CRD_CRD	
  CREDIT_CARD	
  DEPT_MONTH	
  DIR_CP_CD	
  DIR_CP_NM	
  DISSAVINGS	
  DOC_TYPE
  DOD_TYPE
  DODT
  DPT_DAY	
  DPT_TIME
  DST_APX
  DSTDOD
  DTNPOS
  DTN_DI
  EMB_APT_NM	
  EMB_CTY_NM
  EMB_CNTRY_CODE
  EMP_ID
  COUNTRY_CODE	
  EMB_CTY_CD
  EX_RF_FLAG
  EXCHGS	
  EX_FEE
  FARE_BAS	
  FARE_PAID	
  FLIGHT	
  GROSS_DSAVE	
  GROSS_FARE	
  GROUP_CODE
  GSA_GTR	
  INT_CODE	
  INVOICE_NUM
  KB_LVL1	
  LEVEL_DESC	
  LEVEL1	
  LEVEL2	
  LEVEL3	
  LEVEL4
  LEVEL5
  MIR_TYPE	
  MRK_TKT_CNT	
  ND_CITY_NM	
  NET_TKT_CNT	
  NET_TKT_CNT1	
  NEW_ADV_PURCH	
  NEW_SEG_COUNT	
  NEW_SEG_DISC	
  NEW_SEG_MILES	
  NOREF_SEG_COUNT
  NRFLAG
  ORG_APX
  PASSNGR_NAME	
  PNR_LOCATOR	
  REF_E_CNT
  REF_EXCH_CNT	
  REFEXCH	
  REFUSAL_DESC	
  REFUSE_CODE	
  REFUSE_KEY
  RNDT_FLAG
  RTE_APT_NM
  RTE_CNTRY_CODE
  RTE_CTY_NM	
  RTE_CTY_CD	
  SALES_FLAG
  SAVINGS	
  SEG_AMT	
  SEG_COUNT	
  SEG_DESIG	
  SEG_DISCOUNT	
  SEG_LOWEST	
  SEG_MILES	
  SEG_NBR	
  SEG_STANDARD	
  SEG_TAX	
  SHUTTLE
  STAY	
  TICKET_BRANCH	
  TKT_AMOUNT
  TKT_CL_CAT
  TKT_NUM	
  TKT_PURCH
  TKT_RET_DATE
  TKT_SORT	
  TOT_LEN2
  TKT_TYPE
  TKT_TYPE_DSC
  TOUR_CODE	
  TRAN_MONTH
  TRAN_YR
  TRIP_LENGTH	
  TRIP_PURPOSE
  TRN_DATE
  UPCOST	
  VAL_AIRLINE	
  VAL_ALNM
  VOID_DATE
  XARR_DT	
  XDPT_DT
  XFST_DPT
  XPSNGR_NM 
  XTRAN_DT
BY TKT_DATE
ON TABLE HOLD AS AFILE FORMAT FOCUS INDEX TKT_DATE
END
-RUN


-* Global Reporting JOIN
JOIN AFILE.TKT_DATE IN AFILE TO GLOBAL.DATE IN GLOBAL AS J1  
    
  
DEFINE FILE AFILE
NAMEC/A30 = CNAME;
  
-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
  CURR1X/D20.6 = 1 / USDPU ;
  
-* DEFINES ON PREVIOUS DEFINES
  PAID_FAREX/D20.6 = FARE_PAID * CURR1X;
  
-* DEFINES ON PREVIOUSLY DEFINES DEFINES
  
  PAID_FARE1/D20.6C = PAID_FAREX;
END
-RUN
  
  TABLE FILE AFILE
  PRINT ADDCOLLECT
     ADIR_ALL
     AGENT_NUM	
     AIR_KEY	
     INTL_DOM	
     AIRLINE	
     AIRLINE_FEE	
     AIRLINE_NAME
     AL_TNUM
     AR_BRANCH
     ARR_DAY	
     ARR_TIME
     AROLL_DSC3
     AROLL_LEV2
     AROLL_LEV4
     AUX_NON_MIR	
     BASE_FARE	
     BOOK_DT	
     BR_CL_IDX	
     C_ITIN
     CARD_NUM	
     CARD_NUM1	
     CARD1_NUM
     CASH_CREDIT	
     CCARD	
     CCARD1	
     CCARD2	
     CCARD3	
     CCARD5
     EMB_APT_CD	
     RTE_APT_CD
     CL_CAT	
     CLASS	
     CLASS_CAT	
     CLIENT_NAME
     CLIENT_NUM	
     COM_AMT	
     CRD_CRD	
     CREDIT_CARD	
     DEPT_MONTH	
     DIR_CP_CD	
     DIR_CP_NM	
     DISSAVINGS	
     DOC_TYPE
     DOD_TYPE
     DODT
     DPT_DAY	
     DPT_TIME	
     DST_APX
     DSTDOD
     DTNPOS
     DTN_DI
     EMB_APT_NM	
     EMB_CTY_NM	
     EMP_ID
     COUNTRY_CODE	
     EMB_CTY_CD	
     EMB_CNTRY_CODE
     EX_RF_FLAG
     EXCHGS	
     EX_FEE
     FARE_BAS	
     FARE_PAID	
     FLIGHT	
     GROSS_DSAVE	
     GROSS_FARE	
     GROUP_CODE
     GSA_GTR	
     INT_CODE	
     INVOICE_NUM
     KB_LVL1	
     LEVEL_DESC	
     LEVEL1	
     LEVEL2	
     LEVEL3	
     LEVEL4
     LEVEL5
     MIR_TYPE	
     MRK_TKT_CNT	
     ND_CITY_NM	
     NET_TKT_CNT	
     NET_TKT_CNT1	
     NEW_ADV_PURCH	
     NEW_SEG_COUNT	
     NEW_SEG_DISC	
     NEW_SEG_MILES	
     NOREF_SEG_COUNT
     NRFLAG
     ORG_APX
     PASSNGR_NAME	
     PNR_LOCATOR	
     REF_E_CNT	
     REF_EXCH_CNT	
     REFEXCH	
     REFUSAL_DESC	
     REFUSE_CODE	
     REFUSE_KEY 
     RNDT_FLAG
     RTE_APT_NM
     RTE_CNTRY_CODE
     RTE_CTY_NM	
     RTE_CTY_CD	
     SALES_FLAG
     SAVINGS	
     SEG_AMT	
     SEG_COUNT	
     SEG_DESIG	
     SEG_DISCOUNT	
     SEG_LOWEST	
     SEG_MILES	
     SEG_NBR	
     SEG_STANDARD	
     SEG_TAX	
     SHUTTLE
     STAY	
     TICKET_BRANCH	
     TKT_AMOUNT
     TKT_CL_CAT
     TKT_DATE
     TKT_PURCH
     TKT_RET_DATE
     TKT_SORT	
     TKT_TYPE
     TKT_TYPE_DSC
     TOT_LEN2
     TOUR_CODE	
     TRAN_MONTH	
     TRAN_YR
     TRIP_LENGTH
     TRIP_PURPOSE
     TRN_DATE
     UPCOST	
     VAL_AIRLINE
     VAL_ALNM
     VOID_DATE	
     XARR_DT	
     XDPT_DT
     XFST_DPT
     XPSNGR_NM
     XTRAN_DT
     NAMEC
     PAID_FARE1/D16.2CS   
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
BY TKT_NUM
ON TABLE HOLD AS RPTHLD
END
-RUN

-GOTO SKIPthisStep;
-*-INCLUDE HIGHCLS
-*-RUN

MATCH FILE RPTHLD
  PRINT ADDCOLLECT
     ADIR_ALL
     AGENT_NUM	
     AIR_KEY	
     INTL_DOM	
     AIRLINE	
     AIRLINE_FEE	
     AIRLINE_NAME
     AL_TNUM
     AR_BRANCH
     ARR_DAY	
     ARR_TIME
     AROLL_DSC3
     AROLL_LEV2
     AROLL_LEV4
     AUX_NON_MIR	
     BASE_FARE	
     BOOK_DT	
     BR_CL_IDX	
     C_ITIN
     CARD_NUM	
     CARD_NUM1	
     CARD1_NUM
     CASH_CREDIT	
     CCARD	
     CCARD1	
     CCARD2	
     CCARD3	
     CCARD5
     EMB_APT_CD	
     RTE_APT_CD
     CL_CAT	
     CLASS	
     CLASS_CAT	
     CLIENT_NAME
     CLIENT_NUM	
     COM_AMT	
     CRD_CRD	
     CREDIT_CARD	
     DEPT_MONTH	
     DIR_CP_CD	
     DIR_CP_NM	
     DISSAVINGS	
     DOC_TYPE
     DODT
     DOD_TYPE	
     DPT_DAY	
     DPT_TIME	
     DST_APX
     DSTDOD
     DTNPOS
     DTN_DI
     EMB_APT_NM	
     EMB_CTY_NM	
     EMB_CNTRY_CODE
     COUNTRY_CODE	
     EMB_CTY_CD
     EMP_ID
     EX_RF_FLAG
     EXCHGS	
     EX_FEE
     FARE_BAS	
     FARE_PAID	
     FLIGHT	
     GROSS_DSAVE	
     GROSS_FARE	
     GROUP_CODE
     GSA_GTR	
     INT_CODE	
     INVOICE_NUM
     KB_LVL1	
     LEVEL_DESC	
     LEVEL1	
     LEVEL2	
     LEVEL3	
     LEVEL4
     LEVEL5
     MIR_TYPE	
     MRK_TKT_CNT	
     ND_CITY_NM	
     NET_TKT_CNT	
     NET_TKT_CNT1	
     NEW_ADV_PURCH	
     NEW_SEG_COUNT	
     NEW_SEG_DISC	
     NEW_SEG_MILES	
     NOREF_SEG_COUNT
     NRFLAG
     ORG_APX
     PASSNGR_NAME	
     PNR_LOCATOR	
     REF_E_CNT	
     REF_EXCH_CNT	
     REFEXCH	
     REFUSAL_DESC	
     REFUSE_CODE	
     REFUSE_KEY  
     RNDT_FLAG
     RTE_APT_NM	
     RTE_CTY_NM	
     RTE_CTY_CD	
     RTE_CNTRY_CODE
     SALES_FLAG
     SAVINGS	
     SEG_AMT	
     SEG_COUNT	
     SEG_DESIG	
     SEG_DISCOUNT	
     SEG_LOWEST	
     SEG_MILES	
     SEG_NBR	
     SEG_STANDARD	
     SEG_TAX	
     SHUTTLE
     STAY	
     TICKET_BRANCH	
     TKT_AMOUNT
     TKT_CL_CAT
     TKT_DATE
     TKT_PURCH
     TKT_RET_DATE
     TKT_SORT	
     TKT_TYPE
     TKT_TYPE_DSC
     TOT_LEN2
     TOUR_CODE	
     TRAN_MONTH
     TRAN_YR
     TRIP_LENGTH
     TRIP_PURPOSE
     TRN_DATE
     UPCOST	
     VAL_AIRLINE
     VAL_ALNM
     VOID_DATE	
     XARR_DT	
     XDPT_DT
     XFST_DPT
     XPSNGR_NM
     XTRAN_DT
     NAMEC
     PAID_FARE1 
BY TKT_NUM
ON TABLE HOLD
RUN
FILE XSEVEN
SUM FARE_BAS1 CL_CAT1 FAR_BAS2 CL_CAT2 FAR_BAS3 CL_CAT3 FAR_BAS4 CL_CAT4 FAR_BAS5 CL_CAT5 FAR_BAS6 CL_CAT6 FAR_BAS7 CL_CAT7 FAR_BAS8 CL_CAT8
BY TKT_NUM
AFTER MATCH HOLD AS HLD2 OLD-OR-NEW
END
-RUN

-SKIPthisStep;
DEFINE FILE RPTHLD
-*HIGH_CAT/A1 = IF CL_CAT1 EQ 'F' OR CL_CAT2 EQ 'F' OR CL_CAT3 EQ 'F' OR CL_CAT4 EQ 'F' OR 
-*                 CL_CAT5 EQ 'F' OR CL_CAT6 EQ 'F' OR CL_CAT7 EQ 'F' OR CL_CAT8 EQ 'F' THEN 'F' ELSE
-*              IF CL_CAT1 EQ 'B' OR CL_CAT2 EQ 'B' OR CL_CAT3 EQ 'B' OR CL_CAT4 EQ 'B' OR 
-*                 CL_CAT5 EQ 'B' OR CL_CAT6 EQ 'B' OR CL_CAT7 EQ 'B' OR CL_CAT8 EQ 'B' THEN 'B' ELSE
-*              IF CL_CAT1 EQ 'C' OR CL_CAT2 EQ 'C' OR CL_CAT3 EQ 'C' OR CL_CAT4 EQ 'C' OR 
-*                 CL_CAT5 EQ 'C' OR CL_CAT6 EQ 'C' OR CL_CAT7 EQ 'C' OR CL_CAT8 EQ 'C' THEN 'C' ELSE 'D'; 
HIGH_CAT/A1 = IF TKT_CL_CAT EQ 'F'  THEN 'F' ELSE
              IF TKT_CL_CAT EQ 'B'  THEN 'B' ELSE
              IF TKT_CL_CAT EQ 'P'  THEN 'P' ELSE 
              IF TKT_CL_CAT EQ 'U'  THEN 'U' ELSE 
              IF TKT_CL_CAT EQ 'E'  THEN 'E' ELSE 'D';
              
-*CAT/A8 = DECODE HIGH_CAT ('F' 'FIRST'     'C' 'COACH'   
-*                          'D' 'DISCOUNT'  'B' 'BUSINESS');
CAT/A15 = DECODE CL_CAT ('F' 'FIRST'     'P' 'PREMIUM ECONOMY'   
			        'D' 'DEFAULT'   'B' 'BUSINESS'
			        'E' 'ECONOMY'   'U'  'UPGRADE' );
END                               
TABLE FILE RPTHLD
  PRINT ADDCOLLECT
     ADIR_ALL
     AGENT_NUM	
     AIR_KEY	
     INTL_DOM	
     AIRLINE	
     AIRLINE_FEE	
     AIRLINE_NAME
     AL_TNUM
     AR_BRANCH
     ARR_DAY	
     ARR_TIME
     AROLL_DSC3
     AROLL_LEV2
     AROLL_LEV4
     AUX_NON_MIR	
     BASE_FARE	
     BOOK_DT	
     BR_CL_IDX	
     C_ITIN
     CARD_NUM	
     CARD_NUM1	
     CARD1_NUM
     CASH_CREDIT	
     CCARD	
     CCARD1	
     CCARD2	
     CCARD3	
     CCARD5
     EMB_APT_CD	
     RTE_APT_CD
     CL_CAT	
     CLASS	
     CLASS_CAT	
     CLIENT_NAME
     CLIENT_NUM	
     COM_AMT	
     CRD_CRD	
     CREDIT_CARD	
     DEPT_MONTH	
     DIR_CP_CD	
     DIR_CP_NM	
     DISSAVINGS	
     DOC_TYPE
     DODT
     DOD_TYPE	
     DPT_DAY	
     DPT_TIME	
     DST_APX
     DSTDOD
     DTNPOS
     DTN_DI
     EMB_APT_NM	
     EMB_CTY_NM	
     EMB_CNTRY_CODE
     EMP_ID
     COUNTRY_CODE	
     EMB_CTY_CD	
     EX_RF_FLAG
     EXCHGS	
     EX_FEE
     FARE_BAS	
     FARE_PAID	
     FLIGHT	
     GROSS_DSAVE	
     GROSS_FARE	
     GROUP_CODE
     GSA_GTR
     HIGH_CAT
     INT_CODE	
     INVOICE_NUM
     KB_LVL1	
     LEVEL_DESC	
     LEVEL1	
     LEVEL2	
     LEVEL3	
     LEVEL4
     LEVEL5
     MIR_TYPE	
     MRK_TKT_CNT	
     ND_CITY_NM	
     NET_TKT_CNT	
     NET_TKT_CNT1	
     NEW_ADV_PURCH	
     NEW_SEG_COUNT	
     NEW_SEG_DISC	
     NEW_SEG_MILES	
     NOREF_SEG_COUNT
     NRFLAG
     ORG_APX
     PASSNGR_NAME	
     PNR_LOCATOR	
     REF_E_CNT	
     REF_EXCH_CNT	
     REFEXCH	
     REFUSAL_DESC	
     REFUSE_CODE	
     REFUSE_KEY   
     RNDT_FLAG
     RTE_APT_NM	
     RTE_CTY_NM	
     RTE_CTY_CD
     RTE_CNTRY_CODE
     SALES_FLAG
     SAVINGS	
     SEG_AMT	
     SEG_COUNT	
     SEG_DESIG	
     SEG_DISCOUNT	
     SEG_LOWEST	
     SEG_MILES	
     SEG_NBR	
     SEG_STANDARD	
     SEG_TAX	
     SHUTTLE
     STAY	
     TICKET_BRANCH	
     TKT_AMOUNT
     TKT_CL_CAT
     TKT_DATE
     TKT_PURCH
     TKT_RET_DATE
     TKT_SORT	
     TKT_TYPE	
     TKT_TYPE_DSC
     TOT_LEN2
     TOUR_CODE	
     TRAN_MONTH	
     TRAN_YR
     TRIP_LENGTH
     TRIP_PURPOSE
     TRN_DATE
     UPCOST	
     VAL_AIRLINE
     VAL_ALNM
     VOID_DATE	
     XARR_DT	
     XDPT_DT
     XFST_DPT
     XPSNGR_NM
     XTRAN_DT
     NAMEC
     PAID_FARE1 
     CAT
BY TKT_NUM
ON TABLE HOLD AS AFILE2
END
-RUN
 
