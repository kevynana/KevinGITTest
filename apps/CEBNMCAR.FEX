-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* 4/9/13 - DEB - CHANGED TO RUN BY INVOICE_DATE OR PICKUP_DATE
-* File CVIEW1EX.FEX
-*8/29/13 - DEB COMMENTED OUT FIRST 6 &&WHERE STATEMENTS
-*2/5/14 Updated the bookings define to use num_days instead of daily_rate - JK
-*8/18/14 Worked with the hold file to narrow down error - JK
-* 09/29/16 - DLV - S-25275 - Added EMP_ID changed sort when used for employee number
-*  10/05/2016  REJ  S-24432 ER5 Testing updates.
-*  12/29/2016  REJ  S-28553 Move ER5 My Reports to production.
-*  01/24/2017  DLV  S-29648 - Added code for date selection when not in ER5
-* 03/16/2017 - DLV - S-31206 Added CURRENT PRIOR to extract and added WHERE CURRENT EQ 'Y'
-*                            to all hold files following extract so prior date
-*                            range numbers are not included 
-********************************************************************
 
-SET &CDTDESC = IF &&DATETYPE EQ 'I' THEN 'INVOICE_DATE' ELSE 'PICKUP_DATE';
 
 
 
-* MODIFICAIONS:
-*SET &ECHO=ALL;
SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN
-INCLUDE SETECHO
 
-DEFAULT &&CARDATA = 'Y';
 
DEFINE FILE &&EXTRACT
  FIELD/A5 = 'BLANK';
BOOKINGS/D12 = IF NUM_DAYS GT 0 THEN 1 ELSE IF NUM_DAYS LT 0 THEN (-1) ELSE 0;
  LEVEL_DESC/A60 = &&LDESC;
  NBR_DAYS/D12S = NUM_DAYS;
  RENTAL_DAYS/D12S = IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                   ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;
  TRAN_MY/MTYY = INVOICE_DATE;
-* ****DEFINES ON PREVIOUS DEFINES****
  CMPBOOK/D12S = IF (DAILY_RATE GE 0) AND
                  (CAR_CAT EQ 'COMPACT') THEN 1
                  ELSE IF (DAILY_RATE LT 0) AND
                  (CAR_CAT EQ 'COMPACT') THEN (-1) ELSE 0;
  CMPAMT/D12S = IF (CAR_CAT EQ 'COMPACT') THEN RENTAL_AMT ELSE 0;
  CMPDAYS/D12S = IF (CAR_CAT EQ 'COMPACT') THEN RENTAL_DAYS ELSE 0;
 
  NOCMP_DAYS/D12S = IF (CAR_CAT NE 'COMPACT') THEN RENTAL_DAYS ELSE 0;
  MIDAMT/D12S = IF (CAR_CAT EQ 'INTERMEDIATE' OR 'MIDSIZE' OR 'ECONOMY'
                     OR 'COMPACT') THEN RENTAL_AMT ELSE 0;
  MIDDAYS/D12S = IF (CAR_CAT EQ 'INTERMEDIATE' OR 'MIDSIZE' OR 'ECONOMY'
                     OR 'COMPACT') THEN RENTAL_DAYS ELSE 0;
 
  NOMID_DAYS/D12S = IF (CAR_CAT NE 'INTERMEDIATE' OR 'MIDSIZE' OR 'ECONOMY'
                   OR 'COMPACT') THEN RENTAL_DAYS ELSE 0;
  XPSNGR_NM/A15        =
    EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  FLAG/A1 = 'C';

-IF &&FROMER5 EQ 'Y' THEN GOTO :ER5_CURPRC;
CURRENT/A1 = IF &CDTDESC GE '&&FROMDT.EVAL' AND 
                   &CDTDESC LE '&&TODT.EVAL' THEN 'Y' ELSE 'N';
PRIOR/A1 = IF &CDTDESC GE '&&FXDATE.EVAL' AND 
                  &CDTDESC LE '&&TXDATE.EVAL' THEN 'Y' ELSE 'N';
-GOTO SKIP:ER5_CURPRC;
-:ER5_CURPRC;
CURRENT/A1 = IF &CDTDESC GE &&FROMDT.EVAL AND 
                   &CDTDESC LE &&TODT.EVAL THEN 'Y' ELSE 'N';
PRIOR/A1 = IF &CDTDESC GE &&FXDATE.EVAL AND 
                  &CDTDESC LE &&TXDATE.EVAL THEN 'Y' ELSE 'N';
-SKIP:ER5_CURPRC;                          

END
-RUN
 
-IF '&&SETF.EVAL' EQ 'BDBNMPX3' GOTO 'BDBNMPX3';
 
TABLEF FILE &&EXTRACT
PRINT AROLL_DSC3
  BOOKINGS
  BR_CL_IDX
  CAR_CAT
  CAR_DESC
  CAR_KEY
  CAR_RATE
  CAR_TYPE
  CATEGORY
  DAILY_RATE
  EMP_ID
  FIELD
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  CMPBOOK
  CMPAMT
  CMPDAY
  MIDAMT
  MIDDAYS
  NOMID_DAYS
  NOCMP_DAYS
  NBR_DAYS
  PASSNGR_NAME
  RENTAL_AMT
  RENTAL_DAYS
  TRAN_MY
  XPSNGR_NM
  CURRENT 
  PRIOR
-IF &&FROMER5 EQ 'Y' THEN GOTO :ER5_DATE;
WHERE (&CDTDESC GE '&&FROMDT.EVAL') AND (&CDTDESC LE '&&TODT.EVAL') OR
      (&CDTDESC GE '&&FXDATE.EVAL') AND (&CDTDESC LE '&&TXDATE.EVAL')
-GOTO SKIP_ER5:DATE;
-:ER5_DATE
WHERE (&CDTDESC GE &&FROMDT.EVAL) AND (&CDTDESC LE &&TODT.EVAL) OR
      (&CDTDESC GE &&FXDATE.EVAL) AND (&CDTDESC LE &&TXDATE.EVAL)
-SKIP_ER5:DATE 
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-*&&WHERE1
-*&&WHERE2
-*&&WHERE3
-*&&WHERE4
-*&&WHERE5
-*&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
-* &&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS CARHOLD
END
-RUN
 
 
-IF &RECORDS EQ 0 THEN GOTO NOCAR ELSE GOTO Continuec;
-NOCAR;
-SET &&CARDATA = 'N';
-RUN
 
-Continuec;
-IF '&&SETF.EVAL' EQ 'CEBNMPX1' THEN GOTO CERNSET;
-IF '&&SETF.EVAL' EQ 'CEBNMPX' THEN GOTO EMPonly;
-IF '&&SETF.EVAL' EQ 'BDBNMPX2' THEN GOTO NonStandard;
-IF '&&SETF.EVAL' NE 'ARBNMPX'  THEN GOTO Standard;
 
 
-SET &SORT1 = 'BY PASSNGR_NAME';
-SET &SORT2 = ' ';
-GOTO SETdone;
 
-NonStandard
-SET &SORT1 = 'BY EMP_ID';
-SET &SORT2 = 'BY XPSNGR_NM';
-GOTO SETdone;
 
-Standard
 
-SET &SORT1 = 'BY EMP_ID';
-SET &SORT2 = 'BY PASSNGR_NAME ';
-GOTO SETdone;
 
 
-CERNSET;
-SET &SORT1 = 'BY PASSNGR_NAME';
-SET &SORT2 = 'BY EMP_ID';
-GOTO SETdone;
 
-EMPonly;
-SET &SORT1 = 'BY EMP_ID';
-SET &SORT2 = ' ';
 
-SETdone
 
 
 
 
TABLE FILE CARHOLD
PRINT AROLL_DSC3
  BOOKINGS
  CAR_DESC
  CAR_KEY
  CAR_RATE
  CAR_TYPE
  DAILY_RATE
  EMP_ID
  FIELD
  LEVEL_DESC
  CMPAMT
  CMPBOOK
  CMPDAYS
  MIDAMT
  MIDDAYS
  NOMID_DAYS
  NOCMP_DAYS
  NBR_DAYS
  PASSNGR_NAME
  RENTAL_AMT
  RENTAL_DAYS
  LEVEL1
&SORT1
&SORT2
WHERE CURRENT EQ 'Y'
ON TABLE HOLD AS CARTWO
END
-RUN
 
DEFINE FILE CARTWO
CRENTAL/D12S = RENTAL_DAYS ;
CNOCMP_DAYS/D12S = NOCMP_DAYS;
CNOMID_DAYS/D12S = NOMID_DAYS;
 
CRENTALA/D12.2CS = RENTAL_AMT ;
CRENTALD/D12 = CMPDAYS;
END
TABLE FILE CARTWO
SUM CRENTAL
    CRENTALA
    CNOCMP_DAYS
    CNOMID_DAYS
    FIELD
    LEVEL1
    PASSNGR_NAME
COMPUTE PCTNOCMP/P12.2 = IF ((CRENTAL LT 1) AND (CRENTAL GT (-1))) THEN 0 ELSE
                            ((CNOCMP_DAYS/CRENTAL)*100);
COMPUTE PCTNOMID/P12.2 = IF ((CRENTAL LT 1) AND (CRENTAL GT (-1))) THEN 0 ELSE
                            ((CNOMID_DAYS/CRENTAL)*100);
COMPUTE AVGCAR/D12.2CS = IF ((CRENTAL LT 1) AND (CRENTAL GT (-1))) THEN 0
                         ELSE (CRENTALA/CRENTAL);
&SORT1
&SORT2
-IF '&&SETF.EVAL' EQ 'CEBNMPX1' OR 'ARBNMPX' GOTO NXJN;
ON TABLE HOLD AS CARTHREE FORMAT FOCUS INDEX EMP_ID
-GOTO SKJ
-NXJN;
ON TABLE HOLD AS CARTHREE FORMAT FOCUS INDEX PASSNGR_NAME
-SKJ;
END
-RUN
 
 
 
 
-GOTO XXITC;
 
-BDBNMPX3;
 
TABLEF FILE &&EXTRACT
PRINT AROLL_DSC3
  BOOKINGS
  BR_CL_IDX
  CAR_CAT
  CAR_DESC
  CAR_KEY
  CAR_RATE
  CAR_TYPE
  CATEGORY
  DAILY_RATE
  EMP_ID
  FIELD
  FLAG
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  CMPBOOK
  CMPAMT
  CMPDAY
  MIDAMT
  MIDDAYS
  NOMID_DAYS
  NOCMP_DAYS
  NBR_DAYS
  PASSNGR_NAME
  RENTAL_AMT
  RENTAL_DAYS
  TRAN_MY
  XPSNGR_NM
-IF &&FROMER5 EQ 'Y' THEN GOTO :ER5_CDATE;
WHERE (&CDTDESC GE '&&FROMDT.EVAL') AND (&CDTDESC LE '&&TODT.EVAL')

-GOTO SKIP:ER5_CDATE
-:ER5_CDATE; 
WHERE (&CDTDESC GE &&FROMDT.EVAL) AND (&CDTDESC LE &&TODT.EVAL)
-SKIP:ER5_CDATE; 
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
-* &&WHERE10
 
-INCLUDE RPTPARMS
ON TABLE HOLD AS CARHOLD1
END
-RUN
 
TABLE FILE CARHOLD1
PRINT AROLL_DSC3
  BOOKINGS
  BR_CL_IDX
  CAR_CAT
  CAR_DESC
  CAR_KEY
  CAR_RATE
  CAR_TYPE
  CATEGORY
  DAILY_RATE
  EMP_ID
  FIELD
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  CMPBOOK
  CMPAMT
  CMPDAY
  MIDAMT
  MIDDAYS
  NOMID_DAYS
  NOCMP_DAYS
  NBR_DAYS
  PASSNGR_NAME
  RENTAL_AMT
  RENTAL_DAYS
  TRAN_MY
  XPSNGR_NM
BY FLAG
ON TABLE HOLD AS CARHOLDA
END
-RUN
 
DEFINE FILE &&EXTRACT ADD
TRENTAL/D12S = RENTAL_DAYS;
TRENTALA/D12.2CSM = RENTAL_AMT ;
END
-RUN
TABLE FILE &&EXTRACT
SUM TRENTAL TRENTALA
BY FLAG
BY AROLL_DSC2
-IF &&FROMER5 EQ 'Y' THEN GOTO :ER5_CDATE2;
WHERE (&CDTDESC GE '&&FROMDT.EVAL') AND (&CDTDESC LE '&&TODT.EVAL')
-GOTO SKIP:ER5_CDATE2
-:ER5_CDATE2; 
WHERE (&CDTDESC GE &&FROMDT.EVAL) AND (&CDTDESC LE &&TODT.EVAL)
-SKIP:ER5_CDATE2; 
-*WHERE (INVOICE_DATE GE '&&FROMDT.EVAL') AND (INVOICE_DATE LE '&&TODT.EVAL')
-* WHERE AROLL_LEV2 EQ 'BAIR'
WHERE CATEGORY EQ 'BUSINESS'
ON TABLE HOLD AS TCHLD
END
-RUN


 

DEFINE FILE CARHOLDA
SRENTAL/D12S = RENTAL_DAYS;
SRENTALA/D12.2CSM = RENTAL_AMT;
END
-RUN
TABLE FILE CARHOLDA
SUM SRENTAL SRENTALA
BY FLAG
BY LEVEL_DESC
WHERE CATEGORY EQ 'BUSINESS'
ON TABLE HOLD AS SCHLD
END
-RUN
 
MATCH FILE SCHLD
SUM SRENTAL SRENTALA
BY FLAG
ON TABLE HOLD
RUN
FILE TCHLD
SUM TRENTAL TRENTALA
BY FLAG
AFTER MATCH HOLD AS STHLD OLD-OR-NEW
END
-RUN


 

MATCH FILE CARHOLDA
PRINT AROLL_DSC3
  BOOKINGS
  BR_CL_IDX
  CAR_CAT
  CAR_DESC
  CAR_KEY
  CAR_RATE
  CAR_TYPE
  DAILY_RATE
  EMP_ID
  FIELD
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  CMPBOOK
  CMPAMT
  CMPDAY
  MIDAMT
  MIDDAYS
  NOMID_DAYS
  NOCMP_DAYS
  NBR_DAYS
  PASSNGR_NAME
  RENTAL_AMT
  RENTAL_DAYS
  TRAN_MY
  XPSNGR_NM
BY FLAG
ON TABLE HOLD
RUN
FILE STHLD
SUM SRENTAL SRENTALA TRENTAL TRENTALA
BY FLAG
AFTER MATCH HOLD AS CARHOLD OLD
END
-RUN
 
 

 
-SET &&IDXFIELD='EMP_ID';
-SET &SORT1='BY EMP_ID';
-SET &SORT2='BY PASSNGR_NAME';
 
TABLE FILE CARHOLD
PRINT AROLL_DSC3
  BOOKINGS
  CAR_DESC
  CAR_KEY
  CAR_RATE
  CAR_TYPE
  DAILY_RATE
  EMP_ID
  FIELD
  LEVEL_DESC
  CMPAMT
  CMPBOOK
  CMPDAYS
  MIDAMT
  MIDDAYS
  NOMID_DAYS
  NOCMP_DAYS
  NBR_DAYS
  PASSNGR_NAME
  RENTAL_AMT
  RENTAL_DAYS
  LEVEL1
  SRENTAL
  SRENTALA
  TRENTAL
  TRENTALA
&SORT1
&SORT2
ON TABLE HOLD AS CARTWO
END
-RUN

DEFINE FILE CARTWO
CRENTAL/D12S = RENTAL_DAYS ;
CNOCMP_DAYS/D12S = NOCMP_DAYS;
CNOMID_DAYS/D12S = NOMID_DAYS;
 
CRENTALA/D12.2CS = RENTAL_AMT ;
CRENTALD/D12 = CMPDAYS;
END
TABLE FILE CARTWO
SUM CRENTAL
    CRENTALA
    CNOCMP_DAYS
    CNOMID_DAYS
    FIELD
    LEVEL1
    LEVEL_DESC
    PASSNGR_NAME
COMPUTE PCTNOCMP/P12.2 = IF ((CRENTAL LT 1) AND (CRENTAL GT (-1))) THEN 0 ELSE
                            ((CNOCMP_DAYS/CRENTAL)*100);
COMPUTE PCTNOMID/P12.2 = IF ((CRENTAL LT 1) AND (CRENTAL GT (-1))) THEN 0 ELSE
                            ((CNOMID_DAYS/CRENTAL)*100);
COMPUTE AVGCAR/D12.2CSM = IF ((CRENTAL LT 1) AND (CRENTAL GT (-1))) THEN 0
                         ELSE (CRENTALA/CRENTAL);
COMPUTE SAVGCAR/D12.2CSM = IF ((SRENTAL LT 1) AND (SRENTAL GT (-1))) THEN 0
                         ELSE (SRENTALA/SRENTAL);
COMPUTE TAVGCAR/D12.2CSM = IF ((TRENTAL LT 1) AND (TRENTAL GT (-1))) THEN 0
                         ELSE (TRENTALA/TRENTAL);
&SORT1
-* &SORT2
ON TABLE HOLD AS CARTHREE FORMAT FOCUS INDEX &&IDXFIELD

END
-RUN
 
-GOTO XXITC;
 
 
 
-XXITC;
 
 

 
 
 
 
 
 
 
 
 
 
 
 
 
