-* STEVE - 08/18/2010 - Changed to show voids as a negative fare and lost savings - being backed out  
-*                      Each void will show up two times - once positive and once negative
-* STEVE - 08/24/2010 - Corrected RADV_PURCH define to account for $.00 first segment
-* DEB   - 05/23/2014 - ADDED EX5 TO RADV_PURCH DEFINE
-* ADDED TRANTYPE INCLUDE - JK 12/16/14 STORY ID S-06492

-*********************************************************************************
-INCLUDE SETECHO
SET ASNAMES=ON
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

DEFINE FILE &&EXTRACT
FARE/D12.2 = SEG_AMT + SEG_TAX;
LOST/D12.2 = FARE - SEG_LOWEST;
NEW_ADV_PURCH/D9    = ADV_PURCH;
TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
                          
-INCLUDE TRANTYPE

END
TABLEF FILE &&EXTRACT
PRINT AIR_KEY
      AROLL_DSC1
      AROLL_DSC2
      AROLL_DSC3
      AROLL_DSC4
      AROLL_DSC5
      AROLL_DSC6
      AROLL_DSC7
      AROLL_DSC8
      AROLL_DSC9
      AROLL_DSC10
      AROLL_DSC11
      AROLL_DSC12
      AROLL_DSC13
      AROLL_DSC14
      AROLL_DSC15
      CDIR_ALL
      C_ITIN
      CLASS
      EMBARK
      EX_FLAG
      FARE
      AIR_MAIN.INTL_DOM AS 'INTDOM'
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LOST
      NEW_ADV_PURCH
      NONREF
      PASSNGR_NAME
      REFUSE_CODE
      REFUSAL_DESC
      RF_FLAG
      SEG_COUNT
      SEG_NBR
      TKT_NUM
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      VAL_AIRLINE
      VOID_DATE
-INCLUDE &AIRDATES

-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPT_HOLD
END
-RUN     


TABLE FILE RPT_HOLD
PRINT AIR_KEY VAL_AIRLINE PASSNGR_NAME LEVEL4 TKT_NUM TRN_DATE SEG_COUNT LEVEL1 LEVEL2 
LEVEL3 NONREF REFUSE_CODE REFUSAL_DESC FARE LOST INTDOM CLASS NEW_ADV_PURCH 
 VOID_DATE RF_FLAG EX_FLAG EMBARK TKT_TYPE CDIR_ALL C_ITIN AROLL_DSC1 AROLL_DSC2 AROLL_DSC3 AROLL_DSC4
AROLL_DSC5 AROLL_DSC6 AROLL_DSC7 AROLL_DSC8 AROLL_DSC9 AROLL_DSC10 AROLL_DSC11
AROLL_DSC12 AROLL_DSC13 AROLL_DSC14 AROLL_DSC15
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIR1 
END
-RUN


DEFINE FILE AIR1
CLASS1/A1 = SUBSTR(208, CDIR_ALL, 12, 12, 1, CLASS1);
CLASS2/A1 = SUBSTR(208, CDIR_ALL, 25, 25, 1, CLASS2);
CLASS3/A1 = SUBSTR(208, CDIR_ALL, 38, 38, 1, CLASS3); 
CLASS4/A1 = SUBSTR(208, CDIR_ALL, 51, 51, 1, CLASS4);
CLASS5/A1 = SUBSTR(208, CDIR_ALL, 64, 64, 1, CLASS5);
CLASS6/A1 = SUBSTR(208, CDIR_ALL, 77, 77, 1, CLASS6);
CLASS/A12 = IF CLASS6 NE ' ' THEN CLASS1|'-'|CLASS2|'-'|CLASS3|'-'|CLASS4|'-'|CLASS5|'-'|CLASS6 ELSE 
IF CLASS5 NE ' ' THEN CLASS1|'-'|CLASS2|'-'|CLASS3|'-'|CLASS4|'-'|CLASS5 ELSE 
IF CLASS4 NE ' ' THEN CLASS1|'-'|CLASS2|'-'|CLASS3|'-'|CLASS4 ELSE 
IF CLASS3 NE ' ' THEN CLASS1|'-'|CLASS2|'-'|CLASS3 ELSE
IF CLASS2 NE ' ' THEN CLASS1|'-'|CLASS2 ELSE CLASS1;
RADV_PURCH/I8CS = IF (EMBARK EQ 'FP2' OR 'EX1' OR 'RF1' OR 'EX5') THEN 0 ELSE
                  IF (TKT_TYPE EQ 'P-RF' OR 'P-EX') THEN 0 ELSE 
                  IF (SEG_NBR EQ '00') THEN 0 ELSE         
                 IF (TKT_SORT NE LAST TKT_SORT) AND 
                    (FARE GE 0) THEN NEW_ADV_PURCH ELSE
                 IF (TKT_SORT NE LAST TKT_SORT) AND
                    (FARE LT 0) THEN NEW_ADV_PURCH * (-1) ELSE 0; 
END

TABLE FILE AIR1
SUM AIR_KEY VAL_AIRLINE C_ITIN PASSNGR_NAME LEVEL4 TKT_NUM TRN_DATE LEVEL1 LEVEL2 
LEVEL3 NONREF REFUSE_CODE REFUSAL_DESC FARE LOST INTDOM CLASS RADV_PURCH FARE 
VOID_DATE RF_FLAG EX_FLAG C_ITIN AROLL_DSC1 AROLL_DSC2 AROLL_DSC3 AROLL_DSC4
AROLL_DSC5 AROLL_DSC6 AROLL_DSC7 AROLL_DSC8 AROLL_DSC9 AROLL_DSC10 AROLL_DSC11
AROLL_DSC12 AROLL_DSC13 AROLL_DSC14 AROLL_DSC15
BY TKT_NUM NOPRINT
BY SEG_COUNT NOPRINT
ON TABLE HOLD AS AIR2 FORMAT FOCUS
END
-RUN

-**** VOIDS

TABLE FILE RPT_HOLD
PRINT AIR_KEY VAL_AIRLINE PASSNGR_NAME LEVEL4 TKT_NUM TRN_DATE SEG_COUNT LEVEL1 LEVEL2 
LEVEL3 NONREF REFUSE_CODE REFUSAL_DESC FARE LOST INTDOM CLASS NEW_ADV_PURCH 
VOID_DATE RF_FLAG EX_FLAG EMBARK TKT_TYPE CDIR_ALL C_ITIN AROLL_DSC1 AROLL_DSC2 AROLL_DSC3 AROLL_DSC4
AROLL_DSC5 AROLL_DSC6 AROLL_DSC7 AROLL_DSC8 AROLL_DSC9 AROLL_DSC10 AROLL_DSC11
AROLL_DSC12 AROLL_DSC13 AROLL_DSC14 AROLL_DSC15                     
WHERE VOID_DATE NE 0
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIR3 
END
-RUN

DEFINE FILE AIR3
FARE/D12.2 = FARE*(-1);
LOST/D12.2 = LOST*(-1);
CLASS1/A1 = SUBSTR(208, CDIR_ALL, 12, 12, 1, CLASS1);
CLASS2/A1 = SUBSTR(208, CDIR_ALL, 25, 25, 1, CLASS2);
CLASS3/A1 = SUBSTR(208, CDIR_ALL, 38, 38, 1, CLASS3); 
CLASS4/A1 = SUBSTR(208, CDIR_ALL, 51, 51, 1, CLASS4);
CLASS5/A1 = SUBSTR(208, CDIR_ALL, 64, 64, 1, CLASS5);
CLASS6/A1 = SUBSTR(208, CDIR_ALL, 77, 77, 1, CLASS6);
CLASS/A12 = IF CLASS6 NE ' ' THEN CLASS1|'-'|CLASS2|'-'|CLASS3|'-'|CLASS4|'-'|CLASS5|'-'|CLASS6 ELSE 
IF CLASS5 NE ' ' THEN CLASS1|'-'|CLASS2|'-'|CLASS3|'-'|CLASS4|'-'|CLASS5 ELSE 
IF CLASS4 NE ' ' THEN CLASS1|'-'|CLASS2|'-'|CLASS3|'-'|CLASS4 ELSE 
IF CLASS3 NE ' ' THEN CLASS1|'-'|CLASS2|'-'|CLASS3 ELSE
IF CLASS2 NE ' ' THEN CLASS1|'-'|CLASS2 ELSE CLASS1;
RADV_PURCH/I8CS = IF (EMBARK EQ 'FP2' OR 'EX1' OR 'RF1' OR 'EX5') THEN 0 ELSE
                  IF (TKT_TYPE EQ 'P-RF' OR 'P-EX') THEN 0 ELSE 
                  IF (SEG_NBR EQ '00') THEN 0 ELSE         
                 IF (TKT_SORT NE LAST TKT_SORT) AND 
                    (FARE GE 0) THEN NEW_ADV_PURCH ELSE
                 IF (TKT_SORT NE LAST TKT_SORT) AND
                    (FARE LT 0) THEN NEW_ADV_PURCH * (-1) ELSE 0; 
END

TABLE FILE AIR3
SUM AIR_KEY VAL_AIRLINE C_ITIN PASSNGR_NAME LEVEL4 TKT_NUM TRN_DATE LEVEL1 LEVEL2 
LEVEL3 NONREF REFUSE_CODE REFUSAL_DESC FARE LOST INTDOM CLASS RADV_PURCH FARE 
VOID_DATE RF_FLAG EX_FLAG C_ITIN AROLL_DSC1 AROLL_DSC2 AROLL_DSC3 AROLL_DSC4
AROLL_DSC5 AROLL_DSC6 AROLL_DSC7 AROLL_DSC8 AROLL_DSC9 AROLL_DSC10 AROLL_DSC11
AROLL_DSC12 AROLL_DSC13 AROLL_DSC14 AROLL_DSC15                    
BY TKT_NUM NOPRINT
BY SEG_COUNT NOPRINT
ON TABLE HOLD AS AIR4 FORMAT FOCUS
END


USE
AIR2 AS AIR2
AIR4 AS AIR2
END

-SET &&RPTSUF = 'BZAIRFILE';

-INCLUDE FDEFRPTS
-RUN

DEFINE FILE AIR2
NOWTOD/A8 WITH AIR_KEY = HHMMSS (NOWTOD);
END
-RUN

TABLE FILE AIR2
-INCLUDE HEADAIR
"</2"
PRINT PASSNGR_NAME AS 'Passenger Name' LEVEL4 AS 'Employee ID' TKT_NUM AS 'Ticket Number 
TRN_DATE AS 'Transaction Date' LEVEL1 AS 'Charge Code 1' LEVEL2 AS 'Charge Code 2' 
LEVEL3 AS 'Charge Code 3' VAL_AIRLINE AS 'Validating Carrier' NONREF AS 'Refundable/Non-Refundable' REFUSE_CODE AS 'Reason Code'
REFUSAL_DESC AS 'Reason Code Description' FARE AS 'Fare Paid' LOST AS 'Lost Savings' INTDOM AS 'International/Domestic'
CLASS AS 'Class Category' RADV_PURCH AS 'Advance Purchase' C_ITIN AS 'Itinerary' AROLL_DSC1 AS 'Total Company' 
AROLL_DSC2 AS 'Business/Personal/Leisure' AROLL_DSC3 AS 'Sector' AROLL_DSC4 AS 'Global Group' AROLL_DSC5 AS 'Employee Class'
AROLL_DSC6 AS 'Job Family' AROLL_DSC7 AS 'Grade' AROLL_DSC8 AS 'Job Code' AROLL_DSC9 AS 'CDM' AROLL_DSC10 AS 'Location Description'
AROLL_DSC11 AS 'Professional Alignment' AROLL_DSC12 AS 'Secondary Alignment' AROLL_DSC13 AS 'Other Alignment' AROLL_DSC14 AS 'Department'
AROLL_DSC15 AS 'Responsibility Center'
VOID_DATE AS 'Void Date' RF_FLAG AS 'Refund Flag' EX_FLAG AS 'Exchange Flag'
BY PASSNGR_NAME NOPRINT
BY TKT_NUM NOPRINT
-* ON TABLE SET ONLINE-FMT EXL2K
-INCLUDE FOOTERDT

ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
-INCLUDE &&DTSTY
ENDSTYLE
-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
