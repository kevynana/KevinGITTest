-* File DELDATA.FEX
-* THIS PROGRAM DELETES DATA FOR A CERTAIN TIME PERIOD FROM
-* AIR, CAR, HOTEL, SEGMENT, MARKET, DESTINATION, TKT_MAIN
-*
-* 07/27/15 - DEB - S-10299 COMMENTED OUT SET &ECHO=ALL

-*-SET &ECHO=ALL

-SET &&QTR = '2';


-* -GOTO STOP

COPY D:\TNT\TTRACKER\SUDATA\ROLLUP.* D:\STEVE\PURGE\NEW\
END


USE
D:\STEVE\PURGE\NEW\ROLLUP.FOC AS ROLLUP
END

TABLE FILE ROLLUP
PRINT ROLLUP PR_STAMP
BY ROLLUP NOPRINT
ON TABLE HOLD
END
-RUN

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP=' ';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END

TABLE FILE ROLLUP
PRINT ROLLUP
      PR_STAMP
      COMP
BY ROLLUP NOPRINT
WHERE UPD_ENABLE EQ 'X'
WHERE QTR_ENABLE EQ 'X'
WHERE ROLLUP NE 'TOTAL-R'
WHERE ROLLUP NE 'USG-R'
ON TABLE HOLD
END
-RUN

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP='W';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END

-PRGLOOP
USE
D:\STEVE\PURGE\NEW\ROLLUP.FOC AS ROLLUP
END

TABLE FILE ROLLUP
PRINT ROLLUP COMP
BY ROLLUP NOPRINT
-* WHERE RECORDLIMIT EQ 1
WHERE PR_STAMP EQ 'W'
ON TABLE SAVE AS CUSTS
END
-RUN


-IF &RECORDS EQ 0 GOTO STOP;
-RUN
-READ CUSTS &&ROLLUP.A8 &&COMP.A6.
-RUN

-SET &&COPYF = 'D:\TNT\TTRACKER\DATA\*'||&&QTR||&&COMP|||'.FOC';
-SET &&COPYM = 'D:\TNT\TTRACKER\DATA\*'||&&QTR||&&COMP|||'.MAS';
-* -SET &&COPYOLD = 'D:\STEVE\PURGE\OLD\';
-SET &&COPYNEW = 'D:\STEVE\PURGE\NEW\';

-* COPY &&COPYF &&COPYOLD
-* COPY &&COPYM &&COPYOLD
COPY &&COPYF &&COPYNEW
COPY &&COPYM &&COPYNEW

TABLE FILE ROLLUP
PRINT ROLLUP
      PR_STAMP
BY ROLLUP NOPRINT
WHERE ROLLUP EQ '&&ROLLUP'
ON TABLE HOLD
END
MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP='Z';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN


-SET &&PRGSEG = 'D:\STEVE\PURGE\NEW\'||'S' || &&QTR || &&COMP;
-SET &&PRGMKT = 'D:\STEVE\PURGE\NEW\'||'M' || &&QTR || &&COMP;
-SET &&PRGDST = 'D:\STEVE\PURGE\NEW\'||'D' || &&QTR || &&COMP;
-SET &&PRGAIR = 'D:\STEVE\PURGE\NEW\'||'A' || &&QTR || &&COMP;
-SET &&PRGCAR = 'D:\STEVE\PURGE\NEW\'||'C' || &&QTR || &&COMP;
-SET &&PRGHTL = 'D:\STEVE\PURGE\NEW\'||'H' || &&QTR || &&COMP;
-SET &&PRGTKT = 'D:\STEVE\PURGE\NEW\'||'T' || &&QTR || &&COMP;

-TYPE PRGSEG &&PRGSEG
-TYPE PRGMKT &&PRGMKT
-TYPE PRGDST &&PRGDST
-TYPE PRGAIR &&PRGAIR
-TYPE PRGCAR &&PRGCAR
-TYPE PRGHTL &&PRGHTL
-TYPE PRGTKT &&PRGTKT

SET ASNAMES=ON
DEFINE FILE ROLLUP
XL01/A1 = 'Z' ;
END
TABLE FILE ROLLUP
BY ROLLUP NOPRINT
PRINT ROLLUP AS 'ROLLUP_CODE'
      XL01   AS 'PR_STAMP'
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE HOLD
END
MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
-* -GOTO PRGLOOP
-* -RUN
-*======================================================================

-* -STOP
-* -GOTO XXIT;



TABLE FILE &&PRGAIR
SUM AIR_KEY
BY AIR_KEY NOPRINT
ON TABLE HOLD AS HOLDA
END 


TABLE FILE &&PRGSEG
SUM AIR_KEY
BY AIR_KEY NOPRINT
ON TABLE HOLD AS HOLDS
END 

MATCH FILE HOLDA
PRINT AIR_KEY
BY AIR_KEY NOPRINT
RUN
FILE HOLDS
SUM AIR_KEY
BY AIR_KEY NOPRINT
AFTER MATCH HOLD AS NMATCHD OLD-NOT-NEW
END 

TABLE FILE NMATCHD
PRINT AIR_KEY
BY AIR_KEY 
ON TABLE HOLD AS NMATCHD1
END
-RUN

-* AIR_MAIN
MODIFY FILE &&PRGAIR
FIXFORM FROM NMATCHD1
MATCH AIR_KEY
ON MATCH DELETE
ON NOMATCH REJECT
DATA ON NMATCHD1
END
-RUN

SET ASNAMES=ON
DEFINE FILE ROLLUP
XL01/A1 = 'Z' ;
END
TABLE FILE ROLLUP
BY ROLLUP NOPRINT
PRINT ROLLUP AS 'ROLLUP_CODE'
      XL01   AS 'PR_STAMP'
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE HOLD
END
MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
-GOTO PRGLOOP
-RUN
-*======================================================================

-STOP
-GOTO XXIT

-XXIT
-EXIT
