-* File drilldetail5.fex
-*5/23/14   DEB        ADDED EX5 TO RADV_PURCH DEFINE

-*SET TEMPERASE = OFF
EX USESTEVE
END
-RUN

SET ASNAMES=ON
-RUN

-*******steve***********************
-SET &&LDESC='AROLL_DSC5';

DEFINE FILE SR_50
  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;
  LEVEL_DESC/A60 = &&LDESC;
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  NEW_ADV_PURCH/D9    = ADV_PURCH;
  NEW_SEG_AMT/D12.2CS = SEG_AMT;
  NEW_SEG_TAX/D12.2CS = SEG_TAX;
  NEW_SEG_COUNT/D8CS = SEG_COUNT;
  NEW_SEG_DISC/D12.2CS = SEG_DISC;
  NEW_SEG_MILES/D9= SEG_MILES;
  TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  XDPT_DT/MDYY         = DPT_DATE;
  XPSNGR_NM/A15        = 
    EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;
       
-INCLUDE TRANTYPE  
               
END
TABLEF FILE SR_50
PRINT 
  AIRLINE	
  AIRLINE_NAME	
-******steve********************
  AROLL_LEV5
  ARR_TIME
  CITYPAIR.EMBARK      AS 'EMB_APT_CD'	
  DPT_TIME	
  EMB_APT.AIRPORT_NAME AS 'EMB_APT_NM'
  FARE_PAID	
  LEVEL_DESC	
  NET_TKT_CNT	
  NEW_ADV_PURCH
  PASSNGR_NAME	
  REFUSAL_DESC	
  REFUSE_CODE	
  REFUSE_KEY        	
  RTE_APT.AIRPORT_NAME AS 'RTE_APT_NM'	
  SEG_NBR
  TKT_DATE	
  TKT_NUM
  TKT_SORT	
  TKT_TYPE
  TRN_DATE
  VOID_DATE
  XDPT_DT	
  XPSNGR_NM
  XTRAN_DT
ON TABLE HOLD AS RPTHOLD
END
-RUN

SET ASNAMES=ON
-RUN

TABLE FILE RPTHOLD
SUM FARE_PAID AS 'TFARE'
    NET_TKT_CNT AS 'TTKT'
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS AIRHOLD1
END
-RUN

TABLE FILE RPTHOLD
PRINT AIRLINE	
-*******steve***********************
      AROLL_LEV5
      ARR_TIME
      DPT_TIME
      EMB_APT_CD
      EMB_APT_NM
      FARE_PAID	
      NET_TKT_CNT
      NEW_ADV_PURCH
      PASSNGR_NAME
      REFUSE_CODE	
      RTE_APT_NM
      TKT_NUM
      TKT_TYPE
      VOID_DATE
      XDPT_DT	
      XTRAN_DT
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
BY SEG_NBR
ON TABLE HOLD AS XTWO
END
-RUN

MATCH FILE XTWO
PRINT AIRLINE	
-*******steve***********************
      AROLL_LEV5
      ARR_TIME
      DPT_TIME
      EMB_APT_CD
      EMB_APT_NM
      FARE_PAID	
      NET_TKT_CNT
      NEW_ADV_PURCH
      PASSNGR_NAME
      REFUSE_CODE	
      RTE_APT_NM
      TKT_NUM
      TKT_TYPE	
      VOID_DATE
      XDPT_DT
      XTRAN_DT
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
BY SEG_NBR
ON TABLE HOLD
RUN
FILE AIRHOLD1
PRINT TFARE
      TTKT
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
AFTER MATCH HOLD AS AIRHOLD2 OLD-OR-NEW
END
-RUN

TABLE FILE AIRHOLD2
PRINT AIRLINE	
-*******steve***********************
      AROLL_LEV5
      ARR_TIME
      DPT_TIME
      EMB_APT_CD
      EMB_APT_NM
      FARE_PAID	
      LEVEL_DESC
      NET_TKT_CNT
      NEW_ADV_PURCH
      PASSNGR_NAME
      REFUSE_CODE	
      RTE_APT_NM
      TFARE
      TKT_NUM	
      TKT_TYPE
      TRN_DATE
      TTKT
      VOID_DATE
      XDPT_DT
      XPSNGR_NM
      XTRAN_DT
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD3
END
-RUN

DEFINE FILE AIRHOLD3
-INCLUDE STDTIME

RREFUSE_CODE/A2 = IF TKT_SORT NE LAST TKT_SORT THEN REFUSE_CODE ELSE ' ';
TICKET_NMBR/A10 = IF TKT_NUM NE LAST TKT_NUM THEN TKT_NUM ELSE ' ';
XT_DTE/A8 = EDIT(TRN_DATE);
XTKT_SRT/A10 = EDIT(TKT_SORT,'9999999999$');

-* ****DEFINES ON PREVIOUS DEFINES****
SRT_DT/A100 = TKT_SORT||XT_DTE||LEVEL_DESC||XPSNGR_NM;
FARE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TFARE ELSE 0;

NOWTOD/A8 WITH TKT_SORT = HHMMSS (NOWTOD);
RADV_PURCH/I8CS = IF (EMB_APT_CD EQ 'FP2' OR 'EX1' OR 'RF1' OR 'EX5') THEN 0
  ELSE IF (TKT_TYPE EQ 'P-RF' OR 'P-EX') THEN 0
  ELSE IF (SEG_NBR EQ '00') THEN 0
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT GT 0) THEN NEW_ADV_PURCH
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT LT 0) 
  THEN NEW_ADV_PURCH * (-1) ELSE 0;

END

TABLE FILE AIRHOLD3
PRINT TICKET_NMBR AS 'TKT,NMBR'
RREFUSE_CODE AS 'REASON, CODE' 
RADV_PURCH AS 'ADV,PURCH'
XDPT_DT AS 'DEPART, DATE' 
TIME_DPT AS 'TIME'
EMB_APT_NM AS 'ORG'  
RTE_APT_NM AS 'DST'
AIRLINE AS 'CR' 
FARE_AMT AS 'FARE,PAID'
NET_TKT_CNT AS 'TKT,CNT'
BY LEVEL_DESC NOPRINT
BY XPSNGR_NM AS 'PASSENGER,NAME' 
BY XTKT_SRT NOPRINT
BY TKT_SORT NOPRINT 
BY TRN_DATE NOPRINT
BY XDPT_DT NOPRINT  
BY DPT_TIME NOPRINT
BY SEG_NBR NOPRINT
BY TKT_TYPE AS 'TKT,TYPE'
BY XTRAN_DT AS 'TRAN,DATE'
-*******steve***********************
WHERE ( AROLL_LEV5 EQ '&Lvl5' );
WHERE VOID_DATE EQ 0;
WHERE TRN_DATE GE '20051001';
WHERE TRN_DATE LE '20051031';
-* ON TABLE SUBHEAD
" "
" "
" "
"TRANSACTION PERIOD:"
"10/01/2005 - 10/31/2005"
"JOINT Commission" 
"Report by Hierarchy - multi-level drill down"
" "
" "
ON TABLE SET PAGE-NUM OFF
ON TABLE NOTOTAL
ON LEVEL_DESC RECOMPUTE FARE_AMT NET_TKT_CNT AS 'TOTAL FOR'
ON XTKT_SRT SKIP-LINE
ON TABLE SET ONLINE-FMT PDF
ON TABLE SET HTMLCSS ON
ON TABLE SET STYLE *
     UNITS=IN,
     PAGESIZE='Letter',
     LEFTMARGIN=0.1250000,
     RIGHTMARGIN=0.1250000,
     TOPMARGIN=0.250000,
     BOTTOMMARGIN=0.250000,
     SQUEEZE=ON,
     ORIENTATION=LANDSCAPE,
$
TYPE=REPORT,
     GRID=OFF,
     FONT='TIMES NEW ROMAN',
     SIZE=8,
     COLOR='BLACK',
     BACKCOLOR='NONE',
     STYLE=NORMAL,
$
TYPE=HEADING,
     LINE=6,
     SIZE=14,
     JUSTIFY=CENTER,
$
TYPE=HEADING,
     LINE=6,
     OBJECT=TEXT,
     ITEM=1,
     COLOR='BLACK',
     STYLE=BOLD,
$
TYPE=HEADING,
     LINE=7,
     SIZE=14,
     JUSTIFY=CENTER,
$
TYPE=HEADING,
     LINE=7,
     OBJECT=TEXT,
     ITEM=1,
     COLOR='BLACK',
     STYLE=BOLD,
$
TYPE=REPORT,
     IMAGE=JOINT.gif,
     POSITION=(.5 .3), SIZE=(2.0 .4),
$
TYPE=REPORT,
     IMAGE=logo15.gif,
     POSITION=(8.1 .5), SIZE=(1.3 .44),
$
ENDSTYLE

END
