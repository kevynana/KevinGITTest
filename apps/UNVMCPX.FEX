-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-*11/9/15 - DLV - S-12565 - CREATED new routine for UNVMPXT  
-*                          created from TOPCARPX         
-*3/2/16 - JEM -S-16367 Updated hard coded d:\ to use &&WFSRV1.EVAL

-* FILE UNVMCPX.FEX

-INCLUDE SETECHO


SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN
-SET &CARDATES = &&WEB_PATH || 'CARDATES.fex';

DEFINE FILE &&EXTRACT

  
  LEVEL_DESC/A60 = &&LDESC;
  
  DAY_OF_WK/W = PICKUP_DATE;	
  DROP_OFF_DT/MDYY = DROP_DATE;	
  IBOOK/A13 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN 'INTERNET' ELSE
              'NON-INTERNET';
  INV_DATE/MDYY = INVOICE_DATE;
  INV_MONTH/MT = INVOICE_DATE;	
  NBR_DAYS/D12 = NUM_DAYS;
  PICK_UP_DT/MDYY = PICKUP_DATE;	
  XPICK_DOW/W   = PICKUP_DATE;
  XDROP_DOW/W   = DROP_DATE;
  NEW_RENTAL_AMT/D12.2CS = RENTAL_AMT;
  RENTAL_DAYS/D8 = IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                   ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;
XPSNGR_NM1/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');  
XPSNGR_NM/A15 = LCWORD(15, XPSNGR_NM1, XPSNGR_NM);

  
END
-RUN

TABLE FILE &&EXTRACT
PRINT CAR_KEY
  CURR_DATE 
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NEW_RENTAL_AMT
  PNR_LOCATOR
  NBR_DAYS
  NUM_CARS
  RENTAL_DAYS
  XPSNGR_NM
  VENDOR_NAME
-INCLUDE &CARDATES   
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************

WHERE PICK_CTY.INTL_DOM EQ 'I'

&&WHERE7
-INCLUDE RPTPARMS
ON TABLE HOLD AS TOPCARH
END
-RUN


TABLE FILE TOPCARH
PRINT CAR_KEY
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NEW_RENTAL_AMT
  PNR_LOCATOR
  NBR_DAYS
  NUM_CARS
  RENTAL_DAYS
  XPSNGR_NM AS 'PASSNGR_NAME'
  VENDOR_NAME
BY CURR_DATE

ON TABLE HOLD AS TPCARHLD FORMAT FOCUS INDEX CURR_DATE
END
-RUN

-* Global Reporting JOIN
JOIN TPCARHLD.CURR_DATE IN TPCARHLD TO GLOBAL.DATE IN GLOBAL AS J1
END

DEFINE FILE TPCARHLD

 NAMEC/A30 = CNAME;


-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
AMT_RENTALX/D20.6 = NEW_RENTAL_AMT * CURR1X;


END 

TABLE FILE TPCARHLD
PRINT 
  CURR_DATE
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NEW_RENTAL_AMT
  PNR_LOCATOR
  NBR_DAYS
  NUM_CARS
  RENTAL_DAYS
  PASSNGR_NAME
  VENDOR_NAME
  AMT_RENTALX/D16.2CS
  NAMEC
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
BY CAR_KEY
ON TABLE HOLD AS TOPCARH2 FORMAT FOCUS INDEX  CAR_KEY
END
-RUN

 TABLE FILE ROLLUP
 PRINT COMP
 IF ROLLUP EQ '&&ROLLUP.EVAL'
 ON TABLE HOLD AS COMPANY
 END 
 -RUN
 
 -READ COMPANY &&COMP.A8
 -SET &&COMPNY = &&COMP.EVAL;
 -CLOSE COMPANY
 
-SET &&COMPUC = '&&WFSRV1.EVAL' || '\TNT\TTRACKER\DATA\UC'|| '&&COMPNY.EVAL' ||'.FOC';
-RUN
 
 
 
 USE CLEAR *
 USE 
 &&COMPUC AS UDCAR
 &&WFSRV1.EVAL\TNT\TTRACKER\SYSTEM\DATA\UDID_DSC.FOC AS UDID_DSC
 END
 
  
 TABLE FILE UDCAR
 PRINT AUD_DATA AS 'EMP'
 BY CAR_KEY
 WHERE UDID EQ 'EMP' 
 ON TABLE HOLD AS UDIDHOLDC
 END
-RUN


JOIN CAR_KEY IN TOPCARH2 TO CAR_KEY IN UDIDHOLDC AS J1
-RUN 


DEFINE FILE TOPCARH2
EMP_ID/A6 = EDIT(EMP, '999999');
END
TABLE FILE TOPCARH2
SUM NBR_DAYS
    NUM_CARS
    RENTAL_DAYS
    NEW_RENTAL_AMT
    LEVEL_DESC
    LEVEL1
    LEVEL2
    LEVEL3
    AMT_RENTALX/D16.2CS
    NAMEC
    EMP_ID
BY PASSNGR_NAME
 
ON TABLE HOLD AS HOLDCPX 
END
-RUN

-SET &&NOCAR = IF &LINES EQ 0 THEN 'Y' ELSE 'N';

 