-*2/5/14 Updated the bookings define to use num_days instead of daily_rate - JK


-INCLUDE SETECHO
 
-***************************************************
-* reset dates and report type in control file
-***************************************************
-*retain current quarter
-*-SET &&CQFMDT ='&&FROMDT.EVAL';
-*-SET &&CQTODT ='&&TODT.EVAL';
-SET &&INTDOM = 'T'; 
-*specify the values for program catqtr
-SET &&RPTTYP = 'ADD';
-SET &&SMD = 'S';
-*reset the date ranges for Trending Data
-SET &&FROMDT = '&&CYFMDT.EVAL';
-SET &&TODT = '&&CYTODT.EVAL';
-SET &&FXDATE = '&&PYFMDT.EVAL';
-SET &&TXDATE = '&&PYTODT.EVAL';
 
-SET &&QRLVDR='QRLVDR' | &&INTDOM;
-SET &&QRLCTY='QRLCTY' | &&INTDOM;
-SET &&QRLADR='QRLADR' | &&INTDOM;
-SET &&HXLIM01='HXLIM01' | &&INTDOM;
 
CREATE FILE &&QRLVDR
CREATE FILE &&QRLCTY
CREATE FILE &&QRLADR
-RUN
 
-**************************************************************
-* START FROM BASE ROLLUP frist
-* generate include file for database allocation
-**************************************************************
-SET &&ROLLUP = '&&BASEROLL.EVAL';
-SET &&COMPNY = '&&BASECOMP.EVAL';
EX QRSETBDB
-RUN
-***************************************************
-* generate include file for database allocation
-***************************************************
 
EX LIMUSE
-RUN
 
-********************************************************
-* Execute program to generate data from base rollup
-********************************************************
-*EX NQCRBEX
-*-RUN
SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN
 
DEFINE FILE &&EXTRACT
BOOKINGS/D8 = IF NUM_DAYS GT 0 THEN 1 ELSE IF NUM_DAYS LT 0 THEN (-1) ELSE 0;
NBR_DAYS/D8 = IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                   ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;
 
TC_AMT/D12.2  = RENTAL_AMT;
CCQ/A1 = IF INVOICE_DATE GE '&&CQFMDT.EVAL' AND
                INVOICE_DATE LE '&&CQTODT.EVAL' THEN 'Y' ELSE 'N';
-* Defines on Previous Defines
 
CLIENTCODE/A8 = '&&ROLLUP.EVAL';
-*-INCLUDE QRFTRANC

-*
CURRQ/Q = INVOICE_DATE;
CY/Y = INVOICE_DATE;
CM/M  = INVOICE_DATE;
FM/M = &&ROLLFY;
DM/I2 = CM - FM;

TRANYR/YY= INVOICE_DATE;
AYEAR/A4YY = TRANYR;

THEYR/I1 = IF (INVOICE_DATE GE '&&FROMDT.EVAL') AND (INVOICE_DATE LE '&&TODT.EVAL') THEN 2
  ELSE IF (INVOICE_DATE GE '&&FXDATE.EVAL') AND (INVOICE_DATE LE '&&TXDATE.EVAL') THEN 1;

-*first year as fiscal year label
FMDATE1/YYMD='&&FXDATE.EVAL';
FMDATE2/YYMD='&&FROMDT.EVAL';
FYYR1/Y=FMDATE1;
FYYR2/Y=FMDATE2;

-*second year as fiscal year label
Y2DATE/YYMD = DATEADD(FMDATE2, 'Y', 1);
FYYR3/Y=Y2DATE;

FY_YR/A4= IF '&&FYFLAG.EVAL' EQ '1' AND THEYR EQ 1 THEN 'FY' | EDIT(FYYR1) 
  ELSE IF '&&FYFLAG.EVAL' EQ '1' AND THEYR EQ 2 THEN 'FY' | EDIT(FYYR2) 
  ELSE IF '&&FYFLAG.EVAL' EQ '2' AND THEYR EQ 1 THEN 'FY' | EDIT(FYYR2) 
  ELSE IF '&&FYFLAG.EVAL' EQ '2' AND THEYR EQ 2 THEN 'FY' | EDIT(FYYR3) 
  ELSE AYEAR;

YEAR/A4 = IF FM EQ 01 THEN AYEAR ELSE FY_YR;
  
FTRAN1/A2 = IF FM EQ 01 THEN 'Q' | EDIT(CURRQ)  
  ELSE IF (DM GE 9 OR (DM GE -3 AND DM LE -1)) THEN 'Q4'
  ELSE IF (DM GE 6 OR (DM GE -6 AND DM LE -4)) THEN 'Q3' 
  ELSE IF (DM GE 3 OR (DM GE -9 AND DM LE -7))  THEN 'Q2'
  ELSE IF DM LE 0 AND FM GE 11 THEN 'Q1' 
  ELSE 'Q1';    
  
FTRAN/A6 = IF FM EQ 01 THEN FTRAN1 | ' ' | EDIT(CY)
  ELSE FTRAN1 | FY_YR;
  
TRAN/A7 = IF THEYR EQ 1 THEN ' ' | FTRAN ELSE FTRAN;

-*Current: current YTD; PRIOR: prior year; PYTD: prior YTD flag; PQ: prior quarter; CQ: current quarter
CURRENT/A1 = IF INVOICE_DATE GE '&&FROMDT.EVAL'  AND INVOICE_DATE LE '&&TODT.EVAL'     THEN 'Y' ELSE 'N';
PRIOR/A1   = IF INVOICE_DATE GE '&&FXDATE.EVAL'  AND INVOICE_DATE LE '&&TXDATE.EVAL'   THEN 'Y' ELSE 'N'; 
PYTD/A1    = IF INVOICE_DATE GE '&&FXDATE.EVAL'  AND INVOICE_DATE LE '&&PYTDDATE.EVAL' THEN 'Y' ELSE 'N';
PQ/A1      = IF INVOICE_DATE GE '&&PQFMDT.EVAL'  AND INVOICE_DATE LE '&&PQTODT.EVAL'   THEN 'Y' ELSE 'N';	
CQ/A1      = IF INVOICE_DATE GE '&&CQFMDT.EVAL'  AND INVOICE_DATE LE '&&CQTODT.EVAL'   THEN 'Y' ELSE 'N';	
-*
END
TABLE FILE &&EXTRACT
SUM NBR_DAYS
    TC_AMT
    BOOKINGS
    PICK_CTY.CITY_NAME/A20 AS 'PICK_CTY_NAME'
BY YEAR
BY TRAN
BY CLIENTCODE AS 'ROLLUP_CODE'
BY VENDOR_CODE
BY VENDOR_NAME
BY CAR_CAT
BY PICKUP_CITY
BY CURRENT
BY CCQ
BY PRIOR
BY PYTD
-IF &&INTDOM EQ 'T' THEN GOTO SKIP;
WHERE PICK_CTY.INTL_DOM EQ '&&INTDOM.EVAL';
-SKIP
WHERE (INVOICE_DATE GE '&&FROMDT.EVAL') AND (INVOICE_DATE LE '&&TODT.EVAL') OR
      (INVOICE_DATE GE '&&FXDATE.EVAL') AND (INVOICE_DATE LE '&&TXDATE.EVAL')
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-INCLUDE RPTPARMS
-*ON TABLE HOLD AS HOLDLIMB
ON TABLE HOLD AS &&HXLIM01
END
-RUN
 
-IF &LINES EQ 0 THEN GOTO NOLBASE;
 
DEFINE FILE &&HXLIM01
CDAY/D8 = IF CURRENT EQ 'Y' THEN NBR_DAYS ELSE 0;
PDAY/D8 = IF PYTD EQ 'Y' THEN NBR_DAYS ELSE 0;
CAMT/P12.2  = IF CURRENT EQ 'Y' THEN TC_AMT ELSE 0;
PAMT/P12.2  = IF PYTD EQ 'Y' THEN TC_AMT ELSE 0;
CBOOKINGS/D8 = IF CURRENT EQ 'Y' THEN BOOKINGS ELSE 0;
PBOOKINGS/D8 = IF PYTD EQ 'Y' THEN BOOKINGS ELSE 0;
END
TABLE FILE &&HXLIM01
SUM CDAY
    CAMT
    CBOOKINGS
    PDAY
    PAMT
    PBOOKINGS
BY ROLLUP_CODE
BY VENDOR_CODE
BY VENDOR_NAME
ON TABLE HOLD AS LIMBASE2
END
-RUN
 
TABLE FILE LIMBASE2
PRINT *
RANKED BY HIGHEST CBOOKINGS NOPRINT
ON TABLE HOLD AS LIMBASE3
END
-RUN
 
-SET &RECFOUND = &RECORDS;
 
DEFINE FILE LIMBASE3
  LIST/D9 = (LAST LIST + 1) ;
  DRANK/D9 = RANK;
  ARANK/A11 = FTOA(DRANK, '(D9)', ARANK);
  ARANK1/A9 = EDIT(ARANK, '$$999999999');
  RANK_VALUE/A9 = IF LIST GT 8 THEN 'OTHER' ELSE ARANK1;
  RANK_LABEL1/A12 = IF RANK_VALUE NE 'OTHER' THEN VENDOR_CODE
                      ELSE 'ALL OTHER';
  VND_NAME/A12 = IF RANK_VALUE NE 'OTHER' THEN VENDOR_NAME
                      ELSE 'ALL OTHER';
  RANK_LABEL/A12 = LCWORD(12, VND_NAME, RANK_LABEL);
END
-RUN
 
TABLE FILE LIMBASE3
SUM CDAY
    CAMT
    CBOOKINGS
    PDAY
    PAMT
    PBOOKINGS
    VND_NAME/A12 AS 'VENDOR_NAME'
    VENDOR_CODE
BY ROLLUP_CODE
BY RANK_VALUE
BY RANK_LABEL1
BY RANK_LABEL
ON TABLE HOLD AS LIMBASE4
END
-RUN
 
TABLE FILE LIMBASE4
PRINT VENDOR_CODE
BY RANK_VALUE NOPRINT
WHERE RANK_LABEL1 NE 'ALL OTHER'
WHERE VENDOR_CODE NE ' '
ON TABLE SAVE AS SAVLVDR
END
-RUN
 
TABLE FILE LIMBASE4
PRINT ROLLUP_CODE VENDOR_NAME RANK_VALUE AS 'RANK' CDAY CBOOKINGS CAMT PDAY PBOOKINGS PAMT
BY RANK_VALUE NOPRINT
ON TABLE SAVE
END
-RUN
 
MODIFY FILE &&QRLVDR
LOG DUPL MSG OFF
FIXFORM ROLLUP_CODE/8 VENDOR_NAME/12 RANK/9 CDAY/8 CBOOKINGS/8 CAMT/12 PDAY/8 PBOOKINGS/8 PAMT/12
MATCH ROLLUP_CODE VENDOR_NAME
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN
 
-GOTO LVDRskip;

TABLE FILE &&HXLIM01
SUM CAMT
    CDAY
    CBOOKINGS
    PICK_CTY_NAME
BY ROLLUP_CODE
BY PICKUP_CITY
BY VENDOR_NAME
WHERE CURRENT EQ 'Y'
ON TABLE HOLD AS LCARCTY
END
-RUN


TABLE FILE LCARCTY
PRINT CAMT
      CDAY
      CBOOKINGS
      VENDOR_NAME
      ROLLUP_CODE
BY PICK_CTY_NAME
RANKED BY HIGHEST CBOOKINGS
ON TABLE HOLD AS RNKHLD1
END
-RUN


DEFINE FILE RNKHLD1
 RANK_LIMIT/I5 = 3;
 DRANK/D5      = RANK;
 ARANKX/A6 = FTOA(DRANK, '(D5)', 'A6');
 ARANK/A5=EDIT(ARANKX,'$99999');
 RANK_VALUE/A5 = IF (RANK_LIMIT EQ 0) THEN (ARANK) ELSE
                IF RANK GT RANK_LIMIT THEN 'OTHER' ELSE ARANK;
END
-RUN

TABLE FILE RNKHLD1
SUM CAMT
      CDAY
      CBOOKINGS
BY ROLLUP_CODE
BY PICK_CTY_NAME
BY RANK_VALUE
BY VENDOR_NAME
ON TABLE HOLD AS LCARCTY2
END
-RUN


TABLE FILE LCARCTY
PRINT CAMT
      CDAY
      CBOOKINGS
      ROLLUP_CODE
      VENDOR_NAME
BY PICK_CTY_NAME
ON TABLE HOLD AS RHOLD2
END
-RUN

TABLE FILE RHOLD2
PRINT CAMT
      CDAY
      CBOOKINGS
      ROLLUP_CODE
      VENDOR_NAME
      PICK_CTY_NAME
RANKED BY HIGHEST CBOOKINGS AS 'BOOK_RANK'    
ON TABLE HOLD AS RNKHLD2
END
-RUN


MATCH FILE LCARCTY2
PRINT CAMT 
      CDAY
      CBOOKINGS
      ROLLUP_CODE
      RANK_VALUE
      VENDOR_NAME
BY PICK_CTY_NAME
ON TABLE HOLD
RUN 
FILE RNKHLD2
SUM BOOK_RANK
BY PICK_CTY_NAME
AFTER MATCH HOLD AS RHOLD3 OLD-OR-NEW
END
-RUN

TABLE FILE RHOLD3
PRINT CAMT
      CBOOKINGS
      CDAY
      ROLLUP_CODE
      RANK_VALUE
      VENDOR_NAME
      PICK_CTY_NAME
RANKED BY HIGHEST BOOK_RANK
ON TABLE HOLD AS RHOLD4
END
-RUN

DEFINE FILE RHOLD4
  CTY_LIMIT/I2 = 5;
  CLIMIT/A2    = EDIT(CTY_LIMIT) ;
  CRANK/D5     = RANK;
  BRANK/A6     = FTOA(CRANK, '(D5)', 'A6');
  LIST/D6 = IF PICK_CTY_NAME NE LAST PICK_CTY_NAME THEN
                        (LAST LIST + 1) ELSE LAST LIST;
  FRANKX/A7 = FTOA(LIST, '(D6)', 'A7');
  FRANK/A6=EDIT(FRANKX,'$999999');
  VND_LIMIT/I2 = 3;
  VLIMIT/A2 = EDIT(VND_LIMIT);
  CTY_VALUE/A9 = IF CTY_LIMIT EQ 0 THEN BRANK ELSE
                 IF RANK GT CTY_LIMIT THEN 'ALL OTHER' ELSE BRANK;
  CTY_PRINT/A35 = IF CTY_VALUE NE 'ALL OTHER' THEN PICK_CTY_NAME ELSE 'ALL OTHER';
-*  VENDOR_RANK/A9 = IF CTY_VALUENE 'ALL OTHER' THEN RANK_VALUE ELSE ' ';
  VENDOR_RANK/A9 = IF CTY_VALUE EQ 'ALL OTHER' THEN  ' ' ELSE RANK_VALUE;
  VND_NAME/A12 = IF CTY_VALUE EQ 'ALL OTHER' THEN  ' ' ELSE
                 IF VENDOR_RANK NE 'ALL OTHER' THEN VENDOR_NAME ELSE ' ';
                
END
-RUN      

 

 
TABLE FILE RHOLD4
SUM CDAY
    CAMT
    CBOOKINGS
BY CTY_VALUE
BY CTY_PRINT
BY ROLLUP_CODE
BY VENDOR_RANK
BY VND_NAME
END
-RUN
-QUIT


TABLE FILE LCARCTY3
PRINT RNK_LBL1 AS 'PICKUP_CITY'
BY RNK_VAL NOPRINT
WHERE RNK_LBL1 NE 'ALL OTHER'
ON TABLE SAVE AS LCARCTY
END
-RUN
 
TABLE FILE LCARCTY3
PRINT ROLLUP_CODE PICK_CTY_NAME RNK_VAL AS 'RANK' CBOOKINGS CDAY CAMT
ON TABLE SAVE
END
-RUN
 
MODIFY FILE &&QRLCTY
LOG DUPL MSG OFF
FIXFORM ROLLUP_CODE/8 PICK_CTY_NAME/20 RANK/A9 CBOOKINGS/8 CDAY/8 CAMT/12
MATCH ROLLUP_CODE PICK_CTY_NAME
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN

-LVDRskip; 
DEFINE FILE &&HXLIM01
RIGHT_TRAN/A7 = RJUST(7, TRAN, RIGHT_TRAN);
END
TABLE FILE &&HXLIM01
SUM BOOKINGS
    NBR_DAYS
    TC_AMT
BY ROLLUP
BY YEAR
BY RIGHT_TRAN AS 'TRAN'
BY CURRENT
BY PRIOR
BY PYTD
ON TABLE HOLD AS BQLADR
END
-RUN
 
TABLE FILE BQLADR
PRINT ROLLUP_CODE YEAR TRAN BOOKINGS NBR_DAYS TC_AMT CURRENT PRIOR PYTD
ON TABLE SAVE
END
-RUN
 
MODIFY FILE &&QRLADR
LOG DUPL MSG OFF
FIXFORM ROLLUP_CODE/8 YEAR/4 TRAN/7 BOOKINGS/8 NBR_DAYS/8 TC_AMT/12 CURRENT/1 PRIOR/1 PYTD/1
MATCH ROLLUP_CODE YEAR TRAN
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN

-GOTO NOTthis; 
DEFINE FILE &&HXLIM01
RIGHT_TRAN/A7 = RJUST(7, TRAN, RIGHT_TRAN);
END
TABLE FILE &&HXLIM01
SUM BOOKINGS
    NBR_DAYS
    TC_AMT
BY ROLLUP
BY YEAR
BY RIGHT_TRAN AS 'TRAN'
BY CURRENT
BY PYTD
BY CCQ
BY PRIOR
BY CAR_CAT
ON TABLE HOLD AS HLDLCTY01
END
-RUN
 
MODIFY FILE &&QRLTYP
LOG DUPL MSG OFF
FIXFORM FROM HLDLCTY01
MATCH *
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON HLDLCTY01
END
-RUN
-NOTthis 
-NOLBASE
 
-INCLUDE QR_EXTRACT_LIMO_PEER
