
-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* File TKTAIR.FEX
-********************************************************************

-*06/01/17-jem-S-34231-Created for new report QBEACH
-*06/27/17-jem-S-34231-Updated TYPE to be 6 characters
-*07/18/17-jem-S-37248-Updating norecords report to show all fields with blank values so the customer's load process won't error out
-*08/10/17-jem-S-38372-Changed EMP_ID to pass first 11 characters or if non-numeric it passes GUEST
-********************************************************************
-INCLUDE SETECHO
 

SET ASNAMES = ON
-SET HOLDATTR = ON;

-SET &&IDLEVELBREAK = '';
-DEFAULT &&LV1='';
-DEFAULT &&LV2='';
-DEFAULT &&LV3='';
-DEFAULT &&LV4='';
-DEFAULT &&LV5='';
-DEFAULT &&LV6='';
-DEFAULT &&LV7='';


-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';
-SET &WHATDATE = IF '&&DATETYPE.EVAL' EQ 'I' THEN 'TRN_DATE' ELSE 'FST_DPT_DATE';

-INCLUDE IDLEVROLLDEF
-RUN

DEFINE FILE &&EXTRACT
  AIRLN/A30 = AIRLINE_NAME;
             
  
  CTY1/A25 = CITYPAIR.EMBARK;
  CTY2/A25 = CITYPAIR.ROUTE;
  EMP_CHK/A1 = EDIT(EMP_ID, '9');
  EMP_ID1/A11 = EDIT(EMP_ID, '99999999999');
  FARE_PAID/D12.2C   = SEG_AMT + SEG_TAX;
  FIRST_NAME/A25 = GETTOK(PASSNGR_NAME, 33, -1, '/', 25, FIRST_NAME);
  LAST_NAME/A25 =GETTOK(PASSNGR_NAME, 33,-2, '/',25,LAST_NAME);
  LEVEL_DESC1/A60 = &&LDESC;  
  SEG_LOW/D12.2C = SEG_LOWEST;
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  NEW_ADV_PURCH/D9CS    = ADV_PURCH;
  NEW_SEG_DISC/D12.2CS = SEG_DISCOUNT;
  NEW_SEG_MILES/D9= SEG_MILES;

                         

VOID/A1 =  IF (VOID_STATUS EQ '1') AND (VOID_DATE NE 0) THEN 'Y' ELSE 'N';
 
 

  XDPT_DT/MDYY         = DPT_DATE;
  XPSNGR_NM/A15        = 
    EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;

-***DEFINES ON PREVIOUS DEFINES
  AIRLINE_FEE/D12.2CS = IF EMBARK EQ 'FP2' OR 'FP3' 
  THEN FARE_PAID ELSE 0;

  DISSAVINGS/D12.2C  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOW;  
                           
  EMP_ID2/A11 = IF EMP_CHK NE '0' OR '1' OR '2' OR '3' OR '4' OR '5' OR '6' OR '7' OR '8' OR '9' THEN 'GUEST' ELSE EMP_ID1;
                         
  VASAVINGS/D12.2CS    = NEW_SEG_DISC - FARE_PAID;
FDATE/MDYY = FST_DPT_DATE;  

-* TKTN/A10 = IF DOC_TYPE EQ '9' THEN AUX_TKTLS_NUM ELSE TKT_NUM;
TKTN/A10=TKT_NUM;

TKT_TYPE1/A4 = IF (SEG_COUNT LE 0) AND (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
              IF (SEG_COUNT LE 0) AND (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
              IF (SEG_COUNT LE 0) AND (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
              IF (SEG_COUNT LE 0) AND (EX_FLAG EQ 'F') THEN 'F-EX' ELSE
              IF VOID EQ 'Y' THEN 'VOID'  ELSE ' ';


TKT_TYPE/A6 = IF (TKT_TYPE1 EQ '' AND EXSALE EQ '') THEN 'ORGSAL' ELSE
 	       IF (TKT_TYPE1 EQ '' AND EXSALE NE '') THEN 'EXCSAL' ELSE
 	       IF (TKT_TYPE1 EQ 'F-EX') THEN 'FEXCHG' ELSE
               IF (TKT_TYPE1 EQ 'P-EX')    THEN 'PEXCHG' ELSE
               IF (TKT_TYPE1 EQ 'F-RF')    THEN 'FREFND' ELSE
               IF (TKT_TYPE1 EQ 'P-RF')    THEN 'PREFND' ELSE
               IF (TKT_TYPE1 EQ 'VOID')    THEN 'VOID';
FLAG/A1 = IF VOID_DATE NE 0 THEN 'V' ELSE 'A';
-INCLUDE TRANTYPE
-INCLUDE IDLEVDEFINE 

END
-RUN

TABLEF FILE &&EXTRACT
PRINT  
  AIRLINE
  CLASS
  CLIENT_NUM
  CLIENT_NAME
  DISSAVINGS
  DST_APC
  EMBARK
  EMB_APT.AIRPORT_NAME AS 'CITY1' 
  EMP_ID2
  FARE_PAID
  FDATE
  FIRST_NAME
  FLAG
  INVOICE_NUM
  LEVEL_DESC
  NET_TKT_CNT 
  PASSNGR_NAME
  PNR_LOCATOR
  REFUSE_CODE
  ROUTE
  RTE_APT.AIRPORT_NAME AS 'CITY2'
  SEG_COUNT
  SEG_NBR
  SEG_LOW
  TICKET_CODE
  TKT_DATE
  TKT_NUM
  TKTN
  TKT_SORT
  TKT_TYPE
  &WHATDATE
  XDPT_DT   
  XTRAN_DT  
  LAST_NAME
-INCLUDE &AIRDATES
WHERE VOID_DATE EQ 0
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
-*&&WHERE5
-*&&WHERE6
-* &&WHERE7
-* &&WHERE8
-* &&WHERE9
-* &&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS AIRHOLD
END
-RUN


TABLE FILE AIRHOLD
PRINT 
  AIRLINE
  CITY1
  CITY2
  CLASS
  CLIENT_NUM
  CLIENT_NAME
  DISSAVINGS
  DST_APC
  EMBARK
  EMP_ID2 AS 'EMP_ID'
  FARE_PAID
  FIRST_NAME
  FDATE
  FLAG
  INVOICE_NUM
  LAST_NAME
  LEVEL_DESC
  NET_TKT_CNT 
  PASSNGR_NAME
  PNR_LOCATOR
  ROUTE
  REFUSE_CODE
  SEG_COUNT
  SEG_NBR
  SEG_LOW
  TICKET_CODE
  TKT_DATE
  TKT_NUM
  TKTN
  TKT_SORT
  TKT_TYPE
  &WHATDATE
  XDPT_DT   
  XTRAN_DT   
BY TKT_DATE 
ON TABLE HOLD AS AIRHOLD1 FORMAT FOCUS INDEX TKT_DATE
END
-RUN

-* Global Reporting JOIN
JOIN AIRHOLD1.TKT_DATE IN AIRHOLD1 TO GLOBAL.DATE IN GLOBAL AS J1
END

DEFINE FILE AIRHOLD1
NAMEC/A30 = CNAME;

-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES	
PAID_FAREX/D20.6 = FARE_PAID * CURR1X;
-* FEEX/D20.6 = AIRLINE_FEE * CURR1X;
END
-RUN
 
TABLE FILE AIRHOLD1
PRINT
  AIRLINE 
  CITY1
  CITY2
  CLASS
  CLIENT_NUM
  CLIENT_NAME
  DISSAVINGS
  DST_APC
  EMBARK
  EMP_ID
  FARE_PAID
  FDATE
  FIRST_NAME
  FLAG
  INVOICE_NUM
  LAST_NAME
  LEVEL_DESC
  NET_TKT_CNT 
  PASSNGR_NAME
  PNR_LOCATOR
  ROUTE
  REFUSE_CODE
  SEG_COUNT
  SEG_NBR
  SEG_LOW
  TICKET_CODE
  TKT_DATE
  TKT_NUM
  TKTN
  TKT_SORT
  TKT_TYPE AS 'TYPE'
  &WHATDATE
  XDPT_DT AS 'DATE'  
  XTRAN_DT AS 'TRAN_DATE'   
  NAMEC
  PAID_FAREX 
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS AIRHOLD2
END
-RUN


TABLE FILE AIRHOLD2

SUM FARE_PAID AS 'AMOUNT'
    PAID_FAREX/D16.2C AS 'GAMOUNT'
    NET_TKT_CNT/D12 AS 'TTL_COUNT'
    DISSAVINGS AS 'LOST_AMT'
    SEG_LOW/D12.2C AS 'LOW_AMT'
BY LEVEL_DESC 
BY PASSNGR_NAME
BY TKT_SORT
BY &WHATDATE
ON TABLE HOLD AS HOLD3
END
-RUN


TABLE FILE AIRHOLD2
PRINT AIRLINE
  CITY1
  CITY2
  CLASS
  CLIENT_NUM
  CLIENT_NAME
  DATE
  DISSAVINGS
  DST_APC
  EMBARK
  EMP_ID
  FARE_PAID
  FDATE
  FIRST_NAME
  FLAG
  INVOICE_NUM
  LAST_NAME
  LEVEL_DESC
  NET_TKT_CNT 
  PASSNGR_NAME
  PNR_LOCATOR
  REFUSE_CODE
  ROUTE
  SEG_COUNT
  SEG_NBR
  SEG_LOW
  TICKET_CODE
  TKT_DATE
  TKT_NUM
  TKTN
  TRAN_DATE
  TKT_SORT
  TYPE
  NAMEC
  PAID_FAREX
BY LEVEL_DESC 
BY PASSNGR_NAME NOPRINT
BY TKT_SORT  
BY &WHATDATE
BY SEG_NBR   
ON TABLE HOLD AS XTWO
END
-RUN

MATCH FILE XTWO
PRINT AIRLINE
  CITY1
  CITY2
  CLASS
  CLIENT_NUM
  CLIENT_NAME
  DATE
  DISSAVINGS
  DST_APC
  EMBARK
  EMP_ID
  FARE_PAID
  FDATE
  FIRST_NAME 
  FLAG
  INVOICE_NUM
  LAST_NAME
  LEVEL_DESC
  NET_TKT_CNT 
  PASSNGR_NAME
  PNR_LOCATOR
  ROUTE
  REFUSE_CODE
  SEG_COUNT
  SEG_NBR
  SEG_LOW
  TICKET_CODE
  TKT_DATE
  TKT_NUM
  TKTN
  TRAN_DATE
  TKT_SORT
  TYPE
  NAMEC
  PAID_FAREX
BY LEVEL_DESC 
BY PASSNGR_NAME NOPRINT
BY TKT_SORT   
BY &WHATDATE
BY SEG_NBR   
ON TABLE HOLD
RUN
FILE HOLD3
PRINT
  AMOUNT
  GAMOUNT
  LOST_AMT
  TTL_COUNT
  LOW_AMT   
BY LEVEL_DESC 
BY PASSNGR_NAME   
BY TKT_SORT  
BY &WHATDATE  
AFTER MATCH HOLD AS XTHREE OLD-OR-NEW
END
-RUN



DEFINE FILE XTHREE
FLAG/A1 = 'A';
SEG/A2 = SEG_NBR;
TSORT/A11 = TKT_SORT;
RESV_STATUS/A2 = ' ';
VENDOR/A30='';
NEW_RENTAL_AMT/D12.2C = 0;
CDAYS/D12 = 0;
HTL_AMT/D12.2C=0;
HTL_NGTS/D12=0;
NUMCH/D12 = 0;
DRATE/D12.2C=0;
END



TABLE FILE XTHREE
PRINT 
  PASSNGR_NAME
  LAST_NAME
  FIRST_NAME
  LEVEL_DESC
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TKTN
  TSORT
  TYPE
  SEG
  AIRLINE
  DATE
  EMBARK
  CITY1
  ROUTE
  CITY2
  EMP_ID
  FARE_PAID 
  FDATE
  GAMOUNT
  TTL_COUNT
  LOST_AMT
  LOW_AMT
  NAMEC
  REFUSE_CODE
  CLASS
  DST_APC
  CLIENT_NAME
  CLIENT_NUM
  INVOICE_NUM  
  RESV_STATUS
  NEW_RENTAL_AMT
  CDAYS
  VENDOR
  HTL_AMT
  HTL_NGTS
  NUMCH
  DRATE
BY FLAG 
ON TABLE HOLD AS HOLDA1 
END
-RUN

TABLE FILE HOLDA1
PRINT
  PASSNGR_NAME
  LAST_NAME
  FIRST_NAME
  LEVEL_DESC
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TKTN
  TSORT
  TYPE
  SEG
  AIRLINE
  DATE
  EMBARK
  CITY1
  ROUTE
  CITY2
  EMP_ID
  FARE_PAID AS 'AMOUNT'
  FDATE
  GAMOUNT
  TTL_COUNT
  LOST_AMT
  LOW_AMT
  NAMEC
  REFUSE_CODE
  CLASS
  DST_APC
  CLIENT_NAME
  CLIENT_NUM
  INVOICE_NUM  
  RESV_STATUS
  NEW_RENTAL_AMT
  CDAYS
  VENDOR
  HTL_AMT
  HTL_NGTS
  NUMCH
  DRATE
BY FLAG  
ON TABLE HOLD AS HOLDA FORMAT FOCUS INDEX FLAG  
END
-RUN


-SET &&AIRREC=IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';



-XXIT;

