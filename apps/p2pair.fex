-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* STEVE - 05/23/2003 - CHANGED CADVTP TO CADVTPX - DEFINED TWICE
-* JOY   - 08/05/2003 - CHANGED TO DEFINE/TABLE OFF OF SR_50
-* JOY   - 02/24/2004 - ADDED CTAVGT DEFINE FOR PATTI 
-* JOY   - 02/36/2004 - CHANGED THE ONLINE PERCENTAGE DEFINE TO BACK OUT
-*                    - REFUNDS/EXCHANGES
-* JOY   - 10/27/04   - PER PATTI CHANGED THE CALCULATIONS FOR 0-6/7-14 %'S TO 
-*                      USE NET TICKETS INSTEAD OF TICKETS PURCHASED
-* DEB    - 11/5/04   - PER PATTI CHANGED CNVSA DEFINE TO EXCLUDE 5 ADDTL
-*                      CLIENT CODES - CHG CREDIT_CARD OMITS FROM 424604 
-*                      TO 4246
-*DEB   -  12/21/04   - ADDED DOD_TYPE 'J' TO CONL CDONL AND CONGONL DEFINE

-*DEB   -  10/11/05   - ADDED DOD_TYPE 'H' TO CONL CDONL AND CONGONL DEFINE
-*GSE   -  05/08/13   - Changed call to PREFAIR fields to match new fieldnames.
-*                      Added check against DEPART_EFFECTIVE_DATE and
-*                      DEPART_EXPIRATION_DATE vs FST_DPT_DATE to VA_FLG DEFINE.
-*1/31/14 UPDATED ONLINE/TRADITIONAL DEFINES TO USE ONLINE_TRADITIONAL FIELD INSTEAD OF DOD_TYPE
-*7/16/14 Updated LSTT define was not including + sign - JK
-*Added ex_rf_flag - JK 8/1/14
-*Updated defines to back out refunds
-*8/11/14 UPDATED THE FINAL HOLD FILE TO PRINT INSTEAD OF SUM - jk
-*10/9/14 Updated to handle exchanges accordingly - JK 
-*10/23/14 Updated to handle refunds accordingly - JK
-* ADDED TRANTYPE INCLUDE - JK 12/30/14 STORY ID S-06492
-* 01/07/15 - JK - STORY ID S-06408 CHANGED ROUTINE FOR PREFAIR EXTRACT DUE TO DATABASE 
-* 4/16/15 - JK - STORY ID S-07463 added hardcoded date selections for CBUILD-R 
-* 5/19/15 - JK - STORY ID S-07942 added join and code for new bonus p2p file (p2p_rollup_bonus)
-* 1/06/16 - JM - STORY ID S-13954 Added logic for hotel bonus points 
-* 6/7/16-JM-S-20024 Updated extracts to exclude all special code types
-* 2/23/17-JEM-S-30968-Updating HTL_BKD define to correct zeros

-INCLUDE SETECHO
SET ASNAMES = ON
SET EMPTYREPORT=ON
-SET HOLDATTR = ON;
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';
-RUN

DEFINE FILE &&EXTRACT
  CC/A2 = EDIT(CREDIT_CARD, '99');
  21ADV/A1 = IF ADV_PURCH GE 21 THEN '+' ELSE ' ';
  14ADV/A1 = IF ADV_PURCH GE 14 THEN '+' ELSE ' ';
  7ADV/A1 =  IF ADV_PURCH GE 7  THEN '+' ELSE ' ';
  ONLA/A1 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN '+' ELSE ' ';
  PREF_CC/A1 = IF CC EQ 'AX' THEN 'Y' ELSE 'N';
  LEVEL_DESC/A60 = &&LDESC;
  EX_FARE/D12.2CM = IF SEG_NBR EQ '01' THEN EXCH_NET_FARE ELSE 0;
  EX_RF_FLAG/A1 = IF VOID_DATE NE 0 THEN ' ' ELSE 
                  IF (((RF_FLAG EQ 'F' OR 'P') AND (EMBARK NE 'EX1' OR 'FP2' OR 'EX5') AND (SEG_COUNT LE 0)) OR (EMBARK EQ 'RF1')) THEN 'R' ELSE
                  IF (((EXSALE NE ' ') AND (SEG_COUNT GE 0)) OR ((EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (RF_FLAG EQ ' ')))  THEN 'E' ELSE ' ';
  FARE_PAID1/D12.2CM = SEG_AMT + SEG_TAX;
  FARE_PAID/D12.2C = IF DOC_NUMBER NE '0000000000' THEN EX_FARE ELSE FARE_PAID1;
-*  HTL_BKD/A1 = IF TKT_NUM NE ' ' THEN '+' ELSE ' ';
HTL_BKD/A1 = IF HOTEL_FLAG NE ' ' THEN '+' ELSE ' ';
  NET_TKT_CNT/D8CS   = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID1 GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  RO_FLAG/A1 = IF RNDT_FLAG EQ 'Y' THEN 'R' ELSE 'O';                           
  TKT_PURCH/D8.2C      = IF (TICKET_CODE EQ '1') AND
                             (SEG_NBR EQ '01') AND
                             (FARE_PAID GE 0) AND
                             (SEG_COUNT EQ 1) AND 
                             (CONJ_REL EQ 1) THEN 1 ELSE 0;
  TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';                       
XTRAN_DT/MDYY = TRN_DATE;
TVL_DTE/MDYY = FST_DPT_DATE;
TKTS/A1 = EDIT(TKT_SORT, '$$$$$$$$$$9');

FLAGA/A1 = IF TKT_NUM NE ' ' THEN 'Y' ELSE 'N';

MIR_SEQ1/A1 = EDIT(MIR_SEQ, '9$$$$$');

-* Defines on Previous Defines


  DISSAVINGS/P12.2CM = IF EMBARK EQ 'DT1' THEN 0 ELSE FARE_PAID1-SEG_LOWEST;
-*   DECLINE_AMT/D12.2C   = IF EMBARK EQ 'DT1' THEN 0 ELSE
-*                          TKT_AMOUNT - LOWEST_AMT;
  VASAVINGS/D12.2CSM = SEG_DISCOUNT - FARE_PAID;
  NEW_STAY/P9 = IF RO_FLAG EQ 'O' THEN 0 ELSE STAY;
  RES_SYS/A1 = IF MIR_SEQ1 EQ 'X' THEN 'S' ELSE 'A';

 -*HIER15_FLAG/A1 = IF AROLL_LEV15 NE ' ' AND AROLL_LEV14 NE ' ' AND AROLL_LEV13 NE ' '
 HIER1/A15 = AROLL_LEV1;
 HIER2/A32 = AROLL_LEV1||'|'||AROLL_LEV2;
 HIER3/A50 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3;
 HIER4/A66 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4;
 HIER5/A85 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5;
 HIER6/A100 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6;
 HIER7/A120 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7;
 HIER8/A135 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8;
 HIER9/A151 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9;
 HIER10/A168 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10;       
 HIER11/A185 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11;
 HIER12/A202 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12;
 HIER13/A219 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12||'|'||AROLL_LEV13;
 HIER14/A236 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12||'|'||AROLL_LEV13||'|'||AROLL_LEV14;
 HIER15/A255 = AROLL_LEV1||'|'||AROLL_LEV2||'|'||AROLL_LEV3||'|'||AROLL_LEV4||'|'||AROLL_LEV5||'|'||AROLL_LEV6||'|'||AROLL_LEV7||'|'||AROLL_LEV8||'|'||AROLL_LEV9||'|'||AROLL_LEV10||'|'||AROLL_LEV11||'|'||AROLL_LEV12||'|'||AROLL_LEV13||'|'||AROLL_LEV14||'|'||AROLL_LEV15;
 
 
 
 HIERA/A255 = IF AROLL_LEV15 NE ' ' THEN HIER15 ELSE
             IF AROLL_LEV14 NE ' ' THEN HIER14 ELSE
             IF AROLL_LEV13 NE ' ' THEN HIER13 ELSE
             IF AROLL_LEV12 NE ' ' THEN HIER12 ELSE
             IF AROLL_LEV11 NE ' ' THEN HIER11 ELSE
             IF AROLL_LEV10 NE ' ' THEN HIER10 ELSE
             IF AROLL_LEV9 NE ' ' THEN HIER9 ELSE
             IF AROLL_LEV8 NE ' ' THEN HIER8 ELSE
             IF AROLL_LEV7 NE ' ' THEN HIER7 ELSE
             IF AROLL_LEV6 NE ' ' THEN HIER6 ELSE
             IF AROLL_LEV5 NE ' ' THEN HIER5 ELSE
             IF AROLL_LEV4 NE ' ' THEN HIER4 ELSE
             IF AROLL_LEV3 NE ' ' THEN HIER3 ELSE
             IF AROLL_LEV2 NE ' ' THEN HIER2 ELSE HIER1;

-IF '&&ROLLUP.EVAL' NE 'TMOBIL-R' GOTO STDHIER;             
  HIER/A255 = HIER4;         
-GOTO DNEHIER;

-STDHIER;          
  HIER/A255 = IF AROLL_LEV2 EQ AROLL_LEV3 THEN HIER2 ELSE HIERA;          

-DNEHIER;

TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';

DOC_NUM1/A10 = DOC_NUMBER;
-INCLUDE TRANTYPE
END
-RUN

TABLEF FILE &&EXTRACT
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DOC_NUMBER
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
 WHERE VOID_DATE EQ 0
 WHERE EMBARK NE 'DT1' OR 'DT2' OR 'DT4' OR 'EX1' OR 'EX5' OR 'FP2' OR 'FP3' OR 'RF1' 
 WHERE EX_FLAG EQ ' '
 WHERE EXCHG_SALE EQ ' '
 WHERE RF_FLAG EQ ' '
 -IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB;
 WHERE TRN_DATE GE '20150126'
 -NOTMOB;
 -IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB;
 WHERE TRN_DATE GE '20150409'
 -NOCB;
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE &AIRDATES
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDSS
END
-RUN


DEFINE FILE RPTHLDSS
FLAG/A1 = 'A';
END
-RUN
TABLE FILE RPTHLDSS
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
BY TKT_NUM 
ON TABLE HOLD AS RPTHLDSS1 FORMAT FOCUS 
END
-RUN



-* EXTRACT NEW EXCHANGE SALE RECORD

TABLEF FILE &&EXTRACT
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DOC_NUMBER AS 'DOC_NUM'
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
 WHERE VOID_DATE EQ 0
 WHERE EMBARK NE 'DT1' OR 'DT2' OR 'DT4' OR 'EX1' OR 'EX5' OR 'FP2' OR 'FP3' OR 'RF1'  
 WHERE EX_FLAG EQ ' '
 WHERE EXCHG_SALE NE ' '
-IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB1;
 WHERE TRN_DATE GE '20150126'
 -NOTMOB1;
 -IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB1;
 WHERE TRN_DATE GE '20150409'
 -NOCB1;
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE &AIRDATES
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDNE
END
-RUN


DEFINE FILE RPTHLDNE
FLAG/A1 = 'A';
END
-RUN
TABLE FILE RPTHLDNE
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
BY TKT_NUM 
ON TABLE HOLD AS RPTHLDNE1 FORMAT FOCUS 
END

TABLE FILE RPTHLDNE
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DOC_NUMBER AS 'DOC_NUM'
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
BY DOC_NUMBER 
ON TABLE HOLD AS RPTHLDNE2
END
-RUN


DEFINE FILE RPTHLDNE2
DOCN/A12 = ''''||DOC_NUMBER||'''';
END
TABLE FILE RPTHLDNE2
SUM DOCN
BY DOC_NUMBER NOPRINT
ON TABLE SAVE AS NEXCHHLD
END
-RUN



-* EXTRACT OLD EXCHANGE SALE RECORD

TABLEF FILE &&EXTRACT
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DOC_NUMBER
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM AS 'DOC_NUM' 
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
 WHERE VOID_DATE EQ 0
 WHERE EMBARK NE 'DT1' OR 'DT2' OR 'DT4' OR 'EX1' OR 'EX5' OR 'FP2' OR 'FP3' OR 'RF1' 
 WHERE EX_FLAG NE ' '
 -* WHERE EXCHG_SALE EQ ' '
-IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB2;
 WHERE TKT_DATE GE '20150126'
 -NOTMOB2;
 -IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB2;
 WHERE TKT_DATE GE '20150409'
 -NOCB2;
 -********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-* -INCLUDE &AIRDATES
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDOE
END
-RUN


DEFINE FILE RPTHLDOE
FLAG/A1 = 'A';
END
-RUN


TABLE FILE RPTHLDOE
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
BY TKT_NUM 
WHERE DOC_NUM IN FILE NEXCHHLD
ON TABLE HOLD AS RPTHLDOE1 FORMAT FOCUS
END
-RUN


-* EXTRACT REFUND RECORDS THAT THE TRANSACTION DATE OCCURRED BEFORE THE TRAVEL DATE
TABLEF FILE &&EXTRACT
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DOC_NUMBER
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM AS 'DOC_NUM' 
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
 WHERE VOID_DATE EQ 0
 WHERE RF_FLAG NE ' '
 -********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE &AIRDATES
WHERE TRN_DATE LE FST_DPT_DATE
-IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB3;
 WHERE TKT_DATE GE '20150126'
 -NOTMOB3;
 -IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB3;
 WHERE TKT_DATE GE '20150409'
 -NOCB3;
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDRB
END
-RUN


TABLE FILE RPTHLDRB
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
BY TKT_NUM
ON TABLE HOLD AS RPTHLDRB1 FORMAT FOCUS
END
-RUN

-* EXTRACT REFUND RECORDS THAT THE TRANSACTION DATE OCCURRED AFTER THE TRAVEL DATE
TABLEF FILE &&EXTRACT
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
      BR_CL_IDX
      C_ITIN
      CATEGORY
      DOC_NUMBER
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM AS 'DOC_NUM' 
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      TKT_DATE
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
 WHERE VOID_DATE EQ 0
 WHERE RF_FLAG NE ' '
 -********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-* -INCLUDE &AIRDATES
-* WHERE FST_DPT_DATE GE TRN_DATE
WHERE TRN_DATE GE &&FROMDT AND TRN_DATE LE &&TODT
WHERE TRN_DATE GE FST_DPT_DATE
-IF &&ROLLUP NE 'TMOBIL-R' GOTO NOTMOB4;
 WHERE TKT_DATE GE '20150126'
 -NOTMOB4;
 -IF &&ROLLUP NE 'CBUILD-R' GOTO NOCB4;
 WHERE TKT_DATE GE '20150409'
 -NOCB4;
 -INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDRA
END
-RUN

TABLE FILE RPTHLDRA
SUM 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
BY TKT_NUM
-* -INCLUDE &AIRDATES
ON TABLE HOLD AS RPTHLDRAA1 
END
-RUN


TABLE FILE RPTHLDRAA1
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      EX_RF_FLAG
      EMBARK
      FLAG
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      TKT_NUM
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
BY TKT_NUM
ON TABLE HOLD AS RPTHLDRA1 FORMAT FOCUS 
END
-RUN






-SET &HLDPATH=TEMPPATH(50,'A50');
-SET &HNKA=&HLDPATH || 'RPTHLDSS1.FOC';
-SET &HNKB=&HLDPATH || 'RPTHLDNE1.FOC';
-SET &HNKC=&HLDPATH || 'RPTHLDOE1.FOC';
-SET &HNKD=&HLDPATH || 'RPTHLDRB1.FOC';
-SET &HNKE=&HLDPATH || 'RPTHLDRA1.FOC';
-RUN


-SET &FILENAME = 'RPTHLDSS1'; 
-RUN

-DOS STATE &HNKA
-SET &HOLDFILEA = IF &RETCODE.EVAL EQ 0 THEN &HNKA | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKB
-SET &HOLDFILEB = IF &RETCODE.EVAL EQ 0 THEN &HNKB | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKC
-SET &HOLDFILEC = IF &RETCODE.EVAL EQ 0 THEN &HNKC | ' AS ' | &FILENAME ELSE ' ';
 
-DOS STATE &HNKD
-SET &HOLDFILED = IF &RETCODE.EVAL EQ 0 THEN &HNKD | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKE
-SET &HOLDFILEE = IF &RETCODE.EVAL EQ 0 THEN &HNKE | ' AS ' | &FILENAME ELSE ' ';

USE ADD 
&HOLDFILEA
&HOLDFILEB
&HOLDFILEC
&HOLDFILED
&HOLDFILEE
END
-RUN


TABLE FILE RPTHLDSS1
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      DOC_NUM
      DOM_INTL_CODE      
      BR_CL_IDX
      C_ITIN
      CATEGORY
      EX_RF_FLAG
      EMBARK
      FARE_PAID
      FARE_PAID1
      FLAGA
      FST_DPT_DATE 
      FST_DEST_DEPART_DATE      
      HTL_BKD
      HOTEL_FLAG
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      PASSNGR_NAME
      PNR_LOCATOR
      PREF_CC
      NEW_STAY
      TKT_NUM
      TKT_SORT
      XTRAN_DT
      TVL_DTE
      FLAG
      VAL_AIRLINE 
      DOC_NUMBER
      EX_FLAG
      EXCHG_SALE
      EXCH_NET_FARE
      TKT_SORT
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      TRN_DATE
      RO_FLAG
      ROLLUP_CODE
      HIER
      TKT_NUM
BY ROLLUP_CODE
ON TABLE HOLD AS XTWO FORMAT FOCUS INDEX ROLLUP_CODE
END
-RUN


TABLE FILE PREFAIR
-* PRINT AIRLINE_CODE AIRLINE_CATEGORY TICKET_EFFECTIVE_DATE TICKET_EXPIRATION_DATE TSINT
PRINT AIRLINE_CODE AIRLINE_CATEGORY TICKET_EFFECTIVE_DATE TICKET_EXPIRATION_DATE TSINT GROUP_NUMBER DEPART_EFFECTIVE_DATE DEPART_EXPIRATION_DATE
BY ROLLUP_CODE
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE SET ASNAMES ON
ON TABLE HOLD AS NWPREFAIR FORMAT FOCUS INDEX ROLLUP_CODE
END
-RUN


-SET &PAIRRECS=IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-RUN 

TABLE FILE NWPREFAIR
SUM GROUP_NUMBER
BY GROUP_NUMBER NOPRINT
WHERE GROUP_NUMBER NE ' '
ON TABLE SAVE AS GROUP
END
-RUN

-SET &GROUPCK = IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';
-IF &GROUPCK EQ 'N' THEN GOTO Cont:

-READ GROUP &GN.A9
-CLOSE GROUP

-Cont:


JOIN CLEAR *
-RUN

JOIN ROLLUP_CODE IN XTWO TO ALL ROLLUP_CODE IN NWPREFAIR AS J1
-RUN
 
DEFINE FILE XTWO
-* PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
-*             IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND (FST_DPT_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND (AIRLINE_INT_DOM EQ 'B')  THEN 1 ELSE 
-*             IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND (FST_DPT_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE 0;
-IF &GROUPCK EQ 'Y' THEN GOTO NWPDEFINE;
PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
             IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B')  THEN 1 ELSE 
            IF  (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') THEN 1 ELSE 
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE 0;
-GOTO FinDefine;
-NWPDEFINE;
PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B')  AND (BR_CL_IDX EQ GROUP_NUMBER)  THEN 1 ELSE 
            IF  (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 0;
-FinDefine
END


TABLE FILE XTWO
SUM 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      EX_RF_FLAG
      FARE_PAID
      FARE_PAID1
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      EX_FLAG
      FLAGA
      EXCHG_SALE
      HTL_BKD
      RF_FLAG
      RO_FLAG
      PREF_AIRA 
COMPUTE PREF_AIR1/A1 = IF PREF_AIRA GT 0 THEN 'P' ELSE 'N';  
BY ROLLUP_CODE      
BY HIER
BY PNR_LOCATOR
BY TKT_NUM
BY TKT_SORT
BY VAL_AIRLINE
BY TRN_DATE
BY FST_DPT_DATE
BY CATEGORY
BY DOM_INTL_CODE
BY RES_SYS
ON TABLE HOLD AS XTWOA
END
-RUN

TABLE FILE XTWOA
PRINT 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      EX_RF_FLAG
      FARE_PAID
      FARE_PAID1
      HTL_BKD
      FLAGA
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      EX_FLAG
      EXCHG_SALE
      RF_FLAG
      RO_FLAG
      PREF_AIR1 
BY VAL_AIRLINE    
BY HIER
BY PNR_LOCATOR
BY TKT_NUM
BY TKT_SORT
BY TRN_DATE
BY FST_DPT_DATE
BY CATEGORY
BY DOM_INTL_CODE
BY RES_SYS      
ON TABLE HOLD AS RH1 FORMAT FOCUS INDEX VAL_AIRLINE
END

DEFINE FILE P2P_ROLLUP_BONUS
VNDR/A2 = EDIT(VENDOR, '99');
END
TABLE FILE P2P_ROLLUP_BONUS
PRINT VENDOR_TYPE VENDOR P2P_PERCENT BEGIN_DATE END_DATE 
BY VENDOR
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
WHERE VENDOR_TYPE EQ 'A'
ON TABLE HOLD AS PBBONUS FORMAT FOCUS INDEX VENDOR
END
-RUN

-SET &PAIRRECS1=IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-RUN 


JOIN VAL_AIRLINE IN RH1 TO VENDOR IN PBBONUS AS JBA
-RUN

DEFINE FILE RH1
BONUS_AIR/I5=IF '&PAIRRECS1.EVAL' EQ 'N' THEN 0 ELSE
             IF (VAL_AIRLINE EQ VENDOR) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) THEN 1 ELSE 0;
             
END
TABLE FILE RH1
SUM 7ADV 
      14ADV
      21ADV
      ADV_PURCH
      AIR_KEY
      EX_RF_FLAG
      FARE_PAID
      FARE_PAID1
      HTL_BKD
      FLAGA
      ONLA
      DISSAVINGS 
      NET_TKT_CNT
      NEW_STAY
      EX_FLAG
      EXCHG_SALE
      RF_FLAG
      RO_FLAG
      PREF_AIR1 
COMPUTE BONUS_AIR1/A1 = IF BONUS_AIR GT 0 THEN 'B' ELSE 'N';  
      P2P_PERCENT AS 'P2P_PCT'
BY HIER
BY PNR_LOCATOR
BY TRN_DATE
BY TKT_NUM
BY TKT_SORT
BY RES_SYS
ON TABLE HOLD AS RH2
END
-RUN

DEFINE FILE RH2

ONLT/A10 = IF ONLA EQ '+' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
          IF ONLA EQ '+' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' '  AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE         
          IF ONLA EQ '+' OR ' ' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
          IF ONLA EQ '+' OR ' ' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
          IF ONLA EQ '+' OR ' ' AND EX_FLAG EQ 'P' THEN '-.5/-.5' ELSE
-*          IF ONLA EQ '+' OR ' ' AND EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
-*          IF ONLA EQ '+' OR ' ' AND RF_FLAG EQ 'F' THEN '-1/-1' ELSE
-*          IF ONLA EQ '+' OR ' ' AND EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
          IF ONLA EQ '+' OR ' ' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
          IF ONLA EQ '+' OR ' ' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
          IF ONLA EQ '+' OR ' ' AND RF_FLAG EQ 'P' THEN '-.5/-.5' ELSE
          IF ONLA EQ '+' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
          IF ONLA EQ '+' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE 
          IF ONLA NE '+'  AND RO_FLAG EQ 'R' THEN '0/+1' ELSE
          IF ONLA NE '+' AND RO_FLAG EQ 'O' THEN '0/+.5' ELSE ' ';
           
7ADVT/A10 = IF 7ADV EQ '+' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
           IF 7ADV EQ '+' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' '  AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE
           IF 7ADV EQ '+' OR ' ' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
           IF 7ADV EQ '+' OR ' ' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
           IF 7ADV EQ '+' OR ' ' AND EX_FLAG EQ 'P' THEN '-.5/-.5' ELSE
-*           IF 7ADV EQ '+' OR ' ' AND EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
-*           IF 7ADV EQ '+' OR ' ' AND RF_FLAG EQ 'F' THEN '-1/-1' ELSE
-*           IF 7ADV EQ '+' OR ' ' AND EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE  
           IF 7ADV EQ '+' OR ' ' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
           IF 7ADV EQ '+' OR ' ' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
           IF 7ADV EQ '+' OR ' ' AND RF_FLAG EQ 'P' THEN '-.5/-.5' ELSE
           IF 7ADV EQ '+' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
           IF 7ADV EQ '+' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE 
           IF 7ADV NE '+' AND RO_FLAG EQ 'R' THEN '0/+1' ELSE
           IF 7ADV NE '+' AND RO_FLAG EQ 'O' THEN '0/+.5' ELSE ' '; 
           

14ADVT/A10 = IF 14ADV EQ '+' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
           IF 14ADV EQ '+' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE
           IF 14ADV EQ '+' OR ' ' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
           IF 14ADV EQ '+' OR ' ' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
           IF 14ADV EQ '+' OR ' ' AND EX_FLAG EQ 'P' THEN '-.5/-.5' ELSE
-*           IF 14ADV EQ '+' OR ' ' AND EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
-*           IF 14ADV EQ '+' OR ' ' AND RF_FLAG EQ 'F' THEN '-1/-1' ELSE
-*           IF 14ADV EQ '+' OR ' ' AND EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE    
           IF 14ADV EQ '+' OR ' ' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
           IF 14ADV EQ '+' OR ' ' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
           IF 14ADV EQ '+' OR ' ' AND RF_FLAG EQ 'P' THEN '-.5/-.5' ELSE 
           IF 14ADV EQ '+' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
           IF 14ADV EQ '+' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE 
           IF 14ADV NE '+' AND RO_FLAG EQ 'R' THEN '0/+1' ELSE
           IF 14ADV NE '+' AND RO_FLAG EQ 'O' THEN '0/+.5' ELSE ' ';            

            
21ADVT/A10 = IF 21ADV EQ '+' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
           IF 21ADV EQ '+' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE
           IF 21ADV EQ '+' OR ' ' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
           IF 21ADV EQ '+' OR ' ' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
           IF 21ADV EQ '+' OR ' ' AND EX_FLAG EQ 'P' THEN '-.5/-.5' ELSE
-*           IF 21ADV EQ '+' OR ' ' AND EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
-*           IF 21ADV EQ '+' OR ' ' AND RF_FLAG EQ 'F' THEN '-1/-1' ELSE
-*           IF 21ADV EQ '+' OR ' ' AND EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE 
           IF 21ADV EQ '+' OR ' ' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
           IF 21ADV EQ '+' OR ' ' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
           IF 21ADV EQ '+' OR ' ' AND RF_FLAG EQ 'P' THEN '-.5/-.5' ELSE 
           IF 21ADV EQ '+' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
           IF 21ADV EQ '+' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE 
           IF 21ADV NE '+' AND RO_FLAG EQ 'R' THEN '0/+1' ELSE
           IF 21ADV NE '+' AND RO_FLAG EQ 'O' THEN '0/+.5' ELSE ' ';              

          
PREFAIRT/A10 = IF PREF_AIR1 EQ 'P' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
          IF PREF_AIR1 EQ 'P' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE          
          IF PREF_AIR1 EQ 'P' OR 'N' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
          IF PREF_AIR1 EQ 'P' OR 'N' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
          IF PREF_AIR1 EQ 'P' OR 'N' AND EX_FLAG EQ 'P' THEN '-.5/-.5' ELSE
-*          IF PREF_AIR1 EQ 'P' OR 'N' AND EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
-*          IF PREF_AIR1 EQ 'P' OR 'N' AND RF_FLAG EQ 'F' THEN '-1/-1' ELSE
-*          IF PREF_AIR1 EQ 'P' OR 'N' AND EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE    
          IF PREF_AIR1 EQ 'P' OR 'N' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
          IF PREF_AIR1 EQ 'P' OR 'N' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
          IF PREF_AIR1 EQ 'P' OR 'N' AND RF_FLAG EQ 'P' THEN '-.5/-.5' ELSE 
          IF PREF_AIR1 EQ 'P' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
          IF PREF_AIR1 EQ 'P' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE 
          IF PREF_AIR1 NE 'P' AND RO_FLAG EQ 'R' THEN '+0/+1' ELSE
          IF PREF_AIR1 NE 'P' AND RO_FLAG EQ 'O' THEN '+0/+.5' ELSE ' ';          


LSTT/A10 = IF DISSAVINGS EQ 0 AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
          IF DISSAVINGS EQ 0 AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE          
          IF EX_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
          IF EX_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
          IF EX_FLAG EQ 'P' THEN '-.5/-.5' ELSE
-*          IF EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
-*           IF RF_FLAG EQ 'F' THEN '-1/-1' ELSE
-*          IF EX_RF_FLAG EQ 'R' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE    
          IF DISSAVINGS EQ 0 AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN '-1/-1' ELSE
          IF DISSAVINGS EQ 0 AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN '-.5/-.5' ELSE
          IF RF_FLAG EQ 'P' THEN '-.5/-.5' ELSE
          IF DISSAVINGS EQ 0 AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'R' THEN '+1/+1' ELSE
          IF DISSAVINGS EQ 0 AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'O' THEN '+.5/+.5' ELSE    
          IF DISSAVINGS NE 0 AND RO_FLAG EQ 'R' THEN '0/+1' ELSE
          IF DISSAVINGS NE 0 AND RO_FLAG EQ 'O' THEN '0/+.5' ELSE ' ';          

          
HTLBT/A10 = IF HTL_BKD EQ '+' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' THEN '+1/+1' ELSE
            IF HTL_BKD EQ '+' AND EX_FLAG EQ 'F' THEN '-1/-1' ELSE
            IF HTL_BKD EQ '+' AND EX_RF_FLAG EQ 'R' THEN '-1/-1' ELSE
            IF HTL_BKD EQ '+' AND EXCHG_SALE NE ' ' THEN '+1/+1' ELSE '0/+1';
-*             IF HTL_BKD NE '+' THEN '0/+1' ELSE ' ';
STAYF/A1 = IF NEW_STAY GT 0 THEN 'Y' ELSE 'N'; 
BONUS_POINT/D8.2 = IF BONUS_AIR1 EQ 'B' THEN P2P_PCT/100 ELSE 0;
ABONUS1/D8.2 = IF BONUS_AIR1 EQ 'B' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'R' THEN BONUS_POINT ELSE
             IF BONUS_AIR1 EQ 'B' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' AND RO_FLAG EQ 'O' THEN BONUS_POINT*.5 ELSE          
             IF BONUS_AIR1 EQ 'B' OR 'N' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN BONUS_POINT*(-1) ELSE
             IF BONUS_AIR1 EQ 'B' OR 'N' AND EX_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN BONUS_POINT*(-.5) ELSE
             IF BONUS_AIR1 EQ 'B' OR 'N' AND EX_FLAG EQ 'P' THEN BONUS_POINT*(-.5) ELSE
             IF BONUS_AIR1 EQ 'B' OR 'N' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'R' THEN BONUS_POINT*(-1) ELSE
             IF BONUS_AIR1 EQ 'B' OR 'N' AND RF_FLAG EQ 'F' AND RO_FLAG EQ 'O' THEN BONUS_POINT*(-.5) ELSE
             IF BONUS_AIR1 EQ 'B' OR 'N' AND RF_FLAG EQ 'P' THEN BONUS_POINT*(-.5) ELSE 
             IF BONUS_AIR1 EQ 'B' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'R' THEN BONUS_POINT ELSE
             IF BONUS_AIR1 EQ 'B' AND EXCHG_SALE NE ' ' AND RO_FLAG EQ 'O' THEN BONUS_POINT*.5 ELSE 
             IF BONUS_AIR1 NE 'B' AND RO_FLAG EQ 'R' THEN 0.00 ELSE
             IF BONUS_AIR1 NE 'B' AND RO_FLAG EQ 'O' THEN 0.00 ELSE 0.00; 
ABONUS12/A12 = FTOA(ABONUS1, '(D8.2)', 'A12');
ABONUS11/A8 = TRIM('L', ABONUS12, 12, ' ', 4, 'A8'); 

ABONUS/A30 = IF ABONUS11 EQ '.00' AND RO_FLAG EQ 'R' AND EX_FLAG EQ 'F' THEN '-'||ABONUS11||'/'||'-1.00' ELSE
             IF ABONUS11 EQ '.00' AND RO_FLAG EQ 'O' AND EX_FLAG EQ 'F' OR 'P' THEN '-'||ABONUS11||'/'||'-.50' ELSE
             IF ABONUS11 EQ '.00' AND RO_FLAG EQ 'R' AND RF_FLAG EQ 'F' THEN '-'||ABONUS11||'/'||'-1.00' ELSE             
             IF ABONUS11 EQ '.00' AND RO_FLAG EQ 'O' AND RF_FLAG EQ 'F' OR 'P' THEN '-'||ABONUS11||'/'||'-.50' ELSE              
             IF ABONUS11 EQ '.00' AND RO_FLAG EQ 'R' THEN '+'||ABONUS11||'/'||'+1.00' ELSE
             IF ABONUS11 EQ '.00' AND RO_FLAG EQ 'O' THEN '+'||ABONUS11||'/'||'+.50' ELSE
             IF ABONUS11 EQ '.00' AND RO_FLAG EQ 'R' AND EX_FLAG EQ 'F' THEN '-'||ABONUS11||'/'||'-1.00' ELSE
             IF ABONUS11 EQ '.00' AND RO_FLAG EQ 'O' AND EX_FLAG EQ 'F' THEN '-'||ABONUS11||'/'||'-.50' ELSE             
             IF ABONUS11 EQ '-.00' AND RO_FLAG EQ 'R' THEN ABONUS11||'/'||'-1.00' ELSE
             IF ABONUS11 EQ '-.00' AND RO_FLAG EQ 'O' THEN ABONUS11||'/'||'-.50' ELSE
             IF ABONUS11 OMITS '-' THEN '+'||ABONUS11||'/'||'+'||ABONUS11 ELSE ABONUS11||'/'||ABONUS11;

            
         
END      
-RUN         

        
TABLE FILE RH2
PRINT ONLT 21ADVT 14ADVT 7ADVT PREFAIRT DISSAVINGS LSTT HTLBT FLAGA STAYF TRN_DATE NEW_STAY ABONUS
BY HIER
BY PNR_LOCATOR
BY TKT_NUM
BY TKT_SORT
BY RES_SYS
ON TABLE HOLD AS AIRHLD
END
-RUN


-IF &RECORDS NE 0 THEN GOTO SETA ELSE GOTO SETA1;

-SETA
-SET &&AIRDATA='Y';
-GOTO XXIT;

-SETA1
-SET &&AIRDATA='N';
-GOTO XXIT;


-XXIT;



 

 

















