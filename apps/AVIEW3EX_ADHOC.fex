-* AVIEW3EX_ADHOC.FEX
-INCLUDE SETECHO
TABLE FILE &&RPT_HOLD
SUM DISSAVINGS AS 'DISSAV'
    FARE_PAID/D12.2CS AS 'TFARE'
    NET_TKT_CNT AS 'NTTKT'
    REF_EXCH_CNT AS 'TRFEX'
    SAVINGS AS 'TSAVE'
    TKT_PURCH AS 'TTKT'
    
-INCLUDE BYHIERARCHY
BY LEVEL_DESC

ON TABLE HOLD AS HOLDONE
END
-RUN

TABLE FILE &&RPT_HOLD
PRINT
  AROLL_DSC3
  AROLL_DSC4
  AROLL_DSC5
  AROLL_DSC7
  BKD_ONLINE
  CLIENT_NAME
  CLASS_CAT
  DISSAVINGS
  FARE_PAID
  FLAG
  IFLAG
  LEVEL1
  LEVEL2
  LEVEL3
  KM_DAYS
  KM_ADV_PUR
  KW_ADV_PUR
  GRP_ADV_PUR1
  MC_ADV_BOOK
  MRK_TKT_CNT
  MX_ADV_PUR
  MC_DAYS
  MX_DAYS
  NET_TKT_CNT
  NONREF_FLAG
  NON_REF
  NORG_APT
  NDST_APT
  REF_EXCH_CNT
  RTE_APT_NM
  SEG_AMT
  SAVINGS
  TKT_PURCH
  TRIP_PURPOSE
  UP_ADV_PUR
  UP_DAYS
  VAL_AIRLINE
  XPSNGR_NM
  
  AIRLINE
  AIRLINE_NAME
  AIRLINE_FEE
  ARR_DAY
  ARR_TIME
  BR_CL_IDX
  DPT_DAY
  DPT_TIME
  EMB_APT_CD
  RTE_APT_CD
  EMB_APT_NM
  EMB_CTY_NM
  EMB_CTY_CD
  FST_DPT_DATE
  INVOICE_NUM
  PNR_LOCATOR
  REFUSAL_DESC
  REFUSE_CODE
  TKT_NUM
  TRN_DATE
  TRVL_AUTH
  TRP_LEN
        
-INCLUDE BYHIERARCHY
BY LEVEL_DESC

BY NEW_ADV_PURCH
BY GRP_ADV_PUR
BY NEW_ADV_BOOK
ON TABLE HOLD AS XTWO
END
-RUN
 
DEFINE FILE XTWO
AROLL_DSC3_CENTERED/A60 = CTRFLD(AROLL_DSC3, 60, 'A60');
AROLL_DSC4_CENTERED/A60 = CTRFLD(AROLL_DSC4, 60, 'A60');
AROLL_DSC5_CENTERED/A60 = CTRFLD(AROLL_DSC5, 60, 'A60');
END
MATCH FILE XTWO
PRINT
  AROLL_DSC3
  AROLL_DSC3_CENTERED
  AROLL_DSC4
  AROLL_DSC4_CENTERED
  AROLL_DSC5
  AROLL_DSC5_CENTERED
  AROLL_DSC7
  BKD_ONLINE
  CLIENT_NAME
  CLASS_CAT
  DISSAVINGS
  FARE_PAID
  FLAG
  GRP_ADV_PUR
  GRP_ADV_PUR1
  IFLAG
  KM_DAYS
  KM_ADV_PUR
  KW_ADV_PUR
  LEVEL1
  LEVEL2
  LEVEL3
  NONREF_FLAG
  NORG_APT
  NDST_APT
  MC_ADV_BOOK
  MRK_TKT_CNT
  MX_ADV_PUR
  MC_DAYS
  MX_DAYS
  NET_TKT_CNT
  NEW_ADV_BOOK
  NEW_ADV_PURCH
  NON_REF
  REF_EXCH_CNT
  RTE_APT_NM
  SAVINGS
  SEG_AMT
  TKT_PURCH
  TRIP_PURPOSE
  UP_ADV_PUR
  UP_DAYS
  VAL_AIRLINE
  XPSNGR_NM
  
  AIRLINE
  AIRLINE_NAME
  AIRLINE_FEE
  ARR_DAY
  ARR_TIME
  BR_CL_IDX
  DPT_DAY
  DPT_TIME
  EMB_APT_CD
  RTE_APT_CD
  EMB_APT_NM
  EMB_CTY_NM
  EMB_CTY_CD
  FST_DPT_DATE
  INVOICE_NUM
  PNR_LOCATOR
  REFUSAL_DESC
  REFUSE_CODE
  TKT_NUM
  TRN_DATE
  TRVL_AUTH
  TRP_LEN
  
-INCLUDE BYHIERARCHY
BY LEVEL_DESC

ON TABLE HOLD
RUN
FILE HOLDONE
SUM TTKT
    TRFEX
    NTTKT
    DISSAV
    TSAVE
    TFARE
    
-INCLUDE BYHIERARCHY
BY LEVEL_DESC

AFTER MATCH HOLD AS XTHREE OLD-OR-NEW
END
-RUN
              
SET SUMMARYLINES=EXPLICIT 

DEFINE FILE XTHREE
   PCTDSAVE/D8.1 = IF ((DISSAV LT 1) AND (DISSAV GT (-1))) THEN 0
                    ELSE ((DISSAVINGS/DISSAV)*100);
    PCTFARE/D8.1S = IF ((TFARE LT 1) AND (TFARE GT (-1))) THEN 0
                    ELSE ((FARE_PAID/TFARE)*100);
    PCTNETTKT/D8.1S = IF ((NTTKT LT 1) AND (NTTKT GT (-1))) THEN 0
                    ELSE ((NET_TKT_CNT/NTTKT)*100);
    PCTRFEX/D8.1S = IF ((TRFEX LT 1) AND (TRFEX GT (-1))) THEN 0
                    ELSE ((REF_EXCH_CNT/TRFEX)*100);
    PCTSAVE/D8.1 = IF ((TSAVE LT 1) AND (TSAVE GT (-1))) THEN 0
                    ELSE ((SAVINGS/TSAVE)*100);
    PCTTKT/D8.1S = IF ((TTKT LT 1) AND (TTKT GT (-1))) THEN 0
                 ELSE ((TKT_PURCH/TTKT)*100);
  REC_CNT/D8CS = IF NET_TKT_CNT EQ 1 THEN 1 ELSE 0;
  TTLDAYS/D8 = NEW_ADV_PURCH*REC_CNT;
  TTLBDAYS/D8 = NEW_ADV_BOOK*REC_CNT;
 
  NOWTOD/A8 WITH LEVEL_DESC = HHMMSS (NOWTOD);
  
-INCLUDE DefineSubtotalFields  
   TICKETS/P8 = NET_TKT_CNT; 
END
TABLE FILE XTHREE
PRINT *
PCTDSAVE PCTFARE PCTNETTKT PCTRFEX PCTSAVE PCTTKT
ON TABLE HOLD AS AVIW3HLD
END
-RUN

-SET &&RPT_HOLD = 'AVIW3HLD';