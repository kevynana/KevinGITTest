-* File DSTM_Exchange.fex
-* Steve - Original Creation - 03/21/2008
-* Steve - Changed OFARE define - 08/19/2009
-* Joy - Changed modify for records with 2 tickets to only update OTKT_NUM2 instead of OTKT_NUM and OTKT_NUM2
-* Joy - Changed to sort and subtotal by passenger instead of counter/flag
-* Joy - Updated passenger name define to shorten PDF was going on to two pages 5/20/14
-* Deb - Added routine for Brau-r to subtotal Fare on final report
-* Deb - Removed routine for Brau-r that is not what Pat wanted 7/17/14 - Deb
-* DEB - Multiple changes to correct issue of keeping all ticket together - Deb 9/5/14
-* ADDED TRANTYPE INCLUDE - JK 12/30/14 STORY ID S-06492

-INCLUDE SETECHO

SET ASNAMES=ON
SET SPACE=1


-IF '&&SETF.EVAL' EQ 'ABEXCH1D' THEN GOTO DOM ;
-IF '&&SETF.EVAL' EQ 'ABEXCH1I' THEN GOTO INTL ELSE GOTO ALL;

-DOM
-SET &WHERE1 = 'WHERE AIR_MAIN.INTL_DOM EQ ''D''';

-GOTO Extract;

-INTL
-SET &WHERE1= 'WHERE AIR_MAIN.INTL_DOM EQ ''I''';

-GOTO Extract;

-ALL
-SET &WHERE1 = ' ';

-Extract


-
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

-* Select only Exchange Sale records for the time period and excluding MCOs
DEFINE FILE SR_50
PASSNGR_NAME/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
-INCLUDE TRANTYPE
END
TABLE FILE SR_50
PRINT PASSNGR_NAME AS 'PAXNAMA'
DOC_TYPE
PNR_LOCATOR AS 'PNRA'
TKT_DATE AS 'DATEA'
C_ITIN AS 'ITINA'
REFUSE_CODE AS 'CODEA'
TKT_NUM AS 'TICKETA'
DOC_NUMBER AS 'TICKET1'
EXCHG_SALE AS 'EXSALEA'
VAL_AIRLINE AS 'VALAIRA'
WHERE EXCHG_SALE NE ' '
-INCLUDE &AIRDATES
WHERE VOID_DATE EQ 0
WHERE DOC_TYPE NE '1'
-INCLUDE RPTPARMS
BY DOC_NUMBER NOPRINT
&WHERE1
ON TABLE HOLD AS EHOLD1 
END
-RUN



-* GET MCOS
DEFINE FILE SR_50
PASSNGR_NAME/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
END
TABLE FILE SR_50
PRINT PASSNGR_NAME PNR_LOCATOR TKT_DATE C_ITIN REFUSE_CODE TKT_NUM 
DOC_NUMBER AS 'TICKET1' EXCHG_SALE VAL_AIRLINE 
BY DOC_NUMBER NOPRINT
WHERE DOC_TYPE EQ '1'
ON TABLE HOLD AS MHOLD1
END
-RUN




MATCH FILE EHOLD1 
PRINT PAXNAMA
TICKETA
PNRA
DATEA
ITINA
CODEA
EXSALEA
VALAIRA
TICKET1
BY TICKET1 NOPRINT
RUN
FILE MHOLD1
SUM PASSNGR_NAME AS 'MPAXNAM' PNR_LOCATOR AS 'MPNR' TKT_DATE AS 'MDATE' C_ITIN AS 'MITIN' REFUSE_CODE AS 'MCODE'
    TKT_NUM AS 'MTICKETA' TICKET1 AS 'MTICKET1' EXCHG_SALE AS 'MEXSALE' VAL_AIRLINE AS 'MVALAIR'
BY TICKET1 NOPRINT
AFTER MATCH HOLD AS MATCH1A OLD
END

DEFINE FILE MATCH1A
MTKT1/A10 = IF MTICKET1 NE TICKET1 THEN MTICKET1 ELSE ' ';
END
TABLE FILE MATCH1A
SUM PAXNAMA MPAXNAM
PNRA MPNR
DATEA MDATE
ITINA MITIN
CODEA MCODE
TICKETA MTICKETA MTKT1 AS 'MTICKET1'
EXSALEA MEXSALE 
VALAIRA MVALAIR
BY TICKET1 
ON TABLE HOLD AS EHOLD1 
END
-RUN



DEFINE FILE EHOLD1
TKTN/A12 = ''''||TICKET1||'''';
END
TABLE FILE EHOLD1
SUM TKTN
BY TICKET1 NOPRINT
ON TABLE SAVE AS EXCHHLD
END
-RUN



-* -IF &RECORDS EQ 0 THEN GOTO XXIT;

-* Get all tickets related to these exchange sale tickets - maximum of 7 tickets tied together
DEFINE FILE SR_50
PASSNGR_NAME/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
END
TABLE FILE SR_50
PRINT PASSNGR_NAME PNR_LOCATOR TKT_DATE C_ITIN REFUSE_CODE TKT_NUM AS 'TICKET1' DOC_NUMBER EXCHG_SALE DOC_NUM VAL_AIRLINE
BY TKT_NUM NOPRINT 
WHERE TKT_NUM IN FILE EXCHHLD
ON TABLE HOLD AS ALLHOLD
END
-RUN


MATCH FILE EHOLD1
PRINT PAXNAMA MPAXNAM
PNRA MPNR
DATEA MDATE
ITINA MITIN
CODEA MCODE
TICKETA MTICKETA MTICKET1
EXSALEA MEXSALE 
VALAIRA MVALAIR
BY TICKET1 NOPRINT
RUN
FILE ALLHOLD
SUM PASSNGR_NAME AS 'PAXNAMB' PNR_LOCATOR AS 'PNRB' TKT_DATE AS 'DATEB' C_ITIN AS 'ITINB' REFUSE_CODE AS 'CODEB'
TICKET1 AS 'TICKETB' DOC_NUMBER AS 'TICKET2' EXCHG_SALE AS 'EXSALEB' VAL_AIRLINE AS 'VALAIRB'
BY TICKET1 NOPRINT
AFTER MATCH HOLD AS MATCH1 OLD
END


TABLE FILE MATCH1
PRINT PAXNAMA MPAXNAM PAXNAMB
PNRA MPNR PNRB
DATEA MDATE DATEB
ITINA MITIN ITINB
CODEA MCODE CODEB
TICKETA MTICKETA  TICKETB 
EXSALEA MEXSALE EXSALEB  TICKET2
VALAIRA MVALAIR VALAIRB
BY TICKET2 NOPRINT
ON TABLE HOLD AS EHOLD2
END
-RUN

DEFINE FILE SR_50
PASSNGR_NAME/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
END
TABLE FILE SR_50
PRINT SEG_COUNT PASSNGR_NAME PNR_LOCATOR TKT_DATE C_ITIN REFUSE_CODE TKT_NUM AS 'TICKET2' DOC_NUMBER EXCHG_SALE DOC_NUM VAL_AIRLINE 
BY TKT_NUM NOPRINT
WHERE TKT_NUM IN FILE EXCHHLD
ON TABLE HOLD AS ALLHOLD
END

MATCH FILE EHOLD2
PRINT PAXNAMA MPAXNAM PAXNAMB
PNRA MPNR PNRB
DATEA MDATE DATEB
ITINA MITIN ITINB
CODEA MCODE CODEB
TICKETA MTICKETA  TICKETB 
EXSALEA MEXSALE EXSALEB TICKET2
VALAIRA MVALAIR VALAIRB
BY TICKET2 NOPRINT
RUN
FILE ALLHOLD
SUM PASSNGR_NAME AS 'PAXNAMC' PNR_LOCATOR AS 'PNRC' TKT_DATE AS 'DATEC' C_ITIN AS 'ITINC' REFUSE_CODE AS 'CODEC'
TICKET2 AS 'TICKETC' DOC_NUMBER AS 'TICKET3' EXCHG_SALE AS 'EXSALEC' VAL_AIRLINE AS 'VALAIRC'
BY TICKET2 NOPRINT
AFTER MATCH HOLD AS MATCH2 OLD
END


-****

TABLE FILE MATCH2
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC
PNRA MPNR PNRB PNRC
DATEA MDATE DATEB DATEC
ITINA MITIN ITINB ITINC
CODEA MCODE CODEB CODEC
TICKETA MTICKETA  TICKETB  TICKETC
EXSALEA MEXSALE EXSALEB EXSALEC TICKET3
VALAIRA MVALAIR VALAIRB VALAIRC
BY TICKET3 NOPRINT
ON TABLE HOLD AS EHOLD3
END
-RUN


DEFINE FILE SR_50
PASSNGR_NAME/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
END
TABLE FILE SR_50
PRINT PASSNGR_NAME PNR_LOCATOR TKT_DATE C_ITIN REFUSE_CODE TKT_NUM AS 'TICKET3' DOC_NUMBER EXCHG_SALE DOC_NUM VAL_AIRLINE
BY TKT_NUM NOPRINT
WHERE TKT_NUM IN FILE EXCHHLD
ON TABLE HOLD AS ALLHOLD
END

MATCH FILE EHOLD3
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC
PNRA MPNR PNRB PNRC
DATEA MDATE DATEB DATEC
ITINA MITIN ITINB ITINC
CODEA MCODE CODEB CODEC
TICKETA MTICKETA  TICKETB  TICKETC
EXSALEA MEXSALE EXSALEB EXSALEC TICKET3
VALAIRA MVALAIR VALAIRB VALAIRC
BY TICKET3 NOPRINT
RUN
FILE ALLHOLD
SUM PASSNGR_NAME AS 'PAXNAMD' PNR_LOCATOR AS 'PNRD' TKT_DATE AS 'DATED' C_ITIN AS 'ITIND' REFUSE_CODE AS 'CODED' 
TICKET3 AS 'TICKETD' DOC_NUMBER AS 'TICKET4' 
EXCHG_SALE AS 'EXSALED' VAL_AIRLINE AS 'VALAIRD'
BY TICKET3 NOPRINT
AFTER MATCH HOLD AS MATCH3 OLD
END

-****

TABLE FILE MATCH3
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC PAXNAMD
PNRA MPNR PNRB PNRC PNRD
DATEA MDATE DATEB DATEC DATED
ITINA MITIN ITINB ITINC ITIND
CODEA MCODE CODEB CODEC CODED
TICKETA MTICKETA  TICKETB  TICKETC TICKETD
EXSALEA MEXSALE EXSALEB EXSALEC EXSALED TICKET4
VALAIRA MVALAIR VALAIRB VALAIRC VALAIRD
BY TICKET4 NOPRINT
ON TABLE HOLD AS EHOLD4
END
-RUN

DEFINE FILE SR_50
PASSNGR_NAME/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
END
TABLE FILE SR_50
PRINT PASSNGR_NAME PNR_LOCATOR TKT_DATE C_ITIN REFUSE_CODE TKT_NUM AS 'TICKET4' DOC_NUMBER EXCHG_SALE DOC_NUM VAL_AIRLINE
BY TKT_NUM NOPRINT
WHERE TKT_NUM IN FILE EXCHHLD
ON TABLE HOLD AS ALLHOLD
END
-RUN
 

MATCH FILE EHOLD4
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC PAXNAMD
PNRA MPNR PNRB PNRC PNRD
DATEA MDATE DATEB DATEC DATED
ITINA MITIN ITINB ITINC ITIND
CODEA MCODE CODEB CODEC CODED
TICKETA MTICKETA  TICKETB  TICKETC TICKETD
EXSALEA MEXSALE EXSALEB EXSALEC EXSALED TICKET4
VALAIRA MVALAIR VALAIRB VALAIRC VALAIRD
BY TICKET4 NOPRINT
RUN
FILE ALLHOLD
SUM PASSNGR_NAME AS 'PAXNAME' PNR_LOCATOR AS 'PNRE' TKT_DATE AS 'DATEE' C_ITIN AS 'ITINE' REFUSE_CODE AS 'CODEE'
TICKET4 AS 'TICKETE' DOC_NUMBER AS 'TICKET5'
EXCHG_SALE AS 'EXSALEE'
VAL_AIRLINE AS 'VALAIRE'
BY TICKET4 NOPRINT
AFTER MATCH HOLD AS MATCH4 OLD
END

-****

TABLE FILE MATCH4
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC PAXNAMD PAXNAME
PNRA MPNR PNRB PNRC PNRD PNRE
DATEA MDATE DATEB DATEC DATED DATEE
ITINA MITIN ITINB ITINC ITIND ITINE
CODEA MCODE CODEB CODEC CODED CODEE
TICKETA MTICKETA  TICKETB  TICKETC TICKETD TICKETE
EXSALEA MEXSALE EXSALEB EXSALEC EXSALED EXSALEE TICKET5
VALAIRA MVALAIR VALAIRB VALAIRC VALAIRD VALAIRE
BY TICKET5 NOPRINT
ON TABLE HOLD AS EHOLD5
END
-RUN



DEFINE FILE SR_50
PASSNGR_NAME/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
END
-RUN
TABLE FILE SR_50
PRINT PASSNGR_NAME PNR_LOCATOR TKT_DATE C_ITIN REFUSE_CODE TKT_NUM AS 'TICKET5' DOC_NUMBER EXCHG_SALE DOC_NUM VAL_AIRLINE
BY TKT_NUM NOPRINT
WHERE TKT_NUM IN FILE EXCHHLD
ON TABLE HOLD AS ALLHOLD
END

MATCH FILE EHOLD5
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC PAXNAMD PAXNAME
PNRA MPNR PNRB PNRC PNRD PNRE
DATEA MDATE DATEB DATEC DATED DATEE
ITINA MITIN ITINB ITINC ITIND ITINE
CODEA MCODE CODEB CODEC CODED CODEE
TICKETA MTICKETA  TICKETB  TICKETC TICKETD TICKETE
EXSALEA MEXSALE EXSALEB EXSALEC EXSALED EXSALEE TICKET5
VALAIRA MVALAIR VALAIRB VALAIRC VALAIRD VALAIRE
BY TICKET5 NOPRINT
RUN
FILE ALLHOLD
SUM PASSNGR_NAME AS 'PAXNAMF' PNR_LOCATOR AS 'PNRF' TKT_DATE AS 'DATEF' C_ITIN AS 'ITINF' REFUSE_CODE AS 'CODEF'
TICKET5 AS 'TICKETF' DOC_NUMBER AS 'TICKET6'
EXCHG_SALE AS 'EXSALEF'
VAL_AIRLINE AS 'VALAIRF'
BY TICKET5 NOPRINT
AFTER MATCH HOLD AS MATCH5 OLD
END

-****

TABLE FILE MATCH5
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC PAXNAMD PAXNAME PAXNAMF
PNRA MPNR PNRB PNRC PNRD PNRE PNRF
DATEA MDATE DATEB DATEC DATED DATEE DATEF
ITINA MITIN ITINB ITINC ITIND ITINE ITINF
CODEA MCODE CODEB CODEC CODED CODEE CODEF
TICKETA MTICKETA  TICKETB  TICKETC TICKETD TICKETE TICKETF
EXSALEA MEXSALE EXSALEB EXSALEC EXSALED EXSALEE EXSALEF TICKET6
VALAIRA MVALAIR VALAIRB VALAIRC VALAIRD VALAIRE VALAIRF
BY TICKET6 NOPRINT
ON TABLE HOLD AS EHOLD6
END
-RUN

DEFINE FILE SR_50
PASSNGR_NAME/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
END
TABLE FILE SR_50
PRINT PASSNGR_NAME PNR_LOCATOR TKT_DATE C_ITIN REFUSE_CODE TKT_NUM AS 'TICKET6' DOC_NUMBER EXCHG_SALE DOC_NUM VAL_AIRLINE
BY TKT_NUM NOPRINT
WHERE TKT_NUM IN FILE EXCHHLD
ON TABLE HOLD AS ALLHOLD
END

MATCH FILE EHOLD6
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC PAXNAMD PAXNAME PAXNAMF
PNRA MPNR PNRB PNRC PNRD PNRE PNRF
DATEA MDATE DATEB DATEC DATED DATEE DATEF
ITINA MITIN ITINB ITINC ITIND ITINE ITINF
CODEA MCODE CODEB CODEC CODED CODEE CODEF
TICKETA MTICKETA  TICKETB TICKETC TICKETD TICKETE TICKETF
EXSALEA MEXSALE EXSALEB EXSALEC EXSALED EXSALEE EXSALEF TICKET6
VALAIRA MVALAIR VALAIRB VALAIRC VALAIRD VALAIRE VALAIRF
BY TICKET6 NOPRINT
RUN
FILE ALLHOLD
SUM PASSNGR_NAME AS 'PAXNAMG' PNR_LOCATOR AS 'PNRG' TKT_DATE AS 'DATEG' C_ITIN AS 'ITING' REFUSE_CODE AS 'CODEG'
TICKET6 AS 'TICKETG' DOC_NUMBER AS 'TICKET7'
EXCHG_SALE AS 'EXSALEG'
VAL_AIRLINE AS 'VALAIRG'
BY TICKET6 NOPRINT
AFTER MATCH HOLD AS MATCH6 OLD
END

-****

TABLE FILE MATCH6
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC PAXNAMD PAXNAME PAXNAMF PAXNAMG
PNRA MPNR PNRB PNRC PNRD PNRE PNRF PNRG
DATEA MDATE DATEB DATEC DATED DATEE DATEF DATEG
ITINA MITIN ITINB ITINC ITIND ITINE ITINF ITING
CODEA MCODE CODEB CODEC CODED CODEE CODEF CODEG
TICKETA MTICKETA  TICKETB TICKETC TICKETD TICKETE TICKETF TICKETG
EXSALEA MEXSALE EXSALEB EXSALEC EXSALED EXSALEE EXSALEF EXSALEG TICKET7
VALAIRA MVALAIR VALAIRB VALAIRC VALAIRD VALAIRE VALAIRF VALAIRG
BY TICKET7 NOPRINT
ON TABLE HOLD AS EHOLD7
END
-RUN





DEFINE FILE SR_50
PASSNGR_NAME/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
END
-RUN
TABLE FILE SR_50
PRINT PASSNGR_NAME PNR_LOCATOR TKT_DATE C_ITIN REFUSE_CODE TKT_NUM AS 'TICKET7' DOC_NUMBER EXCHG_SALE DOC_NUM VAL_AIRLINE 
BY TKT_NUM NOPRINT
WHERE TKT_NUM IN FILE EXCHHLD
&WHERE1
ON TABLE HOLD AS ALLHOLD
END

MATCH FILE EHOLD7
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC PAXNAMD PAXNAME PAXNAMF PAXNAMG
PNRA MPNR PNRB PNRC PNRD PNRE PNRF PNRG
DATEA MDATE DATEB DATEC DATED DATEE DATEF DATEG
ITINA MITIN ITINB ITINC ITIND ITINE ITINF ITING
CODEA MCODE CODEB CODEC CODED CODEE CODEF CODEG
TICKETA MTICKETA  TICKETB TICKETC TICKETD TICKETE TICKETF TICKETG
EXSALEA MEXSALE EXSALEB EXSALEC EXSALED EXSALEE EXSALEF EXSALEG TICKET7
VALAIRA MVALAIR VALAIRB VALAIRC VALAIRD VALAIRE VALAIRF VALAIRG
BY TICKET7 NOPRINT
RUN
FILE ALLHOLD
SUM PASSNGR_NAME AS 'PAXNAMH' PNR_LOCATOR AS 'PNRH' TKT_DATE AS 'DATEH' C_ITIN AS 'ITINH' REFUSE_CODE AS 'CODEH'
TICKET7 AS 'TICKETH' DOC_NUMBER AS 'TICKET8'
EXCHG_SALE AS 'EXSALEH'
VAL_AIRLINE AS 'VALAIRH'
BY TICKET7 NOPRINT
AFTER MATCH HOLD AS MATCH7 OLD
END
-RUN

-*
DEFINE FILE MATCH7
PAX/A15 = EDIT(PAXNAMA, '999999999999999');
END
TABLE FILE MATCH7
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC PAXNAMD PAXNAME PAXNAMF PAXNAMG PAXNAMH
PNRA MPNR PNRB PNRC PNRD PNRE PNRF PNRG PNRH
DATEA MDATE DATEB DATEC DATED DATEE DATEF DATEG DATEH
ITINA MITIN ITINB ITINC ITIND ITINE ITINF ITING ITINH
CODEA MCODE CODEB CODEC CODED CODEE CODEF CODEG CODEH
TICKETA MTICKETA TICKETB TICKETC TICKETD TICKETE TICKETF TICKETG TICKETH
EXSALEA MEXSALE EXSALEB EXSALEC EXSALED EXSALEE EXSALEF EXSALEG EXSALEH
VALAIRA MVALAIR VALAIRB VALAIRC VALAIRD VALAIRE VALAIRF VALAIRG VALAIRH  
BY PAX NOPRINT
ON TABLE HOLD AS HOLD1
END
-RUN
 

TABLE FILE MATCH7
PRINT PAXNAMA PAXNAMB PAXNAMC PAXNAMD PAXNAME PAXNAMF PAXNAMG PAXNAMH
PNRA PNRB PNRC PNRD PNRE PNRF PNRG PNRH
DATEA DATEB DATEC DATED DATEE DATEF DATEG DATEH
ITINA ITINB ITINC ITIND ITINE ITINF ITING ITINH
CODEA CODEB CODEC CODED CODEE CODEF CODEG CODEH
TICKETA TICKETB TICKETC TICKETD TICKETE TICKETF TICKETG TICKETH
EXSALEA EXSALEB EXSALEC EXSALED EXSALEE EXSALEF EXSALEG EXSALEH
BY PAXNAMA NOPRINT
ON TABLE HOLD
END
-RUN









-* Setup counter to keep tickets grouped together

DEFINE FILE HOLD1
COUNTR/I5 = COUNTR + 1;
END
-RUN

TABLE FILE HOLD1
PRINT PAXNAMA MPAXNAM PAXNAMB PAXNAMC PAXNAMD PAXNAME PAXNAMF PAXNAMG PAXNAMH
PNRA MPNR PNRB PNRC PNRD PNRE PNRF PNRG PNRH
DATEA MDATE DATEB DATEC DATED DATEE DATEF DATEG DATEH
ITINA MITIN ITINB ITINC ITIND ITINE ITINF ITING ITINH
CODEA MCODE CODEB CODEC CODED CODEE CODEF CODEG CODEH
TICKETA MTICKETA  TICKETB TICKETC TICKETD TICKETE TICKETF TICKETG TICKETH
EXSALEA MEXSALE EXSALEB EXSALEC EXSALED EXSALEE EXSALEF EXSALEG EXSALEH
VALAIRA MVALAIR VALAIRB VALAIRC VALAIRD VALAIRE VALAIRF VALAIRG VALAIRH  COUNTR
ON TABLE HOLD AS HOLD2
END
-RUN


-* Update temporary reporting database (EXCHRCDS)

CREATE FILE EXCHRCDS
END
-RUN

-* Work backwards from records that have 8 tickets tied together down to 1 ticket

-* TICKET #8 - Look for only records that have 8 tickets
DEFINE FILE HOLD2
TKTG/A10 = IF MTICKETA EQ ' ' THEN TKTG ELSE MTICKETA;
END
TABLE FILE HOLD2
PRINT TICKETH AS 'TKT_NUM' TICKETG AS 'OTKT_NUM' TKTG AS 'OTKT_NUM2' ITINH AS 'ITIN' COUNTR PAXNAMH AS 'PAXNAM' DATEH AS 'DATE' EXSALEH AS 'EXSALE' 
      VALAIRH AS 'VAL_AIRLINE' CODEH AS 'CODE'
WHERE TICKETH NE ' '
ON TABLE HOLD AS FINAL
END
-RUN


MODIFY FILE EXCHRCDS
LOG DUPL MSG OFF
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON FINAL
END
-RUN

MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH UPDATE OTKT_NUM2
ON NOMATCH REJECT
DATA ON FINAL
END
-RUN


-* TICKET #7 - Look for only records that have 7 tickets
DEFINE FILE HOLD2
TKTF/A10 = IF MTICKETA EQ ' ' THEN TKTF ELSE MTICKETA;
END
TABLE FILE HOLD2
PRINT TICKETG AS 'TKT_NUM' TICKETF AS 'OTKT_NUM' TKTF AS 'OTKT_NUM2' ITING AS 'ITIN' COUNTR PAXNAMG AS 'PAXNAM' DATEG AS 'DATE' 
      EXSALEG AS 'EXSALE' VALAIRG AS 'VAL_AIRLINE' CODEG AS 'CODE'
WHERE TICKETG NE ' '
ON TABLE HOLD AS FINAL
END
-RUN

MODIFY FILE EXCHRCDS
LOG DUPL MSG OFF
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON FINAL
END
-RUN

MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH UPDATE OTKT_NUM2
ON NOMATCH REJECT
DATA ON FINAL
END
-RUN


-* TICKET #6 - Look for only records that have 6 tickets
DEFINE FILE HOLD2
TKTE/A10 = IF MTICKETA EQ ' ' THEN TICKETE ELSE MTICKETA;
END
TABLE FILE HOLD2
PRINT TICKETF AS 'TKT_NUM' TICKETE AS 'OTKT_NUM' TKTE AS 'OTKT_NUM2' ITINF AS 'ITIN' COUNTR PAXNAMF AS 'PAXNAM' DATEF AS 'DATE' 
      EXSALEF AS 'EXSALE' VALAIRF AS 'VAL_AIRLINE' CODEF AS 'CODE'
WHERE TICKETF NE ' '
ON TABLE HOLD AS FINAL
END


MODIFY FILE EXCHRCDS
LOG DUPL MSG OFF
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON FINAL
END
-RUN

MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH UPDATE OTKT_NUM2
ON NOMATCH REJECT
DATA ON FINAL
END
-RUN


-* TICKET #5 - Look for only records that have 5 tickets
DEFINE FILE HOLD2
TKTD/A10 = IF MTICKETA EQ ' ' THEN TICKETD ELSE MTICKETA;
END
TABLE FILE HOLD2
PRINT TICKETE AS 'TKT_NUM' TICKETD AS 'OTKT_NUM' TKTD AS 'OTKT_NUM2' ITINE AS 'ITIN' COUNTR PAXNAME AS 'PAXNAM' DATEE AS 'DATE' 
      EXSALEE AS 'EXSALE' VALAIRE AS 'VAL_AIRLINE' CODEE AS 'CODE'
WHERE TICKETE NE ' '
ON TABLE HOLD AS FINAL
END
-RUN


MODIFY FILE EXCHRCDS
LOG DUPL MSG OFF
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON FINAL
END
-RUN

MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH UPDATE OTKT_NUM2
ON NOMATCH REJECT
DATA ON FINAL
END
-RUN


-* TICKET #4 - Look for only records that have 4 tickets
 

DEFINE FILE HOLD2
TKTC/A10 = IF MTICKETA EQ ' ' THEN TICKETC ELSE MTICKETA;
END
TABLE FILE HOLD2
PRINT TICKETD AS 'TKT_NUM' TICKETC AS 'OTKT_NUM'  TKTC AS 'OTKT_NUM2' ITIND AS 'ITIN' COUNTR PAXNAMD AS 'PAXNAM' DATED AS 'DATE'
      EXSALED AS 'EXSALE' VALAIRC AS 'VAL_AIRLINE' CODED AS 'CODE'
WHERE TICKETD NE ' '
ON TABLE HOLD AS FINAL
END
-RUN


MODIFY FILE EXCHRCDS
LOG DUPL MSG OFF
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON FINAL
END
-RUN

MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH UPDATE OTKT_NUM2
ON NOMATCH REJECT
DATA ON FINAL
END
-RUN

-* TICKET #3 - Look for only records that have 3 tickets
 
DEFINE FILE HOLD2
TKTB/A10 = IF MTICKETA EQ ' ' THEN TICKETB ELSE MTICKETA;
END
TABLE FILE HOLD2
PRINT TICKETC AS 'TKT_NUM' TICKETB AS 'OTKT_NUM' TKTB AS 'OTKT_NUM2' ITINC AS 'ITIN' COUNTR PAXNAMC AS 'PAXNAM' DATEC AS 'DATE' 
      EXSALEC AS 'EXSALE' VALAIRB AS 'VAL_AIRLINE' CODEC AS 'CODE'
WHERE TICKETC NE ' '
ON TABLE HOLD AS FINAL
END
-RUN


MODIFY FILE EXCHRCDS
LOG DUPL MSG OFF
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON FINAL
END
-RUN


MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH UPDATE OTKT_NUM2
ON NOMATCH REJECT
DATA ON FINAL
END
-RUN
 
 
-* TICKET #2 - Look for only records that have 2 tickets
DEFINE FILE HOLD2
TKTA/A10 = IF MTICKETA EQ ' ' THEN TICKETA ELSE MTICKETA;
END
TABLE FILE HOLD2
PRINT TICKETB AS 'TKT_NUM' TICKETA AS 'OTKT_NUM' TICKETA AS 'OTKT_NUM2' ITINB AS 'ITIN' COUNTR PAXNAMB AS 'PAXNAM' DATEB AS 'DATE' 
      EXSALEB AS 'EXSALE' VALAIRA AS 'VAL_AIRLINE' CODEB AS 'CODE' 
WHERE TICKETB NE ' '
ON TABLE HOLD AS FINAL
END
-RUN


MODIFY FILE EXCHRCDS
LOG DUPL MSG OFF
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM 
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON FINAL
END
-RUN


MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
-* ON MATCH UPDATE OTKT_NUM OTKT_NUM2
ON MATCH UPDATE OTKT_NUM2
ON NOMATCH REJECT
DATA ON FINAL
END
-RUN


-* TICKET #1 - Look for only records that have 1 ticket

DEFINE FILE HOLD2
BLANK/A10=' ';
END
TABLE FILE HOLD2
PRINT TICKETA AS 'TKT_NUM' BLANK AS 'OTKT_NUM' BLANK AS 'OTKT_NUM2' ITINA AS 'ITIN' COUNTR PAXNAMA AS 'PAXNAM' DATEA AS 'DATE' 
      EXSALEA AS 'EXSALE' VALAIRA AS 'VAL_AIRLINE' CODEA AS 'CODE'
WHERE TICKETA NE ' '
ON TABLE HOLD AS FINAL
END
-RUN

MODIFY FILE EXCHRCDS
LOG DUPL MSG OFF
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON FINAL
END
-RUN


MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH UPDATE OTKT_NUM2
ON NOMATCH REJECT
DATA ON FINAL
END
-RUN



-* UNEXCHANGED MCO TICKETS 

DEFINE FILE HOLD2
BLANK/A10=' ';
END
TABLE FILE HOLD2
PRINT MTICKETA AS 'TKT_NUM'  BLANK AS 'OTKT_NUM' BLANK AS 'OTKT_NUM2' MITIN AS 'ITIN' COUNTR MPAXNAM AS 'PAXNAM' MDATE AS 'DATE' 
      MEXSALE AS 'EXSALE' MVALAIR AS 'VAL_AIRLINE' MCODE AS 'CODE'
WHERE MTICKETA NE ' '
ON TABLE HOLD AS FINAL
END
-RUN


MODIFY FILE EXCHRCDS
LOG DUPL MSG OFF
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON FINAL
END
-RUN

MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM FINAL
MATCH TKT_NUM
ON MATCH UPDATE OTKT_NUM2
ON NOMATCH REJECT
DATA ON FINAL
END
-RUN



-* Update Counter for tickets that belong together


TABLE FILE EXCHRCDS
PRINT COUNTR  
BY OTKT_NUM AS 'TKT_NUM'
WHERE OTKT_NUM NE ' '
ON TABLE HOLD AS OCOUNT1
END
-RUN


TABLE FILE EXCHRCDS
PRINT TKT_NUM  
WHERE OTKT_NUM EQ ' '
ON TABLE HOLD AS TCOUNT1
END
-RUN


MATCH FILE TCOUNT1
PRINT TKT_NUM
BY TKT_NUM NOPRINT
RUN
FILE OCOUNT1
SUM COUNTR
BY TKT_NUM NOPRINT
AFTER MATCH HOLD AS HOLDCNT1 OLD
END
-RUN

TABLE FILE HOLDCNT1
PRINT COUNTR
BY TKT_NUM
WHERE COUNTR NE 0
ON TABLE HOLD AS HOLDCNT1A
END
-RUN



MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM HOLDCNT1A
MATCH TKT_NUM
ON MATCH UPDATE COUNTR
ON NOMATCH REJECT
DATA ON HOLDCNT1A
END
-RUN


TABLE FILE EXCHRCDS
PRINT OTKT_NUM2 AS 'TKT_NUM' COUNTR
WHERE OTKT_NUM2 NE ' ' 
ON TABLE HOLD AS OCOUNT2
END
-RUN

TABLE FILE EXCHRCDS
PRINT TKT_NUM COUNTR
-*WHERE OTKT_NUM2 EQ ' '
ON TABLE HOLD AS TCOUNT2
END
-RUN

MATCH FILE TCOUNT2
PRINT TKT_NUM
BY TKT_NUM NOPRINT
RUN
FILE OCOUNT2
SUM COUNTR
BY TKT_NUM NOPRINT
AFTER MATCH HOLD AS HOLDCNT2 OLD
END
-RUN


-* NEW CODE

TABLE FILE HOLDCNT2
PRINT COUNTR
BY TKT_NUM
WHERE COUNTR NE 0
ON TABLE HOLD AS HOLDCNT3
END
-RUN

MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM HOLDCNT3
MATCH TKT_NUM
ON MATCH UPDATE COUNTR
ON NOMATCH REJECT
DATA ON HOLDCNT3
END
-RUN


TABLE FILE EXCHRCDS
PRINT OTKT_NUM2 AS 'TKT_NUM' COUNTR
WHERE OTKT_NUM2 NE ' ' 
ON TABLE HOLD AS OCOUNT3
END
-RUN


TABLE FILE EXCHRCDS
PRINT TKT_NUM COUNTR
WHERE OTKT_NUM2 EQ ' '
ON TABLE HOLD AS TCOUNT3
END
-RUN


MATCH FILE TCOUNT3
PRINT TKT_NUM
BY TKT_NUM NOPRINT
RUN
FILE OCOUNT3
SUM COUNTR
BY TKT_NUM NOPRINT
AFTER MATCH HOLD AS HOLDCNT4 OLD
END
-RUN

TABLE FILE HOLDCNT4
PRINT COUNTR
BY TKT_NUM
WHERE COUNTR NE 0
ON TABLE HOLD AS HOLDCNT5
END
-RUN


MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM HOLDCNT5
MATCH TKT_NUM
ON MATCH UPDATE COUNTR
ON NOMATCH REJECT
DATA ON HOLDCNT5
END
-RUN


-* Get Fare And Net Fare And Advance Purchase Days and Document Type

DEFINE FILE AIR_MAIN
FARE/D7.2 = TICKET_AMT + TAX_AMT;
NFARE/D7.2 = EXCH_NET_FARE + EXCH_NET_TAX;
END

TABLE FILE AIR_MAIN
PRINT TKT_NUM FARE NFARE ADV_PURCH DOC_TYPE
BY TKT_NUM NOPRINT
ON TABLE HOLD
END

MODIFY FILE EXCHRCDS
LOG NOMATCH MSG OFF
FIXFORM FROM HOLD
MATCH TKT_NUM
ON MATCH UPDATE FARE NFARE ADV_PURCH DOC_TYPE
ON NOMATCH REJECT
DATA ON HOLD
END

-* Get Penalty Amounts (FP2)

DEFINE FILE SR_50
EPENALTY/D7.2 = SEG_AMT + SEG_TAX;
END

TABLE FILE SR_50
PRINT TKT_NUM EPENALTY
WHERE EMBARK EQ 'FP2'
ON TABLE HOLD AS AHOLD
END
-RUN

TABLE FILE EXCHRCDS
PRINT TKT_NUM OTKT_NUM OTKT_NUM2 ITIN COUNTR PAXNAM DATE EXSALE VAL_AIRLINE FARE NFARE ADV_PURCH DOC_TYPE CODE
BY DATE NOPRINT
BY TKT_NUM NOPRINT
ON TABLE HOLD AS EHOLD
END
-RUN


MATCH FILE EHOLD
PRINT TKT_NUM OTKT_NUM OTKT_NUM2 ITIN COUNTR PAXNAM DATE EXSALE VAL_AIRLINE FARE NFARE ADV_PURCH DOC_TYPE CODE
BY TKT_NUM NOPRINT
RUN
FILE AHOLD
SUM EPENALTY
BY TKT_NUM NOPRINT
AFTER MATCH HOLD AS MATCHD OLD
END
-RUN 

-* Get Departure and Return Dates
-* Departure Dates

TABLE FILE SR_50
PRINT TKT_NUM DPT_DATE DPT_TIME
WHERE SEG_NBR EQ '01'
ON TABLE HOLD AS AHOLD
END
-RUN

TABLE FILE MATCHD
PRINT TKT_NUM OTKT_NUM OTKT_NUM2 ITIN COUNTR PAXNAM DATE EXSALE VAL_AIRLINE FARE NFARE ADV_PURCH DOC_TYPE CODE EPENALTY
BY DATE NOPRINT
BY TKT_NUM NOPRINT
ON TABLE HOLD AS EHOLD
END
-RUN

MATCH FILE EHOLD
PRINT TKT_NUM OTKT_NUM OTKT_NUM2 ITIN COUNTR PAXNAM DATE EXSALE VAL_AIRLINE FARE NFARE ADV_PURCH DOC_TYPE CODE EPENALTY
BY TKT_NUM NOPRINT
RUN
FILE AHOLD
SUM DPT_DATE DPT_TIME
BY TKT_NUM NOPRINT
AFTER MATCH HOLD AS MATCHD OLD
END

-* Return Dates

TABLE FILE SR_50
SUM ARR_DATE ARR_TIME
BY TKT_NUM
BY SEG_NBR NOPRINT
WHERE SEG_COUNT EQ 1
ON TABLE HOLD AS AHOLD
END

TABLE FILE AHOLD
SUM ARR_DATE ARR_TIME
BY TKT_NUM
ON TABLE HOLD AS AHOLD
END

TABLE FILE MATCHD
PRINT TKT_NUM OTKT_NUM OTKT_NUM2 ITIN COUNTR PAXNAM DATE EXSALE VAL_AIRLINE FARE NFARE ADV_PURCH DOC_TYPE CODE EPENALTY DPT_DATE DPT_TIME
BY DATE NOPRINT
BY TKT_NUM NOPRINT
ON TABLE HOLD AS EHOLD
END
-RUN

MATCH FILE EHOLD
PRINT TKT_NUM OTKT_NUM OTKT_NUM2 ITIN COUNTR PAXNAM DATE EXSALE VAL_AIRLINE FARE NFARE ADV_PURCH DOC_TYPE CODE EPENALTY DPT_DATE DPT_TIME
BY TKT_NUM NOPRINT
RUN
FILE AHOLD
SUM ARR_DATE ARR_TIME
BY TKT_NUM NOPRINT
AFTER MATCH HOLD AS MATCHD OLD
END
-RUN


-SET &&NOEXCHREC = IF &LINES EQ 0 THEN 'Y' ELSE 'N';

-IF &&NOEXCHREC EQ 'Y' THEN GOTO XXITA;


-* Final Defines

DEFINE FILE MATCHD
-* Steve - changed definition of OFARE below to always be NFARE - August 19, 2009
-* OFARE/D7.2 = IF EXSALE EQ ' ' THEN FARE ELSE IF NFARE EQ 0 AND EPENALTY NE 0 THEN EPENALTY ELSE NFARE;
OFARE/D7.2 = IF EXSALE EQ ' ' THEN FARE ELSE NFARE;
FITIN/A67 = IF DOC_TYPE EQ '1' THEN 'Miscellaneous Charge Order (MCO)' ELSE ITIN;
NTKT/A25 = IF OTKT_NUM EQ OTKT_NUM2 THEN OTKT_NUM ELSE 
           IF OTKT_NUM2 EQ ' ' THEN OTKT_NUM ELSE OTKT_NUM|' and '|OTKT_NUM2;
FLAG/A1 = ' ';
PAXNAME1/A15 = EDIT(PAXNAM, '999999999999999');
NOWTOD/A8 WITH TKT_NUM = HHMMSS (NOWTOD);
-INCLUDE STDTIME
END

-SET &&RPTSUF = 'DTL';

-INCLUDE FDEFRPTS
-RUN

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADAIR' ELSE 'HDREXLS'; 
-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'DTEXL' ELSE &&DTSTY;
-RUN

TABLE FILE MATCHD
-INCLUDE &&PAHDR
-*PRINT PAXNAME1 AS 'Passenger,Name' DATE AS 'Tran,Date' TKT_NUM AS 'Original,Ticket' NTKT AS 'New Ticket(s)' CODE AS 'Rsn,Cde'
PRINT PAXNAM AS 'Passenger,Name' DATE AS 'Tran,Date' TKT_NUM AS 'Original,Ticket' NTKT AS 'New Ticket(s)' CODE AS 'Rsn,Cde'
VAL_AIRLINE AS 'Airline' FITIN AS 'Itinerary' DPT_DATE/MDY AS 'Depart,Date' TIME_DPT AS 'Depart,Time' ARR_DATE/MDY AS 'Return,Date' 
TIME_ARR AS 'Return,Time' ADV_PURCH AS 'Adv,Purch' FARE/D12.2 AS 'Ticket,Price' EPENALTY/D12.2 AS 'Forfeit/,Penalty,Amount' 
OFARE/D12.2 AS 'Out of Pocket,Expense'
BY COUNTR NOPRINT  
BY PAXNAM  NOPRINT

BY FLAG NOPRINT 
BY DATE  NOPRINT

BY TKT_NUM  NOPRINT
ON COUNTR SKIP-LINE
ON FLAG RECOMPUTE EPENALTY OFARE AS 'Totals'


-INCLUDE FOOTERDT
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
-INCLUDE &&PASTYD
-GOTO JOY
UNITS=IN, PAGESIZE='Letter', LEFTMARGIN=0.250000, RIGHTMARGIN=0.250000, 
    TOPMARGIN=0.500000, BOTTOMMARGIN=0.250000, SQUEEZE=ON, 
    ORIENTATION=LANDSCAPE, $
TYPE=REPORT, FONT=TIMES NEW ROMAN, SIZE=6, BACKCOLOR=NONE, STYLE=NORMAL, $
TYPE=HEADING, OBJECT=TEXT, SIZE=7, COLOR=BLACK, $
TYPE=HEADING, LINE=4, SIZE=8, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=5, SIZE=8, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=6, SIZE=8, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=7, SIZE=8, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=8, SIZE=8, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=10, SIZE=8, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=11, SIZE=12, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=HEADING, LINE=12, SIZE=12, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=FOOTING, SIZE=7, STYLE=BOLD, COLOR=GREY, $
TYPE=TITLE, STYLE=BOLD, $
TYPE=SUBTOTAL, SIZE=7, STYLE=BOLD, $
TYPE=GRANDTOTAL, SIZE=7, STYLE=BOLD, $
TYPE=REPORT, IMAGE=&&TNTPIC,  POSITION=(&&TNTDTPOS), SIZE=(&&TNTDTSIZ), $
TYPE=REPORT, IMAGE=&&ROLLPIC, POSITION=(&&ROLDTPOS), SIZE=(&&ROLDTSIZ), $
-JOY
ENDSTYLE
-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN
-GOTO XXITA;



-XXITA;