-* 4/27/04  SAC   ADDED TRP_REF AND NHR_REF
-*  10/13/2016  REJ  S-25863 Updated to exclude DEMO-R.
-INCLUDE SETECHO
 
EX SETDBLS SETFILE=&&SETF
-RUN
 
-INCLUDE OTHPARMS
 
EX SELDESC2
-RUN
 
-TYPE &&OUTPUTDEST
-IF &&OUTLINE2 EQ 'OFFLINE' THEN GOTO XOFFLINE ELSE GOTO XONLINE;
 
-XONLINE
-TYPE Before ONLINE
ONLINE
-TYPE After ONLINE
-RUN
-GOTO CONT
 
-XOFFLINE
-SET &&OUTLINE2 = '';
-TYPE Before OFFLINE
OFFLINE
-TYPE After OFFLINE
-RUN
-GOTO CONT
 
-CONT
-SET &&RPT_HOLD = 'RPTHOLD';
 
FILEDEF AUSEINCL DISK &&AUSEPASS
-RUN
FILEDEF CUSEINCL DISK &&CUSEPASS
-RUN
FILEDEF HUSEINCL DISK &&HUSEPASS
-RUN
 
FILEDEF AUSEINCL CLEAR
-RUN
FILEDEF CUSEINCL CLEAR
-RUN
FILEDEF HUSEINCL CLEAR
-RUN
 
-*========================================================================
-*                <---------------- STEP1 ---------------->
-*========================================================================
-*      CLEAR ROLLUPX PROCESS STAMPS BEFORE TOTAL COMPANY REPORT RUN
-*========================================================================
SET ASNAMES = ON
 
USE
D:\TNT\TTRACKER\SYSTEM\DATA\ROLLUPX.FOC
END
 
DEFINE FILE ROLLUPX
XL01/A1 = ' ';
END
TABLE FILE ROLLUPX
BY ROLLUP_CODE NOPRINT
PRINT ROLLUP_CODE AS 'ROLLUP_CODE'
      XL01        AS 'PR_STAMP'
IF UPD_ENABLE EQ 'X'
ON TABLE HOLD AS TMPHOLD1
END
MODIFY FILE ROLLUPX
FIXFORM FROM TMPHOLD1
MATCH ROLLUP_CODE
ON MATCH COMPUTE PR_STAMP/A1 = ' ' ;
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON TMPHOLD1
END
-RUN
-*========================================================================
-*      SET PR_STAMP TO 'T' (ROLLUP CODES TO BE INCLUDED IN LOOP)
-*========================================================================
DEFINE FILE ROLLUPX
XL01/A1 = 'T';
END
TABLE FILE ROLLUPX
BY ROLLUP_CODE NOPRINT
PRINT ROLLUP_CODE AS 'ROLLUP_CODE'
      XL01        AS 'PR_STAMP'
IF UPD_ENABLE EQ 'X'
IF ROLLUP_CODE NE 'TOTAL-R' OR 'ABCD-R' OR 'DEMO-R'
-* IF ROLLUP_CODE EQ 'UPTTL-R'
ON TABLE HOLD AS TMPHOLD2
END
MODIFY FILE ROLLUPX
FIXFORM FROM TMPHOLD2
MATCH ROLLUP_CODE
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON TMPHOLD2
END
-RUN
-*========================================================================
-*                <---------------- STEP2 ---------------->
-*========================================================================
-*        CREATE FOCUS FILE TCTHTL - HOLDS DATA FROM EACH CLIENT
-*========================================================================
EX SUUSES
-RUN
EX SELDESC
-RUN
 
CREATE FILE TCTRNK
-RUN
-*========================================================================
-*                <---------------- STEP3 ---------------->
-*========================================================================
-*   FIND ROLLUP CODE TO PROCESS - SETUP USE STATEMENTS FOR DATA EXTRACT
-*========================================================================
-LOOPCHK
TABLE FILE ROLLUPX
BY ROLLUP_CODE NOPRINT
PRINT ROLLUP_CODE COMP
IF PR_STAMP EQ 'T'
IF UPD_ENABLE EQ 'X'
IF QTR_ENABLE EQ ' '
IF RECORDLIMIT EQ 1
ON TABLE SAVE AS TMPREAD
END
-RUN
-IF &RECORDS EQ 0 GOTO QUARTER;
-*IF &RECORDS EQ 0 GOTO STOP;
-RUN
 
-READ TMPREAD &&ROLL.A8. &&COMP.A6.
-RUN
 
-SET &&AH = AH_50;
-SET &&DAH = AH_50 || '.';
-SET &&EXTRACT = HR_50;
-SET &&EXTJOIN = HR_JOIN;
-SET &&COMPNY1  = &&COMP ;
 
-SET &&AIR_PATH = 'D:\TNT\TTRACKER\DATA\';
-SET &&COM_PATH = 'D:\TNT\TTRACKER\SYSTEM\DATA\';
-SET &&SU_PATH  = 'D:\TNT\TTRACKER\SUDATA\';
-*========================================================================
-*                    USE AL DATABASES
-*========================================================================
-SET &&AH_DB1 = 'AL' || &&COMPNY1 || '.FOC';
 
-SET &&USE_AH1 = &&AIR_PATH || &&AH_DB1;
 
-SET &&USE_HREF = &&COM_PATH || 'HTL_REF.FOC';
-SET &&USE_ARPT = &&COM_PATH || 'AIRPORT.FOC';
-SET &&USE_CLNT = &&COM_PATH || 'CLIENT.FOC';
-SET &&USE_ROLL = &&COM_PATH || 'ROLLUPX.FOC';
-SET &&USE_ARAT = &&COM_PATH || 'AL_RATE.FOC';
-SET &&USE_CITY = &&COM_PATH || 'CITY.FOC';
-SET &&USE_PROP = &&COM_PATH || 'HOTL_PRP.FOC';
-SET &&USE_HCHN = &&COM_PATH || 'HOTL_CHN.FOC';
-SET &&USE_BRAN = &&COM_PATH || 'BRANCH.FOC';
 
-SET &&COMP1A = 'H_' ||&&COMPNY1 || '.FOC';
 
USE CLEAR *
 
USE
D:\TNT\TTRACKER\DATA\&&COMP1A AS &&EXTRACT
 &&USE_AH1                    AS AH_50
 &&USE_HREF
 &&USE_ARPT
 &&USE_CLNT
 &&USE_ROLL
 &&USE_ARAT
 &&USE_PROP
 &&USE_HCHN
 &&USE_CITY
 &&USE_BRAN
 
END
-*========================================================================
-*                <---------------- STEP4 ---------------->
-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED IN STEP3
-*========================================================================
 
DEFINE FILE HR_50
  BOOKINGS/D8 = IF TOTAL_AMT GE 0 THEN 1 ELSE (-1);
  CHAIN/A35 = CHAIN_CODE||(' '| CHAIN_NAME);
  LEVEL_DESC/A60  = &&LDESC;
  NBR_DAYS/D12 =  NUM_DAYS;
  NNROOMS/D12 = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
END
 
TABLE FILE HR_50
PRINT BOOKINGS
  CHAIN
  NNROOMS
  ROOM_RATE
  TOTAL_AMT
 WHERE INVOICE_DATE GE &&FROMDT.EVAL AND INVOICE_DATE LE &&TODT.EVAL
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
 
-INCLUDE RPTPARMS
 
ON TABLE HOLD AS TC_HOLD1 FORMAT FOCUS
 
END
 
-*========================================================================
-*                <---------------- STEP5 ---------------->
-*========================================================================
-*   PROCESS EXTRACT DATA FROM STEP4 - HOLD TO FOCUS DATABASE TCTHTL
-*========================================================================
 
DEFINE FILE TC_HOLD1
ROLLCD/A8 = '&&ROLL';
END
TABLE FILE TC_HOLD1
SUM BOOKINGS
    NNROOMS
    ROOM_RATE
    TOTAL_AMT
BY ROLLCD
BY CHAIN
ON TABLE HOLD AS TCH1
END
-RUN
 
MODIFY FILE TCTRNK
 LOG INVALID MSG OFF
 LOG DUPL    MSG OFF
 LOG NOMATCH MSG OFF
 LOG FORMAT  MSG OFF
FIXFORM FROM TCH1
MATCH ROLLCD
ON NOMATCH INCLUDE
MATCH CHAIN
ON NOMATCH INCLUDE
DATA ON TCH1
END
-RUN
 
DEFINE FILE ROLLUPX
XL01/A1 = 'Z';
END
TABLE FILE ROLLUPX
BY ROLLUP_CODE NOPRINT
PRINT ROLLUP_CODE AS 'ROLLUP_CODE'
      XL01        AS 'PR_STAMP'
IF ROLLUP_CODE EQ '&&ROLL'
IF RECORDLIMIT EQ 1
ON TABLE HOLD AS TMPHOLD3
END
MODIFY FILE ROLLUPX
FIXFORM FROM TMPHOLD3
MATCH ROLLUP_CODE
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON TMPHOLD3
END
-*========================================================================
-*                <---------------- STEP6 ---------------->
-*========================================================================
-*  GOTO STEP3 - CHECK TO SEE IF ADDITIONAL CLIENTS REQUIRE PROCESSING
-*========================================================================
-RUN
-GOTO LOOPCHK
-RUN
-*========================================================================
-*                <---------------- STEP7 ---------------->
-*========================================================================
-* PROCESS QUARTERLY CLIENTS, WHEN STEP3 RUNS OUT OF NONQUARTERED CLIENTS
-*========================================================================
-QUARTER
TABLE FILE ROLLUPX
BY ROLLUP_CODE NOPRINT
PRINT ROLLUP_CODE COMP
IF PR_STAMP EQ 'T'
IF UPD_ENABLE EQ 'X'
IF QTR_ENABLE EQ 'X'
IF RECORDLIMIT EQ 1
ON TABLE SAVE AS TMPREAD
END
-IF &RECORDS EQ 0 GOTO STOP;
-RUN
 
-READ TMPREAD &&ROLL.A8. &&COMP.A6.
-RUN
 
-SET &&AH = AH_50;
-SET &&DAH = AH_50 || '.';
-SET &&EXTRACT = HR_50;
-SET &&EXTJOIN = HR_JOIN;
-SET &&COMPNY1  = &&COMP ;
 
-SET &&AIR_PATH = 'D:\TNT\TTRACKER\DATA\';
-SET &&COM_PATH = 'D:\TNT\TTRACKER\SYSTEM\DATA\';
-SET &&SU_PATH =  'D:\TNT\TTRACKER\SUDATA\';
-*========================================================================
-*                    USE AL DATABASES
-*========================================================================
-SET &&AH_DB1 = 'AL' || &&COMPNY1 || '.FOC';
 
-SET &&USE_AH1 = &&AIR_PATH || &&AH_DB1;
 
-SET &&USE_AREF = &&COM_PATH || 'AIR_REF.FOC';
-SET &&USE_TREF = &&COM_PATH || 'TRP_REF.FOC';
-SET &&USE_NREF = &&COM_PATH || 'NHR_REF.FOC';
-SET &&USE_CLNT = &&COM_PATH || 'CLIENT.FOC';
-SET &&USE_BRCH = &&COM_PATH || 'BRANCH.FOC';
-SET &&USE_ROLL = &&COM_PATH || 'ROLLUPX.FOC';
-SET &&USE_CCAT = &&COM_PATH || 'CLS_CAT.FOC';
-SET &&USE_ARPT = &&COM_PATH || 'AIRPORT.FOC';
-SET &&USE_AEMB = &&COM_PATH || 'EMBARPT.FOC';
-SET &&USE_ARTE = &&COM_PATH || 'RTEARPT.FOC';
-SET &&USE_ANDO = &&COM_PATH || 'NDOARPT.FOC';
-SET &&USE_ANDD = &&COM_PATH || 'NDDARPT.FOC';
-SET &&USE_MILG = &&COM_PATH || 'MILEAGE.FOC';
-SET &&USE_ARLN = &&COM_PATH || 'AIRLINE.FOC';
-SET &&USE_CITY = &&COM_PATH || 'CITY.FOC';
-SET &&USE_CEMB = &&COM_PATH || 'EMBCITY.FOC';
-SET &&USE_CRTE = &&COM_PATH || 'RTECITY.FOC';
-SET &&USE_CNDO = &&COM_PATH || 'NDOCITY.FOC';
-SET &&USE_CNDD = &&COM_PATH || 'NDDCITY.FOC';
-SET &&USE_VAIR = &&COM_PATH || 'VAL_AIR.FOC';
 
USE CLEAR *
-RUN
 
-SET &&COMP1A = 'H0' ||&&COMPNY1 || '.FOC';
-SET &&COMP1B = 'A0' ||&&COMPNY1 || '.FOC';
-SET &&COMP1C = 'T0' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP2A = 'H1' ||&&COMPNY1 || '.FOC';
-SET &&COMP2B = 'A1' ||&&COMPNY1 || '.FOC';
-SET &&COMP2C = 'T1' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP3A = 'H2' ||&&COMPNY1 || '.FOC';
-SET &&COMP3B = 'A2' ||&&COMPNY1 || '.FOC';
-SET &&COMP3C = 'T2' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP4A = 'H3' ||&&COMPNY1 || '.FOC';
-SET &&COMP4B = 'A3' ||&&COMPNY1 || '.FOC';
-SET &&COMP4C = 'T3' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP5A = 'H4' ||&&COMPNY1 || '.FOC';
-SET &&COMP5B = 'A4' ||&&COMPNY1 || '.FOC';
-SET &&COMP5C = 'T4' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP6A = 'H5' ||&&COMPNY1 || '.FOC';
-SET &&COMP6B = 'A5' ||&&COMPNY1 || '.FOC';
-SET &&COMP6C = 'T5' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP7A = 'H6' ||&&COMPNY1 || '.FOC';
-SET &&COMP7B = 'A6' ||&&COMPNY1 || '.FOC';
-SET &&COMP7C = 'T6' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP8A = 'H7' ||&&COMPNY1 || '.FOC';
-SET &&COMP8B = 'A7' ||&&COMPNY1 || '.FOC';
-SET &&COMP8C = 'T7' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP9A = 'H8' ||&&COMPNY1 || '.FOC';
-SET &&COMP9B = 'A8' ||&&COMPNY1 || '.FOC';
-SET &&COMP9C = 'T8' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP10A = 'H9' ||&&COMPNY1 || '.FOC';
-SET &&COMP10B = 'A9' ||&&COMPNY1 || '.FOC';
-SET &&COMP10C = 'T9' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP11A = 'HY' ||&&COMPNY1 || '.FOC';
-SET &&COMP11B = 'AY' ||&&COMPNY1 || '.FOC';
-SET &&COMP11C = 'TY' ||&&COMPNY1 || '.FOC';
 
-SET &&COMP12A = 'HZ' ||&&COMPNY1 || '.FOC';
-SET &&COMP12B = 'AZ' ||&&COMPNY1 || '.FOC';
-SET &&COMP12C = 'TZ' ||&&COMPNY1 || '.FOC';
 
 
USE ADD
 
D:\TNT\TTRACKER\DATA\&&COMP1A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP1B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP1C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP2A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP2B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP2C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP3A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP3B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP3C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP4A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP4B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP4C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP5A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP5B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP5C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP6A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP6B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP6C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP7A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP7B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP7C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP8A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP8B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP8C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP9A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP9B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP9C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP10A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP10B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP10C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP11A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP11B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP11C AS TKT_MAIN
 
D:\TNT\TTRACKER\DATA\&&COMP12A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP12B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP12C AS TKT_MAIN
 
 
  &&USE_ARLN
  &&USE_MILG
  &&USE_CCAT
  &&USE_AEMB
  &&USE_CEMB
  &&USE_ARTE
  &&USE_CRTE
  &&USE_ANDO
  &&USE_CNDO
  &&USE_ANDD
  &&USE_CNDD
  &&USE_VAIR
  &&USE_AREF
  &&USE_TREF
  &&USE_NREF
  &&USE_CLNT
  &&USE_AH1 AS &&AH
 
END
-RUN
-*========================================================================
-*                <---------------- STEP8 ---------------->
-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED IN STEP7
-*========================================================================
DEFINE FILE HR_50
  BOOKINGS/D8 = IF TOTAL_AMT GE 0 THEN 1 ELSE (-1);
  CHAIN/A35 = CHAIN_CODE||(' '| CHAIN_NAME);
  LEVEL_DESC/A60  = &&LDESC;
  NBR_DAYS/D12 =  NUM_DAYS;
  NNROOMS/D12 = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
END
 
TABLE FILE HR_50
PRINT BOOKINGS
  CHAIN
  NNROOMS
  ROOM_RATE
  TOTAL_AMT
 WHERE INVOICE_DATE GE &&FROMDT.EVAL AND INVOICE_DATE LE &&TODT.EVAL
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
 
 
 
-INCLUDE RPTPARMS
 
ON TABLE HOLD AS TC_HOLD1 FORMAT FOCUS
 
END
 
-*========================================================================
-*                <---------------- STEP9 ---------------->
-*========================================================================
-*   PROCESS EXTRACT DATA FROM STEP8 - HOLD TO FOCUS DATABASE TCRANK
-*========================================================================
DEFINE FILE TC_HOLD1
ROLLCD/A8 = '&&ROLL';
END
TABLE FILE TC_HOLD1
SUM BOOKINGS
    NNROOMS
    ROOM_RATE
    TOTAL_AMT
BY ROLLCD
BY CHAIN
ON TABLE HOLD AS TCH1
END
-RUN
 
MODIFY FILE TCTRNK
 LOG INVALID MSG OFF
 LOG DUPL    MSG OFF
 LOG NOMATCH MSG OFF
 LOG FORMAT  MSG OFF
FIXFORM FROM TCH1
MATCH ROLLCD
ON NOMATCH INCLUDE
MATCH CHAIN
ON NOMATCH INCLUDE
DATA ON TCH1
END
-RUN
 
DEFINE FILE ROLLUPX
XL01/A1 = 'Z';
END
TABLE FILE ROLLUPX
BY ROLLUP_CODE NOPRINT
PRINT ROLLUP_CODE AS 'ROLLUP_CODE'
      XL01        AS 'PR_STAMP'
IF ROLLUP_CODE EQ '&&ROLL'
IF RECORDLIMIT EQ 1
ON TABLE HOLD AS TMPHOLD3
END
MODIFY FILE ROLLUPX
FIXFORM FROM TMPHOLD3
MATCH ROLLUP_CODE
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON TMPHOLD3
END
-RUN
-*========================================================================
-*                <---------------- STEP10 ---------------->
-*========================================================================
-*  GOTO STEP7 - CHECK TO SEE IF ADDITIONAL CLIENTS REQUIRE PROCESSING
-*========================================================================
-GOTO QUARTER
-RUN
 
-STOP
 
-SET &&CTY_LMT = &&RANK_LIMIT;
-SET &&HTL_LMT = &&RANK_LIMIT2;
-SET &&RANK_METH = IF &&RANK_METH EQ 'ROOM_AMT' THEN 'ROOM_AMT'
- ELSE IF &&RANK_METH EQ 'NMBR_DAYS' THEN 'NMBR_DAYS'
- ELSE 'NMBR_DAYS';
 
TABLE FILE TCTRNK
SUM BOOKINGS
    NNROOMS
    NNROOMS/D8 AS 'NMBR_DAYS'
    TOTAL_AMT/D12.2 AS 'ROOM_AMT'
BY ROLLCD
BY CHAIN
ON TABLE HOLD AS HOLD1
END
-RUN
 
 
TABLE FILE HOLD1
PRINT CHAIN
  BOOKINGS
  NMBR_DAYS
  NNROOMS
  ROOM_AMT/D12.2
BY ROLLCD
RANKED BY HIGHEST &&RANK_METH NOPRINT
ON TABLE HOLD AS HOLD2
END
-RUN
 
 
 
DEFINE FILE HOLD2
 RANK_LIMIT/I5 = &&HTL_LMT;
 CRANK/D5 =   RANK;
 BRANK/A6 =   FTOA(CRANK, '(D5)' , 'A6');
 LIST/D6 = IF CHAIN NE LAST CHAIN THEN (LAST LIST + 1) ELSE LAST LIST;
 FRANKX/A6 = FTOA(LIST, '(D5)', 'A6');
 FRANK/A5=EDIT(FRANKX,'$99999');
 RANK_VALUE/A9 = IF (RANK_LIMIT EQ 0) THEN BRANK ELSE
                 IF RANK GT RANK_LIMIT THEN 'OTHER' ELSE BRANK;
END
-RUN
 
TABLE FILE HOLD2
SUM
  BOOKINGS
  NMBR_DAYS
  NNROOMS
  ROOM_AMT
BY ROLLCD
BY RANK_VALUE
BY CHAIN
ON TABLE HOLD AS HOLD3
END
-RUN
 
 
 
DEFINE FILE HOLD3
 CHN_NAME/A35 =IF RANK_VALUE LT '&&HTL_LMT' THEN CHAIN ELSE 'ALL OTHER';
END
-RUN
 
TABLE FILE HOLD3
SUM
  BOOKINGS
  NMBR_DAYS
  NNROOMS
  ROOM_AMT
BY ROLLCD
 BY RANK_VALUE
BY CHN_NAME
ON TABLE HOLD AS HOLD4
END
-RUN
 
 
TABLE FILE HOLD1
SUM
  BOOKINGS
  NMBR_DAYS
  NNROOMS
  ROOM_AMT
BY ROLLCD
ON TABLE HOLD AS RHOLD1
END
-RUN
 
TABLE FILE RHOLD1
SUM BOOKINGS
    NMBR_DAYS
    NNROOMS
    ROOM_AMT
RANKED BY HIGHEST &&RANK_METH AS 'DAYS_RANK'
BY ROLLCD
ON TABLE HOLD AS RHOLD2
END
-RUN
 
MATCH FILE HOLD4
PRINT BOOKINGS
      CHN_NAME
      NMBR_DAYS
      NNROOMS
      RANK_VALUE
      ROOM_AMT
BY ROLLCD
ON TABLE HOLD
RUN
FILE RHOLD2
SUM DAYS_RANK
BY ROLLCD
AFTER MATCH HOLD AS HOLD5 OLD-OR-NEW
END
-RUN
 
TABLE FILE HOLD5
PRINT BOOKINGS
      CHN_NAME
      NMBR_DAYS
      NNROOMS
      RANK_VALUE
      ROOM_AMT
RANKED BY HIGHEST DAYS_RANK
BY ROLLCD
ON TABLE HOLD AS HOLD6
END
-RUN
 
DEFINE FILE HOLD6
  ROLL_LIMIT/I4 = &&CTY_LMT;
  RLIMIT/A4    = EDIT(ROLL_LIMIT);
  CRANK/D5     = RANK;
  BRANK/A6     = FTOA(CRANK, '(D5)', 'A6');
  LIST/D6 = IF ROLLCD NE LAST ROLLCD THEN (LAST LIST + 1) ELSE LAST LIST;
  FRANKX/A7 = FTOA(LIST, '(D6)', 'A7');
  FRANK/A6=EDIT(FRANKX,'$999999');
  ROLL_VALUE/A9 = IF ROLL_LIMIT EQ 0 THEN BRANK ELSE
                 IF RANK GT ROLL_LIMIT THEN 'ALL OTHER' ELSE FRANK;
END
-RUN
 
TABLE FILE HOLD6
PRINT
  BOOKINGS
  RLIMIT
  ROLL_LIMIT
  DAYS_RANK
  NMBR_DAYS
  NNROOMS
  ROOM_AMT
BY ROLL_VALUE
BY ROLLCD
BY RANK_VALUE
BY CHN_NAME
ON TABLE HOLD AS TCR1
END
-RUN
 
 
-SET &&RPTSUF = 'SMY';
-INCLUDE FDEFRPTS
-RUN
 
DEFINE FILE TCR1
ROLL_PRINT/A35 = IF ROLL_VALUE LT (RLIMIT) THEN ROLLCD ELSE ' ';
CHN_PRINT/A35 = IF ROLL_VALUE LT (RLIMIT) THEN CHN_NAME ELSE ' ';
CHN_RANK/A9 = IF ROLL_VALUE LT (RLIMIT) THEN RANK_VALUE ELSE ' ';
NOWTOD/A8 WITH ROLL_VALUE = HHMMSS (NOWTOD);
END
TABLE FILE TCR1
-INCLUDE HEADER
"&&SUBHEAD"
"</2"
-*
    &&S_SUBJ1
    &&S_SUBJ2
    &&S_SUBJ3
    &&S_SUBJ4
    &&S_SUBJ5
    &&S_SUBJ6
    &&S_SUBJ7
    &&S_SUBJ8
    &&S_SUBJ9
    &&S_SUBJ10
 
-*BY
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
-*ON
   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10
 
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
-INCLUDE &&SMSTY
ENDSTYLE
 
&&OUTLINE1
&&SUMMDEST
&&OUTLINE2
END
-RUN
