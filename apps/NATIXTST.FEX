
SET ASNAMES=ON


JOIN AIR_KEY IN A_NATIX TO ALL AIR_KEY IN S_NATIX
-RUN

-* DATAVAULT EXCHANGE AMOUNTS

DEFINE FILE A_NATIX
ADDCOLLECT/D12 = EXCH_NET_FARE + EXCH_NET_TAX;             
              

FULLE_FARE2/D12 = IF (EXSALE NE ' ') AND (SEG_COUNT GE 0) THEN ADDCOLLECT ELSE
                  IF (EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) THEN ADDCOLLECT ELSE 0;

END
TABLE FILE A_NATIX
PRINT FULLE_FARE2 EX_FLAG
BY TKT_NUM
WHERE TRN_DATE GE '20090101' AND TRN_DATE LE '20090930'
WHERE VOID_DATE EQ 0
ON TABLE COLUMN-TOTAL
-* ON TABLE PCHOLD FORMAT EXL2K
ON TABLE HOLD AS JOYDV
END
-RUN


DEFINE FILE JOYDV
FULLE_FAREB/D12 = IF (TKT_NUM NE LAST TKT_NUM) AND (EX_FLAG NE 'F' OR 'P') THEN FULLE_FARE2 ELSE 0;
END
TABLE FILE JOYDV
SUM FULLE_FAREB  
BY TKT_NUM
ON TABLE COLUMN-TOTAL
WHERE FULLE_FAREB NE 0
ON TABLE HOLD AS JOYDV1
END
-RUN

-* TRENDING DATA EXCHANGE AMOUNTS

DEFINE FILE A_NATIX

FARE_PAID/P12.2C =  SEG_AMT + SEG_TAX;

FARE/D12 = TICKET_AMT + TAX_AMT;

ADDCOLLECT/P12.2C = EXCH_NET_FARE + EXCH_NET_TAX;

                 
FULLE_FARE1/P12.2C = IF (DOC_TYPE EQ '1' AND EXCHG_SALE NE ' ') THEN 0 ELSE 
                   IF ((EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (EMBARK NE 'RF1' OR 'FP3')) THEN FARE_PAID ELSE
                   IF ((SEG_COUNT GE 0) AND (EXCHG_SALE NE ' ') AND (EMBARK NE 'RF1')) THEN FARE_PAID ELSE 0;

FULLE_ADD/P12.2C = IF (DOC_TYPE EQ '1' AND EXCHG_SALE NE ' ') THEN 0 ELSE 
                   IF ((EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (EMBARK NE 'RF1' OR 'FP3')) THEN ADDCOLLECT ELSE
                   IF ((SEG_COUNT GE 0) AND (EXCHG_SALE NE ' ') AND (EMBARK NE 'RF1')) THEN ADDCOLLECT ELSE 0;
                   
FULLE_ADD1/P12.2C = IF EX_FLAG NE 'F' OR 'P' THEN FULLE_ADD ELSE 0;
DOC/A10 = EDIT(DOC_NUMBER, '9999999999');
DOC_NUM/A10 = IF DOC NE '0000000000' THEN DOC ELSE TKT_NUM;
END
TABLE FILE A_NATIX
PRINT SEG_AMT SEG_TAX EXCH_NET_FARE EXCH_NET_TAX
-* FULLE_FARE1 FULLE_ADD1 ADDCOLLECT
BY PASSNGR_NAME
BY TKT_NUM
BY EMBARK
BY ROUTE
BY SEG_NBR
WHERE TRN_DATE GE '20090101' AND TRN_DATE LE '20090930'
WHERE VOID_DATE EQ 0
WHERE TKT_NUM EQ '7531025444' OR '7530052766'
ON TABLE COLUMN-TOTAL
-* ON TABLE HOLD AS JOYTD
END
-RUN
-QUIT


-* -GOTO NEXT;

DEFINE FILE JOYTD
FULLE_ADDB/P12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN FULLE_ADD1 ELSE 0;
END
TABLE FILE JOYTD
SUM FULLE_FARE1 FULLE_ADDB 
COMPUTE DIFF/P12.2CS = IF FULLE_FARE1 GT 0 THEN FULLE_FARE1 - FULLE_ADDB ELSE 0;
COMPUTE DIFF1/P12.2CS = FULLE_ADDB + DIFF;
BY TKT_NUM
-* BY DOC_NUM
-* BY EMBARK
-* BY ROUTE
-* BY TKT_SORT NOPRINT
-* BY SEG_NBR
ON TABLE COLUMN-TOTAL
-* WHERE FULLE_FARE1 NE 0
-* WHERE TOTAL DIFF NE 0
WHERE TOTAL DIFF1 NE FULLE_FARE1
ON TABLE PCHOLD FORMAT EXL2K
-* ON TABLE HOLD AS JOYTD1
END
-RUN
-QUIT

-NEXT;

MATCH FILE JOYTD
SUM FULLE_FARE1
BY TKT_NUM
ON TABLE HOLD
RUN
FILE JOYDV1
SUM FULLE_FAREB
BY TKT_NUM
AFTER MATCH HOLD AS JOYTT OLD
END
-RUN

TABLE FILE JOYTT
SUM FULLE_FARE1 FULLE_FAREB
BY TKT_NUM
ON TABLE COLUMN-TOTAL
END
-RUN
-QUIT
