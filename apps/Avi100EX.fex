-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* 5/10/05  - DEB - CHANGED CODE TO SORT BY TNT_COMPANY
-* 4/20/10 - DEB - CHANGED ORIG_SALE DEFINE
-* 10/10/13 - Joy - Corrected drilldown error on field KEY
-*8/20/15   JOY STORY ID - S-07278 - Updating to use Level_desc and removing company code
-*11/25/15  Joy    S-07987  Corrected for running Currency Enabled Version
-*12/17/15 - JEM - S-13286 Updated to allow reports to sort/subtotal by id-levels
-*8/28/17-JEM-S-34936 Removed TNT_COMPANY

SET ASNAMES = ON
-SET HOLDATTR = ON;
-* -SET &&CURRENCY = 'XXX';

-SET &&IDLEVELBREAK = '';


-* Global Currency Join
-* JOIN SR_50.TRN_DATE IN SR_50 TO GLOBAL.DATE IN GLOBAL AS J1
JOIN SR_50.TKT_DATE IN SR_50 TO GLOBAL.DATE IN GLOBAL AS J1
-RUN


-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

-INCLUDE IDLEVROLLDEF
-RUN


DEFINE FILE SR_50
 EXMCOS/D9 = IF (EX_FLAG NE ' ') AND (DOC_TYPE EQ '1') AND (EXCHG_SALE NE ' ')
                THEN 1 ELSE 0; 
-* FULL_RFNDS/D9 = IF ((VOID_DATE EQ 0) AND (RF_FLAG EQ 'F') AND (TKT_NUM 
-*                     NE LAST TKT_NUM) AND (SEG_COUNT LT 0)) THEN 1 ELSE 0;
 FARE_PAID/D12.2CS = SEG_AMT + SEG_TAX;
 LEVEL_DESC1/A80 = &&LDESC;
 MCOS/D9CS       = IF (DOC_TYPE EQ '1') AND
                      (EX_FLAG EQ ' ')  AND
                      (EXCHG_SALE NE ' ') THEN 1 ELSE 0;
 NET_TKT_CNT1/D9 = IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND 
                      (SEG_COUNT EQ 1) AND (EXCHG_SALE EQ ' ') THEN 1 ELSE 
                   IF (DOC_TYPE EQ '1') AND
                      (EX_FLAG EQ ' ') AND 
                      (EXCHG_SALE NE ' ') THEN 1 ELSE 0;
-* ORIG_SALE/D9 = IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND (SEG_COUNT EQ 1) AND
-*                   (EXCHG_SALE EQ ' ') THEN 1 ELSE 
-*                IF (DOC_TYPE EQ '1') AND (EX_FLAG EQ ' ') AND (EXCHG_SALE NE ' ') 
-*                   THEN 1 ELSE 0;
ORIG_SALE/D9 = IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND (SEG_COUNT  EQ 1) 
                 AND (EXCHG_SALE EQ ' ') THEN 1 ELSE 
              IF (DOC_TYPE EQ '1') AND (EX_FLAG EQ ' ') AND (EXCHG_SALE NE ' ')
              AND (RF_FLAG EQ ' ') THEN 1 ELSE 0;	
 
-*  PART_RFNDS/D9 = IF ((VOID_DATE EQ 0) AND (RF_FLAG EQ 'P') AND 
-*                     (TKT_NUM NE LAST TKT_NUM) AND (SEG_COUNT LE 0)) THEN 1 ELSE 0;
 TKT_CNT/D9CS=   IF (SEG_NBR EQ '01') AND 
                    (FARE_PAID GE 0) AND 
                    (SEG_COUNT EQ 1) THEN 1 ELSE 0;                         
  TKT_TYPE/A4         = IF (SEG_COUNT LE 0) AND
                           (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                           (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                           (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                           (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  VOIDS/D9CS          = IF (VOID_DATE NE 0) AND
                           (SEG_COUNT EQ 1) AND
                           (SEG_NBR EQ '01') THEN 1 ELSE
                        IF (DOC_TYPE EQ '1') AND 
                           (VOID_DATE NE 0) THEN 1 ELSE 0;
                           
  XDPT_DT/MDYY=DPT_DATE;
  XPSNGR_NM/A15=EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY=TRN_DATE;
-* ******* DEFINES ON PREVIOUS DEFINES ******

EXCHGS/D9 = IF (EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (EMBARK 
  NE 'DT1' OR 'RF1' OR 'FP3') THEN TKT_CNT ELSE
  IF (DOC_TYPE EQ '1') AND (EXCHG_SALE EQ 'E') THEN 0 ELSE
  IF (SEG_COUNT GE 0) AND (EXCHG_SALE NE ' ') THEN TKT_CNT ELSE 0;
PAID_FARE/D12.2CS = IF VOID_DATE EQ 0 THEN FARE_PAID ELSE 0;
-* REFUNDS/D9 = FULL_RFNDS + PART_RFNDS;
TOT_ECNT/D9 = EXCHGS + EXMCOS;
-* DEFINE ON PREVIOUSLY DEFINED DEFINE
-* TOT_TRANS/D9 = ORIG_SALE + VOIDS + TOT_ECNT + REFUNDS;

NAMEC/A30 = IF '&&CURRENCY' EQ 'USD' THEN ' ' ELSE CNAME;
-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
  CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
  PAID_FAREX/D20.6C = PAID_FARE * CURR1X;

-* DEFINES ON PREVIOUSLY DEFINES DEFINES
 
-INCLUDE IDLEVDEFINE 

END
-RUN

TABLE FILE SR_50
PRINT 
  AIRLINE
  CITYPAIR.EMBARK      AS 'EMB_APT_CD'	
  CITYPAIR.ROUTE       AS 'RTE_APT_CD'	
  EXMCOS
  DOC_TYPE
  DPT_DATE	
  DPT_TIME
  EXCHGS
  EXMCOS
-*   FULL_RFNDS
  FARE_PAID	
  LEVEL_DESC
  NAMEC
  NET_TKT_CNT1
  MCOS
  ORIG_SALE
  PAID_FAREX
-*   PART_RFNDS
-*   REFUNDS
  RF_FLAG
  SEG_COUNT
  SEG_NBR
  TICKET_BRANCH
  TOT_ECNT
-*   TOT_TRANS
  TKT_NUM
  TKT_SORT
  TRN_DATE
  VOIDS
  VOID_DATE
  XDPT_DT
  XPSNGR_NM
  XTRAN_DT
BY TKT_NUM
BY SEG_COUNT	
-INCLUDE &AIRDATES
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS

ON TABLE HOLD AS FHOLD 
END
-RUN

DEFINE FILE FHOLD
FULL_RFNDS/D9 = IF ((VOID_DATE EQ 0) AND (RF_FLAG EQ 'F') AND (TKT_NUM 
                    NE LAST TKT_NUM) AND (SEG_COUNT LT 0)) THEN 1 ELSE 0;
PART_RFNDS/D9 = IF ((VOID_DATE EQ 0) AND (RF_FLAG EQ 'P') AND 
                    (TKT_NUM NE LAST TKT_NUM) AND (SEG_COUNT LE 0)) THEN 1 ELSE 0;
REFUNDS/D9 = FULL_RFNDS + PART_RFNDS;
-* TOT_TRANS/D9 = ORIG_SALE + VOIDS + TOT_ECNT + REFUNDS;
TOT_TRANS/D9 = ORIG_SALE + VOIDS + TOT_ECNT + MCOS + REFUNDS;

END

TABLE FILE FHOLD
PRINT 
  AIRLINE
  EMB_APT_CD	
  RTE_APT_CD	
  EXMCOS
  DOC_TYPE
  DPT_DATE	
  DPT_TIME
  EXCHGS
  EXMCOS
  FULL_RFNDS
  FARE_PAID	
  LEVEL_DESC
  NAMEC
  NET_TKT_CNT1
  MCOS
  ORIG_SALE
  PAID_FAREX
  PART_RFNDS
  REFUNDS
  SEG_COUNT
  SEG_NBR
  TICKET_BRANCH
  TOT_ECNT
  TOT_TRANS
  TKT_NUM
  TKT_SORT
  TRN_DATE
  VOIDS
  VOID_DATE
  XDPT_DT
  XPSNGR_NM
  XTRAN_DT	
BY LEVEL_DESC  
ON TABLE HOLD AS &&RPT_HOLD 
END
-RUN
