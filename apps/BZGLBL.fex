-* ADDED TRANTYPE INCLUDE - JK 12/16/14 STORY ID S-06492




SET ASNAMES=ON

-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';



DEFINE FILE SR_50
AGENCY_CNTRY/A3 = 'USA';
FARE/D12 = SEG_AMT;
SEG_CNT/P12 = SEG_COUNT;
LEVEL_DESC/A60      = &&LDESC;
-* CLASS_CAT/A8 = DECODE CL_CAT ('F' 'FIRST'     'C' 'COACH'   
-*                               'D' 'DISCOUNT'  'B' 'BUSINESS'
-*                               ' ' 'OTHER');
CLASS_CAT/A15 = DECODE CL_CAT ('F' 'FIRST'     'P' 'PREMIUM ECONOMY'   
			        'D' 'DEFAULT'   'B' 'BUSINESS'
			        'E' 'ECONOMY'   'U'  'UPGRADE' 
                                ' ' 'DEFAULT');
DIR_CP_CD/A50        = CITYPAIR.EMBARK||'-'||CITYPAIR.ROUTE;   
CURR/A3 = '&&CURRENCY';
-INCLUDE TRANTYPE
END
-RUN
TABLE FILE SR_50
PRINT ORG_APC ORG_APCX DST_APC DST_APCX C_ITIN FARE SEG_CNT CLASS CLASS_CAT FARE_BAS RNDT_FLAG DIR_CP_CD AIRLINE CURR 
VAL_AIRLINE AS 'VAL_ALN'
BY AGENCY_CNTRY 
-INCLUDE &AIRDATES
-INCLUDE RPTPARMS
WHERE VOID_DATE EQ 0
WHERE SEG_COUNT NE 0
-* WHERE AIRLINE NE '2V' OR 'XA'
ON TABLE HOLD AS AIRHLD1
END
-RUN

TABLE FILE AIRHLD1
PRINT ORG_APC AGENCY_CNTRY DST_APC DST_APCX C_ITIN FARE SEG_CNT CLASS CLASS_CAT FARE_BAS RNDT_FLAG DIR_CP_CD AIRLINE CURR VAL_ALN 
BY ORG_APCX
ON TABLE HOLD AS AIRHLD2 FORMAT FOCUS INDEX ORG_APCX
END
-RUN

JOIN AIRHLD2.ORG_APCX IN AIRHLD2 TO AIRPORT.APCODEX IN AIRPORT AS J1
-RUN

TABLE FILE AIRHLD2 
PRINT ORG_APC COUNTRY_CODE AS 'OCCODE' GEO_ZONE AS 'OGEO' DST_APC DST_APCX C_ITIN FARE SEG_CNT CLASS CLASS_CAT FARE_BAS RNDT_FLAG DIR_CP_CD AIRLINE CURR VAL_ALN
BY AGENCY_CNTRY
ON TABLE HOLD AS AIRHLD3
END
-RUN

TABLE FILE AIRHLD3
PRINT DST_APC AGENCY_CNTRY ORG_APC OCCODE  OGEO C_ITIN FARE SEG_CNT CLASS CLASS_CAT FARE_BAS RNDT_FLAG DIR_CP_CD AIRLINE CURR VAL_ALN
BY DST_APCX
ON TABLE HOLD AS AIRHLD4 FORMAT FOCUS INDEX DST_APCX
END
-RUN

JOIN AIRHLD4.DST_APCX IN AIRHLD4 TO AIRPORT.APCODEX IN AIRPORT AS J2
-RUN

TABLE FILE AIRHLD4
PRINT ORG_APC OGEO AGENCY_CNTRY DST_APC COUNTRY_CODE AS 'DCCODE' GEO_ZONE AS 'DGEO' C_ITIN FARE SEG_CNT CLASS CLASS_CAT FARE_BAS RNDT_FLAG DIR_CP_CD AIRLINE CURR VAL_ALN
BY OCCODE
ON TABLE HOLD AS AIRHLD5 FORMAT FOCUS INDEX OCCODE
END
-RUN

JOIN AIRHLD5.OCCODE IN AIRHLD5 TO COUNTRY.COUNTRY_CODE IN COUNTRY AS J3
-RUN

TABLE FILE AIRHLD5
PRINT ORG_APC OGEO COUNTRY_NAME AS 'OCNAME' DST_APC DGEO AGENCY_CNTRY C_ITIN FARE SEG_CNT  CLASS CLASS_CAT FARE_BAS RNDT_FLAG DIR_CP_CD AIRLINE CURR VAL_ALN
BY DCCODE
ON TABLE HOLD AS AIRHLD6 FORMAT FOCUS INDEX DCCODE
END
-RUN

JOIN AIRHLD6.DCCODE IN AIRHLD6 TO COUNTRY.COUNTRY_CODE IN COUNTRY AS J4
-RUN

TABLE FILE AIRHLD6
PRINT ORG_APC OCNAME OGEO DST_APC COUNTRY_NAME AS 'DCNAME' DGEO C_ITIN FARE SEG_CNT AGENCY_CNTRY CLASS CLASS_CAT FARE_BAS RNDT_FLAG DIR_CP_CD AIRLINE CURR VAL_ALN
BY OGEO
ON TABLE HOLD AS HLD1 FORMAT FOCUS INDEX OGEO
END
-RUN

JOIN HLD1.OGEO IN HLD1 TO GEO.GEO_ZONE IN GEO AS J5
-RUN

TABLE FILE HLD1
PRINT ORG_APC OCNAME GEO_NAME AS 'OGNAME' DST_APC DCNAME C_ITIN FARE SEG_CNT AGENCY_CNTRY CLASS CLASS_CAT FARE_BAS RNDT_FLAG DIR_CP_CD AIRLINE CURR VAL_ALN
BY DGEO
ON TABLE HOLD AS HLD2 FORMAT FOCUS INDEX DGEO
END
-RUN

JOIN HLD2.DGEO IN HLD2 TO GEO.GEO_ZONE IN GEO AS J6
-RUN

TABLE FILE HLD2
PRINT ORG_APC OCNAME OGNAME DST_APC DCNAME GEO_NAME AS 'DGNAME' C_ITIN FARE SEG_CNT  CLASS CLASS_CAT FARE_BAS RNDT_FLAG DIR_CP_CD AIRLINE CURR VAL_ALN
BY AGENCY_CNTRY
ON TABLE HOLD AS AIRC3A
END
-RUN

TABLE FILE AIRC3A
SUM SEG_CNT FARE CURR
BY AGENCY_CNTRY
BY C_ITIN
BY RNDT_FLAG
BY DIR_CP_CD
BY OCNAME
BY OGNAME
BY DCNAME
BY DGNAME
BY AIRLINE
BY VAL_ALN
BY CLASS_CAT
BY CLASS
BY FARE_BAS
ON TABLE HOLD AS AIRC3
END
-RUN

DEFINE FILE AIRC3
NOWTOD/A8 WITH AGENCY_CNTRY = HHMMSS (NOWTOD);
RT_FLAG/A1 = IF RNDT_FLAG EQ 'Y' THEN 'R' ELSE 'O';
END
-RUN

-SET &&RPTSUF = 'DTL';

-INCLUDE FDEFRPTS
-RUN


TABLE FILE AIRC3
SUM SEG_CNT AS 'O/D Count' SEG_CNT AS 'Segments' FARE AS 'O/D Prorated Fare' 
COMPUTE AVFARE/D12= IF  SEG_CNT EQ 0 THEN 0 ELSE FARE/SEG_CNT; AS 'O/D Average Fare' 
CURR AS 'Currency' 
BY AGENCY_CNTRY AS 'Agency Country'
BY C_ITIN AS 'Air Itinerary'
BY RT_FLAG AS 'Round Trip Indicator'
BY DIR_CP_CD AS 'Directional Market Pair Code'
BY OCNAME AS 'Origin Country'
BY OGNAME AS 'Origin Region'
BY DCNAME AS 'Destination Country'
BY DGNAME AS 'Destination Region'
BY AIRLINE AS 'Operating Carrier Code'
BY VAL_ALN AS 'Validating Carrier Code'
BY CLASS_CAT AS 'Class Type'
BY CLASS AS 'Class Code'
BY FARE_BAS AS 'Fare Basis Code'
WHERE FARE NE 0

HEADING
-INCLUDE HEADAIR
FOOTING
-INCLUDE FOOTERDT
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
-INCLUDE &&DTSTY
ENDSTYLE
-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN

-XXIT;
