-*10/16/17 - Creation of new report TCTPHTL


-INCLUDE SETECHO
SET ASNAMES = ON 
-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED IN STEP3
-*========================================================================
-SET &&EXTRACT = 'HR_50';

-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';


DEFINE FILE &&EXTRACT
  NEW_TOTAL_AMT/D15.2CS = TOTAL_AMT;
  NEW_ROOM_RATE/D15.2CS = ROOM_RATE;
  NEW_STD_RATE/D15.2CS = STD_RATE;
  NEW_STD_RATE2/D15.2CS = IF STD_RATE EQ 0 THEN 0 ELSE STD_RATE;
  NBR_DAYS/P15CS =  NUM_DAYS; 
  NNROOMS/P15CS = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
  NNROOMS2/P15CS = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1)) ELSE
                   IF STD_RATE EQ 0 THEN 0 ELSE
                 NBR_DAYS*NUM_ROOMS;                
  REFUSE_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
-* DEFINES ON PREVIOUS DEFINES                
  TOTAL_STD/D15.2CS = IF (NNROOMS LT 0) AND (NEW_STD_RATE LT 0) 
                     THEN ((NNROOMS * NEW_STD_RATE)*(-1))
                     ELSE NNROOMS * NEW_STD_RATE;    
                      
  NO_COMP/D15.2CS = IF (NNROOMS2 LT 0) AND (NEW_STD_RATE LT 0) 
                     THEN ((NNROOMS2 * NEW_STD_RATE)*(-1)) ELSE
                     IF NNROOMS2 EQ 0 THEN 0 ELSE
                       NNROOMS2 * NEW_STD_RATE2;
  TOTAL_SLSAV/D15.2CS = TOTAL_STD - NEW_TOTAL_AMT;
                     
  TOT_NCMP_SVGS/D15.2CS = NO_COMP - NEW_TOTAL_AMT;
  PC_SVGS/D15.2CS = IF REFUSE_CD EQ 'PC' THEN TOTAL_SLSAV ELSE 0;
  A_SVGS/D15.2CS = IF REFUSE_CD EQ 'A' THEN TOTAL_SLSAV ELSE 0;
-*  T_SVGS/D15.2CS = IF REFUSE_CD EQ 'T'  THEN TOTAL_SLSAV ELSE 0;
  NOI_AMT/D15.2CS = IF REFUSE_CD NE 'I' THEN NEW_TOTAL_AMT ELSE 0;
  NOI_SVG/D15.2CS = IF REFUSE_CD NE 'I' THEN TOTAL_SLSAV ELSE 0;
  ARTPC_AMT/D15.2CS = IF REFUSE_CD EQ 'A' OR 'R' OR 'T' OR 'PC' THEN NEW_TOTAL_AMT ELSE 0;
  ARTPC_SVG/D15.2CS = IF REFUSE_CD EQ 'A' OR 'R' OR 'T' OR 'PC' THEN TOTAL_SLSAV ELSE 0;
  TOTAL_RR/D12.2C = IF (NNROOMS LT 0) AND (NEW_ROOM_RATE LT 0) THEN ((NNROOMS * NEW_ROOM_RATE)*(-1))
                     ELSE NNROOMS * NEW_ROOM_RATE;                  
                   
END

TABLEF FILE &&EXTRACT
PRINT 
    HTL_KEY
    NNROOMS
    NNROOMS2
    NEW_ROOM_RATE
    NEW_TOTAL_AMT
    NO_COMP
    TOT_NCMP_SVGS
    TOTAL_STD
    TOTAL_SLSAV
    TOTAL_RR
    PC_SVGS
    A_SVGS
-*    T_SVGS
    NOI_AMT
    NOI_SVG
    ARTPC_AMT
    ARTPC_SVG
 -INCLUDE &HTLDATES
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHOLD1
END
-RUN

-IF &LINES EQ 0 THEN GOTO NEXTONE;

TABLE FILE RPTHOLD1
PRINT NNROOMS
    NNROOMS2
    NEW_TOTAL_AMT
    NO_COMP
    NEW_ROOM_RATE
    TOT_NCMP_SVGS
    TOTAL_STD
    TOTAL_SLSAV
    TOTAL_RR
    PC_SVGS
    A_SVGS
-*    T_SVGS
    NOI_AMT
    NOI_SVG
    ARTPC_AMT
    ARTPC_SVG
BY HTL_KEY
ON TABLE HOLD AS RPTHOLD FORMAT FOCUS INDEX HTL_KEY
END
-RUN


-INCLUDE UDTOTHTL
-RUN


-GOTO JOY
MATCH FILE RPTHOLD
PRINT NNROOMS
    NNROOMS2
    NEW_TOTAL_AMT
    NO_COMP
    NEW_ROOM_RATE
    TOT_NCMP_SVGS
    TOTAL_STD
    TOTAL_SLSAV
    PC_SVGS
    A_SVGS
-*    T_SVGS
    NOI_AMT
    NOI_SVG
    ARTPC_AMT
    ARTPC_SVG
BY HTL_KEY
ON TABLE HOLD
RUN 
FILE UDHH3
SUM HRS HSS 
BY HTL_KEY
AFTER MATCH HOLD AS TCHSAV OLD
END
-RUN

-JOY

TABLE FILE UDHH3
PRINT HRS HSS TAT_RT
BY HTL_KEY 
ON TABLE HOLD AS TCHSAV FORMAT FOCUS INDEX HTL_KEY
END
-RUN

 

JOIN HTL_KEY IN RPTHOLD TO HTL_KEY IN TCHSAV AS J1
-RUN



DEFINE FILE RPTHOLD
TAT_RAT/D15.2C = IF (NNROOMS LT 0) AND (TAT_RT LT 0) THEN ((NNROOMS * TAT_RT)*(-1)) ELSE NNROOMS * TAT_RT;  
TAT_SAV/D15.2CS = IF TOTAL_RR EQ 0 THEN 0 ELSE
                  IF TAT_RAT EQ 0 THEN 0 ELSE TAT_RAT - TOTAL_RR;
END
-RUN

TABLE FILE RPTHOLD
SUM TAT_RAT TAT_SAV AS 'T_SVGS' NEW_TOTAL_AMT AS 'TATAMT'  
BY HTL_KEY
WHERE TAT_SAV NE 0
ON TABLE HOLD AS RPT_HTAT
END
-RUN

TABLE FILE RPTHOLD
SUM NEW_TOTAL_AMT AS 'NEW_HAMT_RC' TOTAL_SLSAV
BY HTL_KEY
WHERE TOTAL_SLSAV NE 0
ON TABLE HOLD AS RPT_HTAT2
END
-RUN


MATCH FILE RPT_HTAT
SUM TAT_RAT T_SVGS TATAMT
BY HTL_KEY
ON TABLE HOLD
RUN
FILE RPT_HTAT2
SUM NEW_HAMT_RC
BY HTL_KEY
AFTER MATCH HOLD AS RPTHTAT OLD-OR-NEW
END
-RUN


-*========================================================================
-*   PROCESS EXTRACT DATA FROM STEP4 - HOLD TO FOCUS DATABASE TCTHTL       
-*========================================================================
DEFINE FILE RPTHOLD
HTL_SCSAV/P15.2 = HSS;
HTL_SCSAVC/P15.2 = HSS * (-1);
RATE/P15.2CS = NEW_TOTAL_AMT;
-*HRS_AMT1/D15.2CS = IF HTL_SCSAV EQ 0 THEN 0 ELSE 
-*                  IF (RATE LT 0) AND (NNROOMS LT 0) THEN (HTL_SCSAVC*NNROOMS) ELSE
-*                 IF ((RATE LT 1) AND (NNROOMS GT (-1))) THEN 0 ELSE
-*                    (HTL_SCSAV*NNROOMS);


HRS_AMT/D12.2CS = IF HTL_SCSAV EQ 0 THEN 0 ELSE 
                   IF (NNROOMS LT 0) AND HSS LT 0 THEN (HTL_SCSAVC*NNROOMS) ELSE
                      (HTL_SCSAV*NNROOMS);

-*HRS_AMT1/D15.2CS = IF RATE LT 0 THEN HRS_AMT*(-1) ELSE HRS_AMT;
 
HRS_AMT1/D12.2CS = IF (RATE LT 0) AND (HRS_AMT GT 0) THEN HRS_AMT*(-1) ELSE HRS_AMT;

HRS_DAYS/D12CS = IF HRS_AMT1 NE 0 THEN NNROOMS ELSE 0;



ROLLCD/A8 = '&&ROLL';
END
TABLE FILE RPTHOLD
SUM RATE   
    NEW_TOTAL_AMT
    NO_COMP
    TOT_NCMP_SVGS
    TOTAL_STD
    TOTAL_SLSAV
    PC_SVGS
    A_SVGS
-*    T_SVGS
    NOI_AMT
    NOI_SVG
    ARTPC_AMT
    ARTPC_SVG
    HRS_AMT1
    HRS_DAYS
BY HTL_KEY
BY ROLLCD
ON TABLE HOLD AS TCHSV2
END
-RUN


MATCH FILE RPTHTAT
SUM  T_SVGS TATAMT NEW_HAMT_RC
BY HTL_KEY
ON TABLE HOLD
RUN
FILE TCHSV2
PRINT RATE   
    NEW_TOTAL_AMT
    NO_COMP
    TOT_NCMP_SVGS
    TOTAL_STD
    TOTAL_SLSAV
    PC_SVGS
    A_SVGS
    NOI_AMT
    NOI_SVG
    ARTPC_AMT
    ARTPC_SVG
    HRS_AMT1
    HRS_DAYS
    ROLLCD
BY HTL_KEY
AFTER MATCH HOLD AS XTWO OLD-OR-NEW
END
-RUN





TABLE FILE XTWO
SUM NEW_TOTAL_AMT
    TOTAL_STD
    TOTAL_SLSAV
    PC_SVGS
    A_SVGS
    T_SVGS 
    NO_COMP
    TOT_NCMP_SVGS 
    NOI_AMT
    NOI_SVG
    ARTPC_AMT
    ARTPC_SVG
    HRS_AMT1
    HRS_DAYS
    TATAMT
    NEW_HAMT_RC
BY ROLLCD
ON TABLE HOLD AS HOLD3
END
-RUN


DEFINE FILE HOLD3
NMB/I5 = NMB + 1;END
END
TABLE FILE HOLD3
SUM NEW_TOTAL_AMT
    TOTAL_STD
    TOTAL_SLSAV
    PC_SVGS
    A_SVGS
    T_SVGS 
    NO_COMP
    TOT_NCMP_SVGS 
    NOI_AMT
    NOI_SVG
    ARTPC_AMT
    ARTPC_SVG
    HRS_AMT1
    HRS_DAYS
    TATAMT
    NEW_HAMT_RC
BY ROLLCD
BY NMB
ON TABLE HOLD AS TCHSV3
END
-RUN






MODIFY FILE TC_HSAV
FIXFORM FROM TCHSV3
MATCH ROLLCD NMB
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON TCHSV3
END
-RUN

 



-NEXTONE


 
 
