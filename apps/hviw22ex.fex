-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File HVIW22EX.FEX
-* CREATED FOR DATA VAULT HOTEL DETAIL REPORTS
-* CREATED FROM HVIEW1
-********************************************************************
-* MODIFICAIONS:
-* Commented out where statement on last hold file due to this not balancing other hotel reports
-* 5/29/12 - Deb
-*7/11/16 -DLV -  S-20630   Added EMP_ID to extract

-********************************************************************
-*
-* This program extracts data for the series of basic hotel location listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  

-********************************************************************
-INCLUDE SETECHO

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';


DEFINE FILE &&EXTRACT


  DATA_V1/A9 = '*********';  
  DV_NUM2/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
  DV_NUM/A15 = IF DV_NUM2 EQ ' ' THEN ' ' ELSE DATA_V || DV_NUM2;
  CITY_ST/A35 = PROP_CITY||(', '| PROP_STATE);
  LEVEL_DESC/A60  = &&LDESC;
  IN_DATE/MDYY = CHKIN_DATE;
  NBR_DAYS/D12 =  NUM_DAYS;
  NBR_ROOMS/D12 = NUM_ROOMS;
  NEW_ROOM_RATE/D14.2C = ROOM_RATE;
  NEW_STD_RATE/D14.2C = STD_RATE;
  NEW_TOTAL_AMT/D14.2C = TOTAL_AMT;
  NNROOMS/D12 = IF ((NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)) THEN 
                ((NBR_DAYS*NUM_ROOMS) * (-1)) ELSE NBR_DAYS*NUM_ROOMS;
  OUT_DATE/MDYY = CHKOUT_DATE;
  XPSNGR_NM/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  PROP_ZIP5/A5=EDIT(PROP_ZIP, '99999$$$$$');
  PRP_ADDRSS/A18 = EDIT(PROP_ADDRESS,'999999999999999999$$$$$$$$$$$$');
  XINV_DT/MDYY        = INVOICE_DATE;

-* ****DEFINES ON PREVIOUS DEFINES****
   GROSS_BOOK/D8 = IF NEW_TOTAL_AMT GE 0 THEN 1 ELSE 0;
   BOOKINGS/D8 = IF NEW_TOTAL_AMT GE 0 THEN 1 ELSE (-1);
   TOTAL_STD/D12.2C = IF ((NNROOMS LT 0) AND (NEW_STD_RATE LT 0))
                      THEN ((NNROOMS * NEW_STD_RATE) * (-1))
                      ELSE NNROOMS * NEW_STD_RATE;
 MIR_SEQ1/A1 = EDIT(MIR_SEQ, '9$$$$$');

 RES_SYS/A1 = IF MIR_SEQ1 EQ 'X' THEN 'S' ELSE 'A';

 PROP_CODE1/A7 = IF RES_SYS EQ 'S' THEN PROP_SABRE_CODE ELSE PROP_APOLLO_CODE;                     

END
-RUN

TABLEF FILE &&EXTRACT
PRINT AIRPORT_CODE
  AGENT_NUM	
  AR_BRANCH
  BOOKINGS	
  BR_CL_IDX	
  CHAIN_CODE 	
  CHAIN_NAME
  CITY_CODE
  CITY_ST
  CITY.COUNTRY_CODE AS 'COUNTRY'
  CLIENT_NAME	
  DOD_TYPE
  DV_NUM
  EMP_ID
  GROSS_BOOK
  HOTEL_PHONE 	
  HTL_KEY
  IN_DATE 	
  INVOICE_DATE 	
  INVOICE_NUM 
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY 
  PROP_CODE1 AS 'PROP_CODE'
  PROP_CNTRY	
  PROP_NAME 	
  PROP_STATE_CD 
  PROP_ZIP5
  PRP_ADDRSS
  RESV_BRANCH
  RESV_DATE
  RESV_STATUS	
  ROOM_RATE 	
  ROOM_TYPE
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 	
  TOTAL_STD
  XINV_DT
  XPSNGR_NM  
-INCLUDE &HTLDATES  
-* WHERE TOTAL_AMT NE 0
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10

-INCLUDE RPTPARMS

ON TABLE HOLD AS HTLHOLD1

END
-RUN
 


-SET &&DVRHTLRECS = &LINES;

TABLE FILE HTLHOLD1
SUM NNROOMS AS 'TROOMS'
    NEW_TOTAL_AMT AS 'TAMT'
BY LEVEL_DESC
BY PASSNGR_NAME
BY INVOICE_NUM
BY IN_DATE
ON TABLE HOLD AS HTLTOT
END
-RUN

MATCH FILE HTLHOLD1
PRINT AIRPORT_CODE
  AGENT_NUM	
  AR_BRANCH
  BOOKINGS	
  BR_CL_IDX	
  CHAIN_CODE 	
  CHAIN_NAME
  CITY_CODE
  CITY_ST
  COUNTRY 
  CLIENT_NAME	
  DOD_TYPE
  DV_NUM
  EMP_ID
  GROSS_BOOK
  HOTEL_PHONE 	
  HTL_KEY
-*  IN_DATE 	
  INVOICE_DATE 	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  OUT_DATE 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY 
  PROP_CODE
  PROP_CNTRY	
  PROP_NAME 	
  PROP_STATE_CD 
  PROP_ZIP5
  PRP_ADDRSS
  RESV_BRANCH
  RESV_DATE
  RESV_STATUS	
  ROOM_RATE 	
  ROOM_TYPE
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 	
  TOTAL_STD
  XINV_DT
  XPSNGR_NM  
BY LEVEL_DESC	
BY PASSNGR_NAME
BY INVOICE_NUM
BY IN_DATE
ON TABLE HOLD
RUN
FILE HTLTOT
SUM TROOMS
    TAMT
BY LEVEL_DESC
BY PASSNGR_NAME
BY INVOICE_NUM
BY IN_DATE
AFTER MATCH HOLD AS HTLHOLD2 OLD-OR-NEW
END
-RUN


TABLE FILE HTLHOLD2
PRINT AIRPORT_CODE
  AGENT_NUM	
  AR_BRANCH
  BOOKINGS	
  BR_CL_IDX	
  CHAIN_CODE 	
  CHAIN_NAME
  CITY_CODE
  CITY_ST
  COUNTRY 
  CLIENT_NAME	
  DOD_TYPE
  DV_NUM
  EMP_ID
  GROSS_BOOK
  HOTEL_PHONE 	
  HTL_KEY
  IN_DATE 	
  INVOICE_DATE
  INVOICE_NUM
  LEVEL_DESC
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  OUT_DATE 
  PASSNGR_NAME
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY 
  PROP_CODE
  PROP_CNTRY	
  PROP_NAME 	
  PROP_STATE_CD 
  PROP_ZIP5
  PRP_ADDRSS
  RESV_BRANCH
  RESV_DATE
  RESV_STATUS	
  ROOM_RATE 	
  ROOM_TYPE
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 	
  TOTAL_STD
  XINV_DT
  XPSNGR_NM  
  TROOMS
  TAMT
-*WHERE TROOMS NE 0
-*WHERE TAMT NE 0
ON TABLE HOLD AS HTLHLD
END
-RUN