-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* Carried through non_tkts ref_tkts JK 9/29/04
-* ADDED CODE FOR GLOBAL CURRENCY - DEB 11/9/04
-* CARRIED THROUGH AA_TKT DL_TKT NW_TKT OTH_TKT UA_TKT - DEB 11/17/04
-* CREATED FOR TOP TICKET EXCHANGE SUMMARY REPORT - DEB 6/8/05
-* ADDED REF_EXCH_CNT2 FOR ABTPEXCA - STEVE 08/04/2006
-*12/28/15 - JEM - S-13286 Updated to allow reports to sort/subtotal by id-levels
-* 02/24/2017 - DLV - S-22486 CHANGED ettek Review to Post-trip Reporting
-*09/28/2017 - JEM - S-35422 Place the footer date/time stamp text in a separate file to be -INCLUDED in the stylesheets

-INCLUDE SETECHO
-* File SMRYRPT.FEX
-**********************************************************************
-**********************************************************************

SET ASNAMES = ON
-RUN


-IF &&CURRENCY EQ 'USD' THEN GOTO NEXT;

-SET &&SUBHEAD = <NAMEC;
-SET &FPAID_CUR = 'FARE PAID, (' | &&CURRENCY || ')';
-SET &GCPK_CUR= 'COST,/KLMTR, (' | &&CURRENCY || ')';
-SET &&S_SUBJ2='PAID_FAREX/D16.2CS AS ' | '''&FPAID_CUR.EVAL'''  ;
-SET &&S_SUBJ4='KILO/P9CS AS ''TOTAL KLMTRS''';
-SET &&S_SUBJ5='COMPUTE GCPK/P14.2CS= IF ((KILO LT 1) AND'; 
-SET &&S_SUBJ6='(KILO GT (-1))) THEN 0 ELSE';
-SET &&S_SUBJ7='(PAID_FAREX/KILO); AS ' | '''&GCPK_CUR.EVAL''';

-NEXT;

-* -IF &&SETF NE 'ABTPEXCA' THEN GOTO SKIP;

TABLE FILE TOPTVL1
PRINT AA_TKT
        AIR_KEY
        AIRLINE
        AIRLINE_FEE
        AIRFEE_CNT	
        INTL_DOM	
        AR_BRANCH
        BR_CL_IDX        
        CLASS
        CLIENT_NUM	
        COMM_SEG
        DL_TKT               	
        EMB_CNTRY_CODE
        CPMILE	
        DISSAVINGS
        DPT_TIME
        EMB_APT_CD
        EMB_APT_NM	
        EMB_CTY_NM
        F_EXCH_CNT
        FARE_BAS		
        FARE_PAID
        KILO
        LEVEL_DESC	
        LEVEL1	
        LEVEL2	
        LEVEL3
        MRK_TKT_CNT
        NAMEC
        NET_COMM	
        NET_FARE	
        NET_TKT_CNT
        NEW_SEG_LOWEST
        NEW_SEG_MILES
        NEW_STAY
        NEW_TRIP_LENGTH
        NON_TKTS
        NW_TKT
        OTH_TKT
        PASSNGR_NAME
        REF_EXCH_CNT
        REF_EXCH_CNT2
        REFUSE_CODE
        REF_TKTS
        RTE_APT_CD
        RTE_APT_NM
        RTE_CTY_NM	
        SAVINGS	
        SEG_AMT	
        SEG_COUNT	
        SEG_DISCOUNT	
        SEG_LOWEST
        SEG_NBR	
        SEG_STANDARD	
        SEG_TAX	
        STAY
        TICKET_BRANCH	
        TKT_AMOUNT	
        TKT_NUM	
        TKT_PURCH
        TKT_SORT
        TKT_TYPE	
        TOTAL_FARE	
        TRN_DATE
        UA_TKT	
        VAL_AIRLINE	
        VASAVINGS
        XDPT_DT	
        XPSNGR_NM	
        XTRAN_DT
        PAID_FAREX
        PAID_FARE1
BY TKT_NUM
WHERE (EX_RF_FLAG EQ 'E') OR (EMBARK EQ 'FP2')
BY HIGHEST TKT_TYPE  NOPRINT
ON TABLE HOLD AS HOLD2
END
-RUN

DEFINE FILE HOLD2
TCOUNT/D8 = IF TKT_NUM NE LAST TKT_NUM AND TKT_TYPE EQ 'P-EX' THEN 1 ELSE 0;
END
-RUN

TABLE FILE HOLD2
PRINT AA_TKT
        AIR_KEY
        AIRLINE
        AIRLINE_FEE
        AIRFEE_CNT	
        INTL_DOM	
        AR_BRANCH
        BR_CL_IDX        
        CLASS
        CLIENT_NUM	
        COMM_SEG
        DL_TKT               	
        EMB_CNTRY_CODE
        CPMILE	
        DISSAVINGS
        DPT_TIME
        EMB_APT_CD
        EMB_APT_NM	
        EMB_CTY_NM
        F_EXCH_CNT
        FARE_BAS		
        FARE_PAID
        KILO
        LEVEL_DESC	
        LEVEL1	
        LEVEL2	
        LEVEL3
        MRK_TKT_CNT
        NAMEC
        NET_COMM	
        NET_FARE	
        NET_TKT_CNT
        NEW_SEG_LOWEST
        NEW_SEG_MILES
        NEW_STAY
        NEW_TRIP_LENGTH
        NON_TKTS
        NW_TKT
        OTH_TKT
        PASSNGR_NAME
        REF_EXCH_CNT
        REFUSE_CODE
        REF_TKTS
        RTE_APT_CD
        RTE_APT_NM
        RTE_CTY_NM	
        SAVINGS	
        SEG_AMT	
        SEG_COUNT	
        SEG_DISCOUNT	
        SEG_LOWEST
        SEG_NBR	
        SEG_STANDARD	
        SEG_TAX	
        STAY
        TICKET_BRANCH	
        TKT_AMOUNT	
        TKT_NUM	
        TKT_PURCH
        TKT_SORT
        TKT_TYPE	
        TOTAL_FARE	
        TRN_DATE
        UA_TKT	
        VAL_AIRLINE	
        VASAVINGS
        XDPT_DT	
        XPSNGR_NM	
        XTRAN_DT
        PAID_FAREX
        PAID_FARE1
        TCOUNT AS 'P_EXCH_CNT'
        TCOUNT AS 'REF_EXCH_CNT2'
BY LEVEL_DESC
BY PASSNGR_NAME
ON TABLE HOLD AS TOPTVL2
END
-RUN

-* -SKIP

TABLE FILE TOPTVL2
SUM F_EXCH_CNT
         P_EXCH_CNT
BY LEVEL_DESC
BY PASSNGR_NAME
ON TABLE HOLD AS TKTFP
END
-RUN

TABLE FILE TOPTVL1
SUM NET_TKT_CNT AS 'TTKT'
BY LEVEL_DESC
BY PASSNGR_NAME
ON TABLE COLUMN-TOTAL
ON TABLE HOLD AS TKTH
END
-RUN




MATCH FILE TKTFP
PRINT F_EXCH_CNT
      P_EXCH_CNT
BY LEVEL_DESC
BY PASSNGR_NAME
ON TABLE HOLD
RUN
FILE TKTH
SUM TTKT
BY LEVEL_DESC
BY PASSNGR_NAME
AFTER MATCH HOLD AS TKTH2 OLD-OR-NEW
END
-RUN




MATCH FILE TOPTVL2
PRINT FARE_PAID
      PAID_FAREX
      KILO 
      NAMEC
      NEW_SEG_MILES
      AIRLINE_FEE
      AIRFEE_CNT
      NON_TKTS
      REF_TKTS
      AA_TKT
      DL_TKT
      UA_TKT
      NW_TKT
      OTH_TKT  
      PASSNGR_NAME
      REF_EXCH_CNT
      REF_EXCH_CNT2
      NET_TKT_CNT
BY LEVEL_DESC
BY PASSNGR_NAME
ON TABLE HOLD
RUN
FILE TKTH2
PRINT TTKT
    F_EXCH_CNT
    P_EXCH_CNT
BY LEVEL_DESC
BY PASSNGR_NAME
AFTER MATCH HOLD AS TOPTVL3 OLD-OR-NEW
END
-RUN

TABLE FILE TOPTVL3
SUM NET_TKT_CNT TTKT
    FARE_PAID
    F_EXCH_CNT
    P_EXCH_CNT
    PAID_FAREX/D16.2CS
    KILO
    NAMEC 
    NEW_SEG_MILES
    AIRLINE_FEE
    AIRFEE_CNT
    NON_TKTS
    REF_TKTS
    AA_TKT
    DL_TKT
    UA_TKT
    NW_TKT
    OTH_TKT
    REF_EXCH_CNT
    REF_EXCH_CNT2
BY LEVEL_DESC
BY PASSNGR_NAME   
ON TABLE HOLD AS RNKHLD1
END
-RUN



DEFINE FILE RNKHLD1
TOT_EXCH_CNT/D9=REF_EXCH_CNT+REF_EXCH_CNT2;
END
-RUN

-SET &&RANK_METH = REF_EXCH_CNT;



TABLE FILE RNKHLD1
SUM REF_EXCH_CNT
    NET_TKT_CNT
    TTKT
    F_EXCH_CNT
    P_EXCH_CNT
    FARE_PAID
    KILO
    LEVEL_DESC
    NAMEC
    NEW_SEG_MILES
    PAID_FAREX/D16.CS
    AIRLINE_FEE
    AIRFEE_CNT
    NON_TKTS
    REF_TKTS
    AA_TKT
    DL_TKT
    UA_TKT
    NW_TKT
    OTH_TKT
    REF_EXCH_CNT
    REF_EXCH_CNT2
    TOT_EXCH_CNT
BY LEVEL_DESC    
-* RANKED BY &&RANK_ORDER &&RANK_METH NOPRINT
RANKED BY HIGHEST &&RANK_METH
BY PASSNGR_NAME
ON TABLE HOLD AS RNKHLD2
END
-RUN



-SET &&RANK_LIMIT = 999;

DEFINE FILE RNKHLD2
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  LIST/D9 = (LAST LIST + 1);
  CRANKX/A11 = FTOA(LIST, '(D9)', 'A11');
  CRANK/A9 = EDIT(CRANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE 
                  IF LIST GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                  CRANK;
  RANK_VAL/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE
                IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE
                ARANK;
  RANK_LAB1/A80 = IF RANK_VAL NE 'ALL OTHER' THEN &&RANK_LABEL1
                  ELSE 'ALL OTHER';
  RANK_LABEL1/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2
                      ELSE ' ';
  RANK_LABEL3/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3
                      ELSE ' ';
-* NET_TKT_CNT/D9S = IF (SEG_NBR EQ '01') THEN TTKT ELSE 0;
NOWTOD/A8 WITH RANK = HHMMSS (NOWTOD);
END
-RUN




TABLE FILE RNKHLD2
SUM REF_EXCH_CNT
    NET_TKT_CNT
    TTKT
    F_EXCH_CNT
    P_EXCH_CNT
    FARE_PAID
    KILO
    LEVEL_DESC
    NAMEC
    NEW_SEG_MILES
    PAID_FAREX/D16.CS
    AIRLINE_FEE
    AIRFEE_CNT
    NON_TKTS
    REF_TKTS
    AA_TKT
    DL_TKT
    UA_TKT
    NW_TKT
    OTH_TKT
    REF_EXCH_CNT
    REF_EXCH_CNT2
    TOT_EXCH_CNT
BY LEVEL_DESC
BY RANK_VALUE
BY PASSNGR_NAME
ON TABLE HOLD AS HOLD3
END
-RUN


TABLE FILE HOLD3
PRINT REF_EXCH_CNT
    NET_TKT_CNT
    TTKT
    F_EXCH_CNT
    P_EXCH_CNT
    FARE_PAID
    KILO
    LEVEL_DESC
    NAMEC
    NEW_SEG_MILES
    PAID_FAREX/D16.CS
    PASSNGR_NAME
    AIRLINE_FEE
    AIRFEE_CNT
    NON_TKTS
    REF_TKTS
    AA_TKT
    DL_TKT
    UA_TKT
    NW_TKT
    OTH_TKT
    REF_EXCH_CNT
    REF_EXCH_CNT2
    TOT_EXCH_CNT
    RANK_VALUE
 BY LEVEL_DESC
 RANKED BY HIGHEST &&RANK_METH
 ON TABLE HOLD AS HOLD4
 END
 -RUN

 
 
 -SET &&RANK_LIMIT2 = 100;
 -SET &&RANK_LABEL1 = 'PASSNGR_NAME';
  
 DEFINE FILE HOLD4
   PAX_LIMIT/I5 = &&RANK_LIMIT2;
   CRANK/D5     = RANK;
   BRANK/A6     = FTOA(CRANK, '(D5)', 'A6');
 -*  LIST/D6      = IF PASSNGR_NAME NE LAST PASSNGR_NAME THEN (LAST LIST + 1)
 -*                  ELSE LAST LIST;    
   LIST/D6      = (LAST LIST + 1);
   FRANKX/A7    = FTOA(LIST, '(D6)', 'A7');
   FRANK/A6     = EDIT(FRANKX,'$999999');
   PAX_VALUE/A9 = IF PAX_LIMIT EQ 0 THEN BRANK ELSE
                  IF RANK GT PAX_LIMIT THEN 'OTHER' ELSE BRANK;
   RANK_LABEL1/A60 = IF PAX_VALUE NE 'OTHER' THEN &&RANK_LABEL1
                       ELSE ' ';
   RANK_LABEL2/A60 = IF PAX_VALUE NE 'OTHER' THEN &&RANK_LABEL2
                       ELSE ' ';
   RANK_LABEL3/A60 = IF PAX_VALUE NE 'OTHER' THEN &&RANK_LABEL3
                       ELSE ' ';
  FLAG/A1 = 'A'; 
 END
 -RUN


 
 
TABLE FILE HOLD4
PRINT FLAG
    REF_EXCH_CNT
    NET_TKT_CNT
    TTKT
    F_EXCH_CNT
    P_EXCH_CNT
    FARE_PAID
    KILO
    LEVEL_DESC
    NAMEC
    NEW_SEG_MILES
    PAID_FAREX/D16.CS
    PASSNGR_NAME
    AIRLINE_FEE
    AIRFEE_CNT
    NON_TKTS
    REF_TKTS
    AA_TKT
    DL_TKT
    UA_TKT
    NW_TKT
    OTH_TKT
    REF_EXCH_CNT
    REF_EXCH_CNT2
    TOT_EXCH_CNT
    RANK_LABEL1
    RANK_LABEL2
    RANK_LABEL3
BY LEVEL_DESC
BY PAX_VALUE
BY RANK_VALUE
BY PASSNGR_NAME
ON TABLE HOLD AS AIRHOLD5
END
-RUN

 

DEFINE FILE AIRHOLD5
FLAG/A1 = 'A';
END
TABLE FILE AIRHOLD5
SUM REF_EXCH_CNT AS 'TOTETKT'
BY FLAG
ON TABLE HOLD AS HOLD5
END
-RUN
 


MATCH FILE AIRHOLD5
PRINT  
    REF_EXCH_CNT
    NET_TKT_CNT
    TTKT
    F_EXCH_CNT
    P_EXCH_CNT
    FARE_PAID
    KILO
    LEVEL_DESC
    NAMEC
    NEW_SEG_MILES
    PAID_FAREX 
    PASSNGR_NAME
    AIRLINE_FEE
    AIRFEE_CNT
    NON_TKTS
    REF_TKTS
    AA_TKT
    DL_TKT
    UA_TKT
    NW_TKT
    OTH_TKT
    REF_EXCH_CNT
    REF_EXCH_CNT2
    TOT_EXCH_CNT
    RANK_LABEL1
    RANK_LABEL2
    RANK_LABEL3
    LEVEL_DESC
    PAX_VALUE
    RANK_VALUE
    PASSNGR_NAME 
BY FLAG
ON TABLE HOLD
RUN
FILE HOLD5
SUM TOTETKT
BY FLAG
AFTER MATCH HOLD AS XTHREE OLD-OR-NEW
END
-RUN
 

TABLE FILE XTHREE
PRINT FLAG
    REF_EXCH_CNT
    NET_TKT_CNT
    TTKT
    F_EXCH_CNT
    P_EXCH_CNT
    FARE_PAID
    KILO
    LEVEL_DESC
    NAMEC
    NEW_SEG_MILES
    PAID_FAREX/D16.CS
    PASSNGR_NAME
    AIRLINE_FEE
    AIRFEE_CNT
    NON_TKTS
    REF_TKTS
    AA_TKT
    DL_TKT
    UA_TKT
    NW_TKT
    OTH_TKT
    REF_EXCH_CNT
    REF_EXCH_CNT2
    TOT_EXCH_CNT
    RANK_LABEL1
    RANK_LABEL2
    RANK_LABEL3
    TOTETKT
BY LEVEL_DESC
BY PAX_VALUE
BY RANK_VALUE
BY PASSNGR_NAME
ON TABLE HOLD AS AIRHOLD6
END
-RUN


 

-FINrpt;



DEFINE FILE AIRHOLD6
NOWTOD/A8 WITH RANK_VALUE = HHMMSS (NOWTOD);
  EXPCT/D8.1S=IF ((TOTETKT LT 1) AND (TOTETKT GT (-1))) THEN 0
               ELSE ((F_EXCH_CNT/TOTETKT)*100);

END
-RUN



-**********************************************************************
-*DATE           NAME               DESCRIPTION
-*7/31/00      IBISTL-KR            ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERSM
-**********************************************************************

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADER' ELSE 'HDREXLS'; 
-SET &&PASTYS = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE &&SMSTY;
-RUN

TABLE FILE AIRHOLD6
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
    &&S_SUBJ1
    &&S_SUBJ2
    &&S_SUBJ3
    &&S_SUBJ4
    &&S_SUBJ5
    &&S_SUBJ6
    &&S_SUBJ7
    &&S_SUBJ8
    &&S_SUBJ9
    &&S_SUBJ10
    
-*BY
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
-*ON
&&BREAKOPTION
   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10
   
-* 
-SET &FTR_AddlLines = 6;
FOOTING  
"</2> "
"THE FEES COLUMN ARE FORFEIT/PENALTY AMOUNTS"
"AIRLINE FEES ARE INCLUDED IN FEES ALONG WITH FORFEITED AMOUNTS"
"FARE PAID IS THE NET AMOUNT OF NEW EXCHANGE SALE MINUS ORIGINAL SALE AMOUNT"
-*
-INCLUDE FOOTERSM
-*

-* ON TABLE COLUMN-TOTAL
-*ON TABLE SET STYLE &&SMSTY
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**********************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
-IF '&&OUTFMT' NE 'PDF' OR 'PPT' GOTO XLSTY;

ON TABLE SET STYLE *
-INCLUDE &&SMSTY

-**********************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/18/00      IBISTL-KR            INCLUDE STYLESHEET PARAMS FOR 
-*                                  DRILLABLE REPORTS.
-**********************************************************************
-IF &&DRILLABLE EQ 'N' GOTO SKIP_DRILL;
-INCLUDE &&DSTY

-SKIP_DRILL

ENDSTYLE
&&OUTLINE1
&&SUMMDEST
&&OUTLINE2
END
-RUN

-IF &&DRILLABLE EQ 'Y' GOTO SKIP_R3;

EX REPORT_3

-SKIP_R3
-*-*-EXIT

-GOTO XXIT


-XLSTY;
ON TABLE SET STYLE *
-INCLUDE &&PASTYS
-IF &&DRILLABLE EQ 'N' GOTO SKIP_DRILL;
-INCLUDE &&DSTY

-SKIP_DRILL

ENDSTYLE
&&OUTLINE1
&&SUMMDEST
&&OUTLINE2
END
-RUN

-IF &&DRILLABLE EQ 'Y' GOTO SKIP_R31;

EX REPORT_3

-SKIP_R31
-GOTO XXIT


-XXIT