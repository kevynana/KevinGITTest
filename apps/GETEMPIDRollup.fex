-**************************************************************************************************
-* GETEMPIDRollup.FEX
-* this program is a one time task to query the rollup codes which used employee id in rpt_flds
-*
-* lsi 08/15/2016
-**************************************************************************************************
-INCLUDE SETECHO
SET ASNAME = ON

-SET &LASTLEVEL = '1';
-SET &DIR = 'D:\TEMP\LSI\';


DEFINE FILE EMPIDRollup
  LVL/A11 = EDIT(EMPIDLEVEL);
  EMPIDFLD/A10='ID_LEVEL' | EDIT(LVL,'$$$$$$$$$$9');
  LEVEL/A1= EDIT(LVL,'$$$$$$$$$$9');
END
TABLE FILE EMPIDRollup
BY LEVEL 
ON TABLE SAVE AS 'LEVELGRP'
END
-RUN
-SET &GROUPS = &LINES;

TABLE FILE EMPIDRollup
PRINT EMPIDFLD LEVEL
BY EMPIDLEVEL NOPRINT
BY ROLLUP_CODE
-*WHERE EMPIDLEVEL EQ &LASTLEVEL
-*ON TABLE HOLD FORMAT FOCUS INDEX ROLLUP_CODE
ON TABLE SAVE
END
-RUN


-SET &CNT = &LINES;
-SET &LASTLEVEL = '0';
-*FILEDEF FILEC DISK FILEC.ftm (APPEND


-REPEAT TOEND &CNT TIMES

-READ SAVE NOCLOSE &ROLLUP.8. &IDLEVEL.10. &LEVEL.1.
-TYPE &ROLLUP &IDLEVEL &LEVEL

-SET &FIELDNAME = 'ID_LEVEL' | &LEVEL;

-IF &LASTLEVEL EQ &LEVEL THEN SKIPFILEDEF;

-SET &DDNAME = 'HOLD' | &LEVEL;
-SET &HOLDX = &DIR | &DDNAME;
-SET &HOLDFILE = &HOLDX | '.FTM (APPEND ';  
FILEDEF &DDNAME DISK &HOLDFILE
-RUN

-SKIPFILEDEF

JOIN CLEAR *
JOIN SET_KEY IN RPT_INST TO SET_KEY IN RPT_SET AS J1
JOIN INST_KEY IN RPT_INST TO INST_KEY IN RPT_FLDS AS J2
END

TABLE FILE RPT_INST
PRINT &FIELDNAME
BY ROLLUP_CODE AS 'ROLLUP'
BY USER_NAME
BY SET_KEY 
BY SET_NAME
BY INST_KEY
BY RPT_NAME
WHERE ROLLUP_CODE EQ '&ROLLUP.EVAL'
WHERE &IDLEVEL NE ' '

ON TABLE HOLD AS  &DDNAME
END
-RUN

-NEXTONE
-SET &LASTIDLEVEL = &LEVEL;

-TOEND

-*generate reports from hold
-REPEAT TOEND2 &GROUPS TIMES
-READ LEVELGRP NOCLOSE &LEVEL.1.

-SET &FILENAME = 'HOLD' | &LEVEL;
-SET &FIELDNAME = 'ID_LEVEL' | &LEVEL;

-SET &DDNAME = 'HOLDLVL' | &LEVEL;
-SET &HOLDFILE = &DIR | 'HOLDLVL' | &LEVEL |'.xls';
FILEDEF &DDNAME DISK &HOLDFILE
-RUN

TABLE FILE &FILENAME
PRINT &FIELDNAME
BY ROLLUP
BY USER_NAME
BY SET_KEY 
BY SET_NAME
BY INST_KEY
BY RPT_NAME
ON TABLE HOLD AS &DDNAME FORMAT EXL2K
END
-RUN

-TOEND2

-EXIT
