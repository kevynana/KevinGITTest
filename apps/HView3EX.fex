-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-INCLUDE SETECHO
-* File HVIEW3EX.FEX
-********************************************************************
-* MODIFICAIONS:
-********************************************************************
-*
-* This program extracts data for the series of basic hotel location listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-* 12/12/01 - JK  ADDED DEFINE FOR ONLINE
-* 03/31/04 - DV  ADDED BOOKINGS DEFINE PER STEVE
-* 08/16/05 - DV CHANGED ONLINE DEFINE TO USE DOD_TYPE INSTEAD OF
-* ONLINE/A1 = IF AGENT EQ '00444' THEN 'Y' ELSE 'N';  
-* 10/11/05 - DEB - ADDED DOD_TYPE H TO ONLINE DEFINE
-* 07/05/06 - STEVE - Added code for ABTOPHTC (by City Name vs Property City)
-* 09/07/06 - STEVE - Added code for Geo Zone
-* 10/04/06 - JOY - Added Prop_Code
-*  4/29/10   DEB         CHANGED RATE_GRP FOR ROUNDING
-* 5/28/13  - JOY - Added CGHF define
-* 7/16/13 - Joy Added fields for new VX reports that use Lanyon Data
-* 7/16/13 - Joy Added an additional phone number to the CGHF Define
-*1/29/14 UPDATED ONLINE/TRADITIONAL DEFINES TO USE ONLINE_TRADITIONAL FIELD INSTEAD OF DOD_TYPE
-*2/12/14 Added Logic to incorporate the TAT udid - JK
-*9/4/14 Updated CGHF define with new phone numbers for 2014. JK 
-* 9/9/14 Updated Pref_non define to use exclude_flags - jk
-*9/17/14 Added an additional phone number to cfhg define - JK
-*10/8/14 Added join to rollup_hotel_client_pref - JK
-*10/24/14 Updated to carry through HTL_PREF_SHT_DESC - JK
-*10/29/14 Testing with hold files for MXT50HR BLANK RECORDS - JK
-*10/31/14 Tested with hold files for ABTOPHTL - JK
-*11/25/14 Added GEO_ZONE to all hold files - Deb
-*1/29/15 S-07138 UPDATED CHGF DEFINE FOR 2015 PREFERRED CONG HOTELS
-*05/11/16 - JEM - S-18831 - Updated to correct error when an airport instead of a city is chosen and no records report is produced
-*08/21/17 - DLV - D-01611 - Added VXTOPHTC TO ABTOPHTC routine
-*08/24/17 - DLV - S-38843 - Added TRAN_MY define for VXTOPHTM
-********************************************************************

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';

-IF &&SETF EQ 'ABTOPHTC' OR 'CHTOPHTC' OR 'SELTPHTC' OR 'ABTPHTCS' OR 'NUTPHTX' OR 'ABTPHTAT' OR 'VXTOPHTC' 
-          OR 'VXTOPHTM' THEN GOTO ABTOPHTC;

DEFINE FILE &&EXTRACT
  CARD_NUM/A12 = EDIT(CREDIT_CARD, '$$999999999999$$$$');
  CARD1_NUM/A4 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$$$9999');
-IF '&&ROLLUP.EVAL' NE 'MOFO-R' THEN GOTO Skip;
  PROP_CITY/A25 = IF PROP_PHONE EQ '6503221234' THEN 'PALO ALTO' ELSE PROP_CITY;
-Skip  
-* Commented out CGHF is what Conagra used for 2013 new define is for 2014 hotels
-*   CGHF/A1 = IF HOTEL_PHONE EQ '5095861332' OR '2087368000' OR '7658075735' OR '6202757471' OR 
-*               '8706981900' OR '5097653731' OR '3103187732' OR '4026364945' OR '4023467600' OR '3145873045' OR 
-*               '7029469207' OR '3177154906' OR '9254695955' OR '9093702424' OR '5105214500' OR 
-*               '5173242072' OR '6102506500' OR '7176331117' OR '3193510645' OR '4024207800' OR 
-*               '9256066400' OR '9013226544' OR '7152959900' OR '5597323900' OR '4079032130' OR 
-*               '9053629484' OR '2087338500' OR '8652512570' OR '3146418821' OR '7709346000' OR 
-*               '5133876000' OR '7176371228' OR '6068620077' OR '5095437000' OR '5097378000' OR 
-*               '6608264000' OR '7172939500' OR '3192747000' OR '4506829000' OR '5032565000' OR 
-*               '7208952330' OR '6306577672' OR '6306577672' OR '2089398266' OR '4022801516' THEN 'Y' ELSE 'N';
-* Commented out CGHF is what Conagra used for 2014 new define is for 2015 hotels

-*CGHF/A1 = IF HOTEL_PHONE EQ '5633222200' OR '3106709000' OR '2188472000' OR '5097830611' OR '5099467611' OR 
-*                            '5095470701' OR '3146551234' OR '3106427500' OR '4799672299' OR '5099429400' OR
-*                            '8096850000' OR '8032312000' OR '8472929100' OR '3198321130' OR '6142312869' OR 
-*                            '4047679300' OR '2083315600' OR '2703885777' OR '8164159600' OR '6082449400' OR 
-*                            '2709262006' OR '5099434400' OR '2082338200' OR '8045207333' OR '8456230900' OR 
-*                            '2699795577' OR '3207633360' OR '7158489700' OR '6515782822' OR '7406542999' OR 
-*                            '7758537100' OR '7037238989' OR '7165650040' OR '6238823351' OR '8313736141' OR
-*                            '2037839988' OR '2298881590' OR '3367651298' OR '8172220222' OR '5592992203' OR 
-*                            '3033719393' OR '9727881342' OR '4792548400' OR '6305050900' OR '4142717250' OR 
-*                            '4506822225' OR  '3346717676' OR '5197200084' OR '8709317727' OR '7637929292' OR 
-*                            '8132274000' OR '2699790500' OR '5132046000' OR '4166464600' OR '7163667100' OR 
-*                            '5415640202' OR '4166463000' OR '2706852433' OR '9207485500' OR '7176252366' OR 
-*                            '7753586900' OR '7877210303' OR '6154462781' OR '9376675161' OR '7172391600' OR 
-*                            '9133448100' OR '9157724722' OR '8032173999' OR '9135348384' OR '3192666611' OR 
-*                            '8166305500' OR '3197314444' OR '2293828800' OR '8016271190' OR '4025135500' OR 
-*                            '2533954300' OR '39773273470' OR '5716578700' OR '5723307777' OR '5716341777' OR 
-*                            '5744485700' OR '5753738080' OR '5716578787' OR '6326338888' OR '862162798888'  OR '5196208936' THEN 'Y' ELSE 'N';
CGHF/A1 = IF HOTEL_PHONE EQ '3178769777' OR '5415645911' OR '6083656000' OR 
'9015255491' OR '7877918777' OR '7877210303' OR '5023278880' OR '6148515599' OR 
'4028952900' OR '5207410505' OR '9017676666' OR '5045811300' OR '6264458525' OR 
'2087368000' OR '5014901000' OR '6305539805' OR '2188472121' OR '4023394900' OR
'9157716200' OR '6184339900' OR '2093346988' OR '525552838700' OR '5099439800' OR 
'5094528635' OR '5717953500' OR '7045447902' OR '7753563300' OR '3144369000' OR 
'3033731983' OR '2187321234' THEN 'Y' ELSE 'N';

  CITY_ST/A35 = PROP_CITY||(' '| PROP_STATE);
-*   CITY_ST/A36 = PROP_CITY||(' '| PROP_STATE);
  
  LEV_2/A15 = IF PASSNGR_NAME NE LAST PASSNGR_NAME THEN LEVEL2 ELSE ' ';
  LEVEL_DESC/A60  = &&LDESC;
  IN_DATE/MDYY = CHKIN_DATE;
  INV_DATE/MDYY = INVOICE_DATE;
  NEW_ROOM_RATE/D12.2C = ROOM_RATE;
  NEW_STD_RATE/D12.2C = STD_RATE;
  NEW_TOTAL_AMT/D12.2C = TOTAL_AMT;
  NBR_DAYS/D12 =  NUM_DAYS; 
  NNROOMS/D12 = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
  OUT_DATE/MDYY = CHKOUT_DATE;
  ONLINE/A1 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN 'Y' ELSE 'N';
  
-*  PREF_NON/A15 = IF CLIENT_PREF EQ 'C' OR 'P' OR 'N' OR 'M' OR 'L'  THEN 'PREFERRED' ELSE 'NON-PREFERRED';
-*                 IF '&&ROLLUP' EQ 'GWL-R' AND PROP_NAME CONTAINS 'DOUBLETREE DENVER TECH' THEN 'PREFERRED' ELSE 
  
 PNP_FLAG/A1 = EDIT(EXCLUDE_FLAGS, '$9');
 PNP_IE/A1 = EDIT(EXCLUDE_FLAGS, '$$9');
  
 PREF_NON/A15 = IF PNP_FLAG EQ 'I'  THEN 'PREFERRED' ELSE 'NON-PREFERRED';  
  PROP_ZIP5/A5=EDIT(PROP_ZIP, '99999$$$$$');
-* RATE_GRP/A15 = IF ((ROOM_RATE GE 0 AND ROOM_RATE LT 150) OR
-*                      (ROOM_RATE LE 0 AND ROOM_RATE GT (-150)))
-*                  THEN '$0 - $149' ELSE
-*                  IF ((ROOM_RATE GE 150 AND ROOM_RATE LE 199) OR
-*                      (ROOM_RATE LE (-150) AND ROOM_RATE GE (-199)))
-*                  THEN '$150 - $199' ELSE
-*                  IF ((ROOM_RATE GE 200 AND ROOM_RATE LE 249) OR
-*                      (ROOM_RATE LE (-200) AND ROOM_RATE GE (-249)))
-*                  THEN '$200 - $249' ELSE '$250 OR GREATER';

 PRP_NAME/A25 = EDIT(PROP_NAME, '$$$$$$$$$$$$$$$$$$$$$$$$$');

 RATE_GRP/A15 = IF ((ROOM_RATE GE 0 AND ROOM_RATE LT 149.50) OR
                      (ROOM_RATE LE 0 AND ROOM_RATE GT (-149.50)))
                   THEN '$0 - $149' ELSE
                   IF ((ROOM_RATE GE 149.50 AND ROOM_RATE LT 199.50) OR
                      (ROOM_RATE LE (-149.50) AND ROOM_RATE GT (-199.50)))
                   THEN '$150 - $199' ELSE
                   IF ((ROOM_RATE GE 199.50 AND ROOM_RATE LT 249.50) OR
                      (ROOM_RATE LE (-199.50) AND ROOM_RATE GT (-249.50)))
                   THEN '$200 - $249' ELSE '$250 OR GREATER';



  REASON_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
  REFUSE_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
  RSNCDE/A48=REFUSE_CD|| '-' ||REFUSAL_DESC;
  RES_DT/MDY = RESV_DATE;
  MIR_SEQ1/A1 = EDIT(MIR_SEQ, '9$$$$$');
  RES_SYS/A1 = IF MIR_SEQ1 EQ 'X' THEN 'S' ELSE 'A';
  TAT_RAT/D12.2 = 0;
  TAT_SAV/D12.2 = 0;
  ROLLPREF_KEY/A9='&&ROLLUP.EVAL'|CLIENT_PREF;
  TRAN_MY/MYY = INVOICE_DATE;
-* ****DEFINES ON PREVIOUS DEFINES****

  TOTAL_STD/D12.2C = IF (NNROOMS LT 0) AND (NEW_STD_RATE LT 0) 
                     THEN ((NNROOMS * NEW_STD_RATE)*(-1))
                     ELSE NNROOMS * NEW_STD_RATE;

 
-* ***DEFINES ON PREVIOUS DEFINED DEFINES***
   BOOKINGS/D8 = IF NEW_TOTAL_AMT GE 0 THEN 1 ELSE (-1);
   SAVINGS/D12.2CS = TOTAL_STD - TOTAL_AMT;
   TOTAL_SLSAV/D12.2C = TOTAL_STD - NEW_TOTAL_AMT;
   XIN_DOW/WR = IN_DATE;
   XOUT_DOW/WR = OUT_DATE;
   
   PROP_CODE1/A7 = IF RES_SYS EQ 'S' THEN PROP_SABRE_CODE ELSE PROP_APOLLO_CODE;

END
-RUN
 
TABLE FILE &&EXTRACT
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE 	
  CHAIN_NAME 	
  CLIENT_PREF
  CITY_ST
  CITY.GEO_ZONE AS 'GEO_ZONE'
  CREDIT_CARD	
  CLIENT_PREF
  HHL_CONFIRM 	
  HOTEL_PHONE 	
  HTL_KEY	
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 	
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 
  PREF_NON
  PROP_PHONE
  PROP_ADDRESS 	
  PROP_CITY 	
  PROP_CODE1 AS 'PROP_CODE'
  PROP_NAME
  PROP_STATE_CD 
  PROP_KEY
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE	
  RSNCDE	
  SAVINGS	
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 	
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY 
  XIN_DOW
  XOUT_DOW
  TAT_RAT
  TAT_SAV
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS
BY ROLLPREF_KEY  
-INCLUDE &HTLDATES  

-* WHERE INVOICE_DATE GE &&FROMDT.EVAL AND INVOICE_DATE LE &&TODT.EVAL
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS RPT_HOLDA FORMAT FOCUS INDEX ROLLPREF_KEY
END
-RUN


TABLE FILE ROLLUP_HTL_CLIENT_PREF
PRINT HTL_PREF_DESC HTL_CLIENT_PREF HTL_PREF_SHT_DESC
BY ROLLPREF_KEY 
ON TABLE HOLD AS PREFHLD FORMAT FOCUS INDEX ROLLPREF_KEY
END
-RUN



JOIN ROLLPREF_KEY IN RPT_HOLDA TO ROLLPREF_KEY IN PREFHLD AS JP1
-RUN



TABLE FILE RPT_HOLDA
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
-*   CHAIN_CODE 	
  CHAIN_NAME 	
  CITY_ST
  GEO_ZONE
  CREDIT_CARD	
  HHL_CONFIRM 	
  HOTEL_PHONE 
  HTL_CLIENT_PREF
  HTL_PREF_SHT_DESC
  HTL_KEY	
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 
  PREF_NON
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY 	
  PROP_CODE
  PROP_NAME
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE
  ROLLPREF_KEY
  RSNCDE	
  SAVINGS	
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 	
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY
  XIN_DOW
  XOUT_DOW
  TAT_RAT
  TAT_SAV
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS
BY CHAIN_CODE 
ON TABLE HOLD AS REPHLD1 FORMAT FOCUS INDEX CHAIN_CODE
END
-RUN



DEFINE FILE HOTEL_CHAINS_WITH_SCALES
SCALE_DESC1/A20 = DECODE SCALE ('1' 'Luxury Chains Chains'
                               '2' 'Upper Upscale Chains'
                               '3' 'Upperscale Chains' 
                               '4' 'Midscale Chains'
                               '5' 'Economy Chains'
                               '6' 'Independent Hotels'
                               '7' 'Other'
                               ' ' 'Unidentified');

END
-RUN

TABLE FILE HOTEL_CHAINS_WITH_SCALES
SUM SCALE_DESC1
BY CHN_CD
ON TABLE HOLD AS SCALEHLD FORMAT FOCUS INDEX CHN_CD
END
-RUN


JOIN REPHLD1.CHAIN_CODE IN REPHLD1 TO SCALEHLD.CHN_CD IN SCALEHLD AS J4
-RUN

DEFINE FILE REPHLD1
HPHN/A10 = EDIT(HOTEL_PHONE, '9999999999');
SCALE_DESC/A20 = IF HPHN EQ '4029999999' THEN 'Unidentified' ELSE SCALE_DESC1;
END
TABLE FILE REPHLD1
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE 	
  CHAIN_NAME 	
  CITY_ST
  GEO_ZONE
  CREDIT_CARD	
  HHL_CONFIRM 	
  HOTEL_PHONE 	
  HTL_KEY	
  HTL_CLIENT_PREF
  HTL_PREF_SHT_DESC  
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 	
  PREF_NON
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY 	
  PROP_CODE
  PROP_NAME
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE	
  ROLLPREF_KEY
  RSNCDE	
  SAVINGS
  SCALE_DESC
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 	
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY
  XIN_DOW
  XOUT_DOW
  TAT_RAT
  TAT_SAV
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS
ON TABLE HOLD AS &&RPT_HOLD
END
-RUN



-GOTO SKIPHTC

-ABTOPHTC

-**********************************************************
DEFINE FILE &&EXTRACT
  CARD_NUM/A12 = EDIT(CREDIT_CARD, '$$999999999999$$$$');
  CARD1_NUM/A4 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$$$9999');
  CITY_ST/A35 = CITY.CITY_NAME||(' '| CITY.STATE_CODE);
  CITY_ST1/A35 = PROP_CITY||(' '| PROP_STATE);

  LEV_2/A15 = IF PASSNGR_NAME NE LAST PASSNGR_NAME THEN LEVEL2 ELSE ' ';
  LEVEL_DESC/A60  = &&LDESC;
  IN_DATE/MDYY = CHKIN_DATE;
  INV_DATE/MDYY = INVOICE_DATE;
  NEW_ROOM_RATE/D12.2C = ROOM_RATE;
  NEW_STD_RATE/D12.2C = STD_RATE;
  NEW_TOTAL_AMT/D12.2C = TOTAL_AMT;
  NBR_DAYS/D12 =  NUM_DAYS; 
  NNROOMS/D12 = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
  OUT_DATE/MDYY = CHKOUT_DATE;
  ONLINE/A1 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN 'Y' ELSE 'N';
  PROP_ZIP5/A5=EDIT(PROP_ZIP, '99999$$$$$');
  PREF_NON/A15 = IF CLIENT_PREF EQ 'C' OR 'P' OR 'N' OR 'M' OR 'L'  THEN 'PREFERRED' ELSE 'NON-PREFERRED';

-* RATE_GRP/A15 = IF ((ROOM_RATE GE 0 AND ROOM_RATE LT 150) OR
-*                      (ROOM_RATE LE 0 AND ROOM_RATE GT (-150)))
-*                  THEN '$0 - $149' ELSE
-*                  IF ((ROOM_RATE GE 150 AND ROOM_RATE LE 199) OR
-*                      (ROOM_RATE LE (-150) AND ROOM_RATE GE (-199)))
-*                  THEN '$150 - $199' ELSE
-*                  IF ((ROOM_RATE GE 200 AND ROOM_RATE LE 249) OR
-*                      (ROOM_RATE LE (-200) AND ROOM_RATE GE (-249)))
-*                  THEN '$200 - $249' ELSE '$250 OR GREATER';

 PRP_NAME/A25 = EDIT(PROP_NAME, '$$$$$$$$$$$$$$$$$$$$$$$$$');
 RATE_GRP/A15 = IF ((ROOM_RATE GE 0 AND ROOM_RATE LT 149.50) OR
                      (ROOM_RATE LE 0 AND ROOM_RATE GT (-149.50)))
                   THEN '$0 - $149' ELSE
                   IF ((ROOM_RATE GE 149.50 AND ROOM_RATE LT 199.50) OR
                      (ROOM_RATE LE (-149.50) AND ROOM_RATE GT (-199.50)))
                   THEN '$150 - $199' ELSE
                   IF ((ROOM_RATE GE 199.50 AND ROOM_RATE LT 249.50) OR
                      (ROOM_RATE LE (-199.50) AND ROOM_RATE GT (-249.50)))
                   THEN '$200 - $249' ELSE '$250 OR GREATER';


  REASON_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
  REFUSE_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
  RES_DT/MDY = RESV_DATE;
  RSNCDE/A48=REFUSE_CD|| '-' ||REFUSAL_DESC;
  MIR_SEQ1/A1 = EDIT(MIR_SEQ, '9$$$$$');
  RES_SYS/A1 = IF MIR_SEQ1 EQ 'X' THEN 'S' ELSE 'A';
  ROLLPREF_KEY/A9='&&ROLLUP.EVAL'|CLIENT_PREF;
  TRAN_MY/MYY = INVOICE_DATE;


-* ****DEFINES ON PREVIOUS DEFINES****

  TOTAL_STD/D12.2C = IF (NNROOMS LT 0) AND (NEW_STD_RATE LT 0) 
                     THEN ((NNROOMS * NEW_STD_RATE)*(-1))
                     ELSE NNROOMS * NEW_STD_RATE;
                     
  TOTAL_RR/D12.2C = IF (NNROOMS LT 0) AND (NEW_ROOM_RATE LT 0) THEN ((NNROOMS * NEW_ROOM_RATE)*(-1))
                     ELSE NNROOMS * NEW_ROOM_RATE;                  
                   

-* ***DEFINES ON PREVIOUS DEFINED DEFINES***
   BOOKINGS/D8 = IF NEW_TOTAL_AMT GE 0 THEN 1 ELSE (-1);
   SAVINGS/D12.2CS = TOTAL_STD - TOTAL_AMT;
   TOTAL_SLSAV/D12.2C = TOTAL_STD - NEW_TOTAL_AMT;
   XIN_DOW/WR = IN_DATE;
   XOUT_DOW/WR = OUT_DATE;
   PROP_CODE1/A7 = IF RES_SYS EQ 'S' THEN PROP_SABRE_CODE ELSE PROP_APOLLO_CODE;

END
-RUN

-**********************************************************
TABLE FILE &&EXTRACT
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE 	
  CHAIN_NAME 	
  CITY_ST
  CITY_ST1
  CITY.GEO_ZONE AS 'GEO_ZONE'
  CREDIT_CARD	
  HHL_CONFIRM 	
  HOTEL_PHONE 	
  HTL_KEY	
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 
  PROP_CODE1 AS 'PROP_CODE'
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  CITY.CITY_NAME AS 'PROP_CITY' 	
  PROP_NAME 
  CITY.STATE_CODE AS 'PROP_STATE_CD' 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH	
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE	
  RSNCDE	
  SAVINGS	
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  TOTAL_RR
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY
  XIN_DOW
  XOUT_DOW
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PREF_NON
BY ROLLPREF_KEY  
-INCLUDE &HTLDATES  
-* WHERE INVOICE_DATE GE &&FROMDT.EVAL AND INVOICE_DATE LE &&TODT.EVAL
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHOLD FORMAT FOCUS INDEX ROLLPREF_KEY
END
-RUN



TABLE FILE ROLLUP_HTL_CLIENT_PREF
PRINT HTL_PREF_DESC HTL_CLIENT_PREF HTL_PREF_SHT_DESC
BY ROLLPREF_KEY 
ON TABLE HOLD AS PREFHLD FORMAT FOCUS INDEX ROLLPREF_KEY
END
-RUN


JOIN ROLLPREF_KEY IN RPTHOLD TO ROLLPREF_KEY IN PREFHLD AS JP1
-RUN


-IF &&SETF EQ 'ABTPHTAT' GOTO TATRPT;


TABLE FILE RPTHOLD
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE
  CHAIN_NAME 	
  CITY_ST
  CITY_ST1
  CREDIT_CARD	
  GEO_ZONE
  HHL_CONFIRM 	
  HOTEL_PHONE 
  HTL_CLIENT_PREF
  HTL_PREF_SHT_DESC  
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 
  PROP_CODE
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY
  PROP_NAME 
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH	
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE
  ROLLPREF_KEY
  RSNCDE	
  SAVINGS	
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  TOTAL_RR
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY
  XIN_DOW
  XOUT_DOW
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PREF_NON
BY HTL_KEY
ON TABLE HOLD AS RPT_HLDA 
END
-RUN
-GOTO NOTAT;

-TATRPT;

-INCLUDE RETUDID
-RUN

TABLE FILE RPTHOLD
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE
  CHAIN_NAME 	
  CITY_ST
  CITY_ST1
  CREDIT_CARD
  GEO_ZONE
  HHL_CONFIRM 	
  HOTEL_PHONE 	
  HTL_PREF_SHT_DESC  
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 
  PROP_CODE
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY
  PROP_NAME 
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH	
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE	
  ROLLPREF_KEY
  RSNCDE	
  SAVINGS	
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  TOTAL_RR
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY
  XIN_DOW
  XOUT_DOW
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PREF_NON
BY HTL_KEY
ON TABLE HOLD AS RPT_HLDAAA 
END
-RUN

-IF &RECORDS EQ 0 GOTO SKIPHTC;



TABLE FILE RPTHOLD
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE
  CHAIN_NAME 	
  CITY_ST
  CITY_ST1
  CREDIT_CARD
  GEO_ZONE
  HHL_CONFIRM 	
  HOTEL_PHONE 	
  HTL_PREF_SHT_DESC  
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 
  PROP_CODE
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY
  PROP_NAME 
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH	
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE	
  ROLLPREF_KEY
  RSNCDE	
  SAVINGS	
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  TOTAL_RR
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY
  XIN_DOW
  XOUT_DOW
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PREF_NON
BY HTL_KEY
ON TABLE HOLD AS RPT_HLDA1 
END
-RUN

TABLE FILE UDIDHOLD
SUM TAT AS 'TAT_RT'
BY HTL_KEY
ON TABLE HOLD AS UDIDHOLD2 
END
-RUN

-IF &RECORDS EQ 0 GOTO NOUDDEF;

MATCH FILE RPT_HLDA1
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE
  CHAIN_NAME 	
  CITY_ST
  CITY_ST1
  CREDIT_CARD	
  GEO_ZONE
  HHL_CONFIRM 	
  HOTEL_PHONE 
  HTL_PREF_SHT_DESC  
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 
  PROP_CODE
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY
  PROP_NAME 
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH	
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE	
  ROLLPREF_KEY
  RSNCDE	
  SAVINGS	
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  TOTAL_RR
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY
  XIN_DOW
  XOUT_DOW
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PREF_NON
BY HTL_KEY
ON TABLE HOLD
RUN
FILE UDIDHOLD2
SUM TAT_RT
BY HTL_KEY
AFTER MATCH HOLD AS RPT_HLDAA OLD-AND-NEW
END
-RUN

DEFINE FILE RPT_HLDAA
TAT_RAT/D12.2C = IF (NNROOMS LT 0) AND (TAT_RT LT 0) THEN ((NNROOMS * TAT_RT)*(-1)) ELSE NNROOMS * TAT_RT;  
TAT_SAV/D12.2CS = IF TOTAL_RR EQ 0 THEN 0 ELSE
                  IF TAT_RAT EQ 0 THEN 0 ELSE TAT_RAT - TOTAL_RR;
END
-RUN

TABLE FILE RPT_HLDAA
SUM TAT_RAT TAT_SAV 
BY HTL_KEY
WHERE TAT_SAV NE 0
ON TABLE HOLD AS RPT_HTAT
END
-RUN

MATCH FILE RPT_HTAT
SUM TAT_RAT TAT_SAV
BY HTL_KEY
ON TABLE HOLD
RUN
FILE RPT_HLDAA
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE 	
  CHAIN_NAME 	
  CITY_ST
  CITY_ST1
  CREDIT_CARD	
  GEO_ZONE
  HHL_CONFIRM 	
  HOTEL_PHONE 	
  HTL_KEY
  HTL_PREF_SHT_DESC   
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 
  PROP_CODE
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY
  PROP_NAME 
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH	
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE
  ROLLPREF_KEY
  RSNCDE	
  SAVINGS	
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  TOTAL_RR
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY
  XIN_DOW
  XOUT_DOW
  TAT_RAT
  TAT_SAV
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PREF_NON
BY HTL_KEY
AFTER MATCH HOLD AS RPT_HLDA OLD
END
-RUN


-GOTO RPTCONT1;

-NOTAT;
-NOUDDEF;
DEFINE FILE RPT_HLDA
TAT_RAT/D12.2 = 0;
TAT_SAV/D12.2 = 0;
END
-RUN

-RPTCONT1;
TABLE FILE RPT_HLDA
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
-*   CHAIN_CODE 	
  CHAIN_NAME 	
  CITY_ST
  CITY_ST1
  CREDIT_CARD
  GEO_ZONE
  HHL_CONFIRM 	
  HOTEL_PHONE 	
  HTL_KEY
  HTL_PREF_SHT_DESC   
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 
  PROP_CODE
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY
  PROP_NAME 
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH	
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE	
  ROLLPREF_KEY
  RSNCDE	
  SAVINGS	
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 	
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY
  XIN_DOW
  XOUT_DOW
  TAT_RAT
  TAT_SAV
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PREF_NON
BY CHAIN_CODE
ON TABLE HOLD AS REPHLD1 FORMAT FOCUS INDEX CHAIN_CODE
END
-RUN


DEFINE FILE HOTEL_CHAINS_WITH_SCALES
-* HPHN/A10 = EDIT(HOTEL_PHONE, '9999999999');
SCALE_DESC/A20 = DECODE SCALE ('1' 'Luxury Chains Chains'
                               '2' 'Upper Upscale Chains'
                               '3' 'Upperscale Chains' 
                               '4' 'Midscale Chains'
                               '5' 'Economy Chains'
                               '6' 'Independent Hotels'
                               '7' 'Other'
                               ' ' 'Unidentified');
-* SCALE_DESC/A20 = IF HPHN EQ '4029999999' THEN 'Unidentified' ELSE SCALE_DESC1;                               
END
-RUN
TABLE FILE HOTEL_CHAINS_WITH_SCALES
SUM SCALE_DESC
BY CHN_CD
ON TABLE HOLD AS SCALEHLD FORMAT FOCUS INDEX CHN_CD
END
-RUN


JOIN REPHLD1.CHAIN_CODE IN REPHLD1 TO SCALEHLD.CHN_CD IN SCALEHLD AS J2
-RUN

TABLEF FILE REPHLD1
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE 	
  CHAIN_NAME 	
  CITY_ST
  CITY_ST1
  CREDIT_CARD
  GEO_ZONE
  HHL_CONFIRM 	
  HOTEL_PHONE 	
  HTL_KEY	
  HTL_PREF_SHT_DESC    
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 	
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT
  NBR_DAYS	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 
  PROP_CODE
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  PROP_ADDRESS 	
  PROP_CITY
  PROP_NAME 
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH	
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE	
  ROLLPREF_KEY
  RSNCDE	
  SAVINGS
  SCALE_DESC
  STD_RATE 	
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 	
  TOTAL_STD 	
  TOTAL_SLSAV
  TRAN_MY
  XIN_DOW
  XOUT_DOW
  TAT_SAV
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS  
  PREF_NON
ON TABLE HOLD AS &&RPT_HOLD
END
-RUN




-SKIPHTC

-*-EXIT

