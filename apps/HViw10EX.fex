-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File HVIW10
-********************************************************************
-* MODIFICAIONS:
-* JK 11/20/03  Added prop_city field for drilldown per Robin
-* JK 03/23/04  Due to market file format update had to add an extra
-*              space in the city_st define
-* DV 4/20/04   CHANGED PREF_NON DEFINE TO INCLUDE REFUSE_CD 'T'
-* DV 5/12/04   CHANGED PREF_NON DEFINE TO INCLUDE REFUSE_CD 'CC'
-* DV 7/13/05   CHANGED PREF_NON DEFINE TO INCLUDE REFUSE_CD 'R' 
-*              AND REMOVED REFUSE_CD 'CC'
-* DV 11/4/10   CHANGED PREF_NON DEFINE TO USE CLIENT_PREF
-* 1/7/13 DV CHANGED PREF_NON DEFINE TO INCLUDE CLIENT_PREF C OR P
-* Joy Updated Pref_Non define to contain C/P/N/M/L
-* Joy Tested with the kiewit htlmkt file 4/9/14
-* 9/9/14 Updated Pref_non define to use exclude_flags - jk
-* 9/25/14 Updated to use exclude flags in % - JK


-********************************************************************
-*
-* This program extracts data for the Metlife preferred/non-preferred
-* hotel summary for specific cities and groups them into markets
-* 
-*
-*DATE       NAME          DESCRIPTION

-********************************************************************

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-INCLUDE SETECHO

-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';

TABLE FILE CONTROL
PRINT SECURITY_LEVEL
BY ROLLUP_CODE
ON TABLE SAVE AS XROLL
END
-RUN
-READ XROLL &&RLUP.A8.


DEFINE FILE &&EXTRACT

  CITY_ST/A40 = PROP_STATE||(' '|' '|PROP_CITY);
  -* PST/A2 = EDIT(PROP_STATE_CD, '99');
  
  CITY_ST1/A42 = PROP_STATE||PROP_CITY;
  
  FLAG/A1 = 'A';
  IN_DATE/MDYY = CHKIN_DATE;
  LEVEL_DESC/A60  = &&LDESC;
  NBR_DAYS/D12 =  NUM_DAYS;
  NBR_ROOMS/D12 = NUM_ROOMS;
  NEW_ROOM_RATE/D25.2C = ROOM_RATE;
  NEW_STD_RATE/D25.2C = STD_RATE;
  NEW_TOTAL_AMT/D25.2C = TOTAL_AMT;
  NNROOMS/D12 = IF ((NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)) THEN 
                ((NBR_DAYS*NUM_ROOMS) * (-1)) ELSE NBR_DAYS*NUM_ROOMS;
  OUT_DATE/MDYY = CHKOUT_DATE;
  REFUSE_CD/A2 = EDIT(REFUSE_KEY,'$$$$$$$$99');
  
  
-* ****DEFINES ON PREVIOUS DEFINES****
   BOOKINGS/D8 = IF NEW_ROOM_RATE GE 0 THEN 1 ELSE (-1);
-*    PREF_NON/A15 = IF REFUSE_CD EQ 'A' OR 'T' OR 'R' THEN 'PREFERRED'
-*                      ELSE 'NON-PREFERRED';               
-*  PREF_NON/A15 = IF HTL_REF.PREFERRED EQ 'Y' THEN 'PREFERRED' ELSE 'NON-PREFERRED';

-*  PREF_NON/A15 = IF CLIENT_PREF EQ 'C' OR 'P' OR 'N' OR 'M' OR 'L' THEN 'PREFERRED' ELSE 'NON-PREFERRED';
 PNP_FLAG/A1 = EDIT(EXCLUDE_FLAGS, '$9');
 PNP_IE/A1 = EDIT(EXCLUDE_FLAGS, '$$9');
  
 PREF_NON/A15 = IF PNP_FLAG EQ 'I'  THEN 'PREFERRED' ELSE 'NON-PREFERRED';
 
   TOTAL_STD/D25.2C = IF ((NNROOMS LT 0) AND (NEW_STD_RATE LT 0))
                      THEN ((NNROOMS * NEW_STD_RATE) * (-1))
                      ELSE NNROOMS * NEW_STD_RATE;
 
-* ****DEFINES ON PREVIOUS DEFINED DEFINES***
   NPREF_AMT/D25.2 = IF PREF_NON EQ 'NON-PREFERRED' THEN TOTAL_AMT ELSE 0;
   NPREF_NGT/D12 = IF PREF_NON EQ 'NON-PREFERRED' THEN NNROOMS ELSE 0;
   PREF_AMT/D25.2 = IF PREF_NON EQ 'PREFERRED' THEN TOTAL_AMT ELSE 0;
   PREF_NGT/D12 = IF PREF_NON EQ 'PREFERRED' THEN NNROOMS ELSE 0;
   TOTAL_SLSAV/D25.2C = TOTAL_STD - NEW_TOTAL_AMT;
   TTL_NGT/D12 = NPREF_NGT + PREF_NGT;
  NNROOMSPN/P12CS = IF PNP_FLAG EQ 'I' AND PNP_IE EQ 'I' THEN NNROOMS ELSE 
                   IF PNP_FLAG EQ 'E' AND PNP_IE EQ 'I' THEN NNROOMS ELSE 0;    
      
  NNROOMS3/P12CS = IF PNP_IE EQ 'I' THEN NNROOMS ELSE 0;  
END
-RUN

TABLEF FILE &&EXTRACT
PRINT BOOKINGS	
  CITY_ST
  CITY_ST1
  HOTEL_PHONE
  IN_DATE
  INVOICE_NUM
  FLAG
  LEVEL_DESC	
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS
  NNROOMSPN
  NNROOMS3
  NPREF_AMT
  NPREF_NGT
  OUT_DATE
  PASSNGR_NAME
  PNR_LOCATOR
  PREF_AMT
  PREF_NGT
  PREF_NON
  PROP_ADDRESS
  PROP_CITY
  PROP_NAME
  PROP_STATE
  REFUSE_CD
  TOTAL_AMT 	
  TOTAL_SLSAV
  TOTAL_STD 	
  TTL_NGT
-INCLUDE &HTLDATES 
-IF &&SETF EQ 'KWHPNPAX' THEN GOTO KWSEL ELSE GOTO NOKW;
-KWSEL;
-* WHERE PASSNGR_NAME CONTAINS 'HAZEN/D' OR 'INIGUEZ/J' OR 'MAGEE/W' OR 'KIMBALL/R' OR 'STANTON/F' OR
-* 'CONSTABLE/T' OR 'GROVES/V' OR 'ADAM/P' OR 'CLOUTIER/J' OR 'LOGUE/S' OR 'TINANT/W'  OR 'WINGERTER/J' OR
-* 'DUPUIS/P' OR 'NORTHCUTT/R' OR 'SODERBERG/P' OR 'LUMMA/D' OR 'WESTERHEID/P' OR 'WISE/J' OR 'LAAKER/B' OR 'NELSON/M'
-INCLUDE KWSELECT

-NOKW;
-* WHERE INVOICE_DATE GE &&FROMDT.EVAL AND INVOICE_DATE LE &&TODT.EVAL
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS HHOLD
END
-RUN

-IF &&ROLLUP EQ 'KIEWIT-R' GOTO NWMKT;

TABLE FILE HHOLD
PRINT BOOKINGS	
  HOTEL_PHONE
  IN_DATE
  INVOICE_NUM
  FLAG
  LEVEL_DESC	
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS
  NNROOMSPN
  NNROOMS3
  NPREF_AMT
  NPREF_NGT
  OUT_DATE
  PASSNGR_NAME
  PREF_AMT
  PREF_NGT
  PREF_NON
  PROP_ADDRESS
  PROP_CITY
  PROP_NAME
  PROP_STATE
  REFUSE_CD
  TOTAL_AMT 	
  TOTAL_SLSAV
  TOTAL_STD 	
  TTL_NGT
-* BY CITY_ST1
BY CITY_ST
ON TABLE HOLD AS HHOLD2 FORMAT FOCUS INDEX CITY_ST
END
-RUN


DEFINE FILE METXHTL
HTL_MKT/A130 = IF H_MARKET NE ' ' THEN H_MARKET ELSE ST_CITY;
END

TABLE FILE METXHTL
PRINT HTL_MKT 
BY ST_CITY 
WHERE ROLLUP_CODE EQ '&&RLUP'
ON TABLE HOLD AS METXH2 FORMAT FOCUS INDEX ST_CITY
END
-RUN

JOIN ST_CITY IN METXH2 TO ALL CITY_ST IN HHOLD2 AS J2
-RUN

TABLE FILE METXH2
PRINT BOOKINGS	
  CITY_ST
  IN_DATE
  INVOICE_NUM
  FLAG
  LEVEL_DESC	
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS
  NNROOMSPN
  NNROOMS3
  NPREF_AMT
  NPREF_NGT
  OUT_DATE
  PASSNGR_NAME
  PREF_AMT
  PREF_NGT
  PREF_NON
  PROP_ADDRESS
  PROP_CITY
  PROP_NAME
  REFUSE_CD
  ST_CITY
  TOTAL_AMT 	
  TOTAL_SLSAV
  TOTAL_STD 	
  TTL_NGT
BY HTL_MKT
BY ST_CITY
BY CITY_ST
ON TABLE HOLD AS HHOLD5
END
-RUN

DEFINE FILE HHOLD5
HTL_MKT1/A40 = EDIT(HTL_MKT, '9999999999999999999999999999999999999999');
END
-RUN
TABLE FILE HHOLD5
PRINT BOOKINGS	
  CITY_ST
  IN_DATE
  INVOICE_NUM
  FLAG
  LEVEL_DESC	
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS
  NNROOMSPN
  NNROOMS3
  NPREF_AMT
  NPREF_NGT
  OUT_DATE
  PASSNGR_NAME
  PROP_CITY
  PREF_AMT
  PREF_NGT
  PREF_NON
  PROP_ADDRESS
  PROP_NAME
  REFUSE_CD
  ST_CITY
  TOTAL_AMT 	
  TOTAL_SLSAV
  TOTAL_STD 	
  TTL_NGT
BY HTL_MKT
BY HTL_MKT1
WHERE CITY_ST NE ' '
ON TABLE HOLD AS &&RPT_HOLD
END
-RUN

-GOTO XXIT;

-******************************************************************************
-NWMKT;
-RUN
-******************************************************************************
DEFINE FILE HHOLD
STATE/A2 = EDIT(PROP_STATE, '99');
CITY/A40 = PROP_CITY;
ST_CITY/A42 = STATE||CITY;
END
TABLE FILE HHOLD
PRINT BOOKINGS	
  CITY_ST1
  CITY_ST
  HOTEL_PHONE
  IN_DATE
  INVOICE_NUM
  FLAG
  LEVEL_DESC	
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS
  NNROOMSPN
  NNROOMS3
  NPREF_AMT
  NPREF_NGT
  OUT_DATE
  PASSNGR_NAME
  PNR_LOCATOR
  PREF_AMT
  PREF_NGT
  PREF_NON
  PROP_ADDRESS
  PROP_CITY
  PROP_NAME
  PROP_STATE
  REFUSE_CD
  TOTAL_AMT 	
  TOTAL_SLSAV
  TOTAL_STD 	
  TTL_NGT
BY ST_CITY  
ON TABLE HOLD AS HHOLD2 FORMAT FOCUS INDEX ST_CITY
END
-RUN

DEFINE FILE HTLMKT
HTL_MKT/A130 = IF H_MARKET NE ' ' THEN H_MARKET ELSE CITY;
ST_CITY/A42 = STATE||CITY;
STC/A6 = EDIT(ST_CITY, '999999');
END
TABLE FILE HTLMKT
PRINT HTL_MKT  
BY ST_CITY 
WHERE ROLLUP_CODE EQ '&&RLUP'
ON TABLE HOLD AS PRFHLD FORMAT FOCUS INDEX ST_CITY
END
-RUN

JOIN PRFHLD.ST_CITY IN PRFHLD TO ALL HHOLD2.ST_CITY IN HHOLD2 AS J2
-RUN


TABLE FILE PRFHLD
PRINT BOOKINGS	
  CITY_ST
  IN_DATE
  INVOICE_NUM
  FLAG
  LEVEL_DESC	
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS
  NNROOMSPN
  NNROOMS3
  NPREF_AMT
  NPREF_NGT
  OUT_DATE
  PASSNGR_NAME
  PREF_AMT
  PREF_NGT
  PREF_NON
  PROP_ADDRESS
  PROP_CITY
  PROP_NAME
  REFUSE_CD
  ST_CITY
  TOTAL_AMT 	
  TOTAL_SLSAV
  TOTAL_STD 	
  TTL_NGT
BY HTL_MKT
BY ST_CITY
BY CITY_ST1
ON TABLE HOLD AS HHOLD5
END
-RUN

DEFINE FILE HHOLD5
HTL_MKT1/A40 = EDIT(HTL_MKT, '9999999999999999999999999999999999999999');
END
-RUN
TABLE FILE HHOLD5
PRINT BOOKINGS	
  CITY_ST
  IN_DATE
  INVOICE_NUM
  FLAG
  LEVEL_DESC	
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS
  NNROOMSPN
  NNROOMS3
  NPREF_AMT
  NPREF_NGT
  OUT_DATE
  PASSNGR_NAME
  PROP_CITY
  PREF_AMT
  PREF_NGT
  PREF_NON
  PROP_ADDRESS
  PROP_NAME
  REFUSE_CD
  ST_CITY
  TOTAL_AMT 	
  TOTAL_SLSAV
  TOTAL_STD 	
  TTL_NGT
BY HTL_MKT
BY HTL_MKT1
WHERE CITY_ST1 NE ' '
ON TABLE HOLD AS &&RPT_HOLD
END
-RUN



-XXIT;




