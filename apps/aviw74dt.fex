
-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-********************************************************************
-* Modifications:
-* 6/28/02 - CARRIED THROUGH NEW_SEG_AMT AND NET_COMM - DB 
-*07/03/02   STEVE              CHANGED TO eTTek Review and Copyright
-*6/13/03    DEB                ADDED SUM OF NEW_SEG_AMT
-*8/15/03    DEB                CARRIED THROUGH AGENT_NUM
-*9/25/03    DEB     CARRIED THROUGHT SEG_COUNT EMB_APT_NM RTE_APT_NM
-*11/26/03   DEB     CARRIED THROUGH CGBOOK
-*12/31/03   DEB     CARRIED THROUGH LEVEL3
-*1/12/04     JOY     CARRIED THROUGH MILEAGE/SEG_MILES
-*1/15/04    DEB     CARRIED THROUGH TOT_TNT_FEE
-*1/21/04    DEB     CARRIED THROUGH BR_CL_IDX
-*2/10/04   DEB      CARRIED THROUGH DFARE DTKT_CNT IFARE ITKT_CNT
-*                   TRAN_MY INTL_DOM 
-* 2/23/04  JK       CARRIED THROUGH LEVEL1
-* 2/23/04  JK       CARRIED THROUGH AROLL_LEV4
-* 5/04/04  DV       CARRIED THROUGH AL_TKTNUM TOUR_CODE
-* 7/22/04  JK       CARRIED THROUGH EMB_CNTRY_CODE
-* 08/23/04 DV       CARRIED THROUGH FLIGHT
-*11/11/04  DV       ADDED CODE FOR GLOBAL CURRENCY
-*6/14/04   DV       CARRIED THROUGH ORG_APC DST_APC
-*10/03/05  DV       ADDED SUMMATION OF NEW_SEG_MILES
-*5/23/14   DV       UPDATED RADV_PURCH DEFINE TO INCLUDE EX5
-*07/08/14  DV       CARRIED THROUGH DISSAVINGS 
-*12/10/15 - JEM - S-13286 Updated to allow reports to sort/subtotal by id-levels
-* 08/04/2017 - JEM - S-37368 Updated LOW_AMT field to use SRT_DT instead of TKT_SORT

-********************************************************************
SET ASNAMES=ON
-RUN

-IF &&CURRENCY EQ 'USD' THEN GOTO NEXT;
-SET &&SUBHEAD = <NAMEC;
-SET &FPAID_CUR = 'FARE,PAID, (' | &&CURRENCY || ')';
-SET &&PRINT6='PAID_FAREX/D16.2CS AS ' | '''&FPAID_CUR.EVAL''';




-NEXT;



TABLE FILE AIRCLS
SUM FARE_PAID AS 'TFARE'
    PAID_FAREX/D16.2CS AS 'GTFARE'
    MRK_TKT_CNT AS 'TMKT'
    NET_COMM AS 'NCOMM'
    NEW_SEG_AMT AS 'TBASE'
    NEW_SEGAX/D16.2CS AS 'GTBASE'
    SEG_COM AS 'TSCOM'
    NEW_SEG_MILES/D9CS AS 'TMILE'
    DISSAVINGS AS 'DTSAVE'
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS AIRHOLD1
END
-RUN

TABLE FILE AIRCLS
PRINT
  AGENT_NUM
  AIR_KEY	
  AIRLINE	
  AIRLINE_NAME
  AL_TKTNUM
  AROLL_LEV4
  BR_CL_IDX
  CGBOOK	
  CL_CAT	
  CLASS	
  CLASS_CAT
  DFARE	
  DISSAVINGS
  DOC_TYPE
  DPT_TIME
  DST_APC
  DTKT_CNT
  EMB_APT_CD
  EMB_APT_NM	
  EMB_CTY_NM
  EMB_CNTRY_CODE
  FARE_BAS
  FARE_PAID
  FLIGHT
  IFARE
  INTL_DOM
  ITKT_CNT
  LEVEL_DESC
  LEVEL1
  LEVEL3
  MFNH
  MRK_TKT_CNT
  MILEAGE
  NAMEC
  NET_COMM
  NET_TKT_CNT
  NEW_ADV_PURCH
  NEW_SEG_AMT
  NEW_SEGAX/D16.2CS
  NEW_SEG_MILES
  ORG_APC
  PAID_FAREX/D16.2CS
  PASSNGR_NAME
  REFUSE_CODE
  RTE_APT_NM	
  RTE_CTY_NM
  SEG_COUNT
  SEG_MILES
  SEG_NBR
  TOT_TNT_FEE
  TOUR_CODE
  TKT_NUM	
  TKT_SORT
  TKT_TYPE
  TRAN_MONTH
  TRAN_MY	
  TRN_DATE	
  UPFARE
  XDPT_DT
  XFST_DPT
  XPSNGR_NM
  XTRAN_DT	
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
BY SEG_NBR
ON TABLE HOLD AS XTWO
END
-RUN


MATCH FILE XTWO
PRINT
  AGENT_NUM
  AIR_KEY	
  AIRLINE	
  AIRLINE_NAME
  AL_TKTNUM
  AROLL_LEV4
  BR_CL_IDX
  CGBOOK	
  CL_CAT	
  CLASS	
  CLASS_CAT
  DFARE
  DISSAVINGS
  DOC_TYPE
  DST_APC
  DPT_TIME
  DTKT_CNT
  EMB_APT_CD
  EMB_APT_NM	
  EMB_CTY_NM
  EMB_CNTRY_CODE
  FARE_BAS
  FARE_PAID
  FLIGHT
  IFARE
  INTL_DOM
  ITKT_CNT
  LEVEL_DESC
  LEVEL1
  LEVEL3
  MFNH
  MILEAGE
  MRK_TKT_CNT
  NAMEC
  NET_COMM
  NET_TKT_CNT
  NEW_ADV_PURCH
  NEW_SEG_AMT
  NEW_SEGAX
  NEW_SEG_MILES
  ORG_APC
  PAID_FAREX
  PASSNGR_NAME
  REFUSE_CODE
  RTE_APT_NM	
  RTE_CTY_NM
  SEG_COUNT
  SEG_MILES
  SEG_NBR
  TOT_TNT_FEE
  TOUR_CODE	
  TKT_NUM	
  TKT_SORT
  TKT_TYPE
  TRAN_MONTH
  TRAN_MY	
  TRN_DATE	
  UPFARE
  XDPT_DT
  XFST_DPT
  XPSNGR_NM
  XTRAN_DT	
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
BY SEG_NBR
ON TABLE HOLD
RUN
FILE AIRHOLD1
PRINT TBASE     
      TFARE
      TMKT
      NCOMM
      TSCOM
      GTBASE
      GTFARE
      TMILE
      DTSAVE
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
AFTER MATCH HOLD AS AIRHOLD2 OLD-OR-NEW
END
-RUN

TABLE FILE AIRHOLD2
PRINT
  AGENT_NUM
  AIR_KEY	
  AIRLINE	
  AIRLINE_NAME
  AL_TKTNUM
  AROLL_LEV4
  BR_CL_IDX
  CGBOOK	
  CL_CAT	
  CLASS	
  CLASS_CAT
  DFARE	
  DISSAVINGS
  DOC_TYPE
  DST_APC
  DPT_TIME
  DTKT_CNT
  DTSAVE
  EMB_APT_CD
  EMB_APT_NM	
  EMB_CTY_NM
  EMB_CNTRY_CODE
  FARE_BAS
  FARE_PAID
  FLIGHT
  GTFARE
  GTBASE
  IFARE
  INTL_DOM
  ITKT_CNT
  LEVEL_DESC
  LEVEL1
  LEVEL3
  MFNH
  MILEAGE	
  MRK_TKT_CNT
  NAMEC
  NCOMM
  NET_COMM
  NET_TKT_CNT
  NEW_ADV_PURCH
  NEW_SEG_AMT
  NEW_SEGAX 
  NEW_SEG_MILES
  ORG_APC
  PASSNGR_NAME
  PAID_FAREX
  REFUSE_CODE
  RTE_APT_NM	
  RTE_CTY_NM
  SEG_COUNT
  SEG_MILES
  SEG_NBR
  TBASE
  TFARE
  TOUR_CODE
  TKT_NUM	
  TKT_SORT
  TKT_TYPE
  TMILE
  TMKT
  TOT_TNT_FEE
  TRAN_MONTH
  TRAN_MY
  TRN_DATE
  TSCOM	
  UPFARE
  XDPT_DT
  XFST_DPT
  XPSNGR_NM
  XTRAN_DT	
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD3
END
-RUN
 
DEFINE FILE AIRHOLD3
TICKET_NMBR/A10 = IF TKT_NUM NE LAST TKT_NUM THEN TKT_NUM ELSE ' ';
-* AL_TKTNUM/A14 = IF AL_TKTNUM NE LAST AL_TKTNUM THEN AL_TKTNUM ELSE ' ';
RREFUSE_CODE/A2 = IF TKT_SORT NE LAST TKT_SORT THEN REFUSE_CODE ELSE ' ';
XT_DTE/A8 = EDIT(TRN_DATE);
XTKT_SRT/A10 = EDIT(TKT_SORT,'9999999999$');
TOT_TFEE/D9.2CS =  IF (TKT_TYPE EQ 'F-EX' OR 'P-EX' OR 'F-RF' OR 'P-RF')
                   THEN 0 ELSE IF (SEG_NBR EQ '01') THEN TOT_TNT_FEE ELSE 0;
XFSTDPT/MDYY = IF DOC_TYPE EQ '1' THEN XTRAN_DT ELSE XFST_DPT;                   
-* ****DEFINES ON PREVIOUS DEFINES****
SRT_DT/A120 = TKT_SORT||XT_DTE||LEVEL_DESC||XPSNGR_NM;
FARE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TFARE ELSE 0;
GFARE_AMT/D16.2CS = IF SRT_DT NE LAST SRT_DT THEN GTFARE ELSE 0;
BASE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TBASE ELSE 0;
GBASE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN GTBASE ELSE 0;
MKT_CNT/D8CS     = IF SRT_DT NE LAST SRT_DT THEN TMKT ELSE 0;
NCOM_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN NCOMM ELSE 0;
COM_AMT/D12.2CS =  IF SRT_DT NE LAST SRT_DT THEN TSCOM ELSE 0;
TOTAL_MILES/D8CS = IF TKT_SORT NE LAST TKT_SORT THEN TMILE ELSE 0;
RADV_PURCH/I8CS = IF (EMB_APT_CD EQ 'FP2' OR 'EX1' OR 'RF1' OR 'EX5') THEN 0 ELSE
                  IF (TKT_TYPE EQ 'P-RF' OR 'P-EX') THEN 0 ELSE 
                  IF (SEG_NBR EQ '00') THEN 0 ELSE         
                 IF (TKT_SORT NE LAST TKT_SORT) AND 
                    (FARE_AMT GE 0) THEN NEW_ADV_PURCH ELSE
                 IF (TKT_SORT NE LAST TKT_SORT) AND
                    (FARE_AMT LT 0) THEN NEW_ADV_PURCH * (-1) ELSE 0;   
LOST_SAV_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN DTSAVE ELSE 0;
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*7/31/00     IBISTL-KR             ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERDT
-**************************************************************************
NOWTOD/A8 WITH TKT_SORT = HHMMSS (NOWTOD);
XTS_FLAG/A1 = ' ';

END

-IF &&DRILLED_RUN EQ 'N' GOTO SKIP_DRIL;
-************************************************************
-* INCLUDE PROGRAM TO GEN WHERE STATEMENTS
-************************************************************
-SET &&DRILLRPT = 'AIRHOLD3';
-INCLUDE DRILWHRS
-************************************************************
-SKIP_DRIL

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADAIR' ELSE 'HDREXLS'; 
-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'DTEXL' ELSE &&DTSTY;
-RUN

TABLE FILE AIRHOLD3
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
-*
-**********************************************************************
-* Print statement with fields passed from the user profile database
-**********************************************************************
-*
&&PRINT1
&&PRINT2
&&PRINT3
&&PRINT4
&&PRINT5
&&PRINT6
&&PRINT7
&&PRINT8
&&PRINT9
&&PRINT10
-*
-**********************************************************************
-* By statements (one per field)
-**********************************************************************
-*
&&BY1
&&BY2
&&BY3
&&BY4
&&BY5
&&BY6
&&BY7
&&BY8
&&BY9
&&BY10
-*
-*********************************************************************
-*DATE           NAME               DESCRIPTION 
-*8/18/00      IBISTL-KR            INCLUDE WHERE STATEMENTS WHEN
-*                                  DRILLED_RUN EQ 'Y'.
-*********************************************************************
-*
-**********************************************************************
-* Where statements for Drilled Report
-**********************************************************************
-*
-IF &&DRILLED_RUN EQ 'N' GOTO SKIP_WHR;
-INCLUDE &&DRILLWHR
-SKIP_WHR
-*
-**********************************************************************
-* On Table statements for code appropriate to On Table commands
-**********************************************************************
-*
&&BREAKOPTION
&&ONTABLE1
&&ONTABLE2
&&ONTABLE3
&&ONTABLE4
&&ONTABLE5
&&ONTABLE6
&&ONTABLE7
&&ONTABLE8
&&ONTABLE9
&&ONTABLE10
-*
-**********************************************************************
-* Report specific footer(s)
-**********************************************************************
-*
-INCLUDE FOOTERDT
-*
-*ON TABLE SET STYLE &&DTSTY
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**************************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT 

ON TABLE SET STYLE *
-INCLUDE &&PASTYD
ENDSTYLE
-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN
