-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File TKTCAR.FEX
-********************************************************************
-* MODIFICAIONS:
-********************************************************************
-*
-* This program extracts data for the series of basic car verndor listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-* 5/18/04 - DEB - ADDED AIRLINE_FEE COLUMN PER MONICA COLLIGAN
-* 10/05/04 - jk no changes...just testing by stopping the program
-* 10/08/04 - DV - ADDED LEVEL1 LEVEL2 LEVEL3
-* 12/15/04 - DV - ADDED FILEDEF CODE FOR FUJI REPORT
-* 01/04/05 - DV - ADDED CODE FOR GLOBAL CURRENCY
-* 10/10/05 - DV - ADDED GEO_ZONE
-*4/24/2017-JEM-S-33318-updated logic for no records report

-********************************************************************
-INCLUDE SETECHO 
SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-SET &CARDATES = &&WEB_PATH || 'CARDATES.fex';

DEFINE FILE &&EXTRACT
  BLANK4/A4 ='    ';
  BLANK3/D12.2CS= IF CAR_MAIN.CONTRACT_RATE GT 0 THEN 0 ELSE 0;
  BLANK/A4 = '    ';
  BLANK2/A11 = '           ';  
  LEVEL_DESC/A60 = &&LDESC;
  SEG/A2 = '  ';
  DROP_OFF_DT/MDYY = DROP_DATE;	
  INV_DATE/MDYY = INVOICE_DATE;
  NBR_DAYS/D12 = NUM_DAYS;
  NEW_RENTAL_AMT/D12.2CS = RENTAL_AMT;
  PICK_UP_DT/MDYY = PICKUP_DATE;
  RENTAL_DAYS/D12 = IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                   ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;
  VENDR_NM/A30 = VENDOR_NAME;
  TRIP_PURPOSE/A2 = ' ';
  
-* ****DEFINES ON PREVIOUS DEFINES****


 
END
-RUN

TABLEF FILE &&EXTRACT
PRINT CAR_KEY
  BLANK AS 'TYPE'
  CURR_DATE
  DROP_CTY.CITY_NAME AS 'CITY2'  
  INV_DATE AS 'TRAN_DATE'
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NEW_RENTAL_AMT
  PASSNGR_NAME
  PICK_CTY.CITY_NAME AS 'CITY1'
  PICK_UP_DT AS 'DATE'
  PNR_LOCATOR
  RENTAL_DAYS AS 'TTL_COUNT'
  TKT_NUM
  VENDR_NM AS 'NAME'

-INCLUDE &CARDATES
-********************************************************************
-* Where statements to select data specified in user profile
-* *******************************************************************
-* &&WHERE1
-* &&WHERE2
-* &&WHERE3
-* &&WHERE4
-* &&WHERE5
-* &&WHERE6
 &&WHERE7
 &&WHERE8
-* &&WHERE9
-* &&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS CARHOLD
END
-RUN

-IF &LINES EQ 0 THEN GOTO NOCAR;

-INCLUDE EUR_CLVL 
-RUN
 
TABLE FILE CARHOLD
SUM  
  TYPE
  CITY2  
  TRAN_DATE
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NEW_RENTAL_AMT AS 'AMOUNT'
  PASSNGR_NAME
  CITY1
  DATE
  PNR_LOCATOR
  TTL_COUNT
  TKT_NUM
  NAME
BY CAR_KEY  
BY TKT_NUM
BY PASSNGR_NAME NOPRINT
ON TABLE HOLD AS CARHOLD2
END
-RUN

MATCH FILE CARHOLD2
SUM TYPE
  CITY2  
  TRAN_DATE
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  AMOUNT
  PASSNGR_NAME
  CITY1
  DATE
  PNR_LOCATOR
  TTL_COUNT
  TKT_NUM
  NAME
BY CAR_KEY  
BY TKT_NUM  
ON TABLE HOLD 
RUN
FILE CAR_LVL
SUM LEVEL PCT LEVEL03 LEVEL04 LEVEL05
BY CAR_KEY 
BY TKT_NUM
BY LEVEL NOPRINT 
AFTER MATCH HOLD AS MATCHTWO OLD 
END
-RUN

DEFINE FILE MATCHTWO
PCT2/D15.2=EDIT(PCT) / 100;
PCT3/D15.2 = IF PCT2 GT 100 THEN 1.00 ELSE PCT2;
PCT4/A15 = IF PCT3 EQ 1.00 OR 0 THEN '100' ELSE PCT;
END
TABLE FILE MATCHTWO
PRINT
 PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TYPE
  NAME
  DATE
  CITY1
  CITY2
  AMOUNT
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL
  PCT4 AS 'PCT'
  LEVEL03
  LEVEL04
  LEVEL05
BY PASSNGR_NAME NOPRINT
BY PNR_LOC NOPRINT
BY TKT_NUM NOPRINT
ON TABLE HOLD AS CARHLD3
END
-RUN



DEFINE FILE CARHLD3
FLAG/A1 = 'C';
END
TABLE FILE CARHLD3
PRINT 
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TYPE
  NAME
  DATE
  CITY1
  CITY2
  AMOUNT
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL
  PCT
  LEVEL03
  LEVEL04
  LEVEL05
BY FLAG
BY PASSNGR_NAME NOPRINT
BY PNR_LOC NOPRINT
BY TKT_NUM NOPRINT
ON TABLE HOLD AS HOLDC FORMAT FOCUS
END
-RUN

-NOCAR 
-SET &&CARREC=IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';
