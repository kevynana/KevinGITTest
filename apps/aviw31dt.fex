-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-*                     FOCEXEC: AIRRPT
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*6/2/98         JK                 INCLUDE AIRLEVM INSTEAD OF AIRLEVT
-*7/31/00      IBISTL-KR            ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERDT 
-*07/03/02   STEVE              CHANGED TO eTTek Review and Copyright
-*06/12/03   DEB                    CARRIED THROUGH UPCOST
-*05/02/05   DEB                ADDED CODE FOR GLOBAL CURRENCY
-*05/11/06   STEVE              ADD VOID_CNT
-*05/11/06   STEVE              ADD NET_VOID_CNT (NET_TKT_CNT - VOID_CNT)
-*5/19/10    Deb                CARRIED THROUGH CAT
-*06/26/13   STEVE              CARRIED THROUGH AROLL_LEV2
-*1/22/14   CARRIED THROUGH RNDT_FLAG - DEB
-*1/27/14   CARRIED THROUGH TRIP_PURPOSE - DEB
-*2/5/14    CARRIED THROUGH ADDCOLLECT - JK
-*2/7/14    CARRIED THROUGH AL_TNUM - JK
-*2/14/14   CARRIED THROUGH EX_FEE - JK
-*5/22/14   DEB                 ADDED EX5 TO RADV_PURCH DEFINE
-*12/08/15 - JEM - S-13286 Updated to allow reports to sort/subtotal by id-levels
-* 09/23/16 - DLV - S-25159 - CARRIED THROUGH EMP_ID
-*10/11/16 - DLV - S-25736 - Added -INCLUDE DATAVROLL added new routine for ABAFILE
-* 08/04/2017 - JEM - S-37368 Updated LOW_AMT field to use SRT_DT instead of TKT_SORT
-*08/29/17 - DLV - S-39186 - ADDED ROUTINE FOR QBEAUK
-*09/07/2017 - DLV - S-37268 - Expanded ORGAPCXX DSTAPCXX to A9 due to ORG_APCX field expansion

-**************************************************************************
SET ASNAMES=ON


-INCLUDE SETECHO

-IF &&CURRENCY EQ 'USD' THEN GOTO SKIPTHIS;

-SET &&SUBHEAD = <NAMEC;
-SET &GFARE_CUR = 'FARE,PAID, (' | &&CURRENCY || ')';
-SET &&PRINT2= 'GFARE_AMT/D16.2CS AS ' | '''&GFARE_CUR.EVAL''';


-SKIPTHIS


TABLE FILE AFILE2
SUM DISSAVINGS AS 'DTSAVE'
    EXCHGS AS 'TEXCH'
    TKT_AMOUNT AS 'TAMT'
    SEG_DISCOUNT AS 'TDISC'
    FARE_PAID AS 'TFARE'
    PAID_FARE1/D16.2CS AS 'GTFARE'
    SEG_LOWEST AS 'TLOW'
    NEW_SEG_MILES AS 'TMILE'
    TKT_PURCH AS 'TPURCH'
    REF_EXCH_CNT AS 'TRFEX'
    SAVINGS AS 'TSAVE'
    SEG_AMT AS 'TSEG'
    SEG_STANDARD AS 'TSTD'
    SEG_TAX AS 'TTAX'
    NET_TKT_CNT AS 'TTKT'
    NET_TKT_CNT1 AS 'TTKT1'
    ADDCOLLECT AS 'TADD'
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS AIRHOLD1
END
-RUN


TABLE FILE AFILE2
PRINT ADDCOLLECT
      ADIR_ALL
      AGENT_NUM
      AIR_KEY	
      AIRLINE	
      AIRLINE_FEE	
      AIRLINE_NAME
      AL_TNUM
      ARR_DAY
      ARR_TIME	
      AROLL_DSC3
      AROLL_LEV2
      AROLL_LEV4
      BOOK_DT	
      BR_CL_IDX	
      C_ITIN
      CARD_NUM1	
      CASH_CREDIT
      CAT
      CL_CAT	
      CLASS	
      CLASS_CAT	
      CLIENT_NAME
      CLIENT_NUM	
      CREDIT_CARD	
      DISSAVINGS
      DODT
      DOD_TYPE	
      DPT_DAY
      DPT_TIME	
      DST_APX
      DSTDOD
      DTNPOS
      DTN_DI
      EMB_APT_CD	
      EMB_APT_NM
      EMB_CTY_NM
      EMB_CNTRY_CODE
      EMP_ID
      EX_RF_FLAG
      EX_FEE
      FARE_BAS	
      FARE_PAID	
      FLIGHT	
      GROUP_CODE
      HIGH_CAT
      INT_CODE
      INTL_DOM	
      INVOICE_NUM	
      LEVEL1	
      LEVEL2	
      LEVEL3	
      LEVEL4
      LEVEL5
      MIR_TYPE
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NET_TKT_CNT1	
      NEW_ADV_PURCH
      NEW_SEG_COUNT
      NEW_SEG_MILES
      NRFLAG
      ORG_APX
      PAID_FARE1/D16.2CS
      PASSNGR_NAME
      PNR_LOCATOR	
      REF_EXCH_CNT	
      REFUSAL_DESC	
      REFUSE_CODE
      RNDT_FLAG
      RTE_APT_CD	
      RTE_APT_NM	
      RTE_CTY_NM
      RTE_CNTRY_CODE
      SALES_FLAG
      SAVINGS	
      SEG_COUNT	
      SEG_DESIG	
      SEG_DISCOUNT	
      SEG_LOWEST	
      SEG_MILES	
      SEG_STANDARD
      SHUTTLE
      STAY
      TICKET_BRANCH	
      TKT_AMOUNT
      TKT_CL_CAT
      TKT_NUM
      TKT_RET_DATE
      TKT_TYPE	
      TKT_TYPE_DSC
      TOT_LEN2
      TOUR_CODE	
      TRAN_MONTH
      TRAN_YR
      TRIP_LENGTH
      TRIP_PURPOSE
      UPCOST	
      VAL_AIRLINE
      VAL_ALNM
      VOID_DATE
      XARR_DT	
      XDPT_DT
      XFST_DPT
      XTRAN_DT	
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
BY SEG_NBR
ON TABLE HOLD AS XTWO
END
-RUN

MATCH FILE XTWO
PRINT ADDCOLLECT
      ADIR_ALL
      AGENT_NUM
      AIR_KEY	
      AIRLINE	
      AIRLINE_FEE	
      AIRLINE_NAME
      AL_TNUM
      ARR_DAY
      ARR_TIME
      AROLL_DSC3
      AROLL_LEV2
      AROLL_LEV4
      BOOK_DT	
      BR_CL_IDX
      C_ITIN
      CARD_NUM1	
      CASH_CREDIT
      CAT
      CL_CAT	
      CLASS	
      CLASS_CAT	
      CLIENT_NAME
      CLIENT_NUM	
      CREDIT_CARD	
      DISSAVINGS
      DODT
      DOD_TYPE	
      DPT_DAY
      DPT_TIME	
      DST_APX
      DSTDOD
      DTNPOS
      DTN_DI
      EMB_APT_CD	
      EMB_APT_NM
      EMB_CTY_NM
      EMB_CNTRY_CODE
      EMP_ID
      EX_RF_FLAG
      EX_FEE
      FARE_BAS	
      FARE_PAID	
      FLIGHT	
      GROUP_CODE
      HIGH_CAT
      INT_CODE
      INTL_DOM	
      INVOICE_NUM	
      LEVEL1	
      LEVEL2	
      LEVEL3	
      LEVEL4
      LEVEL5
      MIR_TYPE
      MRK_TKT_CNT
      NAMEC
      NET_TKT_CNT
      NET_TKT_CNT1	
      NEW_ADV_PURCH	
      NEW_SEG_COUNT
      NEW_SEG_MILES
      NRFLAG
      ORG_APX
      PAID_FARE1
      PASSNGR_NAME
      PNR_LOCATOR	
      REF_EXCH_CNT	
      REFUSAL_DESC	
      REFUSE_CODE
      RNDT_FLAG
      RTE_APT_CD	
      RTE_APT_NM	
      RTE_CTY_NM
      RTE_CNTRY_CODE
      SALES_FLAG
      SAVINGS	
      SEG_COUNT	
      SEG_DESIG	
      SEG_DISCOUNT	
      SEG_LOWEST	
      SEG_MILES	
      SEG_STANDARD	
      SHUTTLE
      STAY
      TICKET_BRANCH	
      TKT_AMOUNT
      TKT_CL_CAT
      TKT_NUM	
      TKT_RET_DATE
      TKT_TYPE
      TKT_TYPE_DSC
      TOT_LEN2
      TOUR_CODE	
      TRAN_MONTH
      TRAN_YR
      TRIP_LENGTH
      TRIP_PURPOSE
      UPCOST	
      VAL_AIRLINE
      VAL_ALNM
      VOID_DATE
      XARR_DT	
      XDPT_DT
      XFST_DPT
      XTRAN_DT	
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
BY SEG_NBR
ON TABLE HOLD
RUN
FILE AIRHOLD1
PRINT DTSAVE
      GTFARE
      TAMT
      TDISC
      TEXCH
      TFARE
      TLOW
      TMILE
      TPURCH
      TRFEX
      TSAVE
      TSEG
      TSTD
      TTAX
      TTKT 
      TTKT1
      TADD
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
AFTER MATCH HOLD AS AIRHOLD2 OLD-OR-NEW
END
-RUN

TABLE FILE AIRHOLD2
PRINT ADDCOLLECT
      ADIR_ALL
      AGENT_NUM
      AIR_KEY	
      AIRLINE	
      AIRLINE_FEE	
      AIRLINE_NAME
      AL_TNUM
      ARR_DAY
      ARR_TIME
      AROLL_DSC3
      AROLL_LEV2
      AROLL_LEV4
      BOOK_DT	
      BR_CL_IDX	
      C_ITIN
      CARD_NUM1
      CASH_CREDIT
      CAT
      CL_CAT	
      CLASS	
      CLASS_CAT	
      CLIENT_NAME	
      CLIENT_NUM	
      CREDIT_CARD	
      DISSAVINGS
      DOD_TYPE	
      DODT
      DPT_DAY
      DPT_TIME	
      DST_APX
      DSTDOD
      DTSAVE
      DTNPOS
      DTN_DI
      EMB_APT_CD	
      EMB_APT_NM
      EMB_CTY_NM
      EMB_CNTRY_CODE
      EMP_ID
      EX_RF_FLAG
      EX_FEE
      FARE_BAS	
      FARE_PAID	
      FLIGHT	
      GROUP_CODE
      GTFARE
      HIGH_CAT
      INT_CODE 
      INTL_DOM	
      INVOICE_NUM	
      LEVEL_DESC
      LEVEL1	
      LEVEL2	
      LEVEL3	
      LEVEL4
      LEVEL5
      MIR_TYPE
      MRK_TKT_CNT	
      NAMEC
      NET_TKT_CNT
      NET_TKT_CNT1	
      NEW_ADV_PURCH	
      NEW_SEG_COUNT
      NEW_SEG_MILES
      NRFLAG
      ORG_APX
      PAID_FARE1
      PASSNGR_NAME
      PNR_LOCATOR
      REF_EXCH_CNT	
      REFUSAL_DESC	
      REFUSE_CODE
      RNDT_FLAG
      RTE_APT_CD	
      RTE_APT_NM
      RTE_CTY_NM
      RTE_CNTRY_CODE
      SALES_FLAG
      SAVINGS	
      SEG_COUNT	
      SEG_DESIG	
      SEG_DISCOUNT	
      SEG_LOWEST	
      SEG_MILES	
      SEG_NBR
      SEG_STANDARD
      SHUTTLE
      STAY
      TADD
      TAMT
      TDISC
      TEXCH
      TFARE
      TICKET_BRANCH	
      TKT_AMOUNT
      TKT_CL_CAT
      TKT_NUM	
      TKT_RET_DATE
      TKT_SORT
      TKT_TYPE
      TKT_TYPE_DSC
      TOT_LEN2
      TLOW
      TMILE
      TOUR_CODE	
      TPURCH
      TRAN_MONTH
      TRAN_YR
      TRFEX
      TRIP_LENGTH
      TRIP_PURPOSE
      TRN_DATE
      TSAVE
      TSEG
      TSTD
      TTAX
      TTKT
      TTKT1
      UPCOST
      VAL_AIRLINE	
      VAL_ALNM
      VOID_DATE
      XARR_DT	
      XDPT_DT
      XFST_DPT
      XPSNGR_NM
      XTRAN_DT	
-* BY TKT_SORT
-* BY SEG_NBR
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS AIRHOLD3
END
-RUN

-*-IF &&SETF.EVAL EQ 'DTNCFILE' THEN GOTO DTNC;
-IF &&SETF.EVAL EQ 'QBEAUK' THEN GOTO QBEA;

-JOIN
JOIN AGENT_NUM IN AIRHOLD3 TO AGENT IN AGENT AS J1
-RUN

DEFINE FILE AIRHOLD2
XDPT_DT1/MDY = IF SEG_NBR EQ '01' THEN XDPT_DT ELSE ' ';
END
-RUN
TABLE FILE AIRHOLD2
PRINT XDPT_DT1
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS DPTH
END
-RUN

MATCH FILE AIRHOLD3
PRINT ADDCOLLECT
      ADIR_ALL
      AGENT_NUM
      AIR_KEY	
      AIRLINE	
      AIRLINE_FEE	
      AIRLINE_NAME
      AL_TNUM
      ARR_DAY
      ARR_TIME
      AROLL_DSC3
      AROLL_LEV2
      AROLL_LEV4
      BOOK_DT	
      BR_CL_IDX	
      C_ITIN
      CARD_NUM1
      CASH_CREDIT
      CAT
      CL_CAT	
      CLASS	
      CLASS_CAT	
      CLIENT_NAME	
      CLIENT_NUM	
      CREDIT_CARD	
      DISSAVINGS
      DODT
      DOD_TYPE	
      DPT_DAY
      DPT_TIME	
      DST_APX
      DSTDOD
      DTNPOS
      DTN_DI
      DTSAVE
      EMB_APT_CD	
      EMB_APT_NM
      EMB_CTY_NM
      EMB_CNTRY_CODE
      EMP_ID
      EX_FEE
      FARE_BAS	
      FARE_PAID	
      FLIGHT	
      GROUP_CODE
      GTFARE
      HIGH_CAT
      INT_CODE 
      INTL_DOM	
      INVOICE_NUM	
      LEVEL_DESC
      LEVEL1	
      LEVEL2	
      LEVEL3	
      LEVEL4
      LEVEL5
      MIR_TYPE
      MRK_TKT_CNT	
      NAMEC
      NET_TKT_CNT
      NET_TKT_CNT1	
      NEW_ADV_PURCH	
      NEW_SEG_COUNT
      NEW_SEG_MILES
      NRFLAG
      ORG_APX
      PAID_FARE1
      PASSNGR_NAME
      PNR_LOCATOR
      REF_EXCH_CNT	
      REFUSAL_DESC	
      REFUSE_CODE
      RNDT_FLAG
      RTE_APT_CD	
      RTE_APT_NM
      RTE_CTY_NM
      RTE_CNTRY_CODE
      SAVINGS	
      SEG_COUNT	
      SEG_DESIG	
      SEG_DISCOUNT	
      SEG_LOWEST	
      SEG_MILES	
      SEG_NBR
      SEG_STANDARD
      SHUTTLE
      STAY
      TADD
      TAMT
      TDISC
      TEXCH
      TFARE
      TICKET_BRANCH	
      TKT_AMOUNT
      TKT_CL_CAT
      TKT_NUM	
      TKT_SORT
      TKT_TYPE	
      TOT_LEN2
      TLOW
      TMILE
      TOUR_CODE	
      TPURCH
      TRAN_MONTH
      TRAN_YR
      TRFEX
      TRIP_LENGTH
      TRIP_PURPOSE
      TRN_DATE
      TSAVE
      TSEG
      TSTD
      TTAX
      TTKT
      TTKT1
      UPCOST
      VAL_AIRLINE	
      VAL_ALNM
      VOID_DATE
      XARR_DT	
      XDPT_DT
      XFST_DPT
      XPSNGR_NM
      XTRAN_DT	
      BY LEVEL_DESC
      BY XPSNGR_NM
      BY TKT_SORT
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE 
ON TABLE HOLD
RUN
FILE DPTH
PRINT XDPT_DT1
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
AFTER MATCH HOLD AS AIRHOLD4 OLD-AND-NEW
END
-RUN

-GOTO ContRpt;

-*-DTNC
-QBEA;
TABLE FILE AIRHOLD3
BY ORG_APX
BY DST_APX
ON TABLE HOLD
END

DEFINE FILE HOLD
  ORGAPCXX/A9='''' | ORG_APX || '''';
END
TABLE FILE HOLD
BY ORGAPCXX
ON TABLE SAVE AS ORGAPCF
END
-RUN
DEFINE FILE HOLD
  DSTAPCXX/A9='''' | DST_APX || '''';
END
TABLE FILE HOLD
BY DSTAPCXX
ON TABLE SAVE AS DSTPACF
END
-RUN


JOIN COUNTRY_CODE IN AIRPORT TO COUNTRY_CODE IN COUNTRY AS J1
JOIN CITY_CODE IN AIRPORT TO CITY_CODE IN CITY AS J2
END

TABLE FILE AIRPORT
PRINT 
 CITY_NAME AS 'DCTY_NM' APCODEX COUNTRY_NAME AS 'DCNTRY_NAME' GEO_ZONE AS 'DGEO_ZONE' COUNTRY_CODE AS 'DCNTRY_CODE'
COUNTRY_NAME AS 'DCNTRY_NAME' 
WHERE APCODEX IN FILE DSTPACF
ON TABLE HOLD AS CNCTYAPT1 FORMAT FOCUS INDEX APCODEX 
END
-RUN




TABLE FILE AIRPORT
PRINT 
 CITY_NAME AS 'OCTY_NM' APCODEX COUNTRY_NAME AS 'OCNTRY_NAME' GEO_ZONE AS 'OGEO_ZONE' COUNTRY_CODE AS 'OCNTRY_CODE' 
WHERE APCODEX IN FILE ORGAPCF
ON TABLE HOLD AS CNCTYAPT2 FORMAT FOCUS INDEX APCODEX 
END
-RUN



 
JOIN CLEAR *
JOIN DST_APX IN AIRHOLD3 TO APCODEX IN CNCTYAPT1 AS JDA1
JOIN ORG_APX IN AIRHOLD3 TO APCODEX IN CNCTYAPT2 AS JOA1
END


DEFINE FILE AIRHOLD3
OD_CITY/A53 = OCTY_NM || '/' || DCTY_NM;
OGEO_ZN/A4 = IF OGEO_ZONE EQ 'EUR' OR 'MES' OR 'AFR' THEN 'EMEA' ELSE
              IF OGEO_ZONE EQ 'USA' OR OCNTRY_CODE EQ 'MX' OR 'CA' THEN 'NA' ELSE 'EAJP';
TANDT_ZONE/A4 = 'NA';    
DTN_TYPE/A8 = IF TKT_TYPE CONTAINS 'EX' THEN 'EXCHANGE' ELSE
           IF TKT_TYPE CONTAINS 'RF' THEN 'REFUND' ELSE 'ORIGINAL';
NO_FIELD/A8 = '        ';
HIGH_CAT/A15 = DECODE TKT_CL_CAT ('F' 'FIRST'     'P' 'PREMIUM ECONOMY'   
			        'D' 'DEFAULT'   'B' 'BUSINESS'
			        'E' 'ECONOMY'   'U'  'UPGRADE' 
                                ' ' 'DEFAULT'); 
DTN_TRAN/YYMT =  TRN_DATE;
AXDPT_DT/A8MDYY = XDPT_DT;
AXARR_DT/A8MDYY = XARR_DT;
UKDFLAG/A1 = IF RTE_CNTRY_CODE EQ 'GB' THEN 'Y' ELSE 'N';
UKOFLAG/A1 = IF EMB_CNTRY_CODE EQ 'GB' THEN 'Y' ELSE 'N';
 XDPT_DTA    /A10   = IF UKOFLAG EQ 'Y' THEN EDIT(AXDPT_DT,'99/99/9999') ELSE ' ';
 XARR_DTA    /A10   = IF UKDFLAG EQ 'Y' THEN EDIT(AXARR_DT,'99/99/9999') ELSE ' ';

QBEARR_DT/A10 = XARR_DTA;
QBEDPT_DT/A10 =  XDPT_DTA ;
END
TABLE FILE AIRHOLD3
PRINT ADIR_ALL
      AGENT_NUM
      AIR_KEY	
      AIRLINE	
      AIRLINE_FEE	
      AIRLINE_NAME	
      ARR_DAY
      ARR_TIME
      AROLL_DSC3
      AROLL_LEV2
      AROLL_LEV4
      BOOK_DT	
      BR_CL_IDX	
      C_ITIN
      CARD_NUM1
      CASH_CREDIT
      CAT
      CL_CAT	
      CLASS	
      CLASS_CAT	
      CLIENT_NAME	
      CLIENT_NUM	
      CREDIT_CARD
      DCNTRY_NAME
      DISSAVINGS
      DODT
      DOD_TYPE	
      DPT_DAY
      DPT_TIME	
      DST_APX
      DSTDOD
      DTNPOS
      DTN_DI
      DTSAVE
      EMB_APT_CD	
      EMB_APT_NM
      EMB_CTY_NM
      EMB_CNTRY_CODE
      EMP_ID
      EX_RF_FLAG
      FARE_BAS	
      FARE_PAID	
      FLIGHT	
      GROUP_CODE
      GTFARE
      HIGH_CAT
      INT_CODE 
      INTL_DOM	
      INVOICE_NUM	
      LEVEL_DESC
      LEVEL1	
      LEVEL2	
      LEVEL3	
      LEVEL4
      LEVEL5
      MIR_TYPE
      MRK_TKT_CNT	
      NAMEC
      NET_TKT_CNT
      NET_TKT_CNT1	
      NEW_ADV_PURCH
      NEW_SEG_COUNT
      NEW_SEG_MILES
      NRFLAG
      OCNTRY_NAME
      ORG_APX
      PAID_FARE1
      PASSNGR_NAME
      PNR_LOCATOR
      REF_EXCH_CNT	
      REFUSAL_DESC	
      REFUSE_CODE	
      RNDT_FLAG
      RTE_APT_CD	
      RTE_APT_NM
      RTE_CTY_NM
      RTE_CNTRY_CODE
      SALES_FLAG
      SAVINGS	
      SEG_COUNT	
      SEG_DESIG	
      SEG_DISCOUNT	
      SEG_LOWEST	
      SEG_MILES	
      SEG_NBR
      SEG_STANDARD
      SHUTTLE
      STAY
      TAMT
      TDISC
      TEXCH
      TFARE
      TICKET_BRANCH	
      TKT_AMOUNT
      TKT_CL_CAT
      TKT_NUM
      TKT_RET_DATE
      TKT_SORT
      TKT_TYPE
      TKT_TYPE_DSC
      TOT_LEN2
      TLOW
      TMILE
      TOUR_CODE	
      TPURCH
      TRAN_MONTH
      TRAN_YR
      TRFEX
      TRIP_LENGTH
      TRIP_PURPOSE
      TRN_DATE
      TSAVE
      TSEG
      TSTD
      TTAX
      TTKT
      TTKT1
      UPCOST
      VAL_AIRLINE	
      VAL_ALNM
      VOID_DATE
      XARR_DT	
      XDPT_DT
      XFST_DPT
      XPSNGR_NM
      XTRAN_DT	
      DCTY_NM
      OCTY_NM
      DCNTRY_NAME
      OD_CITY
      DGEO_ZONE
      DCNTRY_CODE
      OGEO_ZN
      TANDT_ZONE
      DCNTRY_NAME
      DTN_TYPE
      NO_FIELD
      HIGH_CAT
      DTN_TRAN
      QBEARR_DT
      QBEDPT_DT
      RTE_CNTRY_CODE
      EMB_CNTRY_CODE
      UKDFLAG
      UKOFLAG
BY TKT_NUM
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS AIRHOLD3B 
END
-RUN


DEFINE FILE AIRHOLD3B
QBEARR_DTA/A10 = QBEARR_DT;
END
TABLE FILE AIRHOLD3B
SUM QBEARR_DTA  
BY TKT_NUM
BY EMP_ID
BY PASSNGR_NAME
WHERE QBEARR_DT NE ' '
ON TABLE HOLD AS QBEARR
END
-RUN



DEFINE FILE AIRHOLD3B
QBEDPT_DTA/A10 = QBEDPT_DT;
END
TABLE FILE AIRHOLD3B
SUM QBEDPT_DTA 
BY TKT_NUM
BY EMP_ID  
BY PASSNGR_NAME
WHERE QBEDPT_DT NE ' '
ON TABLE HOLD AS QBEDPT
END
-RUN



MATCH FILE QBEARR
SUM QBEARR_DTA
BY TKT_NUM
BY EMP_ID
BY PASSNGR_NAME
ON TABLE HOLD
RUN
FILE QBEDPT
SUM QBEDPT_DTA
BY TKT_NUM
BY EMP_ID
BY PASSNGR_NAME
AFTER MATCH HOLD AS QBEDATES OLD-OR-NEW
END
-RUN
 
SET ALL=PASS 

JOIN CLEAR *

JOIN TKT_NUM IN AIRHOLD3B TO TKT_NUM IN QBEDATES AS J1
DEFINE FILE AIRHOLD3B
END
TABLE FILE AIRHOLD3B
PRINT ADIR_ALL
      AGENT_NUM
      AIR_KEY	
      AIRLINE	
      AIRLINE_FEE	
      AIRLINE_NAME	
      ARR_DAY
      ARR_TIME
      AROLL_DSC3
      AROLL_LEV2
      AROLL_LEV4
      BOOK_DT	
      BR_CL_IDX	
      C_ITIN
      CARD_NUM1
      CASH_CREDIT
      CAT
      CL_CAT	
      CLASS	
      CLASS_CAT	
      CLIENT_NAME	
      CLIENT_NUM	
      CREDIT_CARD
      DCNTRY_NAME
      DISSAVINGS
      DODT
      DOD_TYPE	
      DPT_DAY
      DPT_TIME	
      DST_APX
      DSTDOD
      DTNPOS
      DTN_DI
      DTSAVE
      EMB_APT_CD	
      EMB_APT_NM
      EMB_CTY_NM
      EMB_CNTRY_CODE
      EMP_ID
      EX_RF_FLAG
      FARE_BAS	
      FARE_PAID	
      FLIGHT	
      GROUP_CODE
      GTFARE
      HIGH_CAT
      INT_CODE 
      INTL_DOM	
      INVOICE_NUM	
      LEVEL_DESC
      LEVEL1	
      LEVEL2	
      LEVEL3	
      LEVEL4
      LEVEL5
      MIR_TYPE
      MRK_TKT_CNT	
      NAMEC
      NET_TKT_CNT
      NET_TKT_CNT1	
      NEW_ADV_PURCH
      NEW_SEG_COUNT
      NEW_SEG_MILES
      NRFLAG
      OCNTRY_NAME
      ORG_APX
      PAID_FARE1
      PASSNGR_NAME
      PNR_LOCATOR
      REF_EXCH_CNT	
      REFUSAL_DESC	
      REFUSE_CODE	
      RNDT_FLAG
      RTE_APT_CD	
      RTE_APT_NM
      RTE_CTY_NM
      RTE_CNTRY_CODE
      SALES_FLAG
      SAVINGS	
      SEG_COUNT	
      SEG_DESIG	
      SEG_DISCOUNT	
      SEG_LOWEST	
      SEG_MILES	
      SEG_NBR
      SEG_STANDARD
      SHUTTLE
      STAY
      TAMT
      TDISC
      TEXCH
      TFARE
      TICKET_BRANCH	
      TKT_AMOUNT
      TKT_CL_CAT
      TKT_NUM
      TKT_RET_DATE
      TKT_SORT
      TKT_TYPE
      TKT_TYPE_DSC
      TOT_LEN2
      TLOW
      TMILE
      TOUR_CODE	
      TPURCH
      TRAN_MONTH
      TRAN_YR
      TRFEX
      TRIP_LENGTH
      TRIP_PURPOSE
      TRN_DATE
      TSAVE
      TSEG
      TSTD
      TTAX
      TTKT
      TTKT1
      UPCOST
      VAL_AIRLINE	
      VAL_ALNM
      VOID_DATE
      XARR_DT	
      XDPT_DT
      XFST_DPT
      XPSNGR_NM
      XTRAN_DT	
      DCTY_NM
      OCTY_NM
      DCNTRY_NAME
      OD_CITY
      DGEO_ZONE
      DCNTRY_CODE
      OGEO_ZN
      TANDT_ZONE
      DCNTRY_NAME
      DTN_TYPE
      NO_FIELD
      HIGH_CAT
      DTN_TRAN
      QBEARR_DTA 
      QBEDPT_DTA 
BY LEVEL_DESC
BY XPSNGR_NM
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS AIRHOLD4
END
-RUN


 


 
-ContRpt;

-INCLUDE DATAVROLL

DEFINE FILE AIRHOLD4
-INCLUDE STDTIME
CONV_AMT/D9.2CS = IF TKT_SORT NE LAST TKT_SORT THEN TDISC ELSE 0;
CPMILE/D12.2CS = FARE_PAID/SEG_MILES;
EX_FEE1/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN EX_FEE ELSE 0;

LEV_1/A15 = IF TKT_NUM NE LAST TKT_NUM THEN LEVEL1 ELSE ' ';
LEV_2/A15 = IF TKT_NUM NE LAST TKT_NUM THEN LEVEL2 ELSE ' ';
LEV_3/A15 = IF TKT_NUM NE LAST TKT_NUM THEN LEVEL3 ELSE ' ';

NET_TKT_CNT/D9S = IF (SEG_NBR EQ '01') THEN  TTKT ELSE 0;
NET_TKT_CNT2/D8CS = IF (SEG_NBR EQ '01') THEN TTKT1 ELSE 0;                       
EXCH_CNT/D9CS = IF (SEG_NBR EQ '01') THEN TEXCH ELSE 0;
ADD_COLL/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN ADDCOLLECT ELSE 0;
PASNGR_NAME/A15 = IF TKT_NUM NE LAST TKT_NUM THEN XPSNGR_NM ELSE ' ';
REASON_CD/A2 =  IF TKT_NUM NE LAST TKT_NUM THEN REFUSE_CODE ELSE ' ';
RREFUSE_CODE/A2 = IF TKT_SORT NE LAST TKT_SORT THEN REFUSE_CODE ELSE ' ';

TICKET_NMBR/A10 = IF TKT_NUM NE LAST TKT_NUM THEN TKT_NUM ELSE ' ';
TKT_CNT/D9CS        = IF (SEG_NBR EQ '01') AND 
                         (FARE_PAID GE 0) AND 
                         (SEG_COUNT EQ 1) THEN 1 ELSE 0;  
TOTAL_MILES/D8CS = IF TKT_SORT NE LAST TKT_SORT THEN TMILE ELSE 0;
VOID_CNT/D9S = IF (SEG_NBR EQ '01' AND VOID_DATE NE 0) THEN 1 ELSE 0;
XBOOK_DT/MDYY = IF TKT_NUM NE LAST TKT_NUM THEN BOOK_DT ELSE 0; 	
XT_DTE/A8 = EDIT(TRN_DATE);
XTKT_SRT/A10 = EDIT(TKT_SORT,'9999999999$');
XTRAN_DTE/MDYY = IF TKT_NUM NE LAST TKT_NUM THEN XTRAN_DT ELSE 0;
-******************************************************************
-*  9/21/00  IBISTL-RJ    DEFINED AS AN 'A2', SHOULD BE 'A3'
XVAL_ALN/A3 = IF TKT_NUM NE LAST TKT_NUM THEN VAL_AIRLINE ELSE ' ';


-* ****DEFINES ON PREVIOUS DEFINES****
SRT_DT/A120 = TKT_SORT||XT_DTE||LEVEL_DESC||XPSNGR_NM;
FARE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TFARE ELSE 0;
GFARE_AMT/D16.2CS = IF SRT_DT NE LAST SRT_DT THEN GTFARE ELSE 0;
GROSS_SALES/D8CS = NET_TKT_CNT1 + EXCH_CNT;
NET_VOID_CNT/D9S = NET_TKT_CNT - VOID_CNT;
RADV_PURCH/I8CS = IF (EMB_APT_CD EQ 'FP2' OR 'EX1' OR 'RF1' OR 'EX5') THEN 0
  ELSE IF (TKT_TYPE EQ 'P-RF' OR 'P-EX') THEN 0
  ELSE IF (SEG_NBR EQ '00') THEN 0
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT GE 0) THEN NEW_ADV_PURCH
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT LT 0)
  THEN NEW_ADV_PURCH * (-1) ELSE 0;
SAVE_AMT/D10.2CS = IF SRT_DT NE LAST SRT_DT THEN TSAVE ELSE 0;
TK_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TAMT ELSE 0;
XSEG_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TSEG ELSE 0;
XTRP_LEN/I3CS = IF SRT_DT NE LAST SRT_DT THEN TRIP_LENGTH * TTKT ELSE 0;
-*DPT_DT1A/MDY = IF TKT_NUM NE LAST TKT_NUM THEN XDPT_DT1 ELSE ' ';
DPT_DT1A/MDY = IF TKT_NUM NE LAST TKT_NUM THEN XFST_DPT ELSE ' ';
DT_TOT_LEN/D10.6 = IF TKT_NUM NE LAST TKT_NUM THEN TOT_LEN2 ELSE 0;
CURR/A30 = 'USD';
LOST_SAV_AMT/D9.2CS = IF SRT_DT NE LAST SRT_DT THEN DTSAVE ELSE 0;
LOW_AMT/D10.2CS = IF SRT_DT NE LAST SRT_DT THEN TLOW ELSE 0;
SEG_AMT/D9.2CS = IF SRT_DT NE LAST SRT_DT THEN TSEG ELSE 0;
SEG_TAX/D9.2CS = IF SRT_DT NE LAST SRT_DT THEN TTAX ELSE 0;
STD_FARE/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TSTD ELSE 0;
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*7/31/00      IBISTL-KR            ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERDT
-**************************************************************************
NOWTOD/A8 WITH TKT_SORT = HHMMSS (NOWTOD);
XTS_FLAG/A1 = IF XTKT_SRT NE LAST XTKT_SRT THEN 'Y' ELSE 'N';

END


-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADAIR' ELSE 'HDREXLS'; 
-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'DTEXL' ELSE &&DTSTY;
-RUN


TABLE FILE AIRHOLD4
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
 

-*-IF &&SETF.EVAL EQ 'DTNCFILE' THEN GOTO DTNC2;
-IF '&&SETF.EVAL' EQ 'ABAFILE' THEN GOTO AIRfile;
 
-**********************************************************************
-* Print statement with fields passed from the user profile database
-**********************************************************************
-*
&&PRINT1
&&PRINT2
&&PRINT3
&&PRINT4
&&PRINT5
&&PRINT6
&&PRINT7
&&PRINT8
&&PRINT9
&&PRINT10
-*
-**********************************************************************
-* By statements (one per field)
-**********************************************************************
-*
&&BY1
&&BY2
&&BY3
&&BY4
&&BY5
&&BY6
&&BY7
&&BY8
&&BY9
&&BY10
-*
-**********************************************************************
-* On Table statements for code appropriate to On Table commands
-**********************************************************************
-*
&&ONTABLE1
&&ONTABLE2
&&ONTABLE3
&&ONTABLE4
&&ONTABLE5
&&ONTABLE6
&&ONTABLE7
&&ONTABLE8
&&ONTABLE9
&&ONTABLE10
 


-GOTO FinRpt;

-DTNC2
 
SUM TKT_NUM
    DTNPOS AS 'Issuing Country Name'
    NET_TKT_CNT AS 'Tickets_used'
    GFARE_AMT AS 'Paid_fare'
    LOW_AMT AS 'Lowest_fare'
    RADV_PURCH AS 'Advance_booking'
    EMB_CTY_NM AS 'Origin_city_name'
    TOTAL_MILES AS 'Trip_miles'
    DTN_DI AS 'Trip_type'
    LEVEL3 AS 'Client_Defined_Field_1'
    DT_TOT_LEN AS 'Flight_Duration'
    PASSNGR_NAME AS 'Traveler_name'
    VAL_ALNM AS 'Supplier_name'
    DT_TOT_LEN AS 'Total_travel_time'
    DTN_DI AS 'Trip type 4'
    TRAN_MONTH AS 'Year/Month 2'
    TRAN_YR AS 'Year'
    OD_CITY AS 'BiDir OD Pair'
    TANDT_ZONE AS 'Issuing_zone'
    TKT_CL_CAT AS 'Predominant_ticket_class'
    SEG_AMT AS 'Base_Fare'
    SEG_TAX AS 'Tax'
    DCNTRY_NAME AS 'Destination_country'
    C_ITIN AS 'Ticket_routing'
    RADV_PURCH AS 'Advance_ticketing'
    DTN_TYPE AS 'Transaction_type'
    LEVEL1 AS 'Cost_center'
    NO_FIELD AS 'SESA'
    NRFLAG AS 'R/F'
    GFARE_AMT AS 'Paid_fare_LC'
    LOW_AMT AS 'Lowest_fare_LC'
    HIGH_CAT AS 'CCC'
    DTN_TRAN AS 'CAD'
BY PASSNGR_NAME NOPRINT
BY TKT_SORT NOPRINT
BY TKT_NUM NOPRINT
ON TABLE NOTOTAL  
-GOTO FinRpt;

-AIRfile

SUM
FARE_AMT AS 'FARE PAID'
NET_TKT_CNT AS 'NET TICKETS'
BY PASSNGR_NAME AS 'PASSENGER NAME' BY BR_CL_IDX AS 'AR BRNCH/CLIENT#'
BY DOD_TYPE AS 'BOOKING' BY PNR_LOCATOR AS 'PNR'
BY BOOK_DT AS 'BOOK DT' 
BY EMP_ID &EMPID
BY LEVEL1 &LV1
BY LEVEL2 &LV2
BY LEVEL3 &LV3
BY LEVEL4 &LV4
BY XTRAN_DT AS 'INVDATE'
BY TKT_NUM AS 'TICKET#' BY TKT_TYPE AS 'TKT TYPE'
BY VOID_DATE AS 'VOID DATE' BY INTL_DOM AS 'INTL OR DOMESTIC'
BY VAL_AIRLINE AS 'VAL ALN'
BY REFUSE_CODE AS 'RSN CDE'
BY REFUSAL_DESC AS 'RSN DESC'
BY C_ITIN AS 'ITIN'
 
  


-FinRpt;
-*
-**********************************************************************
-* Report specific footer(s)
-**********************************************************************
-*
-INCLUDE FOOTERDT
-*
-*ON TABLE SET STYLE &&DTSTY
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**************************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT

ON TABLE SET STYLE *

-INCLUDE &&PASTYD
ENDSTYLE
-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN


 


















    
    
-XXIT

