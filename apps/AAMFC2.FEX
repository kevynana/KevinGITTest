-****************************************************************************
-* AAMFC2.fex - AIRLINE AVERAGE MARKET FARE COMPARISON (Quarterly Review)
-****************************************************************************
-*-INCLUDE SETECHO
-INCLUDE SETECHO

SET ASNAMES=ON

-SET &&AIR1 = '  ';
-SET &&AIR2 = '  ';
-SET &&AIR3 = '  ';
-SET &&AIR4 = '  ';
-SET &&AIR5 = '  ';
-SET &&AIR6 = '  ';
-SET &&AIR7 = '  ';
-SET &&AIR8 = '  ';
-SET &&AIR9 = '  ';




TABLE FILE BRPTFLDS
PRINT AL_MFC
WHERE INST_KEY EQ &&IKEY 
AND AL_MFC NE ' '
ON TABLE SAVE
END
-RUN


-SET &CNT = 0;
-REPEAT TOEND &LINES TIMES

-READ SAVE NOCLOSE &AIR.2. 
-* &X.1.
-SET &CNT = &CNT + 1;
-SET &&AIR.&CNT = '&AIR.EVAL';
-SET &&ACNT = &LINES;
-TOEND
-CLOSE SAVE



TABLEF FILE TPMPYR
-* PRINT AIR_LINE 
SUM AIR_LINE
    AIRLINE_NAME
    P1CNT
    P1FARE     
    XTRANMY
    TRNM_FLAG
    TRN_DATE
BY TRAN_MY    
BY CP_AIRLINE
WHERE (TRN_DATE GE '&&FROMDT.EVAL') AND (TRN_DATE LE '&&TODT.EVAL')
ON TABLE HOLD AS HOLD1
END
-RUN


DEFINE FILE HOLD1 
  AIRSELECT/A3 = IF ('&&AIR1' EQ AIR_LINE) THEN AIR_LINE ELSE '0';
  AIRSELECT2/A3 =IF ('&&AIR2' EQ AIR_LINE) THEN AIR_LINE ELSE '0';
  AIRSELECT3/A3 =IF ('&&AIR3' EQ AIR_LINE) THEN AIR_LINE ELSE '0';
  AIRSELECT4/A3 =IF ('&&AIR4' EQ AIR_LINE) THEN AIR_LINE ELSE '0';
  AIRSELECT5/A3 =IF ('&&AIR5' EQ AIR_LINE) THEN AIR_LINE ELSE '0';
  AIRSELECT6/A3 =IF ('&&AIR6' EQ AIR_LINE) THEN AIR_LINE ELSE '0';
  AIRSELECT7/A3 =IF ('&&AIR7' EQ AIR_LINE) THEN AIR_LINE ELSE '0';
  AIRSELECT8/A3 =IF ('&&AIR8' EQ AIR_LINE) THEN AIR_LINE ELSE '0';
  AIRSELECT9/A3 =IF ('&&AIR9' EQ AIR_LINE) THEN AIR_LINE ELSE '0'; 
END
-RUN

TABLE FILE HOLD1
SUM P1CNT
    P1FARE      
    XTRANMY     
    TRNM_FLAG
    AIRLINE_NAME
BY AIRSELECT NOPRINT
BY AIRSELECT2 NOPRINT
BY AIRSELECT3 NOPRINT
BY AIRSELECT4 NOPRINT
BY AIRSELECT5 NOPRINT
BY AIRSELECT6 NOPRINT
BY AIRSELECT7 NOPRINT
BY AIRSELECT8 NOPRINT
BY AIRSELECT9 NOPRINT
BY CP_AIRLINE
BY TRAN_MY

-**** Start - WHERE statement to test Flown Airlines selected *****************
-IF &&AIR1 NE ' ' AND &&AIR2 NE ' ' AND &&AIR3 NE ' ' AND &&AIR4 NE ' '
- AND &&AIR5 NE ' ' AND &&AIR6 NE ' ' AND &&AIR7 NE ' ' AND &&AIR8 NE ' '
- AND &&AIR9 NE ' ' THEN GOTO WHEREAIR9 ELSE GOTO CHKAIR8;

-WHEREAIR9
WHERE CP_AIRLINE EQ '&&AIR1' OR '&&AIR2' OR '&&AIR3' OR '&&AIR4' OR '&&AIR5' 
OR '&&AIR6' OR '&&AIR7' OR '&&AIR8' OR '&&AIR9'
-GOTO CHKDONE;

-CHKAIR8
-IF &&AIR1 NE ' ' AND &&AIR2 NE ' ' AND &&AIR3 NE ' ' AND &&AIR4 NE ' '
- AND &&AIR5 NE ' ' AND &&AIR6 NE ' ' AND &&AIR7 NE ' ' AND &&AIR8 NE ' '
- THEN GOTO WHEREAIR8 ELSE GOTO CHKAIR7;

-WHEREAIR8
WHERE CP_AIRLINE EQ '&&AIR1' OR '&&AIR2' OR '&&AIR3' OR '&&AIR4' OR '&&AIR5' OR
'&&AIR6' OR '&&AIR7' OR '&&AIR8' 
-GOTO CHKDONE;

-CHKAIR7
-IF &&AIR1 NE ' ' AND &&AIR2 NE ' ' AND &&AIR3 NE ' ' AND &&AIR4 NE ' '
- AND &&AIR5 NE ' ' AND &&AIR6 NE ' ' AND &&AIR7 NE ' '
- THEN GOTO WHEREAIR7 ELSE GOTO CHKAIR6;

-WHEREAIR7
WHERE CP_AIRLINE EQ '&&AIR1' OR '&&AIR2' OR '&&AIR3' OR '&&AIR4' OR 
'&&AIR5' OR '&&AIR6' OR '&&AIR7'
-GOTO CHKDONE;

-CHKAIR6
-IF &&AIR1 NE ' ' AND &&AIR2 NE ' ' AND &&AIR3 NE ' ' AND &&AIR4 NE ' '
- AND &&AIR5 NE ' ' AND &&AIR6 NE ' ' THEN GOTO WHEREAIR6 ELSE GOTO CHKAIR5;

-WHEREAIR6
WHERE CP_AIRLINE EQ '&&AIR1' OR '&&AIR2' OR '&&AIR3' OR '&&AIR4' OR 
'&&AIR5' OR '&&AIR6'
-GOTO CHKDONE;


-CHKAIR5
-IF &&AIR1 NE ' ' AND &&AIR2 NE ' ' AND &&AIR3 NE ' ' AND &&AIR4 NE ' '
- AND &&AIR5 NE ' ' THEN GOTO WHEREAIR5 ELSE GOTO CHKAIR4;

-WHEREAIR5
WHERE CP_AIRLINE EQ '&&AIR1' OR '&&AIR2' OR '&&AIR3' OR '&&AIR4' OR 
'&&AIR5'
-GOTO CHKDONE;

-CHKAIR4
-IF &&AIR1 NE ' ' AND &&AIR2 NE ' ' AND &&AIR3 NE ' ' AND &&AIR4 NE ' '
- THEN GOTO WHEREAIR4 ELSE GOTO CHKAIR3;

-WHEREAIR4
WHERE CP_AIRLINE EQ '&&AIR1' OR '&&AIR2' OR '&&AIR3' OR '&&AIR4' 
-GOTO CHKDONE;

-CHKAIR3
-IF &&AIR1 NE ' ' AND &&AIR2 NE ' ' AND &&AIR3 NE ' ' 
- THEN GOTO WHEREAIR3 ELSE GOTO CHKAIR2;

-WHEREAIR3
WHERE CP_AIRLINE EQ '&&AIR1' OR '&&AIR2' OR '&&AIR3' 
-GOTO CHKDONE;

-CHKAIR2
-IF &&AIR1 NE ' ' AND &&AIR2 NE ' ' THEN GOTO WHEREAIR2 ELSE GOTO CHKAIR1;

-WHEREAIR2
WHERE CP_AIRLINE EQ '&&AIR1' OR '&&AIR2'  
-GOTO CHKDONE;

-CHKAIR1
-IF &&AIR1 NE ' ' THEN GOTO WHEREAIR1 ELSE GOTO CHKDONE;

-WHEREAIR1
WHERE CP_AIRLINE EQ '&&AIR1'  
-GOTO CHKDONE;

-CHKDONE
-**** End - WHERE statement to test Flown Airlines selected *******************

ON TABLE HOLD AS CPHOLD1 
END
-RUN


DEFINE FILE CPHOLD1
FLAG/A1 = 'A';
END

TABLE FILE CPHOLD1
SUM P1CNT
    P1FARE     
    XTRANMY
    TRNM_FLAG
BY FLAG
BY AIRLINE_NAME
BY CP_AIRLINE
BY TRAN_MY
ON TABLE HOLD AS CPHOLD2 FORMAT FOCUS
END
-RUN


DEFINE FILE HOLD1
AIRLINE_NAME/A12 = 'ALL AIRLINES';
CP_AIRLINE/A3 = 'ZZZ';
FLAG/A1 = 'B';
END
TABLE FILE HOLD1
SUM P1CNT
    P1FARE     
    XTRANMY
    TRNM_FLAG
BY FLAG
BY AIRLINE_NAME
BY CP_AIRLINE
BY TRAN_MY
ON TABLE HOLD AS HOLD3 FORMAT FOCUS
END
-RUN

-SET &HLDPATH=TEMPPATH(50,'A50');
-SET &HRANK1=&HLDPATH || 'CPHOLD2.FOC';
-SET &HRANK2=&HLDPATH || 'HOLD3.FOC';
-RUN

USE CLEAR *

USE ADD 
&HRANK1 AS CPHOLD2
&HRANK2 AS CPHOLD2
END
-RUN

TABLE FILE CPHOLD2
SUM XTRANMY
BY TRAN_MY
ON TABLE HOLD AS DEBHOLD
END
-RUN



TABLE FILE DEBHOLD
LIST *
ON TABLE HOLD AS DEBHOLD2
END
-RUN


DEFINE FILE DEBHOLD2
XTRN_M/A3 = EDIT(XTRANMY, '999$$$$');
XTRN_Y/A4 = EDIT(XTRANMY, '$$$9999');
XTRN_MY/A8 = XTRN_M | ' ' | XTRN_Y;
END
TABLE FILE DEBHOLD2
PRINT LIST/I2 AS 'ROW_ORDER'
      XTRN_MY/A8 AS 'ROW_LABEL'
BY TRAN_MY
ON TABLE HOLD AS DEBHOLD3
END
-RUN

DEFINE FILE DEBHOLD2
CURM/A3 = EDIT(XTRANMY, '999');
CURM2/A5 =  '''' |CURM|'''';
END
TABLE FILE DEBHOLD2
PRINT CURM2
BY CURM2 NOPRINT
ON TABLE SAVE AS CURYR
END
-RUN




TABLE FILE DEBHOLD3
COUNT ROW_LABEL AS 'RCNT'
ON TABLE HOLD AS ROWCNT
END
-RUN

TABLE FILE ROWCNT
SUM RCNT/I5
ON TABLE SAVE AS ROWCNT1
END
-RUN

-READ ROWCNT1 NOCLOSE &RCNT.I5.
-RUN

-SET &&RCNT = &RCNT;

-CLOSE ROWCNT1

-SET &YTDLBL = '&&TODT.EVAL';
-SET &YR = SUBSTR(10, &YTDLBL, 1, 4, 4, 'A4');
-SET &&RLBL = 'YTD' | ' ' | '&YR.EVAL';

DEFINE FILE DEBHOLD3
CATEGORY/A40 = 'Average Market Fare';
CAT_ORDER/I2 = 1;
END
-RUN

TABLE FILE DEBHOLD3
PRINT CATEGORY/A40 AND ROW_LABEL/A8 AND
CAT_ORDER/I2 AND ROW_ORDER/I2 AND TRAN_MY/MTYY 
ON TABLE HOLD AS DEBHOLD3A
END
-RUN

TABLE FILE DEBHOLD3A
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER AND
      ROW_ORDER AND TRAN_MY
ON TABLE HOLD AS DEBHOLD3B
END
MODIFY FILE SMP_FAR2
FIXFORM FROM DEBHOLD3B
MATCH CATEGORY ROW_LABEL ROW_ORDER TRAN_MY 
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON DEBHOLD3B
END
-RUN

DEFINE FILE DEBHOLD3
CATEGORY/A40 = 'Average Market Fare';
ROW_LABEL/A8 = '&&RLBL.EVAL';
END
-RUN

TABLE FILE DEBHOLD3
SUM CATEGORY TRAN_MY   
BY ROW_LABEL
ON TABLE HOLD AS DEBHOLD4
END
-RUN

DEFINE FILE DEBHOLD4
CAT_ORDER/I2 = 1;
END

TABLE FILE DEBHOLD4
PRINT CATEGORY/A40 AND ROW_LABEL/A8 AND CAT_ORDER
COMPUTE ROW_ORDER/I2 = 13;
ON TABLE HOLD AS YTDTTL
END
-RUN

TABLE FILE YTDTTL
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER AND
      ROW_ORDER
ON TABLE HOLD AS YTDTTL1
END
MODIFY FILE SMP_FAR2
FIXFORM FROM YTDTTL1
MATCH CATEGORY ROW_LABEL ROW_ORDER
ON MATCH REJECT
ON NOMATCH INCLUDED
DATA ON YTDTTL1
END
-RUN

DEFINE FILE DEBHOLD3
CATEGORY/A40 = 'Dollar/PCT Variance over Previous Year';
CAT_ORDER/I2 = 2;
END
-RUN

TABLE FILE DEBHOLD3
PRINT CATEGORY/A40 AND XTRN_MY/A8 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND ROW_ORDER/I2 AND TRAN_MY/MTYY
ON TABLE HOLD AS DEBHOLD3C
END
-RUN

TABLE FILE DEBHOLD3C
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER AND
      ROW_ORDER AND TRAN_MY
ON TABLE HOLD AS DEBHOLD3D
END
MODIFY FILE SMP_FAR2
FIXFORM FROM DEBHOLD3D
MATCH CATEGORY ROW_LABEL ROW_ORDER TRAN_MY
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON DEBHOLD3D
END
-RUN


DEFINE FILE DEBHOLD3
CATEGORY/A40 = 'Dollar/PCT Variance over Previous Year';
ROW_LABEL/A8 = '&&RLBL.EVAL';
END
-RUN

TABLE FILE DEBHOLD3
SUM CATEGORY TRAN_MY   
BY ROW_LABEL
ON TABLE HOLD AS DEBHOLD5
END
-RUN

DEFINE FILE DEBHOLD5
CAT_ORDER/I2 = 2;
END

TABLE FILE DEBHOLD5
PRINT CATEGORY/A40 AND ROW_LABEL/A8 AND CAT_ORDER
COMPUTE ROW_ORDER/I2 = 13;
ON TABLE HOLD AS YTDTTL2
END
-RUN

TABLE FILE YTDTTL2
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER AND
      ROW_ORDER
ON TABLE HOLD AS YTDTTL3
END
MODIFY FILE SMP_FAR2
FIXFORM FROM YTDTTL3
MATCH CATEGORY ROW_LABEL ROW_ORDER
ON MATCH REJECT
ON NOMATCH INCLUDED
DATA ON YTDTTL3
END
-RUN

DEFINE FILE DEBHOLD3
CATEGORY/A40 = 'Cost/(Savings) over Previous Year';
CAT_ORDER/I2 = 3;
END
-RUN

TABLE FILE DEBHOLD3
PRINT CATEGORY/A40 AND XTRN_MY/A8 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND ROW_ORDER/I2 AND TRAN_MY/MTYY
ON TABLE HOLD AS DEBHOLD3E
END
-RUN

TABLE FILE DEBHOLD3E
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER AND
      ROW_ORDER AND TRAN_MY
ON TABLE HOLD AS DEBHOLD3F
END
MODIFY FILE SMP_FAR2
FIXFORM FROM DEBHOLD3F
MATCH CATEGORY ROW_LABEL ROW_ORDER TRAN_MY
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON DEBHOLD3F
END
-RUN

DEFINE FILE DEBHOLD3
CATEGORY/A40 = 'Cost/(Savings) over Previous Year';
ROW_LABEL/A8 = '&&RLBL.EVAL';
END
-RUN

TABLE FILE DEBHOLD3
SUM CATEGORY TRAN_MY   
BY ROW_LABEL
ON TABLE HOLD AS DEBHOLD6
END
-RUN

DEFINE FILE DEBHOLD6
CAT_ORDER/I2 = 3;
END

TABLE FILE DEBHOLD6
PRINT CATEGORY/A40 AND ROW_LABEL/A8 AND CAT_ORDER
COMPUTE ROW_ORDER/I2 = 13;
ON TABLE HOLD AS YTDTTL4
END
-RUN

TABLE FILE YTDTTL4
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER AND
      ROW_ORDER
ON TABLE HOLD AS YTDTTL5
END
MODIFY FILE SMP_FAR2
FIXFORM FROM YTDTTL5
MATCH CATEGORY ROW_LABEL ROW_ORDER
ON MATCH REJECT
ON NOMATCH INCLUDED
DATA ON YTDTTL5
END
-RUN

