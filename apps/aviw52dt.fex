
-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-*                     FOCEXEC: AIRRPT
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE

-*9/30/03        DEB                CARRIED THROUGHT EMB_APT_CD RTE_APT_CD 
-*11/25/03       JOY                ADDED CLASS
-*11/09/04       DEB                ADDED CODE FOR GLOBAL CURRENCY
-*6/30/05        DEB                CARRIED THROUGH TRIP_LENGTH
-*9/22/06        DEB                CARRIED THROUGH NEW_ADV_PUR
-*1/23/14 UPDATED ONLINE/TRADITIONAL DEFINES TO USE ONLINE_TRADITIONAL FIELD INSTEAD OF DOD_TYPE
-*5/23/14        DEB                ADDED EX5 TO RADV_PURCH DEFINE
-* 6/8/15 - DEB - S-09537 - ADDED SHTOPLSV TO ROUTINES SIMILAR TO ABTOPLSV
-*12/08/15 - JEM - S-13286 Updated to allow reports to sort/subtotal by id-levels
-*7/15/16 -DLV -  S-20630   expanded EMPID define to A15 
-*7/19/16 -RSB -  S-20630   expanded EMPID define to A15 at line 729
-* 08/04/2017 - JEM - S-37368 Updated LOW_AMT field to use SRT_DT instead of TKT_SORT

-**************************************************************************


SET ASNAMES = ON
-RUN
-INCLUDE SETECHO 

-IF &&SETF EQ 'ABTOPLSV' OR 'BZTPLSV' GOTO SET1;
-IF &&SETF EQ 'PRTOPLSV' OR 'BZTOPLSV' OR 'BATOPLSV' THEN GOTO SET2;
-IF &&SETF EQ 'BZTPLSV' GOTO BZSET;
-IF &&SETF EQ 'SHTOPLSV' GOTO SCHNEI ELSE GOTO Next2;

-SET1  

-DEFAULT &&RANK_METH = 'DISSAVINGS';
-DEFAULT &&RANK_LIMIT = 9999;
-GOTO Next2

-BZSET;
-DEFAULT &&RANK_METH = 'DSAV';
-DEFAULT &&RANK_LIMIT = 9999;
-GOTO Next2

-SET2
 
-SET &&RANK_METH = 'DISSAVINGS';
-SET &&RANK_LIMIT = 200;

-GOTO Next2;

-SCHNEI;

-SET &&RANK_METH = 'DISSAVINGS';
-SET &&RANK_LIMIT = 9999;

-Next2;
-IF &&SETF EQ 'BZTPLSV' GOTO BOOZFLSV;


-* -IF &&CURRENCY EQ 'USD' THEN GOTO NEXT;

-* -SET &&SUBHEAD = <NAMEC;
-* -SET &FPAID_CUR = 'FARE,PAID, (' | &&CURRENCY || ')';
-* -SET &&PRINT6='GFARE_AMT/D16.2CS AS ' | '''&FPAID_CUR.EVAL''';
-* -SET &&PRINT8='TOTAL_KILO AS ''TOTAL,KLMTRS''';

-* -NEXT;

TABLE FILE TOPTVL
SUM DISSAVINGS AS 'DSAV'
    DISSAVINGS
    NET_TKT_CNT
    MRK_TKT_CNT
    SEG_LOWEST
    FARE_PAID
    NEW_SEG_MILES
    TRP_LEN    
    EMP_ID
    EMP_NO
BY PASSNGR_NAME
BY LEVEL_DESC   
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS HOLDONE
END
-RUN

DEFINE FILE HOLDONE
LS_TKT/D8 = IF ((DSAV LT 1) AND (DSAV GT (-1))) THEN 0 ELSE NET_TKT_CNT;
END
TABLE FILE HOLDONE
SUM DSAV
    DISSAVINGS
    NET_TKT_CNT
    MRK_TKT_CNT
    SEG_LOWEST
    FARE_PAID
    LS_TKT
    EMP_ID
    EMP_NO
    NEW_SEG_MILES 
    TRP_LEN   
BY PASSNGR_NAME
BY LEVEL_DESC
ON TABLE HOLD AS HOLDTWO
END
-RUN

TABLE FILE HOLDTWO
SUM DSAV
    LS_TKT
    EMP_ID
    EMP_NO    
RANKED BY HIGHEST &&RANK_METH NOPRINT
BY PASSNGR_NAME
BY LEVEL_DESC
ON TABLE HOLD AS RNKHLD1
END 
-RUN


DEFINE FILE RNKHLD1
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  LIST/D9 = (LAST LIST + 1);
  CRANKX/A11 = FTOA(LIST, '(D9)', 'A11');
  CRANK/A9 = EDIT(CRANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE 
                  IF LIST GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                  CRANK;
-*   RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE 
-*                   IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE ARANK;                    
  RANK_VAL/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE
                IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE
                ARANK;
  RANK_LAB1/A80 = IF RANK_VAL NE 'ALL OTHER' THEN &&RANK_LABEL1
                  ELSE 'ALL OTHER';
  RANK_LABEL1/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2
                      ELSE ' ';
  RANK_LABEL3/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3
                      ELSE ' ';
  EMPID/A15 = IF RANK_VALUE NE 'ALL OTHER' THEN EMP_ID ELSE ' ';
  EMPNO/A80 = IF RANK_VALUE NE 'ALL OTHER' THEN EMP_NO ELSE ' ';
END
-RUN 

TABLE FILE RNKHLD1
SUM DSAV
    LS_TKT
    EMP_ID
    EMP_NO
BY RANK_VALUE
BY RANK_LABEL1 
BY PASSNGR_NAME
BY RANK_LABEL2
BY LEVEL_DESC
BY RANK_LABEL3
ON TABLE HOLD AS RNKHLD2
END
-RUN

TABLE FILE TOPTVL
PRINT 
      AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      LEVEL1
      MRK_TKT_CNT
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      OTFLAG
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
BY PASSNGR_NAME
BY LEVEL_DESC
ON TABLE HOLD AS HOLD5
END 
-RUN

MATCH FILE HOLD5
PRINT 
      AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      LEVEL1
      MRK_TKT_CNT
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      OTFLAG
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
BY PASSNGR_NAME
BY LEVEL_DESC
ON TABLE HOLD
RUN
FILE RNKHLD2
SUM EMP_ID
    EMP_NO
    RANK_VALUE
    RANK_LABEL1
    RANK_LABEL2
    RANK_LABEL3
BY PASSNGR_NAME
BY LEVEL_DESC
AFTER MATCH HOLD AS MATCHONE OLD-OR-NEW
END
-RUN

TABLE FILE MATCHONE
PRINT  
      AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      LEVEL1
      MRK_TKT_CNT
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      OTFLAG
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
      EMP_ID
      EMP_NO
      RANK_VALUE
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
BY PASSNGR_NAME
BY LEVEL_DESC
ON TABLE HOLD AS H1
END
-RUN


DEFINE FILE HOLDONE
LS_TKT/D8 = IF ((DSAV LT 1) AND (DSAV GT (-1))) THEN 0 ELSE NET_TKT_CNT;
END
TABLE FILE HOLDONE
SUM FARE_PAID AS 'TFARE'
    LS_TKT AS 'TLSTKT'
    DSAV AS 'TLOSS'
    NEW_SEG_MILES AS 'TMILE'
    TRP_LEN AS 'TLEN'
BY PASSNGR_NAME
BY LEVEL_DESC
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS XONE
END

MATCH FILE H1
PRINT 
      AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      LEVEL1
      MRK_TKT_CNT
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      OTFLAG
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
      EMP_ID
      EMP_NO
      RANK_VALUE
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
BY PASSNGR_NAME
BY LEVEL_DESC
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD
RUN
FILE XONE
SUM TFARE
    TLSTKT
    TLOSS
    TMILE
    TLEN
BY PASSNGR_NAME
BY LEVEL_DESC
BY TKT_SORT
BY TRN_DATE
AFTER MATCH HOLD AS XTWO OLD-OR-NEW
END
-RUN

TABLE FILE XTWO
PRINT 
      AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
-*       FLT_RANGE
      LEVEL1
      LEVEL_DESC
      MRK_TKT_CNT
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      OTFLAG
      PASSNGR_NAME
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
      EMP_ID
      EMP_NO
      RANK_VALUE
      RANK_LABEL1
      RANK_LABEL2
      RANK_LABEL3
      TLSTKT
      TFARE
      TLOSS
      TMILE
      TLEN
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD4
END
-RUN


DEFINE FILE AIRHOLD4
-* NET_TKT_CNT/D9S = IF (SEG_NBR EQ '01') THEN  TTKT ELSE 0;
EMPLID/A15 = IF TKT_NUM NE LAST TKT_NUM THEN EMP_ID ELSE ' ';
EMPLNO/A80 = IF TKT_NUM NE LAST TKT_NUM THEN EMP_NO ELSE ' ';
PASNGR_NAME/A33 = IF TKT_NUM NE LAST TKT_NUM THEN PASSNGR_NAME ELSE ' ';
REASON_CD/A2 =  IF TKT_NUM NE LAST TKT_NUM THEN REFUSE_CODE ELSE ' ';
TICKET_NMBR/A10 = IF TKT_NUM NE LAST TKT_NUM THEN TKT_NUM ELSE ' ';
XT_DTE/A8 = EDIT(TRN_DATE);
XTKT_SRT/A10 = EDIT(TKT_SORT,'9999999999$');
XTRAN_DTE/MDYY = IF TKT_NUM NE LAST TKT_NUM THEN XTRAN_DT ELSE 0;


-* ****DEFINES ON PREVIOUS DEFINES****
SRT_DT/A120 = TKT_SORT||XT_DTE||PASSNGR_NAME;
FARE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TFARE ELSE 0;
LS_TKT/D9S = IF SRT_DT NE LAST SRT_DT THEN TLSTKT ELSE 0;

LOST_SAV_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TLOSS ELSE 0;
RADV_PURCH/I8CS = IF (EMB_APT_CD EQ 'FP2' OR 'EX1' OR 'RF1' OR 'EX5') THEN 0
  ELSE IF (TKT_TYPE EQ 'P-RF' OR 'P-EX') THEN 0
  ELSE IF (SEG_NBR EQ '00') THEN 0
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT GE 0) THEN NEW_ADV_PURCH
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT LT 0) 
  THEN NEW_ADV_PURCH * (-1) ELSE 0;
TOTAL_MILES/D8CS = IF TKT_SORT NE LAST TKT_SORT THEN TMILE ELSE 0;
TRIP_LEN/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TLEN ELSE 0;
-* TOTAL_SEG/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TSEG ELSE 0;
NOWTOD/A8 WITH RANK_VALUE = HHMMSS (NOWTOD);
PAX_NAME/A15 = EDIT(PASSNGR_NAME, '999999999999999');
XTS_FLAG/A1 = IF XTKT_SRT NE LAST XTKT_SRT THEN 'Y' ELSE 'N';

END
-RUN
 
-IF '&&SETF.EVAL' NE 'ABTOPLSV' OR 'SHTOPLSV' THEN GOTO Finishrpt;

-* -SET &&SUBHEAD = <LEVEL_DESC;

-Finishrpt;
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*7/31/00     IBISTL-KR             ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERDT
-**************************************************************************


-IF &&DRILLED_RUN EQ 'N' GOTO SKIP_DRIL;
-************************************************************
-* INCLUDE PROGRAM TO GEN WHERE STATEMENTS
-************************************************************
-SET &&DRILLRPT = 'AIRHOLD4';
-INCLUDE DRILWHRS
-SKIP_DRIL
-************************************************************

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADAIR' ELSE 'HDREXLS'; 
-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'DTEXL' ELSE &&DTSTY;
-RUN

TABLE FILE AIRHOLD4
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
-*
-**********************************************************************
-* Print statement with fields passed from the user profile database
-**********************************************************************
-*
&&PRINT1
&&PRINT2
&&PRINT3
&&PRINT4
&&PRINT5
&&PRINT6
&&PRINT7
&&PRINT8
&&PRINT9
&&PRINT10

-*
-**********************************************************************
-* By statements (one per field)
-**********************************************************************
-*
&&BY1
&&BY2
&&BY3
&&BY4
&&BY5
&&BY6
&&BY7
&&BY8
&&BY9
&&BY10
BY XTS_FLAG NOPRINT


-*
-*********************************************************************
-*DATE           NAME               DESCRIPTION 
-*8/18/00      IBISTL-KR            INCLUDE WHERE STATEMENTS WHEN
-*                                  DRILLED_RUN EQ 'Y'.
-*********************************************************************
-*
-**********************************************************************
-* Where statements for Drilled Report
-**********************************************************************
-*
-IF &&DRILLED_RUN EQ 'N' GOTO SKIP_WHR;
-INCLUDE &&DRILLWHR
-SKIP_WHR
-*
-**********************************************************************
-* On Table statements for code appropriate to On Table commands
-**********************************************************************
-*
&&ONTABLE1
&&ONTABLE2
&&ONTABLE3
&&ONTABLE4
&&ONTABLE5
&&ONTABLE6
&&ONTABLE7
&&ONTABLE8
&&ONTABLE9
&&ONTABLE10


-*
-**********************************************************************
-* Report specific footer(s)
-**********************************************************************
-*
-INCLUDE FOOTERDT
-*
-*ON TABLE SET STYLE &&DTSTY
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**************************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
-INCLUDE &&PASTYD
ENDSTYLE
-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN
-GOTO XXIT;



-BOOZFLSV;
TABLE FILE TOPTVL
SUM DISSAVINGS AS 'DSAV'
    NET_TKT_CNT
    SEG_LOWEST
    FARE_PAID
    NEW_SEG_MILES
    TRP_LEN
    EMP_ID
    EMP_NO
BY PASSNGR_NAME
BY FLT_RANGE
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS HOLDONE
END
-RUN


DEFINE FILE HOLDONE
LS_TKT/D8 = IF ((DSAV LT 1) AND (DSAV GT (-1))) THEN 0 ELSE NET_TKT_CNT;
END
TABLE FILE HOLDONE
SUM DSAV
    TOT.DSAV AS 'TDSV'
    EMP_ID
    SEG_LOWEST
    FARE_PAID
    NET_TKT_CNT
    LS_TKT
    EMP_NO
BY PASSNGR_NAME
ON TABLE HOLD AS HOLDTWO
END
-RUN

TABLE FILE TOPTVL
SUM 
    NET_TKT_CNT
    MRK_TKT_CNT
    FARE_PAID
    PAID_FAREX/D16.2CS
    DISSAVINGS
    KILO
    LEVEL1
    LEVEL3
    NAMEC
    NEW_SEG_MILES
    NEW_TRIP_LENGTH
    AIRLINE_FEE
    AIRFEE_CNT
    NON_TKTS
    REF_TKTS
    AA_TKT
    DL_TKT
    UA_TKT
    NW_TKT
    OTH_TKT
    TRP_LEN
BY PASSNGR_NAME
BY FLT_RANGE
ON TABLE HOLD AS HOLDTHREE
END
-RUN



MATCH FILE HOLDTHREE
PRINT NET_TKT_CNT
    MRK_TKT_CNT
    FARE_PAID
    PAID_FAREX 
    DISSAVINGS
    KILO
    LEVEL1
    LEVEL3
    NAMEC
    NEW_SEG_MILES
    NEW_TRIP_LENGTH
    AIRLINE_FEE
    AIRFEE_CNT
    NON_TKTS
    REF_TKTS
    AA_TKT
    DL_TKT
    UA_TKT
    NW_TKT
    OTH_TKT
    TRP_LEN
BY PASSNGR_NAME
BY FLT_RANGE
ON TABLE HOLD
RUN
FILE HOLDTWO
SUM EMP_ID
    EMP_NO
    DSAV
    LS_TKT
BY PASSNGR_NAME
-* BY FLT_RANGE
AFTER MATCH HOLD AS MATCHONE OLD-OR-NEW
END
-RUN



TABLE FILE MATCHONE
PRINT DISSAVINGS
    NET_TKT_CNT
    LS_TKT
    DSAV
    EMP_ID
    EMP_NO
    MRK_TKT_CNT
    FARE_PAID
    KILO
    LEVEL1
    LEVEL3
    
    NAMEC
    NEW_SEG_MILES
    NEW_TRIP_LENGTH
    PAID_FAREX
    AIRLINE_FEE
    AIRFEE_CNT
    NON_TKTS
    REF_TKTS
    AA_TKT
    DL_TKT
    UA_TKT
    NW_TKT
    OTH_TKT
    TRP_LEN
RANKED BY HIGHEST DSAV NOPRINT
BY PASSNGR_NAME
BY FLT_RANGE
ON TABLE HOLD AS RNKHLD2
END
-RUN


DEFINE FILE RNKHLD2
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  LIST/D9 = IF PASSNGR_NAME NE LAST PASSNGR_NAME THEN (LAST LIST + 1) ELSE LAST LIST;
  CRANKX/A11 = FTOA(LIST, '(D9)', 'A11');
  CRANK/A9 = EDIT(CRANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE 
                  IF LIST GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                  CRANK;
  RANK_VAL/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE
                IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE
                ARANK;
  RANK_LAB1/A60 = IF RANK_VAL NE 'ALL OTHER' THEN &&RANK_LABEL1
                  ELSE 'ALL OTHER';
  RANK_LABEL1/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2
                      ELSE ' ';
  RANK_LABEL3/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3
                      ELSE ' ';
  LEVEL/A15 = IF RANK_VALUE NE 'ALL OTHER' THEN LEVEL1 ELSE ' '; 
  EMPID/A9 = IF RANK_VALUE NE 'ALL OTHER' THEN EMP_ID ELSE ' ';
  EMPNO/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN EMP_NO ELSE ' ';
  LSTKT/D8 = IF PASSNGR_NAME NE LAST PASSNGR_NAME THEN LS_TKT ELSE 0;
-* NET_TKT_CNT/D9S = IF (SEG_NBR EQ '01') THEN TTKT ELSE 0;
  NOWTOD/A8 WITH RANK = HHMMSS (NOWTOD);
END
-RUN

TABLE FILE RNKHLD2
SUM DSAV
    LS_TKT
    EMP_ID
    EMP_NO
BY RANK_VALUE
BY RANK_LABEL1 
BY PASSNGR_NAME
BY RANK_LABEL2
BY FLT_RANGE
ON TABLE HOLD AS RNKHLD2
END
-RUN

TABLE FILE TOPTVL
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      LEVEL1
      MRK_TKT_CNT
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      OTFLAG
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
      LEVEL_DESC
BY PASSNGR_NAME
BY FLT_RANGE
ON TABLE HOLD AS HOLD5
END 
-RUN

MATCH FILE HOLD5
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      LEVEL1
      LEVEL_DESC
      MRK_TKT_CNT
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      OTFLAG
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
BY PASSNGR_NAME
BY FLT_RANGE
ON TABLE HOLD
RUN
FILE RNKHLD2
SUM EMP_ID
    EMP_NO
    RANK_VALUE
    RANK_LABEL1
    RANK_LABEL2
BY PASSNGR_NAME
BY FLT_RANGE
AFTER MATCH HOLD AS MATCHONE OLD-OR-NEW
END
-RUN

TABLE FILE MATCHONE
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      LEVEL1
      LEVEL_DESC
      MRK_TKT_CNT
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      OTFLAG
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
      EMP_ID
      EMP_NO
      RANK_VALUE
      RANK_LABEL1
      RANK_LABEL2
BY PASSNGR_NAME
BY FLT_RANGE
ON TABLE HOLD AS H1
END
-RUN


DEFINE FILE HOLDONE
LS_TKT/D8 = IF ((DSAV LT 1) AND (DSAV GT (-1))) THEN 0 ELSE NET_TKT_CNT;
END
TABLE FILE HOLDONE
SUM FARE_PAID AS 'TFARE'
    LS_TKT AS 'TLSTKT'
    DSAV AS 'TLOSS'
    NEW_SEG_MILES AS 'TMILE'
    TRP_LEN AS 'TLEN'
BY PASSNGR_NAME
BY FLT_RANGE
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD AS XONE
END

MATCH FILE H1
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      LEVEL1
      LEVEL_DESC
      MRK_TKT_CNT
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      OTFLAG
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
      EMP_ID
      EMP_NO
      RANK_VALUE
      RANK_LABEL1
      RANK_LABEL2
BY PASSNGR_NAME
BY FLT_RANGE
BY TKT_SORT
BY TRN_DATE
ON TABLE HOLD
RUN
FILE XONE
SUM TFARE
    TLSTKT
    TLOSS
    TMILE
    TLEN
BY PASSNGR_NAME
BY FLT_RANGE
BY TKT_SORT
BY TRN_DATE
AFTER MATCH HOLD AS XTWO OLD-OR-NEW
END
-RUN

TABLE FILE XTWO
PRINT AIRLINE
      AIRLINE_FEE
      AIRFEE_CNT
      CLASS
      EMB_APT_CD     
      EMB_APT_NM
      DISSAVINGS
      FARE_PAID
      FLT_RANGE
      LEVEL1
      LEVEL_DESC
      MRK_TKT_CNT
      NEW_ADV_PUR
      NET_TKT_CNT
      NEW_SEG_MILES
      OTFLAG
      PASSNGR_NAME
      SAVINGS
      REFUSE_CODE
      RTE_APT_CD 
      RTE_APT_NM  
      SEG_NBR
      TKT_NUM     
      TKT_SORT
      TKT_TYPE
      TRN_DATE
      DPT_TIME
      XDPT_DT
      XTRAN_DT
      TRP_LEN
      EMP_ID
      EMP_NO
      RANK_VALUE
      RANK_LABEL1
      RANK_LABEL2
      TLSTKT
      TFARE
      TLOSS
      TMILE
      TLEN
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS AIRHOLD4
END
-RUN


DEFINE FILE AIRHOLD4
-* NET_TKT_CNT/D9S = IF (SEG_NBR EQ '01') THEN  TTKT ELSE 0;
EMPLID/A9 = IF TKT_NUM NE LAST TKT_NUM THEN EMP_ID ELSE ' ';
EMPLNO/A60 = IF TKT_NUM NE LAST TKT_NUM THEN EMP_NO ELSE ' ';
PASNGR_NAME/A33 = IF TKT_NUM NE LAST TKT_NUM THEN PASSNGR_NAME ELSE ' ';
REASON_CD/A2 =  IF TKT_NUM NE LAST TKT_NUM THEN REFUSE_CODE ELSE ' ';
TICKET_NMBR/A10 = IF TKT_NUM NE LAST TKT_NUM THEN TKT_NUM ELSE ' ';
XT_DTE/A8 = EDIT(TRN_DATE);
XTKT_SRT/A10 = EDIT(TKT_SORT,'9999999999$');
XTRAN_DTE/MDYY = IF TKT_NUM NE LAST TKT_NUM THEN XTRAN_DT ELSE 0;


-* ****DEFINES ON PREVIOUS DEFINES****
SRT_DT/A100 = TKT_SORT||XT_DTE||PASSNGR_NAME;
FARE_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TFARE ELSE 0;
LS_TKT/D9S = IF SRT_DT NE LAST SRT_DT THEN TLSTKT ELSE 0;

LOST_SAV_AMT/D12.2CS = IF SRT_DT NE LAST SRT_DT THEN TLOSS ELSE 0;
RADV_PURCH/I8CS = IF (EMB_APT_CD EQ 'FP2' OR 'EX1' OR 'RF1' OR 'EX5') THEN 0
  ELSE IF (TKT_TYPE EQ 'P-RF' OR 'P-EX') THEN 0
  ELSE IF (SEG_NBR EQ '00') THEN 0
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT GE 0) THEN NEW_ADV_PURCH
  ELSE IF (TKT_SORT NE LAST TKT_SORT) AND (FARE_AMT LT 0) 
  THEN NEW_ADV_PURCH * (-1) ELSE 0;
TOTAL_MILES/D8CS = IF TKT_SORT NE LAST TKT_SORT THEN TMILE ELSE 0;
TRIP_LEN/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TLEN ELSE 0;
-* TOTAL_SEG/D9CS = IF TKT_SORT NE LAST TKT_SORT THEN TSEG ELSE 0;
NOWTOD/A8 WITH RANK_VALUE = HHMMSS (NOWTOD);
PAX_NAME/A15 = EDIT(PASSNGR_NAME, '999999999999999');
XTS_FLAG/A1 = IF XTKT_SRT NE LAST XTKT_SRT THEN 'Y' ELSE 'N';

END
-RUN
 
-IF '&&SETF.EVAL' NE 'ABTOPLSV' THEN GOTO Finishrpt;

-* -SET &&SUBHEAD = <LEVEL_DESC;

-Finishrpt;
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*7/31/00     IBISTL-KR             ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERDT
-**************************************************************************


-IF &&DRILLED_RUN EQ 'N' GOTO SKIP_DRIL;
-************************************************************
-* INCLUDE PROGRAM TO GEN WHERE STATEMENTS
-************************************************************
-SET &&DRILLRPT = 'AIRHOLD4';
-INCLUDE DRILWHRS
-SKIP_DRIL
-************************************************************

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADAIR' ELSE 'HDREXLS'; 
-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'DTEXL' ELSE &&DTSTY;
-RUN

TABLE FILE AIRHOLD4
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
-*
-**********************************************************************
-* Print statement with fields passed from the user profile database
-**********************************************************************
-*
&&PRINT1
&&PRINT2
&&PRINT3
&&PRINT4
&&PRINT5
&&PRINT6
&&PRINT7
&&PRINT8
&&PRINT9
&&PRINT10

-*
-**********************************************************************
-* By statements (one per field)
-**********************************************************************
-*
&&BY1
&&BY2
&&BY3
&&BY4
&&BY5
&&BY6
&&BY7
&&BY8
&&BY9
&&BY10
BY XTS_FLAG NOPRINT


-*
-*********************************************************************
-*DATE           NAME               DESCRIPTION 
-*8/18/00      IBISTL-KR            INCLUDE WHERE STATEMENTS WHEN
-*                                  DRILLED_RUN EQ 'Y'.
-*********************************************************************
-*
-**********************************************************************
-* Where statements for Drilled Report
-**********************************************************************
-*
-IF &&DRILLED_RUN EQ 'N' GOTO SKIP_WHR;
-INCLUDE &&DRILLWHR
-SKIP_WHR
-*
-**********************************************************************
-* On Table statements for code appropriate to On Table commands
-**********************************************************************
-*
&&ONTABLE1
&&ONTABLE2
&&ONTABLE3
&&ONTABLE4
&&ONTABLE5
&&ONTABLE6
&&ONTABLE7
&&ONTABLE8
&&ONTABLE9
&&ONTABLE10


-*
-**********************************************************************
-* Report specific footer(s)
-**********************************************************************
-*
-INCLUDE FOOTERDT
-*
-*ON TABLE SET STYLE &&DTSTY
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**************************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
-INCLUDE &&PASTYD
ENDSTYLE
-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN

-*

-* REJ EX RESTART 
-*-*-EXIT

-XXIT
