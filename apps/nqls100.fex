-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* Created for the new quarterly review - JK 8/2/05
-******************************************************************************

-INCLUDE SETECHO

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-SET &POS0=0;
-SET &INC = 28;
-SET &POS1T = &POS0 + 1 * &INC;


-SET &POS1 = &POS1T + 0;
-SET &POS2 = &POS1 + 9;
-SET &POS3 = &POS2 + 9;
-SET &POS4 = &POS3 + 9;
-SET &POS5 = &POS4 + 9;
-SET &POS6 = &POS5 + 9;
-SET &POS7 = &POS6 + 9;
-SET &POS8 = &POS7 + 9;


-SET &POS1A = &POS1 - 1;
-SET &POS2A = &POS2 - 1;
-SET &POS3A = &POS3 - 1;
-SET &POS4A = &POS4 - 1;
-SET &POS5A = &POS5 - 1;
-SET &POS6A = &POS6 - 1;
-SET &POS7A = &POS7 - 1;
-SET &POS8A = &POS8 - 1;
-SET &POS9A = &POS8 + 7;


DEFINE FILE &&EXTRACT
FARE_PAID/D12M = SEG_AMT + SEG_TAX;
NET_TKT_CNT/D12    =  IF (TICKET_CODE EQ '1') AND
                         (SEG_NBR EQ '01') AND
                         (FARE_PAID GE 0) AND
                         (SEG_COUNT EQ 1) AND 
                         (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
TKT_AMOUNT/D12M = TICKET_AMT + TAX_AMT;
-INCLUDE QRFTRANA

-* DEFINES ON PREVIOUS
DECLINE_AMT/D12M  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         TKT_AMOUNT - LOWEST_AMT;
DISSAVINGS/D12M = IF EMBARK EQ 'DT1' THEN 0 ELSE
                   FARE_PAID-SEG_LOWEST;
-*********
-* DEFINED PREVIOUS
DECLINE/A1 = IF ((DECLINE_AMT GE 100) OR (DECLINE_AMT LE (-100))) THEN 'Y' ELSE 'N';
DFAREP/D12M = IF DECLINE EQ 'Y' THEN FARE_PAID ELSE 0;
DNET/D12 = IF DECLINE EQ 'Y' THEN NET_TKT_CNT ELSE 0;
DDIS/D12M = IF DECLINE EQ 'Y' THEN DISSAVINGS ELSE 0;
END
-RUN

TABLEF FILE &&EXTRACT
PRINT DISSAVINGS
      DFAREP
      DNET
      DDIS
      SEG_COUNT
      TKT_NUM
      TRAN
      TRN_DATE
      YEAR

WHERE (TRN_DATE GE '&&FROMDT.EVAL') AND (TRN_DATE LE '&&TODT.EVAL') OR
      (TRN_DATE GE '&&FXDATE.EVAL') AND (TRN_DATE LE '&&TXDATE.EVAL')
WHERE VOID_DATE EQ 0 

-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-INCLUDE RPTPARMS
ON TABLE HOLD AS LSHOLD1
END
-RUN

TABLE FILE LSHOLD1
PRINT DFAREP
     DNET
     DDIS
     TRAN
     TRN_DATE
     YEAR
BY TKT_NUM
BY SEG_COUNT
ON TABLE HOLD AS LSHOLD2
END
-RUN


TABLE FILE LSHOLD2
SUM DDIS
    DFAREP
    DNET
COMPUTE LSPT/D12 =  IF ((DNET LT 1) AND (DNET GT (-1))) 
                    THEN 0 ELSE (DDIS/DNET);     
BY TRAN
ON TABLE SAVE AS LS100 FORMAT ALPHA
END
-RUN

-SET &G_LSG= 'N';
-IF &&SKIPGRAPH EQ 'Y' THEN GOTO AROUNDG;

-*  Fare Paid, Lost Savings, Net Tickets, and Lost Savings per Net Ticket Graph
GRAPH FILE LSHOLD2
SUM DFAREP AS 'Fare Paid'
    DDIS AS 'Lost Savings'
    DNET AS 'Net Tickets'
COMPUTE LSPT/D12 =  IF ((DNET LT 1) AND (DNET GT (-1))) THEN 0 ELSE 
                       (DDIS/DNET); AS 'LS per Net ticket'
ACROSS TRAN AS ' '
ON GRAPH SET LOOKGRAPH VBAR2AX
ON GRAPH SET BARNUMB OFF
ON GRAPH SET 3D OFF
-* ON GRAPH SET VZERO ON
ON GRAPH SET GRID OFF
ON GRAPH SET GRAPHSTYLE *
setSeriesFillColor(0, new Color, 0 64 128));
setSeriesFillColor(1, new Color, 145 207 255));
setSeriesFillColor(2, new Color, 125 0 0));
setSeriesFillColor(3, new Color, 160 0 181));
setMarkerDisplay(true);
setUseSeriesShapes(true);
setConnectLineMarkers(true);
setSeriesType(0,1);
setSeriesType(1,1);
setSeriesType(2,2);
setSeriesType(3,2);
setO1MajorGridDisplay(false);
setO1MinorGridDisplay(false);
setY1MajorGridDisplay(false);
setY1MinorGridDisplay(false);
setY2MajorGridDisplay(false);
setY2MinorGridDisplay(false);
setO1LabelRotate(0);
setPieFeelerTextDisplay(1);
setPieLabelDisplay(0);
setTextFormatPreset(getPieSliceLabel(),1);
setRiserBorderMode(2);
setSeriesDefaultTransparentBorderColor(true);
setUseSeriesBorderDefaults(true);
setLegendDisplay(true);
setLegendPosition(1);
setLegendTextAutofix(true);
setLegendMarkersPerRow(2);
setTitleString("Lost Savings over $100");
setY1LabelDisplay(true);
setY1LabelFormat(###,###);
setY2LabelDisplay(true);
setY2LabelFormat(6);
setY1AxisSide(0);
setY2AxisSide(1);

setTextJustHoriz(getTitle(),1);
setFontSizeAbsolute(getTitle(),true); 
setFontStyle(getTitle(),0);
setFontSize(getTitle(),12);

setFontSizeAbsolute(getLegendText(),true);
setFontSizeAbsolute(getY1Title(),true);
setFontSizeAbsolute(getY1Label(),true);
setFontSizeAbsolute(getY2Title(),true);
setFontSizeAbsolute(getY2Label(),true);
setFontSizeAbsolute(getO1Title(),true);
setPlace(true);
ENDSTYLE
ON GRAPH HOLD AS LSG FORMAT SVG
END
-RUN

-SET &G_LSG=IF &LINES GT 0 THEN 'Y' ELSE 'N';
 -RUN
-AROUNDG

-SET &CNT = 1;
-REPEAT ENDINIT1 8 TIMES
-SET &TD.&CNT = ' ';
-SET &DS.&CNT = '$0';
-SET &FP.&CNT = '$0';
-SET &LS.&CNT = '$0';
-SET &NT.&CNT = '0';
-SET &CNT = &CNT + 1;
-ENDINIT1


-SET &CNT = 0;
-REPEAT TOEND &LINES TIMES
-SET &CNT = &CNT + 1;
-READ LS100 NOCLOSE &TD.7. &DS.12. &FP.12. &NT.12. &LS.12.

-SET &TD.&CNT = '  '|'&TD.EVAL';

EX FMTNUMBER VALUE=&DS,LEN=9
-RUN
-SET &DS.&CNT = &&RETVAL;

EX FMTNUMBER VALUE=&FP,LEN=9
-RUN
-SET &FP.&CNT = &&RETVAL;

EX FMTNUMBER VALUE=&NT,DOLLAR=N,LEN=9
-RUN
-SET &NT.&CNT = &&RETVAL;

EX FMTNUMBER VALUE=&LS,LEN=9
-RUN
-SET &LS.&CNT = &&RETVAL;

-TOEND 
-CLOSE LS100

-* Comments

-* Year to Year Comparison
DEFINE FILE LSHOLD2
CURRENT/A1 = IF TRN_DATE GE '&&FROMDT.EVAL' AND
                TRN_DATE LE '&&TODT.EVAL' THEN 'Y' ELSE 'N';
PRIOR/A1 =  IF TRN_DATE GE '&&FXDATE.EVAL' AND
               TRN_DATE LE '&&PYTDDATE.EVAL' THEN 'Y' ELSE 'N';
CNET/D12 = IF CURRENT EQ 'Y' THEN DNET ELSE 0;
PNET/D12 = IF PRIOR EQ 'Y' THEN DNET ELSE 0;
CLS/D12 = IF CURRENT EQ 'Y' THEN DDIS ELSE 0;
PLS/D12 = IF PRIOR EQ 'Y' THEN DDIS ELSE 0;
END
-RUN

TABLE FILE LSHOLD2
SUM CNET PNET CLS PLS
BY YEAR
ON TABLE HOLD AS COMHOLD1
END
-RUN

-SET &CLINEY1 = '';
-SET &CLINEY2 = '';
-SET &CLINEYA = '';
-SET &CLINEYB = '';

TABLE FILE COMHOLD1
SUM CLS
    PLS
    CNET
    PNET
COMPUTE FLAGPD/A1 = IF PLS EQ 0 THEN 'Y' ELSE 'N';
COMPUTE FLAGPN/A1 = IF PNET EQ 0 THEN 'Y' ELSE 'N';
COMPUTE DSPY/D4 = IF FLAGPD EQ 'N' THEN (CLS-PLS)/PLS * 100 ELSE 0;
COMPUTE NTPY/D4 = IF FLAGPN EQ 'N' THEN (CNET-PNET)/PNET * 100 ELSE 0;
COMPUTE ABSDSPY/D4 = ABS(DSPY);
COMPUTE ABSNTPY/D4 = ABS(NTPY);
COMPUTE DSCY/A12 = IF DSPY GT 0 THEN ' increased' ELSE IF DSPY LT 0 THEN ' decreased' ELSE 'remains same';
COMPUTE NTCY/A12 = IF NTPY GT 0 THEN ' increased' ELSE IF NTPY LT 0 THEN ' decreased' ELSE 'remains same';
ON TABLE SAVE AS LS100COMMENT 
END
-RUN

-IF &LINES EQ 0 THEN GOTO NOREADC;

-READ LS100COMMENT &X.48. &FLAGPD.1. &FLAGPN.1. &X.8. &ABSDSPY.4. &ABSNTPY.4. &DSCY.12. &NTCY.12. 

EX FMTNUMBER VALUE=&ABSDSPY,DOLLAR='N',ALIGNED='N'
-RUN
-SET &ABSDSPY = &&RETVAL;

EX FMTNUMBER VALUE=&ABSNTPY,DOLLAR='N',ALIGNED='N'
-RUN
-SET &ABSNTPY = &&RETVAL;

-SET &CLINEY1 =  IF &FLAGPD EQ 'N' THEN 'Lost Savings over  $100 &DSCY.EVAL' || ' &ABSDSPY.EVAL'||'%  year to date.' ELSE ' ';
-SET &CLINEY2 =  IF &FLAGPN EQ 'N' THEN 'Net tickets with a lost savings over  $100 &NTCY.EVAL' || ' &ABSNTPY.EVAL'||'%  year to date.' ELSE ' ';
-SET &CLINEYA = IF &ABSDSPY EQ 0 THEN ' ' ELSE &CLINEY1;
-SET &CLINEYB = IF &ABSNTPY EQ 0 THEN ' ' ELSE &CLINEY2;

-NOREADC
-****************************************************************
-* Added for need to show past 4 quarters
-****************************************************************

-SET &DS1A = IF '&TD1.EVAL' EQ ' ' THEN ' ' ELSE &DS1;
-SET &DS2A = IF &TD2 EQ ' ' THEN ' ' ELSE &DS2;
-SET &DS3A = IF &TD3 EQ ' ' THEN ' ' ELSE &DS3;
-SET &DS4A = IF &TD4 EQ ' ' THEN ' ' ELSE &DS4;
-SET &DS5A = IF &TD5 EQ ' ' THEN ' ' ELSE &DS5;
-SET &DS6A = IF &TD6 EQ ' ' THEN ' ' ELSE &DS6;
-SET &DS7A = IF &TD7 EQ ' ' THEN ' ' ELSE &DS7;
-SET &DS8A = IF &TD8 EQ ' ' THEN ' ' ELSE &DS8;

-SET &FP1A = IF &TD1 EQ ' ' THEN ' ' ELSE &FP1;
-SET &FP2A = IF &TD2 EQ ' ' THEN ' ' ELSE &FP2;
-SET &FP3A = IF &TD3 EQ ' ' THEN ' ' ELSE &FP3;
-SET &FP4A = IF &TD4 EQ ' ' THEN ' ' ELSE &FP4;
-SET &FP5A = IF &TD5 EQ ' ' THEN ' ' ELSE &FP5;
-SET &FP6A = IF &TD6 EQ ' ' THEN ' ' ELSE &FP6;
-SET &FP7A = IF &TD7 EQ ' ' THEN ' ' ELSE &FP7;
-SET &FP8A = IF &TD8 EQ ' ' THEN ' ' ELSE &FP8;

-SET &NT1A = IF &TD1 EQ ' ' THEN ' ' ELSE &NT1;
-SET &NT2A = IF &TD2 EQ ' ' THEN ' ' ELSE &NT2;
-SET &NT3A = IF &TD3 EQ ' ' THEN ' ' ELSE &NT3;
-SET &NT4A = IF &TD4 EQ ' ' THEN ' ' ELSE &NT4;
-SET &NT5A = IF &TD5 EQ ' ' THEN ' ' ELSE &NT5;
-SET &NT6A = IF &TD6 EQ ' ' THEN ' ' ELSE &NT6;
-SET &NT7A = IF &TD7 EQ ' ' THEN ' ' ELSE &NT7;
-SET &NT8A = IF &TD8 EQ ' ' THEN ' ' ELSE &NT8;

-SET &LS1A = IF &TD1 EQ ' ' THEN ' ' ELSE &LS1;
-SET &LS2A = IF &TD2 EQ ' ' THEN ' ' ELSE &LS2;
-SET &LS3A = IF &TD3 EQ ' ' THEN ' ' ELSE &LS3;
-SET &LS4A = IF &TD4 EQ ' ' THEN ' ' ELSE &LS4;
-SET &LS5A = IF &TD5 EQ ' ' THEN ' ' ELSE &LS5;
-SET &LS6A = IF &TD6 EQ ' ' THEN ' ' ELSE &LS6;
-SET &LS7A = IF &TD7 EQ ' ' THEN ' ' ELSE &LS7;
-SET &LS8A = IF &TD8 EQ ' ' THEN ' ' ELSE &LS8;

TABLE FILE BRPTINST
BY INST_KEY NOPRINT
ON TABLE SET PAGE-NUM OFF
&&OUTLINE1
&&OUTLINE2
FOOTING
"</37"
"<6 ________________________________________________________________________________________________________________________________________________<&POS9A "
"<6 |                  <&POS1A | <&POS1 &TD1 <&POS2A | <&POS2 &TD2 <&POS3A | <&POS3 &TD3 <&POS4A | <&POS4 &TD4 <&POS5A | <&POS5 &TD5 <&POS6A | <&POS6 &TD6 <&POS7A | <&POS7 &TD7 <&POS8A | <&POS8 &TD8 <&POS9A | "
"<6 |_______________________________________________________________________________________________________________________________________________<&POS9A |"
"<6 |Fare Paid         <&POS1A | <&POS1 &FP1A <&POS2A | <&POS2 &FP2A <&POS3A | <&POS3 &FP3A <&POS4A | <&POS4 &FP4A <&POS5A | <&POS5 &FP5A <&POS6A | <&POS6 &FP6A <&POS7A | <&POS7A &FP7A <&POS8A | <&POS8 &FP8A <&POS9A | "
"<6 |_______________________________________________________________________________________________________________________________________________<&POS9A |"
"<6 |Lost Savings      <&POS1A | <&POS1 &DS1A <&POS2A | <&POS2 &DS2A <&POS3A | <&POS3 &DS3A <&POS4A | <&POS4 &DS4A <&POS5A | <&POS5 &DS5A <&POS6A | <&POS6 &DS6A <&POS7A | <&POS7 &DS7A <&POS8A | <&POS8 &DS8A <&POS9A | "
"<6 |_______________________________________________________________________________________________________________________________________________<&POS9A |"
"<6 |Net Tickets       <&POS1A | <&POS1 &NT1A <&POS2A | <&POS2 &NT2A <&POS3A | <&POS3 &NT3A <&POS4A | <&POS4 &NT4A <&POS5A | <&POS5 &NT5A <&POS6A | <&POS6 &NT6A <&POS7A | <&POS7 &NT7A <&POS8A | <&POS8 &NT8A <&POS9A |"
"<6 |_______________________________________________________________________________________________________________________________________________<&POS9A |"
"<6 |LS Per Net Ticket Over $100<&POS1A | <&POS1 &LS1A <&POS2A | <&POS2 &LS2A <&POS3A | <&POS3 &LS3A <&POS4A | <&POS4 &LS4A <&POS5A | <&POS5 &LS5A <&POS6A | <&POS6 &LS6A <&POS7A | <&POS7 &LS7A <&POS8A | <&POS8 &LS8A <&POS9A |"
"<6 |_______________________________________________________________________________________________________________________________________________<&POS9A |"
" "
" "
"<14 &CLINEYA"
" "
"<14 &CLINEYB"
ON TABLE SET STYLE *
UNITS=IN, PAGESIZE='Letter', LEFTMARGIN=0.250000, RIGHTMARGIN=0.150000, 
    TOPMARGIN=0.500000, BOTTOMMARGIN=0.250000, SQUEEZE=ON, 
    ORIENTATION=LANDSCAPE, $
TYPE=REPORT, FONT=TIMES NEW ROMAN, SIZE=7, BACKCOLOR=NONE, STYLE=NORMAL, $
TYPE=FOOTING,FONT=COURIER NEW,$
TYPE=FOOTING, SIZE=15, LINE=51, OBJECT=TEXT, FONT=TIMES NEW ROMAN, $
TYPE=FOOTING, SIZE=15, LINE=52, OBJECT=TEXT, FONT=TIMES NEW ROMAN, $
TYPE=FOOTING, SIZE=15, LINE=53, OBJECT=TEXT, FONT=TIMES NEW ROMAN, $
TYPE=FOOTING, SIZE=15, LINE=54, OBJECT=TEXT, FONT=TIMES NEW ROMAN, $
TYPE=FOOTING, SIZE=15, LINE=55, OBJECT=TEXT, FONT=TIMES NEW ROMAN, $
TYPE=FOOTING, SIZE=15, LINE=56, OBJECT=TEXT, FONT=TIMES NEW ROMAN, $
TYPE=FOOTING, SIZE=15, LINE=57, OBJECT=TEXT, FONT=TIMES NEW ROMAN, $
TYPE=REPORT, IMAGE=LSA100.GIF,POSITION=(0.1 0.1), SIZE=(10.75 .75), $
-IF '&&SKIPGRAPH.EVAL' EQ 'Y' OR  &G_LSG EQ 'N' GOTO SKIP_DGAT3;
TYPE=REPORT,
IMAGE=LSG.SVG,
    POSITION=(1.6  1.0), SIZE=(6.5 3.5), $
-SKIP_DGAT3
ENDSTYLE
END
-RUN
