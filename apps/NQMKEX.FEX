-*****************************************************************************************************
-* New Quarterly Review Extract for Base and Peer
-*****************************************************************************************************
SET ASNAMES = ON
-SET HOLDATTR = ON;
-SET ECHO=ALL;
-SET &&BASE=' ';

DEFINE FILE MR_50
FARE_PAID/D12  = SEG_AMT + SEG_TAX;
MRK_TKT_CNT/D12   = IF (TICKET_CODE EQ '1') AND
                       (FARE_PAID GE 0) AND
                       (SEG_COUNT EQ 1) AND 
                       (CONJ_REL EQ 1) THEN 1 ELSE 
                     IF (TICKET_CODE EQ '1') AND
                        (EX_FLAG NE ' ') THEN (-1) ELSE 
                     IF (TICKET_CODE EQ '1') AND
                        (RF_FLAG NE ' ') THEN (-1) ELSE 0;
ROLL/A8 = IF ROLLUP_CODE EQ '&&BASEROLL.EVAL' THEN 'BASE' ELSE 'PEER';
-**********PRODUCES NON-DIRECTIONAL AIRPORT CODES*******
ND_APT_CDO/A25 = NDO_APT.ND_ORG;
ND_APT_CDD/A25 = NDD_APT.ND_DST;
-********* PRODUCES NON-DIRECTIONAL CITY NAMES ********
ND_CTY_NMO1/A25 = IF NDD_CTY.CITY_NAME LT NDO_CTY.CITY_NAME THEN NDD_CTY.CITY_NAME ELSE NDO_CTY.CITY_NAME;  
ND_CTY_NMD1/A25 = IF NDD_CTY.CITY_NAME GT NDO_CTY.CITY_NAME THEN NDD_CTY.CITY_NAME ELSE NDO_CTY.CITY_NAME;
-********* PRODUCES NON-DIRECTIONAL AIRPORT NAMES ********
ND_APT_NMO1/A25 = EDIT(NDO_APT.AIRPORT_NAME, '999999999999999999999$$$$');
ND_APT_NMD1/A25 = EDIT(NDD_APT.AIRPORT_NAME, '999999999999999999999$$$$');  
-**Defines on Previous
-* CITY_NM/A50 = ND_CTY_NMO|ND_CTY_NMD;
CITY_NM/A50 = ND_APT_CDO|ND_APT_CDD;
-******Define on Previous
ND_APT_NMO/A25 = LCWORD(25, ND_APT_NMO1, ND_APT_NMO);
ND_APT_NMD/A25 = LCWORD(25, ND_APT_NMD1, ND_APT_NMD);
-INCLUDE QRFTRANA
END
-RUN

-IF '&&ROLLUP.EVAL' EQ '&&BASEROLL.EVAL' THEN GOTO BASE ELSE GOTO PEER;
-RUN

-BASE
-******************************************************************************************
-* Base Company initial extract
-******************************************************************************************
TABLEF FILE MR_50
PRINT CITYPAIR.SEG_MILES/D12 AS 'MILES'	
      CITY_NM
      CITYPAIR.INTL_DOM AS 'INTL_DOM'
      CURRENT 
      FARE_PAID
      MRK_TKT_CNT
      ND_APT_NMO
      ND_APT_NMD
      PRIOR
      PYTD
      ROLL
WHERE (TRN_DATE GE '&&FROMDT.EVAL') AND (TRN_DATE LE '&&TODT.EVAL') OR
      (TRN_DATE GE '&&FXDATE.EVAL') AND (TRN_DATE LE '&&TXDATE.EVAL')
WHERE VOID_DATE EQ 0
-INCLUDE RPTPARMS
ON TABLE HOLD AS BASED1
END
-RUN
-GOTO BASE1;

-PEER
-******************************************************************************************
-* Peer Group initial extract
-******************************************************************************************
DEFINE FILE MR_50
-* CURRENT/A1 = IF TRN_DATE GE '&&FROMDT.EVAL' AND TRN_DATE LE '&&TODT.EVAL' THEN 'Y' ELSE 'N';
-* PRIOR/A1 = IF TRN_DATE GE '&&FXDATE.EVAL' AND TRN_DATE LE '&&TXDATE.EVAL' THEN 'Y' ELSE 'N';
FARE_PAID/D12  = SEG_AMT + SEG_TAX;
MRK_TKT_CNT/D12   = IF (TICKET_CODE EQ '1') AND
                       (FARE_PAID GE 0) AND
                       (SEG_COUNT EQ 1) AND 
                       (CONJ_REL EQ 1) THEN 1 ELSE 
                     IF (TICKET_CODE EQ '1') AND
                        (EX_FLAG NE ' ') THEN (-1) ELSE 
                     IF (TICKET_CODE EQ '1') AND
                        (RF_FLAG NE ' ') THEN (-1) ELSE 0;
ROLL/A8 = IF ROLLUP_CODE EQ '&&BASEROLL.EVAL' THEN 'BASE' ELSE '&&ROLLUP.EVAL';
-**********PRODUCES NON-DIRECTIONAL AIRPORT CODES*******
ND_APT_CDO/A25 = NDO_APT.ND_ORG;
ND_APT_CDD/A25 = NDD_APT.ND_DST;
-********* PRODUCES NON-DIRECTIONAL CITY NAMES ********
ND_CTY_NMO1/A25 = IF NDD_CTY.CITY_NAME LT NDO_CTY.CITY_NAME THEN NDD_CTY.CITY_NAME ELSE NDO_CTY.CITY_NAME;  
ND_CTY_NMD1/A25 = IF NDD_CTY.CITY_NAME GT NDO_CTY.CITY_NAME THEN NDD_CTY.CITY_NAME ELSE NDO_CTY.CITY_NAME;
-********* PRODUCES NON-DIRECTIONAL AIRPORT NAMES ********
ND_APT_NMO1/A25 = EDIT(NDO_APT.AIRPORT_NAME, '999999999999999999999$$$$');
ND_APT_NMD1/A25 = EDIT(NDD_APT.AIRPORT_NAME, '999999999999999999999$$$$');  
-**Defines on Previous
-* CITY_NM/A50 = ND_CTY_NMO|ND_CTY_NMD;
CITY_NM/A50 = ND_APT_CDO|ND_APT_CDD;
-******Define on Previous
ND_APT_NMO/A25 = LCWORD(25, ND_APT_NMO1, ND_APT_NMO);
ND_APT_NMD/A25 = LCWORD(25, ND_APT_NMD1, ND_APT_NMD);
-INCLUDE QRFTRANA
END
-RUN

TABLEF FILE MR_50
PRINT CITYPAIR.SEG_MILES/D12 AS 'MILES'	
      CITY_NM
      CITYPAIR.INTL_DOM AS 'INTL_DOM'
      CURRENT
      FARE_PAID
      MRK_TKT_CNT
      ND_APT_NMO
      ND_APT_NMD
      PRIOR
      PYTD
      ROLL
WHERE (TRN_DATE GE '&&FROMDT.EVAL') AND (TRN_DATE LE '&&TODT.EVAL') OR
      (TRN_DATE GE '&&FXDATE.EVAL') AND (TRN_DATE LE '&&TXDATE.EVAL')
WHERE VOID_DATE EQ 0
WHERE ROLL NE 'BASE'
ON TABLE HOLD AS PEERD1
END
-RUN

-IF &LINES EQ 0 THEN GOTO NEXTONE;

-GOTO PEER1;


-BASE1
-********************************************************************
-* BASE Current Top 10 Domestic Markets
-********************************************************************
TABLE FILE BASED1
SUM FARE_PAID AS 'BCDFARE'
    MILES AS 'BCDMILE'
    MRK_TKT_CNT AS 'BCDMKT'
    PYTD
BY ROLL
BY CITY_NM
BY ND_APT_NMO
BY ND_APT_NMD
WHERE CURRENT EQ 'Y'
WHERE INTL_DOM EQ 'D'
WHERE ROLL EQ 'BASE'
ON TABLE HOLD AS BASED2
END
-RUN


TABLE FILE BASED2
PRINT BCDFARE
      BCDMILE
      BCDMKT
      CITY_NM 
      ND_APT_NMO
      ND_APT_NMD
      PYTD
      ROLL
RANKED BY HIGHEST BCDMKT
ON TABLE HOLD AS BASED3
END
-RUN

DEFINE FILE BASED3
 ORG_LIMIT/I2 = 10;
 OLIMIT/A2    = EDIT(ORG_LIMIT) ;
 CRANK/D5     = RANK;
 BRANK/A6     = FTOA(CRANK, '(D5)', 'A6');
 LIST/D6 = IF CITY_NM NE LAST CITY_NM THEN (LAST LIST + 1) 
           ELSE LAST LIST;
 FRANKX/A7 = FTOA(LIST, '(D6)', 'A7');
 FRANK/A6  = EDIT(FRANKX,'$999999'); 
 ORG_VALUE/A9 = IF ORG_LIMIT EQ 0 THEN BRANK ELSE
                IF LIST GT ORG_LIMIT THEN 'ALL OTHER' ELSE FRANK;
END
-RUN

TABLE FILE BASED3
SUM BCDFARE
    BCDMILE
    BCDMKT
    OLIMIT
    PYTD
BY ROLL
BY ORG_VALUE
BY CITY_NM
BY ND_APT_NMO
BY ND_APT_NMD
ON TABLE HOLD AS BASED4
END
-RUN

DEFINE FILE BASED4
ORG_PRINT/A50 =IF ORG_VALUE LT (OLIMIT) THEN CITY_NM ELSE 'All Other';
ORG_PRINT1/A25 = IF ORG_VALUE LT (OLIMIT) THEN ND_APT_NMO ELSE 'All Other';
DST_PRINT1/A25 = IF ORG_VALUE LT (OLIMIT) THEN ND_APT_NMD ELSE 'All Other';
END

TABLE FILE BASED4
SUM BCDFARE
    BCDMILE
    BCDMKT
    PYTD
BY ROLL
BY ORG_VALUE
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS BASED5
END
-RUN


TABLE FILE BASED5
PRINT ROLL ORG_PRINT1 DST_PRINT1 ORG_VALUE BCDFARE BCDMILE BCDMKT PYTD
ON TABLE SAVE
END
-RUN


MODIFY FILE QRMKTD
FIXFORM ROLL/8 ORG_PRINT1/25 DST_PRINT1/25 ORG_VALUE/9 BCDFARE/12 BCDMILE/12 BCDMKT/12 PYTD/1
MATCH ROLL ORG_PRINT1 DST_PRINT1
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN


-*************************************************************************
-*Prior Domestic Matching Markets
-*************************************************************************
TABLE FILE BASED1
SUM FARE_PAID AS 'BPDFARE'
    MILES AS 'BPDMILE'
    MRK_TKT_CNT AS 'BPDMKT'
BY ROLL
BY CITY_NM AS 'ORG_PRINT'
BY ND_APT_NMO AS 'ORG_PRINT1'
BY ND_APT_NMD AS 'DST_PRINT1'
WHERE PRIOR EQ 'Y'
WHERE ROLL EQ 'BASE'
WHERE INTL_DOM EQ 'D'
ON TABLE HOLD AS PBASED1
END
-RUN

TABLE FILE PBASED1
PRINT BPDFARE
      BPDMILE
      BPDMKT
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PBASED2
END
-RUN

DEFINE FILE BASED5
CNAME/A52 = '''' |ORG_PRINT|'''';
END
-RUN

TABLE FILE BASED5
PRINT CNAME
BY ORG_PRINT NOPRINT
ON TABLE SAVE AS BMKT
END
-RUN

DEFINE FILE PBASED2
ORG_VALUE/A9 = '12';
END
-RUN

TABLE FILE PBASED2
SUM BPDFARE
    BPDMILE
    BPDMKT
BY ROLL
BY ORG_VALUE
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
WHERE ORG_PRINT IN FILE BMKT
ON TABLE HOLD AS PTCITY 
END
-RUN

TABLE FILE PTCITY
PRINT BPDFARE
      BPDMILE
      BPDMKT
BY ROLL
BY ORG_VALUE
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PTCITY1 
END
-RUN

TABLE FILE PTCITY1
PRINT ROLL ORG_PRINT1 DST_PRINT1 ORG_VALUE BPDFARE BPDMILE BPDMKT
ON TABLE SAVE
END
-RUN

MODIFY FILE QRMKTD
FIXFORM ROLL/8 ORG_PRINT1/25 DST_PRINT1/25 ORG_VALUE/9 BPDFARE/12 BPDMILE/12 BPDMKT/12 
MATCH ROLL ORG_PRINT1 DST_PRINT1
ON MATCH UPDATE BPDFARE BPDMILE BPDMKT
ON NOMATCH REJECT
DATA ON SAVE
END
-RUN


-************************************************************************
-* Prior Domestic All Other
-************************************************************************

DEFINE FILE PBASED2
FLAG/A50 = 'All Other';
END
-RUN
TABLE FILE PBASED2
SUM BPDFARE
    BPDMILE
    BPDMKT
BY ROLL
BY FLAG AS 'ORG_PRINT'
WHERE NOT ORG_PRINT IN FILE BMKT
ON TABLE HOLD AS PALLO 
END
-RUN


DEFINE FILE PALLO
ORG_PRINT1/A25 = 'All Other';
DST_PRINT1/A25 = 'All Other';
END
-RUN
TABLE FILE PALLO
SUM BPDFARE
    BPDMILE
    BPDMKT
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PALLO1
END
-RUN

TABLE FILE PALLO1
PRINT ROLL ORG_PRINT1 DST_PRINT1 BPDFARE BPDMILE BPDMKT
ON TABLE SAVE
END
-RUN

MODIFY FILE QRMKTD
FIXFORM ROLL/8 ORG_PRINT1/25 DST_PRINT1/25 BPDFARE/12 BPDMILE/12 BPDMKT/12 
MATCH ROLL ORG_PRINT1 DST_PRINT1
ON MATCH UPDATE BPDFARE BPDMILE BPDMKT
ON NOMATCH REJECT
DATA ON SAVE
END
-RUN


-GOTO BASEINTL;

-PEER1;
-******************************************************************************************************
-* Current and Prior Peer Group Matching Domestic Markets
-******************************************************************************************************
DEFINE FILE PEERD1
PCDFARE/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND CURRENT EQ 'Y' THEN FARE_PAID ELSE 0;
PCDMILE/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND CURRENT EQ 'Y' THEN MILES ELSE 0;
PCDMKT/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND CURRENT EQ 'Y' THEN MRK_TKT_CNT ELSE 0;
PPDFARE/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND PRIOR EQ 'Y' THEN FARE_PAID ELSE 0;
PPDMILE/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND PRIOR EQ 'Y' THEN MILES ELSE 0;
PPDMKT/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND PRIOR EQ 'Y' THEN MRK_TKT_CNT ELSE 0;
END
-RUN

TABLE FILE PEERD1
SUM PCDFARE
    PCDMILE
    PCDMKT
    PPDFARE
    PPDMILE
    PPDMKT    
BY ROLL
BY CITY_NM AS 'ORG_PRINT'
BY ND_APT_NMO AS 'ORG_PRINT1'
BY ND_APT_NMD AS 'DST_PRINT1'
WHERE INTL_DOM EQ 'D'
ON TABLE HOLD AS PEERD2
END
-RUN


TABLE FILE PEERD2
PRINT PCDFARE
      PCDMILE
      PCDMKT
      PPDFARE
      PPDMILE
      PPDMKT    
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PEERD3
END
-RUN

-***************************************************************************
-*Peer Current/Prior Top 10 Cities
-***************************************************************************
TABLE FILE PEERD3
SUM PCDFARE
    PCDMILE
    PCDMKT
    PPDFARE
    PPDMILE
    PPDMKT   
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
WHERE ORG_PRINT IN FILE BMKT
ON TABLE HOLD AS PCUR1
END
-RUN


TABLE FILE PCUR1
PRINT PCDFARE
      PCDMILE
      PCDMKT
      PPDFARE
      PPDMILE
      PPDMKT   
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PCUR2 
END
-RUN


TABLE FILE PCUR2
PRINT ROLL ORG_PRINT1 DST_PRINT1 PCDFARE PCDMILE PCDMKT PPDFARE PPDMILE PPDMKT
ON TABLE SAVE
END
-RUN

MODIFY FILE QRMKTD
FIXFORM ROLL/8 ORG_PRINT1/25 DST_PRINT1/25 PCDFARE/12 PCDMILE/12 PCDMKT/12 PPDFARE/12 PPDMILE/12 PPDMKT/12
MATCH ROLL ORG_PRINT1 DST_PRINT1
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN

-************************************************************************
-* Peer Current All Other
-************************************************************************

DEFINE FILE PEERD2
FLAG/A50 = 'All Other';
END
-RUN
TABLE FILE PEERD2
SUM PCDFARE
    PCDMILE
    PCDMKT
    PPDFARE
    PPDMILE
    PPDMKT   
BY ROLL
BY FLAG AS 'ORG_PRINT'
WHERE NOT ORG_PRINT IN FILE BMKT
ON TABLE HOLD AS PEERAO1
END
-RUN

DEFINE FILE PEERAO1
ORG_PRINT1/A25 = 'All Other';
DST_PRINT1/A25 = 'All Other';
END
-RUN
TABLE FILE PEERAO1
SUM PCDFARE
    PCDMILE
    PCDMKT
    PPDFARE
    PPDMILE
    PPDMKT   
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PEERAO2
END
-RUN

TABLE FILE PEERAO2
PRINT ROLL ORG_PRINT1 DST_PRINT1 PCDFARE PCDMILE PCDMKT PPDFARE PPDMILE PPDMKT
ON TABLE SAVE
END
-RUN


MODIFY FILE QRMKTD
FIXFORM ROLL/8 ORG_PRINT1/25 DST_PRINT1/25 PCDFARE/12 PCDMILE/12 PCDMKT/12 PPDFARE/12 PPDMILE/12 PPDMKT/12
MATCH ROLL ORG_PRINT1 DST_PRINT1
-* ON MATCH UPDATE PCDFARE PCDMILE PCDMKT PPDFARE PPDMILE PPDMKT
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN

-GOTO PEERINTL;

-BASEINTL;
-********************************************************************************
-* Base Company Top 5 Intl Cities
-********************************************************************************
TABLE FILE BASED1
SUM FARE_PAID AS 'BCIFARE'
    MILES AS 'BCIMILE'
    MRK_TKT_CNT AS 'BCIMKT'
    PYTD
BY ROLL
BY CITY_NM
BY ND_APT_NMO
BY ND_APT_NMD
WHERE CURRENT EQ 'Y'
WHERE INTL_DOM EQ 'I'
WHERE ROLL EQ 'BASE'
ON TABLE HOLD AS BASEI2
END
-RUN


-SET &&NOINTL = IF &RECORDS EQ 0 THEN 'Y' ELSE 'N';
-IF &RECORDS EQ 0 THEN GOTO XXIT;
-RUN

TABLE FILE BASEI2
PRINT BCIFARE
      BCIMILE
      BCIMKT
      CITY_NM 
      ND_APT_NMO
      ND_APT_NMD
      ROLL 
      PYTD
RANKED BY HIGHEST BCIMKT
ON TABLE HOLD AS BASEI3
END
-RUN


DEFINE FILE BASEI3
 ORG_LIMIT/I2 = 5;
 OLIMIT/A2    = EDIT(ORG_LIMIT) ;
 CRANK/D5     = RANK;
 BRANK/A6     = FTOA(CRANK, '(D5)', 'A6');
 LIST/D6 = IF CITY_NM NE LAST CITY_NM THEN (LAST LIST + 1) 
           ELSE LAST LIST;
 FRANKX/A7 = FTOA(LIST, '(D6)', 'A7');
 FRANK/A6  = EDIT(FRANKX,'$999999'); 
 ORG_VALUE/A9 = IF ORG_LIMIT EQ 0 THEN BRANK ELSE
                IF LIST GT ORG_LIMIT THEN 'ALL OTHER' ELSE FRANK;
END
-RUN

TABLE FILE BASEI3
SUM BCIFARE
    BCIMILE
    BCIMKT
    OLIMIT
    PYTD
BY ROLL
BY ORG_VALUE
BY CITY_NM
BY ND_APT_NMO
BY ND_APT_NMD
ON TABLE HOLD AS BASEI4
END
-RUN

DEFINE FILE BASEI4
ORG_PRINT/A50 =IF ORG_VALUE LT (OLIMIT) THEN CITY_NM ELSE 'All Other';
ORG_PRINT1/A25 = IF ORG_VALUE LT (OLIMIT) THEN ND_APT_NMO ELSE 'All Other';
DST_PRINT1/A25 = IF ORG_VALUE LT (OLIMIT) THEN ND_APT_NMD ELSE 'All Other';
END

TABLE FILE BASEI4
SUM BCIFARE
    BCIMILE
    BCIMKT
    PYTD
BY ROLL
BY ORG_VALUE
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS BASEI5
END
-RUN

TABLE FILE BASEI5
PRINT ROLL ORG_PRINT1 DST_PRINT1 ORG_VALUE BCIFARE BCIMILE BCIMKT PYTD
ON TABLE SAVE
END
-RUN

MODIFY FILE QRMKTI
FIXFORM ROLL/8 ORG_PRINT1/25 DST_PRINT1/25 ORG_VALUE/9 BCIFARE/12 BCIMILE/12 BCIMKT/12 PYTD/1
MATCH ROLL ORG_PRINT1 DST_PRINT1
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN

-*************************************************************************
-*Prior International Matching Markets
-*************************************************************************
TABLE FILE BASED1
SUM FARE_PAID AS 'BPIFARE'
    MILES AS 'BPIMILE'
    MRK_TKT_CNT AS 'BPIMKT'
BY ROLL
BY CITY_NM AS 'ORG_PRINT'
BY ND_APT_NMO AS 'ORG_PRINT1'
BY ND_APT_NMD AS 'DST_PRINT1'
WHERE PRIOR EQ 'Y'
WHERE ROLL EQ 'BASE'
WHERE INTL_DOM EQ 'I'
ON TABLE HOLD AS PBASEI1
END
-RUN

TABLE FILE PBASEI1
PRINT BPIFARE
      BPIMILE
      BPIMKT
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PBASEI2
END
-RUN

DEFINE FILE BASEI5
CNAME/A52 = '''' |ORG_PRINT|'''';
END
-RUN

TABLE FILE BASEI5
PRINT CNAME
BY ORG_PRINT NOPRINT
ON TABLE SAVE AS BMKTI
END
-RUN

-**********************************************************************
-*Prior International Matching Top 5 Cities
-**********************************************************************
TABLE FILE PBASEI2
SUM BPIFARE
    BPIMILE
    BPIMKT
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
WHERE ORG_PRINT IN FILE BMKTI
ON TABLE HOLD AS PTCITY 
END
-RUN

TABLE FILE PTCITY
PRINT BPIFARE
      BPIMILE
      BPIMKT
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PTCITY1 FORMAT FOCUS
END
-RUN

TABLE FILE PTCITY1
PRINT ROLL ORG_PRINT1 DST_PRINT1 BPIFARE BPIMILE BPIMKT
ON TABLE SAVE
END
-RUN

MODIFY FILE QRMKTI
FIXFORM ROLL/8 ORG_PRINT1/25 DST_PRINT1/25 BPIFARE/12 BPIMILE/12 BPIMKT/12 
MATCH ROLL ORG_PRINT1 DST_PRINT1
ON MATCH UPDATE BPIFARE BPIMILE BPIMKT
DATA ON SAVE
END
-RUN

-************************************************************************
-* Prior International All Other
-************************************************************************

DEFINE FILE PBASEI2
FLAG/A50 = 'All Other';
END
-RUN
TABLE FILE PBASEI2
SUM BPIFARE
    BPIMILE
    BPIMKT
BY ROLL
BY FLAG AS 'ORG_PRINT'
WHERE NOT ORG_PRINT IN FILE BMKTI
ON TABLE HOLD AS PALLO 
END
-RUN

DEFINE FILE PALLO
ORG_PRINT1/A25 = 'All Other';
DST_PRINT1/A25 = 'All Other';
END
-RUN
TABLE FILE PALLO
SUM BPIFARE
    BPIMILE
    BPIMKT
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PALLO1
END
-RUN

TABLE FILE PALLO1
PRINT ROLL ORG_PRINT1 DST_PRINT1 BPIFARE BPIMILE BPIMKT
ON TABLE SAVE
END
-RUN

MODIFY FILE QRMKTI
FIXFORM ROLL/8 ORG_PRINT1/25 DST_PRINT1/25 BPIFARE/12 BPIMILE/12 BPIMKT/12 
MATCH ROLL ORG_PRINT1 DST_PRINT1
ON MATCH UPDATE BPIFARE BPIMILE BPIMKT
DATA ON SAVE
END
-RUN
-GOTO XXIT;


-PEERINTL;

-IF '&&NOINTL.EVAL' EQ 'Y' THEN GOTO XXIT;
-******************************************************************************************************
-* Current and Prior Peer Group Matching International Markets
-******************************************************************************************************
DEFINE FILE PEERD1
PCIFARE/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND CURRENT EQ 'Y' THEN FARE_PAID ELSE 0;
PCIMILE/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND CURRENT EQ 'Y' THEN MILES ELSE 0;
PCIMKT/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND CURRENT EQ 'Y' THEN MRK_TKT_CNT ELSE 0;
PPIFARE/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND PRIOR EQ 'Y' THEN FARE_PAID ELSE 0;
PPIMILE/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND PRIOR EQ 'Y' THEN MILES ELSE 0;
PPIMKT/D12 = IF '&&ROLLUP.EVAL' NE '&&BASEROLL.EVAL' AND PRIOR EQ 'Y' THEN MRK_TKT_CNT ELSE 0;
END
-RUN
TABLE FILE PEERD1
SUM PCIFARE
    PCIMILE
    PCIMKT
    PPIFARE
    PPIMILE
    PPIMKT    
BY ROLL
BY CITY_NM AS 'ORG_PRINT'
BY ND_APT_NMO AS 'ORG_PRINT1'
BY ND_APT_NMD AS 'DST_PRINT1'
WHERE INTL_DOM EQ 'I'
ON TABLE HOLD AS PEERI2
END
-RUN

TABLE FILE PEERI2
PRINT PCIFARE
      PCIMILE
      PCIMKT
      PPIFARE
      PPIMILE
      PPIMKT    
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PEERI3
END
-RUN

-***************************************************************************
-*Peer Current/Prior Top 5 Cities
-***************************************************************************
TABLE FILE PEERI3
SUM PCIFARE
    PCIMILE
    PCIMKT
    PPIFARE
    PPIMILE
    PPIMKT   
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
WHERE ORG_PRINT IN FILE BMKTI
ON TABLE HOLD AS PCURI1
END
-RUN


TABLE FILE PCURI1
PRINT ROLL ORG_PRINT1 DST_PRINT1 PCIFARE PCIMILE PCIMKT PPIFARE PPIMILE PPIMKT  
ON TABLE SAVE
END
-RUN

MODIFY FILE QRMKTI
FIXFORM ROLL/8 ORG_PRINT1/25 DST_PRINT1/25 PCIFARE/12 PCIMILE/12 PCIMKT/12 PPIFARE/12 PPIMILE/12 PPIMKT/12
MATCH ROLL ORG_PRINT1 DST_PRINT1
ON MATCH UPDATE PCIFARE PCIMILE PCIMKT PPIFARE PPIMILE PPIMKT
-* ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN

-************************************************************************
-* Peer Current All Other
-************************************************************************

DEFINE FILE PEERI2
FLAG/A50 = 'All Other';
END
-RUN
TABLE FILE PEERI2
SUM PCIFARE
    PCIMILE
    PCIMKT
    PPIFARE
    PPIMILE
    PPIMKT   
BY ROLL
BY FLAG AS 'ORG_PRINT'
WHERE NOT ORG_PRINT IN FILE BMKTI
ON TABLE HOLD AS PEERAO1I
END
-RUN

DEFINE FILE PEERAO1I
ORG_PRINT1/A25 = 'All Other';
DST_PRINT1/A25 = 'All Other';
END
-RUN
TABLE FILE PEERAO1I
SUM PCIFARE
    PCIMILE
    PCIMKT
    PPIFARE
    PPIMILE
    PPIMKT   
BY ROLL
BY ORG_PRINT
BY ORG_PRINT1
BY DST_PRINT1
ON TABLE HOLD AS PEERAO2I
END
-RUN

TABLE FILE PEERAO2I
PRINT ROLL ORG_PRINT1 DST_PRINT1 PCIFARE PCIMILE PCIMKT PPIFARE PPIMILE PPIMKT   
ON TABLE SAVE
END
-RUN

MODIFY FILE QRMKTI
FIXFORM ROLL/8 ORG_PRINT1/25 DST_PRINT1/25 PCIFARE/12 PCIMILE/12 PCIMKT/12 PPIFARE/12 PPIMILE/12 PPIMKT/12
MATCH ROLL ORG_PRINT1 DST_PRINT1
ON MATCH UPDATE PCIFARE PCIMILE PCIMKT PPIFARE PPIMILE PPIMKT
ON NOMATCH INCLUDE
DATA ON SAVE 
END
-RUN

-NEXTONE

-XXIT;
