-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-INCLUDE SETECHO
-EXIT
-* File RESTART.FEX
-*****************************************************************
-* Last to execute in a report stream or other major process 
-* - cleans up allocations and the FocStack, and restarts the
-* originating procedure

-DEFAULT &ZSKEY='X';
-DEFAULT &&SET_DONE = 'N';

-TYPE &&NOW_CYC Inside Restart

-**********DETERMINE DATE AND TIME FOR FILE TO SAVE
-SET &NOWTM = HHMMSS ('A8');
-SET &NOWTM = EDIT(&NOWTM,'99$99$99');
-SET &NOWDT = &YYMD;
-SET &NOWDTTM = &NOWDT || '_' || &NOWTM;

FILEDEF ZIPCHECK CLEAR
-RUN
-SET &ZCHECK=&&WEB_PATH || 'ZIPCHECK.FTM';

FILEDEF ZIPCHECK DISK &ZCHECK.EVAL
-RUN
-WRITE ZIPCHECK XXXXXXXXXXXXXXXXXXXX
-RUN

-IF &&NOW_CYC EQ 'NOW' THEN GOTO REDO_SET;
-IF &&NOW_CYC EQ 'CYC' THEN GOTO REDO_CYC;
-IF &&NOW_CYC EQ 'HPF' THEN GOTO REDO_HPF;
-IF &&NOW_CYC EQ 'SRV' THEN GOTO REDO_SRV;
-RUN



-REDO_SET

-TYPE Before RPT_END

-*RUN RPT_END
EX RPT_END
-RUN
-IF EDIT(&&OUTTO,'$9') EQ 'B' GOTO SET_CONT;

-IF EDIT(&&OUTTO,'9') EQ 'T' GOTO SET_CONT;

-IF EDIT(&&OUTTO,'9') EQ 'F' GOTO SET_FTP;

-* EMAIL REPORTS
-SET &GROUPNAME = &&IRN ||
- &NOWDTTM || '.ZIP';

-SET &&USEMPATH = 
- &&MAILPATH;
-INCLUDE MAILFILE

-GOTO SET_CONT;


-SET_FTP
-* FTP REPORTS
-INCLUDE FTPFILE

-SET_CONT
-SET &&SET_DONE = 'Y';

-TYPE Before RESET
EX RESET
-EXIT
-**********************************************



-REDO_CYC

FILEDEF INSTPASS DISK &&INSTPASS
-RUN
-WRITE INSTPASS xxxxxxxx
-RUN

-TYPE Before RPT_END



-* RUN RPT_END
EX RPT_END
-RUN
-READ ZIPCHECK &ZUID.A20 &ZSKEY.A30

-* THIS IF STATEMENT WILL HANDLE THE REPORTS THAT WERE SCHEDULED FOR EMAIL
-* BUT WERE NOT PART OF A REPORT SET SCHEDULE.
-IF &&SETZIP EQ 'N'  AND EDIT(&&OUTTO,'9') EQ 'E' GOTO EMAIL_INST;

-*-IF EDIT(&&OUTTO,'9') EQ 'T' GOTO CHECK_ZIP;
-IF EDIT(&&OUTTO,'9') EQ 'T' GOTO SKIP_ZCHECK;

-IF EDIT(&&OUTTO,'9') NE 'F' GOTO CHECK_ZIP;



-* FTP REPORTS
-INCLUDE FTPFILE

-*************************************
-* THIS IS TO EMAIL THE REPORTS THAT WERE SCHEDULED AS A REPORT SET.
-CHECK_ZIP

-IF &&SETZIP EQ 'N' GOTO SKIP_ZCHECK;
-IF &ZSKEY EQ 'X' GOTO SKIP_ZCHECK;
-SET &&SET_DONE = 'Y';
-*-DOS IF EXIST &&SEPATH GOTO DIR_EXIST ;
-*-GOTO SKIP_ZCHECK;
-*-DOS :DIR_EXIST

-*****************************************************************
-* EMAIL REPORT SET
-ZIP_FILES
-*****************************************************************

-* THIS REPEAT LOOP WILL CHANGE ALL NON-ALPHA-NUMERIC CHARACTERS TO
-* UNDERSCORES FOR THE REPORT SET NAME .  
-SET &RSLENX=&&RS.LENGTH;
-SET &RSLEN=ARGLEN(40, &&RS, 'I3');
-SET &RSLEN=IF &RSLENX LT &RSLEN THEN &RSLENX ELSE &RSLEN;
-SET &IRS=&&RS;
-REPEAT RSETLOOP &RSLEN TIMES;
-SET &RSCHK=CHKFMT(&RSLEN, &IRS, 
- 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX', 'I3');
-IF &RSCHK EQ 0 GOTO ENDRSET;
-SET &BADCHAR=SUBSTR(&RSLEN, &IRS, &RSCHK, &RSCHK, 1, 'A1');
-SET &BCDVAL=BYTVAL(&BADCHAR,'I3');
-SET &IRS = CTRAN(&RSLEN, &IRS, &BCDVAL, 122, 'A40');
-RSETLOOP 
-ENDRSET

-SET &GROUPNAME = CTRAN(&RSLEN, &IRS, 122, 95, 'A40') ||
- &NOWDTTM || '.ZIP';

-SET &&USEMPATH = 
- &&SETMPATH;
-SET &&TEMPPATH = &&SEPATH;
-INCLUDE MAILFILE

-GOTO SKIP_ZCHECK



* EMAIL REPORTS THAT WERE NOT SCHEDULED AS A SET
-EMAIL_INST
-SET &GROUPNAME = &&IRN ||
- &NOWDTTM || '.ZIP';

-SET &&USEMPATH = 
- &&MAILPATH;
-INCLUDE MAILFILE

-SKIP_ZCHECK
-SKIPABC

-*EX RESET
-RUN

EX RUN_SET
-EXIT
-**********************************************




-REDO_HPF

FILEDEF INSTPASS DISK &&INSTPASS
-RUN
-WRITE INSTPASS xxxxxxxx
-RUN

-TYPE Before turning main buttons back on
-RUN

-TYPE Before RESET
EX RESET
-EXIT
-**********************************************




-REDO_SRV

FILEDEF INSTPASS DISK &&INSTPASS
-RUN
-WRITE INSTPASS xxxxxxxx
-RUN

-TYPE Before RPT_END

-*RUN RPT_END
EX RPT_END
-RUN

EX SERV_SET
-EXIT
-**********************************************



-XXIT


