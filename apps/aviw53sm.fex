-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-INCLUDE SETECHO
-* File SMRYRPT.FEX 
-**********************************************************************
-* Joy - 6/10/13 Added logic for norecords 
-*  02/02/2015  REJ  S-05681 Changes to the no data report to prepare for the Available
-*                           Report changes.  Rollup Code is being removed from BRPTINST in
-*                           ER5, so I'm removing the reference to the ROLLUP_CODE in that report.
-*7/21/16 S-20630 DLV - Carried through EMP_ID  
-*7/21/16 S-20630 DLV - Changed LEVEL2 to EMP_ID for HDTOPLHB
-*                      commented out UDHDREMP
-*03/17/17 S-31790 DLV - Changed to use new hotel attachment logic
-*4/24/2017-JEM-S-33318-updated logic for no records report
-* 08/08/2017 RSB S-38044 Place the footer datetime stamp text in a separate file to be -INCLUDED in the stylesheets
-*                         Added: -SET &FTR_AddlLines = #;
-**********************************************************************

SET ASNAMES = ON
-RUN


-*-INCLUDE LOHTLSM
-*-RUN

-* -IF '&&NOHSMREC.EVAL' EQ 'Y' THEN GOTO NORECORDS;

-SET &&RPTSUF = 'SMY';
-INCLUDE FDEFRPTS
-RUN

-IF '&&SETF.EVAL' NE 'HDTOPLHB' THEN GOTO NEXTset;

-SET &&RANK_LIMIT = 200;
-SET &&RANK_METH = HBPCT;

-SET &WHERE1 = 'WHERE HTL_NOATTCH GE 3';

-GOTO Skip;

-NEXTset
 
-SET &&RANK_LIMIT = 100;
-SET &&RANK_METH = HBPCT;
-SET &WHERE1 = ' ';

-GOTO Skip;
DEFINE FILE &&RPT_HOLD
 HTL_ATTCH  /I9 = IF (NET_TKT_CNT GT 0) AND (HOTEL_FLAG EQ 'Y') THEN 1 ELSE 0;
 HTL_NOATTCH/I9 = IF (NET_TKT_CNT GT 0) AND (HOTEL_FLAG EQ 'N') THEN 1 ELSE 0;
END
-*
TABLE FILE &&RPT_HOLD
PRINT NET_TKT_CNT
      HOTEL_FLAG
      STAY
      HTL_ATTCH
      HTL_NOATTCH
BY LEVEL_DESC
BY PASSNGR_NAME
BY TKT_NUM
BY TRN_DATE
ON TABLE HOLD AS AIRHLDH1
END
-RUN



-Skip
DEFINE FILE &&RPT_HOLD
 HTL_ATTCH  /I9 = IF (NET_TKT_CNT GT 0) AND (HOTEL_FLAG EQ 'Y') THEN 1 ELSE 0;
 HTL_NOATTCH/I9 = IF (NET_TKT_CNT GT 0) AND (HOTEL_FLAG EQ 'N') THEN 1 ELSE 0;
END
-*
TABLE FILE &&RPT_HOLD
PRINT NET_TKT_CNT
      HOTEL_FLAG
      STAY
      HTL_ATTCH
      HTL_NOATTCH
      EMP_ID
      NOHTL_KEY
BY LEVEL_DESC
BY PASSNGR_NAME
BY TKT_NUM
BY TRN_DATE
ON TABLE HOLD AS AIRHLDH1
END
-RUN


TABLE FILE AIRHLDH1
SUM HTL_ATTCH/D9
    HTL_NOATTCH/D9
    NET_TKT_CNT
COMPUTE TOT_ATTCH/I9 = HTL_ATTCH+HTL_NOATTCH;
COMPUTE HBPCT/F6%= IF HTL_ATTCH EQ 0 THEN 0 ELSE
                  IF HTL_NOATTCH EQ 0 THEN 100 ELSE ((((HTL_ATTCH+HTL_NOATTCH) 
                   - HTL_NOATTCH))) / (HTL_ATTCH + HTL_NOATTCH) * 100;
BY LEVEL_DESC
BY PASSNGR_NAME
BY EMP_ID
ON TABLE HOLD AS AIRHOLD2
END
-RUN







TABLE FILE AIRHOLD2
PRINT HTL_ATTCH
    HTL_NOATTCH
    NET_TKT_CNT
    TOT_ATTCH
    HBPCT
    EMP_ID
BY LEVEL_DESC
RANKED BY LOWEST &&RANK_METH
RANKED BY HIGHEST HTL_NOATTCH
WHERE HBPCT GE 0
&WHERE1
BY PASSNGR_NAME
ON TABLE HOLD AS RNKHLD2
END
-RUN



DEFINE FILE RNKHLD2
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  LIST/D9 = (LAST LIST + 1);
  CRANKX/A11 = FTOA(LIST, '(D9)', 'A11');
  CRANK/A9 = EDIT(CRANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE 
                  IF LIST GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                  CRANK;
  RANK_VAL/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE
                IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE
                ARANK;
  RANK_LABEL1/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2
                      ELSE ' ';
  RANK_LABEL3/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3
                      ELSE ' ';
  NOWTOD/A8 WITH RANK_VALUE = HHMMSS (NOWTOD);
END
-RUN

-GOTO Finishrpt;
-IF '&&SETF.EVAL' NE 'HDTOPLHB' THEN GOTO Finishrpt;
TABLE FILE RNKHLD2
PRINT HTL_ATTCH EMP_ID HTL_NOATTCH NET_TKT_CNT HBPCT RANK_VALUE RANK_LABEL1 RANK_LABEL2
BY LEVEL_DESC
BY PASSNGR_NAME
ON TABLE HOLD AS DEBTEST
END
-RUN



TABLE FILE AIRHOLD1
PRINT AIR_KEY
BY LEVEL_DESC
BY PASSNGR_NAME
ON TABLE HOLD AS HDRHOLD
END
-RUN

MATCH FILE DEBTEST
PRINT STAY1
      NNROOMS1
      NOHOTEL 
      NH_TKT_CNT  
      H_TKT_CNT 
      NET_TKT_CNT
      HBPCT 
      RANK_VALUE 
      RANK_LABEL1 
      RANK_LABEL2
BY LEVEL_DESC
BY PASSNGR_NAME
ON TABLE HOLD
RUN
FILE HDRHOLD
SUM AIR_KEY
BY LEVEL_DESC
BY PASSNGR_NAME
AFTER MATCH HOLD AS HDRTWO OLD 
END
-RUN


TABLE FILE HDRTWO
PRINT STAY1
      NNROOMS1
      NOHOTEL 
      NH_TKT_CNT  
      H_TKT_CNT 
      NET_TKT_CNT
      HBPCT 
      RANK_VALUE 
      RANK_LABEL1 
      RANK_LABEL2
      LEVEL_DESC
      PASSNGR_NAME  
BY AIR_KEY
ON TABLE HOLD AS HDRHOLD2 FORMAT FOCUS INDEX AIR_KEY
END
-RUN

 

-Finishrpt

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADER' ELSE 'HDREXLS'; 
-SET &&PASTYS = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE &&SMSTY;
-RUN

TABLE FILE RNKHLD2
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
    &&S_SUBJ1
    &&S_SUBJ2
    &&S_SUBJ3
    &&S_SUBJ4
    &&S_SUBJ5
    &&S_SUBJ6
    &&S_SUBJ7
    &&S_SUBJ8
    &&S_SUBJ9
    &&S_SUBJ10
    
-*BY
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
-*ON
-*&&BREAKOPTION
   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10
   
-SET &FTR_AddlLines = 3;
FOOTING BOTTOM
" "
" "
"The report includes only tickets with an overnight stay"
-*
-IF '&&SETF.EVAL' NE 'HDTOPLHB' THEN GOTO SKIPthisfoot;
-*
-SET &FTR_AddlLines = 4;
"and travelers with 3 or more no hotels booked"
-*
-************ 
-SKIPthisfoot
-************ 
-INCLUDE FOOTERSM
-* 
ON TABLE COLUMN-TOTAL
-*ON TABLE SET STYLE &&SMSTY
-**************************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**********************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT

ON TABLE SET STYLE *

-INCLUDE &&PASTYS

-**********************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/18/00      IBISTL-KR            INCLUDE STYLESHEET PARAMS FOR 
-*                                  DRILLABLE REPORTS.
-**********************************************************************
-IF &&DRILLABLE EQ 'N' GOTO SKIP_DRILL;
-INCLUDE &&DSTY

-SKIP_DRILL

ENDSTYLE
&&OUTLINE1
&&SUMMDEST
&&OUTLINE2
END
-RUN

-IF &&DRILLABLE EQ 'Y' GOTO SKIP_R3;

EX REPORT_3

-SKIP_R3
-GOTO XXIT;

-NORECORDS
-SET &INST_KEY = &&IKEY;

TABLE FILE BRPTINST
PRINT PAIR_DB RPT_GROUP RPT_STREAM GLOBAL_PARM USE_PARM INST_KEY
WHERE INST_KEY EQ &INST_KEY
ON TABLE SAVE AS PAIRDB
END
-RUN

-READ PAIRDB &PAIRDB.A1. &RPTGRP.A3. &RPTSTREAM.A8. &SETFILE.A8. &VIEW.A8.
-CLOSE PAIRDB
 
-SET &RPTGRP = '&RPTGRP.EVAL';
-SET &VIEW = '&VIEW.EVAL';
-SET &STREAM = '&RPTSTREAM.EVAL';

-SET &HEADER = IF &RPTGRP EQ 'ADD' THEN 'NORECHDRDD' ELSE 'NORECHDR';
-RUN


-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN &HEADER ELSE  
-              IF &RPTGRP EQ 'ADD' THEN 'HDREXLSDD' ELSE 
-              IF &STREAM EQ 'AIR_BNM' THEN 'HDREXLSDD' ELSE 'HDREXLS';

-RUN


-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE 'NORECSTY';

JOIN SET_KEY IN BRPTINST TO SET_KEY IN BRPT_SET AS J1
-RUN

DEFINE FILE BRPTINST
EMPTY/A35 = 'NO RECORDS FOUND FOR THIS SELECTION';
NOWTOD/A8 WITH INST_KEY = HHMMSS (NOWTOD);
END
TABLE FILE BRPTINST
-INCLUDE &&PAHDR
PRINT EMPTY AS 'REPORT,MESSAGE'
BY ROLLUP_CODE AS 'ROLLUP,CODE'
BY RPT_NAME AS 'REPORT,NAME'
BY SELECT_LEV AS 'BREAK,LEVEL'
IF INST_KEY EQ &&IKEY
IF RECORDLIMIT EQ 1
-INCLUDE FOOTERDT
ON TABLE SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET PAGE-NUM OFF
ON TABLE SET STYLE *
-INCLUDE &&PASTYD
ENDSTYLE
 
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN



-XXIT;
