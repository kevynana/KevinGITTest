-************************************************************************************
-* File DVLIM.FEX
-* CREATED FOR DATA VAULT EXPENSE REPORT 
-* CREATED FROM TKTCAR
-* This program extracts data for the series of basic ticket listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-* 9/11/14 - DEB - ADDED TASF_TKT_NUM 
-* 9/26/14 - DEB - CHANGED FIELD FORMAT OF NEW_RENTAL_AMT TO D12.2C
-* 9/15/15 - DV - S-11541 - CORRECTED ISSUE TO CORRECT DV_NUM FOR SVC_FEE
-* 7/11/16 -DLV -  S-20630   Added EMP_ID ASSOC_CONF_NUM to extract
-* Changed Case1 to AND instead of OR - to work correctly if fee only selection
-*   was made 


-* 4 cases to be considered: 
-*  1) Car, fee both selected(Y Y); 2) Neither Car nor Fee is selected (N N).
-*  3) Car selected, Fee not (Y N);     4) Car not, Fee Yes            (N Y)
-************************************************************************************
-INCLUDE SETECHO 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN 



-DEFAULT &GETLIMEXP = 'Y';
-DEFAULT &GETPROFEXP = 'Y';
-DEFAULT &LIMPROF = 'N';



TABLE FILE PFHOLDC
PRINT TRN_TYPE TRN_DATE FEE_SRC FEE_AMT PAY_METHOD CREDIT_CARD FST_DPT_DATE CNT TASF_TKT_NUM
BY CAR_KEY
WHERE CAR_KEY NE ' '
ON TABLE HOLD AS CARFEE
END
-RUN
 
-SET &LIMPROF = IF &LINES GT 0 THEN 'Y' ELSE 'N';


-CarCase1
-*Case 1: Neither Car nor Fee is selected.
-*-IF ('&GETLIMEXP.EVAL' EQ 'N' AND '&GETPROFEXP.EVAL' EQ 'N') OR ('&GETLIMEXP.EVAL' EQ 'N' AND '&LIMPROF.EVAL' EQ 'N') 
-IF ('&GETLIMEXP.EVAL' EQ 'N' AND '&GETPROFEXP.EVAL' EQ 'N') AND ('&GETLIMEXP.EVAL' EQ 'N' AND '&LIMPROF.EVAL' EQ 'N') 
- THEN GOTO LimXXIT;
 

-SET &CARDATES = &&WEB_PATH || 'CARDATES.fex';

DEFINE FILE &&EXTRACT
  BLANK3/D12.2CS= IF LIM_MAIN.CONTRACT_RATE GT 0 THEN 0 ELSE 0;  
  BLANK2/A11 = '           ';  
  DATA_V1/A9 = '*********';
  DV_NUM2/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
  DV_NUM/A15 = IF DV_NUM2 EQ ' ' THEN ' ' ELSE DATA_V || DV_NUM2;
  LEVEL_DESC/A60 = &&LDESC;
  SEG/A2 = '  ';
  DROP_OFF_DT/MDYY = DROP_DATE;	
  INV_DATE/MDYY = INVOICE_DATE;
  NBR_DAYS/D12 = NUM_DAYS;
  NEW_RENTAL_AMT/D12.2  = RENTAL_AMT;
  PICK_UP_DT/MDYY = PICKUP_DATE;
  RENTAL_DAYS/D12 = IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                   ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;
  VENDR_NM/A3 = VENDOR_CODE;
  TRIP_PURPOSE/A2 = ' ';
  TRP_DESC/A40 = '                                        ';      
  TYPE/A3 ='SAL';
  STATUS/A1 = 'O';
  TASF_TKT_NUM/A10 = '          ';
END
-RUN

TABLEF FILE &&EXTRACT
PRINT BR_CL_IDX AS 'ACCT'
  TYPE
  BLANK2 AS 'TSORT'
  CAR_KEY
  CURR_DATE
  DROP_CTY.CITY_NAME AS 'CITY2'  
  DROP_OFF_DT AS 'DATE2'
  DV_NUM
  INV_DATE AS 'TRAN_DATE'
  INVOICE_DATE
  INVOICE_NUM
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  EMP_ID
  NEW_RENTAL_AMT/D12.2 AS 'AMOUNT'
  PASSNGR_NAME
  PICK_CTY.CITY_NAME AS 'CITY1'
  PICK_UP_DT AS 'DATE'
  PNR_LOCATOR
  SEG
  STATUS
  RENTAL_DAYS AS 'TTL_COUNT'
  CCR_CONFIRM AS 'TKT_NUM'
  TRIP_PURPOSE
  TRP_DESC
  VENDR_NM AS 'NAME'
  PICK_CTY.GEO_ZONE AS 'GEO_ZONE'
  TASF_TKT_NUM
-INCLUDE &CARDATES
-********************************************************************
-* Where statements to select data specified in user profile
-* *******************************************************************
 &&WHERE7
 &&WHERE8

-INCLUDE RPTPARMS
ON TABLE HOLD AS LIMHOLD

END
-RUN
 

-IF '&LIMPROF.EVAL' EQ 'Y' AND '&GETPROFEXP.EVAL' EQ 'Y' THEN GOTO JoinLFee;
 


-*no car exp and no pro fee, exit
-IF '&GETLIMEXP.EVAL' EQ 'N' THEN GOTO LimXXIT;

-*Case 2: LIM selected, Fee not
-NoCJoin
DEFINE FILE LIMHOLD
FLAG/A1 = 'L';
-* FEE_AMT/D9.2 = 0;
  ASSOC_CONF_NUM/A30= ' ';
END

-SET &LHOLDFILE = 'LIMHOLD';
-GOTO ToHoldLim;


TABLE FILE LIMHOLD
PRINT 
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TSORT
  TYPE
  EMP_ID
  SEG      
  NAME
  DATE
  DATE2
  CITY1
  DV_NUM
  AMOUNT
  TTL_COUNT
  ACCT
  INVOICE_NUM
  STATUS
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  GEO_ZONE
  TRIP_PURPOSE
  TRP_DESC
  TASF_TKT_NUM
  ASSOC_CONF_NUM
-*  FEE_AMT
BY FLAG
ON TABLE HOLD AS HOLDL FORMAT FOCUS
END
-RUN


-SET &&NOLIM = IF &RECORDS EQ 0 THEN 'Y' ELSE 'N';

-GOTO LimXXIT;


-JoinLFee;


DEFINE FILE CARFEE
  CKEY/A84='''' | CAR_KEY | '''';
END

TABLE FILE CARFEE
PRINT CKEY 
BY CAR_KEY NOPRINT
ON TABLE SAVE
END
-RUN

-INCLUDE DVRLIMUSE
-RUN


DEFINE FILE LR_50
  PICK_UP_DT/MDYY = PICKUP_DATE;
  DROP_OFF_DT/MDYY = DROP_DATE;	

  DATA_V/A9 = '*********';
-*  DV_NUM2/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
-*  DV_NUM/A15 = IF DV_NUM2 EQ ' ' THEN ' ' ELSE DATA_V || DV_NUM2; 
  STATUS/A1 = 'O';
  TRAN_DATE/MDYY = INVOICE_DATE;  
  LEVEL_DESC/A60 = &&LDESC;
  TASF_TKT_NUM/A10 = '          ';
END
TABLE FILE LR_50
PRINT 
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  CCR_CONFIRM 
  
  VENDOR_CODE 
  PICK_UP_DT 
  DROP_OFF_DT 
-*  PICK_CTY.CITY_NAME AS 'CITY1'
-*  DV_NUM

  BR_CL_IDX 
  INVOICE_NUM
  STATUS
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  EMP_ID
  GEO_ZONE
  TASF_TKT_NUM
BY CAR_KEY
-INCLUDE RPTPARMS
WHERE CAR_KEY IN FILE SAVE
ON TABLE HOLD AS 'LR50SUB' FORMAT FOCUS INDEX CAR_KEY
END
-RUN      

JOIN CAR_KEY IN PFHOLDC TO CAR_KEY IN LR50SUB
DEFINE FILE PFHOLDC
-*  FLAG/A1 = 'C';
  TSORT/A11 = '           '; 
  TRIP_PURPOSE/A2 = ' ';
   TRP_DESC/A40 = '                                        ';      
  TYPE/A3 ='SAL';
  SEG/A2 = '  ';

  AMOUNT/D12.2 =FEE_AMT;  
  STATUS/A1 = 'O';
  NAME/A3 = VENDOR_CODE;
  DATA_V/A9 = '*********';
  DV_NUM2/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
  DV_NUM/A15 = IF DV_NUM2 EQ ' ' THEN ' ' ELSE DATA_V || DV_NUM2; 
  ASSOC_CONF_NUM/A30= ' ';

END
TABLE FILE PFHOLDC
PRINT 
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  CCR_CONFIRM AS 'TKT_NUM'
  TSORT 
  TYPE
  EMP_ID
  SEG      
  NAME
  PICK_UP_DT AS 'DATE'
  DROP_OFF_DT AS 'DATE2'
  CITY1
  DV_NUM
  AMOUNT
  CNT AS 'TTL_COUNT'
  BR_CL_IDX AS 'ACCT'
  INVOICE_NUM
  STATUS
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  GEO_ZONE
  TRIP_PURPOSE
  TRP_DESC
  TASF_TKT_NUM
  ASSOC_CONF_NUM
BY FLAG
WHERE PASSNGR_NAME NE ' '
ON TABLE HOLD AS HOLDLP FORMAT FOCUS
END
-RUN
-*Case 3: Car NOT selected, Fee selected.
-IF '&GETLIMEXP.EVAL' EQ 'Y' THEN GOTO CarCase4;

-SET &LHOLDFILE = 'HOLDLP';
-GOTO ToHoldLim;

-CarCase4
-*Case 4: both Car and Fee selected.


DEFINE FILE LIMHOLD
  FLAG/A1 = 'L';
  ASSOC_CONF_NUM/A30= ' ';
END
TABLE FILE LIMHOLD
PRINT 
PASSNGR_NAME
PNR_LOCATOR
TRAN_DATE
TKT_NUM
TSORT
TYPE
EMP_ID
SEG      
NAME
DATE
DATE2
CITY1
DV_NUM
AMOUNT
TTL_COUNT
ACCT
INVOICE_NUM
STATUS
LEVEL_DESC
LEVEL1
LEVEL2
LEVEL3
LEVEL4
LEVEL5
LEVEL6
LEVEL7
GEO_ZONE
TRIP_PURPOSE
TRP_DESC
TASF_TKT_NUM
ASSOC_CONF_NUM
BY FLAG
ON TABLE HOLD

END
-RUN



-*Merger Car and Pro fee together
MODIFY FILE HOLDLP
FIXFORM FROM HOLD
DATA ON HOLD
END
-RUN
-SET &LHOLDFILE = 'HOLDLP';

-ToHoldLim
DEFINE FILE &LHOLDFILE
  ASSOC_CONF_NUM/A30= ' ';
END
TABLE FILE &LHOLDFILE
PRINT 
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TSORT
  TYPE
  EMP_ID
  SEG      
  NAME
  DATE
  DATE2
  CITY1
  DV_NUM
  AMOUNT
  TTL_COUNT
  ACCT
  INVOICE_NUM
  STATUS
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  LEVEL7
  GEO_ZONE
  TRIP_PURPOSE
  TRP_DESC
  TASF_TKT_NUM
  ASSOC_CONF_NUM
BY FLAG
ON TABLE HOLD AS HOLDL FORMAT FOCUS
END
-RUN

 
-LimXXIT


 

 
 
