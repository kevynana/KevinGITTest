-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File LVIEW2EX.FEX
-********************************************************************
-* MODIFICAIONS:
-********************************************************************
-*
-* This program extracts data for the series of basic car verndor listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-*
-* 9/28/09 DEB CREATED FROM CVIEW2EX FOR ABTOPLIM
-*2/5/14 Updated the bookings define to use num_days instead of daily_rate - JK

-********************************************************************
-INCLUDE SETECHO 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN
-SET &CARDATES = &&WEB_PATH || 'CARDATES.fex';

DEFINE FILE &&EXTRACT
  AVG_DLY_RATE/D9.2 = IF (RENTAL_AMT LT 0) AND (NUM_DAYS LT 0)
                      THEN ((RENTAL_AMT/NUM_DAYS)*(-100)) 
                      ELSE RENTAL_AMT/NUM_DAYS; 
  ASIA/A1 = IF PICK_CTY.COUNTRY_CODE EQ 'AM' OR 'AZ' OR 'BD' OR 'BN' OR
  'CN' OR 'GE' OR 'HK' OR 'ID' OR 'IN' OR 'JP' OR 'KG' OR 'KH' OR 'KR' OR
  'KZ' OR 'LA' OR 'LK' OR 'MM' OR 'MO' OR 'MV' OR 'MY' OR 'NP' OR 'PH' OR
  'PK' OR 'SG' OR 'TH' OR 'TM' OR 'TW' OR 'UZ' OR 'VN' THEN 'Y' ELSE 'N';
BOOKINGS/D8 = IF NUM_DAYS GT 0 THEN 1 ELSE IF NUM_DAYS LT 0 THEN (-1) ELSE 0;
  CITY_ST/A35 = PICK_CTY.CITY_NAME||(' '| PICK_CTY.STATE_CODE);
  CARD_NUM/A12 = EDIT(CREDIT_CARD, '$$999999999999$$$$');   
  CARD1_NUM/A4 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$$$9999');   
  DAY_OF_WK/W = PICKUP_DATE;    
  DROP_OFF_DT/MDYY = DROP_DATE; 
  EUROPE/A1 = IF PICK_CTY.COUNTRY_CODE EQ 'AL' OR 'AM' OR 'AT' OR 'AZ' OR
  'BA' OR 'BE' OR 'BG' OR 'BY' OR 'CH' OR 'CY' OR 'CZ' OR 'DE' OR 'DK' OR
  'EE' OR 'ES' OR 'FI' OR 'FR' OR 'GB' OR 'GE' OR 'GI' OR 'GL' OR 'GR' OR 
  'HR' OR 'HU' OR 'IE' OR 'IS' OR 'IT' OR 'LT' OR 'LU' OR 'LV' OR 'MC' OR
  'MD' OR 'MK' OR 'MN' OR 'MT' OR 'NL' OR 'NO' OR 'PL' OR 'PT' OR 'RO' OR
  'RU' OR 'SE' OR 'SI' OR 'SK' OR 'TR' OR 'UA' OR 'YU' THEN 'Y' ELSE 'N';
  INV_DATE/MDYY = INVOICE_DATE; 
  LEV_2/A15 = IF PASSNGR_NAME NE LAST PASSNGR_NAME THEN LEVEL2 ELSE ' ';
  LEVEL_DESC/A60 = &&LDESC; 
  NBR_CARS/D12 = NUM_CARS;
-*  NBR_DAYS/D12 = NUM_DAYS;    
  NBR_DAYS/D12 =  IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                  ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;  
  PICK_UP_DT/MDYY = PICKUP_DATE;    
  REFUSE_CD/A2 = EDIT(REFUSE_KEY,'$$$$$$$$99');
  RNTL_TYP/A15 = IF LIM_MAIN.PICKUP_CITY NE LIM_MAIN.DROP_CITY THEN 'ONE WAY'
              ELSE 'LOCAL'; 
  XPICK_DOW/W   = PICKUP_DATE;
  XDROP_DOW/W   = DROP_DATE;

  
-* ****DEFINES ON PREVIOUS DEFINES****

  PICK_DAY/A3   = DECODE XPICK_DOW (1 'MON' 2 'TUE' 3 'WED'
                        4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
  DROP_DAY/A3   = DECODE XDROP_DOW (1 'MON' 2 'TUE' 3 'WED'
                        4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');

END
-RUN

TABLEF FILE &&EXTRACT
PRINT AIRPORT_CODE  
  AIRPORT_NAME  
  ALPHA_RATE    
  AR_BRANCH
  ASIA
  AVG_DLY_RATE
  BOOKINGS
  BR_CL_IDX 
  CAR_CAT   
  CAR_DESC  
  CAR_KEY   
  CAR_RATE  
  CAR_TYPE  
  CARD_NUM  
  CARD1_NUM 
  CCR_CONFIRM
  CITY_ST
  CREDIT_CARD
  CURR_DATE 
  DAILY_RATE    
  DAY_OF_WK 
  DROP_CITY 
  DROP_CTY.CITY_NAME AS 'DROP_CTY_NAME'     
  DROP_DATE     
  DROP_DAY
  DROP_OFF_DT   
  EUROPE
  INV_DATE  
  INVOICE_DATE  
  INVOICE_NUM   
  LEV_2     
  LEVEL_DESC    
  LEVEL1    
  LEVEL2    
  LEVEL3    
  NBR_DAYS  
  NBR_CARS
  NUM_CARS  
  NUM_DAYS  
  PASSNGR_NAME  
  PICK_CTY.CITY_CODE AS 'CITY_CODE'
  PICK_CTY.CITY_NAME AS 'PICK_CTY_NAME' 
  PICK_CTY.COUNTRY_CODE AS 'COUNTRY'
  PICK_DAY
  PICK_UP_DT    
  PICKUP_CITY   
  PICKUP_DATE   
  PNR_LOCATOR   
  REFUSAL_DESC  
  REFUSE_CD 
  REFUSE_KEY    
  RENTAL_AMT
  RNTL_TYP  
  PICK_CTY.STATE_CODE   
  STD_RATE  
  TICKET_BRANCH 
  TKT_NUM   
  VENDOR_CODE   
  VENDOR_NAME   

-INCLUDE &CARDATES    
-*WHERE INVOICE_DATE GE &&FROMDT.EVAL AND INVOICE_DATE LE &&TODT.EVAL
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS

ON TABLE HOLD AS LIM_HOLD
END
-RUN

TABLE FILE LIM_HOLD
PRINT AIRPORT_CODE  
  AIRPORT_NAME  
  ALPHA_RATE    
  AR_BRANCH
  ASIA
  AVG_DLY_RATE
  BOOKINGS
  BR_CL_IDX 
  CAR_CAT   
  CAR_DESC  
  CAR_KEY   
  CAR_RATE  
  CAR_TYPE  
  CARD_NUM  
  CARD1_NUM 
  CCR_CONFIRM 
  CITY_ST
  CREDIT_CARD
  COUNTRY
  DAILY_RATE    
  DAY_OF_WK 
  DROP_CITY 
  DROP_CTY_NAME     
  DROP_DATE     
  DROP_DAY
  DROP_OFF_DT   
  EUROPE
  INV_DATE  
  INVOICE_DATE  
  INVOICE_NUM   
  LEV_2     
  LEVEL_DESC    
  LEVEL1    
  LEVEL2    
  LEVEL3    
  NBR_DAYS  
  NBR_CARS
  NUM_CARS  
  NUM_DAYS  
  PASSNGR_NAME  
  PICK_CTY_NAME 
  PICK_DAY
  PICK_UP_DT    
  PICKUP_CITY   
  PICKUP_DATE   
  PNR_LOCATOR   
  REFUSAL_DESC  
  REFUSE_CD 
  REFUSE_KEY    
  RENTAL_AMT
  RNTL_TYP  
  STATE_CODE    
  STD_RATE  
  TICKET_BRANCH 
  TKT_NUM   
  VENDOR_CODE   
  VENDOR_NAME
BY CURR_DATE
ON TABLE HOLD AS LIMHLD1 FORMAT FOCUS INDEX CURR_DATE
END
-RUN

-* Global Reporting JOIN
JOIN LIMHLD1.CURR_DATE IN LIMHLD1 TO GLOBAL.DATE IN GLOBAL AS J1
END

DEFINE FILE LIMHLD1

 NAMEC/A30 = CNAME;

-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
AMT_RENTALX/D20.6 = RENTAL_AMT * CURR1X;
RATE_DLYX/D20.6 = DAILY_RATE * CURR1X;

END

TABLE FILE LIMHLD1
  PRINT 
  AIRPORT_CODE  
  AIRPORT_NAME  
  ALPHA_RATE    
  AR_BRANCH
  ASIA
  AVG_DLY_RATE
  BOOKINGS
  BR_CL_IDX 
  CAR_CAT   
  CAR_DESC  
  CAR_KEY   
  CAR_RATE  
  CAR_TYPE  
  CARD_NUM  
  CARD1_NUM 
  CCR_CONFIRM
  CITY_ST
  COUNTRY
  CREDIT_CARD
  CURR_DATE
  DAILY_RATE    
  DAY_OF_WK 
  DROP_CITY 
  DROP_CTY_NAME     
  DROP_DATE     
  DROP_DAY
  DROP_OFF_DT   
  EUROPE
  INV_DATE  
  INVOICE_DATE  
  INVOICE_NUM   
  LEV_2     
  LEVEL_DESC    
  LEVEL1    
  LEVEL2    
  LEVEL3    
  NBR_DAYS  
  NBR_CARS
  NUM_CARS  
  NUM_DAYS  
  PASSNGR_NAME  
  PICK_CTY_NAME 
  PICK_DAY
  PICK_UP_DT    
  PICKUP_CITY   
  PICKUP_DATE   
  PNR_LOCATOR   
  REFUSAL_DESC  
  REFUSE_CD 
  REFUSE_KEY    
  RENTAL_AMT
  RNTL_TYP  
  STATE_CODE    
  STD_RATE  
  TICKET_BRANCH 
  TKT_NUM   
  VENDOR_CODE   
  VENDOR_NAME
  NAMEC
  AMT_RENTALX/D16.2CS
  RATE_DLYX/D16.2CS
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS LIMHLD2
END
-RUN




-*-EXIT
    


-* -QUIT

-*-EXIT
