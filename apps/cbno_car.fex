-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-INCLUDE SETECHO
SET ASNAMES=ON
-* -SET &CARDATES = &&WEB_PATH || 'CARDATES.fex';
DEFINE FILE CR_50
-*  Set Dates
LEVEL_DESC/A60 = &&LDESC;

TDATE1/YYMD=&&TODT.EVAL;
TDATE2/YYMD=&&TXDATE.EVAL;

P_MONTH/MDYY=TDATE1;
P2_MONTH/MDYY = TDATE2;

P_EOM/MDYY=DATEMOV(P_MONTH, 'EOM');
P2_EOM/MDYY=DATEMOV(P2_MONTH, 'EOM2');

-* RUN_EOM is the End of Month we are executing.
RUN_EOM/M=P_EOM;
-* RUN_EOM2 is the Prior End of Month we are executing.
RUN_EOM2/M=P2_EOM;
-* Determine End of Quarters for Rollups
RFY/M=IF ROLL_FY EQ '' OR '1' OR '01' OR 'X' THEN 1 ELSE EDIT(ROLL_FY);
Q1B/M=RFY;
Q1E/M=IF (RFY + 3) - 1 LT 12 THEN (RFY + 3) - 1 ELSE (RFY + 3) - 1 - 12;
Q2B/M=IF (RFY + 3) GT 12 THEN (RFY + 3) - 12 ELSE (RFY + 3);
Q2E/M=IF (RFY + 6) - 1 LT 12 THEN (RFY + 6) - 1 ELSE (RFY + 6) - 1 - 12;
Q3B/M=IF (RFY + 6) GT 12 THEN (RFY + 6) - 12 ELSE (RFY + 6);
Q3E/M=IF (RFY + 9) - 1 LT 12 THEN (RFY + 9) - 1 ELSE (RFY + 9) - 1 - 12;
Q4B/M=IF (RFY + 9) GT 12 THEN (RFY + 9) - 12 ELSE (RFY + 9);
Q4E/M=IF (RFY + 12) - 1 LT 12 THEN (RFY + 12) - 1 ELSE (RFY + 12) - 1 - 12;


ANNUAL/M=Q4E;
ANNUAL_YY/YY=P_EOM;
ANNUAL_YY1/YY=IF RUN_EOM GT Q4E THEN ANNUAL_YY + 1 ELSE ANNUAL_YY;
ANNUAL_A8MDYY/A8MDYY=EDIT(Q4E) | '01' | EDIT(ANNUAL_YY1);
ANNUAL_MONTH/MDYY=ANNUAL_A8MDYY;
ANNUAL_END/MDYY=DATEMOV(ANNUAL_MONTH, 'EOM');

P_ANNUAL/M=Q4E;
P_ANNUAL_YY/YY=P2_EOM;
P_ANNUAL_YY1/YY=IF RUN_EOM2 GT Q4E THEN P_ANNUAL_YY + 1 ELSE P_ANNUAL_YY;
P_ANNUAL_A8MDYY/A8MDYY=EDIT(Q4E) | '01' | EDIT(P_ANNUAL_YY1);
P_ANNUAL_MONTH/MDYY=P_ANNUAL_A8MDYY;
P_ANNUAL_END/MDYY=DATEMOV(P_ANNUAL_MONTH, 'EOM');


Q4_END/MDYY=ANNUAL_END;
Q4_BEGIN/MDYY=DATEMOV(DATEADD(Q4_END, 'M', (-2)), 'BOM');
Q3_END/MDYY=Q4_BEGIN - 1;
Q3_BEGIN/MDYY=DATEMOV(DATEADD(Q3_END, 'M', (-2)), 'BOM');
Q2_END/MDYY=Q3_BEGIN - 1;
Q2_BEGIN/MDYY=DATEMOV(DATEADD(Q2_END, 'M', (-2)), 'BOM');
Q1_END/MDYY=Q2_BEGIN - 1;
Q1_BEGIN/MDYY=DATEMOV(DATEADD(Q1_END, 'M', (-2)), 'BOM');


PQ4_END/MDYY=P_ANNUAL_END;
PQ4_BEGIN/MDYY=DATEMOV(DATEADD(PQ4_END, 'M', (-2)), 'BOM');
PQ3_END/MDYY=PQ4_BEGIN - 1;
PQ3_BEGIN/MDYY=DATEMOV(DATEADD(PQ3_END, 'M', (-2)), 'BOM');
PQ2_END/MDYY=PQ3_BEGIN - 1;
PQ2_BEGIN/MDYY=DATEMOV(DATEADD(PQ2_END, 'M', (-2)), 'BOM');
PQ1_END/MDYY=PQ2_BEGIN - 1;
PQ1_BEGIN/MDYY=DATEMOV(DATEADD(PQ1_END, 'M', (-2)), 'BOM');


P_BOM/MDYY=DATEMOV(P_MONTH, 'BOM');
P_BOQ/MDYY=DATEMOV(P_MONTH, 'BOQ');
P_BOY/MDYY=DATEMOV(P_MONTH, 'BOY');

P2_BOM/MDYY=DATEMOV(P2_MONTH, 'BOM');
P2_BOQ/MDYY=DATEMOV(P2_MONTH, 'BOQ');
P2_BOY/MDYY=DATEMOV(P2_MONTH, 'BOY');
CLIENT/A8 = '&&ROLLUP.EVAL';

 
FDATE/YYMD=&&FROMDT.EVAL;
EDATE/YYMD=&&TODT.EVAL;
BOM_DATE/YYMD=DATEMOV(EDATE,'BOM');
EOM_DATE/YYMD=DATEMOV(EDATE,'EOM');
EOM_DATE1/MDYY=DATEMOV(EDATE,'EOM');
ANNUAL_BEGIN/MDYY=Q1_BEGIN;


P_FDATE/YYMD=&&FXDATE.EVAL;
P_EDATE/YYMD=&&TXDATE.EVAL;
P_BOM_DATE/YYMD=DATEMOV(P_EDATE,'BOM');
P_EOM_DATE/YYMD=DATEMOV(P_EDATE,'EOM');
P_EOM_DATE1/MDYY=DATEMOV(P_EDATE,'EOM');
P_ANNUAL_BEGIN/MDYY=PQ1_BEGIN;
 

-* Determine End of Year Month for Rollups

CLIENT/A8 = '&&ROLLUP.EVAL';


W_QTR/A1= IF EOM_DATE FROM Q1_BEGIN TO Q1_END THEN '1' ELSE
          IF EOM_DATE FROM Q2_BEGIN TO Q2_END THEN '2' ELSE
          IF EOM_DATE FROM Q3_BEGIN TO Q3_END THEN '3' ELSE
          IF EOM_DATE FROM Q4_BEGIN TO Q4_END THEN '4' ELSE '0';
 
MD/A1 = IF (INVOICE_DATE GE BOM_DATE) AND
           (INVOICE_DATE LE EOM_DATE)
            THEN 'Y' ELSE 'N';

P_MD/A1 = IF (INVOICE_DATE GE P_BOM_DATE) AND
           (INVOICE_DATE LE P_EOM_DATE)
            THEN 'Y' ELSE 'N';
 

 
YD/A1 = IF (INVOICE_DATE GE ANNUAL_BEGIN) AND
           (INVOICE_DATE LE EOM_DATE) THEN 'Y' ELSE 'N';
           
           
P_YD/A1 = IF (INVOICE_DATE GE P_ANNUAL_BEGIN) AND
           (INVOICE_DATE LE P_ANNUAL_END) THEN 'Y' ELSE 'N';
                      
 
FMD/QY=EOM_DATE;
TRAN/MDYY = INVOICE_DATE;
DATE1/MTY = INVOICE_DATE;
 
P_FMD/QY=P_EOM_DATE;

12DATE/A1 = IF (TRN_DATE GE ANNUAL_BEGIN) AND
               (TRN_DATE LE EOM_DATE1) THEN 'Y' ELSE 'N';
P_12DATE/A1 = IF (TRN_DATE GE P_ANNUAL_BEGIN) AND
               (TRN_DATE LE P_ANNUAL_END) THEN 'Y' ELSE 'N';

DATE/MTY = IF 12DATE EQ 'Y' THEN DATE1 ELSE ' ';           

P_DATE/MTY = IF P_12DATE EQ 'Y' THEN DATE1 ELSE ' ';



 
NBR_DAYS/D10 = IF (NUM_DAYS LT 0) AND
                  (NUM_CAR LT 0) THEN
                  (NUM_DAYS * NUM_CAR) * (-1) ELSE
                  (NUM_DAYS * NUM_CAR);
 TC_AMT/D15.2 = RENTAL_AMT;

  
 
TRAN/QY = INVOICE_DATE;
-* QDATE/A1 = IF FMD EQ TRAN THEN 'Y' ELSE 'N';
QDATE/A1 = IF FMD EQ TRAN AND INVOICE_DATE LE EOM_DATE THEN 'Y' ELSE 'N';
 
 
-*******************Month********************
-* Month Rental Amount
MCAMT/D12.2 = IF MD EQ 'Y' THEN TC_AMT ELSE 0;
-* Month Days
MCDAY/D12 = IF MD EQ 'Y' THEN NBR_DAYS ELSE 0;
MDCDAY/D12 = IF MD EQ 'Y' AND INTL_DOM EQ 'D' THEN NBR_DAYS ELSE 0;
MICDAY/D12 = IF MD EQ 'Y' AND INTL_DOM EQ 'I' THEN NBR_DAYS ELSE 0;
MONLCDAY/D12 = IF MD EQ 'Y' AND ONLTRAD EQ 'O' THEN NBR_DAYS ELSE 0;
MDONLCDAY/D12 = IF MD EQ 'Y' AND ONLTRAD EQ 'O' AND INTL_DOM EQ 'D' THEN NBR_DAYS ELSE 0;
MIONLCDAY/D12 = IF MD EQ 'Y' AND ONLTRAD EQ 'O' AND INTL_DOM EQ 'I' THEN NBR_DAYS ELSE 0;
-* Month Bookings
MCBOOK/D12 = IF MD EQ 'Y' THEN BOOKINGS ELSE 0;
-*******************YTD**********************
-*Year Rental Amount
YCAMT/D12.2 = IF YD EQ 'Y' THEN TC_AMT ELSE 0;
-* Year Days
YCDAY/D12 = IF YD EQ 'Y' THEN NBR_DAYS ELSE 0;
-*Domestic Year Rental Amount
YCDAMT/D12.2 = IF YD EQ 'Y' AND INTL_DOM EQ 'D' THEN TC_AMT ELSE 0;
-*Domestic Year Days
YCDDAY/D12 = IF YD EQ 'Y' AND INTL_DOM EQ 'D' THEN NBR_DAYS ELSE 0;
-*International Year Rental Amount
YCIAMT/D12.2 = IF YD EQ 'Y' AND INTL_DOM NE 'D' THEN TC_AMT ELSE 0;
-*International Year Days
YCIDAY/D12 = IF YD EQ 'Y' AND INTL_DOM NE 'D' THEN NBR_DAYS ELSE 0;
-* YTD Bookings
YCBOOK/D12 = IF YD EQ 'Y' THEN BOOKINGS ELSE 0;

-*******************Quarter******************
-* Quarter Amount
-* QCAMT/D12.2 = IF QDATE EQ 'Y' THEN TC_AMT ELSE 0;
QCAMT/D12.2=IF W_QTR EQ '1' AND INVOICE_DATE FROM Q1_BEGIN TO EOM_DATE1 THEN TC_AMT ELSE
            IF W_QTR EQ '2' AND INVOICE_DATE FROM Q2_BEGIN TO EOM_DATE1 THEN TC_AMT ELSE
            IF W_QTR EQ '3' AND INVOICE_DATE FROM Q3_BEGIN TO EOM_DATE1 THEN TC_AMT ELSE
            IF W_QTR EQ '4' AND INVOICE_DATE FROM Q4_BEGIN TO EOM_DATE1 THEN TC_AMT ELSE 0;
-* Quarter Days
-* QCDAY/D12 = IF QDATE EQ 'Y' THEN NBR_DAYS ELSE 0;
QCDAY/P12=IF W_QTR EQ '1' AND INVOICE_DATE FROM Q1_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
          IF W_QTR EQ '2' AND INVOICE_DATE FROM Q2_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
          IF W_QTR EQ '3' AND INVOICE_DATE FROM Q3_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
          IF W_QTR EQ '4' AND INVOICE_DATE FROM Q4_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE 0;
QDCDAY/P12= IF INTL_DOM NE 'D' THEN 0 ELSE
          IF W_QTR EQ '1' AND INVOICE_DATE FROM Q1_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
          IF W_QTR EQ '2' AND INVOICE_DATE FROM Q2_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
          IF W_QTR EQ '3' AND INVOICE_DATE FROM Q3_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
          IF W_QTR EQ '4' AND INVOICE_DATE FROM Q4_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE 0;
QICDAY/P12= IF INTL_DOM NE 'I' THEN 0 ELSE
          IF W_QTR EQ '1' AND INVOICE_DATE FROM Q1_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
          IF W_QTR EQ '2' AND INVOICE_DATE FROM Q2_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
          IF W_QTR EQ '3' AND INVOICE_DATE FROM Q3_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
          IF W_QTR EQ '4' AND INVOICE_DATE FROM Q4_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE 0;
QONLCDAY/P12 = IF ONLTRAD NE 'O' THEN 0 ELSE
            IF W_QTR EQ '1' AND INVOICE_DATE FROM Q1_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
	    IF W_QTR EQ '2' AND INVOICE_DATE FROM Q2_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
	    IF W_QTR EQ '3' AND INVOICE_DATE FROM Q3_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
            IF W_QTR EQ '4' AND INVOICE_DATE FROM Q4_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE 0;
QDONLCDAY/P12 = IF ONLTRAD NE 'O' THEN 0 ELSE
            IF INTL_DOM NE 'D' THEN 0 ELSE
            IF W_QTR EQ '1' AND INVOICE_DATE FROM Q1_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
	    IF W_QTR EQ '2' AND INVOICE_DATE FROM Q2_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
	    IF W_QTR EQ '3' AND INVOICE_DATE FROM Q3_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
            IF W_QTR EQ '4' AND INVOICE_DATE FROM Q4_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE 0;
QIONLCDAY/P12 = IF ONLTRAD NE 'O' THEN 0 ELSE
            IF INTL_DOM NE 'I' THEN 0 ELSE
            IF W_QTR EQ '1' AND INVOICE_DATE FROM Q1_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
	    IF W_QTR EQ '2' AND INVOICE_DATE FROM Q2_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
	    IF W_QTR EQ '3' AND INVOICE_DATE FROM Q3_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE
            IF W_QTR EQ '4' AND INVOICE_DATE FROM Q4_BEGIN TO EOM_DATE1 THEN NBR_DAYS ELSE 0;
-* Quarter Bookings
QCBOOK/P12 = IF W_QTR EQ '1' AND INVOICE_DATE FROM Q1_BEGIN TO EOM_DATE1 THEN BOOKINGS ELSE
	    IF W_QTR EQ '2' AND INVOICE_DATE FROM Q2_BEGIN TO EOM_DATE1 THEN BOOKINGS ELSE
	    IF W_QTR EQ '3' AND INVOICE_DATE FROM Q3_BEGIN TO EOM_DATE1 THEN BOOKINGS ELSE
            IF W_QTR EQ '4' AND INVOICE_DATE FROM Q4_BEGIN TO EOM_DATE1 THEN BOOKINGS ELSE 0;

-* 12 Month Amount
12CAMT/D12.2 = IF 12DATE EQ 'Y' THEN TC_AMT ELSE 0;
END
TABLE FILE CR_50
SUM 12CAMT
      MCAMT
      MCDAY
      MDCDAY
      MICDAY
      MONLCDAY
      MDONLCDAY
      MIONLCDAY
      MCBOOK
      QCAMT
      QCDAY
      QDCDAY
      QICDAY
      QONLCDAY
      QDONLCDAY
      QIONLCDAY
      QCBOOK
      YCAMT
      YCDAY
      TC_AMT
      YCDAMT
      YCDDAY
      YCIAMT
      YCIDAY
      YCBOOK
COMPUTE CDAYS/I5=(EOM_DATE - ANNUAL_BEGIN) + 1;
      
BY CLIENT
-* BY &&LDESC
BY VENDOR_NAME
BY DATE
-* &CARDATES CANNOT BE USED FOR THIS REPORT B/C IT WILL RUN FOR CURRENT MONTH ONLY INSTEAD OF YTD,QTR, ETC
-*-INCLUDE &CARDATES
&&WHERE1
&&WHERE2
&&WHERE3
 
-INCLUDE RPTPARMS
 
ON TABLE HOLD AS CAPCAR
END
-RUN

-IF &RECORDS EQ 0 THEN GOTO NOCAR ELSE GOTO CAR;
-NOCAR
-SET &&NOCAR = 'Y';
-GOTO NEXT;
-CAR
-SET &&NOCAR = 'N';

-NEXT;


 