-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File HVIEW1EX.FEX
-********************************************************************
-* MODIFICAIONS:
-********************************************************************
-*
-* This program extracts data for the series of basic hotel location listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-*
-*DATE       NAME          DESCRIPTION
-*4/17/01    TANDT-SS      ADDED DOD_TYPE.
-*7/20/01    TANDT-SS      ADDED AGENT_NUM.
-*4/16/02    TANDT-DB      ADDED DEFINE FOR CHKIN_MONTH
-*8/06/02    TANDT-DB      ADDED DEFINE FOR RATE_GRP2
-*11/5/02    TANDT-DB      ADDED DEFINE FOR PROP_ZIP5
-*5/19/03    DEB           ADDED PROP_ADDRESS
-*6/19/03    JK            CHANGED TO SELECT SPECIFIC ROLLUP_CODE
-*09/18/03   JK            CHANGED JOIN INCLUDE ALL HOTELS INSTEAD OF JUST
-*                         THE HOTELS THAT WERE IN THE MARKET FILE
-*3/23/04    jk            Due to market file format changes changed city_st
-*                         define to have an extra space
-*12/9/05    DV            ADDED ID_FLAG DEFINE
-*06/06/06   STEVE         Added PROP_PHONE for reporting (MetLife - Robin request)
-********************************************************************
-INCLUDE SETECHO
SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';

-*-INCLUDE &HTLDATES 

TABLE FILE CONTROL
PRINT SECURITY_LEVEL
BY ROLLUP_CODE
ON TABLE SAVE AS XROLL
END
-RUN
-READ XROLL &&RLUP.A8.



DEFINE FILE &&EXTRACT

  CITY_ST/A40 = PROP_STATE||(' '| ' '|PROP_CITY);
  LEVEL_DESC/A60  = &&LDESC;
  ID_FLAG/A1 = IF CITY.INTL_DOM EQ 'D' THEN 'D' ELSE 'I';
  IN_DATE/MDYY = CHKIN_DATE;
  INV_DATE/MDYY = INVOICE_DATE;
  NBR_DAYS/D12 =  NUM_DAYS;
  NBR_ROOMS/D12 = NUM_ROOMS;
  NEW_TOTAL_AMT/D14.2C = TOTAL_AMT;
  NNROOMS/D12 = IF ((NBR_DAYS LT 0) AND (NBR_ROOMS LT 0)) THEN 
                ((NBR_DAYS*NBR_ROOMS) * (-1)) ELSE NBR_DAYS*NBR_ROOMS;
  OUT_DATE/MDYY = CHKOUT_DATE;
  REFUSE_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
-* ****DEFINES ON PREVIOUS DEFINES****
MIR_SEQ1/A1 = EDIT(MIR_SEQ, '9$$$$$');

RES_SYS/A1 = IF MIR_SEQ1 EQ 'X' THEN 'S' ELSE 'A';

PROP_CODE1/A7 = IF RES_SYS EQ 'S' THEN PROP_SABRE_CODE ELSE PROP_APOLLO_CODE;
END
-RUN

TABLEF FILE &&EXTRACT
PRINT
  BR_CL_IDX	
  CHAIN_CODE 	
  CITY_ST
  DOD_TYPE
  ID_FLAG
  IN_DATE 
  INV_DATE	
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NEW_TOTAL_AMT	
  NNROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR
  PROP_ADDRESS 	
  PROP_CITY 
  PROP_CODE1 AS 'PROP_CODE'
  PROP_NAME 	
  PROP_PHONE
  PROP_STATE_CD 
  REFUSE_CD
-INCLUDE &HTLDATES   
-* WHERE INVOICE_DATE GE &&FROMDT.EVAL AND INVOICE_DATE LE &&TODT.EVAL
-* WHERE TOTAL_AMT NE 0
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS HHOLD
END
-RUN

TABLE FILE HHOLD
PRINT
  BR_CL_IDX	
  CHAIN_CODE 	
  CITY_ST
  DOD_TYPE
  ID_FLAG
  IN_DATE 
  INV_DATE	
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NEW_TOTAL_AMT	
  NNROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR
  PROP_ADDRESS 	
  PROP_CITY 
  PROP_CODE
  PROP_NAME 	
  PROP_PHONE
  PROP_STATE_CD 
  REFUSE_CD
BY CITY_ST
ON TABLE HOLD AS HHOLD2 
END
-RUN

DEFINE FILE METXHTL
HTL_MKT/A130 = IF H_MARKET NE ' ' THEN H_MARKET ELSE ST_CITY;
END
-RUN
TABLE FILE METXHTL
PRINT HTL_MKT
BY ST_CITY
WHERE ROLLUP_CODE EQ '&&RLUP'
ON TABLE HOLD AS METXH1 FORMAT FOCUS INDEX ST_CITY
END
-RUN

JOIN CITY_ST IN HHOLD2 TO ST_CITY IN METXH1 AS J1
END
-RUN

TABLE FILE HHOLD2
PRINT
  BR_CL_IDX	
  CHAIN_CODE 	
  CITY_ST
  DOD_TYPE
  ID_FLAG
  IN_DATE 
  INV_DATE	
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NEW_TOTAL_AMT	
  NNROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR
  PROP_ADDRESS 	
  PROP_CITY 
  PROP_CODE
  PROP_NAME 	
  PROP_PHONE
  PROP_STATE_CD 
  REFUSE_CD
  ST_CITY
BY HTL_MKT
ON TABLE HOLD AS HHOLD5
END
-RUN

TABLE FILE HHOLD5
PRINT
  BR_CL_IDX	
  CHAIN_CODE 	
  CITY_ST
  DOD_TYPE
  ID_FLAG
  IN_DATE 
  INV_DATE	
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NEW_TOTAL_AMT	
  NNROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR
  PROP_ADDRESS 	
  PROP_CITY 
  PROP_CODE
  PROP_NAME 	
  PROP_PHONE
  PROP_STATE_CD 
  REFUSE_CD
BY HTL_MKT
BY ST_CITY 
BY CITY_ST
WHERE CITY_ST NE ' '
ON TABLE HOLD AS &&RPT_HOLD
END
-RUN


