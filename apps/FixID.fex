-* File FIXID.FEX

-***************************************************************************
-* This program will copy a report set and all related report instances from
-* one user id to another.  The set_id and inst_id will be updated with a
-* date/time stamp to create a unique identifier.
-* DATE           NAME
-* 04/12/2002     Steve - creation
-***************************************************************************
-GOTO ROLLUP

-* -GOTO MUTM

SET ASNAMES = ON

USE
F:\TNT\TTRACKER\SUDATA\I_SUMM.FOC
F:\TNT\TTRACKER\SUDATA\RPT_INST.FOC
END
-RUN

-* UPDATE RPT_INST - INSTANCE_ID

TABLE FILE RPT_INST
PRINT INST_KEY INSTANCE_ID
BY INST_KEY NOPRINT
IF INST_KEY CONTAINS 'METX'
ON TABLE HOLD
END
-RUN

DEFINE FILE HOLD
NOWDATE2/A8 WITH INST_KEY =TODAY(NOWDATE2);
CC/A2 WITH INST_KEY ='20';
MM/A2 WITH INST_KEY =EDIT (NOWDATE2, '99');
DD/A2 WITH INST_KEY =EDIT (NOWDATE2, '$$$99');
YY/A2 WITH INST_KEY =EDIT (NOWDATE2, '$$$$$$99');
DATE/A8 WITH INST_KEY = CC || YY || MM || DD;
NOWTIME2/A8 WITH INST_KEY = HHMMSS(NOWTIME2);
-* HOUR/A2 WITH INST_KEY = EDIT (NOWTIME2, '99');
-* MINUTE/A2 WITH INST_KEY = EDIT (NOWTIME2, '$$$99');
D_SECOND/D6 = 000000;
END
-RUN

TABLE FILE HOLD
PRINT
COMPUTE L_SECOND/D6 = IF D_SECOND EQ LAST L_SECOND THEN
                      (L_SECOND + 1) ELSE (L_SECOND + 1); NOPRINT AND
COMPUTE A_SECOND/A6 = EDIT(L_SECOND); NOPRINT AND
COMPUTE TIME/A6 = A_SECOND; NOPRINT AND
COMPUTE NEWINSTID/A22= 'METX  ' | 'zz' || DATE || TIME; NOPRINT AND

 INST_KEY
 NEWINSTID
ON TABLE HOLD AS HOLD1
END
-RUN

TABLE FILE HOLD1
PRINT INST_KEY AND NEWINSTID AS 'INSTANCE_ID'
ON TABLE HOLD AS HOLD2
END
-RUN

MODIFY FILE RPT_INST
FIXFORM FROM HOLD2
MATCH INST_KEY
ON MATCH UPDATE INSTANCE_ID
ON NOMATCH REJECT
DATA ON HOLD2
END
-RUN

-* UPDATE I_SUMM - RPTKEY

TABLE FILE RPT_INST
PRINT INST_KEY INSTANCE_ID
BY INST_KEY NOPRINT
IF INST_KEY CONTAINS 'METX'
ON TABLE HOLD
END
-RUN

DEFINE FILE HOLD
RPTKEY/A30=INSTANCE_ID;
END
-RUN

TABLE FILE HOLD
PRINT INST_KEY RPTKEY
ON TABLE HOLD AS HOLD2
END
-RUN

MODIFY FILE I_SUMM
FIXFORM INST_KEY/A72 RPTKEY/A30
MATCH INST_KEY
ON MATCH UPDATE RPTKEY
ON NOMATCH REJECT
DATA ON HOLD2
END
-RUN
-EXIT

-DSTM

TABLE FILE M_DSTM
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR SEG_AMT SEG_TAX
IF TKT_SORT EQ '9000001409D'
ON TABLE HOLD
END
-RUN

MODIFY FILE M_DSTM
FIXFORM FROM HOLD
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH COMPUTE SEG_AMT=378.50;
ON MATCH UPDATE SEG_AMT
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
-EXIT

-MUTM

-SET &&CHKTARG = '        ';

-CHKLOOP

FILEDEF ALIST DISK K:\TNT\TTRACKER\TEMP\ALIST.TXT (LRECL 80
-RUN

FILEDEF BLIST DISK K:\TNT\TTRACKER\TEMP\BLIST.TXT (LRECL 80
-RUN

-READ ALIST &&CHKTARG
-IF &&CHKTARG EQ 'END' THEN GOTO XFER;
-TYPE CHKTARG &&CHKTARG
-TYPE IORETURN &IORETURN

-REPEAT BNEW WHILE &IORETURN EQ 0;
-READ ALIST &&SLINE.80
-TYPE IORETURN &IORETURN
-IF &IORETURN NE 0 THEN GOTO BNEW;
-WRITE BLIST &&SLINE
-BNEW

FILEDEF ALIST CLEAR
-RUN

FILEDEF BLIST CLEAR
-RUN

DOS COPY K:\TNT\TTRACKER\TEMP\BLIST.TXT K:\TNT\TTRACKER\TEMP\ALIST.TXT
-RUN

-SET &&COMP = SUBSTR(8, &&CHKTARG, 1, 7, 7, 'A7');
-SET &&CARCO = C || &&COMP;
-SET &&HTLCO = H || &&COMP;

-* -TYPE CHKTARG &&CHKTARG
-TYPE COMPANY &&COMP
-TYPE CARCO &&CARCO
-TYPE HTLCO &&HTLCO

TABLE FILE &&CARCO
PRINT CAR_KEY REFCDE
BY CAR_KEY NOPRINT
ON TABLE HOLD
END
-RUN

MODIFY FILE &&CARCO
FIXFORM FROM HOLD
MATCH CAR_KEY
ON MATCH COMPUTE REFKEY/A10 = '        '|REFCDE;
ON MATCH UPDATE REFKEY
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN

TABLE FILE &&HTLCO
PRINT HTL_KEY REFCDE
BY HTL_KEY NOPRINT
ON TABLE HOLD
END
-RUN

MODIFY FILE &&HTLCO
FIXFORM FROM HOLD
MATCH HTL_KEY
ON MATCH COMPUTE REFKEY/A10 = '        '|REFCDE;
ON MATCH UPDATE REFKEY
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN

-GOTO CHKLOOP

-XFER
-EXIT

-KIMB

-SET &&CHKTARG = '        ';

-CHKLOOP

FILEDEF ALIST DISK K:\TNT\TTRACKER\TEMP\ALIST.TXT (LRECL 80
-RUN

FILEDEF BLIST DISK K:\TNT\TTRACKER\TEMP\BLIST.TXT (LRECL 80
-RUN

-READ ALIST &&CHKTARG
-IF &&CHKTARG EQ 'END' THEN GOTO XFER;
-TYPE CHKTARG &&CHKTARG
-TYPE IORETURN &IORETURN

-REPEAT BNEW WHILE &IORETURN EQ 0;
-READ ALIST &&SLINE.80
-TYPE IORETURN &IORETURN
-IF &IORETURN NE 0 THEN GOTO BNEW;
-WRITE BLIST &&SLINE
-BNEW

FILEDEF ALIST CLEAR
-RUN

FILEDEF BLIST CLEAR
-RUN

DOS COPY K:\TNT\TTRACKER\TEMP\BLIST.TXT K:\TNT\TTRACKER\TEMP\ALIST.TXT
-RUN

-SET &&COMP = SUBSTR(8, &&CHKTARG, 1, 8, 8, 'A8');

-* -TYPE CHKTARG &&CHKTARG
-TYPE COMPANY &&COMP

SET ASNAMES=ON

TABLE FILE &&COMP
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
TRN_DATE DPT_DATE SEG_STANDARD SEG_DISCOUNT
SEG_LOWEST SEG_REASON SEG_CONTRACT
SEG_COUNT DPT_TIME SEG_AMT SEG_TAX
SEG_PCT SEG_COM AIRLINE FLIGHT CLASS CL_CAT
COUPON STOP_CON ALN_AFFL FARE_BAS SEG_DESIG
ARR_TIME ARR_DATE STAY INTL_DOM PFC_CHG
ND_ORG ND_DST ORG_DST SEG_MILES RF_FLAG EX_FLAG
HTL_DAYS CAR_DAYS
AROLL_LEV1 AROLL_LEV2 AROLL_LEV3
AROLL_LEV4 AROLL_LEV5 AROLL_LEV6
AROLL_LEV7 AROLL_LEV8 AROLL_LEV9
AROLL_LEV10 AROLL_LEV11 AROLL_LEV12
AROLL_LEV13 AROLL_LEV14 AROLL_LEV15
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
IF EMBARK EQ 'FP2' OR 'FP3'
ON TABLE HOLD
END
-RUN

MODIFY FILE &&COMP
FIXFORM FROM HOLD
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH DELETE
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN

DEFINE FILE HOLD
NEWTKT/A10 = EDIT(TKT_SORT, '9999999999$');
NEWTKT2/A11 = NEWTKT||'C';
END

TABLE FILE HOLD
PRINT AIR_KEY EMBARK ROUTE NEWTKT2 AS 'TKT_SORT' SEG_NBR
TRN_DATE DPT_DATE SEG_STANDARD SEG_DISCOUNT
SEG_LOWEST SEG_REASON SEG_CONTRACT
SEG_COUNT DPT_TIME SEG_AMT SEG_TAX
SEG_PCT SEG_COM AIRLINE FLIGHT CLASS CL_CAT
COUPON STOP_CON ALN_AFFL FARE_BAS SEG_DESIG
ARR_TIME ARR_DATE STAY INTL_DOM PFC_CHG
ND_ORG ND_DST ORG_DST SEG_MILES RF_FLAG EX_FLAG
HTL_DAYS CAR_DAYS
AROLL_LEV1 AROLL_LEV2 AROLL_LEV3
AROLL_LEV4 AROLL_LEV5 AROLL_LEV6
AROLL_LEV7 AROLL_LEV8 AROLL_LEV9
AROLL_LEV10 AROLL_LEV11 AROLL_LEV12
AROLL_LEV13 AROLL_LEV14 AROLL_LEV15
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
ON TABLE HOLD AS HOLD2
END
-RUN

MODIFY FILE &&COMP
FIXFORM FROM HOLD2
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON HOLD2
END
-RUN

-GOTO CHKLOOP

-XFER
-EXIT

-ROLLUP

FI IDLEVELS DISK K:\AS400\IDLEVELS.TXT

USE CLEAR *
  USE K:\TNT\TTRACKER\SUDATA\ROLLUP.FOC
END
-RUN

SET ASNAMES=ON

TABLE FILE IDLEVELS
PRINT ROLLUP AS 'ROLLUP_CODE' LEV1 LEV2 LEV3
BY ROLLUP NOPRINT
ON TABLE HOLD
END
-RUN

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP_CODE
ON MATCH UPDATE LEV1 
ON MATCH UPDATE LEV2
ON MATCH UPDATE LEV3
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
-EXIT


