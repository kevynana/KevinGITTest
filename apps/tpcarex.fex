-* 1/30/13 - DEB changed due to expansion of car database to
-* include trip purpose
-* CHANGED CODE DUE TO DRILL DOWN NOT WORKING - DEB 11/18/13
-* ADDED PREFERRED/NON-PREFERRED LOGIC - JK 3/31/14
-* Updated CSMC define to count cars larger than midsize - JK 4/3/14 - Per Jami
-*  02/05/2015  REJ  S-05681 Changes for Available Reports.  Adding code so that the
-*                           program will run in current Review and in Available Reports.
-*02/12/16 - DLV - S-13286  Updated to allow reports to sort/subtotal by id-levels
 
-INCLUDE SETECHO
 
FILEDEF RPTPARMS CLEAR
-RUN
 
EX CARUSE
-RUN
 
-SET &&RPTGRP = 'CAR';
EX UDIDGEN
-RUN
 
DEFINE FILE BRPTINST
  RT/A3 = 'CAR';
END
TABLE FILE BRPTINST
PRINT RT AS 'RPT_GROUP'
BY INST_KEY
ON TABLE SAVE AS AIRACH00
END
-RUN
MODIFY FILE BRPTINST
-IF &&FROMAVRP EQ 'Y' GOTO :TPC1;
FIXFORM INST_KEY/7 RPT_GROUP/3
-GOTO :TPC1_CONT;
-:TPC1
FIXFORM INST_KEY/11 RPT_GROUP/3
-:TPC1_CONT
MATCH INST_KEY
  ON MATCH UPDATE RPT_GROUP
DATA ON AIRACH00
END
-RUN
 
-IF &&FROMAVRP EQ 'Y' GOTO :TPC2;
-* rej - don't understand what this modify is doing??
MODIFY FILE BRPTFLDS
FIXFORM INST_KEY/7 CAR.ID/1 CAR.INCL1/1
REPOSITION INST_KEY
MATCH INST_KEY
  ON MATCH CONTINUE
  ON NOMATCH INCLUDE
MATCH * KEYS SEG CAR
  ON NOMATCH INCLUDE
  ON MATCH UPDATE CAR.INCL1
DATA ON AIRACH00
END
-RUN
-:TPC2
 
EX CODEGEN
-RUN

-SET &&IDLEVELBREAK = ' ';
-RUN
 
-SET &CARDATES = &&WEB_PATH || 'CARDATES.fex';

-INCLUDE IDLEVROLLDEF
-RUN
 
DEFINE FILE &&EXTRACT
CAR_AMT/D12.2CS = RENTAL_AMT;
LEVEL_DESC1/A60      = &&LDESC;
CBOOK/P8CS = IF NUM_DAYS GT 0 THEN 1 ELSE IF NUM_DAYS LT 0 THEN (-1) ELSE 0;
NBR_DAYS/D12 = NUM_DAYS;
CAR_DAYS/D12 = IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                   ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;
 
TRN_DATE/YYMD = INVOICE_DATE;
TRIP_KEY/A2   = EDIT(TRP_KEY, '$$$$$$$$99');
TRIPRSN/A10 = IF TRIP_KEY NE ' ' THEN TRIP_KEY ELSE 'ZZZZZZZZZZ';
TRIP_RSN/A10 = IF TRIPRSN EQ 'ZZZZZZZZZZ' THEN 'NONE GIVEN' ELSE TRIPRSN;
CPREFB/P8CS = IF CLIENT_PREF EQ 'P' THEN CBOOK ELSE 0;
CSMC/P8CS = IF (DAILY_RATE GE 0) AND (CAR_CAT NE 'INTERMEDIATE' OR 'MIDSIZE' OR 'ECONOMY' OR 'COMPACT') THEN 1 ELSE
            IF (DAILY_RATE LT 0) AND (CAR_CAT NE 'INTERMEDIATE' OR 'MIDSIZE' OR 'ECONOMY' OR 'COMPACT') THEN (-1) ELSE 0;
-INCLUDE IDLEVDEFINE  

END
TABLE FILE &&EXTRACT
PRINT CBOOK CAR_DAYS CAR_AMT LEVEL_DESC TRIP_KEY TRIP_RSN  TRP_REF.TRP_DESC CPREFB CSMC 
BY CAR_KEY
-INCLUDE &CARDATES
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLDC
END
-RUN
 
-*JOIN CAR_KEY IN RPTHLDC TO CAR_KEY IN CARUDID
-*-RUN
 
-*DEFINE FILE RPTHLDC
-*TRIP_KEY/A2 = IF UDID EQ 'TP-' THEN EDIT(AUD_DATA, '99') ELSE ' ';
-*TRIPRSN/A10 = IF TRIP_KEY NE ' ' THEN TRIP_KEY ELSE 'ZZZZZZZZZZ';
-*TRIP_RSN/A10 = IF TRIPRSN EQ 'ZZZZZZZZZZ' THEN 'NONE GIVEN' ELSE TRIPRSN;
-*END
TABLE FILE RPTHLDC
PRINT CBOOK CAR_DAYS CAR_AMT CPREFB CSMC 
BY LEVEL_DESC
BY TRIP_KEY
BY TRP_DESC
BY TRIP_RSN
-*WHERE UDID EQ 'TP-'
ON TABLE HOLD AS CARHLDA
END
-RUN
 
TABLE FILE CARHLDA
SUM CBOOK CAR_DAYS CAR_AMT CPREFB CSMC 
BY LEVEL_DESC
BY TRIP_KEY
BY TRIP_RSN
BY TRP_DESC
ON TABLE HOLD AS CARHLD
END
-RUN
 
 
