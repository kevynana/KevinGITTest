-*5/3/16-S-18439-JEM-Created for new report TCVSAVEM which is a copy of TCVSAVE which sorts by transaction month/year  
-*7/20/16&-S-21396-Added defines for nr_ref_cnt nr_ref_amt this will shows non-refundable tickets refunded on the report 
-*7/26/16-S-22032-Updated date to be hard coded for transaction date as it was sometimes passing fst_dpt_date. This report is only available to run for transaction date
-*10/16/17 - D-01666 - DLV - Updated to use new hotel attachment logic removed TT_PUR TT_PURHA

-INCLUDE SETECHO
SET ASNAMES = ON 

-*======================================================================== 
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED
-*========================================================================
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

DEFINE FILE SR_50

STD_CAT/A1 = IF TKT_CL_CAT CONTAINS 'F' THEN 'F' ELSE
                 IF TKT_CL_CAT CONTAINS 'B' THEN 'B' ELSE 
                 IF TKT_CL_CAT CONTAINS 'P' THEN 'P' ELSE 
                 IF TKT_CL_CAT CONTAINS 'U' THEN 'U' ELSE 
                 IF TKT_CL_CAT CONTAINS 'E' THEN 'E' ELSE 'D';  
 
  FAR_PAID/P15.2CS =   SEG_AMT + SEG_TAX;                  
  FARE_PAID/P15.2CS   = IF VOID_DATE EQ 0 THEN FAR_PAID ELSE 0;
  NET_TKT_CNT/P8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;  
  NET_TKTS/P12CS = IF VOID_DATE EQ 0 THEN NET_TKT_CNT ELSE 0;                           
  NEW_SEG_AMT/P15.2 = IF VOID_STATUS EQ '0' THEN SEG_AMT ELSE 0;	                      
  NEW_SEG_DISC/P15.2CS = IF VOID_DATE EQ 0 THEN SEG_DISCOUNT ELSE 0;
  TKT_PURCH1/P8.2       = IF (TICKET_CODE EQ '1') AND
                             (SEG_NBR EQ '01') AND
                             (FARE_PAID GE 0) AND
                             (SEG_COUNT EQ 1) AND 
                             (CONJ_REL EQ 1) THEN 1 ELSE 0; 
                             
SALES_FLAG/A1 = IF RF_FLAG EQ ' ' AND EX_FLAG EQ ' '  AND VOID_DATE EQ 0
  THEN 'S' 
  ELSE IF RF_FLAG EQ ' ' AND EX_FLAG EQ ' '  AND VOID_DATE NE 0
  THEN 'V' ELSE ' ';   
TRNMY/MTY = TRN_DATE;  
  
-*Defines after previous defines
 ALN_FEE/P15.2CS = IF EMBARK EQ 'FP2' OR 'FP3' THEN FARE_PAID ELSE 0;

-*  GROSS_VOL/P15.2CS = IF (VOID_DATE EQ 0) THEN NEW_SEG_AMT ELSE 0;
  GROSS_VOL/P15.2CS = FARE_PAID;

  DISSAVINGS/P11.2CS  = IF VOID_DATE EQ 0 AND EMBARK EQ 'DT1' THEN 0 ELSE
                         IF VOID_DATE EQ 0 THEN FARE_PAID - SEG_LOWEST;
  VASAVINGS/P15.2CS    = IF VOID_DATE EQ 0 THEN NEW_SEG_DISC - FARE_PAID ELSE 0;

  DOM_CNT/P8CS = IF VOID_DATE EQ 0 AND AIR_MAIN.INTL_DOM EQ 'D' THEN NET_TKT_CNT ELSE 0;
  DOM_FARE/P12.2CS = IF VOID_DATE EQ 0 AND AIR_MAIN.INTL_DOM EQ 'D' THEN FARE_PAID ELSE 0;
  
  DTRD_CNT/P12CS = IF VOID_DATE EQ 0 AND ONLINE_TRADITIONAL EQ 'TRADITIONAL' THEN 
                      DOM_CNT ELSE 0;
 
  DONL_CNT/P12CS = IF VOID_DATE EQ 0 AND ONLINE_TRADITIONAL EQ 'ONLINE' AND AIRLINE NE '2V' THEN 
                      DOM_CNT ELSE 0;
  DONL_CNT2/P12CS = IF VOID_DATE EQ 0 AND ONLINE_TRADITIONAL EQ 'ONLINE' THEN 
                      DOM_CNT ELSE 0;
  DTRD_FARE/P15.2CS = IF VOID_DATE EQ 0 AND ONLINE_TRADITIONAL EQ 'TRADITIONAL'  THEN
                         DOM_FARE ELSE 0;
  DONL_FARE/P15.2CS = IF VOID_DATE EQ 0 AND ONLINE_TRADITIONAL EQ 'ONLINE'  THEN
                          DOM_FARE ELSE 0;         
                          
 
 
  DTRD_AVG/P12.2CS =  IF ((DTRD_CNT LT 1) AND (DTRD_CNT GT (-1))) AND AIRLINE NE '2V' THEN 0 ELSE (DTRD_FARE/DTRD_CNT);
  
  DONL_AVG/P12.2CS =  IF ((DONL_CNT LT 1) AND (DONL_CNT GT (-1))) AND AIRLINE NE '2V' THEN 0 ELSE (DONL_FARE/DONL_CNT);
  
 
  LS_DSAV/P12.2CS = IF VOID_DATE EQ 0 THEN DISSAVINGS ELSE 0;
  NR_NET_TKTS/P12CS = IF (VOID_DATE EQ 0) AND (NONREF_FLAG EQ 'N') THEN NET_TKT_CNT ELSE 0;
  NR_REF_CNT1/P12CS = IF (VOID_DATE EQ 0) AND (NONREF_FLAG EQ 'N') AND (RF_FLAG NE ' ') THEN NET_TKT_CNT ELSE 0;
  NR_REF_CNT/P12CS = NR_REF_CNT1 * (-1);
  NR_REF_AMT1/P12.2CS = IF (VOID_DATE EQ 0) AND (NONREF_FLAG EQ 'N') AND (RF_FLAG NE ' ') THEN FARE_PAID ELSE
                        IF (VOID_DATE EQ 0) AND (NONREF_FLAG EQ 'N') AND (EMBARK EQ 'RF1') THEN FARE_PAID ELSE 0;
  NR_REF_AMT/P12.2CS = NR_REF_AMT1 * (-1);   
 
  FR_DSAV/P12.2CS = IF VOID_DATE EQ 0 AND REFUSE_CODE EQ 'FR' THEN DISSAVINGS ELSE 0; 
 SOFT_FARE/P15.2CS = IF VOID_DATE EQ 0 AND REFUSE_CODE EQ 'SD' THEN FARE_PAID ELSE 0;
  
 SEG_RSN/P15.2CS = IF VOID_DATE EQ 0 THEN SEG_REASON ELSE 0;
 MISC_SAV/P15.2CS = IF VOID_DATE EQ 0 THEN SEG_RSN - FARE_PAID ELSE 0;



REFUND_TOTAL/P15.2CS =  IF (((VOID_DATE EQ 0) AND (RF_FLAG EQ 'F' OR 'P') AND 
   ((EMBARK NE 'EX1' OR 'FP2' OR 'EX5') OR (EMBARK EQ 'RF1')) AND (SEG_COUNT LE 0)))  THEN FARE_PAID ELSE 0;
ROLLUP_CODE1/A8 = '&&ROLL';   


VOID_TOTAL/P15.2CS = IF VOID_DATE NE 0 THEN FAR_PAID ELSE 0;
             

AVOLVS/P12.2CS = IF VASAVINGS EQ 0 THEN 0 ELSE FARE_PAID;

-* New Fields Added per Patti 
DNR/P12CS = IF AIR_MAIN.INTL_DOM EQ 'D' THEN NR_NET_TKTS ELSE 0;
INR/P12CS = IF AIR_MAIN.INTL_DOM EQ 'I' THEN NR_NET_TKTS ELSE 0;
DOM_NT/P12CS = IF AIR_MAIN.INTL_DOM EQ 'D' THEN NET_TKTS ELSE 0;
INT_NT/P12CS = IF AIR_MAIN.INTL_DOM EQ 'I' THEN NET_TKTS ELSE 0;
06ADV/P12CS = IF (VOID_DATE EQ 0) AND (ADV_PURCH LT 7) THEN NET_TKT_CNT ELSE 0;
FB_FARE/P15.2CS = IF CL_CAT EQ 'F' OR 'B' AND VOID_DATE EQ 0 THEN FARE_PAID ELSE 0;
BUS_FARE/P15.2CS = IF STD_CAT EQ 'B' AND VOID_DATE EQ 0 THEN FARE_PAID ELSE 0;
BUS_TKT/P8CS = IF STD_CAT EQ 'B' AND VOID_DATE EQ 0 THEN NET_TKT_CNT ELSE 0;
ADVSV/P12.2CS = IF VOID_DATE EQ 0 THEN SEG_AGENCY_DISC - FARE_PAID ELSE 0 ;
-* DOM_NT/P12CS = IF AIR_MAIN.INTL_DOM EQ 'D' THEN NET_TKTS ELSE 0;
-* INT_NT/P12CS = IF AIR_MAIN.INTL_DOM EQ 'I' THEN NET_TKTS ELSE 0;
DOM_FP/P12.2CS = IF AIR_MAIN.INTL_DOM EQ 'D' THEN FARE_PAID ELSE 0;
INT_FP/P12.2CS = IF AIR_MAIN.INTL_DOM EQ 'I' THEN FARE_PAID ELSE 0;
TT_PUR/P12CS = IF EX_FLAG EQ 'E' THEN TKT_PURCH1 ELSE 
             IF SALES_FLAG EQ 'S' THEN TKT_PURCH1 ELSE 0;
              
TT_PURHA/P12CS = IF HOTEL_FLAG NE ' ' THEN TT_PUR ELSE 0;

TT_PURNHA/P12 = IF HOTEL_FLAG EQ ' ' THEN TT_PUR ELSE 0; 
-* Added for Total Trans

ORIG_SALE/P12 = IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND (SEG_COUNT EQ 1) AND (EXCHG_SALE EQ ' ') THEN 1 ELSE IF (DOC_TYPE EQ '1') AND
          (EX_FLAG EQ ' ') AND (EXCHG_SALE NE ' ') AND (RF_FLAG EQ ' ') THEN 1 ELSE 0;	
          
          
TKT_CNT/P12CS = IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND (SEG_COUNT 
  EQ 1) THEN 1 ELSE 0;	
  
FULL_RFNDS/P12 = IF ((VOID_DATE EQ 0) AND (RF_FLAG EQ 'F') AND (DOC_TYPE NE '1') AND (SEG_NBR EQ '01') AND (SEG_COUNT LT 0)) THEN 1 ELSE 0;
                           
  
  
PART_RFNDS/P12 = IF ((VOID_DATE EQ 0) AND (RF_FLAG EQ 'P') AND (TKT_NUM 
  NE LAST TKT_NUM) AND (SEG_COUNT LE 0)) THEN 1 ELSE 0;

REFUNDS/P12 = FULL_RFNDS + PART_RFNDS;	
  

EXCHGS/P12 = IF (EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (EMBARK 
 NE 'DT1' OR 'RF1' OR 'FP3') THEN TKT_CNT ELSE IF (DOC_TYPE EQ '1') AND 
(EXCHG_SALE EQ 'E') THEN 0 ELSE IF (SEG_COUNT GE 0) AND (EXCHG_SALE NE 
  ' ') THEN TKT_CNT ELSE 0; 
  
EXMCOS/P12 = IF (EX_FLAG NE ' ') AND (DOC_TYPE EQ '1') AND (EXCHG_SALE 
	NE ' ') THEN 1 ELSE 0;  
	
VOIDS/P12 = IF (VOID_DATE NE 0) AND (SEG_COUNT EQ 1) AND (SEG_NBR EQ '01')
 THEN 1 ELSE IF (DOC_TYPE EQ '1' AND VOID_DATE NE 0) THEN 1 ELSE 0;	
	

TOT_ECNT/P12 = EXCHGS + EXMCOS;	


TOT_TRANS/P12 = ORIG_SALE + VOIDS + TOT_ECNT + REFUNDS;


CHARGE_TRN/P15CS = ORIG_SALE + EXCHGS ;
ONLCHG_TRN/P15CS = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN CHARGE_TRN ELSE 0;
TRDCHG_TRN/P15CS = IF ONLINE_TRADITIONAL EQ 'TRADITIONAL' THEN CHARGE_TRN ELSE 0;
EXEC_ONLTRN/P12CS = IF DOD_TYPE EQ 'J' THEN CHARGE_TRN ELSE 0;
EXEC_TRDTRN/P12CS = IF DOD_TYPE EQ 'K' THEN CHARGE_TRN ELSE 0;

F_EXCH_CNT/D8CS   = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 0 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN 1 ELSE 0;
-* F_EXCH_FARE/P15.2CS   = IF (TICKET_CODE EQ '1') AND
-*                            (SEG_NBR EQ '01') AND
-*                            (FARE_PAID GE 0) AND
-*                            (SEG_COUNT EQ 1) AND 
-*                            (CONJ_REL EQ 1) THEN 0 ELSE 
-*                         IF (TICKET_CODE EQ '1') AND
-*                            (SEG_NBR EQ '01') AND 
-*                            (EX_FLAG EQ 'F') THEN FARE_PAID ELSE 0;          
F_EXCH_FARE/P15.2CS =  IF  (TICKET_CODE EQ '1') AND (EX_FLAG EQ 'F')  AND (SEG_COUNT LE 0) AND (RF_FLAG EQ ' ')  THEN FARE_PAID ELSE 0;
                           
FE_CNT/P12 = IF VOID_DATE EQ 0 THEN F_EXCH_CNT ELSE 0; 
FE_FARE/P15.2CS = IF VOID_DATE EQ 0 THEN F_EXCH_FARE ELSE 0;
NR_FARE/P15.2CS = IF NONREF_FLAG EQ 'N' THEN FARE_PAID ELSE 0;
NR_TKTS/P8CS = IF NONREF_FLAG EQ 'N' THEN NET_TKTS ELSE 0;

EX_RF_FLAG/A1 = IF (((RF_FLAG EQ 'F' OR 'P') AND (EMBARK NE 'EX1' OR 'FP2' OR 'EX5') AND 
                     (SEG_COUNT LE 0)) OR (EMBARK EQ 'RF1')) THEN 'R' ELSE 
                  IF (((EXSALE NE ' ') AND (SEG_COUNT GE 0)) OR ((EMBARK NE 'DT1') AND 
                      (EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (RF_FLAG EQ ' ')))  THEN 'E'  ELSE ' ';
                      
TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' '; 
                          
                          

END


TABLE FILE SR_50
PRINT 
ADVSV
CHARGE_TRN
DONL_CNT 
DONL_FARE
DTRD_CNT
DTRD_FARE
EXEC_ONLTRN
EXEC_TRDTRN
EX_RF_FLAG
FARE_PAID
GROSS_VOL       
ONLCHG_TRN 
LS_DSAV
NET_TKTS
NR_NET_TKTS
REFUND_TOTAL    
SOFT_FARE   
TRDCHG_TRN
VASAVINGS      
VOID_TOTAL  
FR_DSAV
TKT_NUM
TOT_TRANS
AVOLVS
EXCHGS
REFUNDS
VOIDS
ORIG_SALE
DNR
INR
06ADV
FB_FARE
ALN_FEE
FE_CNT
FE_FARE
NR_FARE
NR_TKTS
TKT_TYPE
CATEGORY
VAL_AIRLINE
CATEGORY
FST_DPT_DATE
AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
TKT_NUM
BUS_FARE
BUS_TKT
TRN_DATE
BR_CL_IDX
DOM_NT
INT_NT
DOM_FP
INT_FP
TRNMY
NR_REF_CNT
NR_REF_AMT
BY ROLLUP_CODE1 

-* -INCLUDE &AIRDATES
 WHERE TRN_DATE GE &&FROMDT.EVAL AND TRN_DATE LE &&TODT.EVAL

&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE RPTPARMS
-IF &&SETF NE 'TCVASUA' GOTO NOUAWHR;
WHERE VAL_AIRLINE EQ 'UA'
-NOUAWHR;
ON TABLE HOLD AS TCVASA FORMAT FOCUS INDEX ROLLUP_CODE1
END
-RUN


TABLE FILE PREFAIR
PRINT ROLLUP_CODE
-*AIRLINE_CODE AIRLINE_CATEGORY TICKET_EFFECTIVE_DATE TICKET_EXPIRATION_DATE TSINT
AIRLINE_CODE AIRLINE_CATEGORY TICKET_EFFECTIVE_DATE TICKET_EXPIRATION_DATE TSINT GROUP_NUMBER DEPART_EFFECTIVE_DATE DEPART_EXPIRATION_DATE
WHERE ROLLUP_CODE EQ '&&ROLL.EVAL'
ON TABLE SET ASNAMES ON
ON TABLE HOLD AS NWPREFAIR FORMAT FOCUS INDEX ROLLUP_CODE
END
-RUN

-SET &PAIRRECS=IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-RUN

-IF &PAIRRECS EQ 0 GOTO NOPREFJOIN;

JOIN CLEAR *

JOIN ROLLUP_CODE1 IN TCVASA TO ALL ROLLUP_CODE IN NWPREFAIR AS J1
-RUN

-NOPREFJOIN;

TABLE FILE NWPREFAIR
SUM GROUP_NUMBER
BY GROUP_NUMBER NOPRINT
WHERE GROUP_NUMBER NE ' '
ON TABLE SAVE AS GROUP
END
-RUN

-SET &GROUPCK = IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';
-IF &GROUPCK EQ 'N' THEN GOTO Contt:

-READ GROUP &GN.A9
-CLOSE GROUP

-Contt:

DEFINE FILE TCVASA
-*PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
-*            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND (FST_DPT_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND (AIRLINE_INT_DOM EQ 'B')  THEN 1 ELSE 
-*            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND (FST_DPT_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE 0;
-IF &GROUPCK EQ 'Y' THEN GOTO NWPDEFINET;
PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
             IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B')  THEN 1 ELSE 
            IF  (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') THEN 1 ELSE 
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE 0;
-GOTO FinDefineT;
-NWPDEFINET;
PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B')  AND (BR_CL_IDX EQ GROUP_NUMBER)  THEN 1 ELSE 
            IF  (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 0;
-FinDefineT
END

TABLE FILE TCVASA
SUM
ADVSV
CHARGE_TRN
DONL_CNT 
DONL_FARE
DTRD_CNT
DTRD_FARE
EXEC_ONLTRN
EXEC_TRDTRN
EX_RF_FLAG
FARE_PAID
GROSS_VOL       
ONLCHG_TRN 
LS_DSAV
NET_TKTS
NR_NET_TKTS
REFUND_TOTAL    
SOFT_FARE   
TRDCHG_TRN
VASAVINGS      
VOID_TOTAL  
FR_DSAV
TKT_NUM
TOT_TRANS
AVOLVS
EXCHGS
REFUNDS
VOIDS
ORIG_SALE
DNR
INR
06ADV
FB_FARE
ALN_FEE
FE_CNT
FE_FARE
NR_FARE
NR_TKTS
BUS_FARE
BUS_TKT
DOM_NT
INT_NT
DOM_FP
INT_FP
NR_REF_CNT
NR_REF_AMT
-IF '&PAIRRECS.EVAL' EQ 'N' GOTO NPCOMP;
COMPUTE PREF_AIR1/A1 = IF PREF_AIRA GT 0 THEN 'P' ELSE 'N'; 
-GOTO PREFCONT;
-NPCOMP;
COMPUTE PREF_AIR1/A1 = 'N';
-PREFCONT;
BY ROLLUP_CODE1
BY TKT_NUM
BY VAL_AIRLINE
BY FST_DPT_DATE
BY CATEGORY
BY BR_CL_IDX
BY DOM_INTL_CODE
BY TKT_TYPE
BY TRNMY
ON TABLE HOLD AS TCVASA2
END
-RUN

DEFINE FILE TCVASA2
PREF_AIR/P12CS = IF PREF_AIR1 EQ 'P' THEN NET_TKTS ELSE 0;
END

TABLE FILE TCVASA2
SUM 
ADVSV
CHARGE_TRN
DONL_CNT 
DONL_FARE
DTRD_CNT
DTRD_FARE
EXEC_ONLTRN
EXEC_TRDTRN
EX_RF_FLAG
FARE_PAID
GROSS_VOL       
ONLCHG_TRN 
LS_DSAV
NET_TKTS
NR_NET_TKTS
REFUND_TOTAL    
SOFT_FARE   
TRDCHG_TRN
VASAVINGS      
VOID_TOTAL  
FR_DSAV
TKT_NUM
TOT_TRANS
AVOLVS
EXCHGS
REFUNDS
VOIDS
ORIG_SALE
DNR
INR
06ADV
FB_FARE
ALN_FEE
FE_CNT
FE_FARE
NR_FARE
NR_TKTS
PREF_AIR
BUS_FARE
BUS_TKT
BR_CL_IDX
DOM_NT
INT_NT
DOM_FP
INT_FP
NR_REF_CNT
NR_REF_AMT
BY TKT_NUM
BY TKT_TYPE
BY TRNMY
ON TABLE HOLD AS TCVASA5
END
-RUN


DEFINE FILE TCVASA5
CG_PCNT/D12CS = IF TKT_NUM NE LAST TKT_NUM THEN 1 ELSE 0;
CG_PFARE/P15.2CS = IF TKT_NUM NE LAST TKT_NUM THEN FARE_PAID ELSE 0;
END
TABLE FILE TCVASA5
SUM CG_PCNT CG_PFARE 
BY TKT_NUM
BY TRNMY
WHERE EX_RF_FLAG EQ 'E' 
WHERE TKT_TYPE EQ 'P-EX'
ON TABLE COLUMN-TOTAL
ON TABLE HOLD AS TCVASA1
END
-RUN

TABLE FILE TCVASA5
SUM  ADVSV
     DONL_CNT/D12CS
     DONL_FAR
     DTRD_CNT
     DTRD_FARE
     EXEC_ONLTRN
     EXEC_TRDTRN
     GROSS_VOL   
     ONLCHG_TRN
     NET_TKTS
     NR_NET_TKTS
     REFUND_TOTAL
     SOFT_FARE
     TRDCHG_TRN
     VASAVINGS 
     VOID_TOTAL
     LS_DSAV
     FR_DSAV
     AVOLVS
     TOT_TRANS
     DNR
     INR
     06ADV
     FB_FARE
     ALN_FEE
     FE_CNT
     FE_FARE
     NR_FARE
     NR_TKTS
     PREF_AIR
     BUS_FARE
     BUS_TKT
     BR_CL_IDX
     DOM_NT
     INT_NT
     DOM_FP
     INT_FP
     NR_REF_CNT
     NR_REF_AMT
BY TKT_NUM
BY TRNMY
ON TABLE HOLD AS TCVS1
END
-RUN



MATCH FILE TCVS1
SUM  ADVSV
     DONL_CNT
     DONL_FAR
     DTRD_CNT
     DTRD_FARE
     EXEC_ONLTRN
     EXEC_TRDTRN
     GROSS_VOL   
     ONLCHG_TRN
     NET_TKTS
     NR_NET_TKTS
     REFUND_TOTAL
     SOFT_FARE
     TRDCHG_TRN
     VASAVINGS 
     VOID_TOTAL
     LS_DSAV
     FR_DSAV
     AVOLVS
     TOT_TRANS
     DNR
     INR
     06ADV
     FB_FARE
     ALN_FEE
     FE_CNT
     FE_FARE
     NR_FARE
     NR_TKTS
     PREF_AIR
     BUS_FARE
     BUS_TKT
     BR_CL_IDX
     DOM_NT
     INT_NT
     DOM_FP
     INT_FP
     NR_REF_CNT
     NR_REF_AMT
BY TKT_NUM
BY TRNMY
ON TABLE HOLD
RUN
FILE TCVASA1
SUM CG_PCNT CG_PFARE
BY TKT_NUM
BY TRNMY
AFTER MATCH HOLD AS TCVASAV OLD-OR-NEW
END
-RUN


TABLE FILE TCVASAV
SUM  ADVSV
     CG_PCNT
     CG_PFARE
     DONL_CNT/D12CS
     DONL_FAR
     DTRD_CNT
     DTRD_FARE
     EXEC_ONLTRN
     EXEC_TRDTRN
     GROSS_VOL   
     ONLCHG_TRN
     NET_TKTS
     NR_NET_TKTS
     REFUND_TOTAL
     SOFT_FARE
     TRDCHG_TRN
     VASAVINGS 
     VOID_TOTAL
     LS_DSAV
     FR_DSAV
     AVOLVS
     TOT_TRANS
     DNR
     INR
     06ADV
     FB_FARE
     ALN_FEE
     FE_CNT
     FE_FARE
     NR_FARE
     NR_TKTS
     PREF_AIR
     BUS_FARE
     BUS_TKT
     BR_CL_IDX
     DOM_NT
     INT_NT
     DOM_FP
     INT_FP
     NR_REF_CNT
     NR_REF_AMT
BY TKT_NUM
BY TRNMY
ON TABLE HOLD AS TCVAS
END
-RUN


-IF &LINES EQ 0 THEN GOTO NEXTONE;
-*========================================================================
-*   PROCESS EXTRACTED DATA FROM ABOVE
-*========================================================================
DEFINE FILE TCVAS
ROLLCD/A8 = '&&ROLL';
END
TABLE FILE TCVAS
SUM  
     CG_PCNT
     CG_PFARE
     DONL_CNT/D12CS
     DONL_FAR
     DTRD_CNT
     DTRD_FARE
     EXEC_ONLTRN
     EXEC_TRDTRN
     GROSS_VOL 
     NR_NET_TKTS
     NET_TKTS
     ONLCHG_TRN
     REFUND_TOTAL
     SOFT_FARE
     TRDCHG_TRN
     VASAVINGS 
     VOID_TOTAL
     LS_DSAV
     FR_DSAV
     AVOLVS
     TOT_TRANS
     DNR
     INR
     06ADV
     FB_FARE
     ALN_FEE
     FE_CNT
     FE_FARE
     NR_FARE
     NR_TKTS
     PREF_AIR
     BUS_FARE
     BUS_TKT
     ADVSV
     INT_FP
     NR_REF_CNT
     NR_REF_AMT
  COMPUTE   DTRD_AVG/P12.2CS =  IF ((DTRD_CNT LT 1) AND (DTRD_CNT GT (-1))) THEN 0 ELSE (DTRD_FARE/DTRD_CNT);
  COMPUTE  DONL_AVG/P12.2CS =  IF ((DONL_CNT LT 1) AND (DONL_CNT GT (-1))) THEN 0 ELSE (DONL_FARE/DONL_CNT);
  COMPUTE BUS_ATP/P12.2CS = IF BUS_TKT EQ 0 THEN 0 ELSE BUS_FARE/BUS_TKT;
  COMPUTE DOM_ATP/P12.2CS = IF DOM_NT EQ 0 THEN 0 ELSE DOM_FP/DOM_NT;
  COMPUTE INT_ATP/P12.2CS = IF INT_NT EQ 0 THEN 0 ELSE INT_FP/INT_NT; 
BY TRNMY
BY ROLLCD
ON TABLE HOLD AS TCVAS1
END
-RUN


DEFINE FILE TCVAS1
 NMB/I5 = NMB + 1;
END

TABLE FILE TCVAS1
PRINT 
      CG_PCNT
      CG_PFARE
      DONL_AVG
      DTRD_AVG
      DONL_CNT 
      ONLCHG_TRN 
      TRDCHG_TRN
      GROSS_VOL 
      NR_NET_TKTS
      NET_TKTS
      REFUND_TOTAL
      SOFT_FARE
      VASAVINGS
      VOID_TOTAL
      LS_DSAV
      EXEC_ONLTRN
      EXEC_TRDTRN
      FR_DSAV
      AVOLVS
      TOT_TRANS
      DNR
      INR
      06ADV
      FB_FARE
      ALN_FEE
      FE_CNT
      FE_FARE
      NR_FARE
      NR_TKTS
      PREF_AIR
      BUS_ATP
      ADVSV
      DOM_ATP
      INT_ATP
      INT_FP
      NR_REF_CNT
      NR_REF_AMT
BY TRNMY
BY ROLLCD
ON TABLE HOLD AS TCV3
END
-RUN


MODIFY FILE TC_VSAVM
FIXFORM FROM TCV3
MATCH TRNMY ROLLCD
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON TCV3
END
-RUN


-NEXTONE

