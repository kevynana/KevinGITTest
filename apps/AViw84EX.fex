-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* This was created for Conagra's Adv Purchase reports that only
-* show the dpt_dt and airline from the first segment
-* JK 10/30/02
-* 3/17/03   DEB  CARRIED THROUGH PNR_LOCATOR
-* 5/19/04   DEB  CARRIED THROUGH DOC_TYPE EX_FLAG RF_FLAG
-* 5/04/05   DEB  ADDED CODE FOR GLOBAL CURRENCY
-*8/7/13    Updated Agency Discount/Contract Savings to use new database field - JK
-* ADDED TRANTYPE INCLUDE - JK 12/15/14 STORY ID S-06492

-********************************************************************

SET ASNAMES = ON
-SET HOLDATTR = ON;

-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

DEFINE FILE &&EXTRACT
  
  COMM_SEG/D12.2S = SEG_COM;
  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;
  LEVEL_DESC/A60      = &&LDESC;
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  NET_FARE/D12.2S  = IF (EX_FLAG EQ ' ') AND (RF_FLAG EQ ' ')
                         THEN SEG_AMT - SEG_COM ELSE 0;
  NEW_ADV_PURCH/D9    = ADV_PURCH;
  NEW_SEG_DISC/D12.2CS = SEG_DISCOUNT;
  REF_EXCH_CNT/D8.2CS   = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 0 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN 1 ELSE 0;
  TAX/D12.2S = SEG_TAX;
  TKT_PURCH/D8.2CS      = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 0;
  TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  TRAN_MONTH/MT        = TRN_DATE;
  TKT/A13              = AIRLINE_NUM||TKT_NUM;
  VASAVINGS/D12.2CS    = NEW_SEG_DISC - FARE_PAID;
  XDPT_DOW/W           = DPT_DATE;
  XDPT_DT/MDYY         = DPT_DATE;
  XPSNGR_NM/A15        = 
  EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;
  TRAN_FEE/D9.2CS      = IF NET_TKT_CNT EQ 1 THEN 8.5 ELSE 0;

-* ****DEFINES ON PREVIOUS DEFINES****

  AIRLINE_FEE/D8.2CS = IF EMBARK EQ 'FP2' OR 'FP3' 
     THEN FARE_PAID ELSE 0;
  DISSAVINGS/D11.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST;

ADVSV/D12.2CS = SEG_AGENCY_DISC - FARE_PAID;
NFVSV/D12.2CS = VASAVINGS;

-*  NFVSV/D12.2CS = IF REFUSE_CODE NE 'NF' THEN VASAVINGS ELSE 0;

-INCLUDE TRANTYPE

END
-RUN

TABLEF FILE &&EXTRACT
PRINT ADV_PURCH
    ADVSV
    AIR_KEY	
    AIR_MAIN.INTL_DOM
    AIRLINE
    AIRLINE_FEE    
    ARR_TIME
    BR_CL_IDX
    C_ITIN
    CITYPAIR.EMBARK AS 'EMB_APT_CD'
    CITYPAIR.ROUTE  AS 'RTE_APT_CD'
    CLASS	
    COMM_SEG
    CONJ_REL
    DISSAVINGS	
    DOC_TYPE	
    DPT_TIME
    EMB_APT.AIRPORT_NAME AS 'EMB_APT_NM'	
    EMB_CTY.CITY_NAME    AS 'EMB_CTY_NM'	
    EMB_CTY.EMB_CITY     AS 'EMB_CTY_CD'
    EX_FLAG	
    FARE_PAID
    FARE_BAS	
    INT_CODE
    LEVEL1
    LEVEL2
    LEVEL_DESC
    NET_FARE
    NET_TKT_CNT
    NEW_ADV_PURCH	
    NEW_SEG_DISC
    NFVSV
    PNR_LOCATOR	
    REF_EXCH_CNT	
    REFUSE_KEY        	
    REFUSE_CODE        	
    RESV_BRANCH
    RF_FLAG	
    RTE_APT.AIRPORT_NAME AS 'RTE_APT_NM'	
    RTE_CTY.CITY_NAME    AS 'RTE_CTY_NM'	
    RTE_CTY.RTE_CITY     AS 'RTE_CTY_CD'
    SEG_DESIG
    SEG_LOWEST
    SEG_NBR	
    TAX
    TKT
    TKT_DATE
    TKT_NUM
    TKT_PURCH
    TKT_SORT
    TKT_TYPE
    TOUR_CODE
    TRAN_FEE
    TRN_DATE
    VAL_AIR.AIRLINE_NAME 	
    VAL_AIRLINE	
    VASAVINGS	
    XDPT_DT	
    XTRAN_DT	
    XPSNGR_NM

-INCLUDE &AIRDATES

WHERE VOID_DATE EQ 0
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS

ON TABLE HOLD AS RPT_HOLD

END
-RUN

TABLE FILE RPT_HOLD
PRINT ADV_PURCH   
    ADVSV
    AIR_KEY	
    INTL_DOM
    AIRLINE
    AIRLINE_FEE    
    ARR_TIME
    BR_CL_IDX
    C_ITIN
    EMB_APT_CD
    RTE_APT_CD
    CLASS	
    COMM_SEG
    CONJ_REL
    DISSAVINGS	
    DOC_TYPE	
    DPT_TIME
    EMB_APT_NM	
    EMB_CTY_NM	
    EMB_CTY_CD
    EX_FLAG	
    FARE_PAID
    FARE_BAS	
    INT_CODE
    LEVEL1
    LEVEL2
    LEVEL_DESC
    NET_FARE
    NET_TKT_CNT
    NEW_ADV_PURCH	
    NEW_SEG_DISC
    NFVSV
    PNR_LOCATOR	
    REF_EXCH_CNT	
    REFUSE_KEY        	
    REFUSE_CODE        	
    RESV_BRANCH
    RF_FLAG	
    RTE_APT_NM	
    RTE_CTY_NM	
    RTE_CTY_CD
    SEG_DESIG
    SEG_LOWEST
    SEG_NBR	
    TAX
    TKT
    TKT_NUM
    TKT_PURCH
    TKT_SORT
    TKT_TYPE
    TOUR_CODE
    TRAN_FEE
    TRN_DATE
    AIRLINE_NAME 	
    VAL_AIRLINE	
    VASAVINGS	
    XDPT_DT	
    XTRAN_DT	
    XPSNGR_NM
 BY TKT_DATE
 ON TABLE HOLD AS RPTHOLD1 FORMAT FOCUS INDEX TKT_DATE
 END
 -RUN
   
 -* Global Reporting JOIN
 JOIN RPTHOLD1.TKT_DATE IN RPTHOLD1 TO GLOBAL.DATE IN GLOBAL AS J1
    
    
 DEFINE FILE RPTHOLD1
 NAMEC/A30 = CNAME;
    
 -**********************************************************************
 -*                         Global Currency Conversion Defines
 -**********************************************************************
 CURR1X/D20.6 = 1 / USDPU ;
    

 PAID_FAREX/D20.6 = FARE_PAID * CURR1X;
 DISSAVEX/D20.6 = DISSAVINGS * CURR1X;
 NEWSEG_DISCX/D20.6 = NEW_SEG_DISC * CURR1X;
 VASAVEX/D20.6 = VASAVINGS * CURR1X;
 LOW_SEGX/D20.6 = SEG_LOWEST * CURR1X;
    
    
 -* DEFINES ON PREVIOUSLY DEFINES DEFINES
    
 PAID_FARE1/D20.6C = PAID_FAREX;
 DISSAVE1/D20.6 = DISSAVEX;
 NEWSEG_DISC1/D20.6 = NEWSEG_DISCX;
 VASAVE1/D20.6 = VASAVEX;
 LOW_SEG1/D20.6 = LOW_SEGX;
 END
 -RUN
     
    

    
 TABLE FILE RPTHOLD1
 PRINT ADV_PURCH 
       ADVSV
        AIR_KEY	
        INTL_DOM
        AIRLINE
        AIRLINE_FEE    
        ARR_TIME
        BR_CL_IDX
        C_ITIN
        EMB_APT_CD
        RTE_APT_CD
        CLASS	
        COMM_SEG
        CONJ_REL
        DISSAVINGS	
        DOC_TYPE	
        DPT_TIME
        EMB_APT_NM	
        EMB_CTY_NM	
        EMB_CTY_CD
        EX_FLAG	
        FARE_PAID
        FARE_BAS	
        INT_CODE
        LEVEL1
        LEVEL2
        LEVEL_DESC
        NET_FARE
        NET_TKT_CNT
        NEW_ADV_PURCH	
        NEW_SEG_DISC
        NFVSV
        PNR_LOCATOR	
        REF_EXCH_CNT	
        REFUSE_KEY        	
        REFUSE_CODE        	
        RESV_BRANCH
        RF_FLAG	
        RTE_APT_NM	
        RTE_CTY_NM	
        RTE_CTY_CD
        SEG_DESIG
        SEG_LOWEST
        SEG_NBR	
        TAX
        TKT
        TKT_NUM
        TKT_PURCH
        TKT_SORT
        TKT_TYPE
        TOUR_CODE
        TRAN_FEE
        TRN_DATE
        AIRLINE_NAME 	
        VAL_AIRLINE	
        VASAVINGS	
        XDPT_DT	
        XTRAN_DT	
        XPSNGR_NM
        NAMEC
        PAID_FARE1/D16.2CS
        DISSAVE1/D16.2CS
        NEWSEG_DISC1/D16.2CS
        VASAVE1/D16.2CS
        LOW_SEG1/D16.2CS
 WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
 ON TABLE HOLD AS RPTHOLD2
 END
 -RUN

 
-*-EXIT
