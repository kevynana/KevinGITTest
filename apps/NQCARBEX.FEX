-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* Created for the new quarterly review - JK 8/2/05
-*2/5/14 Updated the bookings define to use num_days instead of daily_rate - JK

-******************************************************************************
-INCLUDE SETECHO
SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

DEFINE FILE &&EXTRACT 


BOOKINGS/D8 = IF NUM_DAYS GT 0 THEN 1 ELSE IF NUM_DAYS LT 0 THEN (-1) ELSE 0;
NBR_DAYS/D8 = IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                   ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;
                 
TC_AMT/D12 = RENTAL_AMT;

CURRENT/A1 = IF INVOICE_DATE GE '&&FROMDT.EVAL' AND
                INVOICE_DATE LE '&&TODT.EVAL' THEN 'Y' ELSE 'N';
PRIOR/A1 =  IF INVOICE_DATE GE '&&FXDATE.EVAL' AND
               INVOICE_DATE LE '&&TXDATE.EVAL' THEN 'Y' ELSE 'N';

-* Defines on Previous Defines
CDAY/D8 = IF CURRENT EQ 'Y' THEN NBR_DAYS ELSE 0;
PDAY/D8 = IF PRIOR EQ 'Y' THEN NBR_DAYS ELSE 0;
CAMT/D12 = IF CURRENT EQ 'Y' THEN TC_AMT ELSE 0;
PAMT/D12 = IF PRIOR EQ 'Y' THEN TC_AMT ELSE 0;
CBOOKINGS/D8 = IF CURRENT EQ 'Y' THEN BOOKINGS ELSE 0;
PBOOKINGS/D8 = IF PRIOR EQ 'Y' THEN BOOKINGS ELSE 0;

-INCLUDE QRFTRANC

END


TABLEF FILE &&EXTRACT
PRINT BOOKINGS
      NBR_DAYS
      PICK_CTY.CITY_NAME/A14 AS 'PICK_CTY_NAME'	
      PICKUP_CITY
      VENDOR_NAME
      ROLLUP_CODE
      TC_AMT
      YEAR
      TRAN
      CURRENT
      PRIOR
WHERE (INVOICE_DATE GE '&&FROMDT.EVAL') AND (INVOICE_DATE LE '&&TODT.EVAL') OR
      (INVOICE_DATE GE '&&FXDATE.EVAL') AND (INVOICE_DATE LE '&&TXDATE.EVAL')
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-INCLUDE RPTPARMS
ON TABLE HOLD AS HOLDCARB
END
-RUN


-IF &LINES EQ 0 THEN GOTO NOCBASE;



TABLE FILE HOLDCARB
SUM NBR_DAYS
    BOOKINGS
    TC_AMT AS 'RNTL_AMT' 
BY ROLLUP_CODE
BY YEAR
BY VENDOR_NAME
WHERE CURRENT EQ 'Y'
ON TABLE HOLD AS CBASECAR 
END
-RUN

TABLE FILE CBASECAR
SUM NBR_DAYS
    BOOKINGS
    RNTL_AMT
BY ROLLUP_CODE
BY YEAR
BY VENDOR_NAME
ON TABLE HOLD AS RNKHLD
END
-RUN

TABLE FILE RNKHLD
SUM NBR_DAYS
    BOOKINGS
    RNTL_AMT
BY ROLLUP_CODE
BY YEAR
RANKED BY HIGHEST NBR_DAYS NOPRINT
BY VENDOR_NAME
ON TABLE HOLD AS RNKHLD2
END
-RUN


-SET &RLIM = IF &LINES LT 10 THEN 'Y' ELSE 'N';
-SET &OTHRNK = &LINES + 1;


-SET &RANK_LIMIT = 9;

DEFINE FILE RNKHLD2
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  LIST/D9 = LAST LIST + 1;
  CRANKX/A11 = FTOA(LIST, '(D9)', 'A11');
  CRANK/A9 = EDIT(CRANKX,'$$999999999');
  RANK_VALUE/A9 = IF &RANK_LIMIT EQ 0 THEN ARANK ELSE  
                  IF LIST GT &RANK_LIMIT THEN 'ALL OTHER' ELSE 
                     CRANK;
  RANK_LABEL/A12 = IF RANK_VALUE NE 'ALL OTHER' THEN VENDOR_NAME
                      ELSE 'ALL OTHER';
END
-RUN

TABLE FILE RNKHLD2
SUM NBR_DAYS
    BOOKINGS
    RNTL_AMT
BY ROLLUP_CODE
BY YEAR
BY RANK_VALUE
BY RANK_LABEL
ON TABLE HOLD AS RNKHLD3
END
-RUN



TABLE FILE RNKHLD3
PRINT RANK_LABEL AS 'VENDOR_NAME'
BY RANK_VALUE NOPRINT
WHERE RANK_LABEL NE 'ALL OTHER'
ON TABLE SAVE AS SAVCVDR
END
-RUN
 
TABLE FILE HOLDCARB
SUM NBR_DAYS
    BOOKINGS
    TC_AMT/D12 AS 'RNTL_AMT' 
    VENDOR_NAME/A12 NOPRINT
BY ROLLUP_CODE
BY YEAR
BY TRAN
BY VENDOR_NAME
WHERE PRIOR EQ 'Y'
ON TABLE HOLD AS PBASECAR 
END
-RUN

TABLE FILE PBASECAR
SUM NBR_DAYS
    BOOKINGS
    RNTL_AMT
BY ROLLUP_CODE
BY YEAR
BY VENDOR_NAME
ON TABLE HOLD AS PBASECAR2
END
-RUN

TABLE FILE PBASECAR2
SUM NBR_DAYS
    BOOKINGS
    RNTL_AMT
BY ROLLUP_CODE
BY YEAR
BY VENDOR_NAME
WHERE VENDOR_NAME IN FILE SAVCVDR
ON TABLE HOLD AS PBASECAR3
END
-RUN

 
TABLE FILE PBASECAR2
SUM NBR_DAYS
    BOOKINGS
    RNTL_AMT
BY ROLLUP_CODE
BY YEAR
BY VENDOR_NAME
WHERE NOT VENDOR_NAME IN FILE SAVCVDR
ON TABLE HOLD AS PBASECAR4
END
-RUN



DEFINE FILE PBASECAR4
VENDOR_NAME/A12  = 'ALL OTHER   ';
RANK_VALUE = &OTHRNK;
END
TABLE FILE PBASECAR4
SUM NBR_DAYS
    BOOKINGS
    RNTL_AMT
BY ROLLUP_CODE
BY YEAR
BY RANK_VALUE
BY VENDOR_NAME
-* ON TABLE HOLD AS PBASECAR5
END
-RUN

TABLE FILE RNKHLD2
PRINT NBR_DAYS
    BOOKINGS
    RNTL_AMT
    RANK_VALUE
    RANK_LABEL AS 'VENDOR_NAME'
BY ROLLUP_CODE
BY YEAR

END
-RUN

MATCH FILE PBASECAR3
PRINT NBR_DAYS
      BOOKINGS
      RNTL_AMT
BY ROLLUP_CODE
BY YEAR
BY VENDOR_NAME
ON TABLE HOLD
RUN
FILE PBASECAR5
SUM NBR_DAYS
      BOOKINGS
      RNTL_AMT
BY ROLLUP_CODE
BY YEAR
BY VENDOR_NAME
AFTER MATCH HOLD AS PYBASE OLD-OR-NEW
END
-RUN

TABLE FILE PYBASE
PRINT *
END
-RUN

TABLE FILE QRCVDR
SUM NBR_DAYS
    BOOKINGS
    RNTL_AMT
BY ROLLUP_CODE
BY YEAR
RANKED BY HIGHEST NBR_DAYS NOPRINT
BY VENDOR_NAME
END
-RUN

TABLE FILE HOLDCARB
SUM NBR_DAYS
    BOOKINGS
    RENTAL_AMT/D12 AS 'RNTL_AMT' 
BY ROLLUP_CODE
BY YEAR
BY TRAN
BY PICK_CTY_NAME
END
-RUN

TABLE FILE CVDR
SUM BOOKINGS
    NBR_DAYS
    RENTAL_AMT
BY ROLLUP_CODE
BY YEAR
BY TRAN
BY VENDOR_NAME
ON TABLE HOLD AS HOLD2
END
-RUN


-SET &&RANK_LIMIT = 10;
DEFINE FILE HOLD2
  DRANK/D5      = RANK;
  ARANKX/A6 = FTOA(DRANK, '(D5)', 'A6');
  ARANK/A5=EDIT(ARANKX,'$99999');
  RANK_LIMIT/I5 = &&RANK_LIMIT;
  RANK_VALUE/A5 = IF (RANK_LIMIT EQ 0) THEN (ARANK) ELSE
                IF RANK GT RANK_LIMIT THEN 'OTHER' ELSE ARANK;
END
-RUN

TABLE FILE HOLD2
SUM BOOKINGS
    NBR_DAYS
    RENTAL_AMT    
BY ROLLUP_CODE
BY YEAR
BY TRAN
BY RANK_VALUE
BY VENDOR_NAME
ON TABLE HOLD AS HOLD3
END
-RUN





-NOCBASE;