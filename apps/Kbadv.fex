-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-SET &&KB_MAIN = &&WEB_PATH || 'KB_MAIN.FOC';
-RUN
FILEDEF KB_MAIN DISK &&KB_MAIN
-RUN

CREATE FILE KB_MAIN
-RUN


SET ASNAMES=ON


DEFINE FILE KBADVHLD
FARE_PAID/D12.2 = SEG_AMT + SEG_TAX ;

KBADV/A10 = IF (ADV_PURCH LT 7) THEN '0 - 6' ELSE 
           IF (ADV_PURCH GE 7) AND (ADV_PURCH LE 13) THEN '7 - 13' ELSE
           IF (ADV_PURCH GE 14) AND (ADV_PURCH LE 20) THEN '14 - 20' ELSE
           IF (ADV_PURCH GE 21) AND (ADV_PURCH LE 29) THEN '21 - 29' ELSE
              '30 +';
KBFLAG/A1 = IF KBADV EQ '0 - 6' THEN 'A' ELSE
            IF KBADV EQ '7 - 13' THEN 'B' ELSE
            IF KBADV EQ '14 - 20' THEN 'C' ELSE
            IF KBADV EQ '21 - 29' THEN 'D' ELSE
            IF KBADV EQ '30 +' THEN 'E' ELSE ' ';

NON_FLAG/A15 = IF NONREF_FLAG EQ 'N' THEN 'NON-REFUNDABLE' ELSE 
               'REFUNDABLE';
REF_EXCH_CNT/D8CS   = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 0 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN 1 ELSE 0;

TKT_PURCH/D8CS      = IF (TICKET_CODE EQ '1') AND
                         (SEG_NBR EQ '01') AND
                         (FARE_PAID GE 0) AND
                         (SEG_COUNT EQ 1) AND 
                         (CONJ_REL EQ 1) THEN 1 ELSE 0;


NTKT_PURCH/D8CS = IF NON_FLAG EQ 'NON-REFUNDABLE' THEN TKT_PURCH ELSE 0;
NREF_CNT/D8CS = IF NON_FLAG EQ 'NON-REFUNDABLE' THEN REF_EXCH_CNT ELSE 0;
RTKT_PURCH/D8CS = IF NON_FLAG EQ 'REFUNDABLE' THEN TKT_PURCH ELSE 0;
RREF_CNT/D8CS = IF NON_FLAG EQ 'REFUNDABLE' THEN REF_EXCH_CNT ELSE 0;

END

TABLE FILE KBADVHLD
SUM NTKT_PURCH
    PCT.NTKT_PURCH AS 'PCTNTKT'
    NREF_CNT 
    PCT.NREF_CNT AS 'PCTNREF'
    RTKT_PURCH
    PCT.RTKT_PURCH AS 'PCTRTKT'
    RREF_CNT 
    PCT.RREF_CNT AS 'PCTRREF'
    TKT_PURCH
BY KBFLAG NOPRINT
BY KBADV
WHERE INTL_DOM EQ 'D'
ON TABLE HOLD AS KBHOLD1
END
-RUN 


TABLE FILE KBADVHLD
SUM NTKT_PURCH
    PCT.NTKT_PURCH AS 'PCTNTKT'
    NREF_CNT 
    PCT.NREF_CNT AS 'PCTNREF'
    RTKT_PURCH
    PCT.RTKT_PURCH AS 'PCTRTKT'
    RREF_CNT 
    PCT.RREF_CNT AS 'PCTRREF'
    TKT_PURCH
BY KBFLAG NOPRINT
BY KBADV
WHERE INTL_DOM EQ 'I'
ON TABLE HOLD AS KBHOLD2
END
-RUN

TABLE FILE KBADVHLD
SUM NTKT_PURCH
    PCT.NTKT_PURCH AS 'PCTNTKT'
    NREF_CNT 
    PCT.NREF_CNT AS 'PCTNREF'
    RTKT_PURCH
    PCT.RTKT_PURCH AS 'PCTRTKT'
    RREF_CNT 
    PCT.RREF_CNT AS 'PCTRREF'
    TKT_PURCH
BY KBFLAG NOPRINT
BY KBADV
ON TABLE HOLD AS KBHOLD3
END
-RUN


DEFINE FILE KBHOLD1
CATEGORY/A35 = 'ADVANCED PURCHASE-DOMESTIC';
CAT_ORDER/I2 = 1;
END

TABLE FILE KBHOLD1
PRINT CATEGORY/A35 AND KBADV/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND NTKT_PURCH/D20 AS 'VOL_CURR' AND 
PCTNTKT/D20 AS 'TKT_CURR' AND NREF_CNT/D20 AS 'PCT_CURR' AND
PCTNREF/D20 AS 'TTL_CURR' AND RTKT_PURCH/D20 AS 'VOL_PRIOR' AND
PCTRTKT/D20 AS 'TKT_PRIOR' AND RREF_CNT/D20 AS 'PCT_PRIOR' AND
PCTRREF/D20 AS 'TTL_PRIOR' AND  TKT_PURCH AS 'TTL_TKT' AND
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;  
ON TABLE HOLD AS KBDOM1
END
-RUN

TABLE FILE KBDOM1
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR AND
      PCT_CURR AND TTL_CURR AND VOL_PRIOR AND TKT_PRIOR
      AND PCT_PRIOR AND TTL_PRIOR AND TTL_TKT
ON TABLE HOLD AS KBDOM2
END
MODIFY FILE KB_MAIN
FIXFORM FROM KBDOM2
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON KBDOM2
END
-RUN


DEFINE FILE KBHOLD2
CATEGORY/A35 = 'ADVANCED PURCHASE-INTERNATIONAL';
CAT_ORDER/I2 = 2;
END
-RUN

TABLE FILE KBHOLD2
PRINT CATEGORY/A35 AND KBADV/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND NTKT_PURCH/D20 AS 'VOL_CURR' AND 
PCTNTKT/D20 AS 'TKT_CURR' AND NREF_CNT/D20 AS 'PCT_CURR' AND
PCTNREF/D20 AS 'TTL_CURR' AND RTKT_PURCH/D20 AS 'VOL_PRIOR' AND
PCTRTKT/D20 AS 'TKT_PRIOR' AND RREF_CNT/D20 AS 'PCT_PRIOR' AND
PCTRREF/D20 AS 'TTL_PRIOR' AND TKT_PURCH/D20 AS 'TTL_TKT' AND
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;   
ON TABLE HOLD AS KBINT1
END
-RUN

TABLE FILE KBINT1
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR AND
      PCT_CURR AND TTL_CURR AND VOL_PRIOR AND TKT_PRIOR
      AND PCT_PRIOR AND TTL_PRIOR AND TTL_TKT
ON TABLE HOLD AS KBINT2
END
MODIFY FILE KB_MAIN
FIXFORM FROM KBINT2
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON KBINT2
END
-RUN

DEFINE FILE KBHOLD3
CATEGORY/A35 = 'ADVANCED PURCHASE-TOTAL';
CAT_ORDER/I2 = 3;
END
-RUN

TABLE FILE KBHOLD3
PRINT CATEGORY/A35 AND KBADV/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND NTKT_PURCH/D20 AS 'VOL_CURR' AND 
PCTNTKT/D20 AS 'TKT_CURR' AND NREF_CNT/D20 AS 'PCT_CURR' AND
PCTNREF/D20 AS 'TTL_CURR' AND RTKT_PURCH/D20 AS 'VOL_PRIOR' AND
PCTRTKT/D20 AS 'TKT_PRIOR' AND RREF_CNT/D20 AS 'PCT_PRIOR' AND
PCTRREF/D20 AS 'TTL_PRIOR' AND TKT_PURCH/D20 AS 'TTL_TKT' AND
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;   
ON TABLE HOLD AS KBTTL1
END
-RUN

TABLE FILE KBTTL1
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR AND
      PCT_CURR AND TTL_CURR AND VOL_PRIOR AND TKT_PRIOR
      AND PCT_PRIOR AND TTL_PRIOR AND TTL_TKT
ON TABLE HOLD AS KBTTL2
END
MODIFY FILE KB_MAIN
FIXFORM FROM KBTTL2
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON KBTTL2
END
-RUN












