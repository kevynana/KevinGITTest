-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File AIREXTRT.FEX
-********************************************************************
-* MODIFICAIONS:
-* 5/22/1998 ADDED TRN_DATE CRITERIA TO WHERE STATEMENTS - LP
-* 7/09/1998 ADDED A DEFINE FOR TICKETLESS MIR TRANSACTIONS - LP
-* 5/31/2001 ADDED A DEFINE FOR PAPER TICKET TRANSACTIONS - DB
-*10/2/01       TANDT-JK  ADDED DEFINES FOR MTLEVEL1 MTLEVEL2 
-*              ALSO ADDED INT_CODE
-*12/26/01  ADDED A DEFINE FOR INTEXT  - DB
-* 5/15/02  ADDED DEFINE FOR ONLINE_AMT - DB
-* 7/11/02  ADDED EMB_CTY_NM RTE_CTY_NM - DB
-* 11/26/02 ADDED AUX_TYPE DEFINE JK
-* 12/20/02 ADDED FOP DEFINE - JK
-* 6/26/03  ADDED NET_TKT_CNT1 DEFINE - DV
-*12/01/03  ADDED AROLL_LEV5 AROLL_LEV6
-*12/02/03  ADDED FOP2 DEFINE - DV
-*12/9/03   Added Shuttle Define - JK 
-*11/8/04   Added ID_flg Define - JK
-*8/2/05    ADDED NRFLAG DEFINE - DEB
-*03/06/13  CHANGED CLASS_CAT DEFINE DUE TO CLASS CATEGORY CHANGES - DV
-*Changed contract savings define - JK 8/23/13
-* 2/2/15 - DEB - S-07181  ADDED AUX_TKTLS_NUM ONLINE_TRADITIONAL
-*12/07/15 - JEM - S-13286 Updated to allow reports to sort/subtotal by id-levels
-* 07/18/16   DLV  S-20630 - New Employee ID database field
-*                           Added EMP_ID
-********************************************************************
-*
-* This program extracts data for the series of basic ticket listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-********************************************************************

SET ASNAMES = ON
-SET HOLDATTR = ON;
-INCLUDE SETECHO

-SET &&IDLEVELBREAK = '';

-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

-INCLUDE IDLEVROLLDEF
-RUN

DEFINE FILE &&EXTRACT
  AUX_TYPE/A2 = IF AUX_NON_MIR EQ 'L' OR 'N' THEN 'TE' ELSE 'PP';
  BASE_AMT/D12.2CS = SEG_AMT;
  BOOK_DT/MDYY         = RESV_DATE;
-*  CLASS_CAT/A8 = DECODE CL_CAT ('F' 'FIRST'     'C' 'COACH'   
-*                                'D' 'DISCOUNT'  'B' 'BUSINESS');
  CLASS_CAT/A15 = DECODE CL_CAT ('F' 'FIRST'     'P' 'PREMIUM ECONOMY'   
			        'D' 'DEFAULT'   'B' 'BUSINESS'
			        'E' 'ECONOMY'   'U'  'UPGRADE' 
                                ' ' 'DEFAULT'); 

  DIR_CP_CD/A50        = CITYPAIR.EMBARK||'-'||CITYPAIR.ROUTE;
  EXCEPTION/A1        = IF ADV_PURCH LT 7 THEN 'X' ELSE ' ';
  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;
  FOP/A2 = EDIT(CREDIT_CARD, '99$$$$$$$$$$$$$$$$');
  FOP2/A7 = IF FOP EQ 'AX' THEN EDIT(CREDIT_CARD, '99$$$$$$$$$$99999')
	      ELSE EDIT(CREDIT_CARD, '99$$$$$$$$$$$99999');
  INTEXT/A8    = IF INT_CODE CONTAINS 'INT' THEN 'INTERNAL' ELSE
                 IF INT_CODE CONTAINS 'EXT' THEN 'EXTERNAL' ELSE 'OTHER';
  ID_FLG/A1 = IF AIR_MAIN.INTL_DOM EQ 'D' THEN 'D' ELSE 'I';
  LEVEL_DESC1/A80      = &&LDESC;
  MTLEVEL1/A15 = IF LEVEL3 EQ 'NEWFTRN' THEN ' ' ELSE LEVEL1;
  MTLEVEL2/A15 = IF LEVEL3 EQ 'NEWFTRN' THEN LEVEL1 ELSE LEVEL2;
  MTLEVEL3/A15 = IF LEVEL3 EQ 'PERSONAL' OR 'HYTLGLCC' OR 
                 'CONCEIRGE' OR 'AUTO & HOME' OR 'GENAMP'
                 OR 'GENAMCC' THEN LEVEL2 ELSE IF LEVEL3 EQ 
                 'PROSPECT' OR 'CONSULT' OR 'GENAMCONCC' OR
                 'RGACONCC' THEN LEVEL1 ELSE LEVEL3;
  NET_TKT_CNT/D8CS    = IF (DOC_TYPE EQ '1') THEN 1 ELSE
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  NET_TKT_CNT1/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  NEW_SEG_COUNT/D8CS = SEG_COUNT;
  NEW_SEG_DISC/D12.2CS = SEG_DISCOUNT;
  NEW_SEG_MILES/D9= SEG_MILES;
  NRFLAG/A2 = IF NONREF_FLAG EQ 'N' THEN 'NR' ELSE ' ';
  NON_REF/A15 = DECODE NONREF_FLAG ('N' 'NON-REFUNDABLE'
                                     'R' 'REFUNDABLE'
                                   ' ' 'REFUNDABLE');
  PAPER/A1 = IF AUX_NON_MIR NE 'L' OR 'N' THEN 'P' ELSE '';
  SAVINGS/D11.2CS     = SEG_STANDARD - FARE_PAID;  
  SHUTTLE/A1 = IF (ORG_DST EQ 'BOSLGA' OR 'DCALGA' OR 'BOSDCA') AND
                  (AIRLINE EQ 'DL' OR 'US') THEN 'Y' ELSE
               IF (ORG_DST EQ 'LGAPVD') AND (AIRLINE EQ 'US') THEN 'Y' ELSE 
               IF (ORG_DST EQ 'BOSEWR') THEN 'Y' ELSE 'N';
  TAX/D12.2CS = SEG_TAX;               
  TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  XARR_DOW/W           = ARR_DATE;
  XARR_DT/MDYY         = ARR_DATE;
  XDPT_DOW/W           = DPT_DATE;
  XDPT_DT/MDYY         = DPT_DATE;
  XPSNGR_NM/A15        = 
    EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;
  XFST_DPT/MDYY = FST_DPT_DATE;


-* ****DEFINES ON PREVIOUS DEFINES****

  ARR_DAY/A3           = DECODE XARR_DOW (1 'MON' 2 'TUE' 3 'WED'
                                 4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
  DISSAVINGS/D11.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST;
  EXCH_AC/D11.2CS     = IF (EXCHG_SALE EQ 'A') AND (SEG_NBR EQ '01') THEN
                        EXCH_NET_FARE + EXCH_NET_TAX ELSE 0;
  DPT_DAY/A3           = DECODE XDPT_DOW (1 'MON' 2 'TUE' 3 'WED'
                                 4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
  ONLINE_AMT/D9.2CS      = IF NET_TKT_CNT EQ 1 THEN 21 ELSE 0;
  VSV/D12.2CS    = NEW_SEG_DISC - FARE_PAID;
  
  NVSV/D12.2CS = VSV;

-INCLUDE TRANTYPE 
-INCLUDE IDLEVDEFINE 
END
-RUN

TABLEF FILE &&EXTRACT
PRINT
  ADV_BOOK 
  AIR_KEY	
  AIRLINE
  AROLL_LEV1
  AROLL_LEV2
  AROLL_LEV3
  AROLL_LEV4
  AROLL_LEV5
  AROLL_LEV6
  AROLL_LEV7
  AROLL_LEV8
  AROLL_LEV9
  AROLL_LEV10
  AROLL_LEV11 
  AROLL_LEV12
  AROLL_LEV13
  AROLL_LEV14
  ARR_DAY	
  ARR_TIME
  AUX_TKTLS_NUM
  AUX_TYPE
  BASE_AMT
  BOOK_DT	
  BR_CL_IDX
  CC_NUM
  C_ITIN
  CITYPAIR.EMBARK      AS 'EMB_APT_CD'	
  CITYPAIR.ROUTE       AS 'RTE_APT_CD'
  CLASS	
  CL_CAT
  CLASS_CAT
  DISSAVINGS
  DOC_NUMBER
  DOC_TYPE
  DOD_TYPE	
  DPT_DAY	
  DPT_TIME
  EMB_CTY.CITY_NAME    AS 'EMB_CTY_NM'
  EMP_ID
  EXCEPTION
  EXCH_AC
  EXCHG_SALE
  EXCH_NET_FARE
  EXCH_NET_TAX
  FARE_BAS	
  FARE_BASE_CODE	
  FARE_PAID
  FOP
  FOP2	
  ID_FLG
  INT_CODE
  INTEXT
  LEVEL_DESC	
  LEVEL1	
  LEVEL2	
  LEVEL3
  MTLEVEL1
  MTLEVEL2
  MTLEVEL3	
  NET_TKT_CNT
  NET_TKT_CNT1
  NEW_SEG_MILES
  NON_REF
  NRFLAG
  ONLINE_AMT
  ONLINE_TRADITIONAL
  PAPER	
  PNR_LOCATOR	
  REFUSAL_DESC	
  REFUSE_CODE
  REFUSE_KEY
  RTE_CTY.CITY_NAME    AS 'RTE_CTY_NM'	
  SEG_LOWEST	
  SEG_NBR
  SHUTTLE
  TAX
  TKT_NUM	
  TKT_SORT	
  TKT_TYPE	
  TRN_DATE	
  XARR_DT	
  XDPT_DT	
  XPSNGR_NM	
  XTRAN_DT
-**** fields added for Metlife
  XFST_DPT
  NVSV
  NEW_SEG_DISC
  SEGMENT_DESIGNATOR

  

-INCLUDE &AIRDATES

WHERE VOID_DATE EQ 0
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS RPTHLD
END
-RUN

TABLE FILE RPTHLD
PRINT FARE_BAS AS 'FARE_BAS1' CL_CAT AS 'CL_CAT1' REFUSE_CODE AS 'REF_CODE1' CLASS_CAT AS 'MCAT1'
BY TKT_NUM
WHERE SEG_NBR EQ '01'
ON TABLE HOLD AS SEG1
END
-RUN



TABLE FILE RPTHLD
PRINT FARE_BAS AS 'FAR_BAS2' CL_CAT AS 'CL_CAT2' REFUSE_CODE AS 'REF_CODE2' CLASS_CAT AS 'MCAT2'
BY TKT_NUM
WHERE SEG_NBR EQ '02'
ON TABLE HOLD AS SEG2
END
-RUN

TABLE FILE RPTHLD
PRINT FARE_BAS AS 'FAR_BAS3' CL_CAT AS 'CL_CAT3' REFUSE_CODE AS 'REF_CODE3' CLASS_CAT AS 'MCAT3'
BY TKT_NUM
WHERE SEG_NBR EQ '03'
ON TABLE HOLD AS SEG3
END
-RUN

TABLE FILE RPTHLD
PRINT FARE_BAS AS 'FAR_BAS4' CL_CAT AS 'CL_CAT4' REFUSE_CODE AS 'REF_CODE4' CLASS_CAT AS 'MCAT4'
BY TKT_NUM
WHERE SEG_NBR EQ '04'
ON TABLE HOLD AS SEG4
END
-RUN

TABLE FILE RPTHLD
PRINT FARE_BAS AS 'FAR_BAS5' CL_CAT AS 'CL_CAT5' REFUSE_CODE AS 'REF_CODE5' CLASS_CAT AS 'MCAT5'
BY TKT_NUM
WHERE SEG_NBR EQ '05'
ON TABLE HOLD AS SEG5
END
-RUN

TABLE FILE RPTHLD
PRINT FARE_BAS AS 'FAR_BAS6' CL_CAT AS 'CL_CAT6' REFUSE_CODE AS 'REF_CODE6' CLASS_CAT AS 'MCAT6'
BY  TKT_NUM
WHERE SEG_NBR EQ '06'
ON TABLE HOLD AS SEG6
END
-RUN

TABLE FILE RPTHLD
PRINT FARE_BAS AS 'FAR_BAS7' CL_CAT AS 'CL_CAT7' REFUSE_CODE AS 'REF_CODE7' CLASS_CAT AS 'MCAT7'
BY  TKT_NUM
WHERE SEG_NBR EQ '07'
ON TABLE HOLD AS SEG7
END
-RUN

TABLE FILE RPTHLD
PRINT FARE_BAS AS 'FAR_BAS8' CL_CAT AS 'CL_CAT8' REFUSE_CODE AS 'REF_CODE8' CLASS_CAT AS 'MCAT8'
BY  TKT_NUM
WHERE SEG_NBR EQ '08'
ON TABLE HOLD AS SEG8
END
-RUN

-* Match all toghether

MATCH FILE SEG1
PRINT FARE_BAS1 CL_CAT1 REF_CODE1 MCAT1
BY TKT_NUM
ON TABLE HOLD
RUN
FILE SEG2
SUM FAR_BAS2 CL_CAT2 REF_CODE2 MCAT2
BY TKT_NUM
AFTER MATCH HOLD AS XONE OLD-OR-NEW
END
-RUN

MATCH FILE XONE
PRINT FARE_BAS1 CL_CAT1 FAR_BAS2 CL_CAT2 REF_CODE1 REF_CODE2 MCAT1 MCAT2
BY TKT_NUM
ON TABLE HOLD
RUN
FILE SEG3
SUM FAR_BAS3 CL_CAT3 REF_CODE3 MCAT3
BY TKT_NUM
AFTER MATCH HOLD AS XTWO OLD-OR-NEW
END
-RUN

MATCH FILE XTWO
PRINT FARE_BAS1 CL_CAT1 FAR_BAS2 CL_CAT2 FAR_BAS3 CL_CAT3 REF_CODE1 REF_CODE2 REF_CODE3 MCAT1 MCAT2 MCAT3
BY TKT_NUM
ON TABLE HOLD
RUN
FILE SEG4
SUM FAR_BAS4 CL_CAT4 REF_CODE4 MCAT4
BY TKT_NUM
AFTER MATCH HOLD AS XTHREE OLD-OR-NEW
END
-RUN

MATCH FILE XTHREE
PRINT FARE_BAS1 CL_CAT1 FAR_BAS2 CL_CAT2 FAR_BAS3 CL_CAT3 FAR_BAS4 CL_CAT4 REF_CODE1 REF_CODE2 REF_CODE3 REF_CODE4 MCAT1 MCAT2 MCAT3 MCAT4
BY TKT_NUM
ON TABLE HOLD
RUN
FILE SEG5
SUM FAR_BAS5 CL_CAT5 REF_CODE5 MCAT5
BY TKT_NUM
AFTER MATCH HOLD AS XFOUR OLD-OR-NEW
END
-RUN

MATCH FILE XFOUR
PRINT FARE_BAS1 CL_CAT1 FAR_BAS2 CL_CAT2 FAR_BAS3 CL_CAT3 FAR_BAS4 CL_CAT4 FAR_BAS5 CL_CAT5 REF_CODE1 REF_CODE2 REF_CODE3 REF_CODE4 REF_CODE5 MCAT1 MCAT2 MCAT3 MCAT4 MCAT5
BY TKT_NUM
ON TABLE HOLD
RUN
FILE SEG6
SUM FAR_BAS6 CL_CAT6 REF_CODE6 MCAT6
BY TKT_NUM
AFTER MATCH HOLD AS XFIVE OLD-OR-NEW
END
-RUN

MATCH FILE XFIVE
PRINT FARE_BAS1 CL_CAT1 FAR_BAS2 CL_CAT2 FAR_BAS3 CL_CAT3 FAR_BAS4 CL_CAT4 FAR_BAS5 CL_CAT5 FAR_BAS6 CL_CAT6 REF_CODE1 REF_CODE2 REF_CODE3 REF_CODE4 REF_CODE5 REF_CODE6
      MCAT1 MCAT2 MCAT3 MCAT4 MCAT5 MCAT6
BY TKT_NUM
ON TABLE HOLD
RUN
FILE SEG7
SUM FAR_BAS7 CL_CAT7 REF_CODE7 MCAT7
BY TKT_NUM
AFTER MATCH HOLD AS XSIX OLD-OR-NEW
END
-RUN

MATCH FILE XSIX
PRINT FARE_BAS1 CL_CAT1 FAR_BAS2 CL_CAT2 FAR_BAS3 CL_CAT3 FAR_BAS4 CL_CAT4 FAR_BAS5 CL_CAT5 FAR_BAS6 CL_CAT6 FAR_BAS7 CL_CAT7 REF_CODE1 REF_CODE2 REF_CODE3 REF_CODE4 REF_CODE5 REF_CODE6 REF_CODE7
      MCAT1 MCAT2 MCAT3 MCAT4 MCAT5 MCAT6 MCAT7
BY TKT_NUM
ON TABLE HOLD
RUN
FILE SEG8
SUM FAR_BAS8 CL_CAT8 REF_CODE8 MCAT8
BY TKT_NUM
AFTER MATCH HOLD AS XSEVEN OLD-OR-NEW
END
-RUN




DEFINE FILE XSEVEN
MXCT2/A15 = IF MCAT1 EQ MCAT2 THEN ' ' ELSE MCAT2;
MXCT3/A15 = IF MCAT2 EQ MCAT3 THEN ' ' ELSE MCAT3;
MXCT4/A15 = IF MCAT3 EQ MCAT4 THEN ' ' ELSE MCAT4;
MXCT5/A15 = IF MCAT4 EQ MCAT5 THEN ' ' ELSE MCAT5;
MXCT6/A15 = IF MCAT5 EQ MCAT6 THEN ' ' ELSE MCAT6;
MXCT7/A15 = IF MCAT6 EQ MCAT7 THEN ' ' ELSE MCAT7;
MXCT8/A15 = IF MCAT7 EQ MCAT8 THEN ' ' ELSE MCAT8;
MXCATT/A128 = MCAT1|' '|MXCT2|' '|MXCT3|' '|MXCT4|' '|MXCT5|' '|MXCT6|' '|MXCT7|' '|MXCT8;
MX_CL/A20 = CL_CAT1|' '|CL_CAT2|' '|CL_CAT3|' '|CL_CAT4|' '|CL_CAT5|' '|CL_CAT6|' '|CL_CAT7|' '|CL_CAT8;
END

TABLE FILE XSEVEN
PRINT MX_CL MXCATT
BY TKT_NUM
ON TABLE HOLD AS XEIGHT
END


MATCH FILE RPTHLD
PRINT ADV_BOOK 
  AIR_KEY	
  AIRLINE
  AROLL_LEV1
  AROLL_LEV2
  AROLL_LEV3
  AROLL_LEV4
  AROLL_LEV5
  AROLL_LEV6
  AROLL_LEV7
  AROLL_LEV8
  AROLL_LEV9
  AROLL_LEV10
  AROLL_LEV11 
  AROLL_LEV12
  AROLL_LEV13
  AROLL_LEV14
  ARR_DAY	
  ARR_TIME
  AUX_TKTLS_NUM
  AUX_TYPE
  BASE_AMT
  BOOK_DT	
  BR_CL_IDX
  CC_NUM
  C_ITIN
  EMB_APT_CD	
  RTE_APT_CD
  CLASS	
  CL_CAT
  CLASS_CAT
  DISSAVINGS
  DOC_NUMBER
  DOC_TYPE
  DOD_TYPE	
  DPT_DAY	
  DPT_TIME
  EMB_CTY_NM
  EMP_ID
  EXCEPTION
  EXCH_AC
  EXCHG_SALE
  EXCH_NET_FARE
  EXCH_NET_TAX
  FARE_BAS
  FARE_BASE_CODE
  FARE_PAID
  FOP
  FOP2	
  ID_FLG
  INT_CODE
  INTEXT
  LEVEL_DESC	
  LEVEL1	
  LEVEL2	
  LEVEL3
  MTLEVEL1
  MTLEVEL2
  MTLEVEL3	
  NET_TKT_CNT
  NET_TKT_CNT1
  NEW_SEG_MILES
  NON_REF
  NRFLAG
  ONLINE_AMT
  ONLINE_TRADITIONAL
  PAPER	
  PNR_LOCATOR	
  REFUSAL_DESC	
  REFUSE_CODE
  REFUSE_KEY
  RTE_CTY_NM
  SEG_LOWEST	
  SEG_NBR
  SHUTTLE
  TAX
  TKT_SORT	
  TKT_TYPE	
  TRN_DATE	
  XARR_DT	
  XDPT_DT	
  XPSNGR_NM	
  XTRAN_DT
-**** fields added for Metlife
  XFST_DPT
  NVSV
  NEW_SEG_DISC
  SEGMENT_DESIGNATOR  
BY TKT_NUM
ON TABLE HOLD
RUN
FILE XEIGHT
SUM MX_CL MXCATT
BY TKT_NUM
AFTER MATCH HOLD AS &&RPT_HOLD OLD-OR-NEW
END
-RUN







-*-EXIT


