-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* 6/29/16 - JEM - S-20131 Created to accommodate updates to DVEXPNAG per Linda Paesl's requirements
-* 9/20/19 - JEM - S-24945 Updated joins/in file to use an edited htl_key (removes the resv_status off the end) when using htl_key records were missing due to changes/cancellations
-* 06/16/17  DLV - D-01541 Added additional code to include only records with BR_CL_IDX in 
-*                         HOTEL extract

-********************************************************************
-INCLUDE SETECHO 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN



-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';

DEFINE FILE &&EXTRACT
  
  BLANK1/A11 = '           ';
  DATA_V1/A9 = '*********';
  DV_NUM2/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
  DV_NUM/A15 = IF DV_NUM2 EQ ' ' THEN ' ' ELSE DATA_V || DV_NUM2;
  LEVEL_DESC/A60 = &&LDESC;
  SEG/A2= '  ';
  CITY_ST/A35 = PROP_CITY||(', '| PROP_STATE);
  IN_DATE/MDYY = CHKIN_DATE;
  INV_DATE/MDYY = INVOICE_DATE;
  NBR_DAYS/D12 =  NUM_DAYS; 
  NNROOMS/D12 = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
  NEW_TOTAL_AMT/D12.2CS = TOTAL_AMT;
  OUT_DATE/MDYY = CHKOUT_DATE;
  PRP_CITY/A25 = PROP_CITY;
  PRP_ST/A25 = PROP_STATE_CD;
  TRIP_PURPOSE/A2 = ' ';
  TRP_DESC/A40 = '                                        ';
  TYPE/A3 = 'SAL';
  CHN_CODE/A3 = CHAIN_CODE;
  STATUS/A1 = 'O';
  HTL_CNF/A30 = HHL_CONFIRM;
  TASF_TKT_NUM/A10 = '          '; 
  ONLT/A33=ONLINE_TRADITIONAL;
  IDFLAG/A15 =IF (CITY.COUNTRY_CODE EQ 'US' OR ' ') THEN 'DOMESTIC' ELSE 'INTERNATIONAL';  
  EXECF/A13 = EXECUTIVE_FLAG;

END
-RUN

TABLEF FILE &&EXTRACT
PRINT BR_CL_IDX AS 'ACCT'
  TYPE
  BLANK1 AS 'TSORT'
  DV_NUM
  PRP_CITY AS 'CITY1'
  HTL_KEY
  IN_DATE AS 'DATE'
  INV_DATE AS 'TRAN_DATE'
  INVOICE_DATE
  INVOICE_NUM
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  LEVEL4
  LEVEL5
  LEVEL6
  NEW_TOTAL_AMT AS 'AMOUNT'
  NNROOMS AS 'TTL_COUNT'
  OUT_DATE AS 'DATE2'
  SEG
  PASSNGR_NAME
  PNR_LOCATOR
  CHN_CODE AS 'NAME'
  STATUS
  HTL_CNF AS 'TKT_NUM'
  TRIP_PURPOSE
  TRP_DESC
  CITY.GEO_ZONE AS 'GEO_ZONE'
  TASF_TKT_NUM
  ONLT
  IDFLAG
  EXECF
  AGENT_NUM
-INCLUDE &HTLDATES 

-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-* &&WHERE1
-* &&WHERE2
-* &&WHERE3
-* &&WHERE4
-* &&WHERE5
-* &&WHERE6
-* &&WHERE7
-* &&WHERE8
&&WHERE9
&&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS HTLHOLD
END
-RUN

 
-* Added additional code to include only HOTEL fees with BR_CL_IDX based on hierarchy selection

TABLE FILE HTLHOLD
SUM ACCT
BY ACCT NOPRINT
ON TABLE SAVE AS HTLCLIENT
END
-RUN



TABLE FILE PFHOLDH
PRINT BR_CL_IDX PAX_NM TRN_TYPE TRN_DATE FEE_SRC FEE_AMT PAY_METHOD CREDIT_CARD FST_DPT_DATE TASF_TKT_NUM 
BY HKEY1
WHERE HKEY1 NE ' '
WHERE BR_CL_IDX IN FILE HTLCLIENT
ON TABLE HOLD AS HTLFEE
END
-RUN




-IF &RECORDS EQ 0 THEN GOTO NoHJoin;



-* start of new code

-JoinHFee  
-*-INCLUDE  DVRHTLUSE
-*-RUN


-* TABLE FILE PFHOLDH
-* PRINT TRN_TYPE TRN_DATE FEE_SRC FEE_AMT PAY_METHOD CREDIT_CARD FST_DPT_DATE TASF_TKT_NUM
-* BY HTL_KEY
-* WHERE HTL_KEY NE ' '

-* ON TABLE HOLD AS HTLFEE
-* END
-* -RUN
 

DEFINE FILE HTLFEE
-*  HKEY/A71='''' | HTL_KEY | '''';
HKEY/A71='''' | HKEY1 | '''';
END

TABLE FILE HTLFEE
PRINT HKEY 
-* BY HTL_KEY NOPRINT
BY HKEY1 NOPRINT
ON TABLE SAVE AS SAVEH
END


DEFINE FILE HR_50

TKT_NUM/A30 = HHL_CONFIRM;
NAME/A3 = CHAIN_CODE;
CITY1/A25 = PROP_CITY;

DATA_V/A9 = '*********';
DV_NUM2/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
DV_NUM/A15 = IF DV_NUM2 EQ ' ' THEN ' ' ELSE DATA_V || DV_NUM2;


IN_DATE/MDYY = CHKIN_DATE;
OUT_DATE/MDYY = CHKOUT_DATE;
LEVEL_DESC/A60 = &&LDESC;
GEO_ZONE/A3 = IF GEO_ZONE EQ ' ' THEN 'USA' ELSE GEO_ZONE;
TRIP_PURPOSE/A2 = ' ';
TRP_DESC/A40 = '                                        ';
TASF_TKT_NUM/A10 = '          ';
ONLT/A33=ONLINE_TRADITIONAL;
IDFLAG/A15 =IF (CITY.COUNTRY_CODE EQ 'US' OR ' ') THEN 'DOMESTIC' ELSE 'INTERNATIONAL';
EXECF/A13 = EXECUTIVE_FLAG;
HKEYR/A69=REVERSE(69, HTL_KEY, HKEYR);
HKEYR1/A68=EDIT(HKEYR, '$$9999999999999999999999999999999999999999999999999999999999999999999');
HKEY1/A69=REVERSE(82, HKEYR1, HKEY1);  
END

TABLE FILE HR_50
PRINT 
  PASSNGR_NAME
  PNR_LOCATOR
  INVOICE_DATE
  TKT_NUM

  NAME
  IN_DATE 
  OUT_DATE
  CITY1
  DV_NUM
  BR_CL_IDX 
  INVOICE_NUM
  
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  GEO_ZONE
  TRIP_PURPOSE
  TRP_DESC
  TASF_TKT_NUM
  ONLT
  IDFLAG
  EXECF
  AGENT_NUM
-* BY HTL_KEY
BY HKEY1
-INCLUDE RPTPARMS
WHERE HKEY1 IN FILE SAVEH
ON TABLE HOLD AS 'HR50SUB' FORMAT FOCUS INDEX HKEY1
END


JOIN HKEY1 IN PFHOLDH TO HKEY1 IN HR50SUB
-RUN

DEFINE FILE PFHOLDH
TRAN_DATE/MDYY = INVOICE_DATE;

TSORT/A11 = '           ';
TYPE/A3 = 'SAL';
SEG/A2= '  ';
STATUS/A1 = 'O';
AMOUNT/D12.2CS = FEE_AMT;
PAXNM/A33 = IF PASSNGR_NAME EQ ' ' THEN PAX_NM ELSE PASSNGR_NAME;
ONL_T/A33 = IF ONLT EQ ' ' THEN 'ONLINE' ELSE ONLT;
END

TABLE FILE PFHOLDH
PRINT 
  PAXNM AS 'PASSNGR_NAME'
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TSORT 
  TYPE
  SEG    
  NAME
  IN_DATE AS 'DATE'
  OUT_DATE AS 'DATE2'
  CITY1
  DV_NUM
  AMOUNT
  CNT AS 'TTL_COUNT'
  BR_CL_IDX AS 'ACCT'  
  INVOICE_NUM
  STATUS
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  GEO_ZONE
  TRIP_PURPOSE
  TRP_DESC
  TASF_TKT_NUM
  ONL_T AS 'ONLT'
  IDFLAG
  EXECF
  AGENT_NUM
BY FLAG
-* WHERE PASSNGR_NAME NE ' '
WHERE BR_CL_IDX IN FILE HTLCLIENT
ON TABLE HOLD AS HOLDHP FORMAT FOCUS
END
-RUN






JOIN CLEAR *
-RUN


DEFINE FILE HTLHOLD
GEO_ZONE/A3 = IF GEO_ZONE EQ ' ' THEN 'USA' ELSE GEO_ZONE;
FLAG/A1 = 'H';
END

TABLE FILE HTLHOLD
PRINT 
PASSNGR_NAME
PNR_LOCATOR
TRAN_DATE
TKT_NUM
TSORT
TYPE
SEG      
NAME
DATE
DATE2
CITY1
DV_NUM
AMOUNT
TTL_COUNT
ACCT
INVOICE_NUM
STATUS
LEVEL_DESC
LEVEL1
LEVEL2
LEVEL3
LEVEL4
LEVEL5
LEVEL6
GEO_ZONE
TRIP_PURPOSE
TRP_DESC
TASF_TKT_NUM
ONLT
IDFLAG
EXECF
AGENT_NUM
BY FLAG
ON TABLE HOLD
END
-RUN

MODIFY FILE HOLDHP
FIXFORM FROM HOLD
DATA ON HOLD
END
-RUN
-SET &HFILENAME = 'HOLDHP';
-RUN
-*


-**********
-ToHoldHtl
-**********
DEFINE FILE &HFILENAME
 ASSOC_CONF_NUM/A30 = ' ';
 TRANS_CODE/A2=' ';
 EXCHG_SALE/A1='';
 DOC_TYPE/A1='';
END
-*
TABLE FILE &HFILENAME
PRINT PASSNGR_NAME
      PNR_LOCATOR
      TRAN_DATE
      TKT_NUM
      TSORT 
      TYPE
      SEG    
      NAME
      DATE
      DATE2
      CITY1
      DV_NUM
      AMOUNT
      TTL_COUNT
      ACCT
      INVOICE_NUM
      STATUS
      LEVEL_DESC
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL5
      LEVEL6
      GEO_ZONE
      TRIP_PURPOSE
      TRP_DESC
      TASF_TKT_NUM
      ASSOC_CONF_NUM
      ONLT
      IDFLAG
      EXECF
      TRANS_CODE
      EXCHG_SALE
      DOC_TYPE
      AGENT_NUM
BY FLAG
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN





 -*
-GOTO XXIT1;
-*
-******** 
-NoHJoin
-******** 
DEFINE FILE HTLHOLD
 GEO_ZONE      /A3  = IF GEO_ZONE EQ ' ' THEN 'USA' ELSE GEO_ZONE;
 FLAG          /A1  = 'H';
 FEE_AMT       /D9.2= 0;
 ASSOC_CONF_NUM/A30 = ' ';
 TRANS_CODE/A2=' ';
 EXCHG_SALE/A1='';
 DOC_TYPE/A1='';
END
-*
TABLE FILE HTLHOLD
PRINT PASSNGR_NAME
      PNR_LOCATOR
      TRAN_DATE
      TKT_NUM
      TSORT 
      TYPE
      SEG    
      NAME
      DATE
      DATE2
      CITY1
      DV_NUM
      AMOUNT
      TTL_COUNT
      ACCT
      INVOICE_NUM
      STATUS
      LEVEL_DESC
      LEVEL1
      LEVEL2
      LEVEL3
      LEVEL4
      LEVEL5
      LEVEL6
      GEO_ZONE
      TRIP_PURPOSE
      TRP_DESC
      TASF_TKT_NUM
      ASSOC_CONF_NUM
      ONLT
      IDFLAG
      EXECF
      TRANS_CODE
      EXCHG_SALE
      DOC_TYPE
      AGENT_NUM
BY FLAG
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN


-*
-SET &&NOHTL = IF &RECORDS EQ 0 THEN 'Y' ELSE 'N';
-*
-*******
-XXIT1
-*******
