-***************************************************************************
-* REPORT NAME: TOP NON DIRECTIONAL MARKET PAIR SUMMARY
-* TOTAL COMPANY REPORTING
-* JK added code to select only tnt_company eq 1 or 2 2/21/05
-***************************************************************************
-INCLUDE SETECHO
SET ASNAMES = ON
-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED IN STEP7
-*========================================================================
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

DEFINE FILE &&EXTRACT
DEMB_APT/A21=EDIT(EMB_APT.AIRPORT_NAME,'999999999999999999999$$$$');
DIR_CITY_CD/A50 = EMB_CTY.EMB_CITY || '-' || RTE_CTY.RTE_CITY;
DIR_CITY_NM/A50 = EMB_CTY.CITY_NAME | RTE_CTY.CITY_NAME; 
DIR_CP_CD/A50 = CITYPAIR.EMBARK || '-' || CITYPAIR.ROUTE;
DIR_CP_NM/A50 = EMB_APT.AIRPORT_NAME | RTE_APT.AIRPORT_NAME;
DPT/A2 = EDIT (DPT_TIME, '99$$');
DRTE_APT/A21=EDIT(RTE_APT.AIRPORT_NAME,'999999999999999999999$$$$');
EMB_APT/A21=EDIT(NDO_APT.AIRPORT_NAME,'999999999999999999999$$$$');
FARE_PAID/D12.2S  = SEG_AMT;
ND_CITY_CD/A50 = NDO_CTY.NDO_CITY || '-' || NDD_CTY.NDD_CITY;
ND_CITY_NM/A50 = NDO_CTY.CITY_NAME | NDD_CTY.CITY_NAME;
ND_CP_CD/A50  = NDO_APT.ND_ORG || '-' || NDD_APT.ND_DST;
MRK_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (EX_FLAG NE ' ') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (RF_FLAG NE ' ') THEN (-1) ELSE 0;
RTE_APT/A21=EDIT(NDD_APT.AIRPORT_NAME,'999999999999999999999$$$$');
-* Defines on Previous Defines
ND_CP_NM/A55 = EMB_APT|'        '|RTE_APT;
 
 
 
F_FAREB/A1 = EDIT(FARE_BAS, '9'); 
DESIG/A7 = 'COS-' | CLASS;
EX_IND/A1 = IF EX_FLAG NE ' ' THEN 'Y' ELSE 'N';
RF_IND/A1 = IF RF_FLAG NE ' ' THEN 'Y' ELSE 'N';
 
XTRAN_DT/MDYY = TRN_DATE;

END

TABLEF FILE &&EXTRACT
PRINT 
  ADIR_ALL
  CITYPAIR.AIRLINE AS 'CP_AIRLINE'
  TKT_MAIN.SEG_MILES  AS 'TSEG_MILES'	
  FARE_PAID AS 'BASE_FARE'  
  ND_CP_NM
  MRK_TKT_CNT
  ORG_DST
  FARE_BAS
  F_FAREB
  TKT_NUM
  C_ITIN
  DESIG
  EX_IND
  RF_IND
  EMB_APT.COUNTRY_CODE AS 'EMB_CTRY'
  RTE_APT.COUNTRY_CODE AS 'RTE_CTRY'
  EMB_APT.GEO_ZONE AS 'EMB_GEO'
  RTE_APT.GEO_ZONE AS 'RTE_GEO'
  FARE_BASE_CODE AS 'FB_CODES'
  ORG_DST
  AIR_MAIN.INTL_DOM AS 'INTDOM'
  XTRAN_DT
  DIR_CITY_CD
-INCLUDE &AIRDATES
WHERE VOID_DATE EQ 0
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS TCHOLD1 
END
-RUN
 
 


-IF &LINES EQ 0 THEN GOTO NEXTONE;
-*========================================================================
-*   PROCESS EXTRACT DATA FROM STEP4 - HOLD TO FOCUS DATABASE TCRANK        
-*========================================================================


DEFINE FILE TCHOLD1
ROLLCD/A8 = '&&ROLL';
END
TABLE FILE TCHOLD1
SUM BASE_FARE
    MRK_TKT_CNT	
BY ROLLCD
BY CP_AIRLINE

BY ORG_DST

BY TKT_NUM
BY DIR_CITY_CD
BY C_ITIN
BY FARE_BAS
BY F_FAREB
BY DESIG
BY EX_IND
BY RF_IND
BY EMB_CTRY
BY RTE_CTRY
BY XTRAN_DT
BY EMB_GEO
BY RTE_GEO
BY FB_CODES
BY TSEG_MILES
BY ADIR_ALL
BY INTDOM
ON TABLE HOLD AS HOLD2 
END
-RUN


 
DEFINE FILE HOLD2
NMB/I5    = NMB + 1;
END

TABLE FILE HOLD2
PRINT C_ITIN
      FARE_BAS
      F_FAREB
      DESIG
      MRK_TKT_CNT
      BASE_FARE
      EX_IND
      RF_IND
      EMB_CTRY
      RTE_CTRY
      XTRAN_DT
      EMB_GEO
      RTE_GEO
      FB_CODES
      TSEG_MILES
      ADIR_ALL
      INTDOM
BY ROLLCD
BY NMB
BY CP_AIRLINE
BY ORG_DST
BY TKT_NUM
BY DIR_CITY_CD
ON TABLE HOLD AS TCUM1
END
-RUN




MODIFY FILE TCULTRA
FIXFORM FROM TCUM1
DATA ON TCUM1
END
-RUN
-NEXTONE


 
-XXIT
