-* File FIXHDRR.FEX

-***************************************************************************
-* This program will fix the ID- Level1, Level2 AND Level3 for HDRR-R.
-* It will also correct the AROLL_LEV4 in S_, M_ and D_ - Zero fill record
-* DATE           NAME
-* 12/30/2002     Steve - creation
-***************************************************************************
-GOTO STEP8

-STEP1
-* UPDATE LEVEL2 AND LEVEL3 IN AIR_MAIN

SET ASNAMES=ON

TABLE FILE A_HDRR
PRINT AIR_KEY LEVEL2 AND COMPUTE
LEVELF/A11=EDIT(LEVEL2, '99999999999$$$$');
LEVELL/A4=EDIT(LEVEL2, '$$$$$$$$$$$9999');
LEVELB/A1=EDIT(LEVEL2, '$$$$$$$$$$$$$9$');
BAD_CHAR/I3=CHKFMT (15, LEVEL2, '999999999999999', BAD_CHAR);
LEV2NEW/A15='0000'||LEVELF;
LEV3NEW/A15=IF LEVELL EQ ' ' THEN ' ' ELSE '0'||LEVELL;
BY AIR_KEY NOPRINT
IF LEVEL2 NE ' '
IF BAD_CHAR GT 8
IF LEVELB EQ ' '
ON TABLE HOLD
END
-RUN

TABLE FILE HOLD
PRINT AIR_KEY LEV2NEW AS 'LEVEL2' LEV3NEW AS 'LEVEL3'
BY AIR_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE A_HDRR
FIXFORM FROM HOLD1
MATCH AIR_KEY
ON MATCH UPDATE LEVEL2
ON MATCH UPDATE LEVEL3
ON NOMATCH REJECT
DATA ON HOLD1
END
-RUN

-STEP2
-* UPDATE LEVEL1 IN AIR_MAIN

TABLE FILE A_HDRR
PRINT AIR_KEY LEVEL1 AND COMPUTE
BAD_CHAR/I3=CHKFMT (15, LEVEL1, '999999999999999', BAD_CHAR);
LEVELX/A13=EDIT(LEVEL1, '9999999999999$$');
LEV1NEW/A15='00'||LEVELX;
LEVELB/A1=EDIT(LEVEL1, '$$$9$$$$$$$$$$$');
BY AIR_KEY NOPRINT
IF BAD_CHAR GT 3
IF LEVELB EQ ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT AIR_KEY LEV1NEW AS 'LEVEL1'
BY AIR_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE A_HDRR
FIXFORM FROM HOLD1
MATCH AIR_KEY
ON MATCH UPDATE LEVEL1
ON NOMATCH REJECT
DATA ON HOLD1
END

-STEP3
-* UPDATE AROLL_LEV4 IN CITYPAIR (SEGMENT, MARKET AND DESTINATION)

TABLE FILE S_HDRR
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
AROLL_LEV4 AND COMPUTE
BAD_CHAR/I3=CHKFMT (15, AROLL_LEV4, '999999999999999', BAD_CHAR);
LEVELX/A13=EDIT(AROLL_LEV4, '9999999999999$$');
LEV1NEW/A15='00'||LEVELX;
BL_CHAR/A1=EDIT(AROLL_LEV4, '$$$9$$$$$$$$$$$');
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
IF BAD_CHAR GT 3
IF BL_CHAR EQ ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR LEV1NEW AS 'AROLL_LEV4'
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE S_HDRR
FIXFORM FROM HOLD1
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON HOLD1
END

TABLE FILE M_HDRR
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
AROLL_LEV4 AND COMPUTE
BAD_CHAR/I3=CHKFMT (15, AROLL_LEV4, '999999999999999', BAD_CHAR);
LEVELX/A13=EDIT(AROLL_LEV4, '9999999999999$$');
LEV1NEW/A15='00'||LEVELX;
BL_CHAR/A1=EDIT(AROLL_LEV4, '$$$9$$$$$$$$$$$');
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
IF BAD_CHAR GT 3
IF BL_CHAR EQ ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR LEV1NEW AS 'AROLL_LEV4'
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE M_HDRR
FIXFORM FROM HOLD1
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON HOLD1
END

TABLE FILE D_HDRR
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
AROLL_LEV4 AND COMPUTE
BAD_CHAR/I3=CHKFMT (15, AROLL_LEV4, '999999999999999', BAD_CHAR);
LEVELX/A13=EDIT(AROLL_LEV4, '9999999999999$$');
LEV1NEW/A15='00'||LEVELX;
BL_CHAR/A1=EDIT(AROLL_LEV4, '$$$9$$$$$$$$$$$');
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
IF BAD_CHAR GT 3
IF BL_CHAR EQ ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR LEV1NEW AS 'AROLL_LEV4'
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE D_HDRR
FIXFORM FROM HOLD1
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON HOLD1
END

-STEP4

TABLE FILE A_HDRR
PRINT AIR_KEY LEVEL3 AND COMPUTE
LEV3NEW1/A1=EDIT(LEVEL3, '$$$9$$$$$$$$$$$');
LEV3NEW2/A1=EDIT(LEVEL3, '$$9$$$$$$$$$$$$');
LEV3NEW3/A1=EDIT(LEVEL3, '$9$$$$$$$$$$$$$');
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT AIR_KEY LEVEL3
BY AIR_KEY NOPRINT
WHERE (LEV3NEW1 NE ' ') OR (LEV3NEW2 EQ ' ') OR (LEV3NEW3 EQ ' ')
OR (LEVEL3 CONTAINS 'HDR' OR 'JOB' OR 'MCO' OR 'SEE');
ON TABLE HOLD AS HOLD1
END

MODIFY FILE A_HDRR
FIXFORM FROM HOLD1
MATCH AIR_KEY
ON MATCH COMPUTE LEVEL3='               ';
ON MATCH UPDATE LEVEL3
ON NOMATCH REJECT
DATA ON HOLD1
END
-EXIT

-STEP5

TABLE FILE A_HDRR
PRINT AIR_KEY LEVEL2
AND COMPUTE
LEVELB/A1=EDIT(LEVEL2, '$$$9$$$$$$$$$$$');
BY AIR_KEY NOPRINT
IF LEVELB EQ ' '
IF LEVEL2 NE ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT AIR_KEY LEVEL2
BY AIR_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE A_HDRR
FIXFORM FROM HOLD1
MATCH AIR_KEY
ON MATCH COMPUTE LEVEL2='               ';
ON MATCH UPDATE LEVEL2
ON NOMATCH REJECT
DATA ON HOLD1
END
-EXIT

-STEP6

-* CAR

SET ASNAMES=ON

TABLE FILE C_HDRR
PRINT CAR_KEY LEVEL2 AND COMPUTE
LEVELF/A11=EDIT(LEVEL2, '99999999999$$$$');
LEVELL/A4=EDIT(LEVEL2, '$$$$$$$$$$$9999');
LEVELB/A1=EDIT(LEVEL2, '$$$$$$$$$$$$$9$');
BAD_CHAR/I3=CHKFMT (15, LEVEL2, '999999999999999', BAD_CHAR);
LEV2NEW/A15='0000'||LEVELF;
LEV3NEW/A15=IF LEVELL EQ ' ' THEN ' ' ELSE '0'||LEVELL;
BY CAR_KEY NOPRINT
IF LEVEL2 NE ' '
IF BAD_CHAR GT 8
IF LEVELB EQ ' '
ON TABLE HOLD
END
-RUN

TABLE FILE HOLD
PRINT CAR_KEY LEV2NEW AS 'LEVEL2' LEV3NEW AS 'LEVEL3'
BY CAR_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE C_HDRR
FIXFORM FROM HOLD1
MATCH CAR_KEY
ON MATCH UPDATE LEVEL2
ON MATCH UPDATE LEVEL3
ON NOMATCH REJECT
DATA ON HOLD1
END
-RUN

TABLE FILE C_HDRR
PRINT CAR_KEY LEVEL1 AND COMPUTE
BAD_CHAR/I3=CHKFMT (15, LEVEL1, '999999999999999', BAD_CHAR);
LEVELX/A13=EDIT(LEVEL1, '9999999999999$$');
LEV1NEW/A15='00'||LEVELX;
LEVELB/A1=EDIT(LEVEL1, '$$$9$$$$$$$$$$$');
BY CAR_KEY NOPRINT
IF BAD_CHAR GT 3
IF LEVELB EQ ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT CAR_KEY LEV1NEW AS 'LEVEL1'
BY CAR_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE C_HDRR
FIXFORM FROM HOLD1
MATCH CAR_KEY
ON MATCH UPDATE LEVEL1
ON NOMATCH REJECT
DATA ON HOLD1
END

TABLE FILE C_HDRR
PRINT CAR_KEY LEVEL3 AND COMPUTE
LEV3NEW1/A1=EDIT(LEVEL3, '$$$9$$$$$$$$$$$');
LEV3NEW2/A1=EDIT(LEVEL3, '$$9$$$$$$$$$$$$');
LEV3NEW3/A1=EDIT(LEVEL3, '$9$$$$$$$$$$$$$');
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT CAR_KEY LEVEL3
BY CAR_KEY NOPRINT
WHERE (LEV3NEW1 NE ' ') OR (LEV3NEW2 EQ ' ') OR (LEV3NEW3 EQ ' ')
OR (LEVEL3 CONTAINS 'HDR' OR 'JOB' OR 'MCO' OR 'SEE');
ON TABLE HOLD AS HOLD1
END

MODIFY FILE C_HDRR
FIXFORM FROM HOLD1
MATCH CAR_KEY
ON MATCH COMPUTE LEVEL3='               ';
ON MATCH UPDATE LEVEL3
ON NOMATCH REJECT
DATA ON HOLD1
END

TABLE FILE C_HDRR
PRINT CAR_KEY LEVEL2
AND COMPUTE
LEVELB/A1=EDIT(LEVEL2, '$$$9$$$$$$$$$$$');
BY CAR_KEY NOPRINT
IF LEVELB EQ ' '
IF LEVEL2 NE ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT CAR_KEY LEVEL2
BY CAR_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE C_HDRR
FIXFORM FROM HOLD1
MATCH CAR_KEY
ON MATCH COMPUTE LEVEL2='               ';
ON MATCH UPDATE LEVEL2
ON NOMATCH REJECT
DATA ON HOLD1
END

-* HOTEL

TABLE FILE H_HDRR
PRINT HTL_KEY LEVEL2 AND COMPUTE
LEVELF/A11=EDIT(LEVEL2, '99999999999$$$$');
LEVELL/A4=EDIT(LEVEL2, '$$$$$$$$$$$9999');
LEVELB/A1=EDIT(LEVEL2, '$$$$$$$$$$$$$9$');
BAD_CHAR/I3=CHKFMT (15, LEVEL2, '999999999999999', BAD_CHAR);
LEV2NEW/A15='0000'||LEVELF;
LEV3NEW/A15=IF LEVELL EQ ' ' THEN ' ' ELSE '0'||LEVELL;
BY HTL_KEY NOPRINT
IF LEVEL2 NE ' '
IF BAD_CHAR GT 8
IF LEVELB EQ ' '
ON TABLE HOLD
END
-RUN

TABLE FILE HOLD
PRINT HTL_KEY LEV2NEW AS 'LEVEL2' LEV3NEW AS 'LEVEL3'
BY HTL_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE H_HDRR
FIXFORM FROM HOLD1
MATCH HTL_KEY
ON MATCH UPDATE LEVEL2
ON MATCH UPDATE LEVEL3
ON NOMATCH REJECT
DATA ON HOLD1
END
-RUN

TABLE FILE H_HDRR
PRINT HTL_KEY LEVEL1 AND COMPUTE
BAD_CHAR/I3=CHKFMT (15, LEVEL1, '999999999999999', BAD_CHAR);
LEVELX/A13=EDIT(LEVEL1, '9999999999999$$');
LEV1NEW/A15='00'||LEVELX;
LEVELB/A1=EDIT(LEVEL1, '$$$9$$$$$$$$$$$');
BY HTL_KEY NOPRINT
IF BAD_CHAR GT 3
IF LEVELB EQ ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT HTL_KEY LEV1NEW AS 'LEVEL1'
BY HTL_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE H_HDRR
FIXFORM FROM HOLD1
MATCH HTL_KEY
ON MATCH UPDATE LEVEL1
ON NOMATCH REJECT
DATA ON HOLD1
END

TABLE FILE H_HDRR
PRINT HTL_KEY LEVEL3 AND COMPUTE
LEV3NEW1/A1=EDIT(LEVEL3, '$$$9$$$$$$$$$$$');
LEV3NEW2/A1=EDIT(LEVEL3, '$$9$$$$$$$$$$$$');
LEV3NEW3/A1=EDIT(LEVEL3, '$9$$$$$$$$$$$$$');
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT HTL_KEY LEVEL3
BY HTL_KEY NOPRINT
WHERE (LEV3NEW1 NE ' ') OR (LEV3NEW2 EQ ' ') OR (LEV3NEW3 EQ ' ')
OR (LEVEL3 CONTAINS 'HDR' OR 'JOB' OR 'MCO' OR 'SEE');
ON TABLE HOLD AS HOLD1
END

MODIFY FILE H_HDRR
FIXFORM FROM HOLD1
MATCH HTL_KEY
ON MATCH COMPUTE LEVEL3='               ';
ON MATCH UPDATE LEVEL3
ON NOMATCH REJECT
DATA ON HOLD1
END

TABLE FILE H_HDRR
PRINT HTL_KEY LEVEL2
AND COMPUTE
LEVELB/A1=EDIT(LEVEL2, '$$$9$$$$$$$$$$$');
BY HTL_KEY NOPRINT
IF LEVELB EQ ' '
IF LEVEL2 NE ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT HTL_KEY LEVEL2
BY HTL_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE H_HDRR
FIXFORM FROM HOLD1
MATCH HTL_KEY
ON MATCH COMPUTE LEVEL2='               ';
ON MATCH UPDATE LEVEL2
ON NOMATCH REJECT
DATA ON HOLD1
END
-EXIT

-STEP7

-* CAR

TABLE FILE C_HDRR
PRINT CAR_KEY
AROLL_LEV4 AND COMPUTE
BAD_CHAR/I3=CHKFMT (15, AROLL_LEV4, '999999999999999', BAD_CHAR);
LEVELX/A13=EDIT(AROLL_LEV4, '9999999999999$$');
LEV1NEW/A15='00'||LEVELX;
BL_CHAR/A1=EDIT(AROLL_LEV4, '$$$9$$$$$$$$$$$');
BY CAR_KEY NOPRINT
IF BAD_CHAR GT 3
IF BL_CHAR EQ ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT CAR_KEY LEV1NEW AS 'AROLL_LEV4'
BY CAR_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE C_HDRR
FIXFORM FROM HOLD1
MATCH CAR_KEY
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON HOLD1
END

-* HOTEL

TABLE FILE H_HDRR
PRINT HTL_KEY
AROLL_LEV4 AND COMPUTE
BAD_CHAR/I3=CHKFMT (15, AROLL_LEV4, '999999999999999', BAD_CHAR);
LEVELX/A13=EDIT(AROLL_LEV4, '9999999999999$$');
LEV1NEW/A15='00'||LEVELX;
BL_CHAR/A1=EDIT(AROLL_LEV4, '$$$9$$$$$$$$$$$');
BY HTL_KEY NOPRINT
IF BAD_CHAR GT 3
IF BL_CHAR EQ ' '
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT HTL_KEY LEV1NEW AS 'AROLL_LEV4'
BY HTL_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

MODIFY FILE H_HDRR
FIXFORM FROM HOLD1
MATCH HTL_KEY
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON HOLD1
END
-EXIT

-STEP8

-* FIX I_SUMM

SET ASNAMES=ON

TABLE FILE I_SUMM
PRINT INST_KEY HSEL1 HDES1 HSIF01 AND COMPUTE
HSELA/A13=EDIT(HSEL1, '9999999999999$$');
HDESA/A1=EDIT(HDES1, '9$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
HDESB/A50=EDIT(HDES1, '$99999999999999999999999999999999999999999999999999');
HSIFA/A19=EDIT(HSIF01, '9999999999999999999');
HSIFB/A20=EDIT(HSIF01, '$$$$$$$$$$$$$$$$$$$99999999999999999999');
IF INST_KEY CONTAINS 'HDRR-R'
IF HSIF01 CONTAINS 'AROLL_LEV4'
ON TABLE HOLD
END

TABLE FILE HOLD
PRINT INST_KEY
AND COMPUTE
HSEL1X/A15='00'||HSELA;
HDESX/A60=HDESA||'00'||HDESB;
HSIFX/A65=HSIFA||'00'||HSIFB;
BY INST_KEY NOPRINT
ON TABLE HOLD AS HOLD1
END

TABLE FILE HOLD1
PRINT INST_KEY
HSEL1X AS 'HSEL1'
HDESX AS 'HDES1'
HSIFX AS 'HSIF01'
BY INST_KEY NOPRINT
ON TABLE HOLD AS HOLD2
END

MODIFY FILE I_SUMM
FIXFORM FROM HOLD2
MATCH INST_KEY 
ON MATCH UPDATE HSEL1
ON MATCH UPDATE HDES1
ON MATCH UPDATE HSIF01
ON NOMATCH REJECT
DATA ON HOLD2
END
-EXIT


