-*========================================================================
-* 08/16/2003
-*
-* TOTAL COMPANY NON-DIRECTIONAL CITY PAIR - QUARTERED DATABASE CLIENTS
-*
-* 4/27/04  SAC   ADDED TRP_REF AND NHR_REF
-*========================================================================
-*                <---------------- STEP1 ---------------->
-*========================================================================
-*      CLEAR ROLLUPX PROCESS STAMPS BEFORE TOTAL COMPANY REPORT RUN
-*========================================================================
-* -INCLUDE SETECHO
-SET HOLDATTR = ON;
SET ASNAMES = ON

USE
D:\TNT\TTRACKER\SYSTEM\DATA\ROLLUPX.FOC
END

FILEDEF WLT DISK D:\FOCTEMP\WLT.DAT
-RUN

EX SETDBLS SETFILE=&&SETF
-RUN
-*========================================================================
-*              SET PROCESS STAMP TO ' ' (FIELD = PR_STAMP)
-*========================================================================
DEFINE FILE ROLLUPX
XL01/A1 = ' ' ;
END
TABLE FILE ROLLUPX
BY ROLLUP_CODE NOPRINT
PRINT ROLLUP_CODE
      XL01 AS 'PR_STAMP' 
IF UPD_ENABLE EQ 'X'
IF QTR_ENABLE EQ 'X'
ON TABLE HOLD 
END
MODIFY FILE ROLLUPX
FIXFORM FROM HOLD
MATCH ROLLUP_CODE
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-*========================================================================
-* SET PROCESS STAMP TO 'T' (FIELD = PR_STAMP) - ROLLUP CODES TO PROCESS
-*========================================================================
DEFINE FILE ROLLUPX
XL01/A1 = 'T' ;
END
TABLE FILE ROLLUPX
BY ROLLUP_CODE NOPRINT
PRINT ROLLUP_CODE
      XL01 AS 'PR_STAMP'
IF UPD_ENABLE EQ 'X'
IF QTR_ENABLE EQ 'X'
ON TABLE HOLD 
END
MODIFY FILE ROLLUPX
FIXFORM FROM HOLD
MATCH ROLLUP_CODE
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
-*========================================================================
-*       FIND CLIENTS TO PROCESS
-*========================================================================
-TCLOOP
USE CLEAR *

TABLE FILE ROLLUPX
BY ROLLUP_CODE NOPRINT
PRINT COMP
IF PR_STAMP EQ 'T'
IF QTR_ENABLE EQ 'X'
-* IF ROLLUP NE 'ABCD-R' OR 'TOTAL-R'
IF ROLLUP EQ 'CONG-R'
IF RECORDLIMIT EQ 1
ON TABLE SAVE
END
-RUN
-IF &RECORDS EQ 0 GOTO STOP;
-SET &&AIR_PATH = 'D:\TNT\TTRACKER\DATA\' ;
-SET &&COM_PATH = 'D:\TNT\TTRACKER\SYSTEM\DATA\' ;
-SET &&SU_PATH = 'D:\TNT\TTRACKER\SUDATA\' ;
-SET &CNT  = 1;
-RUN
-READ SAVE &&XX.A6.

-SET &&AH = AH_50;
-SET &&DAH = AH_50 || '.';
-SET &&EXTRACT = MR_50;
-SET &&EXTJOIN = MR_JOIN;
-SET &&COMPNY1  = &&XX ;

-SET &&AIR_PATH = 'D:\TNT\TTRACKER\DATA\';
-SET &&COM_PATH = 'D:\TNT\TTRACKER\SYSTEM\DATA\';
-SET &&SU_PATH = 'D:\TNT\TTRACKER\SUDATA\';
-*========================================================================
-*                    USE AL DATABASES
-*========================================================================
-SET &&AH_DB1 = 'AL' || &&COMPNY1 || '.FOC';

-SET &&USE_AH1 = &&AIR_PATH || &&AH_DB1;


-SET &&USE_AREF = &&COM_PATH || 'AIR_REF.FOC';
-SET &&USE_TREF = &&COM_PATH || 'TRP_REF.FOC';
-SET &&USE_NREF = &&COM_PATH || 'NHR_REF.FOC';
-SET &&USE_CLNT = &&COM_PATH || 'CLIENT.FOC';
-SET &&USE_BRCH = &&COM_PATH || 'BRANCH.FOC';
-SET &&USE_ROLL = &&COM_PATH || 'ROLLUPX.FOC';
-SET &&USE_CCAT = &&COM_PATH || 'CLS_CAT.FOC';
-SET &&USE_ARPT = &&COM_PATH || 'AIRPORT.FOC';
-SET &&USE_AEMB = &&COM_PATH || 'EMBARPT.FOC';
-SET &&USE_ARTE = &&COM_PATH || 'RTEARPT.FOC';
-SET &&USE_ANDO = &&COM_PATH || 'NDOARPT.FOC';
-SET &&USE_ANDD = &&COM_PATH || 'NDDARPT.FOC';
-SET &&USE_MILG = &&COM_PATH || 'MILEAGE.FOC';
-SET &&USE_ARLN = &&COM_PATH || 'AIRLINE.FOC';
-SET &&USE_CITY = &&COM_PATH || 'CITY.FOC';
-SET &&USE_CEMB = &&COM_PATH || 'EMBCITY.FOC';
-SET &&USE_CRTE = &&COM_PATH || 'RTECITY.FOC';
-SET &&USE_CNDO = &&COM_PATH || 'NDOCITY.FOC';
-SET &&USE_CNDD = &&COM_PATH || 'NDDCITY.FOC';
-SET &&USE_VAIR = &&COM_PATH || 'VAL_AIR.FOC';

USE CLEAR *
-RUN

-SET &&COMP1A = 'M0' ||&&COMPNY1 || '.FOC';
-SET &&COMP1B = 'A0' ||&&COMPNY1 || '.FOC';
-SET &&COMP1C = 'T0' ||&&COMPNY1 || '.FOC';

-SET &&COMP2A = 'M1' ||&&COMPNY1 || '.FOC';
-SET &&COMP2B = 'A1' ||&&COMPNY1 || '.FOC';
-SET &&COMP2C = 'T1' ||&&COMPNY1 || '.FOC';

-SET &&COMP3A = 'M2' ||&&COMPNY1 || '.FOC';
-SET &&COMP3B = 'A2' ||&&COMPNY1 || '.FOC';
-SET &&COMP3C = 'T2' ||&&COMPNY1 || '.FOC';

-SET &&COMP4A = 'M3' ||&&COMPNY1 || '.FOC';
-SET &&COMP4B = 'A3' ||&&COMPNY1 || '.FOC';
-SET &&COMP4C = 'T3' ||&&COMPNY1 || '.FOC';

-SET &&COMP5A = 'M4' ||&&COMPNY1 || '.FOC';
-SET &&COMP5B = 'A4' ||&&COMPNY1 || '.FOC';
-SET &&COMP5C = 'T4' ||&&COMPNY1 || '.FOC';

-SET &&COMP6A = 'M5' ||&&COMPNY1 || '.FOC';
-SET &&COMP6B = 'A5' ||&&COMPNY1 || '.FOC';
-SET &&COMP6C = 'T5' ||&&COMPNY1 || '.FOC';

-SET &&COMP7A = 'M6' ||&&COMPNY1 || '.FOC';
-SET &&COMP7B = 'A6' ||&&COMPNY1 || '.FOC';
-SET &&COMP7C = 'T6' ||&&COMPNY1 || '.FOC';

-SET &&COMP8A = 'M7' ||&&COMPNY1 || '.FOC';
-SET &&COMP8B = 'A7' ||&&COMPNY1 || '.FOC';
-SET &&COMP8C = 'T7' ||&&COMPNY1 || '.FOC';

-SET &&COMP9A = 'M8' ||&&COMPNY1 || '.FOC';
-SET &&COMP9B = 'A8' ||&&COMPNY1 || '.FOC';
-SET &&COMP9C = 'T8' ||&&COMPNY1 || '.FOC';

-SET &&COMP10A = 'M9' ||&&COMPNY1 || '.FOC';
-SET &&COMP10B = 'A9' ||&&COMPNY1 || '.FOC';
-SET &&COMP10C = 'T9' ||&&COMPNY1 || '.FOC';

-SET &&COMP11A = 'MY' ||&&COMPNY1 || '.FOC';
-SET &&COMP11B = 'AY' ||&&COMPNY1 || '.FOC';
-SET &&COMP11C = 'TY' ||&&COMPNY1 || '.FOC';

-SET &&COMP12A = 'MZ' ||&&COMPNY1 || '.FOC';
-SET &&COMP12B = 'AZ' ||&&COMPNY1 || '.FOC';
-SET &&COMP12C = 'TZ' ||&&COMPNY1 || '.FOC';


USE ADD

D:\TNT\TTRACKER\DATA\&&COMP1A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP1B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP1C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP2A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP2B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP2C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP3A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP3B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP3C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP4A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP4B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP4C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP5A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP5B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP5C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP6A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP6B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP6C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP7A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP7B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP7C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP8A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP8B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP8C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP9A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP9B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP9C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP10A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP10B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP10C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP11A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP11B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP11C AS TKT_MAIN

D:\TNT\TTRACKER\DATA\&&COMP12A AS &&EXTRACT
D:\TNT\TTRACKER\DATA\&&COMP12B AS AIR_MAIN
D:\TNT\TTRACKER\DATA\&&COMP12C AS TKT_MAIN


  &&USE_ARLN
  &&USE_MILG
  &&USE_CCAT
  &&USE_AEMB
  &&USE_CEMB
  &&USE_ARTE
  &&USE_CRTE
  &&USE_ANDO
  &&USE_CNDO
  &&USE_ANDD
  &&USE_CNDD
  &&USE_VAIR
  &&USE_AREF
  &&USE_TREF
  &&USE_NREF
  &&USE_CLNT

  &&USE_AH1 AS &&AH

END
-RUN
-*========================================================================
-*                <---------------- STEP2 ---------------->
-*========================================================================
-*                      PERFORM DATA EXTRACT AND HOLD
-*========================================================================
DEFINE FILE &&EXTRACT
COMM_SEG/D12.2S   = SEG_COM;
DEMB_APT/A21=EDIT(EMB_APT.AIRPORT_NAME,'999999999999999999999$$$$');
DIR_CITY_CD/A50 = EMB_CTY.EMB_CITY || '-' || RTE_CTY.RTE_CITY;
DIR_CITY_NM/A50 = EMB_CTY.CITY_NAME | RTE_CTY.CITY_NAME; 
DIR_CP_CD/A50 = CITYPAIR.EMBARK || '-' || CITYPAIR.ROUTE;
DIR_CP_NM/A50 = EMB_APT.AIRPORT_NAME | RTE_APT.AIRPORT_NAME;
DRTE_APT/A21=EDIT(RTE_APT.AIRPORT_NAME,'999999999999999999999$$$$');
EMB_APT/A21=EDIT(NDO_APT.AIRPORT_NAME,'999999999999999999999$$$$');
FARE_PAID/D12.2S  = SEG_AMT;
LEVEL_DESC/A60 = 'AROLL_DSC2';
ND_CITY_CD/A50 = NDO_CTY.NDO_CITY || '-' || NDD_CTY.NDD_CITY;
ND_CITY_NM/A50 = NDO_CTY.CITY_NAME | NDD_CTY.CITY_NAME;
ND_CP_CD/A50  = NDO_APT.ND_ORG || '-' || NDD_APT.ND_DST;
NET_COMM/D12.2S   = (SEG_AMT - SEG_COM);
NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (EX_FLAG NE ' ') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (RF_FLAG NE ' ') THEN (-1) ELSE 0;
NET_FARE/D12.2S  = IF (EX_FLAG EQ ' ') AND (RF_FLAG EQ ' ')
                         THEN SEG_AMT ELSE 0;
RTE_APT/A21=EDIT(NDD_APT.AIRPORT_NAME,'999999999999999999999$$$$');
TOTAL_FARE/D12.2S = SEG_AMT + SEG_TAX;

-* ****DEFINES ON PREVIOUS DEFINES****
ND_CP_NM/A50 = EMB_APT|'        '|RTE_APT;
ORGDST/A50 = &&ORGDST;
-******** NEW DEFINES TO CORRECT CITY/AIRPORT NAME/CODE ISSUE JK ******

-******* PRODUCES DIRECTIONAL CITY CODES ***************
DIR_CTY_CDO/A25 = EMB_CTY.EMB_CITY;
DIR_CTY_CDD/A25 = RTE_CTY.RTE_CITY;

-******* PRODUCES DIRECTIONAL CITY NAMES ***************
DIR_CTY_NMO/A25 = EMB_CTY.CITY_NAME;
DIR_CTY_NMD/A25 = RTE_CTY.CITY_NAME;

-********* PRODUCES DIRECTIONAL AIRPORT CODES ********
DIR_APT_CDO/A25 = CITYPAIR.EMBARK;
DIR_APT_CDD/A25 = CITYPAIR.ROUTE;

-********* PRODUCES DIRECTIONAL AIRPORT NAMES ********
DIR_APT_NMO/A25 = EMB_APT.AIRPORT_NAME;
DIR_APT_NMD/A25 = RTE_APT.AIRPORT_NAME;

-********* PRODUCES NON-DIRECTIONAL CITY CODES ********
ND_CTY_CDO/A25 = NDO_CTY.NDO_CITY;
ND_CTY_CDD/A25 = NDD_CTY.NDD_CITY;

-********* PRODUCES NON-DIRECTIONAL CITY NAMES ********
ND_CTY_NMO/A25 = NDO_CTY.CITY_NAME;
ND_CTY_NMD/A25 = NDD_CTY.CITY_NAME;

-******** PRODUCES NON-DIRECTIONAL AIRPORT CODES ****
ND_APT_CDO/A25 = NDO_APT.ND_ORG;
ND_APT_CDD/A25 = NDD_APT.ND_DST;

-******** PRODUCES NON-DIRECTIONAL AIRPORT NAMES ****
ND_APT_NMO/A25 = EDIT(NDO_APT.AIRPORT_NAME, '999999999999999999999$$$$');
ND_APT_NMD/A25 = EDIT(NDD_APT.AIRPORT_NAME, '999999999999999999999$$$$');  

END

TABLEF FILE SR_50
PRINT 
  AIR_KEY	
  AIRLINE	
  CITYPAIR.AIRLINE AS 'CP_AIRLINE'	
  CITYPAIR.EMBARK AS 'CP_EMB'         	
  CITYPAIR.INTL_DOM AS 'INTL_DOM'	
  CITYPAIR.NET_COMM AS 'NET_COMM'	
  CITYPAIR.ROUTE AS 'CP_RTE'	
  CITYPAIR.SEG_MILES/D9C AS 'MILES'	
  COMM_SEG	
  DEMB_APT	
  DRTE_APT	
  EMB_APT
  FARE_PAID  AS 'CP_FARE_PD'
  LEVEL_DESC
  ND_CP_CD
  ND_CP_NM
  NET_FARE	
  NET_TKT_CNT
  ORGDST	
  ROLLUP_CODE	
  RTE_APT	
  TOTAL_FARE	
-******* NEW FIELDS *********
  DIR_CTY_CDO
  DIR_CTY_CDD
  DIR_CTY_NMO
  DIR_CTY_NMD
  DIR_APT_CDO
  DIR_APT_CDD
  DIR_APT_NMO
  DIR_APT_NMD
  ND_CTY_CDO
  ND_CTY_CDD
  ND_CTY_NMO
  ND_CTY_NMD
  ND_APT_CDO
  ND_APT_CDD
  ND_APT_NMO
  ND_APT_NMD 

WHERE TRN_DATE GE &&FROMDT.EVAL AND TRN_DATE LE &&TODT.EVAL
WHERE VOID_DATE EQ 0
   
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS

ON TABLE HOLD AS '&&XX' FORMAT FOCUS
END
-RUN

-*========================================================================
-*                <---------------- STEP3 ---------------->
-*========================================================================
-*              UPDATE PR_STAMP TO 'Z' = Rollup Code Processed
-*========================================================================
DEFINE FILE ROLLUPX
XL01/A1 = 'Z' ;
END
TABLE FILE ROLLUPX
BY ROLLUP_CODE NOPRINT
PRINT ROLLUP_CODE
      XL01 AS 'PR_STAMP' 
IF UPD_ENABLE EQ 'X'
IF QTR_ENABLE EQ 'X'
IF PR_STAMP EQ 'T'
IF COMP EQ &&XX
ON TABLE HOLD 
END
MODIFY FILE ROLLUPX
FIXFORM FROM HOLD
MATCH ROLLUP_CODE
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
USE CLEAR *
-GOTO TCLOOP
-RUN

-STOP

