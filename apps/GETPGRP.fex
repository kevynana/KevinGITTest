-* 05/05/16 - RSB - S-16412 - Updated to run in ER5.
-* 05/19/16 - DLV - S-16369 - Added code for new peer selection in ER5
-* 06/10/16 - DLV - S-16369 - Added additional code for car hotel limo selection
-* 06/27/2016 DLV S-18401 Added &&PEERTYPE VARIABLE FOR FOOTER PAGE
-*  12/29/2016  REJ  S-28553 Move ER5 My Reports to production.
-* 02/14/2017 DLV S-30381 - CHANGED CUSTOM ROUTINE TO USE &PTYPE INSTEAD OF &PEERTYPE
-**********************************************************************
-* GETPGRP.FEX
-* Retrieve Peer Group selected
-**********************************************************************
-INCLUDE SETECHO
-*Retain the original rollup code (base rollup)
-*
-SET &&TOTPEERS = 0;
-*
-DEFAULT &&FROMER5='N';

-*
-IF &&FROMER5 EQ 'Y' GOTO :ER5PGRP; 
-*
-DEFAULT &PEERTYPE='AIR';
-*
TABLE FILE BRPTFLDS
-IF &PEERTYPE EQ 'CAR' GOTO CPEER;
-IF &PEERTYPE EQ 'HTL' GOTO HPEER;
-IF &PEERTYPE EQ 'LIM' GOTO LPEER;
PRINT QREVIEW2.PEERMBR
WHERE QREVIEW2.PEERMBR NE ' '
-GOTO CONT_PEER;
 
-CPEER
PRINT QREVIEW2.CPEERMBR
WHERE QREVIEW2.CPEERMBR NE ' '
-GOTO CONT_PEER;
 
-HPEER
PRINT QREVIEW2.HPEERMBR
WHERE QREVIEW2.HPEERMBR NE ' '
-GOTO CONT_PEER;


-LPEER
PRINT QREVIEW2.LPEERMBR
WHERE QREVIEW2.LPEERMBR NE ' '
-GOTO CONT_PEER;

 
-CONT_PEER;
WHERE INST_KEY EQ &&IKEY
ON TABLE SAVE AS PEERMEM2
END
-RUN
-*
-GOTO :ER5PGRP_CONT;
-*
-*************
-:ER5PGRP 
-*************
-DEFAULT &PEERTYPE='A';
-DEFAULT &PEERG = ' ';
-DEFAULT &ICODE = ' ';
-DEFAULT &REG = ' ';
-*
JOIN CLEAR *
-*
-IF &PEERTYPE EQ 'C' GOTO CPEERER5;
-IF &PEERTYPE EQ 'H' GOTO HPEERER5;
-IF &PEERTYPE EQ 'L' GOTO LPEERER5;


JOIN CLEAR *
JOIN RPT_SEQ IN BRPT_FLDS_QREVIEW TO ALL RPT_SEQ IN BRPT_FLDS_QREVIEW2 

TABLE FILE BRPT_FLDS_QREVIEW
PRINT PEER_AIR 
WHERE BRPT_FLDS_QREVIEW.INST_KEY EQ BRPT_FLDS_QREVIEW2.INST_KEY
WHERE INST_KEY EQ &&IKEY
ON TABLE HOLD AS HLDP FORMAT ALPHA
END
-RUN

-READ HLDP  &PTYPE.1.
-CLOSE HLDP

-GOTO :ER5_TYPE;

-CPEERER5;

JOIN CLEAR *
JOIN RPT_SEQ IN BRPT_FLDS_QREVIEW TO ALL RPT_SEQ IN BRPT_FLDS_QREVIEW2 

TABLE FILE BRPT_FLDS_QREVIEW
PRINT PEER_CAR 
WHERE BRPT_FLDS_QREVIEW.INST_KEY EQ BRPT_FLDS_QREVIEW2.INST_KEY
WHERE INST_KEY EQ &&IKEY
ON TABLE HOLD AS HLDP FORMAT ALPHA
END
-RUN

-READ HLDP  &PTYPE.1.
-CLOSE HLDP
-GOTO :ER5_TYPE;

-HPEERER5;

JOIN CLEAR *
JOIN RPT_SEQ IN BRPT_FLDS_QREVIEW TO ALL RPT_SEQ IN BRPT_FLDS_QREVIEW2 

TABLE FILE BRPT_FLDS_QREVIEW
PRINT PEER_HOTEL
WHERE BRPT_FLDS_QREVIEW.INST_KEY EQ BRPT_FLDS_QREVIEW2.INST_KEY
WHERE INST_KEY EQ &&IKEY
ON TABLE HOLD AS HLDP FORMAT ALPHA
END
-RUN

-READ HLDP  &PTYPE.1.
-CLOSE HLDP
-GOTO :ER5_TYPE;




-LPEERER5;

JOIN CLEAR *
JOIN RPT_SEQ IN BRPT_FLDS_QREVIEW TO ALL RPT_SEQ IN BRPT_FLDS_QREVIEW2 

TABLE FILE BRPT_FLDS_QREVIEW
PRINT PEER_LIMO 
WHERE BRPT_FLDS_QREVIEW.INST_KEY EQ BRPT_FLDS_QREVIEW2.INST_KEY
WHERE INST_KEY EQ &&IKEY
ON TABLE HOLD AS HLDP FORMAT ALPHA
END
-RUN

-READ HLDP  &PTYPE.1.
-CLOSE HLDP
 

-:ER5_TYPE;

-SET &&PEERTYPE = '&PTYPE.EVAL';

-IF '&PTYPE.EVAL' EQ 'C' THEN GOTO CUSTOM;
-IF '&PTYPE.EVAL' EQ 'V' THEN GOTO VOLUME;
-IF '&PTYPE.EVAL' EQ 'I' THEN GOTO INDUSTRY;
-IF '&PTYPE.EVAL' EQ 'R' THEN GOTO REGION;

-VOLUME;

TABLE FILE ROLLUP_SQL
PRINT PEER_GROUP
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE HOLD AS HLDP2 FORMAT ALPHA
END
-RUN

-READ HLDP2 &PEERG.15.
-CLOSE HLDP2

TABLE FILE ROLLUP_SQL
PRINT ROLLUP_CODE
BY ROLLUP_CODE NOPRINT
WHERE PEER_GROUP EQ '&PEERG.EVAL'
WHERE ROLLUP_CODE NE '&&ROLLUP.EVAL' OR 'TOTAL-R' OR 'ABCD2-R' OR 'ABCD3-R' OR 'GLOBO-R'
WHERE COMP GT ''
WHERE UPD_ENABLE GT ''
ON TABLE SAVE AS PEERMEM2
END
-RUN

-SET &LINES = &RECORDS;

-GOTO :ER5PGRP_CONT;

-INDUSTRY;


DEFINE FILE ROLLUP_SQL
ICODEX/D4 = ICODE;
END
TABLE FILE ROLLUP_SQL
PRINT ICODEX
WHERE ROLLUP_CODE EQ 'ABCD-R'
ON TABLE HOLD
END

DEFINE FILE HOLD
IND/A6 = FTOA(ICODEX, '(D4)', IND);
END
TABLE FILE HOLD
PRINT IND 
ON TABLE HOLD AS HLDIND
END
-RUN

-READ HLDIND &ICODE.6.
-CLOSE HLDIND
-TYPE &ICODE



TABLE FILE ROLLUP_SQL
PRINT ROLLUP_CODE
BY ROLLUP_CODE NOPRINT
WHERE ICODE EQ &ICODE
WHERE ROLLUP_CODE NE '&&ROLLUP.EVAL' OR 'TOTAL-R' OR 'ABCD2-R' OR 'ABCD3-R' OR 'GLOBO-R'
WHERE COMP GT ''
WHERE UPD_ENABLE GT ''
ON TABLE SAVE AS PEERMEM2
END
-RUN

-SET &LINES = &RECORDS;


-GOTO :ER5PGRP_CONT;

-REGION;
 
JOIN CLEAR *

JOIN ROLL_STATE IN ROLLUP_SQL TO STATE_CODE IN STATE AS J1
TABLE FILE ROLLUP_SQL
PRINT REGION
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE HOLD AS HLDR FORMAT ALPHA
END
-RUN

-READ HLDR &REG.2.
-CLOSE HLDR

JOIN ROLL_STATE IN ROLLUP_SQL TO STATE_CODE IN STATE AS J1

TABLE FILE ROLLUP_SQL
PRINT ROLLUP_CODE
BY ROLLUP_CODE NOPRINT
WHERE REGION EQ '&REG.EVAL'
WHERE ROLLUP_CODE NE '&&ROLLUP.EVAL' OR 'TOTAL-R' OR 'ABCD2-R' OR 'ABCD3-R' OR 'GLOBO-R'
WHERE COMP GT ''
WHERE UPD_ENABLE GT ''
ON TABLE SAVE AS PEERMEM2
END
-RUN

-SET &LINES = &RECORDS;


JOIN CLEAR *

-GOTO :ER5PGRP_CONT;

-CUSTOM;
TABLE FILE BENCHMARK_CUSTOM_PEERS 
 PRINT PEER_ROLLUP 
WHERE ROLLUP    EQ '&&ROLLUP';
WHERE PEER_TYPE EQ '&PTYPE';
ON TABLE SAVE AS PEERMEM2
END
-RUN
-*
-*************
-:ER5PGRP_CONT
-*************
-SET &&TOTPEERS = &LINES;
-* -IF &LINES EQ 0 THEN GOTO NOPEERGROUP;
-IF &LINES LE 0 THEN GOTO NOPEERGROUP;
-SET &CNT = 1;
 
-REPEAT TOEND2 &LINES TIMES
-READ PEERMEM2 NOCLOSE &PEERM.8.
-SET &&PEERMBR.&CNT = &PEERM;
-SET &CNT = &CNT + 1;
-TOEND2
-CLOSE PEERMEM2
-NOPEERGROUP
