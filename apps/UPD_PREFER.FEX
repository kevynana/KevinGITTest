-INCLUDE SETECHO

SET ASNAMES = ON 

-GOTO DEB2;

JOIN AIR_KEY IN A_PREFER TO AIR_KEY IN S_PREFER AS J1
TABLE FILE A_PREFER
PRINT LEVEL1 LEVEL2 LEVEL3 LEVEL4 ICODEX AROLL_LEV1 AROLL_LEV2 AROLL_LEV3 AROLL_LEV4
BY TKT_DATE
BY TKT_NUM
 
END
-RUN
-QUIT









-DEB









DEFINE FILE A_PREFER
LVL1/A15 = 
IF LEVEL2 EQ '110' OR '120' OR '130' OR '140' OR '150' OR '200' THEN 'CORPORATE' ELSE
IF LEVEL2 EQ '001' OR '005' OR '007' OR '020' OR '022' OR '030' OR '032' OR '037' OR '040' OR '041' OR '043' OR '045' OR
                           '048' OR '049' OR '051' OR '056' THEN 'EASTERN' ELSE
IF LEVEL2 EQ '014' OR '018' OR '024' OR '026' OR '028' OR '042' OR '046' OR '047' OR '050' OR '053' THEN 'WESTERN' ELSE
IF LEVEL2 EQ 'FINANCIAL' THEN 'FINANCIAL' ELSE 
IF LEVEL2 EQ 'DEFLOC' OR 'DEFREG' THEN 'DEFREG' ELSE 'DEFREG';
TEST/A15 = IF LVL1 EQ 'DEFREG' THEN 'DEFLOC' ELSE
           IF LEVEL2 EQ 'CORP' THEN 'DEFLOC' ELSE LEVEL2;
TEST2/A15 = IF LEVEL2 EQ ' ' THEN 'DEFLOC' ELSE IF LVL1 EQ 'DEFREG' THEN 'DEFLOC' ELSE LEVEL2;          
END
TABLE FILE A_PREFER
PRINT  LVL1 TEST  TEST2
BY AIR_KEY
IF TKT_DATE LE '2011/05/01'
ON TABLE HOLD
END
-RUN



TABLE FILE HOLD
PRINT TEST AS 'LEVEL1' 
BY AIR_KEY
ON TABLE HOLD AS AIRFIX
END
-RUN

 
MODIFY FILE A_PREFER
FIXFORM FROM AIRFIX
MATCH AIR_KEY
ON MATCH UPDATE LEVEL1
ON NOMATCH REJECT
DATA ON AIRFIX 
END
-RUN

 
TABLE FILE HOLD
PRINT LVL1 AS 'AROLL_LEV3' TEST AS 'AROLL_LEV4'
BY AIR_KEY
ON TABLE HOLD AS SHOLD
END
-RUN

TABLE FILE S_PREFER
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
BY AIR_KEY  NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
WHERE TRN_DATE LE '2011/05/01'
ON TABLE HOLD AS SEGHOLD
END
-RUN

MATCH FILE SEGHOLD
PRINT EMBARK ROUTE TKT_SORT SEG_NBR
BY AIR_KEY
ON TABLE HOLD
RUN
FILE SHOLD
SUM AROLL_LEV3 AROLL_LEV4
BY AIR_KEY
AFTER MATCH HOLD AS SHOLD1 OLD-OR-NEW
END
-RUN

TABLE FILE SHOLD1
PRINT EMBARK ROUTE TKT_SORT SEG_NBR AROLL_LEV3 AROLL_LEV4
BY AIR_KEY
ON TABLE HOLD AS SHOLD2
END
-RUN

MODIFY FILE S_PREFER
FIXFORM FROM SHOLD2
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE AROLL_LEV3
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON SHOLD2
END
-RUN


TABLE FILE D_PREFER
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
BY AIR_KEY  NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
WHERE TRN_DATE LE '2011/05/01'
ON TABLE HOLD AS DSTHOLD
END
-RUN

MATCH FILE DSTHOLD
PRINT EMBARK ROUTE TKT_SORT SEG_NBR
BY AIR_KEY 
ON TABLE HOLD
RUN
FILE SHOLD
SUM AROLL_LEV3 AROLL_LEV4
BY AIR_KEY
AFTER MATCH HOLD AS DHOLD1 OLD-OR-NEW
END
-RUN

MODIFY FILE D_PREFER
FIXFORM FROM DHOLD1
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE AROLL_LEV3
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON DHOLD1
END
-RUN

TABLE FILE M_PREFER
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
BY AIR_KEY  NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
WHERE TRN_DATE LE '2011/05/01'
ON TABLE HOLD AS MKTHOLD
END
-RUN

MATCH FILE MKTHOLD
PRINT EMBARK ROUTE TKT_SORT SEG_NBR
BY AIR_KEY 
ON TABLE HOLD
RUN
FILE SHOLD
SUM AROLL_LEV3 AROLL_LEV4
BY AIR_KEY
AFTER MATCH HOLD AS MHOLD1 OLD-OR-NEW
END
-RUN

MODIFY FILE M_PREFER
FIXFORM FROM MHOLD1
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE AROLL_LEV3
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON MHOLD1
END
-RUN

DEFINE FILE C_PREFER
LVL1/A15 = 
IF LEVEL2 EQ '110' OR '120' OR '130' OR '140' OR '150' OR '200' OR 'CORP' THEN 'CORPORATE' ELSE
IF LEVEL2 EQ '001' OR '005' OR '007' OR '020' OR '022' OR '030' OR '032' OR '037' OR '040' OR '041' OR '043' OR '045' OR
                           '048' OR '049' OR '051' OR '056' THEN 'EASTERN' ELSE
IF LEVEL2 EQ '014' OR '018' OR '024' OR '026' OR '028' OR '042' OR '046' OR '047' OR '050' OR '053' THEN 'WESTERN' ELSE
IF LEVEL2 EQ 'FINANCIAL' THEN 'FINANCIAL' ELSE 
IF LEVEL2 EQ 'DEFLOC' OR 'DEFREG' THEN 'DEFREG' ELSE 'DEFREG';
TEST/A15 = IF LVL1 EQ 'DEFREG' THEN 'DEFLOC' ELSE
           IF LEVEL2 EQ 'CORP' THEN 'CORPORATE' ELSE LEVEL2;
END
TABLE FILE C_PREFER
PRINT  LVL1 TEST
BY CAR_KEY
IF INVOICE_DATE LE '2011/05/01'
ON TABLE HOLD
END
-RUN

TABLE FILE HOLD
PRINT TEST AS 'LEVEL1' LVL1 AS 'AROLL_LEV3' TEST AS 'AROLL_LEV4'
BY CAR_KEY
ON TABLE HOLD AS CHOLD
END
-RUN

MODIFY FILE C_PREFER
FIXFORM FROM CHOLD
MATCH CAR_KEY
ON MATCH UPDATE LEVEL1
ON MATCH UPDATE AROLL_LEV3
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON CHOLD
END
-RUN


DEFINE FILE H_PREFER
LVL1/A15 = 
IF LEVEL2 EQ '110' OR '120' OR '130' OR '140' OR '150' OR '200' OR 'CORP' THEN 'CORPORATE' ELSE
IF LEVEL2 EQ '001' OR '005' OR '007' OR '020' OR '022' OR '030' OR '032' OR '037' OR '040' OR '041' OR '043' OR '045' OR
                           '048' OR '049' OR '051' OR '056' THEN 'EASTERN' ELSE
IF LEVEL2 EQ '014' OR '018' OR '024' OR '026' OR '028' OR '042' OR '046' OR '047' OR '050' OR '053' THEN 'WESTERN' ELSE
IF LEVEL2 EQ 'FINANCIAL' THEN 'FINANCIAL' ELSE 
IF LEVEL2 EQ 'DEFLOC' OR 'DEFREG' THEN 'DEFREG' ELSE 'DEFREG';
TEST/A15 = IF LVL1 EQ 'DEFREG' THEN 'DEFLOC' ELSE
           IF LEVEL2 EQ 'CORP' THEN 'CORPORATE' ELSE LEVEL2;
END
TABLE FILE H_PREFER
PRINT  LVL1 TEST
BY HTL_KEY
IF INVOICE_DATE LE '2011/05/01'
ON TABLE HOLD
END
-RUN

TABLE FILE HOLD
PRINT TEST AS 'LEVEL1' LVL1 AS 'AROLL_LEV3' TEST AS 'AROLL_LEV4'
BY HTL_KEY
ON TABLE HOLD AS HHOLD
END
-RUN

MODIFY FILE H_PREFER
FIXFORM FROM HHOLD
MATCH HTL_KEY
ON MATCH UPDATE LEVEL1
ON MATCH UPDATE AROLL_LEV3
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON HHOLD
END
-RUN



DEFINE FILE A_PREFER
LVL1/A15 = '190';
END
TABLE FILE A_PREFER
PRINT AIR_KEY LVL1 AS 'LEVEL1'
BY AIR_KEY NOPRINT
IF LEVEL2 EQ 190
ON TABLE HOLD AS AHOLD
END
-RUN

MODIFY FILE A_PREFER
FIXFORM FROM AHOLD
MATCH AIR_KEY
ON MATCH UPDATE LEVEL1
ON NOMATCH REJECT
DATA ON AHOLD
END
-RUN



JOIN AIR_KEY IN S_PREFER TO AIR_KEY IN A_PREFER 
TABLE FILE S_PREFER
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR LEVEL2
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
WHERE LEVEL2 EQ '190'
ON TABLE HOLD AS SEGHOLD
END
-RUN

DEFINE FILE SEGHOLD
AROLL_LEV3/A15 = 'CORPORATE';
AROLL_LEV4/A15 = '190';
END
TABLE FILE SEGHOLD
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR AROLL_LEV3 AROLL_LEV4
BY AIR_KEY NOPRINT
ON TABLE HOLD AS SHOLD
END
-RUN

MODIFY FILE S_PREFER
FIXFORM FROM SHOLD
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE AROLL_LEV3
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON SHOLD
END
-RUN

JOIN AIR_KEY IN D_PREFER TO AIR_KEY IN A_PREFER 
TABLE FILE D_PREFER
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR  
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
WHERE LEVEL2 EQ '190'
ON TABLE HOLD AS DSTHOLD
END
-RUN

DEFINE FILE DSTHOLD
AROLL_LEV3/A15 = 'CORPORATE';
AROLL_LEV4/A15 = '190';
END
TABLE FILE DSTHOLD
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR AROLL_LEV3 AROLL_LEV4
BY AIR_KEY NOPRINT
ON TABLE HOLD AS DHOLD
END
-RUN

MODIFY FILE D_PREFER
FIXFORM FROM DHOLD
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE AROLL_LEV3
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON DHOLD
END
-RUN 

JOIN AIR_KEY IN M_PREFER TO AIR_KEY IN A_PREFER 
TABLE FILE M_PREFER
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR  
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
WHERE LEVEL2 EQ '190'
ON TABLE HOLD AS MKTHOLD
END
-RUN

DEFINE FILE MKTHOLD
AROLL_LEV3/A15 = 'CORPORATE';
AROLL_LEV4/A15 = '190';
END
TABLE FILE MKTHOLD
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR AROLL_LEV3 AROLL_LEV4
BY AIR_KEY NOPRINT
ON TABLE HOLD AS MHOLD
END
-RUN

MODIFY FILE M_PREFER
FIXFORM FROM MHOLD
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH UPDATE AROLL_LEV3
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON MHOLD
END
-RUN 
-DEB2
DEFINE FILE C_PREFER
LVL1/A15 = '190';
AROLL_LV3/A15 ='CORPORATE';
AROLL_LV4/A15 = '190';
END
TABLE FILE C_PREFER
PRINT CAR_KEY LVL1 AS 'LEVEL1' AROLL_LV3 AS 'AROLL_LEV3' AROLL_LV4 AS 'AROLL_LEV4'
BY CAR_KEY NOPRINT
IF LEVEL2 EQ '190'
ON TABLE HOLD AS CHOLD
END
-RUN

MODIFY FILE C_PREFER
FIXFORM FROM CHOLD
MATCH CAR_KEY
ON MATCH UPDATE LEVEL1
ON MATCH UPDATE AROLL_LEV3
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON CHOLD
END
-RUN

DEFINE FILE H_PREFER
LVL1/A15 = '190';
AROLL_LV3/A15 ='CORPORATE';
AROLL_LV4/A15 = '190';
END
TABLE FILE H_PREFER
PRINT HTL_KEY LVL1 AS 'LEVEL1' AROLL_LV3 AS 'AROLL_LEV3' AROLL_LV4 AS 'AROLL_LEV4'
BY HTL_KEY NOPRINT
IF LEVEL2 EQ '190'
ON TABLE HOLD AS HHOLD 
END
-RUN

MODIFY FILE H_PREFER
FIXFORM FROM HHOLD
MATCH HTL_KEY
ON MATCH UPDATE LEVEL1
ON MATCH UPDATE AROLL_LEV3
ON MATCH UPDATE AROLL_LEV4
ON NOMATCH REJECT
DATA ON HHOLD
END
-RUN
