-* 8/28/14 - ADDED DVEXCHF TO STEP3 ROUTINE
-*12/4/14 - DEB - CHANGED ROUTINE FOR STEP3 TO CORRECT ISSUE WITH OLD_ITIN 
-*                BEING THE SAME AS C_ITIN IN ALL CASES
-* 3/20/15 -DEB -  S-07953 - ADDED ITEXCHG TO STEP3 ROUTINE
-* 04/17/2015 - DEB - S-08364 - ADDED CMEXCHG TO STEP3 ROUTINE


USE CLEAR *
-RUN

-TYPE "BEFORE ROLLUP"


TABLE FILE ROLLUP
BY ROLLUP NOPRINT
PRINT ROLLUP QTR_ENABLE
IF ROLLUP EQ '&&ROLLUP.EVAL'
ON TABLE SAVE AS QTRCHK
END
-RUN
-READ QTRCHK &&XROLL.A8. &&TYPE.A1.
-RUN

-TYPE "AFTER ROLLUP"

-SET &DATAPATH='&&DATASRV.EVAL' || '\TNT\TTRACKER\DATA\';
-IF &&TYPE EQ ' ' GOTO NORMAL;
-IF &&TYPE EQ 'X' GOTO QUARTER;
-RUN



-QUARTER

-SET &&COMP1A = 'A1' ||&&COMPNY || '.FOC';
-SET &&COMP2A = 'A2' ||&&COMPNY || '.FOC';
-SET &&COMP3A = 'A3' ||&&COMPNY || '.FOC';
-SET &&COMP4A = 'A4' ||&&COMPNY || '.FOC';
-SET &&COMP5A = 'A5' ||&&COMPNY || '.FOC';
-SET &&COMP6A = 'A6' ||&&COMPNY || '.FOC';
-SET &&COMP7A = 'A7' ||&&COMPNY || '.FOC';
-SET &&COMP8A = 'A8' ||&&COMPNY || '.FOC';
-SET &&COMP9A = 'A9' ||&&COMPNY || '.FOC';
-SET &&COMP0A = 'A0' ||&&COMPNY || '.FOC';
-SET &&COMPYA = 'AY' ||&&COMPNY || '.FOC';
-SET &&COMPZA = 'AZ' ||&&COMPNY || '.FOC';
-* SEGMENTS
-SET &&COMP1S = 'S1' ||&&COMPNY || '.FOC';
-SET &&COMP2S = 'S2' ||&&COMPNY || '.FOC';
-SET &&COMP3S = 'S3' ||&&COMPNY || '.FOC';
-SET &&COMP4S = 'S4' ||&&COMPNY || '.FOC';
-SET &&COMP5S = 'S5' ||&&COMPNY || '.FOC';
-SET &&COMP6S = 'S6' ||&&COMPNY || '.FOC';
-SET &&COMP7S = 'S7' ||&&COMPNY || '.FOC';
-SET &&COMP8S = 'S8' ||&&COMPNY || '.FOC';
-SET &&COMP9S = 'S9' ||&&COMPNY || '.FOC';
-SET &&COMP0S = 'S0' ||&&COMPNY || '.FOC';
-SET &&COMPYS = 'SY' ||&&COMPNY || '.FOC';
-SET &&COMPZS = 'SZ' ||&&COMPNY || '.FOC';
-* TKT_MAIN
-SET &&COMP1T = 'T1' ||&&COMPNY || '.FOC';
-SET &&COMP2T = 'T2' ||&&COMPNY || '.FOC';
-SET &&COMP3T = 'T3' ||&&COMPNY || '.FOC';
-SET &&COMP4T = 'T4' ||&&COMPNY || '.FOC';
-SET &&COMP5T = 'T5' ||&&COMPNY || '.FOC';
-SET &&COMP6T = 'T6' ||&&COMPNY || '.FOC';
-SET &&COMP7T = 'T7' ||&&COMPNY || '.FOC';
-SET &&COMP8T = 'T8' ||&&COMPNY || '.FOC';
-SET &&COMP9T = 'T9' ||&&COMPNY || '.FOC';
-SET &&COMP0T = 'T0' ||&&COMPNY || '.FOC';
-SET &&COMPYT = 'TY' ||&&COMPNY || '.FOC';
-SET &&COMPZT = 'TZ' ||&&COMPNY || '.FOC';



-SET &&COMP1 = 'A1' ||&&COMPNY;
-SET &&COMP2 = 'A2' ||&&COMPNY;
-SET &&COMP3 = 'A3' ||&&COMPNY;
-SET &&COMP4 = 'A4' ||&&COMPNY;
-SET &&COMP5 = 'A5' ||&&COMPNY;
-SET &&COMP6 = 'A6' ||&&COMPNY;
-SET &&COMP7 = 'A7' ||&&COMPNY;
-SET &&COMP8 = 'A8' ||&&COMPNY;
-SET &&COMP9 = 'A9' ||&&COMPNY;
-SET &&COMP0 = 'A0' ||&&COMPNY;
-SET &&COMPY = 'AY' ||&&COMPNY;
-SET &&COMPZ = 'AZ' ||&&COMPNY;
-* SEGMENTS
-SET &&COMPS1 = 'S1' ||&&COMPNY;
-SET &&COMPS2 = 'S2' ||&&COMPNY;
-SET &&COMPS3 = 'S3' ||&&COMPNY;
-SET &&COMPS4 = 'S4' ||&&COMPNY;
-SET &&COMPS5 = 'S5' ||&&COMPNY;
-SET &&COMPS6 = 'S6' ||&&COMPNY;
-SET &&COMPS7 = 'S7' ||&&COMPNY;
-SET &&COMPS8 = 'S8' ||&&COMPNY;
-SET &&COMPS9 = 'S9' ||&&COMPNY;
-SET &&COMPS0 = 'S0' ||&&COMPNY;
-SET &&COMPSY = 'SY' ||&&COMPNY;
-SET &&COMPSZ = 'SZ' ||&&COMPNY;
-* TKT_MAIN
-SET &&COMPT1 = 'T1' ||&&COMPNY;
-SET &&COMPT2 = 'T2' ||&&COMPNY;
-SET &&COMPT3 = 'T3' ||&&COMPNY;
-SET &&COMPT4 = 'T4' ||&&COMPNY;
-SET &&COMPT5 = 'T5' ||&&COMPNY;
-SET &&COMPT6 = 'T6' ||&&COMPNY;
-SET &&COMPT7 = 'T7' ||&&COMPNY;
-SET &&COMPT8 = 'T8' ||&&COMPNY;
-SET &&COMPT9 = 'T9' ||&&COMPNY;
-SET &&COMPT0 = 'T0' ||&&COMPNY;
-SET &&COMPTY = 'TY' ||&&COMPNY;
-SET &&COMPTZ = 'TZ' ||&&COMPNY;


-*
-TYPE "AFTER -SET"
-RUN

-SET &FILE1A = '&DATAPATH.EVAL' || '&&COMP1A.EVAL AS &&COMP1.EVAL';
-SET &FILE2A = '&DATAPATH.EVAL' || '&&COMP2A.EVAL AS &&COMP1.EVAL';
-SET &FILE3A = '&DATAPATH.EVAL' || '&&COMP3A.EVAL AS &&COMP1.EVAL';
-SET &FILE4A = '&DATAPATH.EVAL' || '&&COMP4A.EVAL AS &&COMP1.EVAL';
-SET &FILE5A = '&DATAPATH.EVAL' || '&&COMP5A.EVAL AS &&COMP1.EVAL';
-SET &FILE6A = '&DATAPATH.EVAL' || '&&COMP6A.EVAL AS &&COMP1.EVAL';
-SET &FILE7A = '&DATAPATH.EVAL' || '&&COMP7A.EVAL AS &&COMP1.EVAL';
-SET &FILE8A = '&DATAPATH.EVAL' || '&&COMP8A.EVAL AS &&COMP1.EVAL';
-SET &FILE9A = '&DATAPATH.EVAL' || '&&COMP9A.EVAL AS &&COMP1.EVAL';
-SET &FILE0A = '&DATAPATH.EVAL' || '&&COMP0A.EVAL AS &&COMP1.EVAL';
-SET &FILEYA = '&DATAPATH.EVAL' || '&&COMPYA.EVAL AS &&COMP1.EVAL';
-SET &FILEZA = '&DATAPATH.EVAL' || '&&COMPZA.EVAL AS &&COMP1.EVAL';

-SET &FILE1S = '&DATAPATH.EVAL' || '&&COMP1S.EVAL AS &&COMPS1.EVAL';
-SET &FILE2S = '&DATAPATH.EVAL' || '&&COMP2S.EVAL AS &&COMPS1.EVAL';
-SET &FILE3S = '&DATAPATH.EVAL' || '&&COMP3S.EVAL AS &&COMPS1.EVAL';
-SET &FILE4S = '&DATAPATH.EVAL' || '&&COMP4S.EVAL AS &&COMPS1.EVAL';
-SET &FILE5S = '&DATAPATH.EVAL' || '&&COMP5S.EVAL AS &&COMPS1.EVAL';
-SET &FILE6S = '&DATAPATH.EVAL' || '&&COMP6S.EVAL AS &&COMPS1.EVAL';
-SET &FILE7S = '&DATAPATH.EVAL' || '&&COMP7S.EVAL AS &&COMPS1.EVAL';
-SET &FILE8S = '&DATAPATH.EVAL' || '&&COMP8S.EVAL AS &&COMPS1.EVAL';
-SET &FILE9S = '&DATAPATH.EVAL' || '&&COMP9S.EVAL AS &&COMPS1.EVAL';
-SET &FILE0S = '&DATAPATH.EVAL' || '&&COMP0S.EVAL AS &&COMPS1.EVAL';
-SET &FILEYS = '&DATAPATH.EVAL' || '&&COMPYS.EVAL AS &&COMPS1.EVAL';
-SET &FILEZS = '&DATAPATH.EVAL' || '&&COMPZS.EVAL AS &&COMPS1.EVAL';

-SET &FILE1T = '&DATAPATH.EVAL' || '&&COMP1T.EVAL AS &&COMPT1.EVAL';
-SET &FILE2T = '&DATAPATH.EVAL' || '&&COMP2T.EVAL AS &&COMPT1.EVAL';
-SET &FILE3T = '&DATAPATH.EVAL' || '&&COMP3T.EVAL AS &&COMPT1.EVAL';
-SET &FILE4T = '&DATAPATH.EVAL' || '&&COMP4T.EVAL AS &&COMPT1.EVAL';
-SET &FILE5T = '&DATAPATH.EVAL' || '&&COMP5T.EVAL AS &&COMPT1.EVAL';
-SET &FILE6T = '&DATAPATH.EVAL' || '&&COMP6T.EVAL AS &&COMPT1.EVAL';
-SET &FILE7T = '&DATAPATH.EVAL' || '&&COMP7T.EVAL AS &&COMPT1.EVAL';
-SET &FILE8T = '&DATAPATH.EVAL' || '&&COMP8T.EVAL AS &&COMPT1.EVAL';
-SET &FILE9T = '&DATAPATH.EVAL' || '&&COMP9T.EVAL AS &&COMPT1.EVAL';
-SET &FILE0T = '&DATAPATH.EVAL' || '&&COMP0T.EVAL AS &&COMPT1.EVAL';
-SET &FILEYT = '&DATAPATH.EVAL' || '&&COMPYT.EVAL AS &&COMPT1.EVAL';
-SET &FILEZT = '&DATAPATH.EVAL' || '&&COMPZT.EVAL AS &&COMPT1.EVAL';

USE
&FILE1A
&FILE2A
&FILE3A
&FILE4A
&FILE5A
&FILE6A
&FILE7A
&FILE8A
&FILE9A
&FILE0A
&FILEYA
&FILEZA
-* SEGMENT
&FILE1S
&FILE2S
&FILE3S
&FILE4S
&FILE5S
&FILE6S
&FILE7S
&FILE8S
&FILE9S
&FILE0S
&FILEYS
&FILEZS
-* TKT_MAIN
&FILE1T
&FILE2T
&FILE3T
&FILE4T
&FILE5T
&FILE6T
&FILE7T
&FILE8T
&FILE9T
&FILE0T
&FILEYT
&FILEZT

END
-RUN


-GOTO NEXT;

-NORMAL

-SET &&COMP1A = 'A_' ||&&COMPNY || '.FOC';
-* SEGMENTS
-SET &&COMP1S = 'S_' ||&&COMPNY || '.FOC';
-* TKT_MAI
-SET &&COMP1T = 'T_' ||&&COMPNY || '.FOC';

-SET &&COMP1 = 'A_' ||&&COMPNY;
-SET &&COMPS1 = 'S_' ||&&COMPNY;
-SET &&COMPT1 = 'T_' ||&&COMPNY;

-RUN


-SET &FILE1A = '&DATAPATH.EVAL' || '&&COMP1A.EVAL AS &&COMP1.EVAL';
-SET &FILE1S = '&DATAPATH.EVAL' || '&&COMP1S.EVAL AS &&COMPS1.EVAL';
-SET &FILE1T = '&DATAPATH.EVAL' || '&&COMP1T.EVAL AS &&COMPT1.EVAL';

USE 
&FILE1A
-* SEGMENT
&FILE1S
-* TKT_MAIN 
&FILE1T
END
-RUN


-NEXT



-IF &&SETF EQ 'ABAEXDT' THEN GOTO STEP2;

-IF &&SETF EQ 'DVEXCHG' OR 'DVRSETF' OR 'DVEXCHF' OR 'ITEXCHG' OR 'CMEXCHG' THEN GOTO STEP3;

DEFINE FILE &&COMPS1
XTRAN_DT/MDYY        = TRN_DATE;
END
TABLE FILE &&COMPS1
PRINT DPT_DATE XTRAN_DT AS 'XTRAN_DT1'
BY AIR_KEY
WHERE SEG_NBR EQ '01'
WHERE SEG_COUNT GE 0
ON TABLE HOLD AS SEGHLD  
END
-RUN

TABLE FILE &&COMP1
SUM AIR_KEY AS 'AIR_KEYD' 
BY DOC_NUMBER AS 'DOC_NUM'
WHERE DOC_NUMBER NE '0000000000'
ON TABLE HOLD AS AIRHLD 
END
-RUN

TABLE FILE &&COMP1
SUM AIR_KEY AS 'AIR_KEYT' 
BY TKT_NUM AS 'DOC_NUM'
ON TABLE HOLD AS AIRHLD1
END
-RUN

MATCH FILE AIRHLD
PRINT AIR_KEYD 
BY DOC_NUM
ON TABLE HOLD
RUN
FILE AIRHLD1
PRINT AIR_KEYT 
BY DOC_NUM
AFTER MATCH HOLD AS AIRHLD2 OLD-AND-NEW
END
-RUN

TABLE FILE AIRHLD2
PRINT AIR_KEYT AS 'AIR_KEY' AIR_KEYD 
BY DOC_NUM
ON TABLE HOLD AS AIRHLD3
END
-RUN

MATCH FILE SEGHLD
PRINT DPT_DATE XTRAN_DT1
BY AIR_KEY
ON TABLE HOLD
RUN 
FILE AIRHLD3
PRINT DOC_NUM AIR_KEYD 
BY AIR_KEY
AFTER MATCH HOLD AS ASHLD OLD-AND-NEW
END
-RUN

-GOTO XXIT;

-STEP2

TABLE FILE &&COMPS1
PRINT DPT_DATE DPT_TIME AS 'DTIME'
BY AIR_KEY
WHERE SEG_NBR EQ '01'
WHERE SEG_COUNT GE 0
ON TABLE HOLD AS SEGHLD 
END
-RUN

TABLE FILE &&COMP1
SUM AIR_KEY AS 'AIR_KEYD'
BY DOC_NUMBER AS 'DOC_NUM'
WHERE DOC_NUMBER NE '0000000000'
ON TABLE HOLD AS AIRHLD 
END
-RUN

TABLE FILE &&COMP1
SUM AIR_KEY AS 'AIR_KEYT'
BY TKT_NUM AS 'DOC_NUM'
ON TABLE HOLD AS AIRHLD1
END
-RUN

MATCH FILE AIRHLD
PRINT AIR_KEYD
BY DOC_NUM
ON TABLE HOLD
RUN
FILE AIRHLD1
PRINT AIR_KEYT 
BY DOC_NUM
AFTER MATCH HOLD AS AIRHLD2 OLD-AND-NEW
END
-RUN

TABLE FILE AIRHLD2
PRINT AIR_KEYT AS 'AIR_KEY' AIR_KEYD
BY DOC_NUM
ON TABLE HOLD AS AIRHLD3
END
-RUN

MATCH FILE SEGHLD
PRINT DPT_DATE DTIME
BY AIR_KEY
ON TABLE HOLD
RUN 
FILE AIRHLD3
PRINT DOC_NUM AIR_KEYD
BY AIR_KEY
AFTER MATCH HOLD AS ASHLD OLD-AND-NEW
END
-RUN

-GOTO XXIT;

-STEP3

TABLE FILE &&COMP1
SUM  DOC_NUMBER
BY DOC_NUMBER AS 'TICKET1'
WHERE DOC_NUMBER NE '0000000000'
WHERE EXCHG_SALE NE ' '
BY DOC_NUMBER
ON TABLE HOLD AS AIRHLD 
END
-RUN


DEFINE FILE &&COMPT1
TICKET1/A10 = EDIT(AIR_KEY, '9999999999');
END
TABLE FILE &&COMPT1
PRINT C_ITIN AS 'OLD_ITIN' 
BY TICKET1 
ON TABLE HOLD AS AIRHLD2
END
-RUN

 

MATCH FILE AIRHLD
PRINT DOC_NUMBER
BY TICKET1
ON TABLE HOLD
RUN
FILE AIRHLD2
SUM OLD_ITIN  
BY TICKET1
AFTER MATCH HOLD AS ASHLD OLD
END
-RUN 

 




-XXIT
