-**********************************************************************************************
-* CONVERTPFFEE.FEX
-* 
-* RECREATE PF&COMP FILE - PROFESSIONAL FEE
-*
-*-SET &NPFMASTER = &FPATH | 'PROFEE2.MAS';
-*-SET &OPFMASTER = &FPATH | 'PR' | '&COMP.EVAL' || '.MAS';
-**********************************************************************************************
-SET &ECHO = ALL;
SET WARNING = OFF
SET TEMPERASE = OFF


REBUILD
REORG
DUMP
&PFMASTER
NO
-RUN

-DOS COPY &NPFMASTER &OPFMASTER 
CREATE FILE &PFMASTER DROP
-RUN

REBUILD
REORG
LOAD
&PFMASTER
YES
-RUN

-*Update historical data with ID Level and Hirarchy levels
TABLE FILE &PFMASTER
PRINT AIR_KEY
BY SEQNBR
WHERE AIR_KEY NE ' '
ON TABLE HOLD AS AIRPFEE FORMAT FOCUS INDEX AIR_KEY
END
-RUN
-IF &LINES EQ 0 THEN GOTO ChkCarFee;

-IF '&QTR.EVAL' EQ 'X' THEN GOTO AIRQTRDBS;

-ASINGLEDB
-SET &SFILE = &FPATH | 'S_' | '&COMP.EVAL' || '.FOC';
-SET &AFILE = &FPATH | 'A_' | '&COMP.EVAL' || '.FOC';

USE
	&SFILE AS SR_502
	&AFILE AS AIR_MAIN
END
-RUN

-GOTO AIRJOIN;

-AIRQTRDBS
-SET &S0FILE = &FPATH | 'S0' | '&COMP.EVAL' || '.FOC';
-SET &A0FILE = &FPATH | 'A0' | '&COMP.EVAL' || '.FOC';
-SET &S1FILE = &FPATH | 'S1' | '&COMP.EVAL' || '.FOC';
-SET &A1FILE = &FPATH | 'A1' | '&COMP.EVAL' || '.FOC';
-SET &S2FILE = &FPATH | 'S2' | '&COMP.EVAL' || '.FOC';
-SET &A2FILE = &FPATH | 'A2' | '&COMP.EVAL' || '.FOC';
-SET &S3FILE = &FPATH | 'S3' | '&COMP.EVAL' || '.FOC';
-SET &A3FILE = &FPATH | 'A3' | '&COMP.EVAL' || '.FOC';
-SET &S4FILE = &FPATH | 'S4' | '&COMP.EVAL' || '.FOC';
-SET &A4FILE = &FPATH | 'A4' | '&COMP.EVAL' || '.FOC';
-SET &S5FILE = &FPATH | 'S5' | '&COMP.EVAL' || '.FOC';
-SET &A5FILE = &FPATH | 'A5' | '&COMP.EVAL' || '.FOC';
-SET &S6FILE = &FPATH | 'S6' | '&COMP.EVAL' || '.FOC';
-SET &A6FILE = &FPATH | 'A6' | '&COMP.EVAL' || '.FOC';
-SET &S7FILE = &FPATH | 'S7' | '&COMP.EVAL' || '.FOC';
-SET &A7FILE = &FPATH | 'A7' | '&COMP.EVAL' || '.FOC';
-SET &S8FILE = &FPATH | 'S8' | '&COMP.EVAL' || '.FOC';
-SET &A8FILE = &FPATH | 'A8' | '&COMP.EVAL' || '.FOC';
-SET &S9FILE = &FPATH | 'S9' | '&COMP.EVAL' || '.FOC';
-SET &A9FILE = &FPATH | 'A9' | '&COMP.EVAL' || '.FOC';
-SET &SYFILE = &FPATH | 'SY' | '&COMP.EVAL' || '.FOC';
-SET &AYFILE = &FPATH | 'AY' | '&COMP.EVAL' || '.FOC';
-SET &SZFILE = &FPATH | 'SZ' | '&COMP.EVAL' || '.FOC';
-SET &AZFILE = &FPATH | 'AZ' | '&COMP.EVAL' || '.FOC';

USE
	&S0FILE AS SR_502
	&S1FILE AS SR_502
	&S2FILE AS SR_502
	&S3FILE AS SR_502
	&S4FILE AS SR_502
	&S5FILE AS SR_502
	&S6FILE AS SR_502
	&S7FILE AS SR_502
	&S8FILE AS SR_502
	&S9FILE AS SR_502
	&SYFILE AS SR_502
	&SZFILE AS SR_502

	&A0FILE AS AIR_MAIN
	&A1FILE AS AIR_MAIN
	&A2FILE AS AIR_MAIN
	&A3FILE AS AIR_MAIN
	&A4FILE AS AIR_MAIN
	&A5FILE AS AIR_MAIN
	&A6FILE AS AIR_MAIN
	&A7FILE AS AIR_MAIN
	&A8FILE AS AIR_MAIN
	&A9FILE AS AIR_MAIN
	&AYFILE AS AIR_MAIN
	&AZFILE AS AIR_MAIN
END
-RUN

-AIRJOIN

JOIN CLEAR *
-*JOIN AIR_KEY IN AIRPFEE TO AIR_KEY IN SR_502 AS J1
JOIN AIR_KEY IN SR_502 TO AIR_KEY IN AIRPFEE AS J1
END

TABLE FILE SR_502
-*PRINT LEVEL1 LEVEL2 LEVEL3 LEVEL4
-*AROLL_LEV1 AROLL_LEV2 AROLL_LEV3 AROLL_LEV4 AROLL_LEV5 AROLL_LEV6 AROLL_LEV7 
-*AROLL_LEV8 AROLL_LEV9 AROLL_LEV10 AROLL_LEV11 AROLL_LEV12 AROLL_LEV13 
-*AROLL_LEV14 AROLL_LEV15
BY SEQNBR
-*BY AIR_KEY
BY LEVEL1 BY LEVEL2 BY LEVEL3 BY LEVEL4
BY AROLL_LEV1 BY AROLL_LEV2 BY AROLL_LEV3 BY AROLL_LEV4 BY AROLL_LEV5 BY AROLL_LEV6 BY AROLL_LEV7 
BY AROLL_LEV8 BY AROLL_LEV9 BY AROLL_LEV10 BY AROLL_LEV11 BY AROLL_LEV12 BY AROLL_LEV13 
BY AROLL_LEV14 BY AROLL_LEV15

WHERE AIRPFEE.AIR_KEY EQ SR_502.AIR_KEY
WHERE AIRPFEE.AIR_KEY NE ''
ON TABLE HOLD FORMAT ALPHA
END
-RUN

-IF &LINES EQ 0 THEN GOTO ChkCarFee;

MODIFY FILE &PFMASTER
FIXFORM SEQNBR/9 
FIXFORM ID_LEVEL1/A15 ID_LEVEL2/A15 ID_LEVEL3/A15 ID_LEVEL4/A60
FIXFORM AROLL_LEV1/A15 AROLL_LEV2/A15 AROLL_LEV3/A15 AROLL_LEV4/A15 
FIXFORM AROLL_LEV5/A15
FIXFORM AROLL_LEV6/A15 AROLL_LEV7/A15 AROLL_LEV8/A15 AROLL_LEV9/A15 
FIXFORM AROLL_LEV10/A15
FIXFORM AROLL_LEV11/A15 AROLL_LEV12/A15 AROLL_LEV13/A15 AROLL_LEV14/A15 
FIXFORM AROLL_LEV15/A15
COMPUTE SEQNBR = SEQNBR;
REPOSITION SEQNBR
MATCH SEQNBR
  ON MATCH UPDATE ID_LEVEL1 ID_LEVEL2 ID_LEVEL3 ID_LEVEL4 
  ON MATCH UPDATE AROLL_LEV1 AROLL_LEV2 AROLL_LEV3 AROLL_LEV4 AROLL_LEV5 
  ON MATCH UPDATE AROLL_LEV6 AROLL_LEV7 AROLL_LEV8 AROLL_LEV9 AROLL_LEV10
  ON MATCH UPDATE AROLL_LEV11 AROLL_LEV12 AROLL_LEV13 AROLL_LEV14 AROLL_LEV15
DATA ON HOLD
END
-RUN

-ChkCarFee

TABLE FILE &PFMASTER
PRINT CAR_KEY
BY SEQNBR
WHERE CAR_KEY NE ' '
ON TABLE HOLD AS CARPFEE FORMAT FOCUS INDEX CAR_KEY
END
-RUN
-IF &LINES EQ 0 THEN GOTO ChkHtlFee;

-IF '&QTR.EVAL' EQ 'X' THEN GOTO CARQTRDBS;

-CSINGLEDB
-SET &CFILE = &FPATH | 'C_' | '&COMP.EVAL' || '.FOC';

USE
	&CFILE AS CR_502
END
-RUN
-GOTO CARJOIN;

-CARQTRDBS
-SET &C0FILE = &FPATH | 'C0' | '&COMP.EVAL' || '.FOC';
-SET &C1FILE = &FPATH | 'C1' | '&COMP.EVAL' || '.FOC';
-SET &C2FILE = &FPATH | 'C2' | '&COMP.EVAL' || '.FOC';
-SET &C3FILE = &FPATH | 'C3' | '&COMP.EVAL' || '.FOC';
-SET &C4FILE = &FPATH | 'C4' | '&COMP.EVAL' || '.FOC';
-SET &C5FILE = &FPATH | 'C5' | '&COMP.EVAL' || '.FOC';
-SET &C6FILE = &FPATH | 'C6' | '&COMP.EVAL' || '.FOC';
-SET &C7FILE = &FPATH | 'C7' | '&COMP.EVAL' || '.FOC';
-SET &C8FILE = &FPATH | 'C8' | '&COMP.EVAL' || '.FOC';
-SET &C9FILE = &FPATH | 'C9' | '&COMP.EVAL' || '.FOC';
-SET &CYFILE = &FPATH | 'CY' | '&COMP.EVAL' || '.FOC';
-SET &CZFILE = &FPATH | 'CZ' | '&COMP.EVAL' || '.FOC';

USE
	&C0FILE AS CR_502
	&C1FILE AS CR_502
	&C2FILE AS CR_502
	&C3FILE AS CR_502
	&C4FILE AS CR_502
	&C5FILE AS CR_502
	&C6FILE AS CR_502
	&C7FILE AS CR_502
	&C8FILE AS CR_502
	&C9FILE AS CR_502
	&CYFILE AS CR_502
	&CZFILE AS CR_502
END
-RUN

-CARJOIN

JOIN CLEAR *
JOIN CAR_KEY IN CR_502 TO ALL CAR_KEY IN CARPFEE AS J1
-*JOIN CAR_KEY IN CARPFEE TO CAR_KEY IN CR_502 AS J1
END

TABLE FILE CR_502
-*PRINT LEVEL1 LEVEL2 LEVEL3 LEVEL4
-*AROLL_LEV1 AROLL_LEV2 AROLL_LEV3 AROLL_LEV4 AROLL_LEV5 AROLL_LEV6 AROLL_LEV7 
-*AROLL_LEV8 AROLL_LEV9 AROLL_LEV10 AROLL_LEV11 AROLL_LEV12 AROLL_LEV13
-*AROLL_LEV14 AROLL_LEV15
BY SEQNBR
-*BY CAR_KEY
BY LEVEL1 BY LEVEL2 BY LEVEL3 BY LEVEL4
BY AROLL_LEV1 BY AROLL_LEV2 BY AROLL_LEV3 BY AROLL_LEV4 BY AROLL_LEV5 BY AROLL_LEV6 BY AROLL_LEV7 
BY AROLL_LEV8 BY AROLL_LEV9 BY AROLL_LEV10 BY AROLL_LEV11 BY AROLL_LEV12 BY AROLL_LEV13 
BY AROLL_LEV14 BY AROLL_LEV15
WHERE CARPFEE.CAR_KEY EQ CR_502.CAR_KEY
WHERE CARPFEE.CAR_KEY NE ''
ON TABLE HOLD FORMAT ALPHA
END
-RUN
-IF &LINES EQ 0 THEN GOTO ChkHtlFee;

MODIFY FILE &PFMASTER
FIXFORM SEQNBR/9 
FIXFORM ID_LEVEL1/A15 ID_LEVEL2/A15 ID_LEVEL3/A15 ID_LEVEL4/A60
FIXFORM AROLL_LEV1/A15 AROLL_LEV2/A15 AROLL_LEV3/A15 AROLL_LEV4/A15 
FIXFORM AROLL_LEV5/A15
FIXFORM AROLL_LEV6/A15 AROLL_LEV7/A15 AROLL_LEV8/A15 AROLL_LEV9/A15 
FIXFORM AROLL_LEV10/A15
FIXFORM AROLL_LEV11/A15 AROLL_LEV12/A15 AROLL_LEV13/A15 AROLL_LEV14/A15 
FIXFORM AROLL_LEV15/A15
COMPUTE SEQNBR = SEQNBR;
REPOSITION SEQNBR
MATCH SEQNBR
  ON MATCH UPDATE ID_LEVEL1 ID_LEVEL2 ID_LEVEL3 ID_LEVEL4 
  ON MATCH UPDATE AROLL_LEV1 AROLL_LEV2 AROLL_LEV3 AROLL_LEV4 AROLL_LEV5 
  ON MATCH UPDATE AROLL_LEV6 AROLL_LEV7 AROLL_LEV8 AROLL_LEV9 AROLL_LEV10
  ON MATCH UPDATE AROLL_LEV11 AROLL_LEV12 AROLL_LEV13 AROLL_LEV14 AROLL_LEV15
DATA ON HOLD
END
-RUN

-ChkHtlFee
TABLE FILE &PFMASTER
PRINT HTL_KEY
BY SEQNBR
WHERE HTL_KEY NE ' '
ON TABLE HOLD AS HTLPFEE FORMAT FOCUS INDEX HTL_KEY
END
-RUN
-IF &LINES EQ 0 THEN GOTO DoneFee;

-IF '&QTR.EVAL' EQ 'X' THEN GOTO HTLQTRDBS;

-HSINGLEDB
-SET &HFILE = &FPATH | 'H_' | '&COMP.EVAL' || '.FOC';

USE
	&HFILE AS HR_502
END
-RUN
-GOTO HTLJOIN;

-HTLQTRDBS
-SET &H0FILE = &FPATH | 'H0' | '&COMP.EVAL' || '.FOC';
-SET &H1FILE = &FPATH | 'H1' | '&COMP.EVAL' || '.FOC';
-SET &H2FILE = &FPATH | 'H2' | '&COMP.EVAL' || '.FOC';
-SET &H3FILE = &FPATH | 'H3' | '&COMP.EVAL' || '.FOC';
-SET &H4FILE = &FPATH | 'H4' | '&COMP.EVAL' || '.FOC';
-SET &H5FILE = &FPATH | 'H5' | '&COMP.EVAL' || '.FOC';
-SET &H6FILE = &FPATH | 'H6' | '&COMP.EVAL' || '.FOC';
-SET &H7FILE = &FPATH | 'H7' | '&COMP.EVAL' || '.FOC';
-SET &H8FILE = &FPATH | 'H8' | '&COMP.EVAL' || '.FOC';
-SET &H9FILE = &FPATH | 'H9' | '&COMP.EVAL' || '.FOC';
-SET &HYFILE = &FPATH | 'HY' | '&COMP.EVAL' || '.FOC';
-SET &HZFILE = &FPATH | 'HZ' | '&COMP.EVAL' || '.FOC';

USE
	&H0FILE AS HR_502
	&H1FILE AS HR_502
	&H2FILE AS HR_502
	&H3FILE AS HR_502
	&H4FILE AS HR_502
	&H5FILE AS HR_502
	&H6FILE AS HR_502
	&H7FILE AS HR_502
	&H8FILE AS HR_502
	&H9FILE AS HR_502
	&HYFILE AS HR_502
	&HZFILE AS HR_502
END
-RUN

-HTLJOIN

JOIN CLEAR *
-*JOIN HTL_KEY IN HTLPFEE TO HTL_KEY IN HR_502 AS J1
JOIN HTL_KEY IN HR_502 TO HTL_KEY IN HTLPFEE AS J1
END

TABLE FILE HR_502
-*PRINT LEVEL1 LEVEL2 LEVEL3 LEVEL4
-*AROLL_LEV1 AROLL_LEV2 AROLL_LEV3 AROLL_LEV4 AROLL_LEV5 AROLL_LEV6 AROLL_LEV7 
-*AROLL_LEV8 AROLL_LEV9 AROLL_LEV10 AROLL_LEV11 AROLL_LEV12 AROLL_LEV13 
-*AROLL_LEV14 AROLL_LEV15
BY SEQNBR
-*BY HTL_KEY
BY LEVEL1 BY LEVEL2 BY LEVEL3 BY LEVEL4
BY AROLL_LEV1 BY AROLL_LEV2 BY AROLL_LEV3 BY AROLL_LEV4 BY AROLL_LEV5 BY AROLL_LEV6 BY AROLL_LEV7 
BY AROLL_LEV8 BY AROLL_LEV9 BY AROLL_LEV10 BY AROLL_LEV11 BY AROLL_LEV12 BY AROLL_LEV13 
BY AROLL_LEV14 BY AROLL_LEV15

WHERE HTLPFEE.HTL_KEY NE ''
WHERE HTLPFEE.HTL_KEY EQ HR_502.HTL_KEY
ON TABLE HOLD FORMAT ALPHA
END
-RUN
-IF &LINES EQ 0 THEN GOTO DoneFee;

MODIFY FILE &PFMASTER
FIXFORM SEQNBR/9 
FIXFORM ID_LEVEL1/A15 ID_LEVEL2/A15 ID_LEVEL3/A15 ID_LEVEL4/A60
FIXFORM AROLL_LEV1/A15 AROLL_LEV2/A15 AROLL_LEV3/A15 AROLL_LEV4/A15 
FIXFORM AROLL_LEV5/A15
FIXFORM AROLL_LEV6/A15 AROLL_LEV7/A15 AROLL_LEV8/A15 AROLL_LEV9/A15 
FIXFORM AROLL_LEV10/A15
FIXFORM AROLL_LEV11/A15 AROLL_LEV12/A15 AROLL_LEV13/A15 AROLL_LEV14/A15 
FIXFORM AROLL_LEV15/A15
COMPUTE SEQNBR = SEQNBR;
REPOSITION SEQNBR
MATCH SEQNBR
  ON MATCH UPDATE ID_LEVEL1 ID_LEVEL2 ID_LEVEL3 ID_LEVEL4 
  ON MATCH UPDATE AROLL_LEV1 AROLL_LEV2 AROLL_LEV3 AROLL_LEV4 AROLL_LEV5 
  ON MATCH UPDATE AROLL_LEV6 AROLL_LEV7 AROLL_LEV8 AROLL_LEV9 AROLL_LEV10
  ON MATCH UPDATE AROLL_LEV11 AROLL_LEV12 AROLL_LEV13 AROLL_LEV14 AROLL_LEV15
DATA ON HOLD
END
-RUN
-DoneFee

