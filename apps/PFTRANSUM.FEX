-*2/17/15 - DEB = S-07237  ADDED SUMMARY REPORT FOR ABTRNFSM
SET ASNAMES=ON


DEFINE FILE SR_50
 CC_LEN/I2 = ARGLEN(18, CREDIT_CARD, CC_LEN);
 AA_CC/A7 = IF CC_LEN LT 18 THEN EDIT(CREDIT_CARD, '99$$$$$$$$$$99999')
              ELSE EDIT(CREDIT_CARD, '99$$$$$$$$$$$99999');
 COMM/D12.2 = IF VOID_DATE EQ 0 THEN SEG_COM ELSE 0;

 FARE_PAID/D12.2C   = SEG_AMT + SEG_TAX;
 XTRAN_DT/MDYY        = TRN_DATE;
 LEVEL_DESC/A60 = &&LDESC;
 MCOS/D9CS           = IF (DOC_TYPE EQ '1') AND
                            (EX_FLAG EQ ' ')  AND
                           (EXCHG_SALE NE ' ') THEN 1 ELSE 0;        
 NEW_SEG_AMT/D12.2CS = SEG_AMT;
 NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                            (SEG_NBR EQ '01') AND
                            (FARE_PAID GE 0) AND
                            (SEG_COUNT EQ 1) AND 
                            (CONJ_REL EQ 1) THEN 1 ELSE 
                         IF (TICKET_CODE EQ '1') AND 
                            (SEG_NBR EQ '01') AND 
                            (EX_FLAG EQ 'F') THEN (-1) ELSE 
                         IF (TICKET_CODE EQ '1') AND
                            (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
NET_TKT_CNT1/D9 =   IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND
                         (SEG_COUNT  EQ 1) AND (EXCHG_SALE EQ ' ') THEN 1 ELSE 
                    IF (DOC_TYPE EQ '1') AND (EX_FLAG EQ ' ') AND 
                         (EXCHG_SALE NE ' ') AND (RF_FLAG EQ ' ') THEN 1 ELSE 0;
NEW_SEG_MILES/D9= SEG_MILES;
SEG_CNT/D8CS         = SEG_COUNT;
TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                           (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
                           EX_IND/A1 = IF EXCHG_SALE NE ' ' THEN 'E' ELSE ' ';
XPSNGR_NM/A15        = 
  EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');   
XDPT_DT/MDYY         = DPT_DATE;
VOIDS/D9CS          = IF (VOID_DATE NE 0) AND
                           (SEG_COUNT EQ 1) AND
                           (SEG_NBR EQ '01') THEN 1 ELSE
                        IF (DOC_TYPE EQ '1') AND 
                           (VOID_DATE NE 0) THEN 1 ELSE 0;
FLAG/A1 = 'B';
TKT_CNT/D9CS        = IF (SEG_NBR EQ '01') AND 
                         (FARE_PAID GE 0) AND 
                           (SEG_COUNT EQ 1) THEN 1 ELSE 0;       
-* Defines on previous defines
 AIRLINE_FEE/D12.2CS = IF EMBARK EQ 'FP2' OR 'FP3' 
      THEN FARE_PAID ELSE 0;
 EXCHGS/D9 = IF (EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (EMBARK 
  NE 'DT1' OR 'RF1' OR 'FP3') THEN TKT_CNT ELSE
  IF (DOC_TYPE EQ '1') AND (EXCHG_SALE EQ 'E') THEN 0 ELSE
  IF (SEG_COUNT GE 0) AND (EXCHG_SALE NE ' ') THEN TKT_CNT ELSE 0;
 REFUND/D9CS    = IF (VOID_DATE EQ 0) AND
                     (SEG_COUNT LE 0) AND
                    (TKT_SORT NE LAST TKT_SORT) AND
                    (EMBARK NE 'DT1' OR 'RF1' OR 'FP3') AND
                    (RF_FLAG NE ' ') THEN 1 ELSE 0;
 TSFARE_PAID/D12.2CS = IF EMBARK EQ 'FP2' OR 'FP3' THEN 0 ELSE FARE_PAID ;
 XFST_DPT/MDYY = FST_DPT_DATE;
 EXMCOS/D9 = IF (EX_FLAG NE ' ') AND (DOC_TYPE EQ '1') AND (EXCHG_SALE 
	NE ' ') THEN 1 ELSE 0;  
NW_FARE_PAID/D12.2CS = IF VOID_DATE EQ 0 THEN FARE_PAID ELSE 0;
NW_TKT_CNT/D8CS = IF VOID_DATE EQ 0 THEN NET_TKT_CNT ELSE 0;

END

TABLE FILE SR_50
PRINT AIR_KEY
  AA_CC
  INTL_DOM
  AIRLINE
  AIRLINE_FEE
  BR_CL_IDX
  C_ITIN
  CC_NUM
  DOC_NUMBER
  DOC_TYPE
  EMBARK
  CITYPAIR.EMBARK      AS 'EMB_APT_CD'	
  EXCHG_SALE AS 'EXSALE'
  EX_FLAG
  EX_IND
  EXCHGS
  NW_FARE_PAID  
  FLAG
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  
  NEW_SEG_AMT
  NW_TKT_CNT
  NEW_SEG_MILES
  ONLINE_TRADITIONAL
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_CNT
  SEG_NBR
  TKT_NUM	
  TKT_SORT
  TKT_TYPE	
  TRN_DATE
  VOID_DATE
  XFST_DPT
  XPSNGR_NM
  XTRAN_DT

  NW_FARE_PAID AS 'TFARE'

BY AIR_KEY
-INCLUDE RPTPARMS
-INCLUDE &AIRDATES

-* WHERE AIR_KEY IN FILE SAVE
ON TABLE HOLD AS SR50SUB FORMAT FOCUS INDEX AIR_KEY
END
-RUN
 

JOIN AIR_KEY IN PFHOLDA TO ALL AIR_KEY IN SR50SUB AS PFJ
-RUN

DEFINE FILE PFHOLDA
-* IF EMB_APT_CD EQ 'FP2' OR 'FP1' OR 'DT1' THEN 0 ELSE  
FEE/D12.2CS = IF TKT_NUM NE LAST TKT_NUM THEN FEE_AMT ELSE 0;
END
TABLE FILE PFHOLDA
PRINT 
  AIR_KEY	
  AA_CC
  INTL_DOM
  AIRLINE
  AIRLINE_FEE
  BR_CL_IDX
  C_ITIN
  CC_NUM
  DOC_NUMBER
  DOC_TYPE
  EMBARK
  EMB_APT_CD
  EXSALE   
  EX_FLAG
  EX_IND
  EXCHGS
  NW_FARE_PAID
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  NEW_SEG_AMT
  NW_TKT_CNT
  NEW_SEG_MILES
  ONLINE_TRADITIONAL
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_CNT
  SEG_NBR
  TASF_TKT_NUM
  TKT_NUM	
  TKT_SORT
  TKT_TYPE	
  TRN_DATE
  VOID_DATE
  XFST_DPT
  XPSNGR_NM
  XTRAN_DT

  FEE AS 'TFARE' 

BY FLAG
BY PASSNGR_NAME NOPRINT
ON TABLE HOLD AS HOLDFEE FORMAT FOCUS
END
-RUN
 


TABLE FILE AIRHOLD4
PRINT 
  AIR_KEY
  AA_CC
  INTL_DOM
  AIRLINE
  AIRLINE_FEE
  BR_CL_IDX
  C_ITIN
  CC_NUM
  DOC_NUMBER
  DOC_TYPE
  EMBARK
  EMB_APT_CD
  EXSALE
  EX_FLAG
  EX_IND
  EXCHGS
  NW_FARE_PAID
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  NEW_SEG_AMT
  NW_TKT_CNT
  NEW_SEG_MILES
  ONLINE_TRADITIONAL
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_CNT
  SEG_NBR
  TASF_TKT_NUM
  TKT_NUM	
  TKT_SORT
  TKT_TYPE	
  TRN_DATE
  VOID_DATE
  XFST_DPT
  XPSNGR_NM
  XTRAN_DT
  TFARE
BY FLAG
BY PASSNGR_NAME NOPRINT
WHERE AIRLINE_FEE EQ 0
ON TABLE HOLD  
END
-RUN


MODIFY FILE HOLDFEE
FIXFORM FROM HOLD
DATA ON HOLD
END
-RUN

TABLE FILE HOLDFEE
PRINT 
  AIR_KEY	
  AA_CC
  INTL_DOM
  AIRLINE
  AIRLINE_FEE
  BR_CL_IDX
  C_ITIN
  CC_NUM
  DOC_NUMBER
  DOC_TYPE
  EMBARK
  EMB_APT_CD
  EXSALE
  EX_FLAG
  EX_IND
  EXCHGS
  NW_FARE_PAID
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  NEW_SEG_AMT
  NW_TKT_CNT
  NEW_SEG_MILES
  ONLINE_TRADITIONAL
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_CNT
  SEG_NBR
  TASF_TKT_NUM
  TKT_NUM	
  TKT_SORT
  TKT_TYPE	
  TRN_DATE
  XPSNGR_NM
  XFST_DPT
  VOID_DATE
  XTRAN_DT

  TFARE

BY FLAG
BY PASSNGR_NAME NOPRINT
ON TABLE HOLD AS HOLDAM FORMAT FOCUS
END
-RUN

 


DEFINE FILE AIRHOLD4
FLAG/A1 = 'F';
END
TABLE FILE AIRHOLD4
PRINT 
  AIR_KEY
  AA_CC
  INTL_DOM
  AIRLINE
  AIRLINE_FEE
  BR_CL_IDX
  C_ITIN
  CC_NUM
  DOC_NUMBER
  DOC_TYPE
  EMBARK
  EMB_APT_CD
  EXSALE
  EX_FLAG
  EX_IND
  EXCHGS
  NW_FARE_PAID
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  NEW_SEG_AMT
  NW_TKT_CNT
  NEW_SEG_MILES
  ONLINE_TRADITIONAL
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_CNT
  SEG_NBR
  TASF_TKT_NUM
  TKT_NUM	
  TKT_SORT
  TKT_TYPE	
  TRN_DATE
  VOID_DATE
  XFST_DPT
  XPSNGR_NM
  XTRAN_DT
 
  TFARE
 
BY FLAG
BY PASSNGR_NAME NOPRINT
WHERE AIRLINE_FEE NE 0
ON TABLE HOLD
END
-RUN

MODIFY FILE HOLDAM
FIXFORM FROM HOLD
DATA ON HOLD
END
-RUN


-GOTO XXIT;

DEFINE FILE HOLDAM
NEW_FARE/D12.2CS = IF FLAG EQ 'A' OR 'F' THEN NW_FARE_PAID ELSE 0;
NW_TCNT/D8CS = IF FLAG EQ 'A' THEN NW_TKT_CNT ELSE 0;
AFEE/D12.2CS = IF FLAG EQ 'F' THEN AIRLINE_FEE ELSE 0;
FEE/D12.2CS = IF FLAG EQ 'B' THEN TFARE ELSE 0;
END
TABLE FILE HOLDAM
 
PRINT  AIR_KEY	
  AFEE  
  BR_CL_IDX  
  NEW_FARE AS 'NW_FARE_PAID'

  NW_TCNT  AS 'NW_TKT_CNT'
  TKT_NUM
  TASF_TKT_NUM

  PASSNGR_NAME
  FEE  
BY FLAG
BY PASSNGR_NAME NOPRINT
BY TKT_NUM NOPRINT
ON FLAG SUMMARIZE AS 'TOTAL FOR'
ON TABLE COLUMN-TOTAL
ON TABLE HOLD AS MATCHONE
END
-RUN


-XXIT

 

