-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-*11/9/15 - DLV - S-12565 - CREATED new routine for UNVMPXT  
-*                          CREATED FROM TOPHTLPX
-*3/2/16 - JEM -S-16367 Updated hard coded d:\ to use &&WFSRV1.EVAL

-INCLUDE SETECHO

-* FILE UNVMHPX.FEX
 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN
-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';

DEFINE FILE &&EXTRACT

  LEVEL_DESC/A60  = &&LDESC;
  IN_DATE/MDYY = CHKIN_DATE;
  INV_DATE/MDYY = INVOICE_DATE;
  NBR_DAYS/D12 =  NUM_DAYS;
  NBR_ROOMS/D12 = NUM_ROOMS;
  NEW_ROOM_RATE/D14.2C = ROOM_RATE;
  NEW_STD_RATE/D14.2C = STD_RATE;
  NEW_TOTAL_AMT/D14.2C = TOTAL_AMT;
  NNROOMS/D12 = IF ((NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)) THEN 
                ((NBR_DAYS*NUM_ROOMS) * (-1)) ELSE NBR_DAYS*NUM_ROOMS;
  OUT_DATE/MDYY = CHKOUT_DATE;
  
  XPSNGR_NM1/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XPSNGR_NM/A15 = LCWORD(15, XPSNGR_NM1, XPSNGR_NM);
  
END
-RUN

TABLEF FILE &&EXTRACT
PRINT 
  AR_BRANCH
  BR_CL_IDX	
  CLIENT_NAME
  CURR_DATE	
  HTL_KEY
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  RESV_BRANCH
  RESV_DATE	
  ROOM_RATE 	
  ROOM_TYPE
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 	
  XPSNGR_NM

-INCLUDE &HTLDATES    
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************

WHERE CITY.INTL_DOM EQ 'I' 
&&WHERE9
-INCLUDE RPTPARMS

ON TABLE HOLD AS TOPHTLH
END
-RUN

TABLE FILE TOPHTLH
PRINT AR_BRANCH
  BR_CL_IDX	
  CLIENT_NAME
  HTL_KEY
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  RESV_BRANCH
  RESV_DATE	
  ROOM_RATE 	
  ROOM_TYPE
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  XPSNGR_NM
BY CURR_DATE
ON TABLE HOLD AS TPHTLHLD FORMAT FOCUS INDEX CURR_DATE
END
-RUN

-* Global Reporting JOIN
JOIN TPHTLHLD.CURR_DATE IN TPHTLHLD TO GLOBAL.DATE IN GLOBAL AS J1
END

DEFINE FILE TPHTLHLD
NAMEC/A30 = CNAME;


-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
AMT_TOTALX/D20.6 = NEW_TOTAL_AMT * CURR1X;
END

TABLE FILE TPHTLHLD
PRINT AR_BRANCH
  BR_CL_IDX	
  CLIENT_NAME
  CURR_DATE
  HTL_KEY
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  RESV_BRANCH
  RESV_DATE	
  ROOM_RATE 	
  ROOM_TYPE
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  XPSNGR_NM
  AMT_TOTALX/D16.2CS
  NAMEC
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
BY HTL_KEY
ON TABLE HOLD AS TOPHTLH2 FORMAT FOCUS INDEX HTL_KEY
END
-RUN

 TABLE FILE ROLLUP
 PRINT COMP
 IF ROLLUP EQ '&&ROLLUP.EVAL'
 ON TABLE HOLD AS COMPANY
 END 
 -RUN
 
 -READ COMPANY &&COMP.A8
 -SET &&COMPNY = &&COMP.EVAL;
 -CLOSE COMPANY
 
-SET &&COMPUH = '&&WFSRV1.EVAL' || '\TNT\TTRACKER\DATA\UH'|| '&&COMPNY.EVAL' ||'.FOC';
-RUN
 
 
 
 USE CLEAR *
 USE 
 &&COMPUH AS UDHTL
 &&WFSRV1.EVAL\TNT\TTRACKER\SYSTEM\DATA\UDID_DSC.FOC AS UDID_DSC
 END
 
  
 TABLE FILE UDHTL
 PRINT AUD_DATA AS 'EMP
 BY HTL_KEY
 WHERE UDID EQ 'EMP' 
 ON TABLE HOLD AS UDIDHOLDH
 END
-RUN


JOIN HTL_KEY IN TOPHTLH2 TO HTL_KEY IN UDIDHOLDH AS J1
-RUN

DEFINE FILE TOPHTLH2
EMP_ID/A6 = EDIT(EMP, '999999');
END
TABLE FILE TOPHTLH2  
SUM
  NBR_DAY
  NBR_ROOMS
  NNROOMS
  NEW_TOTAL_AMT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  AMT_TOTALX/D16.2CS
  NAMEC
  EMP_ID
BY XPSNGR_NM AS 'PASSNGR_NAME' 
 
ON TABLE HOLD AS HOLDHPX 
END
-RUN

-SET &&NOHTL = IF &LINES EQ 0 THEN 'Y' ELSE 'N';

 