SET ASNAMES=ON

-SET &&FYFLAG = '2';
-SET &&ROLLFY = '04';
-SET &&FROMDT = '20090401';
-SET &&TODT = '20090630';
-SET &&FXDATE = '20080401';
-SET &&TXDATE = '20080331';
-SET &&IQTR = 1;

DEFINE FILE TOPAZ

  FROM_MYR/A8=GETTOK(PERIOD, 18, 1, '-', 8, FROM_MYR);
  TO_MYR/A8  =GETTOK(PERIOD, 18, -1, '-', 8, TO_MYR);

  TOYRX/A4 = GETTOK(TO_MYR,8, -1, ' ', 4, TOYRX);   
  TOYR/A4=IF TOYRX CONTAINS '20' THEN TOYRX ELSE EDIT(TO_MYR, '$$$$9999');
   
  FMMTH/A3 = EDIT(FROM_MYR, '999');  
  FMYR/A4=IF FROM_MYR CONTAINS '20' THEN EDIT(FROM_MYR,'$$$$9999')
    ELSE EDIT(TO_MYR,'$$$$9999');
   
  TOMTH/A3 = EDIT(TO_MYR,'999');   
  MTH1/A2=DECODE FMMTH ('Jan' '01' 'Feb' '02' 'Mar' '03' 'Apr' '04' 'May' '05' 
   'Jun' '06' 'Jul' 07 'Aug' '08' 'Sep' '09' 'Oct' '10' 'Nov' '11' 'Dec' '12');
   MTH2/A2=DECODE TOMTH ('Jan' '01' 'Feb' '02' 'Mar' '03' 'Apr' '04' 'May' '05' 
   'Jun' '06' 'Jul' 07 'Aug' '08' 'Sep' '09' 'Oct' '10' 'Nov' '11' 'Dec' '12');
  
-*Calculate FromData and ToDate  
  AFROMDATE/A6YYM = FMYR | MTH1;
  ATODATE/A6YYM   = TOYR | MTH2; 
  XFROMDATE/YYMD = AFROMDATE;
  
  THEYR/I1 = IF (XFROMDATE GE '&&FROMDT.EVAL') AND (XFROMDATE LE '&&TODT.EVAL') THEN 2
     ELSE IF (XFROMDATE GE '&&FXDATE.EVAL') AND (XFROMDATE LE '&&TXDATE.EVAL') THEN 1;
 
  TRANYR/YY= XFROMDATE;
  AYEAR/A4YY = TRANYR;
  
-*first year as fiscal year label
  FMDATE1/YYMD= '&&FXDATE.EVAL';
  FMDATE2/YYMD= '&&FROMDT.EVAL';
  FYYR1/A2=EDIT('&&FXDATE.EVAL','$$99');
  FYYR2/A2=EDIT('&&FROMDT.EVAL','$$99');

-*second year as fiscal year label
  Y2DATE/YYMD = DATEADD(FMDATE2, 'Y', 1);
  FYYR3T/YY=Y2DATE;
  FYYR3TA/A4=EDIT(FYYR3T);
  FYYR3/A2=EDIT(FYYR3TA,'$$99');
  
  FY_YR/A4= IF '&&FYFLAG.EVAL' EQ '1' AND THEYR EQ 1 THEN 'FY' | FYYR1
    ELSE IF '&&FYFLAG.EVAL' EQ '1' AND THEYR EQ 2 THEN 'FY' | FYYR2
    ELSE IF '&&FYFLAG.EVAL' EQ '2' AND THEYR EQ 1 THEN 'FY' | FYYR2
    ELSE IF '&&FYFLAG.EVAL' EQ '2' AND THEYR EQ 2 THEN 'FY' | FYYR3
    ELSE AYEAR;

  FYM/M = &&ROLLFY;
  YEAR/A4 = IF FYM EQ 01 THEN AYEAR ELSE FY_YR;
  
  FROMDATE/YYMD='&&FROMDT.EVAL';
  TODATE/YYMD='&&TODT.EVAL';
  FXDATE/YYMD='&&FXDATE.EVAL';
  TXDATE/YYMD='&&TXDATE.EVAL';
  
  FM/M=FROMDATE;
  TM/M=TODATE;
  
  FMA/A3=DECODE FM ('01' 'Jan' '02' 'Feb' '03' 'Mar' '04' 'Apr' '05' 'May' '06' 
     'Jun' '07' 'Jul' 08 'Aug' '09' 'Sep' '10' 'Oct' '11' 'Nov' '12' 'Dec');
  TMA/A3=DECODE TM ('01' 'Jan' '02' 'Feb' '03' 'Mar' '04' 'Apr' '05' 'May' '06' 
     'Jun' '07' 'Jul' 08 'Aug' '09' 'Sep' '10' 'Oct' '11' 'Nov' '12' 'Dec');
  TXM/M=TM-12;   
  -* TXM/M=TXDATE;
  TXMA/A3 = DECODE TXM ('01' 'Jan' '02' 'Feb' '03' 'Mar' '04' 'Apr' '05' 'May' '06' 
     'Jun' '07' 'Jul' 08 'Aug' '09' 'Sep' '10' 'Oct' '11' 'Nov' '12' 'Dec');
     
  FMYY/YY = FROMDATE;
  FMYYA/A4YY = FMYY;
  
  TOYY/YY = TODATE;
  TOYYA/A4YY = TOYY;
  
  FXYY/YY = FXDATE;
  FXYYA/A4YY = FXYY;
  
  TXYY/YY = TOYY-1;
  -*TXYY/YY = TXDATE;
  TXYYA/A4YY = TXYY;
  
  PERIOD1A/A18=FMA | '-' | TMA | ' ' | TOYYA;
  PERIOD1B/A18=FMA | ' ' | FMYYA | '-' | TMA | ' ' | TOYYA;
  
  PERIOD2A/A18=FMA | '-' | TXMA | ' ' | TXYYA;
  PERIOD2B/A18=FMA | ' ' | FXYYA | '-' | TXMA | ' ' | TXYYA;
 
  ROLLUP_CODE/A8 = 'TOPAZ-R';
 
 
END

TABLE FILE TOPAZ
PRINT DPRICE  IPRICE  CPRICE 
BY ROLLUP_CODE AS 'ROLL'
BY YEAR
BY PERIOD
WHERE PERIOD EQ PERIOD1A OR PERIOD EQ PERIOD1B OR PERIOD EQ PERIOD2A OR PERIOD EQ PERIOD2B
-* ON TABLE HOLD
END
-RUN
-QUIT

DEFINE FILE HOLD
  SEL/A1 = IF YEAR EQ LAST YEAR THEN 'N' ELSE 'Y';
END
TABLE FILE HOLD
PRINT DPRICE/D6 AS 'T1AVGD'  IPRICE/D6 AS 'T1AVGI'  CPRICE/D6 AS 'T1AVGC'
BY ROLL
BY YEAR
WHERE SEL EQ 'Y'
-* ON TABLE HOLD AS TPZYTD2
END
-RUN
-QUIT
-GOTO XXIT;
USE D:\JOY\QRATP2.FOC
    D:\JOY\YTDATP1.MAS
END
-INCLUDE JOYTOPAZ
TABLE FILE TPZYTD2
PRINT T1AVGD
      T1AVGI
      T1AVGC
BY ROLL
BY YEAR
ON TABLE HOLD
END
TABLE FILE YTDATP1
PRINT *
END

-XXIT;