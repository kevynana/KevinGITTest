-*2/22/05        JK                 ADDED TNT_COMPANY WHERE STATEMENT
-* 01/26/2017 - S-29510 - UPDATED TO USE NEW HOTEL ATTACHENT LOGIC

-INCLUDE SETECHO
SET ASNAMES = ON 

-TYPE '&&ROLL.EVAL'

-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED
-*========================================================================
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

DEFINE FILE &&EXTRACT
AIR_VOL/D12.2 = SEG_AMT + SEG_TAX;
FARE_PAID/D12.2C = SEG_AMT + SEG_TAX;
NEW_STAY/P12 = STAY;
-*NEW_HTL_DAYS/P12 = HTL_DAYS;
-* NEW_HTL_DAYS/P12 = IF HTL_DAYS LT 0 THEN HTL_DAYS * (-1) ELSE HTL_DAYS;
-*NOHOTEL/P9C = NEW_STAY - NEW_HTL_DAYS;
NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0; 
TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
-* Defines on Previous
ROLLCD/A8 = '&&ROLL';
END


TABLE FILE &&EXTRACT
PRINT AGENT_NUM AIR_VOL
EMBARK
HOTEL_FLAG
NET_TKT_CNT
NEW_STAY
PASSNGR_NAME
TRN_DATE
BY ROLLCD
BY TKT_NUM
-INCLUDE &AIRDATES
WHERE VOID_DATE EQ 0
WHERE HOTEL_FLAG NE ' ' 
WHERE EMBARK OMITS 'DT1' 
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS TCANHD
END
-RUN



-IF &LINES EQ 0 THEN GOTO NEXTONE;
-*========================================================================
-*   PROCESS EXTRACTED DATA FROM ABOVE
-*========================================================================
DEFINE FILE TCANHD
ROLLCD/A8 = '&&ROLL';
 HTL_ATTCH  /P9 = IF (NET_TKT_CNT GT 0) AND (HOTEL_FLAG EQ 'Y') THEN 1 ELSE 0;
 HTL_NOATTCH/P9 = IF (NET_TKT_CNT GT 0) AND (HOTEL_FLAG EQ 'N') THEN 1 ELSE 0;
END
-*
TABLE FILE TCANHD
PRINT NET_TKT_CNT AIR_VOL
      HOTEL_FLAG
      NEW_STAY
      HTL_ATTCH
      HTL_NOATTCH
BY ROLLCD
BY PASSNGR_NAME
BY TKT_NUM
BY AGENT_NUM
BY TRN_DATE
ON TABLE HOLD AS TCNHD1A
END
-RUN

TABLE FILE TCNHD1A
SUM   HTL_ATTCH HTL_NOATTCH AIR_VOL
BY ROLLCD
BY AGENT_NUM
ON TABLE HOLD AS TCNHD1
END
-RUN




MODIFY FILE TC_NHA
LOG DUPL MSG OFF
FIXFORM FROM TCNHD1
MATCH ROLLCD AGENT_NUM
ON NOMATCH INCLUDE
ON MATCH UPDATE  HTL_ATTCH HTL_NOATTCH AIR_VOL
DATA ON TCNHD1
END
-RUN




-NEXTONE
 

