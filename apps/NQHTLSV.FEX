-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* Created for the new quarterly review - JK 8/2/05
-******************************************************************************
-INCLUDE SETECHO
SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-INCLUDE SETECHO
SET ASNAMES = ON
-SET HOLDATTR = ON;

DEFINE FILE &&EXTRACT 
  CHAINN/A25 = LCWORD(25, CHAIN_NAME, CHAINN);
  NEW_STD_RATE/P10.4 = STD_RATE;
  NEW_TOTAL_AMT/D12.2C = TOTAL_AMT;
  NBR_DAYS/D12 =  NUM_DAYS; 
  NNROOMS/D12 = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
 REASON_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
-********Defines on Previous Defines
TOTAL_STD/D12.2C = IF ((NNROOMS LT 0) AND (NEW_STD_RATE LT 0))
                      THEN ((NNROOMS * NEW_STD_RATE) * (-1))
                      ELSE NNROOMS * NEW_STD_RATE;

-******Defines on Previously Defined Defines***
 TOTAL_SLSAV/D12.2C = TOTAL_STD - NEW_TOTAL_AMT;
-INCLUDE QRFTRANC
END


TABLEF FILE &&EXTRACT
PRINT NNROOMS
      NEW_TOTAL_AMT
      REASON_CD
      TOTAL_SLSAV
      TRAN
      INVOICE_DATE
WHERE (INVOICE_DATE GE '&&FROMDT.EVAL') AND (INVOICE_DATE LE '&&TODT.EVAL') OR
      (INVOICE_DATE GE '&&FXDATE.EVAL') AND (INVOICE_DATE LE '&&TXDATE.EVAL') 
WHERE REASON_CD NE ' '
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-INCLUDE RPTPARMS
ON TABLE HOLD AS HTLB
END
-RUN


TABLE FILE HTLB
SUM NNROOMS
    NEW_TOTAL_AMT
BY REASON_CD
WHERE (INVOICE_DATE GE '&&FROMDT.EVAL') AND (INVOICE_DATE LE '&&TODT.EVAL')
ON TABLE HOLD AS HTLB1
END
-RUN



-IF &LINES EQ 0 THEN GOTO NoHTLData;


DEFINE FILE HTL_REF
HTLR/A1 = IF REFUSE_KEY CONTAINS '&&BASEROLL.EVAL' THEN 'Y' ELSE 'N';
END
TABLE FILE HTL_REF
SUM HTLR
BY REFUSE_KEY
ON TABLE SAVE
END
-RUN


-READ SAVE &HREF.10. &HTLR.1.

DEFINE FILE HTL_REF
ROLLUP/A8=EDIT(REFUSE_KEY,'99999999');
REASON_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
END
TABLE FILE HTL_REF
PRINT REASON_CD REFUSAL_DESC
BY REASON_CD
-IF '&HTLR.EVAL' EQ 'N' THEN GOTO Common;
WHERE ROLLUP EQ '&&BASEROLL.EVAL'
-GOTO EndWhere;
-Common
WHERE ROLLUP EQ ' '
-EndWhere
ON TABLE HOLD AS HREF
END
-RUN



MATCH FILE HTLB1
PRINT NNROOMS
      NEW_TOTAL_AMT
BY REASON_CD
ON TABLE HOLD
RUN
FILE HREF
SUM REASON_CD REFUSAL_DESC
BY REASON_CD
AFTER MATCH HOLD AS HTLB2 OLD-AND-NEW
END
-RUN

DEFINE FILE HTLB2
SPACE/A2 = '  ';
RSNCDE/A6 = SPACE|SPACE|REASON_CD;
END
-RUN

TABLE FILE HTLB2
SUM NNROOMS
    NEW_TOTAL_AMT
    PCT.NEW_TOTAL_AMT/P10.4 AS 'TAPCT'
BY REASON_CD
BY REFUSAL_DESC
BY RSNCDE
ON TABLE HOLD AS HTLB3
END
-RUN

TABLE FILE HTLB3
SUM 
COMPUTE AVGRR/P4.1 = IF ((NNROOMS LT 1) AND (NNROOMS GT (-1))) THEN 0 ELSE
                       NEW_TOTAL_AMT/NNROOMS;
BY RSNCDE
ON TABLE HOLD AS HTLB4
END
-RUN

-***********************************************************************************
-* Average Rate Per Night by Reason Code Graph
-***********************************************************************************
-SET &G_DADV1= 'N';
-IF &&SKIPGRAPH EQ 'Y' THEN GOTO AROUNDHTL;

GRAPH FILE HTLB4
PRINT AVGRR AS ' '  
ACROSS RSNCDE AS ' '
ON GRAPH SET 3D OFF
ON GRAPH SET VZERO ON
ON GRAPH SET GRID OFF
ON GRAPH SET GRAPHSTYLE *
setGraphType(17);
setO1LabelRotate(3);
setAutofit(getO1Label(),true);
setFontSizeAbsolute(getO1Label(),true); 
setFillColor(getSeries(0), new Color, 0 64 128));
setFillColor(getSeries(1), new Color, 145 207 255));
setFillColor(getSeries(2), new Color, 160 0 181));
setFillColor(getSeries(3), new Color, 255 255 128 ));
setFillColor(getSeries(4), new Color, 0 128 0));
setFillColor(getSeries(5), new Color, 128 128 128));
setFillColor(getSeries(6), new Color, 255 0 255));
setFillColor(getSeries(7), new Color, 64 128 128));
setFillColor(getSeries(8), new Color, 255 128 0));
setFillColor(getSeries(9), new Color, 128 0 0));
setFillColor(getSeries(10), new Color, 192 192 192));
setFillColor(getSeries(11), new Color, 0 0 160));
setFillColor(getSeries(12), new Color, 190 115 65));
setFillColor(getSeries(13), new Color, 0 64 64));
setFillColor(getSeries(14), new Color, 64 0 128));
setFillColor(getSeries(15), new Color, 255 0 128));
setFillColor(getSeries(16), new Color, 52 203 181));
setO1MajorGridDisplay(false);
setO1MinorGridDisplay(false);
setY1MajorGridDisplay(false);
setY1MinorGridDisplay(false);
setSeriesDefaultTransparentBorderColor(true);
setUseSeriesBorderDefaults(true);
setLegendDisplay(false);
setTitleString("Average Rate Per Night YTD");
setSubtitleString(" ");
setY1LabelDisplay(true);
setY1LabelFormat(6);
setAutofit(getY1Label(),true);
setFontSizeAbsolute(getY1Label(),true); 
setAutofit(getTitle(),true);
setTextJustHoriz(getTitle(),1);
setFontSizeAbsolute(getTitle(),true); 
setFontStyle(getTitle(),0);
setFontSize(getTitle(),12);
setPlace(true);
setDataTextDisplay(true);
setDataTextFormat(6); 
setFontSizeAbsolute(getDataText(),true);
setAutofit(getDataText(),false);
setFontStyle(getDataText(),0);
setFontSize(getDataText(),12);
ENDSTYLE
ON GRAPH HOLD AS HRSN FORMAT SVG
END
-RUN

-SET &G_DADV1=IF &LINES GT 0 THEN 'Y' ELSE 'N';
-AROUNDHTL

-***********************************************************************************
-* Hotel Savings
-***********************************************************************************

-SET &G_DADV2= 'N';
-IF &&SKIPGRAPH EQ 'Y' THEN GOTO AROUNDHTL1;

GRAPH FILE HTLB
SUM TOTAL_SLSAV AS ' '
ACROSS TRAN AS ' '
ON GRAPH SET 3D OFF
ON GRAPH SET VZERO OFF
ON GRAPH SET GRID OFF
ON GRAPH SET GRAPHSTYLE *
setGraphType(17);
setO1LabelDisplay(true);
setFontSizeAbsolute(getO1Label(),true); 
setAutofit(getO1Label(),false);
setFontStyle(getO1Label(),0);
setFontSize(getO1Label(),14);
setO1LabelRotate(3);
setO1MajorGridDisplay(false);
setO1MinorGridDisplay(false);
setY1MajorGridDisplay(false);
setY1MinorGridDisplay(false);
setSeriesDefaultTransparentBorderColor(true);
setUseSeriesBorderDefaults(true);
setLegendDisplay(false);
setTitleString("Hotel Savings");
setSubtitleString(" ");
setY1LabelDisplay(true);
setY1LabelFormat(6);
setAutofit(getY1Label(),true);
setFontSizeAbsolute(getY1Label(),true); 
setAutofit(getTitle(),true);
setTextJustHoriz(getTitle(),1);
setFontSizeAbsolute(getTitle(),true); 
setFontStyle(getTitle(),0);
setFontSize(getTitle(),12);
setDataTextDisplay(true);
setDataTextFormat(6); 
setFontSizeAbsolute(getDataText(),true);
setAutofit(getDataText(),false);
setFontStyle(getDataText(),0);
setFontSize(getDataText(),12);
setPlace(true);
ENDSTYLE
ON GRAPH HOLD AS HSAV FORMAT SVG
END
-RUN

-SET &G_DADV2=IF &LINES GT 0 THEN 'Y' ELSE 'N';
-AROUNDHTL1


-************************************************************************
-* % of Total (spend per reason code)
-************************************************************************
-SET &G_DADV3= 'N';
-IF &&SKIPGRAPH EQ 'Y' THEN GOTO AROUNDHTL2;

TABLE FILE HTLB3
SUM TAPCT
BY REASON_CD
WHERE TAPCT GT 1
ON TABLE HOLD AS HTLBG
END
-RUN

GRAPH FILE HTLBG
SUM TAPCT AS ' '
BY REASON_CD AS ' '
ON GRAPH SET GRAPHEDIT OFF
ON GRAPH SET GRAPHSTYLE *
setGraphType(55);
setPieFeelerTextDisplay(1);
setPieFeelerTextFormat(2);
setPieLabelDisplay(3);
setPieDepth(90);
setFontSizeAbsolute(getPieLabelDisplay(),(true);
setLegendDisplay(false);
setPieSliceDetach(getSeries(0), 100);
setPieSliceDetach(getSeries(1), 100);
setSubtitleString("% Of Total Spend YTD");
setAutofit(getSubtitle(),true);
setTextJustHoriz(getSubtitle(),1);
setFontSizeAbsolute(getSubtitle(),true); 
setFontStyle(getSubtitle(),0);
setFontSize(getSubtitle(),12);
setFillColor(getSeries(0), new Color, 0 64 128));
setFillColor(getSeries(1), new Color, 145 207 255)); 
setFillColor(getSeries(2), new Color, 160 0 181));
setFillColor(getSeries(3), new Color, 255 255 128 ));
setFillColor(getSeries(4), new Color, 0 128 0));
setFillColor(getSeries(5), new Color, 128 128 128));
setFillColor(getSeries(6), new Color, 255 0 255));
setFillColor(getSeries(7), new Color, 64 128 128));
setFillColor(getSeries(8), new Color, 255 128 0));
setFillColor(getSeries(9), new Color, 128 0 0));
setFillColor(getSeries(10), new Color, 192 192 192));
setFillColor(getSeries(11), new Color, 0 0 160));
setFillColor(getSeries(12), new Color, 190 115 65));
setFillColor(getSeries(13), new Color, 0 64 64));
setFillColor(getSeries(14), new Color, 64 0 128));
setFillColor(getSeries(15), new Color, 255 0 128));
setFillColor(getSeries(16), new Color, 52 203 181));
setPlace(true);
ENDSTYLE
ON GRAPH HOLD AS HPTR FORMAT SVG
END
-RUN


-SET &G_DADV3=IF &LINES GT 0 THEN 'Y' ELSE 'N';
-AROUNDHTL2


-*******************************************************************************
-*Comments
-*******************************************************************************


DEFINE FILE HTLB1
FLAG/A1 = 'A';
TNIGHTS/P12 = IF REASON_CD NE 'I' THEN NNROOMS ELSE 0;
PNIGHTS/P12 = IF REASON_CD EQ 'T' OR 'A' OR 'R' THEN NNROOMS ELSE 0;
END
-RUN

TABLE FILE HTLB1
SUM TNIGHTS PNIGHTS
COMPUTE PPCT/P12 = IF ((TNIGHTS LT 1) AND (TNIGHTS GT (-1))) THEN 0 ELSE
                        (PNIGHTS/TNIGHTS)*100; 
COMPUTE ABSPPCT/P12 = ABS(PPCT);
BY FLAG 
ON TABLE HOLD AS HTLCMT
END
-RUN

TABLE FILE HTLCMT 
PRINT FLAG PPCT ABSPPCT
ON TABLE SAVE AS HSVCMT
END
-RUN


-READ HSVCMT NOCLOSE &FLAG.1. &PPCT.12. &ABSPPCT.12.

EX FMTNUMBER VALUE=&PPCT,DOLLAR='N',ALIGNED='N'
-RUN
-SET &PPCT = &&RETVAL;

-SET &CLINE1 = IF &ABSPPCT GT 0 THEN 'Percentage of Preferred Property Usage' ELSE ' ';
-SET &CLINE2 = IF &CLINE1 EQ ' ' THEN ' ' ELSE '(excluding I reason code):'|'&PPCT.EVAL'|'%';


-*******************************************************************************
-* Reason Code Table Creation
-*******************************************************************************

DEFINE FILE HTLB2
SPACE/A1 = ' ';
RSN/A45 = REASON_CD|SPACE|'-'|SPACE|REFUSAL_DESC;
END
-RUN

TABLE FILE HTLB2
LIST RSN 
ON TABLE HOLD AS HTLJOY
END
-RUN


TABLE FILE HTLJOY
PRINT RSN IN +55 AS ' '
BY LIST NOPRINT
ON TABLE SET PAGE-NUM OFF
HEADING
"</15"
"<52 &CLINE1"
"<52 &CLINE2"
"</5"
FOOTING BOTTOM
"Blank and/or Invalid Reason Codes Excluded"
&&OUTLINE1
&&OUTLINE2
ON TABLE SET STYLE *
UNITS=IN, PAGESIZE='Letter', LEFTMARGIN=0.100000, RIGHTMARGIN=0.100000, 
    TOPMARGIN=0.500000, BOTTOMMARGIN=0.250000, SQUEEZE=ON, 
    ORIENTATION=LANDSCAPE, $
TYPE=HEADING, LINE=17, FONT=ARIAL, SIZE=15, STYLE=BOLD, $
TYPE=HEADING, LINE=18, FONT=ARIAL, SIZE=15, STYLE=BOLD, $
TYPE=FOOTING, FONT=TIMES NEW ROMAN, SIZE=7, STYLE=BOLD, $
-* TYPE=REPORT, FONT=TIMES NEW ROMAN, SIZE=8, BACKCOLOR=NONE, STYLE=NORMAL, $
TYPE=REPORT, FONT=ARIAL, SIZE=8, STYLE=NORMAL, $

DEFMACRO=COND0001, MACTYPE=RULE, WHEN=N1 EQ 1, $
DEFMACRO=COND0002, MACTYPE=RULE, WHEN=N1 EQ 3, $
DEFMACRO=COND0003, MACTYPE=RULE, WHEN=N1 EQ 5, $
DEFMACRO=COND0004, MACTYPE=RULE, WHEN=N1 EQ 7, $
DEFMACRO=COND0005, MACTYPE=RULE, WHEN=N1 EQ 9, $
DEFMACRO=COND0006, MACTYPE=RULE, WHEN=N1 EQ 11, $
DEFMACRO=COND0007, MACTYPE=RULE, WHEN=N1 EQ 13, $
DEFMACRO=COND0008, MACTYPE=RULE, WHEN=N1 EQ 15, $
DEFMACRO=COND0009, MACTYPE=RULE, WHEN=N1 EQ 17, $
DEFMACRO=COND0010, MACTYPE=RULE, WHEN=N1 EQ 19, $



TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(234 234 234), MACRO=COND0001, $
TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(234 234 234), MACRO=COND0002, $
TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(234 234 234), MACRO=COND0003, $
TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(234 234 234), MACRO=COND0004, $
TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(234 234 234), MACRO=COND0005, $
TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(234 234 234), MACRO=COND0006, $
TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(234 234 234), MACRO=COND0007, $
TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(234 234 234), MACRO=COND0008, $
TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(234 234 234), MACRO=COND0009, $
TYPE=DATA, COLUMN=N2, BACKCOLOR=RGB(234 234 234), MACRO=COND0010, $




TYPE=REPORT, IMAGE=HtlSavings.GIF,POSITION=(0.1 0.1), SIZE=(10.75 .75), $
-IF &&SKIPGRAPH EQ 'Y' OR &G_DADV1 EQ 'N' GOTO SKIP_DGAT1;
TYPE=REPORT,IMAGE=HRSN.SVG,POSITION=(0.1  1.0), SIZE=(5.0 2.0), $
-SKIP_DGAT1
-IF &&SKIPGRAPH EQ 'Y' OR &G_DADV2 EQ 'N' GOTO SKIP_DGAT2;
TYPE=REPORT,IMAGE=HSAV.SVG, POSITION=(0.1  3.3), SIZE=(5.2 2.2), $
-SKIP_DGAT2
-IF &&SKIPGRAPH EQ 'Y' OR &G_DADV3 EQ 'N' GOTO SKIP_DGAT3;
TYPE=REPORT,IMAGE=HPTR.SVG, POSITION=(0.1  5.8), SIZE=(5.2 2.2), $
-SKIP_DGAT3
TYPE=SUBTOTAL, SIZE=9, STYLE=BOLD,  $
TYPE=GRANDTOTAL, SIZE=9, STYLE=BOLD, $
TYPE=REPORT,GRID=OFF, $
ENDSTYLE
END
-RUN


-NoHTLData

