-* File DELDATA.FEX
-* THIS PROGRAM DELETES DATA FOR A CERTAIN TIME PERIOD FROM
-* AIR, CAR, HOTEL, SEGMENT, MARKET, DESTINATION, TKT_MAIN
-*
-* 07/27/15 - DEB - S-10299 COMMENTED OUT SET &ECHO=ALL

-*-SET &ECHO=ALL

-SET &&QTR = '3';


-* -GOTO STOP

COPY D:\TNT\TTRACKER\SUDATA\ROLLUP.* D:\STEVE\PURGE\NEW\
END


USE
D:\STEVE\PURGE\NEW\ROLLUP.FOC AS ROLLUP
END

TABLE FILE ROLLUP
PRINT ROLLUP PR_STAMP
BY ROLLUP NOPRINT
ON TABLE HOLD
END
-RUN

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP=' ';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END

TABLE FILE ROLLUP
PRINT ROLLUP
      PR_STAMP
      COMP
BY ROLLUP NOPRINT
WHERE UPD_ENABLE EQ 'X'
WHERE QTR_ENABLE EQ 'X'
WHERE ROLLUP NE 'TOTAL-R'
WHERE ROLLUP NE 'USG-R'
ON TABLE HOLD
END
-RUN

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP='W';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END

-PRGLOOP
USE
D:\STEVE\PURGE\NEW\ROLLUP.FOC AS ROLLUP
END

TABLE FILE ROLLUP
PRINT ROLLUP COMP
BY ROLLUP NOPRINT
-* WHERE RECORDLIMIT EQ 1
WHERE PR_STAMP EQ 'W'
ON TABLE SAVE AS CUSTS
END
-RUN


-IF &RECORDS EQ 0 GOTO STOP;
-RUN
-READ CUSTS &&ROLLUP.A8 &&COMP.A6.
-RUN

-SET &&COPYF = 'D:\TNT\TTRACKER\DATA\*'||&&QTR||&&COMP|||'.FOC';
-SET &&COPYM = 'D:\TNT\TTRACKER\DATA\*'||&&QTR||&&COMP|||'.MAS';
-* -SET &&COPYOLD = 'D:\STEVE\PURGE\OLD\';
-SET &&COPYNEW = 'D:\STEVE\PURGE\NEW\';

-* COPY &&COPYF &&COPYOLD
-* COPY &&COPYM &&COPYOLD
COPY &&COPYF &&COPYNEW
COPY &&COPYM &&COPYNEW

TABLE FILE ROLLUP
PRINT ROLLUP
      PR_STAMP
BY ROLLUP NOPRINT
WHERE ROLLUP EQ '&&ROLLUP'
ON TABLE HOLD
END
MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP='Z';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN


-SET &&PRGSEG = 'D:\STEVE\PURGE\NEW\'||'S' || &&QTR || &&COMP;
-SET &&PRGMKT = 'D:\STEVE\PURGE\NEW\'||'M' || &&QTR || &&COMP;
-SET &&PRGDST = 'D:\STEVE\PURGE\NEW\'||'D' || &&QTR || &&COMP;
-SET &&PRGAIR = 'D:\STEVE\PURGE\NEW\'||'A' || &&QTR || &&COMP;
-SET &&PRGCAR = 'D:\STEVE\PURGE\NEW\'||'C' || &&QTR || &&COMP;
-SET &&PRGHTL = 'D:\STEVE\PURGE\NEW\'||'H' || &&QTR || &&COMP;
-SET &&PRGTKT = 'D:\STEVE\PURGE\NEW\'||'T' || &&QTR || &&COMP;

-TYPE PRGSEG &&PRGSEG
-TYPE PRGMKT &&PRGMKT
-TYPE PRGDST &&PRGDST
-TYPE PRGAIR &&PRGAIR
-TYPE PRGCAR &&PRGCAR
-TYPE PRGHTL &&PRGHTL
-TYPE PRGTKT &&PRGTKT

SET ASNAMES=ON
DEFINE FILE ROLLUP
XL01/A1 = 'Z' ;
END
TABLE FILE ROLLUP
BY ROLLUP NOPRINT
PRINT ROLLUP AS 'ROLLUP_CODE'
      XL01   AS 'PR_STAMP'
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE HOLD
END
MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
-* -GOTO PRGLOOP
-* -RUN
-*======================================================================

-* -STOP
-* -GOTO XXIT;
-* The date range in this file should be the date range you want to delete


TABLE FILE &&PRGSEG
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR TRN_DATE
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
-* WHERE (TRN_DATE GE '20081001') AND (TRN_DATE LE '20081026')
-* WHERE TRN_DATE GE '20081031'
WHERE TRN_DATE LT '20100701'
ON TABLE HOLD AS SHOLD
END
-RUN


-* The date range in this file is all METX data outside of the data being deleted above

TABLE FILE &&PRGSEG
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
WHERE (TRN_DATE GE '20100701') AND (TRN_DATE LE '20100930')  
ON TABLE HOLD AS SHOLD2
END
-RUN


-* Match these two files together getting everything in the original file that is not in the new file 

MATCH FILE SHOLD
PRINT AIR_KEY TRN_DATE
BY AIR_KEY NOPRINT
RUN
FILE SHOLD2
PRINT AIR_KEY
BY AIR_KEY NOPRINT
AFTER MATCH HOLD AS SHOLD3 OLD-NOT-NEW
END
-RUN

TABLE FILE SHOLD3
SUM TRN_DATE
BY AIR_KEY
ON TABLE HOLD AS SHOLD4
END
-RUN 

TABLE FILE SHOLD4
PRINT AIR_KEY 
BY AIR_KEY NOPRINT
ON TABLE HOLD AS SHOLD5
END
-RUN


-* AIR_MAIN
MODIFY FILE &&PRGAIR
FIXFORM FROM SHOLD5
MATCH AIR_KEY
ON MATCH DELETE
ON NOMATCH REJECT
DATA ON SHOLD5
END
-RUN

-* TKT_MAIN
MODIFY FILE &&PRGTKT
FIXFORM FROM SHOLD5
MATCH AIR_KEY
ON MATCH DELETE
ON NOMATCH REJECT
DATA ON SHOLD5
END
-RUN

-* SEGMENT
MODIFY FILE &&PRGSEG
FIXFORM FROM SHOLD
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH DELETE
ON NOMATCH REJECT
DATA ON SHOLD
END
-RUN

TABLE FILE &&PRGMKT
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
WHERE TRN_DATE LT '20100701'
ON TABLE HOLD AS MHOLD
END
-RUN

-* MARKET
MODIFY FILE &&PRGMKT
FIXFORM FROM MHOLD
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH DELETE
ON NOMATCH REJECT
DATA ON MHOLD
END
-RUN

TABLE FILE &&PRGDST
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
WHERE TRN_DATE LT '20100701'
ON TABLE HOLD AS DHOLD
END
-RUN

-* DESTINATION
MODIFY  FILE &&PRGDST
FIXFORM FROM DHOLD
MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
ON MATCH DELETE
ON NOMATCH REJECT
DATA ON DHOLD
END
-RUN

-CAR

-* CAR

TABLE FILE &&PRGCAR
PRINT CAR_KEY
BY CAR_KEY NOPRINT
WHERE INVOICE_DATE LT '20100701'
ON TABLE HOLD AS CHOLD
END
-RUN

MODIFY FILE &&PRGCAR
FIXFORM FROM CHOLD
MATCH CAR_KEY
ON MATCH DELETE
ON NOMATCH REJECT
DATA ON CHOLD
END
-RUN

-* HOTEL

TABLE FILE &&PRGHTL
PRINT HTL_KEY
BY HTL_KEY NOPRINT
WHERE INVOICE_DATE LT '20100701'
ON TABLE HOLD AS HHOLD
END
-RUN

MODIFY FILE &&PRGHTL
FIXFORM FROM HHOLD
MATCH HTL_KEY
ON MATCH DELETE
ON NOMATCH REJECT
DATA ON HHOLD
END
-RUN

SET ASNAMES=ON
DEFINE FILE ROLLUP
XL01/A1 = 'Z' ;
END
TABLE FILE ROLLUP
BY ROLLUP NOPRINT
PRINT ROLLUP AS 'ROLLUP_CODE'
      XL01   AS 'PR_STAMP'
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE HOLD
END
MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
-GOTO PRGLOOP
-RUN
-*======================================================================

-STOP
-GOTO XXIT

-XXIT
-EXIT
