-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-INCLUDE SETECHO
-* File EUR_ALVL.fex
-* 02/04/2014 - GSE - Changed TABLE against CR_HIER to call 
-*                    ROLLUP_HIERARCHY_LEVELS
-**********************************************************************

SET ASNAMES=ON
-*SET TEMPERASE=OFF



CREATE FILE AIR_LVL
-RUN


USE CLEAR *
-RUN 

TABLE FILE AIRHOLD
SUM AIR_KEY TKT_NUM LEVEL1 LEVEL2 LEVEL3
BY AIR_KEY NOPRINT
ON TABLE HOLD
END
-RUN

TABLE FILE HOLD
PRINT AIR_KEY TKT_NUM LEVEL1 AS 'LEVEL'
WHERE LEVEL1 NE ' '
ON TABLE HOLD AS LVL1 FORMAT FOCUS INDEX AIR_KEY
END
-RUN

TABLE FILE HOLD
PRINT AIR_KEY TKT_NUM LEVEL2 AS 'LEVEL'
WHERE LEVEL2 NE ' '
ON TABLE HOLD AS LVL2 FORMAT FOCUS INDEX AIR_KEY
END
-RUN

TABLE FILE HOLD
PRINT AIR_KEY TKT_NUM LEVEL3 AS 'LEVEL'
WHERE LEVEL3 NE ' '
ON TABLE HOLD AS LVL3 FORMAT FOCUS INDEX AIR_KEY
END
-RUN



-SET &HLDPATH=TEMPPATH(50,'A50');
-SET &HNKA=&HLDPATH || 'LVL1.FOC';
-SET &HNKB=&HLDPATH || 'LVL2.FOC';
-SET &HNKC=&HLDPATH || 'LVL3.FOC';

 
-SET &FILENAME = 'LVL1'; 
-RUN

-DOS STATE &HNKA
-SET &HOLDFILE1 = IF &RETCODE.EVAL EQ 0 THEN &HNKA | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKB
-SET &HOLDFILE2 = IF &RETCODE.EVAL EQ 0 THEN &HNKB | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKC
-SET &HOLDFILE3 = IF &RETCODE.EVAL EQ 0 THEN &HNKC | ' AS ' | &FILENAME ELSE ' ';





USE ADD 
&HOLDFILE1
&HOLDFILE2
&HOLDFILE3
END


DEFINE FILE LVL1
LVL/A15 = GETTOK (LEVEL, 15, 1, '*', 15, LVL);
PCT/A15 = GETTOK (LEVEL, 15, -1, '*', 15, PCT);
END
TABLE FILE LVL1
PRINT TKT_NUM LEVEL LVL AS 'LEVEL05' PCT LVL
BY LEVEL NOPRINT
ON TABLE HOLD AS LDATA
END
-RUN


-SET &ARCNT = &LINES;



TABLE FILE ROLLUP_HIERARCHY_LEVELS
PRINT 
      LEVEL5 AS LEVEL05
      LEVEL4 AS LEVEL04 
      LEVEL3 AS LEVEL03
BY LEVEL5 NOPRINT
WHERE ROLLUP_CODE EQ 'EURA-R'
ON TABLE HOLD AS CDATA
END
-RUN


MATCH FILE LDATA
PRINT TKT_NUM LEVEL PCT LVL
BY LEVEL05 NOPRINT
RUN
FILE CDATA
SUM LEVEL03 LEVEL04 LEVEL05
BY LEVEL05 NOPRINT
AFTER MATCH HOLD AS MATCHD OLD 
END
-RUN


-* Remove records with blank Level05 
-* add to AIR_LVL FILE


TABLE FILE MATCHD
PRINT TKT_NUM LEVEL PCT LVL LEVEL03 LEVEL04 LEVEL05
BY TKT_NUM NOPRINT
BY LEVEL NOPRINT
WHERE LEVEL05 NE ' '
ON TABLE HOLD AS LDATA2
END
-RUN

-SET &LVLLMT = IF &LINES EQ &ARCNT THEN 'Y' ELSE 'N';


MODIFY FILE AIR_LVL
FIXFORM FROM LDATA2
MATCH TKT_NUM LEVEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON LDATA2
END
-RUN

-IF &LVLLMT EQ 'Y' THEN GOTO NOMORE;

-* Hold records with blank Level05


TABLE FILE MATCHD
PRINT TKT_NUM LEVEL LVL AS 'LEVEL04' PCT LVL
BY LEVEL04 NOPRINT
WHERE LEVEL05 EQ ' '
ON TABLE HOLD AS LDATA3
END
-RUN


TABLE FILE ROLLUP_HIERARCHY_LEVELS
PRINT 
      LEVEL5 AS LEVEL05
      LEVEL4 AS LEVEL04 
      LEVEL3 AS LEVEL03
BY LEVEL4 NOPRINT
WHERE ROLLUP_CODE EQ 'EURA-R'
ON TABLE HOLD AS CDATA2
END
-RUN

MATCH FILE LDATA3
PRINT TKT_NUM LEVEL PCT LVL
BY LEVEL04 NOPRINT
RUN
FILE CDATA2
SUM LEVEL03 LEVEL04 LEVEL05
BY LEVEL04 NOPRINT
AFTER MATCH HOLD AS MATCHD2 OLD-AND-NEW 
END
-RUN

-*  Remove records with blank Level04 
-* add to AIR_LVL FILE


TABLE FILE MATCHD2
PRINT TKT_NUM LEVEL PCT LVL LEVEL03 LEVEL04 LEVEL05
BY TKT_NUM NOPRINT
BY LEVEL NOPRINT
WHERE LEVEL04 NE ' '
ON TABLE HOLD AS LDATA4
END
-RUN

MODIFY FILE AIR_LVL
FIXFORM FROM LDATA4
MATCH TKT_NUM LEVEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON LDATA4
END
-RUN


-* Hold records with blank Level04


TABLE FILE MATCHD
PRINT TKT_NUM LEVEL LVL AS 'LEVEL03' PCT LVL
BY LEVEL03 NOPRINT
WHERE LEVEL04 EQ ' '
ON TABLE HOLD AS LDATA5
END
-RUN


TABLE FILE ROLLUP_HIERARCHY_LEVELS
PRINT 
      LEVEL5 AS LEVEL05
      LEVEL4 AS LEVEL04 
      LEVEL3 AS LEVEL03
BY LEVEL3 NOPRINT
WHERE ROLLUP_CODE EQ 'EURA-R'
ON TABLE HOLD AS CDATA3
END
-RUN

MATCH FILE LDATA5
PRINT TKT_NUM LEVEL PCT LVL
BY LEVEL03 NOPRINT
RUN
FILE CDATA3
SUM LEVEL03 LEVEL04 LEVEL05
BY LEVEL03 NOPRINT
AFTER MATCH HOLD AS MATCHD3 OLD-AND-NEW 
END
-RUN

TABLE FILE MATCHD3 
PRINT TKT_NUM LEVEL PCT LVL LEVEL03 LEVEL04 LEVEL05
BY TKT_NUM NOPRINT
WHERE LEVEL03 NE ' '
ON TABLE HOLD AS LDATA6
END
-RUN

-* Add records to AIR_LVL



MODIFY FILE AIR_LVL
FIXFORM FROM LDATA6
MATCH TKT_NUM LEVEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON LDATA6
END
-RUN

 

-NOMORE 
 
