-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File HTLTKT.FEX
-********************************************************************
-* MODIFICAIONS:
-********************************************************************
-*
-* This program extracts data for the series of basic hotel location listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-* 5/18/04 - DEB - ADDED AIRLINE_FEE PER MONICA COLLIGAN
-* 10/05/04 - jk no changes...just testing by stopping the program
-* 10/08/04 - DV - ADDED LEVEL1 LEVEL2 LEVEL3
-* 12/15/04 - DV - ADDED FILEDEF CODE FOR FUJI REPORT
-* 01/04/05 - DV - ADDED CODE FOR GLOBAL CURRENCY
-* 08/11/05 - DV - REMOVED WHERE TKT_NUM NE '0000000000'
-*                 AND WHERE CITY2 EQ 'CA'
-* 10/10/05 - DV - ADDED GEO_ZONE
-* 7/30/14 - JK - ADDED LOGIC FOR NEW HDR REPORT BY JOB NUMBER
-* 8/12/14 - JK - Stopped hold files to test with HDR issue 
-*10/2/14 - DV - Removed quit statement 
-* 1/30/15 - DEB - S-07122 ADDED ROUTINE FOR LWACHTVR
-*3/2/16 - JEM -S-16367 Updated hard coded d:\ to use &&WFSRV1.EVAL
-*10/10/16-JEM-S-25670 Updated AMJOB logic to correct report error 
-*4/26/2017-JEM-S-33318-updated logic for no records report

-********************************************************************
-INCLUDE SETECHO 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN


-IF &&SETF EQ 'DTNACHD' OR 'CMPACHD' THEN GOTO SkipIt;

FI FUTKTLST DISK &&WFSRV1.EVAL\TNT\TTRACKER\TEMP\FUTKTLST.TXT

-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';

DEFINE FILE &&EXTRACT
  BLANK4/A4 ='    ';
  BLANK3/D12.2CS = IF HTL_MAIN.CONTRACT_RATE GT 0 THEN 0 ELSE 0;
  BLANK/A4 = '    ';
  BLANK1/A11 = '           ';
  NEW_ADV_PUR/D9CS = 0;
  LEVEL_DESC/A60 = &&LDESC;
  SEG/A2= '  ';
  CITY_ST/A35 = PROP_CITY||(', '| PROP_STATE);
  IN_DATE/MDYY = CHKIN_DATE;
  INV_DATE/MDYY = INVOICE_DATE;
  NBR_DAYS/D12 =  NUM_DAYS; 
  NNROOMS/D12 = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
  NEW_TOTAL_AMT/D12.2CS = TOTAL_AMT;
  OUT_DATE/MDYY = CHKOUT_DATE;
  PRP_CITY/A25 = PROP_CITY;
  PRP_ST/A25 = PROP_STATE_CD;
  TRIP_PURPOSE/A2 = ' ';
  
  
END
-RUN

TABLEF FILE &&EXTRACT
PRINT HTL_KEY
  BLANK3 AS 'FEE'
  BLANK AS 'TYPE'
  BLANK1 AS 'TSORT'
  BLANK4 AS 'AIRT'
  CURR_DATE
  PRP_CITY AS 'CITY1'
  PRP_ST AS 'CITY2' 
  IN_DATE AS 'DATE'
  INV_DATE AS 'TRAN_DATE'
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
-*   NEW_TOTAL_AMT AS 'AMOUNT'
  NEW_ADV_PUR
  NEW_TOTAL_AMT
  NNROOMS AS 'TTL_COUNT'
  SEG
  PASSNGR_NAME
  PNR_LOCATOR
  PROP_NAME AS 'NAME'
  TKT_NUM 
  TRIP_PURPOSE
  CITY.GEO_ZONE AS 'GEO_ZONE'

-INCLUDE &HTLDATES 

-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-* &&WHERE1
-* &&WHERE2
-* &&WHERE3
-* &&WHERE4
-* &&WHERE5
-* &&WHERE6
-* &&WHERE7
-* &&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS
ON TABLE HOLD AS &&RPT_HOLD3
END
-RUN


-SET &&REPTTYPE = 'HTL';
-INCLUDE RETUDID2
-RUN

DEFINE FILE &&RPT_HOLD3
GEO_ZONE/A3 = IF GEO_ZONE EQ ' ' THEN 'USA' ELSE GEO_ZONE;
END

TABLE FILE &&RPT_HOLD3
PRINT HTL_KEY
  FEE
  TYPE
  TSORT
  CITY1
  CITY2 
  DATE
  AIRT
  TRAN_DATE
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  NEW_TOTAL_AMT
  TTL_COUNT
  SEG
  PASSNGR_NAME
  PNR_LOCATOR
  NAME
  TKT_NUM
  NEW_ADV_PUR
  GEO_ZONE
  TRIP_PURPOSE
BY CURR_DATE
ON TABLE HOLD AS HTLHOLD1 FORMAT FOCUS INDEX CURR_DATE
END
-RUN


-* Global Reporting JOIN
JOIN HTLHOLD1.CURR_DATE IN HTLHOLD1 TO GLOBAL.DATE IN GLOBAL AS J1
END

DEFINE FILE HTLHOLD1
NAMEC/A30 = CNAME;


-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
AMT_TOTALX/D20.6 = NEW_TOTAL_AMT * CURR1X;
FEEX/D20.6 = FEE * CURR1X;

END

TABLE FILE HTLHOLD1
PRINT HTL_KEY
  CURR_DATE
  FEE
  FEEX/D16.2CS
  TYPE
  TSORT
  CURR_DATE
  CITY1
  CITY2 
  DATE
  AIRT
  TRAN_DATE
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  NEW_TOTAL_AMT AS 'AMOUNT'
  AMT_TOTALX/D16.2CS AS 'GAMOUNT'
  TTL_COUNT
  SEG
  PASSNGR_NAME
  PNR_LOCATOR
  NAME
  TKT_NUM
  NAMEC
  NEW_ADV_PUR
  GEO_ZONE
  TRIP_PURPOSE
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS HTLHLD2
END
-RUN
  
TABLE FILE HTLHLD2
PRINT  
  CURR_DATE
  FEE
  FEEX 
  TYPE
  TSORT
  CURR_DATE
  CITY1
  CITY2 
  DATE
  AIRT
  TRAN_DATE
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  AMOUNT 
  GAMOUNT
  TTL_COUNT
  SEG
  PASSNGR_NAME
  PNR_LOCATOR
  NAME
  TKT_NUM
  NAMEC
  NEW_ADV_PUR
  GEO_ZONE
  TRIP_PURPOSE
BY HTL_KEY
ON TABLE HOLD AS HTLHLD3 FORMAT FOCUS INDEX HTL_KEY
END
-RUN

-IF '&&SETF.EVAL' EQ 'AMJOBACH' GOTO AMJOB;
-IF '&&SETF.EVAL' EQ 'HDJOBACH' GOTO HDJOB;
-IF '&&SETF.EVAL' EQ 'LWACHTVR' GOTO LWTVR;


TABLE FILE UDIDHOLD
PRINT PRN
BY HTL_KEY
ON TABLE HOLD AS UDIDHOLD2
END
-RUN
 

-IF &LINES EQ 0 THEN GOTO NOHudid;

JOIN HTL_KEY IN HTLHLD3 TO HTL_KEY IN UDIDHOLD2 AS J3
    

DEFINE FILE HTLHLD3
PROJ_NBR/A64 = PRN;
PRJ_NBR/A10 = EDIT(PROJ_NBR, '9999999999');
FLAG/A1 = 'H';
END

TABLE FILE HTLHLD3
PRINT  
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TSORT 
  TYPE
  SEG    
  NAME
  DATE
  AIRT
  CITY1
  CITY2
  AMOUNT
  GAMOUNT
  FEE
  FEEX  
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NAMEC
  NEW_ADV_PUR
  GEO_ZONE
  TRIP_PURPOSE
  PRJ_NBR
BY FLAG
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN
-GOTO XXITHTL;

-AMJOB;

TABLE FILE &HTLUDID
SUM UDID
BY UDID
IF UDID EQ 'JOB'
ON TABLE HOLD AS HTLUDID
END


-IF &RECORDS EQ 0 GOTO NOHudidam;

TABLE FILE UDIDHOLD
PRINT JOB
BY HTL_KEY
ON TABLE HOLD AS UDIDHOLD2
END
-RUN

-IF &LINES EQ 0 THEN GOTO NOHudid;

JOIN HTL_KEY IN HTLHLD3 TO HTL_KEY IN UDIDHOLD2 AS J3
    

DEFINE FILE HTLHLD3
JOB_NBR/A64 = JOB;
FLAG/A1 = 'H';
END

TABLE FILE HTLHLD3
PRINT  
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TSORT 
  TYPE
  SEG    
  NAME
  DATE
  AIRT
  CITY1
  CITY2
  AMOUNT
  GAMOUNT
  FEE
  FEEX  
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NAMEC
  NEW_ADV_PUR
  GEO_ZONE
  TRIP_PURPOSE
  JOB_NBR
BY FLAG
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN



-GOTO XXITHTL;

-HDJOB;

TABLE FILE UDIDHOLD
PRINT JB1 JB2 JB3 JB4
BY HTL_KEY
ON TABLE HOLD AS UDIDHOLD2
END
-RUN

-IF &RECORDS EQ 0 GOTO NOHudidam;

JOIN HTL_KEY IN HTLHLD3 TO HTL_KEY IN UDIDHOLD2 AS JH1
-RUN
    

DEFINE FILE HTLHLD3
JB1X/A25 = EDIT(JB1, '9999999999999999999999999');
JB2X/A25 = EDIT(JB2, '9999999999999999999999999');
JB3X/A25 = EDIT(JB3, '9999999999999999999999999');
JB4X/A25 = EDIT(JB4, '9999999999999999999999999');
SPC/A1 = IF JB1X EQ ' ' OR JB2X EQ ' ' OR JB3X EQ ' ' THEN ' ' ELSE '-';             
JOB_NUM/A105 = JB1X||SPC||JB2X||SPC||JB3X||SPC||JB4X; 
FLAG/A1 = 'H';
END

TABLE FILE HTLHLD3
PRINT  
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TSORT 
  TYPE
  SEG    
  NAME
  DATE
  AIRT
  CITY1
  CITY2
  AMOUNT
  GAMOUNT
  FEE
  FEEX  
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NAMEC
  NEW_ADV_PUR
  GEO_ZONE
  TRIP_PURPOSE
  JOB_NUM
BY FLAG
WHERE JOB_NUM NE ' '
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN

-GOTO XXITHTL;


-NOHudid;
 
TABLE FILE HTLHLD2
PRJ_NBR/A10 = '          ';
FLAG/A1 = 'H';
END
TABLE FILE HTLHLD2
PRINT  
  CURR_DATE
  FEE
  FEEX 
  TYPE
  TSORT
  CURR_DATE
  CITY1
  CITY2 
  DATE
  AIRT
  TRAN_DATE
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  AMOUNT 
  GAMOUNT
  TTL_COUNT
  SEG
  PASSNGR_NAME
  PNR_LOCATOR
  NAME
  TKT_NUM
  NAMEC
  NEW_ADV_PUR
  GEO_ZONE
  TRIP_PURPOSE
BY FLAG
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN
-GOTO XXITHTL;

-NOHudidam;
 
DEFINE FILE HTLHLD2
PRJ_NBR/A10 = '          ';
JOB_NBR/A10 = '          ';
FLAG/A1 = 'H';
END
TABLE FILE HTLHLD2
PRINT  PASSNGR_NAME
   PNR_LOCATOR
   TRAN_DATE
   TKT_NUM
   TSORT
   TYPE
   SEG
   NAME
   DATE
   AIRT
   CITY1
   CITY2
   AMOUNT
   GAMOUNT
   FEE
   FEEX
   TTL_COUNT
   LEVEL_DESC
   LEVEL1
   LEVEL2
   LEVEL3
   NAMEC
   NEW_ADV_PUR
   GEO_ZONE
   TRIP_PURPOSE
   PRJ_NBR  
   JOB_NBR
BY FLAG 
BY FLAG
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN
-GOTO XXITHTL;
   
-LWTVR


TABLE FILE UDIDHOLD
PRINT TVR
BY HTL_KEY
ON TABLE HOLD AS UDIDHOLD2
END
-RUN
 

-IF &LINES EQ 0 THEN GOTO NOHudidL;


JOIN HTL_KEY IN HTLHLD3 TO HTL_KEY IN UDIDHOLD2 AS J3
    

DEFINE FILE HTLHLD3
TVLR_TYPE/A64 = TVR;
TVR_TYPE/A15 = EDIT(TVLR_TYPE, '999999999999999');
FLAG/A1 = 'H';
END

TABLE FILE HTLHLD3
PRINT  
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TSORT 
  TYPE
  SEG    
  NAME
  DATE
  AIRT
  CITY1
  CITY2
  AMOUNT
  GAMOUNT
  FEE
  FEEX  
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NAMEC
  NEW_ADV_PUR
  GEO_ZONE
  TRIP_PURPOSE
  TVR_TYPE
BY FLAG
WHERE TVR_TYPE NE ' '
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN

-GOTO XXITHTL

-NOHudidL

DEFINE FILE HTLHLD3
 
TVR_TYPE/A15 = '               ');
FLAG/A1 = 'H';
END

TABLE FILE HTLHLD3
PRINT  
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TSORT 
  TYPE
  SEG    
  NAME
  DATE
  AIRT
  CITY1
  CITY2
  AMOUNT
  GAMOUNT
  FEE
  FEEX  
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NAMEC
  NEW_ADV_PUR
  GEO_ZONE
  TRIP_PURPOSE
  TVR_TYPE
BY FLAG
WHERE TVR_TYPE NE ' '
ON TABLE HOLD AS HOLDH FORMAT FOCUS
END
-RUN

-XXITHTL;
-SET &&HTLREC=IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';

