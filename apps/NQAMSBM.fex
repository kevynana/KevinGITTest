-* **************************************************************
-* File Name: NQAMSBM.fex
-* Airline Market Share By Month - Quarterly Review
-* The report contains 13 month data with page break by airline.
-* LS 07/02/2006
-* **************************************************************
-INCLUDE SETECHO
-SET HOLDATTR = ON;
SET ASNAMES = ON

DEFINE FILE MR_50
COMM_SEG/D12.2S   = SEG_COM;
-* CP_CL_CAT/A8 = DECODE CL_CAT ('F' 'FIRST'     'C' 'COACH'   
-*                               'D' 'DISCOUNT'  'B' 'BUSINESS');

CP_CL_CAT/A15 = DECODE CL_CAT ('F' 'FIRST'     'P' 'PREMIUM ECONOMY'   
		               'D' 'DEFAULT'   'B' 'BUSINESS'
		               'E' 'ECONOMY'   'U'  'UPGRADE' 
                               ' ' 'DEFAULT');   

DIR_CITY_CD/A50 = EMB_CTY.EMB_CITY || '-' || RTE_CTY.RTE_CITY;                                                            
DIR_CITY_NM/A50 = EMB_CTY.CITY_NAME | RTE_CTY.CITY_NAME; 
DIR_CP_CD/A50 = CITYPAIR.EMBARK || '-' || CITYPAIR.ROUTE;
DIR_CP_NM/A50 = EMB_APT.AIRPORT_NAME | RTE_APT.AIRPORT_NAME;
EMB_APT/A21=EDIT(NDO_APT.AIRPORT_NAME,'999999999999999999999$$$$');
FARE_PAID/D12.2S  = SEG_AMT;

-*KILO/D9      = CITYPAIR.SEG_MILES * 1.60934 ;  

ND_CITY_CD/A50 = NDO_CTY.NDO_CITY || '-' || NDD_CTY.NDD_CITY;
ND_CITY_NM/A50 = NDO_CTY.CITY_NAME | NDD_CTY.CITY_NAME;
ND_CP_CD/A50  = NDO_APT.ND_ORG || '-' || NDD_APT.ND_DST;
NET_COMM/D12.2S = (SEG_AMT - SEG_COM);
NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (EX_FLAG NE ' ') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (RF_FLAG NE ' ') THEN (-1) ELSE 0;
NET_FARE/D12.2S  = IF (EX_FLAG EQ ' ') AND (RF_FLAG EQ ' ')
                         THEN SEG_AMT ELSE 0;
NEW_SEG_COUNT/D8CS = SEG_COUNT;
RTE_APT/A21=EDIT(NDD_APT.AIRPORT_NAME,'999999999999999999999$$$$');
TOTAL_FARE/D12.2S = SEG_AMT + SEG_TAX;
VASAVINGS/D11.2CS = SEG_DISCOUNT - TOTAL_FARE;
XPSNGR_NM/A15 = EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
XTRAN_DT/MDYY = TRN_DATE;
TRAN_MYA/I6MTYY = TRN_DATE;
TRAN_MY/MTYY = TRN_DATE;

-* ****DEFINES ON PREVIOUS DEFINES****
DISSAVINGS/D11.2CS= IF EMBARK EQ 'DT1' THEN 0 ELSE
                         TOTAL_FARE - SEG_LOWEST;
ND_CP_NM/A50 = EMB_APT|'        '|RTE_APT;
ORGDST/A50 = &&ORGDST;
SAVINGS/D11.2CS   = SEG_STANDARD - TOTAL_FARE;  
 
END
-RUN

TABLEF FILE MR_50
PRINT 
  AIR_KEY   
  AIRLINE   
  AIRLINE.AIRLINE AS 'AIR_LINE' 
  AIRLINE.AIRLINE_NAME  
  AR_BRANCH
  CITYPAIR.AIRLINE AS 'CP_AIRLINE'  
  CITYPAIR.CLASS AS 'CP_CLASS'  
  CITYPAIR.INTL_DOM AS 'INTL_DOM'   
  CITYPAIR.SEG_MILES/D9C AS 'MILES' 
  CLASS 
  CLS_CAT.CAT_DESC AS 'CAT_DESC'    
  COMM_SEG  
  CP_CL_CAT 
  DISSAVINGS    
  DOC_TYPE  
  EMB_APT   
  FARE_PAID AS 'CP_FARE_PD'

-*  KILO   
  ND_CP_CD  
  ND_CP_NM
  NDD_APT.ND_DST AS 'CP_RTE'    
  NDO_APT.ND_ORG AS 'CP_EMB'            
  NET_COMM
  NET_FARE  
  NET_TKT_CNT   
  NEW_SEG_COUNT 
  ORGDST    
  REFUSE_KEY    
  RTE_APT   
  SAVINGS   
  SEG_COUNT
  SEG_DESIG
  SEG_DISCOUNT  
  SEG_NBR
  TKT_NUM   
  TOTAL_FARE    
  TRN_DATE  
  TRAN_MY
  TRAN_MYA
  VASAVINGS     
  XPSNGR_NM 
  XTRAN_DT 
  TKT_DATE
-*BY TKT_DATE 
WHERE (TRN_DATE GE '&&FROMDT.EVAL') AND (TRN_DATE LE '&&TODT.EVAL')
WHERE VOID_DATE EQ 0  
-INCLUDE RPTPARMS
-* ON TABLE HOLD AS MKTSHRM FORMAT FOCUS INDEX TKT_DATE
ON TABLE HOLD AS MKTSHRM 
END
-RUN

-******************************************************************************
-*             Global Currency Conversion Defines - USD ONLY
-******************************************************************************
DEFINE FILE MKTSHRM
CURR1X/D20.6 = 1;
PAID_FAREX/D20.6 = CP_FARE_PD * CURR1X;
TOT_FAREX/D20.6 = TOTAL_FARE * CURR1X;
VASAVX/D20.6 = VASAVINGS * CURR1X;
SEG_DISCX/D20.6 = SEG_DISCOUNT * CURR1X;
END
    
-*TABLEF FILE MKTSHM
TABLEF FILE MKTSHRM
PRINT AIR_LINE
      COMM_SEG
      CP_FARE_PD
      CP_AIRLINE
-*      CP_FARE_PD AS 'GCP_FARE_PD'
-*      KILO
      MILES
      NET_COMM
      NET_TKT_CNT
      SEG_DISCOUNT
-*     SEG_DISCOUNT AS 'SEG_DISCX'
-*      SEG_DISCX/D16.2CS
      TOTAL_FARE
-*      TOT_FAREX/D16.2CS
      TOTAL_FARE AS 'TOT_FAREX'
      VASAVINGS
-*      VASAVINGS AS 'VASAVX'
-*      VASAVX/D16.2CS
BY AIRLINE_NAME
BY TRAN_MY
ON TABLE HOLD AS HOLD1
END
-RUN

-*HOLD1 contains data of all airlines.
-***************************************************
-* get airlines selected from GUI
-***************************************************
TABLE FILE BRPTFLDS
BY AL_MS 
WHERE INST_KEY EQ &&IKEY
AND REVIEW.AL_MSM NE ' '
ON TABLE SAVE AS SAVEAL
END
-RUN

-SET &ALCNT = &LINES;
-SET &CNT = 1;
-SET &ONLYONE = IF '&&OUTLINE2.EVAL' EQ 'FORMAT PDF OPEN' THEN 'N' ELSE 'Y';

-REPEAT TOALLAIRS &ALCNT TIMES
-READ SAVEAL NOCLOSE &AL.2.

-SET &&OUTLINE2 = IF '&ONLYONE.EVAL' EQ 'N' THEN '&&OUTLINE2.EVAL'
- ELSE IF &CNT LT &ALCNT THEN 'FORMAT PDF OPEN' ELSE 'FORMAT PDF CLOSE';
-SET &CNT = &CNT + 1;

-SET &IMGCRRSHR  = '&AL.EVAL' || 'CRRSHR';
-SET &IMGCRRSHR2 = '&AL.EVAL' || 'CRRSHR.SVG';
-SET &IMGMKTSHR  = '&AL.EVAL' || 'MKTSHR';
-SET &IMGMKTSHR2 = '&AL.EVAL' || 'MKTSHR.SVG';

TABLE FILE HOLD1
SUM COMM_SEG AS 'TCOMM'
    CP_FARE_PD AS 'FARE'
-*    GCP_FARE_PD AS 'GFARE'
-*    KILO
    MILES
    NET_COMM AS 'NCOMM'
    NET_TKT_CNT AS 'TICK_SEG'
    SEG_DISCOUNT/D12.2CS AS 'SEG_DISC'
-*   SEG_DISCX/D16.2CS AS 'GSEG_DISC'
    TOTAL_FARE AS 'TFARE'
-*    TOT_FAREX/D16.2CS AS 'GTFARE'
    VASAVINGS AS 'VASAVE'
-*    VASAVX/D16.2CS AS 'GVASAVE'

BY AIRLINE_NAME
BY TRAN_MY

WHERE CP_AIRLINE EQ '&AL.EVAL' 

ON TABLE HOLD AS CPHOLD1 FORMAT ALPHA
END
-RUN

TABLE FILE CPHOLD1
PRINT AIRLINE_NAME
      FARE
-*      GFARE
-*      GSEG_DISC
-*      GTFARE
-*      GVASAVE
-*      KILO
      MILES
      NCOMM
      SEG_DISC
      TCOMM
      TFARE
      TICK_SEG
      VASAVE
BY TRAN_MY
-*WHERE AIRLINE_NAME NE ' '
ON TABLE HOLD AS CPHOLD2
END
-RUN


TABLE FILE HOLD1
SUM COMM_SEG AS 'ACOMM'
    CP_FARE_PD AS 'AFARE'
-*    GCP_FARE_PD AS 'GAFARE'
-*    KILO
    NET_COMM AS 'ANET'
    NET_TKT_CNT AS 'ATICK_SEG'
    SEG_DISCOUNT/D12.2CS AS 'ASEG_DISC'
-*    SEG_DISCX/D16.2CS AS 'GASEG_DISC'
    TOTAL_FARE AS 'ATFARE'
-*    TOT_FAREX/D16.2CS AS 'GATFARE'
    VASAVINGS AS 'AVASAVE'
-*    VASAVX/D16.2CS AS 'GAVASAVE'
BY AIRLINE_NAME
BY TRAN_MY

WHERE CP_AIRLINE NE '&AL.EVAL' 

ON TABLE HOLD AS CPHOLD3 FORMAT ALPHA
END
-RUN

TABLE FILE CPHOLD3
SUM AFARE
    ANET ACOMM
    ASEG_DISC
    ATFARE
    ATICK_SEG
    AVASAVE
-*    GAFARE
-*    GATFARE
-*    GAVASAVE
-*    GASEG_DISC
    AIRLINE_NAME
BY TRAN_MY
-*WHERE AIRLINE_NAME NE ' '
ON TABLE HOLD AS HOLD2
END
-RUN

MATCH FILE CPHOLD2
PRINT *
BY TRAN_MY
ON TABLE HOLD
RUN
FILE HOLD2
PRINT *
BY TRAN_MY

AFTER MATCH HOLD AS HOLD3 OLD-OR-NEW
END
-RUN

DEFINE FILE HOLD3
BASE_FARE/D12.2CS = AFARE + FARE;
END
-*-RUN

TABLE FILE HOLD3
SUM     TICK_SEG  
    COMPUTE TOT_SEG/I9C=TICK_SEG+ATICK_SEG;
    COMPUTE CRR_SHR/D6.1S=IF ((TOT_SEG LT 1) AND (TOT_SEG GT (-1))) 
                              THEN 0
                              ELSE ((TICK_SEG/TOT_SEG)*100);
        COMPUTE TAVG/D12.2CS = IF ((TOT_SEG LT 1) AND (TOT_SEG GT (-1))) 
                              THEN 0
                              ELSE (BASE_FARE/TOT_SEG);
        COMPUTE AAVG/D12.2CS = IF ((TICK_SEG LT 1) AND (TICK_SEG GT (-1))) 
                              THEN 0 
                              ELSE (FARE/TICK_SEG);
        
BY TRAN_MY
ON TABLE HOLD AS HOLD5
END
-RUN

TABLE FILE HOLD5
PRINT AAVG
      TICK_SEG
      TOT_SEG
      TAVG
      CRR_SHR
BY TRAN_MY 
ON TABLE HOLD AS HOLD4
END
-RUN

-SET &G_MKTSHR = 'N';
-SET &G_CRRSHR = 'N';

-SET &G_MKTSHR = IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-SET &G_CRRSHR = IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-IF &LINES EQ 0 THEN GOTO NOGRAPH2;

-IF &&SKIPGRAPH EQ 'Y' THEN GOTO NOGRAPH2;

-* Created by Graph Assist
GRAPH FILE HOLD4
SUM TOT_SEG AS 'Total Markets' TICK_SEG AS 'Airline Markets'  
    CRR_SHR AS 'Airline % Mkt'
BY TRAN_MY AS ' '
ON GRAPH SET LOOKGRAPH VBAR2AX
ON GRAPH SET BARNUMB OFF
ON GRAPH SET 3D OFF
ON GRAPH SET VZERO ON

ON GRAPH SAVE AS &IMGMKTSHR FORMAT SVG
-*ON GRAPH SAVE AS MKTSHR FORMAT SVG
ON GRAPH SET GRAPHSTYLE *
setMarkerDisplay(true);
setConnectLineMarkers(true);
setConnectScatterMarkers(true);
setO1LabelDisplay(true);
setO1AxisSide(0);
setO1MajorGridDisplay(false);
setO1MajorGridStyle(0);
setO1MinorGridDisplay(false);
setAxisAssignment(0,0);
setSeriesType(0,1);
setAxisAssignment(1,0);
setSeriesType(1,1);
setAxisAssignment(2,1);
setSeriesType(2,2);
setY1LabelDisplay(true);
setY1AxisSide(0);
setY1MajorGridDisplay(false);
setY1MinorGridDisplay(true);
setTextFormatPreset(getY1Label(),1);
setY2LabelDisplay(true);
setY2AxisSide(1);
setY2MajorGridDisplay(false);
setY2MinorGridDisplay(false);
setTextFormatPreset(getY2Label(),1);
setPieFeelerTextDisplay(1);
setPieLabelDisplay(0);
setTextFormatPreset(getPieSliceLabel(),1);
setRiserBorderMode(1);
setSeriesDefaultTransparentBorderColor(true);
setUseSeriesBorderDefaults(true);
setLegendDisplay(true);
setLegendPosition(2);
setLegendMarkerPosition(1);
setFontSizeAbsolute(getY1Title(),true);
setFontSizeAbsolute(getY1Label(),true);
setFontSizeAbsolute(getY2Title(),true);
setFontSizeAbsolute(getY2Label(),true);
setFontSizeAbsolute(getO1Title(),true);
setTextJustHoriz(getTitle(), 1);
setTitleString("Airline Markets and Percentage");
setFontSizeAbsolute(getTitle(),true);
setAutofit(getTitle(),false);
setFontSize(getTitle(),18);
setFontStyle(getTitle(),0);
setY2MustIncludeZero(true);
setSeriesFillColor(0, new Color, 0 2 224));
setSeriesFillColor(1, new Color, 145 174 211));
setSeriesFillColor(2, new Color, 255 255 0));
ENDSTYLE
END
-RUN
-SET &G_MKTSHR = IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-NOGRAPH1

-* Created by Graph Assist
GRAPH FILE HOLD4
SUM AAVG AS 'Airline Avg Mkt Cost' TAVG AS 'Total Avg Mkt Cost'
ACROSS TRAN_MY AS ' '
ON GRAPH SET BARNUMB OFF
ON GRAPH SET 3D OFF
ON GRAPH SET VZERO ON
ON GRAPH SAVE AS &IMGCRRSHR FORMAT SVG
-*ON GRAPH SAVE AS CRRSHR FORMAT SVG
ON GRAPH SET GRAPHSTYLE *
setGraphType(17);
setLegendDisplay(true);
setLegendPosition(2);
setLegendMarkerPosition(1);
setO1LabelDisplay(true);
setFontSizeAbsolute(getO1Label(),true); 
setAutofit(getO1Label(),false);
setFontStyle(getO1Label(),0);
setFontSize(getO1Label(),15);
setO1LabelRotate(2);
setO1MajorGridDisplay(false);
setO1MinorGridDisplay(false);
setFontSizeAbsolute(getY1Label(),true);
setAutofit(getY1Label(),false);
setY1LabelDisplay(true);
setY1MinorGridDisplay(true);
setFontSize(getY1Label(),15);
setFontStyle(getY1Label(),0);
setY1AxisSide(0);
setTextJustHoriz(getTitle(), 1);
setTitleString("Average Market Cost");
setFontSizeAbsolute(getTitle(),true);
setAutofit(getTitle(),false);
setFontSize(getTitle(),18);
setFontStyle(getTitle(),0);
setSubtitleString(" ");
setSeriesDefaultTransparentBorderColor(true);
setUseSeriesBorderDefaults(true);
setSeriesFillColor(0, new Color, 0 2 224));
setSeriesFillColor(1, new Color, 145 174 211));
ENDSTYLE
END
-RUN
-SET &G_CRRSHR = IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-NOGRAPH2

TABLE FILE AIRLINE
PRINT AIRLINE_NAME
WHERE AIRLINE EQ '&AL.EVAL'
ON TABLE SAVE
END
-RUN
-READ SAVE &AIRLINENAME.12.

-SET &FROMDATE = EDIT(&&FROMDT,'$$$$$99$$$') | '/' | EDIT(&&FROMDT,'$$$$$$$$99') | '/' | EDIT(&&FROMDT,'9999');
-SET &TODATE   = EDIT(&&TODT,'$$$$$99$$$') | '/' | EDIT(&&TODT,'$$$$$$$$99') | '/' | EDIT(&&TODT,'9999');

DEFINE FILE HOLD3
  BASE_FARE/D12.2CS = AFARE + FARE;
-*  GBASE_FARE/D16.2CS = GAFARE + GFARE;
  FARE_PAID/D12.2CS = ATFARE + TFARE;
-*  GFARE_PAID/D16.2CS = GATFARE + GTFARE;
  NET_FARE/D12.2CS = ANET + NCOMM;
  NET_MKTS/D8CS = ATICK_SEG + TICK_SEG;
  TOTAL_COMM/D12.2 = ACOMM + TCOMM;
  TOTAL_VASAV/D12.2 = AVASAVE + VASAVE;
-*  GTOT_VASAV/D16.2CS = GAVASAVE + GVASAVE;
  TOTAL_SEG_DISC/D12.2 = ASEG_DISC + SEG_DISC;
-*  TOT_SEG_DISCX/D16.2CS = GASEG_DISC + GSEG_DISC;
  SORT_FIRST/A1 = ' ';
  NOWTOD/A8 WITH TRAN_MY = HHMMSS (NOWTOD);
END
-RUN

TABLE FILE HOLD3
HEADING CENTER
"</2"
"&AIRLINENAME"
-*"Transaction Period: &FROMDATE - &TODATE"
" "
SUM TICK_SEG AS 'AIRLINE,MKTS'
COMPUTE TOT_SEG/I9C=TICK_SEG+ATICK_SEG; AS 'TOTAL,MKTS'
COMPUTE CRR_SHR/D6.1S=IF ((TOT_SEG LT 1) AND (TOT_SEG GT (-1))) THEN 0 
    ELSE ((TICK_SEG/TOT_SEG)*100); AS 'AIRLINE,% OF MKT'
-*GFARE/D16.2CS AS 'AIRLINE,BASE,FARE'
-*COMPUTE TOT_REV/D16.2S=GFARE+GAFARE; AS 'TOTAL,BASE,FAR'
-*GFARE/D16CS AS 'AIRLINE,BASE,FARE'
-* COMPUTE TOT_REV/D16S=GFARE+GAFARE; AS 'TOTAL,BASE,FARE'
COMPUTE TOT_REV/D16S=FARE+AFARE; AS 'TOTAL,BASE,FARE'

COMPUTE CR_PR/D6.1S=IF ((TOT_REV LT 1) AND (TOT_REV GT (-1))) THEN 0 
    ELSE ((FARE/TOT_REV)*100); AS ' AIRLINE,% OF BASE,FARE'
COMPUTE CR_AVG/D16S=IF ((TICK_SEG LT 1) AND (TICK_SEG GT (-1))) THEN 0 
    ELSE FARE/TICK_SEG; AS 'AIRLINE,AVG MKT,COST'
COMPUTE TOT_AVG/D14S=IF ((TOT_SEG LT 1) AND (TOT_SEG GT (-1))) THEN 0
    ELSE TOT_REV/TOT_SEG; AS 'TOTAL,AVG MKT,COST'
-*COMPUTE CR_KILO/D12.2S=IF ((KILO LT 1) AND (KILO GT (-1))) THEN 0 
-*  ELSE FARE/KILO; AS 'AIRLINE,CPM'

COMPUTE CR_CPM/D12.2S=IF ((MILES LT 1) AND (MILES GT (-1))) THEN 0 
    ELSE FARE/MILES; AS 'AIRLINE,CPM'

VASAVE/D16CS AS 'AIRLINE,CONTRACT,SAVINGS'
COMPUTE CR_PVA/D6.1S=IF ((SEG_DISC LT 1) AND (SEG_DISC GT (-1))) THEN 0 
    ELSE ((VASAVE/SEG_DISC)*100); AS 'AIRLINE,CONTRACT,SAVINGS %'
   
BY SORT_FIRST NOPRINT
BY TRAN_MY AS 'MONTH'
ON SORT_FIRST RECOMPUTE MULTILINES AS 'TOTAL';
ON TABLE NOTOTAL

ON TABLE SET PAGE OFF   
ON TABLE SET STYLE *
UNITS=IN, PAGESIZE='Letter', LEFTMARGIN=0.500000, RIGHTMARGIN=0.250000, 
    TOPMARGIN=0.500000, BOTTOMMARGIN=0.250000, SQUEEZE=ON, 
    ORIENTATION=LANDSCAPE, $
TYPE=REPORT, FONT=TIMES NEW ROMAN, SIZE=9, BACKCOLOR=NONE, STYLE=NORMAL, $
TYPE=REPORT, IMAGE=MarketShare.GIF,POSITION=(0.1 0.2), SIZE=(10.75 0.75), $

TYPE=HEADING, OBJECT=TEXT, SIZE=9, COLOR=BLACK, $
TYPE=HEADING, LINE=1, SIZE=15, STYLE=BOLD, COLOR=BLACK, $
TYPE=HEADING, LINE=2, SIZE=15, STYLE=BOLD, COLOR=BLACK, $
TYPE=HEADING, LINE=3, SIZE=15, STYLE=BOLD, COLOR=BLACK, $
TYPE=HEADING, LINE=4, SIZE=15,  STYLE=BOLD, COLOR=BLACK, $
TYPE=HEADING, LINE=5, SIZE=9,  STYLE=BOLD, COLOR=BLACK, $
TYPE=FOOTING, SIZE=8, STYLE=BOLD, COLOR=GREY, $
TYPE=TITLE, STYLE=BOLD, $
TYPE=SUBFOOT, SIZE=8, STYLE=BOLD, $
TYPE=SUBTOTAL, SIZE=9, STYLE=BOLD, $
TYPE=GRANDTOTAL, SIZE=9, STYLE=BOLD, $

-IF &&SKIPGRAPH EQ 'Y' OR &G_MKTSHR EQ 'N' THEN GOTO SKIPMKT;
TYPE=REPORT, IMAGE=&IMGMKTSHR2, POSITION=(0.1 4.3), SIZE=(5.25 3.5), $
-SKIPMKT
-IF &&SKIPGRAPH EQ 'Y' OR &G_CRRSHR EQ 'N' THEN GOTO SKIPCRRSHR;
TYPE=REPORT, IMAGE=&IMGCRRSHR2, POSITION=(5.5 4.3), SIZE=(5.25 3.5), $
-SKIPCRRSHR
ENDSTYLE
&&OUTLINE1
&&OUTLINE2
END
-RUN

-TOALLAIRS
-CLOSE SAVEAL
