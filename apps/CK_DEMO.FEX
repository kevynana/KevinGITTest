-INCLUDE SETECHO
-SET &&ROLLFY = 1;

SET ASNAMES = ON 
-SET &&FROMDT = '2015/01/01';
-SET &&TODT = '2015/12/31';
-SET &&FXDATE = '2014/01/01';

-SET &&TXDATE= '2014/12/31';
-SET &&FYFLAG = ' ';
-SET &&PYTDDATE = '2014/12/31';
-SET &&PQFMDT = '2014/07/01';
-SET &&PQTODT = '2014/09/30';
-SET &&CQFMDT = '2015/10/01';
-SET &&CQTODT = '2015/12/31';


EX CONCAT_ALL_DBS ROLL=ABCD-R,FID=SEG,CLEAR=Y
-RUN 
-SET &&ROLL = 'ABCD-R';
-GOTO DEB;
 DEFINE FILE SR_50
 FARE_PAID/D12 = SEG_AMT + SEG_TAX;
 NET_TKT_CNT/D10  =   IF (SEG_NBR EQ '01') AND
 (FARE_PAID GE 0) AND
 (SEG_COUNT EQ 1) THEN 1 ELSE
 IF (SEG_NBR EQ '01') AND
 (EX_FLAG EQ 'F') AND (SEG_COUNT EQ -1)
 THEN (-1) ELSE
 IF (DOC_TYPE NE '1') AND
 (SEG_NBR EQ '01') AND
 (RF_FLAG EQ 'F') AND
 (SEG_COUNT EQ -1)
 THEN (-1) ELSE 0;
 TKT_PURCH/D8CS      = IF (TICKET_CODE EQ '1') AND
 (SEG_NBR EQ '01') AND
 (FARE_PAID GE 0) AND
 (SEG_COUNT EQ 1) AND
 (CONJ_REL EQ 1) THEN 1 ELSE 0;
 -INCLUDE QRFTRANA
 CURRQ/Q = TRN_DATE;
 CY/Y = TRN_DATE;
 CM/M  = TRN_DATE;
 FM/M = 01;
 DM/I2 = CM - FM;
 TRANYR/YY= TRN_DATE;
 AYEAR/A4YY = TRANYR;
 THEYR/I1 = IF (TRN_DATE GE '2015/01/01') AND (TRN_DATE LE '2015/12/31') THEN 2
 ELSE IF (TRN_DATE GE '2014/01/01') AND (TRN_DATE LE '2014/12/31') THEN 1;
 -*first year as fiscal year label
 FMDATE1/YYMD='2014/01/01';
 FMDATE2/YYMD='2015/01/01';
 FYYR1/Y=FMDATE1;
 FYYR2/Y=FMDATE2;
 -*second year as fiscal year label
 Y2DATE/YYMD = DATEADD(FMDATE2, 'Y', 1);
 FYYR3/Y=Y2DATE;
 FY_YR/A4= IF ' ' EQ '1' AND THEYR EQ 1 THEN 'FY' | EDIT(FYYR1)
 ELSE IF ' ' EQ '1' AND THEYR EQ 2 THEN 'FY' | EDIT(FYYR2)
 ELSE IF ' ' EQ '2' AND THEYR EQ 1 THEN 'FY' | EDIT(FYYR2)
 ELSE IF ' ' EQ '2' AND THEYR EQ 2 THEN 'FY' | EDIT(FYYR3)
 ELSE AYEAR;
 YEAR/A4 = IF FM EQ 01 THEN AYEAR ELSE FY_YR;
 FTRAN1/A2 = IF FM EQ 01 THEN 'Q' | EDIT(CURRQ)
 ELSE IF (DM GE 9 OR (DM GE -3 AND DM LE -1)) THEN 'Q4'
 ELSE IF (DM GE 6 OR (DM GE -6 AND DM LE -4)) THEN 'Q3'
 ELSE IF (DM GE 3 OR (DM GE -9 AND DM LE -7))  THEN 'Q2'
 ELSE IF DM LE 0 AND FM GE 11 THEN 'Q1'
 ELSE 'Q1';
 FTRAN/A6 = IF FM EQ 01 THEN FTRAN1 | ' ' | EDIT(CY)
 ELSE FTRAN1 | FY_YR;
 TRAN/A7 = IF THEYR EQ 1 THEN ' ' | FTRAN ELSE FTRAN;
 -*Current: current YTD; PRIOR: prior year; PYTD: prior YTD flag; PQ: prior quarter; CQ: current quarter
 CURRENT/A1 = IF TRN_DATE GE '2015/01/01'  AND TRN_DATE LE '2015/12/31'     THEN 'Y' ELSE 'N';
 PRIOR/A1   = IF TRN_DATE GE '2014/01/01'  AND TRN_DATE LE '2014/12/31'   THEN 'Y' ELSE 'N';
 PYTD/A1    = IF TRN_DATE GE '2014/01/01'  AND TRN_DATE LE '2014/12/31' THEN 'Y' ELSE 'N';
 PQ/A1      = IF TRN_DATE GE '2014/10/01'  AND TRN_DATE LE '2014/12/31'   THEN 'Y' ELSE 'N';
 CQ/A1      = IF TRN_DATE GE '2015/10/01'  AND TRN_DATE LE '2015/12/31'   THEN 'Y' ELSE 'N';
 -* Defines on Previous Defines
 DISSAVINGS/D12 = IF EMBARK EQ 'DT1' THEN 0 ELSE
 FARE_PAID - SEG_LOWEST;
 VASAVINGS/D12 = SEG_DISCOUNT - FARE_PAID;
 END
 TABLE FILE SR_50
 SUM FARE_PAID
 NET_TKT_CNT
 BY YEAR
 BY TRAN
 BY AIR_MAIN.INTL_DOM AS 'INTL_DOM'
 BY CURRENT
 BY PRIOR
 BY PYTD
 BY PQ
 BY CQ
 WHERE (TRN_DATE GE '2015/01/01') AND (TRN_DATE LE '2015/12/31') OR
 (TRN_DATE GE '2014/01/01') AND (TRN_DATE LE '2014/12/31')
 -********************************************************************
 -* Where statements to select data specified in user profile
 -********************************************************************
 WHERE VOID_DATE EQ 0
 
 WHERE AROLL_LEV2 EQ 'DEMOB'
 ON TABLE HOLD
END
-RUN
-QUIT

-DEB

-SET &&ROLLUP = 'ABCD-R';
-SET &&INTDOM = 'D'; 

DEFINE FILE SR_50
FARE_PAID/D12     = SEG_AMT + SEG_TAX;
 
NET_TKT_CNT/D12    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (SEG_COUNT EQ 1) AND
                           (FARE_PAID GE 0) AND
                           (CONJ_REL EQ 1) THEN 1 ELSE
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (SEG_COUNT EQ -1) AND
                           (EX_FLAG EQ 'F')
                         THEN (-1) ELSE
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (SEG_COUNT EQ -1) AND
                           (RF_FLAG EQ 'F')
                         THEN (-1) ELSE 0;
CLIENTCODE/A8 = '&&ROLLUP.EVAL';
TKT_AMOUNT/D12    = TICKET_AMT + TAX_AMT;
DECLINE_AMT/D12    = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         TKT_AMOUNT - LOWEST_AMT;
DISSAVINGS/D12.2  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST;
 
 
SPACE/A1 = '-';
SPACE1/A1 = ' ';
REF_DESC/A40 = LCWORD(40, REFUSAL_DESC, REF_DESC);
REASON/A45 = REFUSE_CODE||SPACE1|SPACE|SPACE1|REF_DESC;
 
 
 
-INCLUDE QRFTRANA
END
TABLE FILE SR_50
SUM DISSAVINGS
    REASON
    FARE_PAID
    NET_TKT_CNT
    PYTD CURRENT
BY CLIENTCODE AS 'ROLLUP_CODE'
BY YEAR
BY TRAN
BY REFUSE_CODE
BY REASON
BY CURRENT
BY PRIOR
BY PYTD
 
WHERE (TRN_DATE GE '&&FROMDT.EVAL') AND (TRN_DATE LE '&&TODT.EVAL') OR
      (TRN_DATE GE '&&FXDATE.EVAL') AND (TRN_DATE LE '&&TXDATE.EVAL')
WHERE VOID.VOID_DATE EQ 0
-IF &&INTDOM EQ 'T' THEN GOTO SKIPIT;
WHERE AIR_MAIN.INTL_DOM EQ '&&INTDOM.EVAL'
 
-SKIPIT
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
-INCLUDE RPTPARMS
 
ON TABLE HOLD AS BASELSD
END
-RUN
-SET &&NOLSTSAV = IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-*-IF &LINES EQ 0 THEN GOTO NOLSTSAV;
 
TABLE FILE BASELSD
SUM DISSAVINGS
    REASON
    FARE_PAID
    NET_TKT_CNT
    PYTD CURRENT
BY ROLLUP_CODE
BY YEAR
BY TRAN
BY REFUSE_CODE
BY REASON
ON TABLE HOLD AS BHOLD1
END
-RUN
 
 
TABLE FILE BHOLD1
PRINT ROLLUP_CODE YEAR TRAN REFUSE_CODE DISSAVINGS REASON FARE_PAID NET_TKT_CNT PYTD CURRENT
ON TABLE SAVE
END
-RUN

MODIFY FILE QRLSD
LOG DUPL MSG OFF
FIXFORM ROLLUP_CODE/8 YEAR/4 TRAN/7 REFUSE_CODE/2 DISSAVINGS/12 REASON/45 FARE_PAID/12 NET_TKT_CNT/12 PYTD/1 CURRENT/1
MATCH ROLLUP_CODE YEAR TRAN REFUSE_CODE
ON NOMATCH INCLUDE
DATA ON SAVE
END
-RUN

-SET &&BASEROLL = 'ABCD-R';
DEFINE FILE QRLSD
ROLL/A8 = IF ROLLUP_CODE EQ '&&BASEROLL.EVAL' THEN '&&BASEROLL.EVAL' ELSE 'PEER-R';
END
TABLE FILE QRLSD
SUM DISSAVINGS
    FARE_PAID
    NET_TKT_CNT 
    PYTD CURRENT
BY ROLL 
BY YEAR
BY TRAN
ON TABLE HOLD AS DLS
END
-RUN
 
 
-*  Data for LS % and LS per net ticket
DEFINE FILE DLS
WQTRX/A3=EDIT(TRAN,'999');
WQTR/A2=EDIT(LJUST(3, WQTRX, 'A3'),'99');
Q1_DIS/D12M=IF CURRENT NE 'Y' AND WQTR EQ 'Q1' THEN DISSAVINGS ELSE 0;
Q2_DIS/D12M=IF CURRENT NE 'Y' AND WQTR EQ 'Q2' THEN DISSAVINGS ELSE 0;
Q3_DIS/D12M=IF CURRENT NE 'Y' AND WQTR EQ 'Q3' THEN DISSAVINGS ELSE 0;
Q4_DIS/D12M=IF CURRENT NE 'Y' AND WQTR EQ 'Q4' THEN DISSAVINGS ELSE 0;
Q5_DIS/D12M=IF CURRENT EQ 'Y' AND WQTR EQ 'Q1' THEN DISSAVINGS ELSE 0;
Q6_DIS/D12M=IF CURRENT EQ 'Y' AND WQTR EQ 'Q2' THEN DISSAVINGS ELSE 0;
Q7_DIS/D12M=IF CURRENT EQ 'Y' AND WQTR EQ 'Q3' THEN DISSAVINGS ELSE 0;
Q8_DIS/D12M=IF CURRENT EQ 'Y' AND WQTR EQ 'Q4' THEN DISSAVINGS ELSE 0;
Q1_FP/D12M=IF CURRENT NE 'Y' AND WQTR EQ 'Q1' THEN FARE_PAID ELSE 0;
Q2_FP/D12M=IF CURRENT NE 'Y' AND WQTR EQ 'Q2' THEN FARE_PAID ELSE 0;
Q3_FP/D12M=IF CURRENT NE 'Y' AND WQTR EQ 'Q3' THEN FARE_PAID ELSE 0;
Q4_FP/D12M=IF CURRENT NE 'Y' AND WQTR EQ 'Q4' THEN FARE_PAID ELSE 0;
Q5_FP/D12M=IF CURRENT EQ 'Y' AND WQTR EQ 'Q1' THEN FARE_PAID ELSE 0;
Q6_FP/D12M=IF CURRENT EQ 'Y' AND WQTR EQ 'Q2' THEN FARE_PAID ELSE 0;
Q7_FP/D12M=IF CURRENT EQ 'Y' AND WQTR EQ 'Q3' THEN FARE_PAID ELSE 0;
Q8_FP/D12M=IF CURRENT EQ 'Y' AND WQTR EQ 'Q4' THEN FARE_PAID ELSE 0;
Q1_NT/D12=IF CURRENT NE 'Y' AND WQTR EQ 'Q1' THEN NET_TKT_CNT ELSE 0;
Q2_NT/D12=IF CURRENT NE 'Y' AND WQTR EQ 'Q2' THEN NET_TKT_CNT ELSE 0;
Q3_NT/D12=IF CURRENT NE 'Y' AND WQTR EQ 'Q3' THEN NET_TKT_CNT ELSE 0;
Q4_NT/D12=IF CURRENT NE 'Y' AND WQTR EQ 'Q4' THEN NET_TKT_CNT ELSE 0;
Q5_NT/D12=IF CURRENT EQ 'Y' AND WQTR EQ 'Q1' THEN NET_TKT_CNT ELSE 0;
Q6_NT/D12=IF CURRENT EQ 'Y' AND WQTR EQ 'Q2' THEN NET_TKT_CNT ELSE 0;
Q7_NT/D12=IF CURRENT EQ 'Y' AND WQTR EQ 'Q3' THEN NET_TKT_CNT ELSE 0;
Q8_NT/D12=IF CURRENT EQ 'Y' AND WQTR EQ 'Q4' THEN NET_TKT_CNT ELSE 0;
 
Q1_DESC/A7=IF CURRENT NE 'Y' AND WQTR EQ 'Q1' THEN TRAN ELSE Q1_DESC;
Q2_DESC/A7=IF CURRENT NE 'Y' AND WQTR EQ 'Q2' THEN TRAN ELSE Q2_DESC;
Q3_DESC/A7=IF CURRENT NE 'Y' AND WQTR EQ 'Q3' THEN TRAN ELSE Q3_DESC;
Q4_DESC/A7=IF CURRENT NE 'Y' AND WQTR EQ 'Q4' THEN TRAN ELSE Q4_DESC;
Q5_DESC/A7=IF CURRENT EQ 'Y' AND WQTR EQ 'Q1' THEN TRAN ELSE Q5_DESC;
Q6_DESC/A7=IF CURRENT EQ 'Y' AND WQTR EQ 'Q2' THEN TRAN ELSE Q6_DESC;
Q7_DESC/A7=IF CURRENT EQ 'Y' AND WQTR EQ 'Q3' THEN TRAN ELSE Q7_DESC;
Q8_DESC/A7=IF CURRENT EQ 'Y' AND WQTR EQ 'Q4' THEN TRAN ELSE Q8_DESC;
 
CYEAR/A4=IF CURRENT EQ 'Y' THEN YEAR ELSE CYEAR;
PYEAR/A4=IF CURRENT NE 'Y' THEN YEAR ELSE PYEAR;
 
CYTD_DIS/D12M=IF CURRENT EQ 'Y' THEN DISSAVINGS ELSE 0;
CYTD_FP/D12M=IF CURRENT EQ 'Y' THEN FARE_PAID ELSE 0;
CYTD_NT/D12=IF CURRENT EQ 'Y' THEN NET_TKT_CNT ELSE 0;
PYTD_DIS/D12M=IF CURRENT NE 'Y' THEN DISSAVINGS ELSE 0;
PYTD_FP/D12M=IF CURRENT NE 'Y' THEN FARE_PAID ELSE 0;
PYTD_NT/D12=IF CURRENT NE 'Y' THEN NET_TKT_CNT ELSE 0;
END
TABLE FILE DLS
SUM Q1_DIS Q2_DIS Q3_DIS Q4_DIS Q5_DIS Q6_DIS Q7_DIS Q8_DIS
    Q1_FP Q2_FP Q3_FP Q4_FP Q5_FP Q6_FP Q7_FP Q8_FP
    Q1_NT Q2_NT Q3_NT Q4_NT Q5_NT Q6_NT Q7_NT Q8_NT
    Q1_DESC Q2_DESC Q3_DESC Q4_DESC Q5_DESC Q6_DESC Q7_DESC Q8_DESC
    CYEAR PYEAR
 CYTD_DIS CYTD_FP CYTD_NT
 PYTD_DIS PYTD_FP PYTD_NT
COMPUTE Q1LSP/D6%S  = IF ((Q1_FP LT 1) AND (Q1_FP GT (-1))) THEN 0 ELSE (Q1_DIS/Q1_FP) * 100;
COMPUTE Q1NTLS/D6MS = IF ((Q1_NT LT 1) AND (Q1_NT GT (-1))) THEN 0 ELSE (Q1_DIS/Q1_NT);
COMPUTE Q2LSP/D6%S  = IF ((Q2_FP LT 1) AND (Q2_FP GT (-1))) THEN 0 ELSE (Q2_DIS/Q2_FP) * 100;
COMPUTE Q2NTLS/D6MS = IF ((Q2_NT LT 1) AND (Q2_NT GT (-1))) THEN 0 ELSE (Q2_DIS/Q2_NT);
COMPUTE Q3LSP/D6%S  = IF ((Q3_FP LT 1) AND (Q3_FP GT (-1))) THEN 0 ELSE (Q3_DIS/Q3_FP) * 100;
COMPUTE Q3NTLS/D6MS = IF ((Q3_NT LT 1) AND (Q3_NT GT (-1))) THEN 0 ELSE (Q3_DIS/Q3_NT);
COMPUTE Q4LSP/D6%S  = IF ((Q4_FP LT 1) AND (Q4_FP GT (-1))) THEN 0 ELSE (Q4_DIS/Q4_FP) * 100;
COMPUTE Q4NTLS/D6MS = IF ((Q4_NT LT 1) AND (Q4_NT GT (-1))) THEN 0 ELSE (Q4_DIS/Q4_NT);
COMPUTE Q5LSP/D6%S  = IF ((Q5_FP LT 1) AND (Q5_FP GT (-1))) THEN 0 ELSE (Q5_DIS/Q5_FP) * 100;
COMPUTE Q5NTLS/D6MS = IF ((Q5_NT LT 1) AND (Q5_NT GT (-1))) THEN 0 ELSE (Q5_DIS/Q5_NT);
COMPUTE Q6LSP/D6%S  = IF ((Q6_FP LT 1) AND (Q6_FP GT (-1))) THEN 0 ELSE (Q6_DIS/Q6_FP) * 100;
COMPUTE Q6NTLS/D6MS = IF ((Q6_NT LT 1) AND (Q6_NT GT (-1))) THEN 0 ELSE (Q6_DIS/Q6_NT);
COMPUTE Q7LSP/D6%S  = IF ((Q7_FP LT 1) AND (Q7_FP GT (-1))) THEN 0 ELSE (Q7_DIS/Q7_FP) * 100;
COMPUTE Q7NTLS/D6MS = IF ((Q7_NT LT 1) AND (Q7_NT GT (-1))) THEN 0 ELSE (Q7_DIS/Q7_NT);
COMPUTE Q8LSP/D6%S  = IF ((Q8_FP LT 1) AND (Q8_FP GT (-1))) THEN 0 ELSE (Q8_DIS/Q8_FP) * 100;
COMPUTE Q8NTLS/D6MS = IF ((Q8_NT LT 1) AND (Q8_NT GT (-1))) THEN 0 ELSE (Q8_DIS/Q8_NT);
COMPUTE CYTD_LSP/D6.2 = IF ((CYTD_FP LT 1) AND (CYTD_FP GT (-1))) THEN 0 ELSE (CYTD_DIS/CYTD_FP) * 100;
COMPUTE CYTD_NTLS/D6MS = IF ((CYTD_NT LT 1) AND (CYTD_NT GT (-1))) THEN 0 ELSE (CYTD_DIS/CYTD_NT);
COMPUTE PYTD_LSP/D6.2   = IF ((PYTD_FP LT 1) AND (PYTD_FP GT (-1))) THEN 0 ELSE (PYTD_DIS/PYTD_FP) * 100;
COMPUTE PYTD_NTLS/D6MS = IF ((PYTD_NT LT 1) AND (PYTD_NT GT (-1))) THEN 0 ELSE (PYTD_DIS/PYTD_NT);

 COMPUTE YTDVAR2/D6%S=(CYTD_LSP - PYTD_LSP);
 BY ROLL
-*ON TABLE HOLD AS HLDLS201D
END
-RUN