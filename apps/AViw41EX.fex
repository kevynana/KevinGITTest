-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* -SET ECHO=ALL;
-* File AIREXTRT.FEX
-********************************************************************
-* MODIFICAIONS:
-* 5/22/1998 ADDED TRN_DATE CRITERIA TO WHERE STATEMENTS - LP
-* 7/09/1998 ADDED A DEFINE FOR TICKETLESS MIR TRANSACTIONS - LP
-* 4/29/2002 CHANGED MRK_TKT_CNT DEFINE TO CORRECTLY BACK OUT PARTIAL 
-*           REFUNDS AND EXCHANGES - SC DB
-* 5/06/02  ADDED PRIN_TKT DEFINE - DB
-* 5/15/02  ADDED ISU_TKT DEFINE - DB 
-* 5/20/02  ADDED UP_LSAV DEFINE - DB
-* 12/9/02  ADDED PROP_CNT/PROP_AMT/PROP_SAV DEFINES - JK
-* 9/02/03  ADDED PRIN_BASE DEFINE - DV
-* 10/17/03 ADDED CCARD6 DEFINE - DEB
-* 12/08/03 ADDED CCNTR1 CCNTR DEFINE  - DEB AND STEVE
-*12/8/04   ADDED CNTRY DEFINES JK
-* 5/3/05   ADDED CODE FOR GLOBAL CURRENCY - DEB
-* 4/13/06  ADDED ID DEFINE - JK
-*02/28/13  CHANGED CLASS_CAT DEFINE DUE TO CLASS CATEGORY CHANGES - DV
-*6/30/14   ADDED DEFINE FOR PROP_LSAV - DEB
-*9/22/14     ADDED DEFINE PROP_TKT_CNT - DEB
-*10/3/14   ADDED LEVEL4 LEVEL5 LEVEL6 ND_ORG_CD ND_DST_CD - DV
-*10/9/14   UPDATED PROP_LOW AND PROP_LSAV PER CLIENT REQUEST - DEB
-*10/28/14  CHANGED PROP_NET_TKT DEFINE - DEB
-*11/25/14  ADDED DEFINE   CO_MILE_DSC  CO_MILE_KEY - DEB

-*10/15/15     DLV   S-12173  - ADDED EX_FLAG
-*02/19/16 - JEM - S-13286 Updated to allow reports to sort/subtotal by id-levels
-*09/26/2017 - DLV - S-37268 - UPDATED ND_ORG_CD ND_DST_CD

-********************************************************************
-*
-* This program extracts data for the series of basic ticket listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-*
-********************************************************************

SET ASNAMES = ON
-SET HOLDATTR = ON;

-SET &&IDLEVELBREAK = '';


-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

-INCLUDE IDLEVROLLDEF
-RUN

DEFINE FILE &&EXTRACT
  BASE_FARE/D12.2CS = SEG_AMT - SEG_COM;
  BASE_FAR2/D12.2CS = SEG_AMT;
  BOOK_DT/MDYY = RESV_DATE;
  CARD_NUM/A12 = EDIT(CC_NUM, '$$999999999999$$$$');
  CARD1_NUM/A4 = EDIT(CC_NUM, '$$$$$$$$$$$$$$9999');
  CARD_NUM1/A16 = EDIT(CC_NUM,'$$9999999999999999');
  CCARD/A4 = EDIT(CC_NUM, '$$9999$$$$$$$$$$$$');
  CCARD1/A4 = EDIT(CC_NUM, '$$$$$$9999$$$$$$$$');
  CCARD2/A6 = EDIT(CC_NUM, '$$999999$$$$$$$$$$');
  CCARD3/A6 = EDIT(CC_NUM, '$$999999$$$$$$$$$$');
  CCARD5/A6 = EDIT(CC_NUM, '$$$$$$$$$$$$999999');
  CCARD6/A5 = EDIT(CC_NUM, '$$$$$$$$$$$$$99999');
  CASH_CRDT/A6 = DECODE CASH_CREDIT ('1' 'CASH'    '2' 'CREDIT');
-*  CLASS_CAT/A8 = DECODE CL_CAT ('F' 'FIRST'     'C' 'COACH'   
-*                              'D' 'DISCOUNT'  'B' 'BUSINESS');
  CLASS_CAT/A15 = DECODE CL_CAT ('F' 'FIRST'     'P' 'PREMIUM ECONOMY'   
			        'D' 'DEFAULT'   'B' 'BUSINESS'
			        'E' 'ECONOMY'   'U'  'UPGRADE' 
                                ' ' 'DEFAULT'); 
  CLS_CAT/A1 = IF ADIR_ALL CONTAINS '*F' THEN 'F' ELSE
             IF ADIR_ALL CONTAINS '*B' THEN 'B' ELSE
             IF ADIR_ALL CONTAINS '*C' THEN 'C' ELSE 'D';                                 
  COM_AMT/D12.2CS = SEG_COM;
 CTRY1/A2 =  EDIT(CTRY_COD, 
'99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY2/A2 =  EDIT(CTRY_COD, 
'$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY3/A2 =  EDIT(CTRY_COD, 
'$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY4/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY5/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY6/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY7/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY8/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY9/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY10/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY11/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY12/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY13/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY14/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY15/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$$$$');
CTRY16/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$$$$');
CTRY17/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$$$$');
CTRY18/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$$$$');
CTRY19/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$$$$');
CTRY20/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$$$$');
CTRY21/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$$$$');
CTRY22/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99$$$');
CTRY23/A2 =  EDIT(CTRY_COD, 
'$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$99');

-* DEFINES ON PREVIOUS DEFINES

  CRD_CRD/A2 = EDIT(CC_NUM, '99$$$$$$$$$$$$$$$');
  CTRY_FLAG/A1 = IF CTRY_COD CONTAINS 'CA' THEN 'Y' ELSE 'N';
  CTRY_FLAG1/A1 = IF (CTRY1 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND 
    (CTRY2 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND 
    (CTRY3 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY4 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY5 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY6 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY7 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY8 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND 
    (CTRY9 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY10 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY11 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY12 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY13 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY14 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY15 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY16 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND 
    (CTRY17 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY18 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY19 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY20 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY21 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
    (CTRY22 EQ 'US' OR 'CA' OR 'MX' OR ' ') AND
  (CTRY23 EQ 'US' OR 'CA' OR 'MX' OR ' ') THEN 'Y' ELSE 'N';
  DEPT_MONTH/MT = DPT_DATE;
  DIR_CP_CD/A50 = CITYPAIR.EMBARK||'-'||CITYPAIR.ROUTE;
-****************************************************************************
-* 10/3/00  IBISTL-RJ    FIELD WAS BEING TRUNCATED IN FOCUS 6, NEED TO RUN A 
-*                       SUBROUTINE IN WEBFOCUS TO TRUNCATE.
  DIR_CP_NMX/A72 = '(' || CITYPAIR.EMBARK || '/' 
           || CITYPAIR.ROUTE || ') ' | 
           EMB_APT.AIRPORT_NAME ||'---' || RTE_APT.AIRPORT_NAME;
  DIR_CP_NM/A50 = SUBSTR(72,DIR_CP_NMX,1,50,50,'A50');
-*
  FARE_PAID/D12.2CS = SEG_AMT + SEG_TAX;
  FDEST_GEOZONE/A3 = FST_DEST_GEO_ZONE;
  LEVEL_DESC1/A80    = &&LDESC;
  GROSS_FARE/D12.2CS = IF (RF_FLAG EQ ' ') AND (EX_FLAG EQ ' ') THEN
                       SEG_AMT + SEG_TAX ELSE 0;
  ID/A15 = IF AIR_MAIN.INTL_DOM EQ 'I' THEN 'INTERNATIONAL' ELSE 'DOMESTIC';
  MIR_TYPE/A24 = DECODE AUX_NON_MIR ('X' 'X-DUAL MIR'
                                    'N' 'N-NON-TICKETING MIR'
                                    'J' 'J-NON-FARING MIR'
                                    'A' 'A-NON-ACCOUNTING MIR'
                                    'B' 'B-ACCOUNTING MIR'
                                    'H' 'H-REGULAR TICKET MIR'
                                    'V' 'V-VOID'
                                    'E' 'E-ELECTRONIC TKT NETWORK'
                                    'L' 'L-ELECTRONIC TKT MIR'
                                    ' ' ' -MANUALLY ENTERED TRANS');
  MRK_TKT_CNT/D8CS = IF (TICKET_CODE EQ '1') AND
                        (FARE_PAID GE 0) AND
                        (SEG_COUNT EQ 1) AND 
                        (CONJ_REL EQ 1) THEN 1 ELSE 
                     IF (TICKET_CODE EQ '1') AND
                        (EX_FLAG NE ' ') THEN (-1) ELSE 
                     IF (TICKET_CODE EQ '1') AND
                        (RF_FLAG NE ' ') THEN (-1) ELSE 0;
  ND_CITY_NM/A50 = NDO_CTY.CITY_NAME | NDD_CTY.CITY_NAME;
  NET_TKT_CNT/D8CS = IF (TICKET_CODE EQ '1') AND
                        (SEG_NBR EQ '01') AND
                        (FARE_PAID GE 0) AND
                        (SEG_COUNT EQ 1) AND 
                        (CONJ_REL EQ 1) THEN 1 ELSE 
                     IF (TICKET_CODE EQ '1') AND
                        (SEG_NBR EQ '01') AND 
                        (EX_FLAG EQ 'F') THEN (-1) ELSE 
                     IF (TICKET_CODE EQ '1') AND
                        (SEG_NBR EQ '01') AND
                        (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  NET_TKT_CNT1/D8CS = IF (TICKET_CODE EQ '1') AND
                         (FARE_PAID GE 0) AND
                         (SEG_COUNT EQ 1) AND 
                         (CONJ_REL EQ 1) THEN 1 ELSE 
                      IF (TICKET_CODE EQ '1') AND
                         (EX_FLAG EQ 'F') THEN (-1) ELSE 
                      IF (TICKET_CODE EQ '1') AND
                         (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  NEW_ADV_PURCH/D9 = ADV_PURCH;
  NEW_SEG_COUNT/D8CS = SEG_COUNT;
  NEW_SEG_DISC/D12.2CS = SEG_DISC;
  NEW_SEG_MILES/D9 = SEG_MILES;
  NOREF_SEG_COUNT/D8CS = IF (RF_FLAG EQ ' ') AND (EX_FLAG EQ ' ') THEN
                           NEW_SEG_COUNT ELSE 0;
  PROP_AMT/D12.2CS = IF CONTRACT_FARE EQ 0 THEN 0 ELSE
                    (LOWEST_AMT - CONTRACT_FARE);
  PROP_SAV/D12.2CS = SEG_LOWEST - SEG_CONTRACT;
  PROP_LOW/D12.2CS = IF RF_FLAG NE ' ' THEN FARE_PAID ELSE SEG_CONTRACT;
  PROP_LOW2/D12.2CS = IF REFUSE_CODE EQ 'LE' OR 'NF' THEN PROP_LOW ELSE 0;

  REF_E_CNT/D8CS = IF (RF_FLAG NE ' ') OR (EX_FLAG NE ' ') THEN
                   1 ELSE 0;  
  REF_EXCH_CNT/D8CS = IF (TICKET_CODE EQ '1') AND
                         (SEG_NBR EQ '01') AND
                         (FARE_PAID GE 0) AND
                         (SEG_COUNT EQ 1) AND 
                         (CONJ_REL EQ 1) THEN 0 ELSE 
                      IF (TICKET_CODE EQ '1') AND
                         (SEG_NBR EQ '01') AND 
                         (EX_FLAG EQ 'F') THEN 1 ELSE 
                      IF (TICKET_CODE EQ '1') AND
                         (SEG_NBR EQ '01') AND
                         (RF_FLAG EQ 'F') THEN 1 ELSE 0;
  REFEXCH/D12.2CS = IF (RF_FLAG NE ' ') THEN
                    SEG_AMT + SEG_TAX ELSE 
                    IF (EX_FLAG NE ' ') THEN
                    SEG_AMT + SEG_TAX ELSE 0;                      
  SAVINGS/D11.2CS = SEG_STANDARD - FARE_PAID;  
  TKT_AMOUNT/D12.2CS = TICKET_AMT + TAX_AMT;
  TKT_PURCH/D8CS = IF (TICKET_CODE EQ '1') AND
                      (SEG_NBR EQ '01') AND
                      (FARE_PAID GE 0) AND
                      (SEG_COUNT EQ 1) AND 
                      (CONJ_REL EQ 1) THEN 1 ELSE 0;
  TKT_TYPE/A4 = IF (SEG_COUNT LE 0) AND
                   (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                IF (SEG_COUNT LE 0) AND 
                   (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                IF (SEG_COUNT LE 0) AND 
                   (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                IF (SEG_COUNT LE 0) AND 
                   (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  TRAN_MONTH/MT = TRN_DATE;
  XARR_DOW/W = ARR_DATE;
  XARR_DT/MDYY = ARR_DATE;
  XDPT_DOW/W = DPT_DATE;
  XDPT_DT/MDYY = DPT_DATE;
  XPSNGR_NM/A15 = EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY = TRN_DATE;

-* ****DEFINES ON PREVIOUS DEFINES****

  AIRLINE_FEE/D8.2CS = IF EMBARK EQ 'FP2' OR 'FP3' 
     THEN FARE_PAID ELSE 0;
  ARR_DAY/A3 = DECODE XARR_DOW (1 'MON' 2 'TUE' 3 'WED'
               4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
  BAIR_TKT/A15 = IF TKT_AMOUNT LE 299 THEN '299 AND UNDER'  ELSE
          IF TKT_AMOUNT GT 299 AND TKT_AMOUNT LE 600 THEN '300 - 599' ELSE
            '600 OR MORE';               
  CO_MILE_DSC/A35 = IF (MILE GT 1) AND (MILE LT 621) OR 
                      ((MILE LT (-1)) AND (MILE GT (-621)))  THEN 'SHORT HAUL (LESS THAN 621)' ELSE
                   IF (MILE GE 621 AND MILE LE 2300) OR
                      ((MILE LT (-621)) AND (MILE GT (-2300))) THEN 'MEDIUM HAUL (621-2300)' ELSE
                      'LONG HAUL (2300 OR MORE)';                      
  DISSAVINGS/D11.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST;
  DECLINE_AMT/D12.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         TKT_AMOUNT - LOWEST_AMT;
  DPT_DAY/A3 = DECODE XDPT_DOW (1 'MON' 2 'TUE' 3 'WED'
               4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
  GROSS_DSAVE/D12.2CS = IF (RF_FLAG EQ ' ') AND
                           (EX_FLAG EQ ' ') THEN
                           DISSAVINGS ELSE 0;
  ISU_TKT/A15 = IF TKT_AMOUNT LE 400 THEN '0 - 400'  ELSE
          IF TKT_AMOUNT GT 400 THEN 'OVER 400'; 
  PRIN_TKT/A15 = IF TKT_AMOUNT LE 400 THEN '0 - 400'  ELSE
          IF TKT_AMOUNT GT 400 AND TKT_AMOUNT LE 600 THEN '401 - 600' ELSE
          IF TKT_AMOUNT GT 600 AND TKT_AMOUNT LE 1000 THEN '601 - 1000' ELSE
          IF TKT_AMOUNT GT 1000 AND TKT_AMOUNT LE 1499 THEN '1001 - 1499'
          ELSE '1500 AND OVER';
  PRIN_TKT2/A1 = IF PRIN_TKT EQ '0 - 400' THEN 'A' ELSE
                 IF PRIN_TKT EQ '401 - 600' THEN 'B' ELSE
                 IF PRIN_TKT EQ '601 - 1000' THEN 'C' ELSE
                 IF PRIN_TKT EQ '1001 - 1499' THEN 'D' ELSE 'E';
  PRIN_BASE/A15 = IF TICKET_AMT LT 400 THEN '0 - 399' ELSE 
                 IF TICKET_AMT GE 400 THEN '400 - OVER';
  PROP_CNT/P8CS = IF PROP_AMT EQ LOWEST_AMT THEN 0 ELSE
                  IF PROP_AMT EQ 0 THEN 0 ELSE NET_TKT_CNT;
  PROP_AMT1/D12.2CS = IF PROP_AMT EQ LOWEST_AMT THEN 0 ELSE
                      IF PROP_AMT EQ 0 THEN 0 ELSE PROP_SAV; 
-*  PROP_LSAV/D11.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
-*                       IF SEG_CONTRACT EQ 0 THEN 0 ELSE
-*                         FARE_PAID - SEG_CONTRACT; 
  PROP_LSAV/D11.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                  IF SEG_CONTRACT EQ 0 THEN 0 ELSE
                  IF REFUSE_CODE EQ 'LE' OR 'NF' THEN FARE_PAID - SEG_CONTRACT ELSE 0; 
 CCNTR1/I2 = POSIT(LEVEL1, 15, '  ', 2, 'I2');
 
  KX_TKT/A1 = IF TKT_AMOUNT GE 400 THEN 'Y' ELSE 'N';               

-* ****DEFINES ON PREVIOUS DEFINES****
  
  UP_LSAV/A1 = IF (VAL_AIRLINE EQ 'AA' OR 'DL' OR 'CO' OR 'F9' OR 'NW') AND
               (DECLINE_AMT LE 50) THEN 'N' ELSE 
               IF REFUSE_CODE EQ 'LE' THEN 'N' ELSE 'Y';
-*   CCNTR/A13 = IF CCNTR1 EQ ' ' THEN 'N' ELSE 'Y';

  CCNTR/A1 = IF CCNTR1 EQ 14 THEN 'Y' ELSE 'N';
  PROP_NET_TKT/D8CS = IF CONTRACT_FARE EQ 0 THEN 0 ELSE 
                      IF REFUSE_CODE EQ 'LE' OR 'NF' THEN NET_TKT_CNT ELSE 0;
  CO_MILE_KEY/A1 = IF CO_MILE_DSC CONTAINS 'SHORT HAUL' THEN 'A' ELSE
                   IF CO_MILE_DSC CONTAINS 'MEDIUM HAUL' THEN 'B' ELSE 'C';    
-INCLUDE TRANTYPE
-INCLUDE IDLEVDEFINE 

END
-RUN

TABLEF FILE &&EXTRACT
PRINT 
  ADIR_STP
  AGENT_NUM	
  AIR_KEY	
  AIR_MAIN.INTL_DOM AS 'INTL_DOM'	
  AIRLINE	
  AIRLINE_FEE	
  AIRLINE_NAME	
  AR_BRANCH
  AROLL_LEV3
  ARR_DAY	
  ARR_TIME
  AUX_NON_MIR
  BAIR_TKT
  BASE_FARE
  BASE_FAR2	
  BOOK_DT	
  BR_CL_IDX	
  CARD_NUM	
  CARD_NUM1	
  CARD1_NUM
  CASH_CRDT	
  CCARD	
  CCARD1	
  CCARD2	
  CCARD3	
  CCARD5
  CCARD6
  CDIR_ALL
  CITYPAIR.EMBARK      AS 'EMB_APT_CD'	
  CITYPAIR.ROUTE       AS 'RTE_APT_CD'	
  CL_CAT	
  CLASS	
  CLASS_CAT	
  CLIENT_NAME
  CLIENT_NUM
  CO_MILE_DSC
  CO_MILE_KEY
  COM_AMT
-*   COSTCNTR
  CCNTR	
  CRD_CRD	
  CC_NUM	
  CTRY_COD
  CTRY_FLAG1
  DEPT_MONTH
  DIR_CP_CD	
  DIR_CP_NM	
  DISSAVINGS
  DOC_TYPE	
  DPT_DAY	
  DPT_TIME	
  EMB_APT.AIRPORT_NAME AS 'EMB_APT_NM'	
  EMB_CTY.CITY_NAME    AS 'EMB_CTY_NM'	
  EMB_CTY.COUNTRY_CODE	
  EMB_CTY.EMB_CITY     AS 'EMB_CTY_CD'	
  EX_FLAG
  FARE_BAS	
  FARE_PAID	
  FLIGHT
  FDEST_GEOZONE	
  GROSS_DSAVE	
  GROSS_FARE	
  GROUP_CODE
  GSA_GTR
  ID
  INT_CODE	
  INVOICE_NUM
  ISU_TKT
  LEVEL_DESC	
  LEVEL1	
  LEVEL2	
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  MIR_TYPE	
  MRK_TKT_CNT	
  ND_CITY_NM
-*  NDO_APT.ND_ORG AS 'ND_ORG_CD'
-*  NDD_APT.ND_DST AS 'ND_DST_CD'
  ND_ORG AS 'ND_ORG_CD'
  ND_DST AS 'ND_DST_CD'
  NET_TKT_CNT	
  NET_TKT_CNT1	
  NEW_ADV_PURCH	
  NEW_SEG_COUNT	
  NEW_SEG_DISC	
  NEW_SEG_MILES	
  NOREF_SEG_COUNT	
  PASSNGR_NAME	
  PNR_LOCATOR
  PRIN_BASE
  PRIN_TKT
  PRIN_TKT2
  PROP_CNT
  PROP_AMT1
  PROP_LOW
  PROP_LOW2 
  PROP_LSAV
  PROP_NET_TKT
  PROP_SAV	
  REF_E_CNT	
  REF_EXCH_CNT	
  REFEXCH	
  REFUSAL_DESC	
  REFUSE_CODE	
  REFUSE_KEY    
  RESV_DATE    	
  RTE_APT.AIRPORT_NAME AS 'RTE_APT_NM'	
  RTE_CTY.CITY_NAME    AS 'RTE_CTY_NM'	
  RTE_CTY.RTE_CITY     AS 'RTE_CTY_CD'	
  SAVINGS	
  SEG_AMT	
  SEG_CONTRACT
  SEG_COUNT
  SEG_DESIG	
  SEG_DISCOUNT	
  SEG_LOWEST	
  SEG_MILES	
  SEG_NBR	
  SEG_STANDARD	
  SEG_TAX	
  STAY	
  TICKET_BRANCH	
  TKT_AMOUNT	
  TKT_DATE
  TKT_NUM	
  TKT_PURCH	
  TKT_SORT	
  TKT_TYPE	
  TOUR_CODE	
  TRAN_MONTH
  TRIP_LENGTH	
  TRN_DATE
  UP_LSAV	
  VAL_AIRLINE	
  VOID_DATE
  XARR_DOW	
  XARR_DT
  XDPT_DOW	
  XDPT_DT	
  XPSNGR_NM	
  XTRAN_DT	


-INCLUDE &AIRDATES

WHERE VOID_DATE EQ 0
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS RPT_HOLD
END
-RUN

TABLE FILE RPT_HOLD
PRINT   
  ADIR_STP
  AGENT_NUM	
  AIR_KEY	
  INTL_DOM	
  AIRLINE	
  AIRLINE_FEE	
  AIRLINE_NAME	
  AR_BRANCH
  AROLL_LEV3
  ARR_DAY	
  ARR_TIME
  AUX_NON_MIR
  BAIR_TKT
  BASE_FARE
  BASE_FAR2	
  BOOK_DT	
  BR_CL_IDX	
  CARD_NUM	
  CARD_NUM1	
  CARD1_NUM
  CASH_CRDT	
  CCARD	
  CCARD1	
  CCARD2	
  CCARD3	
  CCARD5
  CCARD6
  CDIR_ALL
  EMB_APT_CD	
  RTE_APT_CD	
  CL_CAT	
  CLASS	
  CLASS_CAT	
  CLIENT_NAME
  CLIENT_NUM	
  CO_MILE_DSC
  CO_MILE_KEY
  COM_AMT
-*   COSTCNTR
  CCNTR	
  CRD_CRD	
  CC_NUM	
  CTRY_COD
  DEPT_MONTH
  DIR_CP_CD	
  DIR_CP_NM	
  DISSAVINGS
  DOC_TYPE	
  DPT_DAY	
  DPT_TIME	
  EMB_APT_NM	
  EMB_CTY_NM	
  COUNTRY_CODE	
  EMB_CTY_CD
  EX_FLAG
  FARE_BAS	
  FARE_PAID	
  FLIGHT
  FDEST_GEOZONE	
  GROSS_DSAVE	
  GROSS_FARE	
  GROUP_CODE
  GSA_GTR
  ID
  INT_CODE	
  INVOICE_NUM
  ISU_TKT
  LEVEL_DESC	
  LEVEL1	
  LEVEL2	
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6	
  MIR_TYPE	
  MRK_TKT_CNT	
  ND_CITY_NM
  ND_ORG_CD
  ND_DST_CD
  NET_TKT_CNT	
  NET_TKT_CNT1	
  NEW_ADV_PURCH	
  NEW_SEG_COUNT	
  NEW_SEG_DISC	
  NEW_SEG_MILES	
  NOREF_SEG_COUNT	
  PASSNGR_NAME	
  PNR_LOCATOR
  PRIN_BASE
  PRIN_TKT
  PRIN_TKT2
  PROP_CNT
  PROP_AMT1
  PROP_LOW
  PROP_LOW2 
  PROP_LSAV
  PROP_NET_TKT
  PROP_SAV	
  REF_E_CNT	
  REF_EXCH_CNT	
  REFEXCH	
  REFUSAL_DESC	
  REFUSE_CODE	
  REFUSE_KEY    
  RESV_DATE    	
  RTE_APT_NM	
  RTE_CTY_NM	
  RTE_CTY_CD
  SAVINGS	
  SEG_AMT	
  SEG_CONTRACT
  SEG_COUNT
  SEG_DESIG	
  SEG_DISCOUNT	
  SEG_LOWEST	
  SEG_MILES	
  SEG_NBR	
  SEG_STANDARD	
  SEG_TAX	
  STAY	
  TICKET_BRANCH	
  TKT_AMOUNT	
  TKT_NUM	
  TKT_PURCH	
  TKT_SORT	
  TKT_TYPE	
  TOUR_CODE	
  TRAN_MONTH
  TRIP_LENGTH	
  TRN_DATE
  UP_LSAV	
  VAL_AIRLINE	
  VOID_DATE
  XARR_DOW	
  XARR_DT
  XDPT_DOW	
  XDPT_DT	
  XPSNGR_NM	
  XTRAN_DT
BY TKT_DATE
ON TABLE HOLD AS RPTHLD FORMAT FOCUS INDEX TKT_DATE
END
-RUN

-* Global Reporting JOIN
JOIN RPTHLD.TKT_DATE IN RPTHLD TO GLOBAL.DATE IN GLOBAL AS J1


DEFINE FILE RPTHLD
NAMEC/A30 = CNAME;

-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
PAID_FAREX/D20.6 = FARE_PAID * CURR1X;
GSEG_LOWX/D20.6 = SEG_LOWEST * CURR1X;
GDIS_SAVEX/D20.6 = DISSAVINGS * CURR1X;
GAIR_FEEX/D20.6 = AIRLINE_FEE * CURR1X;

-* DEFINES ON PREVIOUSLY DEFINES DEFINES

PAID_FARE1/D20.6C = PAID_FAREX;
GSEG_LOW1/D20.6 = GSEG_LOWX;
GDIS_SAVE1/D10.6 = GDIS_SAVEX;
GAIR_FEE1/D20.6 = GAIR_FEEX;
END
 

TABLE FILE RPTHLD
PRINT   
  ADIR_STP
  AGENT_NUM	
  AIR_KEY	
  INTL_DOM	
  AIRLINE	
  AIRLINE_FEE	
  AIRLINE_NAME	
  AR_BRANCH
  AROLL_LEV3
  ARR_DAY	
  ARR_TIME
  AUX_NON_MIR
  BAIR_TKT
  BASE_FARE
  BASE_FAR2	
  BOOK_DT	
  BR_CL_IDX	
  CARD_NUM	
  CARD_NUM1	
  CARD1_NUM
  CASH_CRDT	
  CCARD	
  CCARD1	
  CCARD2	
  CCARD3	
  CCARD5
  CCARD6
  CDIR_ALL
  EMB_APT_CD	
  RTE_APT_CD	
  CL_CAT	
  CLASS	
  CLASS_CAT	
  CLIENT_NAME
  CLIENT_NUM	
  CO_MILE_DSC
  CO_MILE_KEY
  COM_AMT
-*   COSTCNTR
  CCNTR	
  CRD_CRD	
  CC_NUM	
  CTRY_COD
  DEPT_MONTH
  DIR_CP_CD	
  DIR_CP_NM	
  DISSAVINGS
  DOC_TYPE	
  DPT_DAY	
  DPT_TIME	
  EMB_APT_NM	
  EMB_CTY_NM	
  COUNTRY_CODE	
  EMB_CTY_CD
  EX_FLAG
  FARE_BAS	
  FARE_PAID	
  FLIGHT
  FDEST_GEOZONE	
  GROSS_DSAVE	
  GROSS_FARE	
  GROUP_CODE
  GSA_GTR
  ID
  INT_CODE	
  INVOICE_NUM
  ISU_TKT
  LEVEL_DESC	
  LEVEL1	
  LEVEL2	
  LEVEL3
  LEVEL4
  LEVEL5
  LEVEL6
  MIR_TYPE	
  MRK_TKT_CNT	
  ND_CITY_NM	
  ND_ORG_CD
  ND_DST_CD
  NET_TKT_CNT	
  NET_TKT_CNT1	
  NEW_ADV_PURCH	
  NEW_SEG_COUNT	
  NEW_SEG_DISC	
  NEW_SEG_MILES	
  NOREF_SEG_COUNT	
  PASSNGR_NAME	
  PNR_LOCATOR
  PRIN_BASE
  PRIN_TKT
  PRIN_TKT2
  PROP_CNT
  PROP_AMT1
  PROP_LOW
  PROP_LOW2 
  PROP_LSAV
  PROP_NET_TKT
  PROP_SAV	
  REF_E_CNT	
  REF_EXCH_CNT	
  REFEXCH	
  REFUSAL_DESC	
  REFUSE_CODE	
  REFUSE_KEY    
  RESV_DATE    	
  RTE_APT_NM	
  RTE_CTY_NM	
  RTE_CTY_CD
  SAVINGS	
  SEG_AMT	
  SEG_CONTRACT
  SEG_COUNT
  SEG_DESIG	
  SEG_DISCOUNT	
  SEG_LOWEST	
  SEG_MILES	
  SEG_NBR	
  SEG_STANDARD	
  SEG_TAX	
  STAY	
  TICKET_BRANCH	
  TKT_AMOUNT	
  TKT_NUM	
  TKT_PURCH	
  TKT_SORT	
  TKT_TYPE	
  TOUR_CODE	
  TRAN_MONTH
  TRIP_LENGTH	
  TRN_DATE
  UP_LSAV	
  VAL_AIRLINE	
  VOID_DATE
  XARR_DOW	
  XARR_DT
  XDPT_DOW	
  XDPT_DT	
  XPSNGR_NM	
  XTRAN_DT
  NAMEC
  PAID_FARE1/D16.2CS
  GSEG_LOW1/D16.2CS
  GDIS_SAVE1/D16.2CS
  GAIR_FEE1/D16.2CS
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS RPTHOLD2
END
-RUN


