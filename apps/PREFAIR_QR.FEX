-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

SET ASNAMES=ON
-******************************************************************************
-* 10/25/17 - DLV - S-16607 - New extract created for KPI page
EX CONCAT_ALL_DBS ROLL=ABCD-R,FID=SEG,CLEAR=Y
-RUN

-INCLUDE SETECHO 
-SET &&FROMDT = '2017/07/01';
-SET &&TODT = '2017/09/30';
-SET &&CYFMDT = '&&FROMDT.EVAL';
-SET &&CYTODT = '&&TODT.EVAL';
-SET &&FXDATE = '2016/01/01';
-SET &&TXDATE = '2016/12/31';
-SET &&PYFMDT = '&&FXDATE.EVAL';

-SET &&PQFMDT= '2016/07/01';
-SET &&PQTODT= '2016/09/30';
-SET &&CQFMDT = '2017/07/01';
-SET &&CQTODT = '2017/09/30';
-SET &&PYTDDATE= '&&TXDATE.EVAL'; 
-SET &&ROLLUP = 'ABCD-R';
-SET &&ROLLFY = '01';
-SET &&FYFLAG = ' ';



-SET &&INTDOM = 'I';
-SET &&HXPFD001='QRPREF001' | &&INTDOM;

DEFINE FILE SR_50
CLIENT/A8 = '&&ROLLUP.EVAL';
FARE_PAID/D15.2 = SEG_AMT + SEG_TAX;
MRK_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                     (FARE_PAID GE 0) AND
                     (SEG_COUNT EQ 1) AND
                     (CONJ_REL EQ 1) THEN 1 ELSE
                  IF (TICKET_CODE EQ '1') AND
                     (EX_FLAG NE ' ') THEN (-1) ELSE
                  IF (TICKET_CODE EQ '1') AND
                     (RF_FLAG NE ' ') THEN (-1) ELSE 0;
NET_TKT_CNT/P12      = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND
                           (CONJ_REL EQ 1) THEN 1 ELSE
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (EX_FLAG EQ 'F') THEN (-1) ELSE
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;  
NEW_SEG_DISC/D15.2CS = SEG_DISCOUNT;
VASAVINGS/D15.2CS    = NEW_SEG_DISC - FARE_PAID;
-INCLUDE QRFTRANA
END
 
TABLE FILE SR_50
SUM FARE_PAID
    MRK_CNT
    NET_TKT_CNT
    VASAVINGS
    VAL_AIR.AIRLINE_NAME AS 'AIRLINE_NAME'
BY TKT_DATE
BY CLIENT AS 'ROLLUP_CODE'
BY VAL_AIRLINE
BY TKT_NUM
BY AIR_MAIN.INTL_DOM AS 'DOM_INTL_CODE'
BY YEAR
BY TRAN
BY CURRENT
BY PRIOR
BY PYTD
BY PQ
BY CQ
BY CATEGORY
BY BR_CL_IDX
BY TRN_DATE
BY FST_DPT_DATE

WHERE (TRN_DATE GE '&&FROMDT.EVAL') AND (TRN_DATE LE '&&TODT.EVAL') OR
      (TRN_DATE GE '&&FXDATE.EVAL') AND (TRN_DATE LE '&&TXDATE.EVAL')
-*WHERE (TRN_DATE GE '&&CYFMDT.EVAL') AND (TRN_DATE LE '&&CYTODT.EVAL') OR
-*      (TRN_DATE GE '&&PYFMDT.EVAL') AND (TRN_DATE LE '&&PYTDDATE.EVAL')
WHERE VOID.VOID_DATE EQ 0 
WHERE VAL_AIRLINE NE '2V' OR '9F' OR '2A'
-IF &&INTDOM EQ 'T' THEN GOTO SKIP;
WHERE AIR_MAIN.INTL_DOM EQ '&&INTDOM.EVAL'
-SKIP
-*&&WHERE1 
-*&&WHERE2 
-*&&WHERE3
 
-*-INCLUDE RPTPARMS
-*WHERE AROLL_LEV2 EQ 'ABCDB'
WHERE AROLL_LEV1 EQ 'ABCD-R'
ON TABLE HOLD AS QRPREFHLDA FORMAT FOCUS INDEX TKT_DATE
END
-RUN


 


DEFINE FILE QRPREFHLDA

 
CNET_TKT/P12 = IF CQ EQ 'Y' THEN NET_TKT_CNT ELSE 0;
PNET_TKT/P12 = IF PQ EQ 'Y' THEN NET_TKT_CNT ELSE 0;
CFARE/P12.2 = IF CQ EQ 'Y' THEN FARE_PAID ELSE 0;
PFARE/P12.2 = IF PQ EQ 'Y' THEN FARE_PAID ELSE 0;
END

TABLE FILE QRPREFHLDA
SUM  
    FARE_PAID
    VASAVINGS
    MRK_CNT
    NET_TKT_CNT

    AIRLINE_NAME
    CNET_TKT
    PNET_TKT
    CFARE
    PFARE
BY ROLLUP_CODE
BY VAL_AIRLINE
BY TKT_NUM
BY DOM_INTL_CODE
BY YEAR
BY TRAN
BY CURRENT
BY PRIOR
BY PYTD
BY PQ
BY CQ
BY CATEGORY
BY BR_CL_IDX
BY TRN_DATE
BY FST_DPT_DATE
-*WHERE CQ EQ 'Y' OR PQ EQ 'Y'
ON TABLE HOLD AS QRPREFHLD
END
-RUN


 



 

TABLE FILE PREFAIR
PRINT ROLLUP_CODE
AIRLINE_CODE AIRLINE_CATEGORY TICKET_EFFECTIVE_DATE TICKET_EXPIRATION_DATE AIRLINE_INT_DOM GROUP_NUMBER DEPART_EFFECTIVE_DATE DEPART_EXPIRATION_DATE
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE SET ASNAMES ON
ON TABLE HOLD AS QRPREFAIR FORMAT FOCUS INDEX ROLLUP_CODE
END
-RUN 
-SET &PAIRRECS=IF &LINES EQ 0 THEN 'N' ELSE 'Y';

-RUN 



TABLE FILE QRPREFAIR
SUM GROUP_NUMBER
BY GROUP_NUMBER NOPRINT
WHERE GROUP_NUMBER NE ' '
ON TABLE SAVE AS GROUP
END
-RUN

-SET &GROUPCK = IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';
-IF &GROUPCK EQ 'N' THEN GOTO Cont:

-READ GROUP &GN.A9
-CLOSE GROUP


-Cont:
JOIN CLEAR *

JOIN ROLLUP_CODE IN QRPREFHLD TO ALL ROLLUP_CODE IN QRPREFAIR AS J1
-RUN
 
DEFINE FILE QRPREFHLD
-IF &GROUPCK EQ 'Y' THEN GOTO NWPDEFINE;
CPREF_AIR/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
            IF (CQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B') THEN 1 ELSE 
            IF (CQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') THEN 1 ELSE 
            IF (CQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE
            IF (CQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE 0;
PPREF_AIR/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
            IF (PQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B') THEN 1 ELSE
            IF (PQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') THEN 1 ELSE
            IF (PQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE                        
            IF (PQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE 0;
-GOTO FINdefine;
-NWPDEFINE
CPREF_AIR/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
            IF (CQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B')  AND (BR_CL_IDX EQ GROUP_NUMBER)  THEN 1 ELSE 
            IF (CQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 
            IF (CQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE
            IF (CQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 0;
PPREF_AIR/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
            IF (PQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B') AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE
            IF (PQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE
            IF (PQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER)  THEN 1 ELSE                        
            IF (PQ EQ 'Y') AND (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 0;
-FINdefine
END
TABLE FILE QRPREFHLD
SUM 
    CFARE
    PFARE
    CNET_TKT
    PNET_TKT
    FARE_PAID
    VASAVINGS
    MRK_CNT
    NET_TKT_CNT
    AIRLINE_NAME
    COMPUTE CPRF_AIR/A1=IF CPREF_AIR GT 0 THEN 'P' ELSE 'N';
    COMPUTE PPRF_AIR/A1 = IF PPREF_AIR GT 0 THEN 'P' ELSE 'N';
    COMPUTE CPREF_NET/P12 = IF CPRF_AIR EQ 'P' THEN CNET_TKT ELSE 0;
BY ROLLUP_CODE
BY VAL_AIRLINE
BY TKT_NUM
BY DOM_INTL_CODE
BY YEAR
BY TRAN
BY CURRENT
BY PRIOR
BY PYTD
BY PQ
BY CQ
BY CATEGORY
BY BR_CL_IDX
BY TRN_DATE
BY FST_DPT_DATE
WHERE CQ EQ 'Y' OR PQ EQ 'Y'
ON TABLE HOLD AS PREFAIRHLD
END
-RUN
 


TABLE FILE PREFAIRHLD
SUM CFARE/P12.2 AS 'CPREF' CNET_TKT/P12 AS 'CPREFT' 
BY ROLLUP_CODE
BY VAL_AIRLINE
WHERE CPRF_AIR EQ 'P' 
WHERE CQ EQ 'Y'
ON TABLE HOLD AS PREFCUR
END
-RUN



TABLE FILE PREFAIRHLD
SUM PFARE/P12.2 AS 'PPREF'  PNET_TKT/P12 AS 'PPREFT' 
BY ROLLUP_CODE
BY AIRLINE_NAME
BY VAL_AIRLINE
WHERE PPRF_AIR EQ 'P' 
WHERE PQ EQ 'Y'
ON TABLE HOLD AS PREFPR
END
-RUN



MATCH FILE PREFCUR
SUM CPREF CPREFT 
BY ROLLUP_CODE
ON TABLE HOLD
RUN
FILE PREFPR
SUM PPREF PPREFT 
BY ROLLUP_CODE
AFTER MATCH HOLD AS CPPREF OLD-OR-NEW
END
-RUN

TABLE FILE PREFAIRHLD
SUM CFARE/P12.2 AS 'CURAMT'
    PFARE/P12.2 AS 'PRAMT'
    CNET_TKT/P12 AS 'CURNETT'
    PNET_TKT/P12 AS 'PRNETT'
BY ROLLUP_CODE
ON TABLE HOLD AS TOTNET
END
-RUN


MATCH FILE CPPREF
PRINT CPREF 
      CPREFT
      PPREF
      PPREFT
BY ROLLUP_CODE
ON TABLE HOLD
RUN
FILE TOTNET
SUM CURAMT
    CURNETT
    PRAMT
    PRNETT
BY ROLLUP_CODE
AFTER MATCH HOLD AS PREFTOT OLD-OR-NEW
END
-RUN

TABLE FILE PREFTOT
SUM CURAMT CURNETT PRAMT PRNETT CPREF CPREFT PPREF PPREFT
-*COMPUTE CPRPCT/P12.1% = IF ((CURAMT LT 1) AND (CURAMT GT (-1))) THEN 0 ELSE (CPREF/CURAMT) *100;
-*COMPUTE PPRPCT/P12.1% = IF ((PRAMT LT 1) AND (PRAMT GT (-1))) THEN 0 ELSE (PPREF/PRAMT) *100;
-*COMPUTE CPRPCTT/P12.1% = IF ((CURNETT LT 1) AND (CURNETT GT (-1))) THEN 0 ELSE (CPREFT/CURNETT) *100;
-*COMPUTE PPRPCTT/P12.1% = IF ((PRNETT LT 1) AND (PRNETT GT (-1))) THEN 0 ELSE (PPREFT/PRNETT) *100;
BY ROLLUP_CODE
ON TABLE HOLD AS &&HXPFD001
END
-RUN







-INCLUDE QR_KPIPA_REPORT
