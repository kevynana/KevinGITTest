-* 2/23/05 - JK Added TNT_COMPANY eq '1' or '2'
-*04/20/10   DEB                CHANGED ORIG_SALE DEFINE
-*1/30/14 UPDATED ONLINE/TRADITIONAL DEFINES TO USE ONLINE_TRADITIONAL FIELD INSTEAD OF DOD_TYPE
-*5/23/14    DEB     ADDED EX5 TO NUMEROUS DEFINES

-INCLUDE SETECHO
SET ASNAMES = ON

-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED
-*========================================================================
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

TABLE FILE &&EXTRACT
PRINT 
   AGENT_NUM
-* AIR_KEY
   CONJ_REL
   DOC_TYPE
   DOD_TYPE
   DOD_DESC
   EMBARK
   EX_FLAG
   EXCHG_SALE
   RESV_BRANCH
   RF_FLAG
   SEG_AMT/D12.2
   SEG_COM/D12.2
   SEG_COUNT
   SEG_NBR
   SEG_TAX/D12.2
   TICKET_CODE
   TKT_SORT
   TRN_DATE
   TKT_NUM
   TICKET_BRANCH
   VOID_DATE
   VOID_STATUS
-* BY TKT_SORT NOPRINT
BY AIR_KEY
-INCLUDE &AIRDATES
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS TC_TRAN 
END
-RUN

-IF &LINES EQ 0 THEN GOTO NEXTONE;


TABLE FILE &&EXTRACT
PRINT DOD_DESC
   EX_FLAG
   EXCHG_SALE
   RF_FLAG
   SEG_AMT/D12.2
   SEG_TAX/D12.2
   TRN_DATE
   TKT_NUM
   SEG_NBR
   TKT_SORT
BY AIR_KEY
-INCLUDE RPTPARMS
-*WHERE TNT_COMPANY EQ '1' OR '2'
WHERE EX_FLAG NE ' '
ON TABLE HOLD AS TC_EXCH
END
-RUN



-INCLUDE TCUDAUSE
-RUN


TABLE FILE &&EXTRACT2
PRINT AUD_DATA AS 'QCC_FB'
BY AIR_KEY
WHERE UDID EQ 'QCC'
ON TABLE HOLD AS TCUDH1 
END
-RUN

-IF &LINES EQ 0 THEN GOTO NOUDID; 



MATCH FILE TC_TRAN
PRINT AGENT_NUM DOC_TYPE DOD_TYPE EMBARK EX_FLAG EXCHG_SALE RESV_BRANCH RF_FLAG SEG_AMT
  SEG_COM SEG_COUNT SEG_NBR SEG_TAX TKT_SORT TRN_DATE TKT_NUM TICKET_BRANCH
  VOID_DATE VOID_STATUS TICKET_CODE CONJ_REL DOD_DESC
BY AIR_KEY
ON TABLE HOLD
RUN 
FILE TCUDH1
SUM QCC_FB
BY AIR_KEY
AFTER MATCH HOLD AS TC_TRAN1 OLD
END
-RUN

 
 
 


DEFINE FILE TC_TRAN1


FLAG/A1 = 'A';
EMCO_TAX/D15 = IF DOC_TYPE EQ '1' AND EXCHG_SALE EQ 'E' THEN SEG_TAX 
  ELSE 0;	
EXCH_AMT/D15 = IF (DOC_TYPE EQ '1' AND EXCHG_SALE EQ 'E') THEN 0 ELSE IF 
  ((EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (EMBARK NE 'DT1' OR 
  'RF1' OR 'FP3') AND (RF_FLAG EQ ' ')) OR ((SEG_COUNT GE 0) AND 
  (EXCHG_SALE NE ' ')) OR (EMBARK EQ 'EX1' OR 'EX5') THEN SEG_AMT ELSE 0;	
EXCH_MCO/D15 = IF DOC_TYPE EQ '1' AND EXCHG_SALE EQ 'E' THEN SEG_AMT 
  ELSE 0;	
EXCH_TAX/D15 = IF (DOC_TYPE EQ '1' AND EXCHG_SALE EQ 'E') THEN 0 ELSE IF 
  ((EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (EMBARK NE 'DT1' OR 
  'RF1' OR 'FP3') AND (RF_FLAG EQ ' ')) OR ((SEG_COUNT GE 0) AND 
  (EXCHG_SALE NE ' ')) OR (EMBARK EQ 'EX1' OR 'EX5') THEN SEG_TAX ELSE 0;	
EXMCOS/D15 = IF (EX_FLAG NE ' ') AND (DOC_TYPE EQ '1') AND (EXCHG_SALE 
	NE ' ') THEN 1 ELSE 0;  
FARE_PAID/D15 = SEG_AMT + SEG_TAX;	
FULL_RFNDS/D15 = IF ((VOID_DATE EQ 0) AND (RF_FLAG EQ 'F') AND (TKT_NUM 
          NE LAST TKT_NUM) AND (SEG_COUNT LT 0)) THEN 1 ELSE 0;
IFLAG/A42 = DOD_DESC;

-*IFLAG/A33 = IF DOD_TYPE EQ 'I' OR 'J' THEN 'ONLINE BOOKINGS' ELSE
-*     IF DOD_TYPE EQ 'M' OR 'X' THEN 'EXCHANGE FROM AN INTERNET BOOKING' ELSE
-*     IF DOD_TYPE EQ 'A' OR 'L' OR 'N' OR 'S' THEN 'WEB BOOKINGS' ELSE
-*     'TRADITIONAL BOOKINGS'; 	
NEW_SALES/D15 = IF (SEG_AMT GT 0) AND (SEG_COUNT GE 0) AND (EXCHG_SALE 
  EQ ' ') AND (EMBARK NE 'EX1' OR 'RF1' OR 'EX5') THEN SEG_AMT ELSE 0;	
NEW_TAX/D15 = IF ((SEG_TAX GT 0) AND (SEG_COUNT GE 0) AND (EXCHG_SALE EQ 
  ' ') AND (EMBARK NE 'EX1' OR 'RF1' OR 'EX5')) THEN SEG_TAX ELSE 0;	
NEW_TOTAL/D15 = NEW_SALES + NEW_TAX;	
-*ORIG_SALE/D15 = IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND (SEG_COUNT 
-* EQ 1) AND (EXCHG_SALE EQ ' ') THEN 1 ELSE IF (DOC_TYPE EQ '1') AND
-* (EX_FLAG EQ ' ') AND (EXCHG_SALE NE ' ') THEN 1 ELSE 0;



ORIG_SALE/D9 = IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND 
     (SEG_COUNT EQ 1) AND (EXCHG_SALE EQ ' ') THEN 1 ELSE 
     IF (DOC_TYPE EQ '1') AND (EX_FLAG EQ ' ') AND (EXCHG_SALE NE ' ') AND
     (RF_FLAG EQ ' ') THEN 1 ELSE 0;	

PART_RFNDS/D15 = IF ((VOID_DATE EQ 0) AND (RF_FLAG EQ 'P') AND (TKT_NUM 
  NE LAST TKT_NUM) AND (SEG_COUNT LE 0)) THEN 1 ELSE 0;	
REFUND_AMT/D15 = IF ((RF_FLAG EQ 'F' OR 'P') AND (EMBARK NE 'EX1' OR 
  'FP2' OR 'EX5') AND (SEG_COUNT LE 0)) OR (EMBARK EQ 'RF1') THEN SEG_AMT ELSE 0;	
REFUND_TAX/D15 = IF ((RF_FLAG EQ 'F' OR 'P') AND (EMBARK NE 'EX1' OR 
  'FP2' OR 'EX5') AND (SEG_COUNT LE 0)) OR (EMBARK EQ 'RF1') THEN SEG_TAX ELSE 0;	
REFUND_TOTAL/D15 = IF ((RF_FLAG EQ 'F' OR 'P') AND (EMBARK NE 'EX1' OR 
  'FP2' OR 'EX5') AND (SEG_COUNT LE 0)) OR (EMBARK EQ 'RF1') THEN FARE_PAID ELSE 0;	
REFUNDS/D9 = FULL_RFNDS + PART_RFNDS;	
TKT_CNT/D8CS = IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND (SEG_COUNT 
  EQ 1) THEN 1 ELSE 0;	


TOTL/A15 = 'TOTAL NEW SALES';	

TRAN_DT/MDYY = TRN_DATE;	
VOID_AMT/D15 = IF VOID_DATE NE 0 THEN SEG_AMT ELSE 0;	
VOID_TAX/D15 = IF VOID_DATE NE 0 THEN SEG_TAX ELSE 0;	
VOID_TOTAL/D15 = IF VOID_DATE NE 0 THEN FARE_PAID ELSE 0;	
VOIDS/D9 = IF (VOID_DATE NE 0) AND (SEG_COUNT EQ 1) AND (SEG_NBR EQ '01')
 THEN 1 ELSE IF (DOC_TYPE EQ '1' AND VOID_DATE NE 0) THEN 1 ELSE 0;	

-* Defines on previous DEFINEs
TOT_ETAX/D15 = EXCH_TAX + EMCO_TAX;	
TOT_EXCH/D15 = EXCH_AMT + EXCH_MCO;
EMCO_TOTAL/D15 = IF DOC_TYPE EQ '1' AND EXCHG_SALE EQ 'E' THEN FARE_PAID 
  ELSE 0;	
EXCHGS/D15 = IF (EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (EMBARK 
                 NE 'DT1' OR 'RF1' OR 'FP3') THEN TKT_CNT ELSE
  IF (DOC_TYPE EQ '1') AND (EXCHG_SALE EQ 'E') THEN 0 ELSE
  IF (SEG_COUNT GE 0) AND (EXCHG_SALE NE ' ') THEN TKT_CNT ELSE 0;  

EXCH_TOTAL/D15 = IF (DOC_TYPE EQ '1' AND EXCHG_SALE EQ 'E') THEN 0 ELSE 
   IF (((EXCHG_SALE NE ' ') AND (SEG_COUNT GE 0)) OR ((EMBARK NE 'DT1' OR 
  'RF1' OR 'FP3') AND (RF_FLAG EQ ' ') AND (EX_FLAG EQ 'F' OR 'P') AND 
  (SEG_COUNT LE 0)) OR (EMBARK EQ 'EX1' OR 'EX5')) THEN FARE_PAID ELSE 0;
PEXCHGS/D15 = IF EXCHGS EQ 1 AND (EX_FLAG EQ 'P') AND (SEG_COUNT LE 0) AND (EMBARK 
                 NE 'DT1' OR 'RF1' OR 'FP3')THEN 1 ELSE 0;
  
MCO_AMT/D15 = IF DOC_TYPE EQ '1' THEN NEW_SALES ELSE 0;	
MCO_CNT/D15 = IF DOC_TYPE EQ '1' THEN ORIG_SALE ELSE 0;		
MCO_TAX/D15 = IF DOC_TYPE EQ '1' THEN NEW_TAX ELSE 0;	
MCO_TOTAL/D15 = IF DOC_TYPE EQ '1' THEN NEW_TOTAL ELSE 0;
MCOS/D15CS           = IF (DOC_TYPE EQ '1') AND
                           (EX_FLAG EQ ' ')  AND
                           (EXCHG_SALE NE ' ') THEN 1 ELSE 0;	

PRFND_AMT/D12 = IF RF_FLAG EQ 'P' THEN REFUND_AMT ELSE 0;	
PRFND_TAX/D12 = IF RF_FLAG EQ 'P' THEN REFUND_TAX ELSE 0;	
PRFND_TOTAL/D12 = IF RF_FLAG EQ 'P' THEN REFUND_TOTAL ELSE 0;	
TOTAL_EXCHG/D12.2 = EXCH_TOTAL + EMCO_TOTAL;	
TOT_ECNT/D9 = EXCHGS + EXMCOS;	
TOT_TRANS/D9 = ORIG_SALE + VOIDS + TOT_ECNT + REFUNDS;	
CHARGE_TRN/D9 = ORIG_SALE + VOIDS + EXCHGS + REFUNDS;
KW_TRN/D9 = ORIG_SALE + EXCHGS;
TRN_TYPE/A4 = IF (VOIDS EQ 1) THEN 'VOID' ELSE IF (ORIG_SALE EQ 1) THEN 
  'SALE' ELSE IF (TOT_ECNT EQ 1) THEN 'EXCH' ELSE IF (REFUNDS EQ 1) THEN 
  'RFND' ELSE ' ';	
FEE1/D12.2CS = 35.25;


NET_AMT/D15 = NEW_SALES + REFUND_AMT + TOT_EXCH - VOID_AMT;	
NET_TAX/D15 = NEW_TAX + REFUND_TAX + TOT_ETAX - VOID_TAX;	
TOTAL_EXCHG/D15 = EXCH_TOTAL + EMCO_TOTAL;
TOT_EXAMT/D15 = EXCH_AMT + EXCH_MCO;	
TOT_EXTAX/D15 = EXCH_TAX + EMCO_TAX;
TOT_ECNT/D15 = EXCHGS + EXMCOS;	
TOT_TRANS/D15 = ORIG_SALE + VOIDS + TOT_ECNT + REFUNDS;	
CHARGE_TRN/D15 = ORIG_SALE + VOIDS + EXCHGS + REFUNDS;
NET_TOTAL/D15 = NEW_TOTAL + REFUND_TOTAL + TOTAL_EXCHG - VOID_TOTAL;
-*F_EXCH_CNT/D15   = IF (TICKET_CODE EQ '1') AND
-*                           (SEG_NBR EQ '01') AND
-*                           (FARE_PAID GE 0) AND
-*                           (SEG_COUNT EQ 1) AND 
-*                           (CONJ_REL EQ 1) THEN 0 ELSE 
F_EXCH_CNT/D15 =  IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN 1 ELSE 0;
-*P_EXCH_CNT/D15  = IF (TICKET_CODE EQ '1') AND
-*                           (FARE_PAID GE 0) AND
-*                           (SEG_COUNT EQ 1) AND 
-*                           (CONJ_REL EQ 1) THEN 0 ELSE 
P_EXCH_CNT/D15 =  IF (TICKET_CODE EQ '1') AND
                           (EX_FLAG EQ 'P') THEN 1 ELSE 0;
F_EXCH_AMT/D15 = IF F_EXCH_CNT EQ 1 THEN FARE_PAID ELSE 0;
P_EXCH_AMT/D15 = IF P_EXCH_CNT EQ 1 THEN FARE_PAID ELSE 0;
ROLLCD/A8 = '&&ROLL'; 

END

-* -IF &LINES EQ 0 THEN GOTO NEXTONE;
-*========================================================================
-*   PROCESS EXTRACTED DATA FROM ABOVE
-*========================================================================


TABLE FILE TC_TRAN1
SUM
  ORIG_SALE 
  EXCHGS 
  EXMCOS 
  REFUNDS 
  MCOS  
  VOIDS 
  TOT_TRANS 
  NEW_SALES 
  NEW_TAX 
  NEW_TOTAL 
  EXCH_AMT 
  EXCH_TAX 
  EXCH_TOTAL  
  EXCH_MCO 
  EMCO_TAX 
  EMCO_TOTAL 
  REFUND_AMT 
  REFUND_TAX 
  REFUND_TOTAL 
  RESV_BRANCH
  MCO_AMT 
  MCO_TAX 
  MCO_TOTAL 
  VOID_AMT 
  VOID_TAX 
  VOID_TOTAL 
  NET_AMT 
  NET_TAX 
  NET_TOTAL 
  QCC_FB
  ROLLCD
  IFLAG
BY TKT_NUM  
WHERE QCC_FB NE ' '
ON TABLE HOLD AS TCT1
END
-RUN


TABLE FILE TCT1
SUM 
  EXCHGS 
BY TKT_NUM
WHERE EXCHGS NE 0
ON TABLE HOLD AS TCT2
END
-RUN



DEFINE FILE TC_EXCH
FARE_PAID/D12.2CS = SEG_AMT + SEG_TAX;
DOC_NUMBER/A10 = EDIT(AIR_KEY, '$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$9999999999');
TSORT/A10 = EDIT(TKT_SORT, '9999999999');
NEW_FARE/D12.2CS = IF DOC_NUMBER NE '0000000000' AND SEG_NBR NE ' ' THEN FARE_PAID ELSE 0;
END
TABLE FILE TC_EXCH
SUM EX_FLAG TSORT AS 'TKT_NUM'
BY AIR_KEY    
WHERE EX_FLAG NE ' '
ON TABLE HOLD AS EXCHGHOLD
END
-RUN

DEFINE FILE EXCHGHOLD
F_EXCH_CNT/D15 = IF EX_FLAG EQ 'F' THEN 1 ELSE 0;
P_EXCH_CNT/D15 = IF EX_FLAG EQ 'P' THEN 1 ELSE 0;
END
TABLE FILE EXCHGHOLD
SUM EX_FLAG F_EXCH_CNT P_EXCH_CNT  
BY TKT_NUM
ON TABLE HOLD AS EXHLD2
END
-RUN

DEFINE FILE EXHLD2
F_EXCH_CNT2/D15 = IF F_EXCH_CNT GT 1 THEN 1 ELSE F_EXCH_CNT;
P_EXCH_CNT2/D15 = IF P_EXCH_CNT GT 1 THEN 1 ELSE P_EXCH_CNT;
END
TABLE FILE EXHLD2
SUM F_EXCH_CNT2 AS 'F_EXCH_CNT' P_EXCH_CNT2 AS 'P_EXCH_CNT'
BY TKT_NUM
ON TABLE HOLD AS EXHLD3
END
-RUN


MATCH FILE TCT2
PRINT EXCHGS 
BY TKT_NUM
RUN
FILE EXHLD3
SUM F_EXCH_CNT P_EXCH_CNT
BY TKT_NUM
AFTER MATCH HOLD AS TCT3 OLD
END
-RUN


MATCH FILE TCT1
PRINT 
ORIG_SALE 
EXCHGS 
EXMCOS 
REFUNDS 
MCOS  
VOIDS 
TOT_TRANS 
NEW_SALES 
NEW_TAX 
NEW_TOTAL 
EXCH_AMT 
EXCH_TAX 
EXCH_TOTAL  
EXCH_MCO 
EMCO_TAX 
EMCO_TOTAL 
REFUND_AMT 
REFUND_TAX 
REFUND_TOTAL
RESV_BRANCH
MCO_AMT 
MCO_TAX 
MCO_TOTAL 
VOID_AMT 
VOID_TAX 
VOID_TOTAL 
NET_AMT 
NET_TAX 
NET_TOTAL 
QCC_FB
ROLLCD
IFLAG
BY TKT_NUM
ON TABLE HOLD
RUN
FILE TCT3
SUM F_EXCH_CNT P_EXCH_CNT
BY TKT_NUM
AFTER MATCH HOLD AS TCT4 OLD
END
-RUN


TABLE FILE TCT4
SUM
  ORIG_SALE 
  EXCHGS
  EXMCOS 
  REFUNDS 
  MCOS  
  VOIDS 
  TOT_TRANS
  NEW_SALES
  NEW_TAX
  NEW_TOTAL
  EXCH_AMT
  EXCH_TAX
  EXCH_TOTAL
  EXCH_MCO
  EMCO_TAX
  EMCO_TOTAL
  REFUND_AMT
  REFUND_TAX
  REFUND_TOTAL
  MCO_AMT
  MCO_TAX
  MCO_TOTAL
  VOID_AMT
  VOID_TAX
  VOID_TOTAL
  NET_AMT
  NET_TAX
  NET_TOTAL
  QCC_FB
  F_EXCH_CNT
  P_EXCH_CNT
BY ROLLCD
BY RESV_BRANCH
BY IFLAG
ON TABLE HOLD AS TCT5
END
-RUN




MODIFY FILE TCTRANQC
FIXFORM FROM TCT5
DATA ON TCT5
END
-RUN

-NOUDID



-NEXTONE

