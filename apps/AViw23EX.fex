-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File AVIW23EX.FEX
-********************************************************************
-* MODIFICAIONS:
-********************************************************************
-*
-* This program extracts data for the series of basic ticket listing
-* reports.  Based on the user profile selected, one of many report 
-* formats will be produced.  
-* 12/29/04 - DEB - ADDED FILEDEF FOR FUJI REPORT - DEB
-* 1/25/05  - DEB - ADDED CODE FOR GLOBAL CURRENCY
-* 8/29/05  - DEB - ADDED BDGA_DPT DEFINE
-*  02/02/2015  REJ  S-05681 Changes to the no data report to prepare for the Available
-*                           Report changes.  Rollup Code is being removed from BRPTINST in
-*                           ER5, so I'm removing the reference to the ROLLUP_CODE in that report.
-*06/18/15 DEB               S-09799 ADDED ONLINE_TRADITIONAL
-*3/2/16 - JEM -S-16367 Updated hard coded d:\ to use &&WFSRV1.EVAL
-*4/21/2017-JEM-S-33318-updated logic for no records report

-********************************************************************

SET ASNAMES = ON
-SET HOLDATTR = ON;

FI FUJILIST DISK &&WFSRV1.EVAL\TNT\TTRACKER\TEMP\FUJILIST.TXT

-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

DEFINE FILE &&EXTRACT
  MTG_CODE/A2=EDIT(CLIENT_NUM, '99'); 
  LEVEL_DESC/A60 = &&LDESC;
  BDGA_DPT/A3 = EDIT(LEVEL1, '999$$$$$$$$$$$$');
  
END
-RUN

TABLEF FILE &&EXTRACT
PRINT 
  AIR_KEY   
  AIRLINE
  BDGA_DPT
  BR_CL_IDX 
  CLASS 
  DOD_DESC
  DOC_TYPE  
  DOD_TYPE
  DPT_DATE  
  DST_APC
  EMBARK    
  EX_FLAG   
  EXCHG_SALE    
  GRAND_MSTR_CODE   
  GROUP_CODE
  INVOICE_NUM   
  LEVEL1    
  LEVEL2    
  LEVEL3
  LEVEL_DESC
  MTG_CODE  
  MSTR_GRP_CODE 
  ONLINE_TRADITIONAL
  ORG_APC
  PASSNGR_NAME  
  REFUSE_KEY    
  RESV_BRANCH   
  RF_FLAG
  SEG_AMT   
  SEG_COM   
  SEG_COUNT
  SEG_NBR   
  SEG_TAX
  TKT_DATE  
  TKT_NUM
  TRN_DATE  
  VAL_AIRLINE   
  VOID_DATE     
  VOID_STATUS   

-INCLUDE &AIRDATES
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS

ON TABLE HOLD AS RPTHOLD
END
-RUN

TABLE FILE RPTHOLD
PRINT AIR_KEY   
  AIRLINE
  BDGA_DPT
  BR_CL_IDX 
  CLASS 
  DOC_TYPE  
  DOD_DESC
  DOD_TYPE
  DPT_DATE  
  DST_APC
  EMBARK    
  EX_FLAG   
  EXCHG_SALE    
  GRAND_MSTR_CODE   
  GROUP_CODE
  INVOICE_NUM   
  LEVEL1    
  LEVEL2    
  LEVEL3
  LEVEL_DESC
  MTG_CODE  
  MSTR_GRP_CODE 
  ONLINE_TRADITIONAL
  ORG_APC
  PASSNGR_NAME  
  REFUSE_KEY    
  RESV_BRANCH   
  RF_FLAG
  SEG_AMT   
  SEG_COM   
  SEG_COUNT
  SEG_NBR   
  SEG_TAX
  TKT_NUM
  TRN_DATE  
  VAL_AIRLINE   
  VOID_DATE     
  VOID_STATUS
BY TKT_DATE 
ON TABLE HOLD AS AIRHOLD FORMAT FOCUS INDEX TKT_DATE
END
-RUN

-* Global Reporting JOIN
JOIN AIRHOLD.TKT_DATE IN AIRHOLD TO GLOBAL.DATE IN GLOBAL AS J1


DEFINE FILE AIRHOLD
NAMEC/A30 = CNAME;

-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
GSEG_TAX/D20.6 = SEG_TAX * CURR1X;
GSEG_AMT/D20.6 = SEG_AMT * CURR1X;
GSEG_COM/D20.6 = SEG_COM * CURR1X;

END
-RUN     


TABLE FILE AIRHOLD
PRINT AIR_KEY   
  AIRLINE
  BDGA_DPT
  BR_CL_IDX 
  CLASS 
  DOC_TYPE
  DOD_DESC
  DOD_TYPE
  DPT_DATE 
  DST_APC
  EMBARK    
  EX_FLAG   
  EXCHG_SALE    
  GRAND_MSTR_CODE   
  GROUP_CODE
  INVOICE_NUM   
  LEVEL1    
  LEVEL2    
  LEVEL3
  LEVEL_DESC
  MTG_CODE  
  MSTR_GRP_CODE 
  ONLINE_TRADITIONAL
  ORG_APC
  PASSNGR_NAME  
  REFUSE_KEY    
  RESV_BRANCH   
  RF_FLAG
  SEG_AMT   
  SEG_COM   
  SEG_COUNT
  SEG_NBR   
  SEG_TAX
  TKT_DATE
  TKT_NUM
  TRN_DATE  
  VAL_AIRLINE   
  VOID_DATE     
  VOID_STATUS
  NAMEC
  GSEG_AMT/D16.2CS
  GSEG_TAX/D16.2CS
  GSEG_COM/D16.2CS
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS TRANSAIR
END
-RUN   

-GOTO XXIT; 

-*-EXIT

-NORECORDS
-SET &INST_KEY = &&IKEY;

TABLE FILE BRPTINST
PRINT PAIR_DB RPT_GROUP RPT_STREAM GLOBAL_PARM USE_PARM INST_KEY
WHERE INST_KEY EQ &INST_KEY
ON TABLE SAVE AS PAIRDB
END
-RUN

-READ PAIRDB &PAIRDB.A1. &RPTGRP.A3. &RPTSTREAM.A8. &SETFILE.A8. &VIEW.A8.
-CLOSE PAIRDB
 
-SET &RPTGRP = '&RPTGRP.EVAL';
-SET &VIEW = '&VIEW.EVAL';
-SET &STREAM = '&RPTSTREAM.EVAL';

-SET &HEADER = IF &RPTGRP EQ 'ADD' THEN 'NORECHDRDD' ELSE 'NORECHDR';
-RUN


-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN &HEADER ELSE  
-              IF &RPTGRP EQ 'ADD' THEN 'HDREXLSDD' ELSE 
-              IF &STREAM EQ 'AIR_BNM' THEN 'HDREXLSDD' ELSE 'HDREXLS';

-RUN


-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE 'NORECSTY';

JOIN SET_KEY IN BRPTINST TO SET_KEY IN BRPT_SET AS J1
-RUN

DEFINE FILE BRPTINST
EMPTY/A35 = 'NO RECORDS FOUND FOR THIS SELECTION';
NOWTOD/A8 WITH INST_KEY = HHMMSS (NOWTOD);
END
TABLE FILE BRPTINST
-INCLUDE &&PAHDR
PRINT EMPTY AS 'REPORT,MESSAGE'
BY ROLLUP_CODE AS 'ROLLUP,CODE'
BY RPT_NAME AS 'REPORT,NAME'
BY SELECT_LEV AS 'BREAK,LEVEL'
IF INST_KEY EQ &&IKEY
IF RECORDLIMIT EQ 1
-INCLUDE FOOTERDT
ON TABLE SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET PAGE-NUM OFF
ON TABLE SET STYLE *
-INCLUDE &&PASTYD
ENDSTYLE
 
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN

-XXIT;
