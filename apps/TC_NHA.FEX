-*  08/23/2016  REJ  S-17914 Changes for ER5.
-*  12/29/2016  REJ  S-28553 Move ER5 My Reports to production.
-* 01/26/2017 - S-29510 - UPDATED TO USE NEW HOTEL ATTACHENT LOGIC
-DEFAULT &&FROMER5 = 'N';
-DEFAULT &&ROLLEMAIL = ' '; 
-INCLUDE SETECHO
 
CREATE FILE TC_NHA
-RUN
 
-*CREATE FILE TC_NHH
-*-RUN
 
-*CREATE FILE TC_NCC
-*-RUN
 
-INCLUDE TCGETROLL
-RUN
 
 
-SET &CNT = 1;
-REPEAT Loop2 &TOTROLLS TIMES
-SET &&ROLL = &ROLL.&CNT;
 
 
EX TCAIRDB
-RUN
 
 
-IF &FOCERRNUM EQ 36 THEN GOTO IncLoop2;
 
EX TCNHAGENTEX
-RUN
 
-*EX TCHTLDB
-*-RUN
 
-*EX TCHAGENTEX
-*-RUN
 
-*EX TCHHAGTEX
-*-RUN
 
-*EX TCCARDB
-*-RUN
 
-*EX TCCHAGTEX
-*-RUN
 
 
-IncLoop2
-SET &CNT = &CNT + 1;
-Loop2
 
 
-INCLUDE SetParmtime
-RUN
 
-IF &&FROMAVRP NE 'Y' GOTO :AVSF0;
-INCLUDE AVRP_SUBFOOT
-:AVSF0
 
-******************************************************************
-* GET THE FINAL REPORT
-******************************************************************

-GOTO SKIPoldcode;
TABLE FILE TC_NHA
SUM NEW_STAY AIR_VOL
BY ROLLCD
BY TKT_NUM
BY AGENT_NUM
ON TABLE HOLD AS HLDTKT1
END
-RUN
 
TABLE FILE TC_NHH
SUM NNROOMS1 NNROOMS2 HBOOK
BY ROLLCD
BY TKT_NUM
BY AGENT_NUM
ON TABLE HOLD AS HLDHTL1
END
-RUN
 
MATCH FILE HLDTKT1
SUM NEW_STAY AIR_VOL
BY ROLLCD
BY TKT_NUM
BY AGENT_NUM
ON TABLE HOLD
RUN
FILE HLDHTL1
SUM NNROOMS1 NNROOMS2 HBOOK
BY ROLLCD
BY TKT_NUM
BY AGENT_NUM
AFTER MATCH HOLD AS HLDAH1 OLD-OR-NEW
END
-RUN
 
TABLE FILE HLDAH1
SUM NEW_STAY AS 'TSTAY' NNROOMS1 AS 'TNN1'
BY ROLLCD
BY TKT_NUM
ON TABLE HOLD AS TTLHLD1
END
-RUN
 
TABLE FILE TTLHLD1
SUM TSTAY TNN1
COMPUTE STAY1/P12C = IF (TSTAY EQ 0) AND (TNN1 NE 0) THEN TNN1 ELSE TSTAY;
COMPUTE NOHOTEL/P12C = STAY1 - TNN1;
COMPUTE ZFLAG/A1 = IF TKT_NUM EQ '0000000000' THEN 'Y' ELSE
                   IF (TSTAY EQ 0) AND (TNN1 EQ 0) THEN 'Y' ELSE 'N';
BY ROLLCD
BY TKT_NUM
ON TABLE HOLD AS TTLHLD2
END
-RUN
 
TABLE FILE TTLHLD2
SUM TSTAY TNN1 STAY1 NOHOTEL
BY ROLLCD
BY TKT_NUM
WHERE ZFLAG EQ 'N'
ON TABLE HOLD AS TTLHLD3
END
-RUN
 
TABLE FILE HLDAH1
PRINT NNROOMS2 HBOOK AIR_VOL AGENT_NUM
BY ROLLCD
BY TKT_NUM
ON TABLE HOLD AS HLDAH2
END
-RUN
 
MATCH FILE HLDAH2
PRINT NNROOMS2 HBOOK AIR_VOL
BY ROLLCD
BY TKT_NUM
BY AGENT_NUM
ON TABLE HOLD
RUN
FILE TTLHLD3
PRINT TSTAY TNN1 STAY1 NOHOTEL
BY ROLLCD
BY TKT_NUM
AFTER MATCH HOLD AS THLDAH1 OLD-OR-NEW
END
-RUN
 
 
TABLE FILE THLDAH1
SUM TSTAY TNN1 STAY1 NNROOMS2 NOHOTEL HBOOK AIR_VOL
COMPUTE ZF/A1 = IF TKT_NUM EQ '0000000000' THEN 'N' ELSE
                IF (TSTAY EQ 0) AND (TNN1 EQ 0) THEN 'Y' ELSE 'N';
BY ROLLCD
BY TKT_NUM
BY AGENT_NUM
ON TABLE HOLD AS THLDAH2
END
-RUN
 
TABLE FILE THLDAH2
SUM STAY1 TSTAY TNN1 NNROOMS2 NOHOTEL HBOOK AIR_VOL
BY ROLLCD
BY TKT_NUM
BY AGENT_NUM
WHERE ZF EQ 'N'
ON TABLE HOLD AS THLDAH3
END
-RUN
 
 
TABLE FILE TC_NCC
SUM CBOOK
BY ROLLCD
BY TKT_NUM
BY AGENT_NUM
ON TABLE HOLD AS HLDCAR1
END
-RUN
 
MATCH FILE THLDAH3
PRINT TSTAY STAY1 TNN1 NNROOMS2 NOHOTEL HBOOK AIR_VOL
BY ROLLCD
BY TKT_NUM
BY AGENT_NUM
ON TABLE HOLD
RUN
FILE HLDCAR1
SUM CBOOK
BY ROLLCD
BY TKT_NUM
BY AGENT_NUM
AFTER MATCH HOLD AS HLDAHC1 OLD-OR-NEW
END
-RUN

-SKIPoldcode;

TABLE FILE TC_NHA
SUM   HTL_ATTCH/D12 HTL_NOATTCH/D12 AIR_VOL/D12.2CS
COMPUTE TOT_ATTCH/D12 = HTL_ATTCH + HTL_NOATTCH;
BY AGENT_NUM
ON TABLE HOLD AS TCNH2
END
-RUN
 
TABLE FILE TCNH2
SUM HTL_ATTCH HTL_NOATTCH TOT_ATTCH AIR_VOL
BY AGENT_NUM
ON TABLE COLUMN-TOTAL
ON TABLE HOLD AS HLD1 FORMAT FOCUS INDEX AGENT_NUM
END
-RUN
 
JOIN AGENT_NUM IN HLD1 TO AGENT IN AGENT
-RUN
 
DEFINE FILE HLD1
FLAG/A1 = 'A';
AGT/A26=AGENT_NUM||'-'||AGENT_NAME;
END
TABLE FILE HLD1
SUM HTL_ATTCH HTL_NOATTCH TOT_ATTCH AIR_VOL
COMPUTE PCTNH/P8.1C% = IF TOT_ATTCH EQ 0 THEN 0 ELSE (HTL_NOATTCH/TOT_ATTCH)*100;
COMPUTE PCTH/P8.1C% = IF TOT_ATTCH EQ 0 THEN 0 ELSE (HTL_ATTCH/TOT_ATTCH)*100;
BY FLAG
BY HOME_BRANCH
BY AGT
ON TABLE HOLD AS HLD2 FORMAT FOCUS
END
-RUN
 
DEFINE FILE HLD1
FLAG/A1 = 'A';
AGT/A26='HOME BRANCH TOTAL';
END
TABLE FILE HLD1
SUM HTL_ATTCH HTL_NOATTCH TOT_ATTCH AIR_VOL
COMPUTE PCTNH/P8.1C% = IF TOT_ATTCH EQ 0 THEN 0 ELSE (HTL_NOATTCH/TOT_ATTCH)*100;
COMPUTE PCTH/P8.1C% = IF TOT_ATTCH EQ 0 THEN 0 ELSE (HTL_ATTCH/TOT_ATTCH)*100;
BY FLAG
BY HOME_BRANCH
BY AGT
ON TABLE HOLD AS HLD3 FORMAT FOCUS
END
-RUN
 
DEFINE FILE HLD1
FLAG/A1 = 'B';
HOME_BRANCH/A2 = ' ';
AGT/A26='TOTAL';
END
TABLE FILE HLD1
SUM HTL_ATTCH HTL_NOATTCH TOT_ATTCH AIR_VOL
COMPUTE PCTNH/P8.1C% = IF TOT_ATTCH EQ 0 THEN 0 ELSE (HTL_NOATTCH/TOT_ATTCH)*100;
COMPUTE PCTH/P8.1C% = IF TOT_ATTCH EQ 0 THEN 0 ELSE (HTL_ATTCH/TOT_ATTCH)*100;
BY FLAG
BY HOME_BRANCH
BY AGT
ON TABLE HOLD AS HLD4 FORMAT FOCUS
END
-RUN
 
USE CLEAR *
-RUN
 
USE
HLD2.FOC AS HLD2
HLD3.FOC AS HLD2
HLD4.FOC AS HLD2
END
 
 

-SET &&RPTSUF = 'SMY';
-INCLUDE FDEFRPTS
-RUN
 
-TYPE BEFORE DEFINES
 
DEFINE FILE HLD2
NOWTOD/A8 WITH HOME_BRANCH = HHMMSS (NOWTOD);
END
 
-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADER' ELSE 'HDREXLS';
-SET &&PASTYS = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE &&SMSTY;
 
TABLE FILE HLD2
-INCLUDE &&PAHDR
   &&S_SUBJ1
   &&S_SUBJ2
   &&S_SUBJ3
   &&S_SUBJ4
   &&S_SUBJ5
   &&S_SUBJ6
   &&S_SUBJ7
   &&S_SUBJ8
   &&S_SUBJ9
   &&S_SUBJ10
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10
 


FOOTING BOTTOM
" "
" "
"Report includes tickets with an overnight stay including one way tickets that could be attached."
"Hotel Attachment determined by looking at dates of airlines tickets and comparing it with any hotel booked during that date range."

-INCLUDE FOOTERSM
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
-INCLUDE &&PASTYS
TYPE=REPORT, COLUMN=N2, WRAP= 1.0,$
TYPE=REPORT, COLUMN=N3, WRAP= 2.25,$
TYPE=REPORT, COLUMN=N4, WRAP= 1.25,$
TYPE=REPORT, COLUMN=N5, WRAP= 1.25,$
TYPE=REPORT, COLUMN=N6, WRAP= 1.25,$
TYPE=REPORT, COLUMN=N7, WRAP= 1.25,$
TYPE=REPORT, COLUMN=N8, WRAP= 1.25,$
TYPE=REPORT, COLUMN=N9, WRAP= 1.25,$

-GOTO JOY
-INCLUDE GLOBAL_LOGO_SM
 
UNITS=IN, PAGESIZE='Letter', LEFTMARGIN=0.500000, RIGHTMARGIN=0.250000,
    TOPMARGIN=0.500000, BOTTOMMARGIN=0.250000, SQUEEZE=ON,
    ORIENTATION=LANDSCAPE, $
TYPE=REPORT, FONT=TIMES NEW ROMAN, SIZE=8, BACKCOLOR=NONE, STYLE=NORMAL, $
TYPE=DATA, FONT=TIMES NEW ROMAN, SIZE=9, STYLE=BOLD, WHEN=N3 EQ 'TOTAL                     ', $
TYPE=DATA, FONT=TIMES NEW ROMAN, SIZE=9, STYLE=BOLD, WHEN=N3 EQ 'HOME BRANCH TOTAL         ', $
TYPE=HEADING, OBJECT=TEXT, SIZE=8, COLOR=BLACK, $
TYPE=HEADING, LINE=4, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=5, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=6, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=7, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=8, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=10, SIZE=9, STYLE=BOLD, COLOR=GREY, $
TYPE=HEADING, LINE=11, SIZE=12, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=HEADING, LINE=12, SIZE=12, STYLE=BOLD+ITALIC, FONT=COURIER NEW, $
TYPE=FOOTING, SIZE=7, STYLE=BOLD, COLOR=GREY, $
TYPE=TITLE, STYLE=BOLD, $
TYPE=SUBFOOT, SIZE=9, STYLE=BOLD, $
TYPE=SUBTOTAL, SIZE=9, STYLE=BOLD, $
TYPE=GRANDTOTAL, SIZE=9, STYLE=BOLD, $
TYPE=REPORT, IMAGE=&&TNTPIC,  POSITION=(&&TNTSMPOS), SIZE=(&&TNTSMSIZ), $
TYPE=REPORT, IMAGE=&&ROLLPIC, POSITION=(&&ROLSMPOS), SIZE=(&&ROLSMSIZ), $

-JOY
ENDSTYLE
&&OUTLINE1
&&SUMMDEST
&&OUTLINE2
END
-RUN
 
-IF &LINES GT 0 THEN GOTO XXIT;
EX TCEMPTY
-RUN
 
-XXIT
