-* File UPDMILES.fex

SET ASNAMES=ON

-SET &CNT=0;

TABLE FILE ROLLUP
PRINT ROLLUP
BY ROLLUP NOPRINT
ON TABLE HOLD
END

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH COMPUTE PR_STAMP=' ';
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END

-* USE CLEAR *
-* USE
-*     C:\TNT\TTRACKER\SUDATA\ROLLUP.FOC AS ROLLUP
-* END

FI CUSTS DISK D:\LOAD\FOCTEMP\CUSTS.DAT
SET MESSAGE=ON
-*=======================================================================
SET ASNAMES=ON
DEFINE FILE ROLLUP
XL01/A1 = 'W' ;
END
TABLE FILE ROLLUP
BY ROLLUP NOPRINT
PRINT ROLLUP AS 'ROLLUP_CODE'
      XL01   AS 'PR_STAMP'
	  QTR_ENABLE
IF UPD_ENABLE NE ' '
IF ROLLUP NE 'TOTAL-R'
-* IF ROLLUP EQ 'METX-R' OR 'ACTON-R'
ON TABLE HOLD
END

MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
-*======================================================================
USE CLEAR *
-RUN
SET TEMPDIR=C:\FOCTEMP
SET MESSAGE=ON
SET WARNING=OFF
SET YRTHRESH=30
SET DEFCENT=19
-RUN
-*=======================================================================
-TOP
TABLE FILE ROLLUP
BY ROLLUP NOPRINT
PRINT ROLLUP COMP QTR_ENABLE
BY ROLLUP_CODE NOPRINT
IF RECORDLIMIT EQ 1
IF PR_STAMP EQ 'W'
ON TABLE SAVE AS CUSTS
END
-TYPE RECORDS = &RECORDS

-IF &RECORDS EQ 0 GOTO STOP;
-RUN
-READ CUSTS &&ROLLUP.A8 &&COMP.A6 &&QTR.A1.
-RUN

-TYPE QUARTER=&&QTR
-TYPE COMPANY=&&COMP

-IF &&QTR EQ 'X' THEN GOTO QUARTERA ELSE GOTO NOQUARTERA;
-QUARTERA
-TYPE INSIDE QUATERA
-SET &CNT=0;
-GOTO LOOP
-NOQUARTERA
-TYPE INSIDE NOQUARTERA
-SET &DATA = 'S'||'_'||&&COMP;
-GOTO SLOOP
-LOOP
-TYPE INSIDE LOOP
-SET &QTRC = IF (&CNT LT 10) THEN &CNT ELSE IF (&CNT EQ 10) THEN 'Y' ELSE IF (&CNT EQ 11) THEN 'Z' ELSE 'END';
-IF &QTRC = 'END' THEN GOTO TOP;

-TYPE QTR=&QTRC
-TYPE COUNT=&CNT

-SET &DATA = 'S'||&QTRC||&&COMP;
-SLOOP
-TYPE INSIDE SLOOP
-*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
TABLE FILE &DATA
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR SEG_MILES SEG_COUNT
BY AIR_KEY NOPRINT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
BY TKT_SORT NOPRINT
BY SEG_NBR NOPRINT
IF SEG_NBR GT 04
ON TABLE HOLD AS HOLD1
END

TABLE FILE MILEAGE
PRINT ORIGIN_CITY AS 'EMBARK' DESTIN_CITY AS 'ROUTE' MILES
ON TABLE HOLD AS HOLD2
END

MATCH FILE HOLD1
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR SEG_MILES SEG_COUNT
BY EMBARK NOPRINT
BY ROUTE NOPRINT
RUN
FILE HOLD2
SUM MILES
BY EMBARK NOPRINT
BY ROUTE NOPRINT
AFTER MATCH HOLD AS NEWMILES OLD
END
-RUN

DEFINE FILE NEWMILES
MILESN/I5 = SEG_COUNT * MILES;
END

-* TABLE FILE NEWMILES
-* PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
-* MILESN AS 'SEG_MILES'
-* -* SEG_MILES SEG_COUNT MILES MILESN
-* IF MILESN NE 0
-* ON TABLE HOLD
-* END

-* MODIFY FILE &DATA
-* FIXFORM FROM HOLD
-* MATCH AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
-* ON MATCH UPDATE SEG_MILES
-* ON NOMATCH REJECT
-* DATA ON HOLD
-* END

TABLE FILE NEWMILES
PRINT AIR_KEY EMBARK ROUTE TKT_SORT SEG_NBR
IF MILESN EQ 0
ON TABLE HOLD
END

MODIFY FILE NOMILES
FIXFORM FROM HOLD
MATCH AIR_KEY EMBARK ROUTE
ON MATCH UPDATE TKT_SORT SEG_NBR
ON NOMATCH INCLUDE
DATA ON HOLD
END
-*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
DEFINE FILE ROLLUP
XL01/A1 = 'Z' ;
END
TABLE FILE ROLLUP
BY ROLLUP NOPRINT
PRINT ROLLUP AS 'ROLLUP_CODE'
      XL01   AS 'PR_STAMP'
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE HOLD
END
MODIFY FILE ROLLUP
FIXFORM FROM HOLD
MATCH ROLLUP
ON MATCH UPDATE PR_STAMP
ON NOMATCH REJECT
DATA ON HOLD
END
-RUN
-SET &CNT = &CNT + 1;
-IF &&QTR NE 'X' THEN GOTO TOP ELSE GOTO LOOP;
-RUN
-*======================================================================
-STOP

-TYPE PROGRAM COMPLETED.......
-EXIT



