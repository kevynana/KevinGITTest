-* File DRILLRPT.FEX

-**********************************************************************
-* THIS PROGRAM CREATES STYLESHEET PARAMETERS BASED ON THE 'BY' FIELDS
-**********************************************************************
-*  DATE        NAME         DESCRIPTION OF CHANGE
-*  ----        ----         ---------------------
-* 3/14/2016 JEM S-16661 - Added code to make &&overdrill part of the parameters in &&DRILLABLE so a user 
-*                        may chose non-drillable summary reports in 5.0

-**********************************************************************

-INCLUDE SETECHO
-*SET TEMPERASE = OFF

-INCLUDE SetParmtime
-RUN

-IF &&DEPLOY EQ 'W' GOTO SETWEB;
-**********************************************************************
-* DETERMINE IF WE HAVE WEB DEPLOYMENT OR LOCAL STAND ALONE
-* SET PATHS FOR FILES NEEDED TO GEN STYLESHEET PARAMS
-**********************************************************************
-******LOCAL DEPLOYMENT
-*-SET &&DRILLBYS = &&LOCPATH ||'DRILLBYS.FTM';
-SET &&DRILLBYS = &&LOCPATH ||&&DTTMSTRM ||'DRILLBYS.FTM';
-*-SET &&DSTY = &&LOCPATH ||'DSTY.FTM';
-SET &&DSTY = &&WEB_PATH ||'DSTY.FTM';
-SET &&TMPFIL = &&LOCPATH ||'TMPFIL.FTM';
-SET &&SETFNM= &&LOCPATH || &&DTTMSTRM ||'.FTM';
-SET &&PATH = &&LOCPATH;
-SET &&URLPATH = &&ROLLUP || '/ '||&&UNAME.EVAL|| '/';
COPY &&SETF &&SETFNM
-RUN
-GOTO SETFILDEF;

-******WEB DEPLOYMENT
-SETWEB
-SET &&DRILLBYS = &&WEBPATH ||&&DTTMSTRM ||'DRILLBYS.FTM';
-SET &&DSTY = &&WEB_PATH ||'DSTY.FTM';
-SET &&TMPFIL = &&WEB_PATH ||'TMPFIL.FTM';
-SET &&SETFNM= &&WEBPATH || &&DTTMSTRM ||'.FTM';
-SET &&PATH = &&WEBPATH;
-SET &&URLPATH = &&ROLLUP || '/ '||&&UNAME.EVAL|| '/';
-*COPY &&SETF &&SETFNM

COPY &&VARFWEB &&SETFNM
-INCLUDE SetBDBsForDrill
-RUN


-SETFILDEF
-INCLUDE APNDSETF

-**********************************************************************
-* CLEAR AND ESTABLISH FILEDEFS
-**********************************************************************
FILEDEF DRILLBYS CLEAR
FILEDEF DSTY CLEAR
FILEDEF TMPFIL CLEAR
-RUN

-*FILEDEF DSTY DISK &&DSTY (APPEND
FILEDEF DSTY DISK &&DSTY  
FILEDEF DRILLBYS DISK &&DRILLBYS
FILEDEF TMPFIL DISK &&TMPFIL (APPEND
-RUN

-**********************************************************************
-* INCLUDE RTN TO PARSE SET FILE TO DETERMINE 'BY' FIELDS
-**********************************************************************
-INCLUDE PARSIT
-RUN
-SET &&XTN = IF (&&OUTLINE2 CONTAINS 'PDF') THEN '.pdf'
-ELSE IF (&&OUTLINE2 CONTAINS 'EXCEL') THEN '.xls'
-ELSE IF (&&OUTLINE2 CONTAINS 'EXL2K') THEN '.xls' ;
-SET &RPTLEN = ARGLEN(50, &&RN, 'I2');
-SET &&RPTNM = CTRAN(&RPTLEN, &&RN, 32, 95, 'A&RPTLEN.EVAL');

-**********************************************************************
-* GENERATE STYLE SHEET PARAMETER FOR HEADING BASED ON WHERE THE
-* OUTPUT IS GOING, I.E., TO BROWSER OR SAVE TO A FILE.
-**********************************************************************
-IF &&SUMONLY EQ 'Y' THEN GOTO GENFIELDS;
-IF (&&OUTLINE1 CONTAINS 'ONLINE-FMT') AND 
- (&&OUTLINE2 CONTAINS 'PDF' OR 'EXL2K') 
-THEN GOTO BROWSERHDR 
-ELSE GOTO FILECHK;


-BROWSERHDR
-GOTO GENFIELDS;
-***** CREATE STYLE SHEET HEADING PARAMETER FOR WEB BROWSER OUTPUT
-SET &STYPRM1 = 'TYPE=FOOTING,';
-SET &STYPRM2 = 'FOCEXEC=RUN_DRIL(SETFNM='||'''&&DTTMSTRM.EVAL'''||'\';
-SET &CNT = 0;
-SET &STYPRM2C ='ROLUP='||'''&&ROLLUP.EVAL'''||'\';
-SET &STYPRM2D ='user='||'''&&UNAME.EVAL'''||'\';
-SET &STYPRM3 = 'COLNBR='||'''&CNT.EVAL'''| '),$';
-WRITE DSTY NOCLOSE &STYPRM1
-WRITE DSTY NOCLOSE &STYPRM2

-WRITE DSTY NOCLOSE &STYPRM2C
-WRITE DSTY NOCLOSE &STYPRM2D
-WRITE DSTY NOCLOSE &STYPRM3
-RUN
-GOTO GENFIELDS;

-FILECHK
-IF (&&OUTLINE1 CONTAINS 'SAVE') AND
-   ((&&OUTLINE2 CONTAINS 'PDF') OR (&&OUTLINE2 CONTAINS 'EXCEL') OR
-    (&&OUTLINE2 CONTAINS 'EXL2K')) 
-THEN GOTO FILEHDR
-ELSE GOTO GENFIELDS;

-FILEHDR
-***** CREATE STYLE SHEET HEADING PARAMETER FOR OUTPUT TO SAVED FILE 
-* -SET &STYPRM1 = 'TYPE=HEADING,';
-* -SET &STYURL = &&SRVR;
-* -SET &STYPRM2= &STYURL || &&RPTNM || '_DTL' || &&XTN ||',$';
-* -WRITE DSTY NOCLOSE &STYPRM1
-* -WRITE DSTY NOCLOSE &STYPRM2
-RUN
-GOTO GENFIELDS;

-**********************************************************************
-* GENERATE STYLE SHEET PARAMETERS FOR BY FIELDS
-**********************************************************************
-GENFIELDS
-SET &LOOPVAR = 1;
-SET &CNT = 0;
-SET &TMPCNT = 0;
-SET &TCNT = 0;
-SET &BCNT = 0;
-DEFAULT &COLNBR = '';
-DEFAULT &COLNM = '';
-DEFAULT &PRNT = '';
-SET &COLNBR = &COLNBR;
-SET &COLNM = &COLNM;
-SET &PRNT = &PRNT;
-RUN

-BEGREPEAT
-REPEAT XOUT WHILE &LOOPVAR EQ 1;
FILEDEF TMPFIL DISK &&TMPFIL (APPEND
-RUN
-READ DRILLBYS NOCLOSE &COLNBR.A3. &COLNM.A50. &PRNT.A1.
-RUN

-SET &LOOPVAR = IF &COLNBR EQ 'EOF' THEN 0 ELSE 1;
-IF &COLNBR EQ 'EOF' THEN GOTO XOUT;
-SET &CNT = &CNT + 1;
-SET &TCNT = &TCNT + 1;
-**** SAVE OFF NOPRINT FIELDS TO TMPFIL
-SET &TCOLNBR = &COLNBR;
-SET &TCOLNM = &COLNM;
-SET &TLINE = &TCOLNBR || &TCOLNM | &TCNT;
-WRITE TMPFIL NOCLOSE &TLINE
-SET &TMPCNT = &TMPCNT + 1;
-IF &PRNT EQ 'Y' GOTO WROUT;
-GOTO XOUT;

-WROUT
-**** GENERATE STYLE SHEET PARAMS
-SET &CNT = 0;
-* -SET &STYPRM1 = 'TYPE=DATA,COLUMN='|&COLNBR | ',' | ' \';
-IF &&OVERDRILL EQ 'Y' THEN GOTO ODSTY ELSE GOTO NOODSTY;
-ODSTY;
-SET &STYPRM1 = '';
-SET &STYPRM2 = '';
-SET &STYPRM2A = '';
-SET &STYPRM2B ='';
-SET &STYPRM2C ='';
-SET &STYPRM2D ='';
-SET &RPARM='';
-GOTO ODCONT;
-NOODSTY;
-SET &STYPRM1 = 'TYPE=DATA,STYLE=-UNDERLINE,COLUMN='|&COLNBR | ',' | ' \';
-SET &STYPRM2 =
- 'URL=&&SRVR.EVAL/ibi_apps/WFServlet? \';
-SET &STYPRM2A =
- '(IBIF_ex='||'''RUN_DRIL'''|| '\';
-SET &STYPRM2B ='SETFNM='||'''&&DTTMSTRM.EVAL'''||'\';
-SET &STYPRM2C ='ROLUP='||'''&&ROLLUP.EVAL'''||'\';
-SET &STYPRM2D ='user='||'''&&UNAME.EVAL'''||'\';
-SET &RPARM = 'FPARM='||'''&&DTTMID.EVAL'''||'\' ;

-ODCONT;
-WRITE DSTY NOCLOSE &STYPRM1
-WRITE DSTY NOCLOSE &STYPRM2
-WRITE DSTY NOCLOSE &STYPRM2A
-WRITE DSTY NOCLOSE &STYPRM2B

-***************Added 10/28/03 ******
-WRITE DSTY NOCLOSE &RPARM
-***************Added 10/28/03 ******

-WRITE DSTY NOCLOSE &STYPRM2C
-WRITE DSTY NOCLOSE &STYPRM2D
-RUN
FILEDEF TMPFIL DISK &&TMPFIL (APPEND
-RUN

-DEFAULT &TTCOLNBR = '';
-DEFAULT &TTCOLNM = '';
-DEFAULT &TTCNT = '';
-SET &TTCOLNBR = &TTCOLNBR;
-SET &TTCOLNM = &TTCOLNM;
-SET &TTCNT = &TTCNT;
-RUN


-**** INNER LOOP FOR BYFIELDS AND NOPRINTS
-IF &&OVERDRILL EQ 'Y' THEN GOTO ODBY ELSE GOTO NOODBY;
-ODBY;
-SET &STYPRM3='';
-SET &STYPRM4='';
-SET &STYPRM5='';
-WRITE DSTY NOCLOSE &STYPRM3 &STYPRM4
-WRITE DSTY NOCLOSE &STYPRM5
-GOTO INLOOP;

-NOODBY;
-REPEAT INLOOP &TMPCNT TIMES;
-READ TMPFIL  NOCLOSE &TTCOLNBR.A3. &TTCOLNM.A50. &TTCNT.I1.
-SET &CNT = &CNT + 1;
-SET &BCNT = &BCNT + 1;
-SET &BYFLD = 'BYFLD' | &TTCNT;
-SET &SFLD = 'SFLD' | &TTCNT;
-IF &CNT EQ &TMPCNT GOTO WREND;
-SET &STYPRM3 = &BYFLD|| '=' || &TTCOLNBR ;
-SET &TLNGTH = ARGLEN(50, &TTCOLNM, 'I2');
-SET &TXBLNK=SUBSTR(50, &TTCOLNM, 1, &TLNGTH, &TLNGTH, 'A&TLNGTH.EVAL');
-SET &STYPRM4 = &SFLD | '= '''||&TXBLNK.EVAL|''' \';
-WRITE DSTY NOCLOSE &STYPRM3 &STYPRM4
-GOTO INLOOP;

-WREND
-SET &STYPRM3 = &BYFLD|| '=' || &TTCOLNBR ;
-SET &TLNGTH = ARGLEN(50, &TTCOLNM, 'I2');
-SET &TXBLNK=SUBSTR(50, &TTCOLNM, 1, &TLNGTH, &TLNGTH, 'A&TLNGTH.EVAL');
-TYPE &TXBLNK
-SET &STYPRM4 = &SFLD | '= '''||&TXBLNK.EVAL|''' \';
-TYPE &STYPRM4
-SET &STYPRM5 = 'COLNBR='||'''&TTCNT.EVAL'''| '),$';
-WRITE DSTY NOCLOSE &STYPRM3 &STYPRM4
-WRITE DSTY NOCLOSE &STYPRM5

-INLOOP

-XOUT
-CLOSE DSTY

FILEDEF DSTY CLEAR
ERASE &&TMPFIL
-RUN

-NEXTSTEP
-*-EXIT
