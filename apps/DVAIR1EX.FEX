-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* File DVAIREX.FEX
-********************************************************************
-* CREATED FOR DATA VAULT EXPENSE REPORT 
-* CREATED FROM TKTAIR
-********************************************************************
-*
-* This program extracts data for the series of basic ticket listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-* ADDED TRANTYPE INCLUDE - JK 12/19/14 STORY ID S-06492

-********************************************************************
-INCLUDE SETECHO 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';
-SET &WHATDATE = IF '&&DATETYPE.EVAL' EQ 'I' THEN 'TRN_DATE' ELSE 'FST_DPT_DATE';


DEFINE FILE &&EXTRACT
  AIRLN/A3 = VAL_AIRLINE;  
  CTY1/A25 = EDIT (C_ITIN, '9999999999999999999999999');
  CTY2/A25 = CITYPAIR.ROUTE;
  DATA_V1/A9 = '*********';
  DV_NUM2/A6 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$999999');
  DV_NUM/A15 = IF DV_NUM2 EQ ' ' THEN ' ' ELSE DATA_V || DV_NUM2;
  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;
  LEVEL_DESC/A60 = &&LDESC;
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  DV_TYPE/A3 =           IF EX_FLAG NE ' ' THEN 'EXC' ELSE
                            IF RF_FLAG NE ' ' THEN 'REF' ELSE 'SAL';

  STATUS/A1 =    IF VOID_DATE NE 0 THEN 'V' ELSE
                 IF EX_FLAG NE ' ' THEN 'E' ELSE
                 IF RF_FLAG NE ' ' THEN 'R' ELSE 'O';
  
  XDPT_DT/MDYY         = DPT_DATE;
  XPSNGR_NM/A15        = 
    EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;
  XFST_DT/MDYY         = FST_DPT_DATE;

-INCLUDE TRANTYPE

END


TABLEF FILE &&EXTRACT
PRINT AIR_KEY
  AIRLN  
  BR_CL_IDX AS 'ACCT'
  CTY1 AS 'CITY1'
  CONJ_REL
  DV_NUM
  DV_TYPE
  EX_FLAG
  FARE_PAID
  FST_DPT_DATE
  INVOICE_NUM
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  LEVEL4
  NET_TKT_CNT 
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_COUNT
  SEG_NBR
  STATUS
  TICKET_CODE
  TKT_DATE
  TKT_NUM
  TKT_SORT
  &WHATDATE
  TRIP_PURPOSE
  XDPT_DT   
  XFST_DT
  XTRAN_DT   
  XPSNGR_NM
  EMB_APT.GEO_ZONE AS 'GEO_ZONE'
  VOID_DATE

-INCLUDE &AIRDATES
-* WHERE VOID_DATE EQ 0

-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
-* &&WHERE7
-* &&WHERE8
-* &&WHERE9
-* &&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS AIRHOLD2
END
-RUN





TABLE FILE AIRHOLD2
SUM FARE_PAID AS 'AMOUNT'
    NET_TKT_CNT/D12CS AS 'TTL_COUNT'
BY PASSNGR_NAME
BY TKT_SORT
BY &WHATDATE
ON TABLE HOLD AS HOLD3
END
-RUN

TABLE FILE AIRHOLD2
PRINT AIR_KEY 
  ACCT 
  AIRLN AS 'NAME'
  CITY1
  CONJ_REL
  DV_NUM
  DV_TYPE
  EX_FLAG
  FARE_PAID
  XFST_DT AS 'DATE'
  GEO_ZONE
  INVOICE_NUM
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  NET_TKT_CNT
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_COUNT
  STATUS
  TICKET_CODE
  TKT_NUM
  TRIP_PURPOSE
  XTRAN_DT AS 'TRAN_DATE'
  XDPT_DT AS 'DATE2'
  VOID_DATE
BY PASSNGR_NAME NOPRINT
BY TKT_SORT  
BY &WHATDATE
BY SEG_NBR   
ON TABLE HOLD AS XTWO
END
-RUN

TABLE FILE XTWO
SUM LST.DATE2
BY PASSNGR_NAME
BY TKT_NUM
BY &WHATDATE
WHERE DATE2 NE ' '
ON TABLE HOLD AS HOLD4
END
-RUN


MATCH FILE XTWO
PRINT AIR_KEY 
  ACCT
  CITY1
  CONJ_REL
  DATE
  DATE2
  DV_NUM
  DV_TYPE
  EX_FLAG
  FARE_PAID  
  GEO_ZONE
  INVOICE_NUM
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  NAME
  NET_TKT_CNT
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  SEG_COUNT
  STATUS
  TICKET_CODE
  TKT_NUM
  TRAN_DATE  
  TRIP_PURPOSE
BY PASSNGR_NAME NOPRINT
BY TKT_SORT   
BY &WHATDATE
BY SEG_NBR   
ON TABLE HOLD
RUN
FILE HOLD3
PRINT
  AMOUNT
  TTL_COUNT   
BY PASSNGR_NAME   
BY TKT_SORT  
BY &WHATDATE  
AFTER MATCH HOLD AS XTHREE OLD-OR-NEW
END
-RUN

MATCH FILE XTHREE
PRINT AIR_KEY 
  ACCT
  CITY1
  CONJ_REL
  DATE
  DV_NUM
  DV_TYPE
  EX_FLAG
  FARE_PAID  
    GEO_ZONE
    INVOICE_NUM
    LEVEL_DESC
    LEVEL1
    LEVEL2
    LEVEL3
    LEVEL4
    NAME
    NET_TKT_CNT
    PASSNGR_NAME
    PNR_LOCATOR
    RF_FLAG
    SEG_COUNT
    SEG_NBR
    STATUS
    TICKET_CODE
    TKT_SORT
    TRAN_DATE  
    TRIP_PURPOSE
    AMOUNT
    TTL_COUNT
  BY PASSNGR_NAME NOPRINT
  BY TKT_NUM
  BY &WHATDATE
  ON TABLE HOLD
  RUN
  FILE HOLD4
  SUM DATE2
  BY PASSNGR_NAME
  BY TKT_NUM
  BY &WHATDATE
  AFTER MATCH HOLD AS XFOUR OLD-OR-NEW
  END
  -RUN
  
DEFINE FILE XFOUR
  TKTNUM/A30 = TKT_NUM;
  FLAG/A1 = IF NAME EQ '2V' THEN 'R' ELSE 'A';
  SEG/A2 = SEG_NBR;
  TSORT/A11 = TKT_SORT;
  -*FEE_AMT/D9.2 = 0;
  END
TABLE FILE XFOUR
  SUM   
    ACCT
    AMOUNT
    CITY1
    CONJ_REL
    DATE
    DATE2 
    DV_NUM
    DV_TYPE AS 'TYPE'
    EX_FLAG
    FARE_PAID AS 'AMOUNT'
    GEO_ZONE
    INVOICE_NUM
    LEVEL_DESC
    LEVEL1
    LEVEL2
    LEVEL3
    LEVEL4
    NAME
    NET_TKT_CNT
    PASSNGR_NAME
    PNR_LOCATOR
    RF_FLAG
    SEG_COUNT
    SEG_NBR
    STATUS
    TICKET_CODE
    TTL_COUNT
    TKTNUM AS 'TKT_NUM'
    TRAN_DATE  
    TRIP_PURPOSE
    PASSNGR_NAME  
    TKT_SORT
    SEG_NBR
    
    FLAG SEG TSORT 
-*  FEE_AMT
    
BY AIR_KEY  
ON TABLE HOLD AS AIRHOLD3
END
-RUN

  
-* -IF '&AIRPROF.EVAL' EQ 'N' OR '&GETPROFEXP.EVAL' EQ 'N' THEN GOTO NoAirJoin;
-*  -JoinAirPrf
  JOIN AIR_KEY IN AIRHOLD2 TO ALL AIR_KEY IN PFHOLDA
  -RUN
  
DEFINE FILE AIRHOLD2
   FLAG/A1 = 'A';
END
TABLE FILE AIRHOLD2
PRINT 
    PASSNGR_NAME
    PNR_LOCATOR
    XTRAN_DT AS 'TRAN_DATE'
    TKT_NUM
    TKT_SORT AS 'TSORT'
    DV_TYPE AS 'TYPE'
    SEG_NBR AS 'SEG'
    AIRLN AS 'NAME'
    XFST_DT AS 'DATE' 
    XDPT_DT AS 'DATE2'
    CITY1
    DV_NUM
    ACCT
    INVOICE_NUM
    STATUS
    LEVEL_DESC
    LEVEL1
    LEVEL2
    LEVEL3
    LEVEL4
    GEO_ZONE
    TRIP_PURPOSE
    FEE_AMT AS 'AMOUNT'
    CNT AS 'TTL_COUNT'
BY FLAG
BY PASSNGR_NAME NOPRINT
WHERE AIRHOLD2.AIR_KEY EQ PFHOLDA.AIR_KEY
ON TABLE HOLD AS HOLDAP FORMAT FOCUS
END
-RUN
 
 
-*Merger Air and Fee together
MATCH FILE AIRHOLD3
PRINT  TYPE
    SEG
    NAME
    DATE
    DATE2
    CITY1
    DV_NUM
    ACCT
    INVOICE_NUM
    STATUS
    LEVEL_DESC
    LEVEL1
    LEVEL2
    LEVEL3
    LEVEL4
    GEO_ZONE
    TRIP_PURPOSE
    AMOUNT
    TTL_COUNT
BY FLAG
BY PASSNGR_NAME   
BY PNR_LOCATOR
BY TRAN_DATE
BY TKT_NUM
BY  TSORT
RUN
FILE HOLDAP
PRINT TYPE
    SEG
    NAME
    DATE
    DATE2
    CITY1
    DV_NUM
    ACCT
    INVOICE_NUM
    STATUS
    LEVEL_DESC
    LEVEL1
    LEVEL2
    LEVEL3
    LEVEL4
    GEO_ZONE
    TRIP_PURPOSE
    AMOUNT
    TTL_COUNT
BY FLAG
BY PASSNGR_NAME 
BY PNR_LOCATOR
BY TRAN_DATE
BY TKT_NUM
BY  TSORT
AFTER MATCH HOLD OLD-OR-NEW
END
-RUN

 

  
-SET &AFILENAME= 'HOLD';
-GOTO ToHoldAir;
  
  -*Case 4. Air (Y), Fee (N)
  -*-NoAirJoin
  -* -SET &AFILENAME= 'AIRHOLD3';


-ToHoldAir 



TABLE FILE &AFILENAME

PRINT 
    PASSNGR_NAME
    PNR_LOCATOR
    TRAN_DATE
    TKT_NUM
    TSORT
    TYPE
    SEG
    NAME
    DATE
    DATE2
    CITY1
    DV_NUM
    AMOUNT
    TTL_COUNT
    ACCT
    INVOICE_NUM
    STATUS
    LEVEL_DESC
    LEVEL1
    LEVEL2
    LEVEL3
    LEVEL4
    GEO_ZONE
    TRIP_PURPOSE
-*  FEE_AMT
BY FLAG
BY PASSNGR_NAME NOPRINT
-*IF AMOUNT NE 0
ON TABLE HOLD AS HOLDA FORMAT FOCUS
END
-RUN
-QUIT
 
-AIREXXIT
