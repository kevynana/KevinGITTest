-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-INCLUDE SETECHO
-* File HVIW27EX.FEX
-********************************************************************
-* MODIFICAIONS:
-********************************************************************
-*
-* CREATED FOR VXTOPYTD
-* 9/9/14 Updated Pref_non define to use exclude_flags - jk
-*5/01/2017-JEM-S-33318-updated logic for no records report

-********************************************************************

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

DEFINE FILE  &&EXTRACT

  CURRENT/A1 = IF INVOICE_DATE GE  &&FROMDT.EVAL  AND
                  INVOICE_DATE LE  &&TODT.EVAL  THEN 'Y' ELSE 'N';
  PRIOR/A1 =   IF INVOICE_DATE GE  &&FXDATE.EVAL  AND
                INVOICE_DATE LE &&TXDATE.EVAL  THEN 'Y' ELSE 'N';

TDATE1/YYMD= &&TODT.EVAL;
-*TDATE2/YYMD='&&TXDATE.EVAL';

P_MONTH/MDYY=TDATE1;
-*P2_MONTH/MDYY = TDATE2;

P_EOM/MDYY=DATEMOV(P_MONTH, 'EOM');
-*P2_EOM/MDYY=DATEMOV(P2_MONTH, 'EOM2');

-* RUN_EOM is the End of Month we are executing.
RUN_EOM/M=P_EOM;
-* RUN_EOM2 is the Prior End of Month we are executing.
-*RUN_EOM2/M=P2_EOM;
-* Determine End of Quarters for Rollups
RFY/M=IF ROLL_FY EQ '' OR '1' OR '01' OR 'X' THEN 1 ELSE EDIT(ROLL_FY);
Q1B/M=RFY;
Q1E/M=IF (RFY + 3) - 1 LT 12 THEN (RFY + 3) - 1 ELSE (RFY + 3) - 1 - 12;
Q2B/M=IF (RFY + 3) GT 12 THEN (RFY + 3) - 12 ELSE (RFY + 3);
Q2E/M=IF (RFY + 6) - 1 LT 12 THEN (RFY + 6) - 1 ELSE (RFY + 6) - 1 - 12;
Q3B/M=IF (RFY + 6) GT 12 THEN (RFY + 6) - 12 ELSE (RFY + 6);
Q3E/M=IF (RFY + 9) - 1 LT 12 THEN (RFY + 9) - 1 ELSE (RFY + 9) - 1 - 12;
Q4B/M=IF (RFY + 9) GT 12 THEN (RFY + 9) - 12 ELSE (RFY + 9);
Q4E/M=IF (RFY + 12) - 1 LT 12 THEN (RFY + 12) - 1 ELSE (RFY + 12) - 1 - 12;


ANNUAL/M=Q4E;
ANNUAL_YY/YY=P_EOM;
ANNUAL_YY1/YY=IF RUN_EOM GT Q4E THEN ANNUAL_YY + 1 ELSE ANNUAL_YY;
ANNUAL_A8MDYY/A8MDYY=EDIT(Q4E) | '01' | EDIT(ANNUAL_YY1);
ANNUAL_MONTH/MDYY=ANNUAL_A8MDYY;
ANNUAL_END/MDYY=DATEMOV(ANNUAL_MONTH, 'EOM');
ANNUAL_END2/YYMD=DATEMOV(ANNUAL_MONTH, 'EOM');
 

Q4_END/MDYY=ANNUAL_END;
Q4_BEGIN/MDYY=DATEMOV(DATEADD(Q4_END, 'M', (-2)), 'BOM');
Q3_END/MDYY=Q4_BEGIN - 1;
Q3_BEGIN/MDYY=DATEMOV(DATEADD(Q3_END, 'M', (-2)), 'BOM');
Q2_END/MDYY=Q3_BEGIN - 1;
Q2_BEGIN/MDYY=DATEMOV(DATEADD(Q2_END, 'M', (-2)), 'BOM');
Q1_END/MDYY=Q2_BEGIN - 1;
Q1_BEGIN/MDYY=DATEMOV(DATEADD(Q1_END, 'M', (-2)), 'BOM');

 
FDATE/YYMD=&&FROMDT.EVAL;
EDATE/YYMD=&&TODT.EVAL;
BOM_DATE/YYMD=DATEMOV(EDATE,'BOM');
EOM_DATE/YYMD=DATEMOV(EDATE,'EOM');
EOM_DATE1/MDYY=DATEMOV(EDATE,'EOM');
ANNUAL_BEGIN/MDYY=Q1_BEGIN;
ANNUAL_BEGIN1/YYMD = Q1_BEGIN;
P_ANNUAL_END/YYMD = DATEADD(ANNUAL_END2, 'Y',(-1));
P_ANNUAL_BEGIN/YYMD = DATEMOV(DATEADD(ANNUAL_BEGIN1, 'Y', (-1)), 'BOM'); 

 


  CARD_NUM/A12 = EDIT(CREDIT_CARD, '$$999999999999$$$$');
  CARD1_NUM/A4 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$$$9999');
 CGHF/A1 = IF HOTEL_PHONE EQ '5095861332' OR '2087368000' OR '7658075735' OR '6202757471' OR 
              '8706981900' OR '5097653731' OR '3103187732' OR '4026364945' OR '4023467600' OR '3145873045' OR 
              '7029469207' OR '3177154906' OR '9254695955' OR '9093702424' OR '5105214500' OR 
              '5173242072' OR '6102506500' OR '7176331117' OR '3193510645' OR '4024207800' OR 
              '9256066400' OR '9013226544' OR '7152959900' OR '5597323900' OR '4079032130' OR 
              '9053629484' OR '2087338500' OR '8652512570' OR '3146418821' OR '7709346000' OR 
              '5133876000' OR '7176371228' OR '6068620077' OR '5095437000' OR '5097378000' OR 
              '6608264000' OR '7172939500' OR '3192747000' OR '4506829000' OR '5032565000' OR 
              '7208952330' OR '6306577672' OR '6306577672' OR '2089398266' OR '4022801516' THEN 'Y' ELSE 'N';
  CITY_ST/A35 = PROP_CITY||(' '| PROP_STATE);
  LEV_2/A15 = IF PASSNGR_NAME NE LAST PASSNGR_NAME THEN LEVEL2 ELSE ' ';
  LEVEL_DESC/A60  = &&LDESC;
  IN_DATE/MDYY = CHKIN_DATE;
  INV_DATE/MDYY = INVOICE_DATE;
  NEW_ROOM_RATE/D12.2C = ROOM_RATE;
  NEW_STD_RATE/D12.2C = STD_RATE;
  NEW_TOTAL_AMT/D12.2C = TOTAL_AMT;
  NBR_DAYS/D12 =  NUM_DAYS; 
  NNROOMS/D12 = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
  OUT_DATE/MDYY = CHKOUT_DATE;
  ONLINE/A1 = IF DOD_TYPE EQ 'H' OR 'I' OR 'J' THEN 'Y' ELSE 'N';
 PNP_FLAG/A1 = EDIT(EXCLUDE_FLAGS, '$9');
 PNP_IE/A1 = EDIT(EXCLUDE_FLAGS, '$$9');  
-*  PREF_NON/A15 = IF CLIENT_PREF EQ 'C' OR 'P' OR 'N' OR 'M' OR 'L'  THEN 'PREFERRED' ELSE 'NON-PREFERRED';
 PREF_NON/A15 = IF PNP_FLAG EQ 'I'  THEN 'PREFERRED' ELSE 'NON-PREFERRED';
   
 
  PROP_ZIP5/A5=EDIT(PROP_ZIP, '99999$$$$$');

 PRP_NAME/A25 = EDIT(PROP_NAME, '$$$$$$$$$$$$$$$$$$$$$$$$$');

 RATE_GRP/A15 = IF ((ROOM_RATE GE 0 AND ROOM_RATE LT 149.50) OR
                      (ROOM_RATE LE 0 AND ROOM_RATE GT (-149.50)))
                   THEN '$0 - $149' ELSE
                   IF ((ROOM_RATE GE 149.50 AND ROOM_RATE LT 199.50) OR
                      (ROOM_RATE LE (-149.50) AND ROOM_RATE GT (-199.50)))
                   THEN '$150 - $199' ELSE
                   IF ((ROOM_RATE GE 199.50 AND ROOM_RATE LT 249.50) OR
                      (ROOM_RATE LE (-199.50) AND ROOM_RATE GT (-249.50)))
                   THEN '$200 - $249' ELSE '$250 OR GREATER';



  REASON_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
  REFUSE_CD/A2=EDIT(REFUSE_KEY,'$$$$$$$$99');
  RSNCDE/A48=REFUSE_CD|| '-' ||REFUSAL_DESC;
  RES_DT/MDY = RESV_DATE;
  MIR_SEQ1/A1 = EDIT(MIR_SEQ, '9$$$$$');
  RES_SYS/A1 = IF MIR_SEQ1 EQ 'X' THEN 'S' ELSE 'A';


-* ****DEFINES ON PREVIOUS DEFINES****

  TOTAL_STD/D12.2C = IF (NNROOMS LT 0) AND (NEW_STD_RATE LT 0) 
                     THEN ((NNROOMS * NEW_STD_RATE)*(-1))
                     ELSE NNROOMS * NEW_STD_RATE;

-* ***DEFINES ON PREVIOUS DEFINED DEFINES***
   BOOKINGS/D8 = IF NEW_TOTAL_AMT GE 0 THEN 1 ELSE (-1);
   SAVINGS/D12.2CS = TOTAL_STD - TOTAL_AMT;
   TOTAL_SLSAV/D12.2C = TOTAL_STD - NEW_TOTAL_AMT;
   XIN_DOW/WR = IN_DATE;
   XOUT_DOW/WR = OUT_DATE;
   
   PROP_CODE1/A7 = IF RES_SYS EQ 'S' THEN PROP_SABRE_CODE ELSE PROP_APOLLO_CODE;


-***********************YTD**********************
 
YBOOKINGS/D8 = IF CURRENT EQ 'Y' THEN BOOKINGS ELSE 0;
YDRRATE/D12.2C = IF CURRENT EQ 'Y' THEN NEW_ROOM_RATE ELSE 0;
YDSTD/D12.2C = IF CURRENT EQ 'Y' THEN NEW_STD_RATE ELSE 0;
YDTOT_AMT/D12.2C = IF CURRENT EQ 'Y' THEN NEW_TOTAL_AMT ELSE 0;
YDDAYS/D12 = IF CURRENT EQ 'Y' THEN NBR_DAYS ELSE 0;
YDROOMS/D12 = IF CURRENT EQ 'Y' THEN NNROOMS ELSE 0;
YDTOT_STD/D12.2C = IF CURRENT EQ 'Y' THEN TOTAL_STD ELSE 0;
YDSVGS/D12.2CS = IF CURRENT EQ 'Y' THEN SAVINGS ELSE 0;
YDTOT_SVGS/D12.2 = IF CURRENT EQ 'Y' THEN TOTAL_SLSAV ELSE 0;
YDPREF_NON/A15 = IF CURRENT EQ 'Y' THEN PREF_NON ELSE ' ';
PNFLAG/A1 = IF CURRENT EQ 'Y' AND PREF_NON EQ 'PREFERRED' THEN 'Y' ELSE 'N';

-***********************PRIOR YTD**********************

PYBOOKINGS/D8 = IF PRIOR EQ 'Y' THEN BOOKINGS ELSE 0;

PYDTOT_AMT/D12.2C = IF PRIOR EQ 'Y' THEN NEW_TOTAL_AMT ELSE 0;
PYDDAYS/D12 = IF PRIOR EQ 'Y' THEN NBR_DAYS ELSE 0;
PYDROOMS/D12 = IF PRIOR EQ 'Y' THEN NNROOMS ELSE 0;


PREV_YR/YY = P_ANNUAL_BEGIN;
P_YEAR/A2 = EDIT(PREV_YR, '$$99');

CURR_YR/YY = ANNUAL_BEGIN;
C_YEAR/A2 = EDIT(CURR_YR, '$$99');


-* PREF/I9=IF CLIENT_PREF EQ 'C' OR 'P' OR 'N' OR 'M' OR 'L' THEN 1 ELSE 0;
-* NPREF/I9=IF CLIENT_PREF EQ 'C' OR 'P' OR 'N' OR 'M' OR 'L' THEN 0 ELSE 1;

 PREF/I9 = IF PNP_FLAG EQ 'I' THEN 1 ELSE 0;
 NPREF/I9 = IF PNP_FLAG EQ 'I' THEN 0 ELSE 1;
 
END
-RUN
 
 
 
TABLEF FILE &&EXTRACT
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE 	
  CHAIN_NAME 	
  CITY_ST
  CITY.GEO_ZONE AS 'GEO_ZONE'
  CREDIT_CARD	
  CLIENT_PREF
  HHL_CONFIRM 	
  HOTEL_PHONE 	
  HTL_KEY	
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3
  NEW_ROOM_RATE
  NEW_STD_RATE
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 	
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR
  PREF_NON
  YDPREF_NON
  PROP_ADDRESS 	
  PROP_CITY 	
  PROP_CODE1 AS 'PROP_CODE'
  PROP_NAME
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE	
  RSNCDE
  TICKET_BRANCH	
  TKT_NUM	
  XIN_DOW
  XOUT_DOW
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS
  YBOOKINGS
  YDRRATE 
  YDSTD 
  YDTOT_AMT 
  YDDAYS 
  YDROOMS 
  YDTOT_STD 
  YDSVGS 
  YDTOT_SVGS
  
  PYBOOKINGS
  PYDTOT_AMT 
  PYDDAYS 
  PYDROOMS
  P_ANNUAL_BEGIN
  P_ANNUAL_END
  P_YEAR
  C_YEAR
  ANNUAL_BEGIN
  EOM_DATE1
COMPUTE DAYS/I6=(EOM_DATE - ANNUAL_BEGIN1) + 1;
WHERE INVOICE_DATE GE &&FROMDT.EVAL AND INVOICE_DATE LE &&TODT.EVAL OR
      INVOICE_DATE GE &&FXDATE.EVAL AND INVOICE_DATE LE &&TXDATE.EVAL
-*
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
 
-INCLUDE RPTPARMS
ON TABLE HOLD AS RPT_HOLDA
END
-RUN
-IF &RECORDS EQ 0 GOTO XXIT;
 


-DEB

TABLE FILE RPT_HOLDA
SUM LST.P_YEAR LST.C_YEAR LST.DAYS
ON TABLE SAVE AS PRIORYR
END
-RUN




-READ PRIORYR &&PYEAR.A2. &&CYEAR.A2.

-TYPE &&PYEAR &&CYEAR
-CLOSE PRIORYR

 


TABLE FILE RPT_HOLDA
PRINT AIRPORT_CODE	
  ALPHA_RATE	
  AR_BRANCH
  BOOKINGS
  BR_CL_IDX
  CARD_NUM
  CARD1_NUM	
  CHAIN_CODE 	
  CHAIN_NAME 
  CLIENT_PREF
  CITY_ST
  GEO_ZONE
  CREDIT_CARD	
  CLIENT_PREF
  DAYS
  HHL_CONFIRM 	
  HOTEL_PHONE 	
  HTL_KEY	
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEV_2
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NEW_ROOM_RATE
  NEW_STD_RATE  
  NUM_DAYS 	
  NUM_ROOMS	
  ONLINE
  OUT_DATE 	
  PROP_ZIP5
  PASSNGR_NAME 	
  PNR_LOCATOR
  PREF_NON
  YDPREF_NON
  PROP_ADDRESS 	
  PROP_CITY 	
  PROP_CODE
  PROP_NAME
  PROP_STATE_CD 	
  RATE_GRP	
  REFUSAL_DESC	
  REFUSE_CD	
  REFUSE_KEY	
  RESV_BRANCH
  RES_DT
  ROOM_RATE 	
  ROOM_TYPE	
  RSNCDE
  TICKET_BRANCH	
  TKT_NUM	
  XIN_DOW
  XOUT_DOW
  YBOOKINGS
  YDRRATE 
  YDSTD 
  YDTOT_AMT 
  YDDAYS 
  YDROOMS 
  YDTOT_STD 
  YDSVGS 
  YDTOT_SVGS
  
  PYBOOKINGS
  PYDTOT_AMT 
  PYDDAYS 
  PYDROOMS 
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  
BY CHAIN_CODE
ON TABLE HOLD AS HTLHLD2 FORMAT FOCUS INDEX CHAIN_CODE
END 
-RUN




 

DEFINE FILE HOTEL_CHAINS_WITH_SCALES
SCALE_DESC1/A20 = DECODE SCALE ('1' 'Luxury Chains Chains'
                               '2' 'Upper Upscale Chains'
                               '3' 'Upperscale Chains' 
                               '4' 'Midscale Chains'
                               '5' 'Economy Chains'
                               '6' 'Independent Hotels'
                               '7' 'Other'
                               ' ' 'Unidentified');

END
-RUN

TABLE FILE HOTEL_CHAINS_WITH_SCALES
SUM SCALE_DESC1
BY CHN_CD
ON TABLE HOLD AS SCALEHLD FORMAT FOCUS INDEX CHN_CD
END
-RUN



JOIN HTLHLD2.CHAIN_CODE IN HTLHLD2 TO SCALEHLD.CHN_CD IN SCALEHLD AS J4
-RUN

DEFINE FILE HTLHLD2
HPHN/A10 = EDIT(HOTEL_PHONE, '9999999999');
SCALE_DESC/A20 = IF HPHN EQ '4029999999' THEN 'Unidentified' ELSE SCALE_DESC1;
 
END



 TABLE FILE HTLHLD2
SUM   
    NEW_ROOM_RATE
    NEW_STD_RATE
    YBOOKINGS
    PYBOOKINGS
    YDDAYS AS 'YNUMDYS'
    PYDDAYS AS 'PNUMDYS'
    YDRRATE
    YDSTD
    YDTOT_AMT
    PYDTOT_AMT
    YDROOMS/D8 AS 'YNMBR_DAYS'	
    PYDROOMS/D8 AS 'PYNMBR_DAYS'	
    YDROOMS	
    PYDROOMS
    REFUSE_CD	
    RESV_BRANCH	
    YDSVGS
    YDTOT_AMT AS 'YROOM_AMT'
    YDTOT_STD
    YDTOT_SVGS
    PROP_CODE
    
    YDPREF_NON
    PREF_NON
    CLIENT_PREF
 
BY CITY_ST
BY PROP_CITY
BY PROP_STATE_CD
BY CHAIN_NAME
BY PROP_NAME
BY PROP_ZIP5
BY PROP_ADDRESS
BY HOTEL_PHONE
BY CHAIN_CODE
-* New Property Master fields
BY PROP_LANYON_ID
BY PROP_LATITUDE
BY PROP_LONGITUDE
BY PROP_MOBIL_STARS
BY PROP_AAA_DIAMONDS
BY PROP_OHG_CLASS
BY SCALE_DESC
-*BY YDPREF_NON
ON TABLE HOLD AS HTLHLD3
 
END
-RUN
 

-*Determine Pref htls for Current period

TABLE FILE &&EXTRACT
SUM NPREF  
    PREF
BY HOTEL_PHONE
BY PROP_NAME
WHERE (INVOICE_DATE GE ANNUAL_BEGIN) AND (INVOICE_DATE LE EOM_DATE1)
ON TABLE HOLD AS CPREFHLD
END
-RUN


TABLE FILE CPREFHLD
SUM SUM NPREF  
    PREF           
COMPUTE MARKER_NAME/A20=IF PREF GT 0 AND NPREF EQ 0 THEN 'Preferred' ELSE
                        IF PREF EQ 0 AND NPREF GT 0 THEN 'Non-Preferred' ELSE 
                        'Pref/Non-Pref';
BY HOTEL_PHONE
BY PROP_NAME
ON TABLE HOLD AS CPREFHLD2
END
-RUN
 

DEFINE FILE CPREFHLD2
CPREF_FLAG/A1 = IF MARKER_NAME EQ 'Preferred' OR 'Pref/Non-Pref' THEN 'Y' ELSE 'N';
END
TABLE FILE CPREFHLD2
PRINT CPREF_FLAG
BY HOTEL_PHONE
BY PROP_NAME
ON TABLE HOLD AS CPREF3
END
-RUN


MATCH FILE HTLHLD3
PRINT   
    NEW_ROOM_RATE
    NEW_STD_RATE
    YBOOKINGS
    PYBOOKINGS
    YNUMDYS
    PNUMDYS
    YDRRATE
    YDSTD
    YDTOT_AMT
    PYDTOT_AMT
    YNMBR_DAYS	
    PYNMBR_DAYS	
    YDROOMS	
    PYDROOMS
    REFUSE_CD	
    RESV_BRANCH	
    YDSVGS
    YROOM_AMT
    YDTOT_STD
    YDTOT_SVGS
    PROP_CODE
    YDPREF_NON
    PREF_NON
  CITY_ST
  PROP_CITY
  PROP_STATE_CD
  CHAIN_NAME
  PROP_ZIP5
  PROP_ADDRESS
  CHAIN_CODE
-* New Property Master fields
  PROP_LANYON_ID
 PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS
  SCALE_DESC

BY HOTEL_PHONE
BY PROP_NAME
ON TABLE HOLD
RUN
FILE CPREF3
PRINT CPREF_FLAG
BY HOTEL_PHONE
BY PROP_NAME
AFTER MATCH HOLD AS &&RPT_HOLD OLD-OR-NEW
END
-RUN

-XXIT;
 
 