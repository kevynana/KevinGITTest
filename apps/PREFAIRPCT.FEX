
-* 7/23/2015 - DEB - S-10025 Added Pref airline % TMTOPTVL
-* 7/30/2015 - DEB - S-10025 Added routine for NOprefAir

-INCLUDE SETECHO

SET ASNAMES = ON

DEFINE FILE TOPTVL
ROLLUP_CODE/A8 = '&&ROLLUP.EVAL';
END
TABLE FILE TOPTVL
SUM NET_TKT_CNT
    MRK_TKT_CNT
    FARE_PAID
    ONL_TKTS
    REF_TKTS
    LEVEL_DESC
    PASSNGR_NAME
BY ROLLUP_CODE
BY LEVEL_DESC
BY VAL_AIRLINE
BY TKT_NUM
BY INTL_DOM AS 'DOM_INTL_CODE'
BY CATEGORY
BY BR_CL_IDX
BY TRN_DATE
BY FST_DPT_DATE
ON TABLE HOLD AS PREFHLD
END
-RUN



TABLE FILE PREFAIR
PRINT ROLLUP_CODE
-*AIRLINE_CODE AIRLINE_CATEGORY TICKET_EFFECTIVE_DATE TICKET_EXPIRATION_DATE TSINT
AIRLINE_CODE AIRLINE_CATEGORY TICKET_EFFECTIVE_DATE TICKET_EXPIRATION_DATE TSINT GROUP_NUMBER DEPART_EFFECTIVE_DATE DEPART_EXPIRATION_DATE

WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE SET ASNAMES ON
ON TABLE HOLD AS NWPREFAIR FORMAT FOCUS INDEX ROLLUP_CODE
END
-RUN 
-SET &PAIRRECS=IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-RUN 



-IF '&PAIRRECS.EVAL' EQ 'N' GOTO NOprefAir;


TABLE FILE NWPREFAIR
SUM GROUP_NUMBER
BY GROUP_NUMBER NOPRINT
WHERE GROUP_NUMBER NE ' '
ON TABLE SAVE AS GROUP1
END
-RUN

-SET &GROUPCK2 = IF &RECORDS EQ 0 THEN 'N' ELSE 'Y';
-IF &GROUPCK2 EQ 'N' THEN GOTO Cont2:

-READ GROUP1 &GN.A9
-CLOSE GROUP1

-Cont2:

JOIN CLEAR *

JOIN ROLLUP_CODE IN PREFHLD TO ALL ROLLUP_CODE IN NWPREFAIR AS J1
-RUN
 
DEFINE FILE PREFHLD
-*PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
-*            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND (FST_DPT_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND (AIRLINE_INT_DOM EQ 'B')  THEN 1 ELSE 
-*            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND (FST_DPT_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE 0;
-IF &GROUPCK2 EQ 'Y' THEN GOTO NWPDEFINE2;
PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
             IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B')  THEN 1 ELSE 
            IF  (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') THEN 1 ELSE 
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) THEN 1 ELSE 0;
-GOTO FinDefine2;
-NWPDEFINE2;
PREF_AIRA/I5=IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (AIRLINE_INT_DOM EQ 'B')  AND (BR_CL_IDX EQ GROUP_NUMBER)  THEN 1 ELSE 
            IF  (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (AIRLINE_INT_DOM EQ 'B') AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (FST_DPT_DATE FROM DEPART_EFFECTIVE_DATE TO DEPART_EXPIRATION_DATE) AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE
            IF (VAL_AIRLINE EQ AIRLINE_CODE) AND (CATEGORY EQ AIRLINE_CATEGORY) AND 
               (TRN_DATE FROM TICKET_EFFECTIVE_DATE TO TICKET_EXPIRATION_DATE) AND 
               (DEPART_EFFECTIVE_DATE EQ ' ') AND 
               (DOM_INTL_CODE EQ AIRLINE_INT_DOM) AND (BR_CL_IDX EQ GROUP_NUMBER) THEN 1 ELSE 0;
-FinDefine2
END

TABLE FILE PREFHLD
SUM NET_TKT_CNT
    MRK_TKT_CNT
    FARE_PAID
    ONL_TKTS
    REF_TKTS
    LEVEL_DESC
    PASSNGR_NAME
COMPUTE PREF_AIR1/A1 = IF PREF_AIRA GT 0 THEN 'P' ELSE 'N';  
BY LEVEL_DESC
BY VAL_AIRLINE
BY TKT_NUM
BY TRN_DATE
BY FST_DPT_DATE
BY CATEGORY
BY DOM_INTL_CODE
ON TABLE HOLD AS PREFHLD2
END
-RUN




DEFINE FILE PREFHLD2
PREF_AIR/P12CS = IF PREF_AIR1 EQ 'P' THEN NET_TKT_CNT ELSE 0;
END
TABLE FILE PREFHLD2
SUM NET_TKT_CNT
    MRK_TKT_CNT
    FARE_PAID
    ONL_TKTS
    REF_TKTS
    LEVEL_DESC
    PASSNGR_NAME
    PREF_AIR
BY LEVEL_DESC 
BY PASSNGR_NAME
BY TKT_NUM
ON TABLE HOLD AS PAXPRFHLD
END
-RUN
 


-GOTO XXIT

-NOprefAir

DEFINE FILE PREFHLD
PREF_AIR/P12CS =  0;
END
TABLE FILE PREFHLD
SUM NET_TKT_CNT
    MRK_TKT_CNT
    FARE_PAID
    ONL_TKTS
    REF_TKTS
    LEVEL_DESC
    PASSNGR_NAME
    PREF_AIR
BY LEVEL_DESC 
BY PASSNGR_NAME
BY TKT_NUM
ON TABLE HOLD AS PAXPRFHLD
END
-RUN


-XXIT
