-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* JK Added Level2, Level3 9/16/04
-* JK Changed Level2, Level3 to carry through instead of a sort prior to the
-*    match
-* DV ADDED CODE FOR GLOBAL CURRENCY - 1/5/05
-* DV CARRIED THROUGH LEVEL1 - 7/25/05
-* DV ADDED SORT BY LEVEL1 FOR CONG 4/7/08
-* Changed ITPAXTVL, ITPAXTV2, TTPAXTVL to sort by PASSNGR_NAME
-* insted of XPSNGR_NM   - Deb 5/26/10
-*7/11/16 S-20630 DLV  Added EMP_ID to extract
-*05/24/17 - DLV - S-34879  Added new routine for  TMPAXSUM 


-INCLUDE SETECHO


-DEFAULT &&NOHTLREC = 'N';


SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN
-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';

DEFINE FILE &&EXTRACT

  LEVEL_DESC/A60  = &&LDESC;
  IN_DATE/MDYY = CHKIN_DATE;
  INV_DATE/MDYY = INVOICE_DATE;
  NBR_DAYS/D12 =  NUM_DAYS;
  NBR_ROOMS/D12 = NUM_ROOMS;
  NEW_ROOM_RATE/D14.2C = ROOM_RATE;
  NEW_STD_RATE/D14.2C = STD_RATE;
  NEW_TOTAL_AMT/D14.2C = TOTAL_AMT;
  NNROOMS/D12 = IF ((NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)) THEN 
                ((NBR_DAYS*NUM_ROOMS) * (-1)) ELSE NBR_DAYS*NUM_ROOMS;
  OUT_DATE/MDYY = CHKOUT_DATE;
  TRAN_MONTH/MT = INVOICE_DATE;

  XPSNGR_NM/A15 =EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  
END
-RUN

TABLEF FILE &&EXTRACT
PRINT 
  AR_BRANCH
  AROLL_LEV3
  AROLL_LEV4
  AROLL_LEV6
  AROLL_LEV7  
  AROLL_DSC3
  AROLL_DSC4
  AROLL_DSC7
  BR_CL_IDX	
  CLIENT_NAME
  CURR_DATE
  EMP_ID
  HTL_KEY
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  RESV_BRANCH
  RESV_DATE	
  ROOM_RATE 	
  ROOM_TYPE
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  TRAN_MONTH
  XPSNGR_NM

-INCLUDE &HTLDATES    
-* WHERE TOTAL_AMT NE 0
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE9
-IF &&SETF EQ 'BWPAXBR' OR 'BWPAXCN' OR 'BWPAXIT' THEN GOTO WHERE2 ELSE GOTO WHERE1;
-WHERE2;
&&WHERE10
-WHERE1;

-INCLUDE RPTPARMS

ON TABLE HOLD AS TOPHTLH
END
-RUN

TABLE FILE TOPHTLH
PRINT AR_BRANCH
  AROLL_LEV3
  AROLL_LEV4
  AROLL_LEV6
  AROLL_LEV7
  AROLL_DSC3
  AROLL_DSC4
  AROLL_DSC7
  CLIENT_NAME
  EMP_ID
  HTL_KEY
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  RESV_BRANCH
  RESV_DATE	
  ROOM_RATE 	
  ROOM_TYPE
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  TRAN_MONTH
  XPSNGR_NM
BY CURR_DATE
ON TABLE HOLD AS TPHTLHLD FORMAT FOCUS INDEX CURR_DATE
END
-RUN

-* Global Reporting JOIN
JOIN TPHTLHLD.CURR_DATE IN TPHTLHLD TO GLOBAL.DATE IN GLOBAL AS J1
END

DEFINE FILE TPHTLHLD
NAMEC/A30 = CNAME;


-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
AMT_TOTALX/D20.6 = NEW_TOTAL_AMT * CURR1X;
END

TABLE FILE TPHTLHLD
PRINT AR_BRANCH
  AROLL_LEV3
  AROLL_LEV4
  AROLL_LEV6
  AROLL_LEV7  
  AROLL_DSC3
  AROLL_DSC4
  AROLL_DSC7
  CLIENT_NAME
  CURR_DATE
  EMP_ID
  HTL_KEY
  IN_DATE 	
  INV_DATE	
  INVOICE_DATE 	
  INVOICE_NUM 	
  LEVEL_DESC	
  LEVEL1 	
  LEVEL2 	
  LEVEL3 
  NBR_DAYS	
  NBR_ROOMS
  NEW_ROOM_RATE
  NEW_STD_RATE
  NEW_TOTAL_AMT	
  NNROOMS	
  NUM_DAYS 	
  NUM_ROOMS	
  OUT_DATE 	
  PASSNGR_NAME 	
  PNR_LOCATOR 	
  RESV_BRANCH
  RESV_DATE	
  ROOM_RATE 	
  ROOM_TYPE
  TICKET_BRANCH	
  TKT_NUM	
  TOTAL_AMT 
  TRAN_MONTH
  XPSNGR_NM
  AMT_TOTALX/D16.2CS
  NAMEC
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS TOPHTLH2
END
-RUN


-SET &&SORT1 = &&RANK_LABEL1;
-SET &&SORT2 = &&RANK_LABEL2;


-IF '&&SETF.EVAL' EQ 'ITBUSUM' THEN GOTO DEBH;
-IF '&&SETF.EVAL' EQ 'TMPAXSUM' THEN GOTO TMOBH;

-SET &LVL1 = IF '&&ROLLUP.EVAL' EQ 'CRAY-R' OR 'ITRON-R' THEN EMP_ID ELSE LEVEL1;
 


-*-IF '&&SETF.EVAL' EQ 'ITPAXTVL' OR 'ITPAXTV2' OR 'TTPAXTVL' THEN GOTO NextsortH;



TABLE FILE TOPHTLH2
SUM 
  NBR_DAY
  NBR_ROOMS
  NNROOMS
  NEW_TOTAL_AMT
  LEVEL2
  LEVEL3
  AMT_TOTALX/D16.2CS
  NAMEC
BY &&SORT1
BY &&SORT2
-IF '&&SETF.EVAL' NE 'CYPAXTVL' OR 'GWPAXTVL' OR 'TMPAXSUM' THEN GOTO BYSKIPH;
BY &&RANK_LABEL3
-BYSKIPH;
BY &LVL1
BY PASSNGR_NAME
ON TABLE HOLD AS HOLDHPX 
END
-RUN

-GOTO Donehtl;


-TMOBH;
TABLE FILE TOPHTLH2
SUM 
  NBR_DAY
  NBR_ROOMS
  NNROOMS
  NEW_TOTAL_AMT
  LEVEL2
  LEVEL3
  AMT_TOTALX/D16.2CS
  NAMEC
BY &&SORT1
BY &&SORT2
BY &&RANK_LABEL3
BY PASSNGR_NAME
ON TABLE HOLD AS HOLDHPX 
END
-RUN



-GOTO Donehtl;



-NextsortH
TABLE FILE TOPHTLH2
SUM 
  NBR_DAY
  NBR_ROOMS
  NNROOMS
  NEW_TOTAL_AMT
  LEVEL2
  LEVEL3
  AMT_TOTALX/D16.2CS
  NAMEC
BY &&SORT1
BY &&SORT2
BY LEVEL1
BY XPSNGR_NM
ON TABLE HOLD AS HOLDHPX 
END
-RUN

-GOTO Donehtl;


-DEBH

DEFINE FILE TOPHTLH2
FLAG/A1 = 'H';
END
TABLE FILE TOPHTLH2
SUM FLAG NEW_TOTAL_AMT/D12.2CS
BY &&SORT1
BY TRAN_MONTH
ON TABLE HOLD AS TPHTL
END
-RUN


-Donehtl

-IF &RECORDS NE 0 THEN GOTO XXITHTL;

-SET &&NOHTLREC = 'Y';

-XXITHTL
