-*5/8/14 - DEB - TESTING ONLY
-* 7/29/14 - DEB - ADDED ROUTINE FOR BZTRPPRP
-* CARRIED THRU TRP_LEN - JK 8/3/14 
-* ADDED GOTO SO RDFL REPORT WOULD USE DIFFERENT STYLESHEET - JK 8/14/14
-*  02/02/2015  REJ  S-05681 Changes to the no data report to prepare for the Available
-*                           Report changes.  Rollup Code is being removed from BRPTINST in
-*                           ER5, so I'm removing the reference to the ROLLUP_CODE in that report.
-* 7/2/15 JEK-Story ID - S-07156 - Added fields for new standard air fare re-search savings report
-* 7/22/15 JEK-StoryID- S-07156-Per Jami we are making the DSS amount 0 on exchanges
-* 11/10/15 - DLV - S-12670 - Added VAL_AIRLINE VALAIR_NAME and 
-*                            new routine for new report ABPASSP
-*02/23/16 - JEM - S-15795  Added logic for new report HDUDFLYD
-*05/17/16- JEM-S-18812 - Added logic for SHBTALST
-*12/21/16 - DLV - S-27218 - Added code for new styling of RDFTRP
-*02/22/17 - DLV - S-30299 - Changed to sort by EMP_ID instead of LEVEL5 for routine RDSTY
-*03/13/17 - DLV - S-22486 - updated ettek Review to Post-trip Reporting
-*04/10/17 - DLV - S-33125 - added routine for LFTRP50 LFTRP50U
-*4/26/2017-JEM-S-33318-updated logic for no records report
-* 06/06/2017 - RSB - S-35474 - EJONES-R EDJ would like the group numbers (UDID GN-)
-*                               Also repositioned the footer date/time stamp while I was here.
-* 08/14/2017 RSB S-38044 Place the footer datetime stamp text in a separate file to be -INCLUDED in the stylesheets
-*                         Backed out old footer changes.
-* 09/26/2017 RSB - S-40348 - Analyze ABUDDSS for performance
-*                             Bypass -INCLUDE RETUDID
-*
SET ASNAMES = ON
-RUN
 

-IF '&&SETF.EVAL' EQ 'LFBCDSM' OR 'ABPASSP' OR 'LFTRP50' OR 'LFTRP50U' OR 'ABUDDSS' THEN GOTO SKIPthis;
-INCLUDE RETUDID
-RUN

-SKIPthis 

TABLE FILE &&RPT_HOLD
SUM 
    DISSAVINGS AS 'TLOSS'
    FARE_PAID/D12.2CS AS 'TFARE'	
    NET_TKT_CNT/P12 AS 'NTTKT'
    BASE_FARE AS 'TBASE'
    SEG_TAX AS 'TTAX'
BY LEVEL_DESC  
ON TABLE HOLD AS HOLDONE
END
-RUN

TABLE FILE &&RPT_HOLD
PRINT  
  AIR_KEY
  AIRLINE_NAME
  AROLL_DSC14
  AROLL_DSC15
  AGENT_NUM
  BOOK_DT
  BASE_FARE
  CATEGORY
  CC_NUM
  CLASS_CAT
  DISSAVINGS
  DPT_MON
  EMP_ID
  EMB_APT_NM
  IBOOK
  INTL_DOM
  FARE_PAID
  FLT_RANGE
  LEVEL5
  NEW_ADV_PURCH	
  NET_TKT_CNT   
  ORG_APC
  DST_APC
  OTFLAG
  PASSNGR_NAME
  REF_EXCH_CNT
  RTE_APT_NM
  SEG_AMT
  SEG_TAX
  SEG_LOWEST
  STD_FARE
  TKT_PURCH
  LOWEST_AMT
  CC_NUM
  TKT_NUM
  TKT_SORT
  TKT_TYPE
  SEG_NBR
  EMB_APT_CD
  TRN_DATE
  XPSNGR_NM
  TRP_DSC
  TRIP_RSN  
  TRP_LEN
  TRP_STAY
  VAL_AIRLINE
  VALAIR_NAME
  XDPT_DT
BY LEVEL_DESC
BY REFUSE_CODE
BY REFUSAL_DESC
ON TABLE HOLD AS XTWO
END
-RUN

MATCH FILE XTWO
PRINT AIR_KEY 
  AIRLINE_NAME
  AROLL_DSC14
  AROLL_DSC15
  AGENT_NUM
  BASE_FARE
  BOOK_DT
  CATEGORY
  CC_NUM
  CLASS_CAT
  DISSAVINGS
  DPT_MON
  EMP_ID
  EMB_APT_NM
  IBOOK
  INTL_DOM
  FARE_PAID
  FLT_RANGE
  LEVEL5
  NET_TKT_CNT
  ORG_APC
  DST_APC
  NEW_ADV_PURCH	
  OTFLAG
  PASSNGR_NAME
  RTE_APT_NM
  REF_EXCH_CNT
  SEG_AMT
  SEG_LOWEST
  SEG_TAX
  STD_FARE
  TKT_PURCH
  CC_NUM
  TKT_NUM
  TKT_SORT
  TKT_TYPE
  SEG_NBR
  EMB_APT_CD  
  TRN_DATE
  XPSNGR_NM
  TRP_DSC
  TRIP_RSN
  TRP_LEN
  TRP_STAY
  VAL_AIRLINE
  VALAIR_NAME
  XDPT_DT
BY LEVEL_DESC
BY REFUSE_CODE
BY REFUSAL_DESC
ON TABLE HOLD
RUN
FILE HOLDONE
SUM NTTKT    
    TFARE    
    TLOSS
    TBASE
    TTAX
BY LEVEL_DESC
AFTER MATCH HOLD AS XTHREE OLD-OR-NEW 
END
-RUN

-IF '&&ROLLUP.EVAL' EQ 'USG-R' THEN GOTO EXUSG;

TABLE FILE XTHREE
PRINT AGENT_NUM
  AIRLINE_NAME
  AROLL_DSC14
  AROLL_DSC15
  BASE_FARE  
  BOOK_DT
  CATEGORY
  CC_NUM
  CLASS_CAT
  DISSAVING
  DPT_MON
  EMP_ID
  EMB_APT_NM
  IBOOK
  INTL_DOM
  REF_EXCH_CNT
  SEG_AMT
  SEG_LOWEST
  SEG_TAX
  STD_FARE
  TKT_PURCH 
  FARE_PAID
  FLT_RANGE
  LEVEL5
  ORG_APC
  DST_APC
  NET_TKT_CNT 
  NEW_ADV_PURCH	
  OTFLAG
  LEVEL_DESC
  NEW_ADV_PURCH	
  PASSNGR_NAME
  RTE_APT_NM
  REFUSE_CODE
  REFUSAL_DESC
  NTTKT
  TBASE
  TFARE
  TLOSS
  TTAX
  TKT_NUM
  TKT_SORT
  TKT_TYPE
  SEG_NBR
  EMB_APT_CD 
  TRN_DATE
  XPSNGR_NM
  TRP_DSC
  TRIP_RSN
  TRP_LEN
  TRP_STAY
  VAL_AIRLINE
  VALAIR_NAME
  XDPT_DT
BY AIR_KEY
ON TABLE HOLD AS AIRHOLD4 FORMAT FOCUS INDEX AIR_KEY
END
-RUN


-IF '&&SETF.EVAL' EQ 'TZTRPRSN' THEN GOTO EXTRIZ;
-IF '&&SETF.EVAL' EQ 'HDUDFLYD' THEN GOTO EXHDRR;
-IF '&&SETF.EVAL' EQ 'ABUDLSAV' THEN GOTO EXWWF;
-IF '&&SETF.EVAL' EQ 'LFBCDSM' GOTO EXLIFE;
-IF '&&SETF.EVAL' EQ 'MXBTA' OR 'MXBTA1' OR 'MXBTA2' THEN GOTO METX;
-IF '&&SETF.EVAL' EQ 'BZPERKS' THEN GOTO BZP;
-IF '&&SETF.EVAL' EQ 'BZCOSTA' THEN GOTO BZC;
-IF '&&SETF.EVAL' EQ 'BZUALSV' THEN GOTO BZCRC;
-IF '&&SETF.EVAL' EQ 'BZTRPPRP' THEN GOTO BZGLOBAL;
-IF '&&SETF.EVAL' EQ 'RDFTRP' THEN GOTO ROSSTRIP;
-IF '&&SETF.EVAL' EQ 'ABUDDSS' THEN GOTO EXDSS;
-IF '&&SETF.EVAL' EQ 'ABPASSP' THEN GOTO PASSP;
-IF '&&SETF.EVAL' EQ 'BDRFADTL' THEN GOTO BAIRRF;

-IF '&&SETF.EVAL' EQ 'SHBTALST' THEN GOTO SCHNEI;
-IF '&&SETF.EVAL' EQ 'ABUDGN1S' THEN GOTO MCMGRPNM;
-IF '&&SETF.EVAL' EQ 'LFTRP50' OR 'LFTRP50U' THEN GOTO LIFETRP;

-EXTRIZ
EX UDTRZSM
-RUN


-IF &&TRZSM EQ 'Y' THEN GOTO NORECORDS;

-GOTO Continue;

-EXHDRR;
EX UDHDFLYSM
-RUN


-IF &&HDRSM EQ 'Y' THEN GOTO NORECORDS;

-GOTO Continue;

-EXUSG

EX UDUSGSM
-RUN


-IF &&USGSM EQ 'Y' THEN GOTO NORECORDS;
-GOTO Continue;


-EXWWF

 
TABLE FILE AIRHOLD4
PRINT AIR_KEY  
  DISSAVINGS
  FARE_PAID
  NET_TKT_CNT  
  LEVEL_DESC
  REFUSE_CODE
  REFUSAL_DESC
  NTTKT
  TFARE
  TLOSS
BY LEVEL_DESC
ON TABLE HOLD AS AIRHOLD5
END
-RUN
-GOTO Continue;


-EXLIFE 
EX UDLIFSM
-RUN

-IF &&LIFSM EQ 'Y' THEN GOTO NORECORDS;
-GOTO Continue;

-BZP
EX UDBZPSM
-RUN
-IF &&BZPSM EQ 'Y' THEN GOTO NORECORDS;
-RUN


-GOTO Continue;


-BZC;
EX UDBZCSTS
-RUN
-IF &&NOBZDREC EQ 'Y' THEN GOTO NORECORDS;
-RUN
-GOTO Continue;

-BZCRC;
EX UDBZCRC
-RUN
-IF &&NOBZDREC EQ 'Y' THEN GOTO NORECORDS;
-RUN
-GOTO Continue;


-BZGLOBAL
EX UDBZGBLSM
-RUN
-IF &&NOBZREC2 EQ 'Y' THEN GOTO NORECORDS;
-RUN
 


-GOTO Continue;

-METX
EX UDMXAPPSM
-RUN

-GOTO Continue;


-ROSSTRIP;

 

EX UDRDFTSM
-RUN
 

-GOTO RDSTY;

-EXDSS
EX UDABDSS
-RUN

-IF &&ABDSSSM EQ 'Y' THEN GOTO NORECORDS;

-GOTO Continue;

-PASSP

EX UDPPSM
-RUN



-IF &&ABPPSM EQ 'Y' THEN GOTO NORECORDS;
-GOTO Continue;


-BAIRRF

EX UDBDRFSM
-RUN



-IF &&NORFREC EQ 'Y' THEN GOTO NORECORDS;
-GOTO Continue;

-SCHNEI

EX UDSCHBTASM
-RUN


-IF &&SCHBTASM EQ 'Y' THEN GOTO NORECORDS;

-GOTO Continue;



-LIFETRP

EX UDLFTRP
-RUN
 

-IF &&NORECLF EQ 'Y' THEN GOTO NORECORDS;
 
-GOTO Continue;
-*
-*********
-MCMGRPNM
-*********
EX UDABGN1S
-RUN
-* 
-IF &&NO_GNGRP EQ 'Y' THEN GOTO NORECORDS;
-*
-GOTO Continue;
-* 



-Continue


DEFINE FILE AIRHOLD5 ADD
  PCTDSAVE/D8.1S=IF ((TLOSS LT 1) AND (TLOSS GT (-1))) THEN 0
                 ELSE ((DISSAVINGS/TLOSS)*100);
  PCTFARE/D8.1S=IF ((TFARE LT 1) AND (TFARE GT (-1))) THEN 0 
                ELSE ((FARE_PAID/TFARE)*100);	
  PCTNETTKT/D8.1S=IF ((NTTKT LT 1) AND (NTTKT GT (-1))) THEN 0 
                  ELSE ((NET_TKT_CNT/NTTKT)*100);  	
   NOWTOD/A8 WITH LEVEL_DESC = HHMMSS (NOWTOD);
-IF '&&ROLLUP.EVAL' NE 'USG-R' THEN GOTO NOTthis;

  PCPSAVE/D8.1S=IF ((TPOT LT 1) AND (TPOT GT (-1))) THEN 0
                ELSE ((POT_SAV/TPOT)*100);	
  PCASAVE/D8.1S=IF ((TADD LT 1) AND (TADD GT (-1))) THEN 0
                ELSE (ADD_SAV/TADD);
  PCTSAVE/D8.1S=IF ((TSAV LT 1) AND (TSAV GT (-1))) THEN 0
                ELSE ((SAV_AMT/TSAV)*100);  
-NOTthis
END
-RUN

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADER' ELSE 'HDREXLS'; 
-SET &&PASTYS = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE &&SMSTY;
-RUN

 

TABLE FILE AIRHOLD5
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
    &&S_SUBJ1
    &&S_SUBJ2
    &&S_SUBJ3
    &&S_SUBJ4
    &&S_SUBJ5
    &&S_SUBJ6
    &&S_SUBJ7
    &&S_SUBJ8
    &&S_SUBJ9
    &&S_SUBJ10
    
-*BY
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
-*ON
-IF &&SETF EQ 'BZPERKS' OR 'BZCOSTA' OR 'BZUALSV' OR 'BZTRPPRP' OR 'HDUDFLYD' GOTO NOBO;
&&BREAKOPTION
-NOBO;
   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10

 
-IF '&&SETF.EVAL' NE 'ABPASSP' THEN GOTO SKIPfoot;
SET &FTR_AddlLines = 4;
FOOTING BOTTOM
"</2"
"Report excludes MCOS and forfeit penalty amounts:"
-*********
-SKIPfoot
-*********
-INCLUDE FOOTERSM

ON TABLE COLUMN-TOTAL

ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT

ON TABLE SET STYLE *
-INCLUDE &&PASTYS

 
-IF '&&OUTFMT.EVAL' EQ 'EXCEL' THEN GOTO SKIPdd;
-*

-IF (&&DRILLABLE EQ 'N') OR ('&&SETF.EVAL' EQ 'ABUDGN1S') GOTO SKIPdd;
-*
-INCLUDE &&DSTY
-*******
-SKIPdd;
-*******
ENDSTYLE
&&OUTLINE1
&&SUMMDEST
&&OUTLINE2
END
-RUN

-IF &&DRILLABLE EQ 'Y' GOTO SKIP_R3;

EX REPORT_3
-RUN

-SKIP_R3

-GOTO XXIT;

-RDSTY;
SET COMPOUND=BYTOC
-SET &&OUT3 = IF '&&OUTTO.EVAL' EQ 'XB' THEN 'ON TABLE PCHOLD FORMAT EXL2K' ELSE
-                                            'ON TABLE SAVE AS SAVREP FORMAT EXL2K';


-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADER' ELSE 'HDREXLS'; 
-SET &&PASTYS = 'SMRDFLSTY';
-RUN

DEFINE FILE RDFTRIP
 NOWTOD/A8 WITH DEPART_M = HHMMSS (NOWTOD);
 KEY/A1 = IF XPSNGR_NM EQ ' ' THEN 'Z' ELSE 'A';
 KEY1/A1 = IF EMP_ID EQ ' ' THEN 'B' ELSE 'A';
END
-RUN
TABLE FILE RDFTRIP
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;


SUM NTKTS AS 'Trips'
TRPLEN AS 'Days'
BY LEVEL_DESC NOPRINT
BY KEY NOPRINT 
BY XPSNGR_NM AS 'Passenger,Name'
BY KEY1 NOPRINT BY EMP_ID AS 'Employee ID'
BY ID AS '' 
ACROSS ROW_ORDER NOPRINT
ACROSS DEPART_M AS ' '

ON TABLE NOTOTAL
ON LEVEL_DESC COLUMN-TOTAL
ON XPSNGR_NM SKIP-LINE
ON XPSNGR_NM RECOMPUTE MULTILINES AS 'TOTAL FOR'
 
 
 

-GOTO FinishRpt;
    &&S_SUBJ1
    &&S_SUBJ2
    &&S_SUBJ3
    &&S_SUBJ4
    &&S_SUBJ5
    &&S_SUBJ6
    &&S_SUBJ7
    &&S_SUBJ8
    &&S_SUBJ9
    &&S_SUBJ10
    
-*BY
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
-*ON

   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10

-FinishRpt;

-INCLUDE FOOTERSM
ON TABLE COLUMN-TOTAL



ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT





ON TABLE SET STYLE *
-INCLUDE &&PASTYS

ENDSTYLE
&&OUT3

END
-RUN

-IF &&DRILLABLE EQ 'Y' GOTO SKIP_R3R;

EX REPORT_3
-RUN

-SKIP_R3R

-GOTO XXIT;



-NORECORDS
-SET &INST_KEY = &&IKEY;

TABLE FILE BRPTINST
PRINT PAIR_DB RPT_GROUP RPT_STREAM GLOBAL_PARM USE_PARM INST_KEY
WHERE INST_KEY EQ &INST_KEY
ON TABLE SAVE AS PAIRDB
END
-RUN

-READ PAIRDB &PAIRDB.A1. &RPTGRP.A3. &RPTSTREAM.A8. &SETFILE.A8. &VIEW.A8.
-CLOSE PAIRDB
 
-SET &RPTGRP = '&RPTGRP.EVAL';
-SET &VIEW = '&VIEW.EVAL';
-SET &STREAM = '&RPTSTREAM.EVAL';

-SET &HEADER = IF &RPTGRP EQ 'ADD' OR 'CDD' OR 'HDD' THEN 'NORECHDRDD' ELSE 'NORECHDR';
-RUN


-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN &HEADER ELSE  
-              IF &RPTGRP EQ 'ADD' OR 'CDD' OR 'HDD' THEN 'HDREXLSDD' ELSE 
-              IF &STREAM EQ 'AIR_BNM' THEN 'HDREXLSDD' ELSE 'HDREXLS';

-RUN


-SET &&PASTYD = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE 'NORECSTY';

JOIN SET_KEY IN BRPTINST TO SET_KEY IN BRPT_SET AS J1
-RUN

DEFINE FILE BRPTINST
EMPTY/A35 = 'NO RECORDS FOUND FOR THIS SELECTION';
NOWTOD/A8 WITH INST_KEY = HHMMSS (NOWTOD);
END
TABLE FILE BRPTINST
-INCLUDE &&PAHDR
PRINT EMPTY AS 'REPORT,MESSAGE'
BY ROLLUP_CODE AS 'ROLLUP,CODE'
BY RPT_NAME AS 'REPORT,NAME'
BY SELECT_LEV AS 'BREAK,LEVEL'
IF INST_KEY EQ &&IKEY
IF RECORDLIMIT EQ 1
-INCLUDE FOOTERDT
ON TABLE SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET PAGE-NUM OFF
ON TABLE SET STYLE *
-INCLUDE &&PASTYD
ENDSTYLE
 
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN

-XXIT



-*-*-EXIT




