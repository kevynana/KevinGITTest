-***************************************************************************
-* REPORT NAME: TOP NON DIRECTIONAL MARKET PAIR SUMMARY
-* TOTAL COMPANY REPORTING
-* JK added code to select only tnt_company eq 1 or 2 2/21/05
-* 5/14/2015 - Deb - S-08964 = corrected HI_CAT define
-* 5/18/2015 - Deb - S-08964 - changed extract to carry through TKT_CL_CAT
-*                             instead of HI_CAT
-*09/08/2017    DLV     S-37268    updated ORG_APX to use ORG_APCX updated ND_CP_CD define
 
-***************************************************************************
-INCLUDE SETECHO
SET ASNAMES = ON
-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED IN STEP7
-*========================================================================
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

DEFINE FILE &&EXTRACT
DEMB_APT/A21=EDIT(EMB_APT.AIRPORT_NAME,'999999999999999999999$$$$');
DIR_CITY_CD/A50 = EMB_CTY.EMB_CITY || '-' || RTE_CTY.RTE_CITY;
DIR_CITY_NM/A50 = EMB_CTY.CITY_NAME | RTE_CTY.CITY_NAME; 
DIR_CP_CD/A50 = CITYPAIR.EMBARK || '-' || CITYPAIR.ROUTE;
DIR_CP_NM/A50 = EMB_APT.AIRPORT_NAME | RTE_APT.AIRPORT_NAME;
DPT/A2 = EDIT (DPT_TIME, '99$$');
DRTE_APT/A21=EDIT(RTE_APT.AIRPORT_NAME,'999999999999999999999$$$$');
EMB_APT/A21=EDIT(NDO_APT.AIRPORT_NAME,'999999999999999999999$$$$');
FARE_PAID/D12.2S  = SEG_AMT + SEG_TAX;
ND_CITY_CD/A50 = NDO_CTY.NDO_CITY || '-' || NDD_CTY.NDD_CITY;
ND_CITY_NM/A50 = NDO_CTY.CITY_NAME | NDD_CTY.CITY_NAME;
-*ND_CP_CD/A50  = NDO_APT.ND_ORG || '-' || NDD_APT.ND_DST;
ND_CP_CD/A50  = ND_ORG || '-' || ND_DST;
NET_TKT_CNT/D8    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
RTE_APT/A21=EDIT(NDD_APT.AIRPORT_NAME,'999999999999999999999$$$$');
-* Defines on Previous Defines
ND_CP_NM/A55 = EMB_APT|'        '|RTE_APT;
-IF '&&SETF.EVAL' EQ 'TCTC10D' OR 'TCTC10I' THEN GOTO SETID;
ORGDST/A55 = &&ORGDST;
-GOTO NCHK;
-SETID;
ORGDST/A55=ND_CP_CD;
-NCHK;
CTY_CHK/A1 = IF ND_CP_CD EQ 'JFK-LAX' OR 'JFK-SFO' OR 'ORD-SFO' OR 'ATL-SFO' OR
                                  'LAX-SFO' OR 'PDX-SFO' OR 'SFO-SEA' OR 'JFK-LHR' OR 
                                  'CDG-JFK' OR 'LHR-SFO' OR 'SFO-TPE' OR 'HKG-SFO' THEN 'Y' ELSE 'N';

 HI_CAT/A1 = IF ADIR_ALL CONTAINS '*F' THEN 'F' ELSE IF ADIR_ALL CONTAINS '*B' THEN 'B' ELSE 'C';
-*AT_FLAG/A1 = EDIT(ND_ORGX, '$$$9'); 
-*ORG_APX/A4 = ORG_APC || AT_FLAG;
ORG_APX/A7 = ORG_APCX;
ORGAP/A4 = EDIT(ORG_APCX, '$$$9999');
FLAG/A1 = IF ORGAP EQ 'ATLA' OR 'JFKA' AND 
              FNL_DEST_AIRPORT EQ 'CGH' OR 'GRU' OR 'MXP' THEN 'Y' ELSE 'N';
FLAG2/A1 = IF ORGAP EQ 'GRUA' OR 'CGHA' OR 'MXPA' AND
              FNL_DEST_AIRPORT EQ 'JFK' OR 'ATL' THEN 'Y' ELSE 'N';
FLAG3/A1 = IF HI_CAT EQ 'B' OR 'C' THEN 'Y' ELSE 'N';
END

TABLEF FILE &&EXTRACT
PRINT 
  CITYPAIR.AIRLINE AS 'CP_AIRLINE'
  CITYPAIR.SEG_MILES/D9C AS 'MILES'	
  FARE_PAID  AS 'CP_FARE_PD'
  ND_CP_NM
  NET_TKT_CNT
  ORGDST
  TKT_CL_CAT
  FNL_DEST_AIRPORT AS 'FNL_DEST'
  ORG_APX
-INCLUDE &AIRDATES
WHERE VOID_DATE EQ 0
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10
-INCLUDE RPTPARMS
ON TABLE HOLD AS TC_MRK 
END
-RUN


-IF &LINES EQ 0 THEN GOTO NEXTONE;
-*========================================================================
-*   PROCESS EXTRACT DATA FROM STEP4 - HOLD TO FOCUS DATABASE TCRANK        
-*========================================================================
DEFINE FILE TC_MRK
ROLLCD/A8 = '&&ROLL';
END
TABLE FILE TC_MRK
SUM CP_FARE_PD AS 'FARE'
    MILES	
    NET_TKT_CNT
BY ROLLCD
BY TKT_CL_CAT
BY ORG_APX
BY FNL_DEST
ON TABLE HOLD AS HOLD2 
END
-RUN


DEFINE FILE HOLD2
NMB/I5    = NMB + 1;
END

TABLE FILE HOLD2
SUM NET_TKT_CNT
    FARE
    MILES
BY ROLLCD
BY NMB
BY TKT_CL_CAT
BY ORG_APX
BY FNL_DEST
ON TABLE HOLD AS TCM1
END
-RUN



MODIFY FILE TCAVGMP
FIXFORM FROM TCM1
DATA ON TCM1
END
-RUN



-NEXTONE



-XXIT
 
