-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File AVIW11SM.FEX
-INCLUDE SETECHO
-**********************************************************************
-*DATE           NAME               DESCRIPTION
-*7/31/00      IBISTL-KR            ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERSM
-*8/18/00      IBISTL-KR            INCLUDE STYLESHEET PARAMS FOR 
-*                                  DRILLABLE REPORTS.
-*03/30/01     DEB BUCKNER/WTORRES  VIEW AMENDED TO NOT INCLUDE CARRIERS
-*                                  W/NO NAME
-*04/09/01     SCORDS/JKALHORN      COMMENTED OUT THE CARRIERS W/NO NAME
-*                                  COMMENTED OUT THE IF FARE > 0
-*07/03/02   STEVE              CHANGED TO eTTek Review and Copyright
-*11/5/03    JK                 &&RANK_METH WAS NOT BEING SET CORRECTLY
-*                              FROM CODEGEN/ADDED CODE TO SET THIS CORRECTLY
-*3/15/04    JK                 CHANGED VIEW TO NOT SORT BY LEVEL_DESC TO 
-*                              ELMINATE DUP AIRLINES IF SORTED 
-*                              AT A LOWER LEVEL
-*10/29/04    DEB               CHANGED TO ADD GLOBAL CURRENCY
-*09/21/05 CREATED FOR CARRIER USAGE SUMMARY BY BOOKING TYPE REPORT
-*12/20/11    GSE                   Removed parens from around OLIMIT for
-*                                  7.7.03
-*7/11/16     DLV               S-21378 Commented sort by CLASS_CAT on first
-*                              hold file changed to CLASS_CAT to sum
-*                              this field not used for ABONCARI BVONCARI OR JCONCARI
-* 07/03/2017 - RSB - S-35420 Report view to be updated with standard footer (part 3)
-* 09/13/2017   RSB  S-39793 Footer changes to be backed out of story S-35420
-*
-**********************************************************************
-*
-SET &&RANK_METH =  'NET_TKT_CNT';
-SET &&RANK_LIMIT =    50;
-SET &&RANK_LIMIT2 = 10;

-SET &&RANK_METH = IF &&RANK_METH EQ 'BASE_FARE' THEN 'BASE_FARE'
- ELSE IF &&RANK_METH EQ 'NET_TKT_CNT' THEN 'NET_TKT_CNT' 
- ELSE 'NET_TKT_CNT';





SET ASNAMES = ON
-RUN

-IF &&SETF EQ 'ABONCARI' AND &&CURRENCY NE 'USD' THEN GOTO CARIR
-ELSE GO TO NEXT;

-CARIR;

-SET &&SUBHEAD = <NAMEC;
-SET &FBASE_CUR = 'BASE FARE, (' | &&CURRENCY || ')';
-SET &GAVGP_CUR= 'AVG,FLIGHT,PRICE, (' | &&CURRENCY || ')';
-SET &GCPK_CUR= 'COST,/KLMTR, (' | &&CURRENCY || ')';
-SET &&S_SUBJ3='GFARE/D16.2CS AS ' | '''&FBASE_CUR.EVAL'''  ;
-SET &&S_SUBJ4='PCT.GFARE/D8.2 AS ''% OF,FARE'' KILO/P9CS AS ''TOTAL KLMTRS''';
-SET &&S_SUBJ5='PCT.KILO/P8.2 AS ''% OF,KLMTRS''';
-SET &&S_SUBJ6='COMPUTE CAVG_FLT/P14.2 = IF ((NET_TKT_CNT LT 1) AND';
-SET &&S_SUBJ7='(NET_TKT_CNT GT (-1))) THEN 0';
-SET &&S_SUBJ8='ELSE (GFARE/NET_TKT_CNT); AS ' | '''&GAVGP_CUR.EVAL''';
-SET &&S_SUBJ9='COMPUTE GCPK/P14.2= IF ((KILO LT 1) AND (KILO GT (-1))) ';
-SET &&S_SUBJ10='THEN 0 ELSE (GFARE/KILO); AS ' | '''&GCPK_CUR.EVAL''';

-NEXT;

-IF &&SETF EQ 'RFONCARI' GOTO RDFL;

TABLE FILE AIRCARI2
SUM BASE_FARE 
  COMM_SEG	
  CP_FARE_PD AS 'FARE'
  FARE_BASE1/D20.6CS AS 'GBASE_FARE'
  FARE_TTL1/D20.6CS AS 'GTTL_FARE'	
  INTCNT
  KILO
  MILES	
  LEVEL_DESC
  NAMEC
  NET_COMM
  NET_FARE
  NET_TKT_CNT
  NET_FARE
  NEW_SEG_MILES
  PAID_FARE1/D20.6CS AS 'GFARE'
  TAX_TTL1/D20.6CS AS 'GTTL_TAX'
  TOTAL_FARE
  TOTAL_TAX
  CLASS_CAT
BY AIRLINE_NAME
BY IFLAG
-*BY CLASS_CAT
ON TABLE HOLD AS HOLD2
END
-RUN

-GOTO NORDFL;

-RDFL;
TABLE FILE AIRCARI2
SUM BASE_FARE 
  COMM_SEG	
  CP_FARE_PD AS 'FARE'
  FARE_BASE1/D20.6CS AS 'GBASE_FARE'
  FARE_TTL1/D20.6CS AS 'GTTL_FARE'	
  INTCNT
  KILO
  MILES	
  LEVEL_DESC
  NAMEC
  NET_COMM
  NET_FARE
  NET_TKT_CNT
  NET_FARE
  NEW_SEG_MILES
  PAID_FARE1/D20.6CS AS 'GFARE'
  TAX_TTL1/D20.6CS AS 'GTTL_TAX'
  TOTAL_FARE
  TOTAL_TAX
  IFLAG
BY AIRLINE_NAME
BY CLASS_CAT
ON TABLE HOLD AS HOLD2
END
-RUN

-NORDFL;

TABLE FILE HOLD2
PRINT BASE_FARE COMM_SEG FARE GBASE_FARE GFARE GTTL_FARE GTTL_TAX IFLAG
      INTCNT KILO MILES NET_COMM NET_FARE NET_TKT_CNT NAMEC
      NET_FARE NEW_SEG_MILES TOTAL_FARE TOTAL_TAX LEVEL_DESC CLASS_CAT

BY AIRLINE_NAME
RANKED BY HIGHEST &&RANK_METH NOPRINT
ON TABLE HOLD AS HOLD3 
END
-RUN


DEFINE FILE HOLD3
  DRANK/D5      = RANK ;
  ARANKX/A6     = FTOA(DRANK, '(D5)', 'A6');
  ARANK/A5      = EDIT(ARANKX,'$99999');
  RANK_LIMIT2/I5 = &&RANK_LIMIT2 ;
  RNK_VAL/A5 = IF (RANK_LIMIT2 EQ 0) THEN (ARANK) ELSE
                 IF RANK GT RANK_LIMIT2 THEN 'OTHER' ELSE ARANK;
END




TABLE FILE HOLD3
PRINT BASE_FARE COMM_SEG FARE GBASE_FARE GFARE GTTL_FARE GTTL_TAX IFLAG
      INTCNT KILO MILES NET_COMM NET_FARE NET_TKT_CNT NAMEC
      NET_FARE NEW_SEG_MILES TOTAL_FARE TOTAL_TAX LEVEL_DESC CLASS_CAT


BY AIRLINE_NAME
BY RNK_VAL
ON TABLE HOLD AS HOLD4
END
-RUN


DEFINE FILE HOLD4
AIRLINE_PRINT/A12 = IF RNK_VAL LE '&&RANK_LIMIT2' 
	THEN AIRLINE_NAME ELSE 'OTHER';
END



TABLE FILE HOLD4
SUM BASE_FARE COMM_SEG FARE GBASE_FARE GFARE GTTL_FARE GTTL_TAX IFLAG
      INTCNT KILO MILES NET_COMM NET_FARE NET_TKT_CNT NAMEC
      NET_FARE NEW_SEG_MILES TOTAL_FARE TOTAL_TAX LEVEL_DESC CLASS_CAT
BY AIRLINE_NAME
BY RNK_VAL
BY AIRLINE_PRINT
ON TABLE HOLD AS HOLD5
END
-RUN

TABLE FILE HOLD2
 SUM &&RANK_METH 
BY AIRLINE_NAME
ON TABLE HOLD AS RHOLD1 
END
-RUN
     
     
TABLE FILE RHOLD1
PRINT &&RANK_METH
RANKED BY HIGHEST &&RANK_METH AS 'SEG_RANK'
BY AIRLINE_NAME
ON TABLE HOLD AS RHOLD2
END
-RUN     
     

MATCH FILE HOLD5
PRINT 
  BASE_FARE
  CLASS_CAT
  COMM_SEG	
  FARE 
  GBASE_FARE
  GFARE
  GTTL_FARE
  GTTL_TAX
  IFLAG
  INTCNT
  KILO
  LEVEL_DESC
  MILES	
  NAMEC
  NET_COMM	
  NET_TKT_CNT	
  NEW_SEG_MILES
  RNK_VAL
  TOTAL_FARE
  TOTAL_TAX
  AIRLINE_PRINT
BY AIRLINE_NAME
ON TABLE HOLD
RUN
FILE RHOLD2
SUM SEG_RANK
BY AIRLINE_NAME
AFTER MATCH HOLD AS HOLD6 OLD-AND-NEW
END
-RUN 

TABLE FILE HOLD6
PRINT BASE_FARE	
  CLASS_CAT
  COMM_SEG	
  FARE 
  GBASE_FARE
  GFARE
  GTTL_FARE
  GTTL_TAX
  IFLAG
  INTCNT
  KILO
  LEVEL_DESC
  MILES	
  NAMEC
  NET_COMM	
  NET_TKT_CNT	
  NEW_SEG_MILES
  RNK_VAL
  TOTAL_FARE
  TOTAL_TAX
  AIRLINE_NAME
  AIRLINE_PRINT
RANKED BY HIGHEST SEG_RANK
ON TABLE HOLD AS HOLD7
END
-RUN


DEFINE FILE HOLD7
  ORG_LIMIT/I2 = &&RANK_LIMIT ;
  OLIMIT/A2    = EDIT(ORG_LIMIT) ;
  CRANK/D5     = RANK;
  BRANK/A6     = FTOA(CRANK, '(D5)', 'A6');
  LIST/D6 = IF AIRLINE_NAME NE LAST AIRLINE_NAME THEN (LAST LIST + 1) 
    ELSE LAST LIST;
  FRANKX/A7 = FTOA(LIST, '(D6)', 'A7');
  FRANK/A6  = EDIT(FRANKX,'$999999'); 
  ORG_VALUE/A6 = IF ORG_LIMIT EQ 0 THEN BRANK ELSE
               IF LIST GT ORG_LIMIT THEN 'OTHER' ELSE FRANK;
END

TABLE FILE HOLD7
SUM BASE_FARE
  CLASS_CAT
  COMM_SEG	
  FARE 
  GBASE_FARE
  GFARE
  GTTL_FARE
  GTTL_TAX
  IFLAG
  INTCNT
  KILO
  LEVEL_DESC
  MILES	
  NAMEC
  NET_COMM	
  NET_TKT_CNT	
  NEW_SEG_MILES
  OLIMIT
  RNK_VAL
  TOTAL_FARE
  TOTAL_TAX
  AIRLINE_NAME
  AIRLINE_PRINT
BY ORG_VALUE
BY AIRLINE_NAME
BY RNK_VAL
BY AIRLINE_PRINT
ON TABLE HOLD AS HOLD8
END
-RUN

DEFINE FILE HOLD8
AIRL_PRINT/A12 =IF ORG_VALUE LT OLIMIT THEN AIRLINE_NAME ELSE 'ALL OTHER';
RO_PRINT/A12 =IF ORG_VALUE LT OLIMIT THEN AIRLINE_PRINT ELSE 'ALL OTHER'; 

END

TABLE FILE HOLD8
SUM BASE_FARE	
  CLASS_CAT
  COMM_SEG	
  FARE 
  GBASE_FARE
  GFARE
  GTTL_FARE
  GTTL_TAX
  IFLAG
  INTCNT
  KILO
  LEVEL_DESC
  MILES	
  NAMEC
  NET_COMM	
  NET_TKT_CNT	
  NEW_SEG_MILES
  RNK_VAL
  TOTAL_FARE
  TOTAL_TAX
  AIRLINE_NAME
  AIRLINE_PRINT
BY ORG_VALUE     
BY AIRL_PRINT  
BY RNK_VAL
BY RO_PRINT
ON TABLE HOLD AS HOLD9
END
-RUN




TABLE FILE HOLD9
SUM FARE AS 'TFARE'
  GFARE AS 'GTFARE'
  KILO AS 'TKILO'	
  MILES AS 'TMILES'	
  NET_COMM AS 'TCOM'	
  NET_TKT_CNT AS 'TTKTS'
BY AIRL_PRINT
ON TABLE HOLD AS HOLD10
END
-RUN

MATCH FILE HOLD9
PRINT BASE_FARE	
  CLASS_CAT
  COMM_SEG	
  FARE 
  GBASE_FARE
  GFARE
  GTTL_FARE
  GTTL_TAX
  IFLAG
  INTCNT
  KILO
  LEVEL_DESC
  MILES	
  NAMEC
  NET_COMM	
  NET_TKT_CNT	
  NEW_SEG_MILES
  RNK_VAL
  TOTAL_FARE
  TOTAL_TAX
  AIRLINE_NAME
  AIRLINE_PRINT
  ORG_VALUE
  RNK_VAL
  RO_PRINT
BY AIRL_PRINT
ON TABLE HOLD
RUN
FILE HOLD10
SUM TFARE
    GTFARE
    TKILO
    TMILES
    TCOM
    TTKTS
BY AIRL_PRINT
AFTER MATCH HOLD AS HOLD11 OLD-OR-NEW
END
-RUN

TABLE FILE HOLD11
SUM BASE_FARE	
  CLASS_CAT
  COMM_SEG	
  FARE 
  GBASE_FARE
  GFARE
  GTTL_FARE
  GTTL_TAX
  IFLAG
  INTCNT
  KILO
  LEVEL_DESC
  MILES	
  NAMEC
  NET_COMM	
  NET_TKT_CNT	
  NEW_SEG_MILES
  TOTAL_FARE
  TOTAL_TAX
  AIRLINE_NAME
  AIRLINE_PRINT
  TFARE
  GTFARE
  TKILO
  TMILES
  TCOM
  TTKTS
BY ORG_VALUE
BY AIRL_PRINT
BY RNK_VAL
BY RO_PRINT
ON TABLE HOLD AS HOLD12
END
-RUN
  


DEFINE FILE HOLD12
  PCTFARE/D8.1= IF ((TFARE LT 1) AND (TFARE GT (-1))) THEN 0
                ELSE ((FARE/TFARE)*100);
  PCTTKT/D8.1= IF ((TTKT LT 1) AND (TTKT GT (-1))) THEN 0
               ELSE ((NET_TKT_CNT/TTKT)*100);
  PTMILES/D8.1= IF ((TMILES LT 1) AND (TMILES GT (-1))) THEN 0
                ELSE ((MILES/TMILES)*100);
-**********************************************************************
-*DATE           NAME               DESCRIPTION
-*7/31/00      IBISTL-KR            ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERSM
-**********************************************************************
  NOWTOD/A8 WITH LEVEL_DESC = HHMMSS (NOWTOD);
END

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADER' ELSE 'HDREXLS'; 
-SET &&PASTYS = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE &&SMSTY;
-RUN


TABLE FILE HOLD12
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
    &&S_SUBJ1
    &&S_SUBJ2
    &&S_SUBJ3
    &&S_SUBJ4
    &&S_SUBJ5
    &&S_SUBJ6
    &&S_SUBJ7
    &&S_SUBJ8
    &&S_SUBJ9
    &&S_SUBJ10
    
-*BY
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
-*ON
   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10

-*
-INCLUDE FOOTERSM
-*
-*ON TABLE SET STYLE &&SMSTY

ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
-**********************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**********************************************************************
ON TABLE SET STYLE *
-INCLUDE &&PASTYS

-**********************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/18/00      IBISTL-KR            INCLUDE STYLESHEET PARAMS FOR 
-*                                  DRILLABLE REPORTS.
-**********************************************************************
-IF &&DRILLABLE EQ 'N' GOTO SKIP_DRILL;

-INCLUDE &&DSTY

-SKIP_DRILL

ENDSTYLE



-*
&&OUTLINE1
&&SUMMDEST
&&OUTLINE2
END
-RUN


-IF &&DRILLABLE EQ 'Y' GOTO SKIP_R3;

EX REPORT_3

-SKIP_R3
