-*7/26/16-S-22032-Updated date to be hard coded for transaction date as it was sometimes passing fst_dpt_date. This report is only available to run for transaction date

-INCLUDE SETECHO
SET ASNAMES = ON

-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED
-*========================================================================
-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

DEFINE FILE SR_50

  FARE_PAID/P15.2CS   = SEG_AMT + SEG_TAX;   
  NET_TKT_CNT/P12CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
TRNMY/MTY = TRN_DATE;  
                           
END

TABLEF FILE SR_50
PRINT AIR_KEY	
  FARE_PAID	
  NET_TKT_CNT	
  TRNMY
 WHERE TRN_DATE GE &&FROMDT.EVAL AND TRN_DATE LE &&TODT.EVAL
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10

-INCLUDE RPTPARMS
-IF &&SETF NE 'TCVASUA' GOTO NOUAWHR;
WHERE VAL_AIRLINE EQ 'UA'
-NOUAWHR;
-* ON TABLE HOLD AS &&RPT_HOLD
ON TABLE HOLD AS REPHOLD
END
-RUN

-IF &LINES EQ 0 THEN GOTO NEXTONE;

-INCLUDE tc_sameday_match
-RUN


DEFINE FILE UDHOLD2
SVGS/P12.2CS = STD_FEE - PD_FEE;
END
-RUN
TABLE FILE UDHOLD2
PRINT STD_FEE PD_FEE SVGS VAL_ALN
BY AIR_KEY
ON TABLE HOLD AS UDHOLD3
END
-RUN


TABLE FILE REPHOLD
PRINT 
  FARE_PAID	
  NET_TKT_CNT	
  TRNMY
BY AIR_KEY
ON TABLE HOLD AS REPHLD1
END



JOIN AIR_KEY IN REPHLD1 TO AIR_KEY IN UDHOLD2 AS J1
-RUN

DEFINE FILE REPHLD1
STD_FEE2/P12.2CS = IF AIR_KEY NE LAST AIR_KEY THEN STD_FEE ELSE 0;
PD_FEE2/P12.2CS = IF AIR_KEY NE LAST AIR_KEY THEN PD_FEE ELSE 0;
SVGS2/P12.2CS = IF AIR_KEY NE LAST AIR_KEY THEN SVGS ELSE 0;
END
TABLE FILE REPHLD1
PRINT  AIR_KEY
  FARE_PAID	
  NET_TKT_CNT	
  PD_FEE2 AS 'PD_FEE'
  STD_FEE2 AS 'STD_FEE'
  VAL_ALN
  TRNMY
  SVGS2 AS 'SVGS'
WHERE VAL_ALN NE ' '    
ON TABLE HOLD AS TCSDAY
END
-RUN


DEFINE FILE TCSDAY
ROLLCD/A8 = '&&ROLL';
END
TABLE FILE TCSDAY
SUM FARE_PAID
    NET_TKT_CNT
    PD_FEE
    STD_FEE
    SVGS
BY TRNMY    
BY ROLLCD
ON TABLE HOLD AS TCSD2
END
-RUN

JOIN CLEAR *
-RUN

-* MATCH RECORDS FROM TCDSSEX HOLD FILE
JOIN AIR_KEY IN TCAD2 TO AIR_KEY IN TCUA2 AS J2
-RUN

DEFINE FILE TCAD2
AIR_SCSAV/P12.2 = IF SEG_NBR EQ '01' THEN DSS ELSE 0;
AIR_DSS/P12.2CSM = IF NET_TKT_CNT LT 0 THEN 0 ELSE AIR_SCSAV;
ADSS_CNT/P12S = IF AIR_SCSAV NE 0 THEN NET_TKT_CNT ELSE 0;
NTKTS/P12S = NET_TKT_CNT;
END

TABLE FILE TCAD2
PRINT NET_TKT_CNT
      FARE_PAID
      AIR_DSS
      ADSS_CNT
      NTKTS
      ROLLCD
      TRNMY
BY AIR_KEY
ON TABLE HOLD AS TCAD3
END
-RUN

TABLE FILE TCAD3
SUM AIR_DSS
    ADSS_CNT
BY TRNMY    
BY ROLLCD
ON TABLE HOLD AS TCDSSHLD
END
-RUN

MATCH FILE TCSD2
PRINT FARE_PAID
      NET_TKT_CNT
      PD_FE
      STD_FEE
      SVGS
BY TRNMY      
BY ROLLCD
ON TABLE HOLD
RUN
FILE TCDSSHLD
SUM AIR_DSS
    ADSS_CNT
BY TRNMY 
BY ROLLCD
AFTER MATCH HOLD AS TCSD2X OLD-OR-NEW
END
-RUN


DEFINE FILE TCSD2X
 NMB/I5 = NMB + 1;
END
TABLE FILE TCSD2X
PRINT FARE_PAID
      NET_TKT_CNT 
      STD_FEE
      PD_FEE
      SVGS
      AIR_DSS
      ADSS_CNT 
BY TRNMY      
BY ROLLCD
ON TABLE HOLD AS TCSD3
END
-RUN

MODIFY FILE TC_VSV2M
FIXFORM FROM TCSD3
MATCH TRNMY ROLLCD 
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON TCSD3
END
-RUN

 

-NEXTONE

 


