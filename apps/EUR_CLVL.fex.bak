-* File EUR_CLVL.fex

SET ASNAMES=ON
-*SET TEMPERASE=OFF

CREATE FILE CAR_LVL
-RUN

USE CLEAR *
-RUN 

TABLE FILE CARHOLD
SUM CAR_KEY TKT_NUM LEVEL1 LEVEL2 LEVEL3
BY CAR_KEY NOPRINT
ON TABLE HOLD
END
-RUN


TABLE FILE HOLD
PRINT CAR_KEY TKT_NUM LEVEL1 AS 'LEVEL'
WHERE LEVEL1 NE ' '
ON TABLE HOLD AS LVL1 FORMAT FOCUS INDEX CAR_KEY
END
-RUN


TABLE FILE HOLD
PRINT CAR_KEY TKT_NUM LEVEL2 AS 'LEVEL'
WHERE LEVEL2 NE ' '
ON TABLE HOLD AS LVL2 FORMAT FOCUS INDEX CAR_KEY
END
-RUN

TABLE FILE HOLD
PRINT CAR_KEY TKT_NUM LEVEL3 AS 'LEVEL'
WHERE LEVEL3 NE ' '
ON TABLE HOLD AS LVL3 FORMAT FOCUS INDEX CAR_KEY
END
-RUN



-SET &HLDPATH=TEMPPATH(50,'A50');
-SET &HNKA=&HLDPATH || 'LVL1.FOC';
-SET &HNKB=&HLDPATH || 'LVL2.FOC';
-SET &HNKC=&HLDPATH || 'LVL3.FOC';

 
-SET &FILENAME = 'LVL1'; 
-RUN

-DOS STATE &HNKA
-SET &HOLDFILE1 = IF &RETCODE.EVAL EQ 0 THEN &HNKA | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKB
-SET &HOLDFILE2 = IF &RETCODE.EVAL EQ 0 THEN &HNKB | ' AS ' | &FILENAME ELSE ' ';

-DOS STATE &HNKC
-SET &HOLDFILE3 = IF &RETCODE.EVAL EQ 0 THEN &HNKC | ' AS ' | &FILENAME ELSE ' ';





USE ADD 
&HOLDFILE1
&HOLDFILE2
&HOLDFILE3
END

DEFINE FILE LVL1
LVL/A15 = GETTOK (LEVEL, 15, 1, '*', 15, LVL);
PCT/A15 = GETTOK (LEVEL, 15, -1, '*', 15, PCT);
END

TABLE FILE LVL1
PRINT CAR_KEY TKT_NUM LEVEL LVL AS 'LEVEL05' PCT LVL 
BY LEVEL NOPRINT
ON TABLE HOLD AS CLDATA
END
-RUN

-SET &CRCNT = &LINES;

TABLE FILE CR_HIER
PRINT LEVEL05 LEVEL04 LEVEL03  
BY LEVEL05 NOPRINT
WHERE ROLLUP EQ 'EURA-R'
ON TABLE HOLD AS LDATAC
END
-RUN


MATCH FILE CLDATA
PRINT TKT_NUM LEVEL PCT CAR_KEY LVL
BY LEVEL05 NOPRINT
RUN
FILE LDATAC
SUM LEVEL03 LEVEL04 LEVEL05
BY LEVEL05 NOPRINT
AFTER MATCH HOLD AS MATCHC OLD 
END
-RUN



TABLE FILE MATCHC
PRINT CAR_KEY TKT_NUM LEVEL PCT LVL LEVEL03 LEVEL04 LEVEL05 
BY CAR_KEY NOPRINT
BY TKT_NUM NOPRINT
BY LEVEL NOPRINT
WHERE LEVEL03 NE ' '
ON TABLE HOLD AS CLVLDATA 
END
-RUN

-SET &CM1 = IF &LINES EQ '&CRCNT.EVAL' THEN 'Y' ELSE 'N';



MODIFY FILE CAR_LVL
FIXFORM FROM CLVLDATA
MATCH CAR_KEY TKT_NUM LEVEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON CLVLDATA
END
-RUN


 

-IF &CM1 EQ 'Y' THEN GOTO ALLMATCHC;

-* Match to CR_HIER by level04

TABLE FILE CR_HIER
PRINT LEVEL05 LEVEL04 LEVEL03  
BY LEVEL04 NOPRINT
WHERE ROLLUP EQ 'EURA-R'
ON TABLE HOLD AS LDCATAC2
END
-RUN

TABLE FILE MATCHC
PRINT CAR_KEY TKT_NUM LEVEL LVL AS 'LEVEL04' PCT LVL
BY LEVEL NOPRINT
WHERE LEVEL03 EQ ' '
ON TABLE HOLD AS CLDATA2
END
-RUN


MATCH FILE CLDATA2
PRINT CAR_KEY TKT_NUM LEVEL PCT LVL
BY LEVEL04
RUN
FILE LDCATAC2
SUM LEVEL05 LEVEL04 LEVEL03
BY LEVEL04
AFTER MATCH HOLD AS MATCHC2 OLD-AND-NEW
END
-RUN

-IF &LINES EQ 0 THEN GOTO LEVEL03;


TABLE FILE MATCHC2
PRINT PCT LEVEL03 LEVEL04 LEVEL05 
BY CAR_KEY
BY TKT_NUM
BY LEVEL 
WHERE LEVEL04 NE ' '
ON TABLE HOLD AS CLVLDATA2 
END
-RUN


MODIFY FILE CAR_LVL
FIXFORM FROM CLVLDATA2
MATCH CAR_KEY TKT_NUM LEVEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON CLVLDATA2
END
-RUN

-LEVEL03

 

-* Match to CR_HIER by level03

TABLE FILE CR_HIER
PRINT LEVEL05 LEVEL04 LEVEL03  
BY LEVEL03 NOPRINT
WHERE ROLLUP EQ 'EURA-R'
ON TABLE HOLD AS LDATAC3
END
-RUN

TABLE FILE MATCHC 
PRINT CAR_KEY TKT_NUM LEVEL LVL AS 'LEVEL03' PCT LVL
BY LEVEL NOPRINT
WHERE LEVEL04 EQ ' '
ON TABLE HOLD AS CLDATA3
END
-RUN

MATCH FILE CLDATA3
PRINT CAR_KEY TKT_NUM LEVEL PCT LVL
BY LEVEL03
RUN
FILE LDATAC3
SUM LEVEL05 LEVEL04 LEVEL03
BY LEVEL03
AFTER MATCH HOLD AS MATCHC3 OLD-AND-NEW
END
-RUN


TABLE FILE MATCHC3
PRINT PCT LEVEL03 LEVEL04 LEVEL05 
BY CAR_KEY
BY TKT_NUM
BY LEVEL 
ON TABLE HOLD AS CLVLDATA3 
END
-RUN


MODIFY FILE CAR_LVL
FIXFORM FROM CLVLDATA3
MATCH CAR_KEY TKT_NUM LEVEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON CLVLDATA3
END
-RUN


-ALLMATCHC
 
