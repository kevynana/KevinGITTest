-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File AVI136EX.FEX
-********************************************************************
-* MODIFICAIONS:
-********************************************************************
-*
-* This program extracts data for taxaction trasnaction reports 
-* for ALL-R
-*
-* ADDED TRANTYPE INCLUDE - JK 12/9/14 STORY ID S-06492
-*12/28/15 - JEM - S-13286 Updated to allow reports to sort/subtotal by id-levels


-********************************************************************

SET ASNAMES = ON
-SET HOLDATTR = ON;

-SET &&IDLEVELBREAK = '';


-INCLUDE SETECHO

-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

-INCLUDE IDLEVROLLDEF
-RUN


DEFINE FILE &&EXTRACT

  FARE_PAID/D12.2=SEG_AMT + SEG_TAX;
  LEVEL_DESC1/A80 = &&LDESC;
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                             (SEG_NBR EQ '01') AND
                             (FARE_PAID GE 0) AND
                             (SEG_COUNT EQ 1) AND 
                             (CONJ_REL EQ 1) THEN 1 ELSE 
                          IF (TICKET_CODE EQ '1') AND
                             (SEG_NBR EQ '01') AND 
                             (EX_FLAG EQ 'F') THEN (-1) ELSE 
                          IF (TICKET_CODE EQ '1') AND
                             (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
   NET_TKT_CNT1/D9 =   IF (SEG_NBR EQ '01') AND (FARE_PAID GE 0) AND 
                         (SEG_COUNT EQ 1) AND (EXCHG_SALE EQ ' ') THEN 1 ELSE 
                        IF (DOC_TYPE EQ '1') AND
                        (EX_FLAG EQ ' ') AND 
                        (EXCHG_SALE NE ' ') THEN 1 ELSE 0;
  TKT_CNT/D9CS        = IF (SEG_NBR EQ '01') AND 
                           (FARE_PAID GE 0) AND 
                           (SEG_COUNT EQ 1) THEN 1 ELSE 0;                         
  TKT_TYPE/A4         = IF (SEG_COUNT LE 0) AND
                           (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                           (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                           (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                           (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  TRAN_MYA/I6MTYY = TRN_DATE;
  VOIDS/D9CS          = IF (VOID_DATE NE 0) AND
                           (SEG_COUNT EQ 1) AND
                           (SEG_NBR EQ '01') THEN 1 ELSE
                        IF (DOC_TYPE EQ '1') AND 
                           (VOID_DATE NE 0) THEN 1 ELSE 0;
                         
  XDPT_DT/MDYY=DPT_DATE;
  XFST_DPT/MDYY = FST_DPT_DATE;
  XPSNGR_NM/A15=EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY=TRN_DATE;
  LVL3/A13 = EDIT(AROLL_LEV3, '999');
  QUAL/A1 = EDIT(LEVEL3, '9');
-* ******* DEFINES ON PREVIOUS DEFINES ******

EXCHGS/D9 = IF (EX_FLAG EQ 'F' OR 'P') AND (SEG_COUNT LE 0) AND (EMBARK 
  NE 'DT1' OR 'RF1' OR 'FP3') THEN TKT_CNT ELSE
  IF (DOC_TYPE EQ '1') AND (EXCHG_SALE EQ 'E') THEN 0 ELSE
  IF (SEG_COUNT GE 0) AND (EXCHG_SALE NE ' ') THEN TKT_CNT ELSE 0;

-****** Start of Defines for the New Principal Transaction Summary
-* Determine number of segments ticket has
SEG_FLAG/A1 = EDIT(TKT_MAIN.C_ITIN, '$$$$$$$$$$$9');
-INCLUDE TRANTYPE
-INCLUDE IDLEVDEFINE 

END


TABLE FILE &&EXTRACT
PRINT   
  AIR_MAIN.INTL_DOM AS 'INT_DOM'
  AGENT_NUM 
  AIR_KEY	
  AIRLINE
  AROLL_LEV3
  BR_CL_IDX
  C_ITIN
  CITYPAIR.EMBARK      AS 'EMB_APT_CD'	
  CITYPAIR.ROUTE       AS 'RTE_APT_CD'	
  CLASS	
  CLIENT_NUM
  CLIENT_NAME
  DOC_TYPE	
  DOD_TYPE
  DPT_DATE	
  DPT_TIME
  DST_APC
  DST_APCX
  EMBARK	
  EX_FLAG	
  EXCHG_SALE
  EXCHGS
  FARE_PAID	
  FLIGHT  
  INT_CODE
  INVOICE_NUM	
  LEVEL1	
  LEVEL2	
  LEVEL3
  LEVEL4
  LEVEL_DESC
  LVL3 
  NET_TKT_CNT
  NET_TKT_CNT1  
  ORG_APC
  ORG_APCX
  PASSNGR_NAME
  PNR_LOCATOR
  QUAL
  REFUSE_KEY	
  RESV_BRANCH	
  RF_FLAG
  SEG_AMT	
  SEG_COM	
  SEG_COUNT
  SEG_NBR 	
  SEG_TAX 
  TICKET_BRANCH
  TKT_DATE	
  TKT_NUM
  TKT_SORT
  TKT_TYPE
  TRAN_MYA
  TRN_DATE
  VAL_AIRLINE
  XDPT_DT
  XFST_DPT
  XPSNGR_NM
  XTRAN_DT
 
WHERE VOID_DATE EQ 0 
-INCLUDE &AIRDATES
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS

ON TABLE HOLD AS AIRTRANS
END
-RUN

 