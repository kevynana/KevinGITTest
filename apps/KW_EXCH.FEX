-* File KW_EXCH
-* 5/23/14 - DEB - UPDATED EX_RF_FLAG TO INCLUDE EX5
 -* ADDED TRANTYPE INCLUDE - JK 12/29/14 STORY ID S-06492
-*02/22/17 - DLV - S-30939  ADDED &&WHERE1  to RPTHOLD extract
 
-INCLUDE SETECHO

SET ASNAMES=ON
SET SPACE=1

-* Obtain EXR UDID records

-TYPE &&UDIDUSED


 



-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';

DEFINE FILE SR_50
  FARE_PAID/D15.2  = SEG_AMT + SEG_TAX;

  



  IFLAG/A1 = IF DOD_TYPE EQ 'H' OR 'I' OR 'J' THEN 'I' ELSE 'N';
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND
                           (CONJ_REL EQ 1) THEN 1 ELSE
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (EX_FLAG EQ 'F') THEN (-1) ELSE
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  MXADV/A8  = IF (ADV_PURCH LT 7) THEN '00 - 06' ELSE
              IF (ADV_PURCH LT 14) THEN '07 - 13' ELSE '14 +';              
  NON_FLAG/A15 = IF NONREF_FLAG EQ 'N' THEN 'NON-REFUNDABLE' ELSE 
                                            'REFUNDABLE';
  TKT_TYPE/A4         = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  XDPT_DT/MDYY         = DPT_DATE;
  XTRAN_DT/MDYY        = TRN_DATE;
  MONTH/MT = TRN_DATE;
  LSTSVNGS/P12.2C    = IF EMBARK EQ 'DT1' THEN 0 ELSE
                          FARE_PAID - SEG_LOWEST;
 
   XPSNGR_NM/A15        = 
  EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
 
 EX_RF_FLAG/A1 = IF VOID_DATE NE 0 
  THEN ' '
  ELSE IF (((RF_FLAG EQ 'F' OR 'P') AND
    (EMBARK NE 'EX1' OR 'FP2' OR 'EX5') AND (SEG_COUNT LE 0)) OR (EMBARK EQ 'RF1'))
  THEN 'R'
  ELSE IF (((EXSALE NE ' ') AND (SEG_COUNT GE 0)) OR
-*     ((EMBARK NE 'DT1') AND (EX_FLAG EQ 'F' OR 'P') AND 
       ((EX_FLAG EQ 'F' OR 'P') AND
    (SEG_COUNT LE 0) AND (RF_FLAG EQ ' ')))
  THEN 'E'
  ELSE ' ';
  
SALES_FLAG/A1 = IF RF_FLAG EQ ' ' AND EX_FLAG EQ ' '  AND VOID_DATE EQ 0
  THEN 'S' 
  ELSE IF RF_FLAG EQ ' ' AND EX_FLAG EQ ' '  AND VOID_DATE NE 0
  THEN 'V' ELSE ' ';
LEVEL_DESC/A60 = &&LDESC;
  AIRLINE_FEE/D8.2CS = IF EMBARK EQ 'FP2' OR 'FP3' THEN FARE_PAID ELSE 0;
-INCLUDE TRANTYPE  
END
-RUN
 
TABLEF FILE SR_50
PRINT
  AIR_KEY
  AIRLINE
  AIRLINE_FEE
  ADV_PURCH
  C_ITIN
  DOC_NUMBER
  DOC_TYPE
  EMB_APT.AIRPORT_NAME AS 'EMB_APT_NM'
  EMB_CTY.CITY_NAME    AS 'EMB_CTY_NM'
  EXCHG_SALE
  FARE_PAID
  FARE_BAS
  IFLAG
  LSTSVNGS
  NET_TKT_CNT
  NON_FLAG
  MXADV
  PASSNGR_NAME
  PNR_LOCATOR
  REFUSE_CODE
  RTE_APT.AIRPORT_NAME AS 'RTE_APT_NM'
  RTE_CTY.CITY_NAME    AS 'RTE_CTY_NM'	
  SEG_LOWEST
  TKT_DATE
  TKT_NUM
  TKT_TYPE
  TRN_DATE
  DPT_TIME
  XDPT_DT
  XTRAN_DT
  XPSNGR_NM
  MONTH
  TKT_SORT
  SEG_NBR
  TKT_DATE
  LEVEL_DESC
  ROLLUP_CODE
  VAL_AIRLINE
-***************************************************************
-* Where statements to select data specified in user profile
-***************************************************************
 
 
-INCLUDE &AIRDATES
WHERE VOID_DATE EQ 0 
-INCLUDE RPTPARMS
WHERE EXSALE NE ' '
&&WHERE1

ON TABLE HOLD AS RPTHOLD
END
-RUN 
 
TABLE FILE RPTHOLD
PRINT
  AIRLINE
  AIRLINE_FEE
  ADV_PURCH
  C_ITIN
  DOC_NUMBER
  DOC_TYPE
  EMB_APT_NM
  EMB_CTY_NM
  EXCHG_SALE
  FARE_PAID
  FARE_BAS
  IFLAG
  LSTSVNGS
  NET_TKT_CNT
  NON_FLAG
  MXADV
  PASSNGR_NAME
  PNR_LOCATOR
  REFUSE_CODE
  RTE_APT_NM
  RTE_CTY_NM	
  SEG_LOWEST
  TKT_DATE
  TKT_NUM
  TKT_TYPE
  TRN_DATE
  DPT_TIME
  XDPT_DT
  XTRAN_DT
  XPSNGR_NM
  MONTH
  TKT_SORT
  SEG_NBR
  TKT_DATE
  LEVEL_DESC
  ROLLUP_CODE
  VAL_AIRLINE
BY AIR_KEY
ON TABLE HOLD AS HOLD1
END
-RUN
-* OBTAIN exr udid records

 

TABLE FILE ROLLUP
PRINT COMP
IF ROLLUP EQ '&&ROLLUP.EVAL'
ON TABLE HOLD AS ROLLHOLD
END
-RUN

-READ ROLLHOLD &&COMP.A6
-SET &&COMPNY = &&COMP.EVAL;
 
-SET &&COMPUA = 'D:\TNT\TTRACKER\DATA\UA'|| '&&COMPNY.EVAL' ||'.FOC';
-RUN


 


USE CLEAR *
USE 
&&COMPUA AS UDAIR
D:\TNT\TTRACKER\SYSTEM\DATA\UDID_DSC.FOC AS UDID_DSC
END

 
TABLE FILE UDAIR
PRINT AUD_DATA AS 'REASON'
BY AIR_KEY
IF UDID EQ EXR
ON TABLE HOLD AS UDIDHOLD2 FORMAT FOCUS INDEX AIR_KEY
END
-RUN



DEFINE FILE UDID_DSC
XL01/A4 = EDIT(UDID_ALPHA, '9999');
UDIDA/A4 = XL01;
END
TABLE FILE UDID_DSC
PRINT UD_DESC UDID_ALPHA 
BY UDIDA
WHERE UDID_ID EQ 'EXR'
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
ON TABLE HOLD AS DESCUDID FORMAT FOCUS INDEX UDIDA
END
-RUN
 

JOIN AIR_KEY IN HOLD1 TO AIR_KEY IN UDIDHOLD2 AS J1
-RUN


DEFINE FILE HOLD1
EX_RSN/A64 = REASON;
EXRSN/A4 = EDIT(EX_RSN, '9999');
END
TABLE FILE HOLD1
PRINT  AIR_KEY
  AIRLINE
  AIRLINE_FEE
  ADV_PURCH
  C_ITIN
  DOC_NUMBER
  DOC_TYPE
   EMB_APT_NM 
  EMB_CTY_NM 
  EXCHG_SALE
  FARE_PAID
  FARE_BAS
  IFLAG
  LSTSVNGS
  NET_TKT_CNT
  NON_FLAG
  MXADV
  PASSNGR_NAME
  PNR_LOCATOR
  REFUSE_CODE
   RTE_APT_NM 
   RTE_CTY_NM 	
  SEG_LOWEST
  TKT_DATE 
  TKT_NUM
  TKT_TYPE
  TRN_DATE
  DPT_TIME
  XDPT_DT
  XTRAN_DT
  XPSNGR_NM
  MONTH
  TKT_SORT
  SEG_NBR
  TKT_DATE
  LEVEL_DESC
  ROLLUP_CODE
  VAL_AIRLINE
BY EXRSN
WHERE EXR NE ' '
ON TABLE HOLD AS AIRHOLD4
END
-RUN




JOIN AIRHOLD4.EXRSN IN AIRHOLD4 TO DESCUDID.UDIDA IN DESCUDID AS J2

DEFINE FILE AIRHOLD4
EX_RSN_DSC/A53 = EDIT(UD_DESC, '99999999999999999999999999999999999999999999999999999');
EXRSN_DSC/A53 = IF EX_RSN_DSC EQ ' ' THEN 'NONE GIVEN' ELSE EX_RSN_DSC;
EXRSNDSC/A42 = EDIT(EXRSN_DSC, '99999999999999999999999999999999');
END
TABLE FILE AIRHOLD4
PRINT    AIR_KEY
  AIRLINE
  AIRLINE_FEE
  ADV_PURCH
  C_ITIN
  DOC_NUMBER
  DOC_TYPE
   EMB_APT_NM 
  EMB_CTY_NM 
  EXCHG_SALE
  FARE_PAID
  FARE_BAS
  IFLAG
  LSTSVNGS
  NET_TKT_CNT
  NON_FLAG
  MXADV
  PASSNGR_NAME
  PNR_LOCATOR
  REFUSE_CODE
   RTE_APT_NM 
   RTE_CTY_NM 	
  SEG_LOWEST
  TKT_DATE
  TKT_NUM
  TKT_TYPE
  TRN_DATE
  DPT_TIME
  XDPT_DT
  XTRAN_DT
  XPSNGR_NM
  MONTH
  TKT_SORT
  SEG_NBR
  TKT_DATE
  LEVEL_DESC
  ROLLUP_CODE
  EXRSN
  EXRSN_DSC
  EXRSNDSC
  VAL_AIRLINE
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS FINALHLD
-RUN
 




TABLE FILE FINALHLD
-*PRINT PASSNGR_NAME AS 'PAXNAMA'
SUM PASSNGR_NAME AS 'PAXNAMA'
 
PNR_LOCATOR AS 'PNRA'
TKT_DATE AS 'DATEA'
C_ITIN AS 'ITINA'
REFUSE_CODE AS 'CODEA'
TKT_NUM AS 'TICKETA'
DOC_NUMBER AS 'TICKET1'
EXCHG_SALE AS 'EXSALEA'
VAL_AIRLINE AS 'VALAIRA'
EXRSN
EXRSN_DSC
-*WHERE EXCHG_SALE NE ' '
 
-*WHERE DOC_TYPE NE '1'
BY EXRSN NOPRINT
BY PASSNGR_NAME NOPRINT
BY PNR_LOCATOR NOPRINT
BY TKT_NUM NOPRINT 
 
BY DOC_NUMBER NOPRINT
ON TABLE HOLD AS EHOLD1A
END
-RUN





TABLE  FILE EHOLD1A
PRINT PAXNAMA
TICKETA
PNRA
DATEA
ITINA
CODEA
EXSALEA
VALAIRA
TICKET1
EXRSN
EXRSN_DSC
BY EXRSN NOPRINT
BY PAXNAMA NOPRINT
BY TICKET1 NOPRINT
ON TABLE HOLD AS EHOLD1B
END
-RUN
 

-* Update temporary reporting database (UDEXCHR)

CREATE FILE UDEXCHR
END
-RUN


-INCLUDE GetOldTicket
-RUN
 
 
-SET &&NOEXCHREC = IF &LINES EQ 0 THEN 'Y' ELSE 'N';

-IF &&NOEXCHREC EQ 'Y' THEN GOTO XXITA;


TABLE FILE FINALHLD
SUM EXRSN AS 'OEXRSN' EXRSN_DSC AS 'OEXRNSDSC' FARE_PAID AS 'EXR_FARE'
BY EXRSN
BY PASSNGR_NAME
BY TKT_NUM
WHERE EXRSN NE ' '
WHERE FARE_PAID NE 0
WHERE EXCHG_SALE NE ' '
ON TABLE HOLD AS FIXRSN
END
-RUN

 
MATCH FILE MATCHD1
PRINT TKT_NUM OTKT_NUM OTKT_NUM2 ITIN COUNTR PAXNAM DATE EXSALE VAL_AIRLINE FARE NFARE ADV_PURCH DOC_TYPE
      CODE   EPENALTY  EXRSN EXRSN_DSC DPT_DATE DPT_TIME ARR_DATE ARR_TIME
BY TKT_NUM  
ON TABLE HOLD
RUN
FILE FIXRSN
SUM  OEXRSN OEXRNSDSC EXR_FARE
BY TKT_NUM
AFTER MATCH HOLD AS MATCHD2 OLD
END
-RUN


-* Final Defines

DEFINE FILE MATCHD2
-* Steve - changed definition of OFARE below to always be NFARE - August 19, 2009
-* OFARE/D7.2 = IF EXSALE EQ ' ' THEN FARE ELSE IF NFARE EQ 0 AND EPENALTY NE 0 THEN EPENALTY ELSE NFARE;
OFARE/D7.2 = IF EXSALE EQ ' ' THEN FARE ELSE NFARE;
FITIN/A67 = IF DOC_TYPE EQ '1' THEN 'Miscellaneous Charge Order (MCO)' ELSE ITIN;
NTKT/A25 = IF OTKT_NUM EQ OTKT_NUM2 THEN OTKT_NUM ELSE 
           IF OTKT_NUM2 EQ ' ' THEN OTKT_NUM ELSE OTKT_NUM|' and '|OTKT_NUM2;
-*EXRSN2/A4 = IF TKT_NUM NE ' ' AND NTKT EQ ' ' AND FITIN OMITS 'MCO' THEN EXRSN ELSE ' ';           
-*EXRSNDSC2/A53 = IF TKT_NUM NE ' ' AND NTKT EQ ' '  AND FITIN OMITS 'MCO' THEN EXRSN_DSC ELSE ' ';

EXRSN2/A4 = IF EXSALE EQ 'A' THEN EXRSN ELSE ' ';           
EXRSNDSC2/A53 = IF EXSALE EQ 'A' THEN  EXRSN_DSC ELSE ' ';

FLAG/A1 = ' ';
FARE2/D12.2CS = IF EXSALE EQ 'A' THEN EXR_FARE ELSE 0;
FARE3/D12.2C = IF NTKT EQ ' ' THEN (FARE + EPENALTY) ELSE 0;
 
NOWTOD/A8 WITH TKT_NUM = HHMMSS (NOWTOD);
-INCLUDE STDTIME
END
-SET &&RPTSUF = 'DTL';

-INCLUDE FDEFRPTS 

 

-GOTO DEB;
TABLE FILE MATCHD2
PRINT EXRSN 
      PAXNAM
      TKT_NUM
      OEXRSN
      OEXRNSDSC
      EXR_FARE
BY EXRSN   NOPRINT
BY PAXNAM  NOPRINT
BY FLAG NOPRINT 
BY DATE NOPRINT
BY TKT_NUM NOPRINT
IF OEXRSN NE ' ' 

  ON EXRSN RECOMPUTE    EXR_FARE AS 'Total for'
ON TABLE SET ONLINE-FMT EXL2K
END
-RUN
-QUIT
-DEB

TABLE FILE MATCHD2
-INCLUDE HEADEX
" "
PRINT  PAXNAM/A20 AS 'Passenger,Name' 
DATE AS 'Tran,Date' 
TKT_NUM AS 'Original,Ticket' 
NTKT AS 'New Ticket(s)' CODE AS 'Rsn,Cde'
VAL_AIRLINE AS 'Airline' 
FITIN AS 'Itinerary'
DPT_DATE/MDY AS 'Depart,Date' 
TIME_DPT AS 'Depart,Time' 
ARR_DATE/MDY AS 'Return,Date' 
TIME_ARR AS 'Return,Time' 
ADV_PURCH AS 'Adv,Purch' 
FARE/D12.2 AS 'Ticket,Price' 
EPENALTY/D12.2 AS 'Forfeit/,Penalty,Amount' 
OFARE/D12.2 AS 'Out of, Pocket,Expense'
EXR_FARE/D12.2CS AS 'EXR Ticket Amount'
-*EXRSN  AS 'Exchange,Reason' EXRSN_DSC AS 'Exchange,Reason,Description'
OEXRSN  AS 'Exchange Reason'
OEXRNSDSC AS 'Exchange,Reason,Description'
 


BY EXRSN  NOPRINT
BY COUNTR NOPRINT  

BY FLAG NOPRINT 
BY DATE NOPRINT
BY TKT_NUM NOPRINT
 

-*BY OEXRSN  AS 'Exchange Reason'
-*BY OEXRNSDSC AS 'Exchange,Reason,Description'
WHERE EXRSN NE ' '
ON COUNTR SKIP-LINE
ON FLAG RECOMPUTE  AS 'Totals'
ON EXRSN RECOMPUTE  EPENALTY OFARE  EXR_FARE AS 'Total for'
ON FLAG RECOMPUTE   EPENALTY OFARE   AS 'Total for'
 
ON TABLE SET PAGE-NUM OFF
ON TABLE COLUMN-TOTAL
ON TABLE PCHOLD FORMAT EXL2K 
ON TABLE SET HTMLCSS ON
 



-INCLUDE FOOTERDT
-*ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT
ON TABLE SET STYLE *
UNITS=IN, PAGESIZE='Letter', LEFTMARGIN=0.250000, RIGHTMARGIN=0.250000, 
    TOPMARGIN=0.500000, BOTTOMMARGIN=0.250000, SQUEEZE=ON, 
    ORIENTATION=LANDSCAPE, $
TYPE=REPORT, FONT=TIMES NEW ROMAN, SIZE=6, BACKCOLOR=NONE, STYLE=NORMAL, $
TYPE=HEADING, SIZE=8, STYLE=BOLD, FONT='ARIAL', COLOR=RGB(31 114 164), BACKCOLOR=NONE, $
 
TYPE=REPORT, COLUMN=N6, WRAP= 1.5,     $
TYPE=REPORT, COLUMN=N7, WRAP= 1.0,     $
TYPE=REPORT, COLUMN=N8, WRAP= 1.5,     $

TYPE=REPORT, COLUMN=N9, WRAP= 1.5,     $
TYPE=REPORT, COLUMN=N10, WRAP= 1.0,     $
TYPE=REPORT, COLUMN=N11,  WRAP= 1.0, $

TYPE=REPORT, COLUMN=N12, WRAP= 2.0,     $


TYPE=REPORT, COLUMN=N13, WRAP= .75,     $
TYPE=REPORT, COLUMN=N14, WRAP= .75,     $ 
TYPE=REPORT, COLUMN=N15, WRAP= .75,     $
TYPE=REPORT, COLUMN=N16, WRAP= .75, $     
TYPE=REPORT, COLUMN=N17, WRAP= .50, $     
TYPE=REPORT, COLUMN=N16, WRAP= 1.0, $     
TYPE=REPORT, COLUMN=N16, WRAP= 1.0, $     
TYPE=REPORT, COLUMN=N17, WRAP= 1.0, $     
TYPE=REPORT, COLUMN=N18, WRAP= 2.0, $     


TYPE=TITLE,
     BORDER-TOP=LIGHT,
     BORDER-BOTTOM=LIGHT,
     BORDER-LEFT=LIGHT,
     BORDER-RIGHT=LIGHT,
     BORDER-TOP-STYLE=RIDGE,
     BORDER-BOTTOM-STYLE=RIDGE,
     BORDER-LEFT-STYLE=RIDGE,
     BORDER-RIGHT-STYLE=RIDGE,
     BORDER-TOP-COLOR='SILVER',
     BORDER-BOTTOM-COLOR='SILVER',
     BORDER-LEFT-COLOR='SILVER',
     BORDER-RIGHT-COLOR='SILVER',
     SIZE=8,
     COLOR='WHITE',
     BACKCOLOR=RGB(31 114 164),
     STYLE=BOLD,$
      FONT='ARIAL',$



TYPE=FOOTING, SIZE=7, STYLE=BOLD, COLOR=GREY, $
TYPE=TITLE, STYLE=BOLD, $
TYPE=SUBTOTAL, SIZE=7, STYLE=BOLD, $
TYPE=GRANDTOTAL, SIZE=7, STYLE=BOLD, $
-*TYPE=REPORT, IMAGE=&&TNTPIC,  POSITION=(&&TNTDTPOS), SIZE=(&&TNTDTSIZ), $
-*TYPE=REPORT, IMAGE=&&ROLLPIC, POSITION=(&&ROLDTPOS), SIZE=(&&ROLDTSIZ), $
ENDSTYLE
 

-*
&&OUTLINE1
&&OUTPUTDEST
&&OUTLINE2
END
-RUN
 
 
 
 
 


-XXITA
 