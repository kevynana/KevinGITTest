-* JK added code to select only tnt_company eq 1 or 2 2/21/05
-* DV added TOTAL_SLSAV 5/29/07
-* JK Added NBR_DAYS/NBR_ROOMS 2/21/08
-* Joy Updated Pref_Non define to contain C/P/N/M/L
-* Joy Added new layon fields
-* Joy Added Geo_zone and prop country 
-* Joy Joined to Geo file to get descriptions
-* 9/9/14 Updated Pref_non define to use exclude_flags - jk
-*11/3/15 - S-11911 - DLV - Added CURRQ YEAR 
-*                     REMOVED MAINTAIN CODE and added MODIFY 
-*11/19/16 - DLV - S-26101 - Changed to obtain GEO_ZONE based on PROP_CNTRY
-*                           instead of GEO_ZONE based in CITY file
-*1/13/17 JEM S-28998 Added logic for new report TCTHLNGS

-INCLUDE SETECHO

SET ASNAMES = ON
-*========================================================================
-*           PERFORM DATA EXTRACT FOR CLIENT DETERMINED 
-*========================================================================

-SET &&EXTRACT = 'HR_50';

-SET &HTLDATES = &&WEB_PATH || 'HTLDATES.fex';



DEFINE FILE &&EXTRACT
  INT_FLAG/A1 = IF CITY.INTL_DOM EQ 'I' THEN 'Y' ELSE 'N';
  BOOKINGS/D8 = IF TOTAL_AMT GE 0 THEN 1 ELSE (-1);
-*   CHN_GRP/A30 = GCHN_NAME;
CHAIN_GRP/A3 = CHAIN_GROUP;

-IF '&&SETF.EVAL' NE 'TCTPHTL1' OR 'TCTPHTLA' GOTO TCNXT;
  CITY_ST/A35 = CITY.CITY_NAME||(' '| CITY.STATE_CODE);
-GOTO NXSKP
-TCNXT;
  CITY_ST/A35 = PROP_CITY||(' '| PROP_STATE);
-NXSKP  
  NBR_DAYS/D12 =  NUM_DAYS; 
  NBR_ROOMS/D12 = NUM_ROOMS;
  NNROOMS/D12 = IF (NBR_DAYS LT 0) AND (NUM_ROOMS LT 0)
                THEN ((NBR_DAYS*NUM_ROOMS)*(-1))
                ELSE NBR_DAYS*NUM_ROOMS;
  PROP_ZIP5/A5=EDIT(PROP_ZIP, '99999$$$$$');
  NEW_STD_RATE/D14.2C = STD_RATE;

  TOTAL_STD/D12.2C = IF ((NNROOMS LT 0) AND (NEW_STD_RATE LT 0))
                        THEN ((NNROOMS * NEW_STD_RATE) * (-1))
                        ELSE NNROOMS * NEW_STD_RATE;
  NEW_TOTAL_AMT/D14.2C = TOTAL_AMT;
  TOTAL_SLSAV/D12.2C = TOTAL_STD - NEW_TOTAL_AMT;
   PNP_FLAG/A1 = EDIT(EXCLUDE_FLAGS, '$9');
   PNP_IE/A1 = EDIT(EXCLUDE_FLAGS, '$$9');
-*  PREF_NON/A15 = IF CLIENT_PREF EQ 'C' OR 'P' OR 'N' OR 'M' OR 'L' THEN 'PREFERRED' ELSE 'NON-PREFERRED';
  PREF_NON/A15 = IF PNP_FLAG EQ 'I'  THEN 'PREFERRED' ELSE 'NON-PREFERRED';

  MIR_SEQ1/A1 = EDIT(MIR_SEQ, '9$$$$$');
  RES_SYS/A1 = IF MIR_SEQ1 EQ 'X' THEN 'S' ELSE 'A';
  PROP_CODE1/A7 = IF RES_SYS EQ 'S' THEN PROP_SABRE_CODE ELSE PROP_APOLLO_CODE;
  GZONEA/A3 = IF CITY_ST CONTAINS 'UNKNOWN' THEN 'USA' ELSE
              IF GEO_ZONE EQ ' ' THEN 'USA' ELSE CITY.GEO_ZONE;
CURRM/Mt = CHKIN_DATE;              
CURRQ/Q = CHKIN_DATE;
YEAR/YY = CHKIN_DATE;

-* CODE ADDED FOR NEW REPORT TCTHLNGS which shows month/quarter/year total_amt
FDATE/YYMD=&&FROMDT.EVAL;
 EDATE/YYMD=&&TODT.EVAL;
 BOM_DATE/YYMD=DATEMOV(EDATE,'BOM');
 EOM_DATE/YYMD=DATEMOV(EDATE,'EOM');
 BOQ_DATE/YYMD=DATEMOV(EDATE,'BOQ');
 EOQ_DATE/YYMD=DATEMOV(EDATE,'EOQ'); 
 ANNUAL_BEGIN1/MDYY=DATEMOV(DATEADD(BOM_DATE, 'M', (-11)), 'BOM');

 
-* MONTH 
  MD/A1 = IF (INVOICE_DATE GE &&FROMDT.EVAL) AND (INVOICE_DATE LE &&TODT.EVAL) THEN 'Y' ELSE 'N';
  
  MD_AMT/D14.2C = IF MD EQ 'Y' THEN NEW_TOTAL_AMT ELSE 0;
  MD_BOOK/D8 = IF MD EQ 'Y' THEN BOOKINGS ELSE 0;
  MD_NNROOMS/D12 = IF MD EQ 'Y' THEN NNROOMS ELSE 0;
  
-* QUARTER

  QD/A1 = IF (INVOICE_DATE GE BOQ_DATE) AND (INVOICE_DATE LE EOQ_DATE) THEN 'Y' ELSE 'N';
  
  QD_AMT/D14.2C = IF QD EQ 'Y' THEN NEW_TOTAL_AMT ELSE 0;
  QD_BOOK/D8 = IF QD EQ 'Y' THEN BOOKINGS ELSE 0;
  QD_NNROOMS/D12 = IF QD EQ 'Y' THEN NNROOMS ELSE 0;


-* YEAR  
  YR/A1 = IF (INVOICE_DATE GE ANNUAL_BEGIN1) AND
            (INVOICE_DATE LE EOM_DATE) THEN 'Y' ELSE 'N';
            
 YR_AMT/D14.2C = IF YR EQ 'Y' THEN NEW_TOTAL_AMT ELSE 0;
 YR_BOOK/D8 = IF MD EQ 'Y' THEN BOOKINGS ELSE 0;
 YR_NNROOMS/D12 = IF YR EQ 'Y' THEN NNROOMS ELSE 0;
            

END

TABLEF FILE &&EXTRACT
PRINT PNR_LOCATOR
  BOOKINGS
  CHAIN_CODE
  CHAIN_NAME
  CITY_ST
  CITY_CODE
  CITY.CITY_NAME AS 'CNAME'
  CITY.STATE_CODE AS 'CSTATE'
  CHAIN_GRP
  PROP_CITY
  PROP_CNTRY
  PROP_STATE_CD
  PROP_PHONE
  HOTEL_PHONE 	
-*  LEVEL_DESC	
  NBR_DAYS
  NBR_ROOMS
  NNROOMS	
  PROP_ZIP5
  PROP_ADDRESS 
  PROP_CODE1 AS 'PROP_CODE'
  PROP_NAME 	
  ROOM_RATE 	
  TOTAL_AMT 
  TOTAL_SLSAV
  TICKET_BRANCH
  RESV_BRANCH
  PREF_NON
  AGENT_NUM
  
-* New Property Master fields
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PROP_SABRE_CODE
  PROP_APOLLO_CODE
  CURRM
  CURRQ
  YEAR
-INCLUDE RPTPARMS
-IF &&SETF NE 'TCTHLNGS' GOTO NOLNGSWHR;
WHERE NNROOMS GE 7 OR NNROOMS LE (-7)
-NOLNGSWHR;   
 -INCLUDE &HTLDATES
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10

ON TABLE HOLD AS TC_HOLD1A 
END
-RUN


TABLE FILE TC_HOLD1A
PRINT BOOKINGS
  CHAIN_CODE
  CHAIN_NAME
  CITY_ST
  CITY_CODE
  CNAME
  CSTATE
  PROP_CITY
  PROP_STATE_CD
  PROP_PHONE
  HOTEL_PHONE 	
  NBR_DAYS
  NBR_ROOMS
  NNROOMS
  PROP_CNTRY
  PROP_ZIP5
  PROP_ADDRESS 	
  PROP_NAME 	
  ROOM_RATE 	
  TOTAL_AMT 
  TOTAL_SLSAV
  RESV_BRANCH
  TICKET_BRANCH
  PREF_NON
  AGENT_NUM
-* New Property Master fields
  PROP_CODE
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS  
  PROP_SABRE_CODE
  PROP_APOLLO_CODE 
  CURRM
  CURRQ
  YEAR
BY CHAIN_GRP
ON TABLE HOLD AS TC_HOLD1A1 FORMAT FOCUS INDEX CHAIN_GRP
END
-RUN

JOIN CHAIN_GRP IN TC_HOLD1A1 TO CHAIN_GROUP IN HTL_CGRP AS J1
-RUN

DEFINE FILE TC_HOLD1A1
CHN_GRP1/A30 = GCHN_NAME;
CHN_GRPA/A30 = IF CHN_GRP1 EQ ' ' THEN CHAIN_NAME ELSE CHN_GRP1;
CHN_GRP/A30 = UPCASE (30, CHN_GRPA, CHN_GRPA);
END
-RUN
TABLE FILE TC_HOLD1A1
PRINT BOOKINGS
  CHAIN_GRP
  CHAIN_CODE
  CHN_GRP
  CITY_ST
  CNAME
  CSTATE
  CITY_CODE
  PROP_CITY
  PROP_STATE_CD
  PROP_PHONE
  HOTEL_PHONE 	
  NBR_DAYS
  NBR_ROOMS
  NNROOMS
  PROP_ZIP5
  PROP_ADDRESS 	
  PROP_NAME 	
  ROOM_RATE 	
  TOTAL_AMT 
  TOTAL_SLSAV
  RESV_BRANCH
  TICKET_BRANCH
  PREF_NON
  AGENT_NUM
  PROP_CODE
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PROP_SABRE_CODE
  PROP_APOLLO_CODE    
  CURRM
  CURRQ
  YEAR
  BY PROP_CNTRY  
ON TABLE HOLD AS TC_HOLD1A FORMAT FOCUS INDEX PROP_CNTRY
END
-RUN


JOIN CLEAR *
-RUN
JOIN PROP_CNTRY IN TC_HOLD1A TO COUNTRY_CODE IN CITY AS J3
-RUN

DEFINE FILE TC_HOLD1A
GZONEA/A3 = GEO_ZONE;
END
TABLE FILE TC_HOLD1A
PRINT BOOKINGS
  CHAIN_GRP
  CHAIN_CODE
  CHN_GRP
  CITY_ST
  CNAME
  CSTATE
  CITY_CODE
  PROP_CITY
  PROP_STATE_CD
  PROP_PHONE
  HOTEL_PHONE 	
  NBR_DAYS
  NBR_ROOMS
  NNROOMS
  PROP_ZIP5
  PROP_ADDRESS 	
  PROP_NAME 	
  ROOM_RATE 	
  TOTAL_AMT 
  TOTAL_SLSAV
  RESV_BRANCH
  TICKET_BRANCH
  PREF_NON
  AGENT_NUM
  PROP_CODE
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PROP_SABRE_CODE
  PROP_APOLLO_CODE    
  PROP_CNTRY
  CURRM
  CURRQ
  YEAR
BY  GZONEA  
ON TABLE HOLD AS TC_HOLD1B
END
-RUN

JOIN CLEAR *
-RUN
JOIN GZONEA IN TC_HOLD1B TO GEO_ZONE IN GEO AS J3
-RUN


TABLE FILE TC_HOLD1B
PRINT BOOKINGS
  CHAIN_GRP
  CHAIN_CODE
  CHN_GRP
  CITY_ST
  CNAME
  CSTATE
  CITY_CODE
  PROP_CITY
  PROP_STATE_CD
  PROP_PHONE
  HOTEL_PHONE 	
  NBR_DAYS
  NBR_ROOMS
  NNROOMS
  PROP_ZIP5
  PROP_ADDRESS 	
  PROP_NAME 	
  ROOM_RATE 	
  TOTAL_AMT 
  TOTAL_SLSAV
  RESV_BRANCH
  TICKET_BRANCH
  PREF_NON
  AGENT_NUM
  PROP_CODE
  PROP_LANYON_ID
  PROP_LATITUDE
  PROP_LONGITUDE
  PROP_MOBIL_STARS
  PROP_AAA_DIAMONDS
  PROP_OHG_CLASS 
  PROP_SABRE_CODE
  PROP_APOLLO_CODE    
  PROP_CNTRY
  GZONEA
  GEO_NAME
  CURRM
  CURRQ
  YEAR
  ON TABLE HOLD AS TC_HOLD1
END
-RUN

-IF &LINES EQ 0 THEN GOTO NEXTONE;
-*========================================================================
-*   PROCESS EXTRACT DATA FROM STEP4 - HOLD TO FOCUS DATABASE TCTHTL       
-*========================================================================
DEFINE FILE TC_HOLD1
ROLLCD/A8 = '&&ROLL';
NMB/I5    = NMB + 1;
GZONE/A20 = GZONEA||'-'||GEO_NAME;
END
TABLE FILE TC_HOLD1
SUM BOOKINGS
    NBR_DAYS
    NBR_ROOMS
    NNROOMS	
    ROOM_RATE 	
    TOTAL_AMT 
    TOTAL_SLSAV 
BY ROLLCD
BY NMB
BY CITY_ST
BY CNAME
BY CSTATE
BY CITY_CODE
BY PROP_CITY
BY PROP_STATE_CD
BY PROP_NAME 
BY PROP_CODE
BY PROP_SABRE_CODE
BY PROP_APOLLO_CODE
BY PROP_LANYON_ID
BY PROP_LATITUDE
BY PROP_LONGITUDE
BY PROP_MOBIL_STARS
BY PROP_AAA_DIAMONDS
BY PROP_OHG_CLASS
BY PROP_ZIP5
BY PROP_ADDRESS
BY HOTEL_PHONE
BY PROP_PHONE
BY CHAIN_CODE
BY CHN_GRP
BY RESV_BRANCH
BY TICKET_BRANCH
BY PREF_NON
BY AGENT_NUM
BY GZONE
BY PROP_CNTRY
BY CURRM
BY CURRQ
BY YEAR
ON TABLE HOLD AS TCHTLHLD
END
-RUN

MODIFY FILE TCTHTL
FIXFORM FROM TCHTLHLD
MATCH ROLLCD NMB
ON MATCH REJECT
ON NOMATCH INCLUDE 
DATA ON TCHTLHLD
END
-RUN




-NEXTONE
 

 
