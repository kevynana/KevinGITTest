-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
SET ASNAMES=ON

DEFINE FILE OVSTSHLD
FARE_PAID/D12.2 = SEG_AMT + SEG_TAX ;
TKT_AMOUNT/D12.2CS = TICKET_AMT + TAX_AMT;

CY/A1 = IF TRN_DATE GE &&FROMDT.EVAL AND
           TRN_DATE LE &&TODT.EVAL THEN 'Y' ELSE 'N';
PY/A1 =  IF TRN_DATE GE &&FXDATE.EVAL AND
               TRN_DATE LE &&TXDATE.EVAL THEN 'Y' ELSE 'N';

NET_TKT_CNT/D12      = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
RSN/A30 =  IF REFUSE_CODE EQ 'AS' THEN 'Airline/Flight Spcfd' ELSE
           IF REFUSE_CODE EQ 'CX' THEN 'Alt Arpt/Connec Rjctd' ELSE
           IF REFUSE_CODE EQ 'NR' THEN 'Refused Discount' ELSE
           IF REFUSE_CODE EQ 'RQ' THEN 'Routing Requested' ELSE
           IF REFUSE_CODE EQ 'TS' THEN 'Time Specified' ELSE
           IF REFUSE_CODE EQ 'UG' THEN 'Fare due to Upgrade' 
           ELSE 'Other';

TRSN1/A5 = 'Total';
                  

-* DEFINES ON PREVIOUS DEFINES
DISSAVINGS/D12.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST;
DECLINE_AMT/D12.2CS = IF EMBARK EQ 'DT1' THEN 0 ELSE
                      TKT_AMOUNT - LOWEST_AMT;

-* DEFINES ON PREVIOUSLY DEFINED DEFINES
CLST/D12.2CS = IF CY EQ 'Y' THEN DISSAVINGS ELSE 0;
PLST/D12.2CS = IF PY EQ 'Y' THEN DISSAVINGS ELSE 0;
CTKT/D12 = IF CY EQ 'Y' THEN NET_TKT_CNT ELSE 0;
PTKT/D12 = IF PY EQ 'Y' THEN NET_TKT_CNT ELSE 0;
END
-RUN

TABLE FILE OVSTSHLD
 SUM CLST 
     CTKT 
     PLST 
     PTKT
     PCT.CTKT AS 'CPCT'
     PCT.PTKT AS 'PPCT'
BY RSN
WHERE (DECLINE_AMT GE 200) OR (DECLINE_AMT LE (-200))
ON TABLE HOLD AS OVLST1
END
-RUN

-GOTO SKIP_GRAPH
-SET &RECFOUND = &RECORDS;

-IF &RECFOUND EQ 0 GOTO SKIP_GRAPH;

GRAPH FILE OVLST1
SUM CTKT AS 'CURRENT'
    PTKT AS 'PRIOR'
BY RSN AS ' '
WHERE RSN NE 'OTHER'
ON TABLE SET GRAPHSTYLE *
setGraphType(24);
setLegendDisplay(true);
setLegendTextAutofit(true);
setLegendPosition(2);
setFontSizeAbsolute(getLegendText(),true);
setAutofit(getLegendText(),false);
setFontSize(getLegendText(),15);
setFontStyle(getLegendText(),0);
setLegendMarkerPosition(1);
setO1LabelDisplay(true);
setFontSizeAbsolute(getO1Label(),true); 
setAutofit(getO1Label(),false);
setFontStyle(getO1Label(),0);
setFontSize(getO1Label(),15);
setO1LabelRotate(0);
setO1MajorGridDisplay(true);
setO1MinorGridDisplay(false);
setFontSizeAbsolute(getY1Label(),true);
setAutofit(getY1Label(),false);
setY1LabelDisplay(true);
setY1LabelFormat(1);
setFontSize(getY1Label(),15);
setFontStyle(getY1Label(),0);
setY1AxisSide(0);
setFontSizeAbsolute(getTitle(),true); 
setAutofit(getTitle(),false);
setTitleString("Lost Savings");
setTextJustHoriz(getTitle(),1);
setFontStyle(getTitle(),0);
setFontSize(getTitle(),15);
setSubtitleString(" ");
setDataTextDisplay(false);
setSeriesFillColor(0, new Color, 0 64 128));
setSeriesFillColor(1, new Color, 115 160 247));
ENDSTYLE
ON GRAPH SAVE AS LOST FORMAT SVG
END
-RUN

-SKIP_GRAPH
-* -SET &&LST_SVG= IF &LINES GT 0 THEN 'Y' ELSE 'N';

-INCLUDE DTRANGE
-RUN

DEFINE FILE OVLST1
CATEGORY/A30 = 'Lost Savings';
CAT_ORDER/I2 = 4;
END
-RUN

TABLE FILE OVLST1
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'TKT_CURR' AND 
CLST/D15 AS 'VOL_CURR' AND CPCT AS 'PCT_CURR'
PTKT/D15 AS 'TKT_PRIOR' AND PLST/D15 AS 'VOL_PRIOR' AND 
PPCT AS 'PCT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;   
WHERE RSN EQ 'Airline/Flight Spcfd'
ON TABLE HOLD AS OVLOST1
END
-RUN


TABLE FILE OVLOST1
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR AND PCT_CURR
      AND VOL_PRIOR AND TKT_PRIOR AND PCT_PRIOR
ON TABLE HOLD AS OVLOSTA
END
MODIFY FILE OV_STAP
FIXFORM FROM OVLOSTA
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTA
END
-RUN

DEFINE FILE OVLST1
CATEGORY/A30 = 'Lost Savings';
CAT_ORDER/I2 = 4;
END
-RUN

TABLE FILE OVLST1
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'TKT_CURR' AND 
CLST/D15 AS 'VOL_CURR' AND CPCT AS 'PCT_CURR'
PTKT/D15 AS 'TKT_PRIOR' AND PLST/D15 AS 'VOL_PRIOR' AND 
PPCT AS 'PCT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
WHERE RSN EQ 'Alt Arpt/Connec Rjctd'
ON TABLE HOLD AS OVLOST2
END
-RUN

TABLE FILE OVLOST2
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR AND PCT_CURR
      AND VOL_PRIOR AND TKT_PRIOR AND PCT_PRIOR
ON TABLE HOLD AS OVLOSTB
END
MODIFY FILE OV_STAP
FIXFORM FROM OVLOSTB
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTB
END
-RUN

DEFINE FILE OVLST1
CATEGORY/A30 = 'Lost Savings';
CAT_ORDER/I2 = 4;
END
-RUN

TABLE FILE OVLST1
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'TKT_CURR' AND 
CLST/D15 AS 'VOL_CURR' AND CPCT AS 'PCT_CURR'
PTKT/D15 AS 'TKT_PRIOR' AND PLST/D15 AS 'VOL_PRIOR' AND 
PPCT AS 'PCT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
WHERE RSN EQ 'Refused Discount'
ON TABLE HOLD AS OVLOST3
END
-RUN

TABLE FILE OVLOST3
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR AND PCT_CURR
      AND VOL_PRIOR AND TKT_PRIOR AND PCT_PRIOR
ON TABLE HOLD AS OVLOSTC
END
MODIFY FILE OV_STAP
FIXFORM FROM OVLOSTC
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTC
END
-RUN

DEFINE FILE OVLST1
CATEGORY/A30 = 'Lost Savings';
CAT_ORDER/I2 = 4;
END
-RUN

TABLE FILE OVLST1
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'TKT_CURR' AND 
CLST/D15 AS 'VOL_CURR' AND CPCT AS 'PCT_CURR'
PTKT/D15 AS 'TKT_PRIOR' AND PLST/D15 AS 'VOL_PRIOR' AND 
PPCT AS 'PCT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
WHERE RSN EQ 'Routing Requested'
ON TABLE HOLD AS OVLOST4
END
-RUN

TABLE FILE OVLOST4
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR AND PCT_CURR
      AND VOL_PRIOR AND TKT_PRIOR AND PCT_PRIOR
ON TABLE HOLD AS OVLOSTD
END
MODIFY FILE OV_STAP
FIXFORM FROM OVLOSTA
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTD
END
-RUN

DEFINE FILE OVLST1
CATEGORY/A30 = 'Lost Savings';
CAT_ORDER/I2 = 4;
END
-RUN

TABLE FILE OVLST1
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'TKT_CURR' AND 
CLST/D15 AS 'VOL_CURR' AND CPCT AS 'PCT_CURR'
PTKT/D15 AS 'TKT_PRIOR' AND PLST/D15 AS 'VOL_PRIOR' AND 
PPCT AS 'PCT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
WHERE RSN EQ 'Time Specified'
ON TABLE HOLD AS OVLOST5
END
-RUN

TABLE FILE OVLOST5
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR AND PCT_CURR
      AND VOL_PRIOR AND TKT_PRIOR AND PCT_PRIOR
ON TABLE HOLD AS OVLOSTE
END
MODIFY FILE OV_STAP
FIXFORM FROM OVLOSTE
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTE
END
-RUN

DEFINE FILE OVLST1
CATEGORY/A30 = 'Lost Savings';
CAT_ORDER/I2 = 4;
END
-RUN

TABLE FILE OVLST1
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'TKT_CURR' AND 
CLST/D15 AS 'VOL_CURR' AND CPCT AS 'PCT_CURR'
PTKT/D15 AS 'TKT_PRIOR' AND PLST/D15 AS 'VOL_PRIOR' AND 
PPCT AS 'PCT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
WHERE RSN EQ 'Fare Due to Upgrade'
ON TABLE HOLD AS OVLOST6
END
-RUN

TABLE FILE OVLOST6
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR AND PCT_CURR
      AND VOL_PRIOR AND TKT_PRIOR AND PCT_PRIOR
ON TABLE HOLD AS OVLOSTF
END
MODIFY FILE OV_STAP
FIXFORM FROM OVLOSTF
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTF
END
-RUN

-GOTO SKIP
DEFINE FILE OVLST1
CATEGORY/A30 = 'Lost Savings';
CAT_ORDER/I2 = 4;
END
-RUN

TABLE FILE OVLST1
PRINT CATEGORY/A30 AND RSN/A30 AS 'ROW_LABEL' AND
CAT_ORDER/I2 AND CTKT/D15 AS 'TKT_CURR' AND 
CLST/D15 AS 'VOL_CURR' AND CPCT AS 'PCT_CURR'
PTKT/D15 AS 'TKT_PRIOR' AND PLST/D15 AS 'VOL_PRIOR' AND 
PPCT AS 'PCT_PRIOR' AND 
COMPUTE ROW_ORDER/I2 = ROW_ORDER + 1;    
WHERE RSN EQ 'Other'
ON TABLE HOLD AS OVLOST7
END
-RUN


TABLE FILE OVLOST7
PRINT CATEGORY AND ROW_LABEL AND CAT_ORDER
      AND ROW_ORDER AND VOL_CURR AND TKT_CURR AND PCT_CURR
      AND VOL_PRIOR AND TKT_PRIOR AND PCT_PRIOR
ON TABLE HOLD AS OVLOSTT
END
MODIFY FILE OV_STAP
FIXFORM FROM OVLOSTT
MATCH CATEGORY ROW_LABEL
ON MATCH REJECT
ON NOMATCH INCLUDE
DATA ON OVLOSTT
END
-RUN

-SKIP




