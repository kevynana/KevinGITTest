-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* JK Added Level2, Level3 9/16/04
-* JK Changed Level2, Level3 to carry through instead of a sort prior to the
-*    match
-* DV ADDED DOD_TYPE 'J' TO IBOOK DEFINE - 12/21/04
-* DV  ADDED CODE FOR GLOBAL CURRENCY 1/5/05
-* DV  CARRIED THROUGH LEVEL1 7/25/05
-* DV ADDED DOD_TYPE H TO IBOOK DEFINE 10/11/05
-* DV ADDED SORT BY LEVEL1 FOR CONG 4/7/08
-* Changed ITPAXTVL, ITPAXTV2, TTPAXTVL to sort by PASSNGR_NAME
-* insted of XPSNGR_NM   - Deb 5/26/10
-*1/31/14 UPDATED ONLINE/TRADITIONAL DEFINES TO USE ONLINE_TRADITIONAL FIELD INSTEAD OF DOD_TYPE
-*3/2/16 - JEM -S-16367 Updated hard coded d:\ to use &&WFSRV1.EVAL
-*7/11/16   S-20630 DLV  Added EMP_ID to extract
-*05/24/17 - DLV - S-34879  Added new routine for  TMPAXSUM 


-* FILE TOPCARPX.FEX
FILEDEF KIEWITDM DISK &&WFSRV1.EVAL\TNT\TTRACKER\TEMP\KIEWITDM.TXT

-INCLUDE SETECHO


-DEFAULT &&NOCARREC = 'N';

-* -*SET &ECHO=ALL;
SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN
-SET &CARDATES = &&WEB_PATH || 'CARDATES.fex';

DEFINE FILE &&EXTRACT

  
  LEVEL_DESC/A60 = &&LDESC;
  
  DAY_OF_WK/W = PICKUP_DATE;	
  DROP_OFF_DT/MDYY = DROP_DATE;	
  IBOOK/A13 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN 'INTERNET' ELSE
              'NON-INTERNET';
  INV_DATE/MDYY = INVOICE_DATE;
  INV_MONTH/MT = INVOICE_DATE;	
  NBR_DAYS/D12 = NUM_DAYS;
  PICK_UP_DT/MDYY = PICKUP_DATE;	
  XPICK_DOW/W   = PICKUP_DATE;
  XDROP_DOW/W   = DROP_DATE;
  NEW_RENTAL_AMT/D12.2CS = RENTAL_AMT;
  RENTAL_DAYS/D8 = IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                   ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;
  TRAN_MONTH/MT = INVOICE_DATE;
  
  XPSNGR_NM/A15        = 
  EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  
END
-RUN

TABLE FILE &&EXTRACT
PRINT
  AROLL_LEV3
  AROLL_LEV4
  AROLL_LEV6
  AROLL_LEV7
  AROLL_DSC3
  AROLL_DSC4
  AROLL_DSC7
  CURR_DATE 
  EMP_ID
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NEW_RENTAL_AMT
  PNR_LOCATOR
  NBR_DAYS
  NUM_CARS
  RENTAL_DAYS
  PASSNGR_NAME
  TRAN_MONTH
  VENDOR_NAME
  XPSNGR_NM
-INCLUDE &CARDATES   
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************

&&WHERE7
-IF &&SETF EQ 'BWPAXBR' OR 'BWPAXCN' OR 'BWPAXIT' THEN GOTO WHERE2 ELSE GOTO WHERE1;
-* &&WHERE8
-WHERE2;
&&WHERE9
-* &&WHERE10
-WHERE1;


-INCLUDE RPTPARMS

ON TABLE HOLD AS TOPCARH
END
-RUN


TABLE FILE TOPCARH
PRINT 
  AROLL_LEV3
  AROLL_LEV4
  AROLL_LEV6
  AROLL_LEV7
  AROLL_DSC3
  AROLL_DSC4
  AROLL_DSC7
  EMP_ID
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NEW_RENTAL_AMT
  PNR_LOCATOR
  NBR_DAYS
  NUM_CARS
  RENTAL_DAYS
  PASSNGR_NAME
  TRAN_MONTH
  VENDOR_NAME
  XPSNGR_NM
BY CURR_DATE
ON TABLE HOLD AS TPCARHLD FORMAT FOCUS INDEX CURR_DATE
END
-RUN

-* Global Reporting JOIN
JOIN TPCARHLD.CURR_DATE IN TPCARHLD TO GLOBAL.DATE IN GLOBAL AS J1
END

DEFINE FILE TPCARHLD

 NAMEC/A30 = CNAME;


-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
AMT_RENTALX/D20.6 = NEW_RENTAL_AMT * CURR1X;


END 

TABLE FILE TPCARHLD
PRINT 
  AROLL_LEV3
  AROLL_LEV4
  AROLL_LEV6
  AROLL_LEV7
  AROLL_DSC3
  AROLL_DSC4
  AROLL_DSC7
  CURR_DATE
  EMP_ID
  INVOICE_DATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  NEW_RENTAL_AMT
  PNR_LOCATOR
  NBR_DAYS
  NUM_CARS
  RENTAL_DAYS
  PASSNGR_NAME
  TRAN_MONTH
  VENDOR_NAME
  AMT_RENTALX/D16.2CS
  NAMEC
  XPSNGR_NM
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS TOPCARH2
END
-RUN



-SET &&SORT1 = &&RANK_LABEL1;
-SET &&SORT2 = &&RANK_LABEL2;

-IF '&&SETF.EVAL' EQ 'ITBUSUM' THEN GOTO DEBC;
-IF '&&SETF.EVAL' EQ 'TMPAXSUM' THEN GOTO TMOBC;

-SET &LVL1 = IF '&&ROLLUP.EVAL' EQ 'CRAY-R' OR 'ITRON-R' THEN EMP_ID ELSE LEVEL1;


 
-*-IF '&&SETF.EVAL' EQ 'ITPAXTVL' OR 'ITPAXTV2' OR 'TTPAXTVL' THEN GOTO NextsortC;




TABLE FILE TOPCARH2
SUM NBR_DAYS
    NUM_CARS
    RENTAL_DAYS
    NEW_RENTAL_AMT
    LEVEL2
    LEVEL3
    AMT_RENTALX/D16.2CS
    NAMEC
BY &&SORT1
BY &&SORT2
-IF '&&SETF.EVAL' NE 'CYPAXTVL' OR 'GWPAXTVL' OR 'TMPAXSUM' THEN GOTO BYSKIPC;
BY &&RANK_LABEL3
-BYSKIPC;
BY &LVL1
BY PASSNGR_NAME
ON TABLE HOLD AS HOLDCPX 
END
-RUN


-GOTO DoneCar;

-TMOBC

TABLE FILE TOPCARH2
SUM NBR_DAYS
    NUM_CARS
    RENTAL_DAYS
    NEW_RENTAL_AMT
    LEVEL2
    LEVEL3
    AMT_RENTALX/D16.2CS
    NAMEC
BY &&SORT1
BY &&SORT2
BY &&RANK_LABEL3
BY PASSNGR_NAME
ON TABLE HOLD AS HOLDCPX 
END
-RUN



-GOTO DoneCar;


-NextsortC
TABLE FILE TOPCARH2
SUM NBR_DAYS
    NUM_CARS
    RENTAL_DAYS
    NEW_RENTAL_AMT
    LEVEL2
    LEVEL3
    AMT_RENTALX/D16.2CS
    NAMEC
BY &&SORT1
BY &&SORT2
BY LEVEL1
BY XPSNGR_NM
ON TABLE HOLD AS HOLDCPX 
END
-RUN
-GOTO DoneCar;


-DEBC

DEFINE FILE TOPCARH2
FLAG/A1 = 'C';
END
TABLE FILE TOPCARH2
SUM FLAG
    NEW_RENTAL_AMT
BY &&SORT1
BY TRAN_MONTH
ON TABLE HOLD AS TPCAR
END
-RUN

-DoneCar
-IF &RECORDS NE 0 THEN GOTO XXITCAR;


-SET &&NOCARREC = 'Y';

-XXITCAR

