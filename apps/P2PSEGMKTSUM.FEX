-*1/05/17-JEM-S-23779-Created for new Bonus Point file ABP2PBS

TABLE FILE XTWO
PRINT EX_RF_FLAG
      FST_DPT_DATE 
      PASSNGR_NAME
      PNR_LOCATOR
      TKT_NUM
      TKT_SORT
      TRN_DATE
      TVL_DTE
      VAL_AIRLINE 
      EX_FLAG
      EXCHG_SALE
      TKT_SORT
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      ROLLUP_CODE
      TKT_NUM
      DIRECT
      ORG_APC
      DST_APC
      C_ITIN
      ROLLUP_CODE     
BY AIR_KEY
BY TKT_NUM
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS XTWO1 
END
-RUN

TABLE FILE MXTWO
PRINT DIR_APTS
      NDIR_APTS
BY AIR_KEY
BY TKT_NUM
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD AS MXTWO1 
END
-RUN

MATCH FILE XTWO1
PRINT EX_RF_FLAG
      FST_DPT_DATE 
      PASSNGR_NAME
      PNR_LOCATOR
      TKT_NUM
      TKT_SORT
      TRN_DATE
      TVL_DTE
      VAL_AIRLINE 
      EX_FLAG
      EXCHG_SALE
      TKT_SORT
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      ROLLUP_CODE
      TKT_NUM
      DIRECT
      ORG_APC
      DST_APC
      C_ITIN
      ROLLUP_CODE     
BY AIR_KEY
BY TKT_NUM
BY TKT_SORT
BY SEG_NBR
ON TABLE HOLD
RUN
FILE MXTWO
PRINT DIR_APTS
    NDIR_APTS
BY AIR_KEY
BY TKT_NUM
BY TKT_SORT
BY SEG_NBR
AFTER MATCH HOLD AS XTHREE OLD-AND-NEW
END
-RUN

TABLE FILE XTHREE
PRINT EX_RF_FLAG
      FST_DPT_DATE 
      PASSNGR_NAME
      PNR_LOCATOR
      TKT_NUM
      TKT_SORT
      TRN_DATE
      VAL_AIRLINE 
      EX_FLAG
      EXCHG_SALE
      TKT_SORT
      SEG_NBR
      RF_FLAG
      RES_SYS
      EXCHG_SALE
      ROLLUP_CODE
      DIRECT
      ORG_APC
      DST_APC
      C_ITIN
      DIR_APTS
      NDIR_APTS
BY ROLLUP_CODE
ON TABLE HOLD AS XFOUR FORMAT FOCUS INDEX ROLLUP_CODE
END
-RUN

TABLE FILE P2P_ROLLUP_BONUS
PRINT BACK_OFFICE_ID VENDOR BEGIN_DATE END_DATE CATEGORY_ID AS 'CAT_ID' P2P_PARMS1 P2P_PARMS2 P2P_DESCRIPTION AS 'VEND_DESC' CITY_PAIR 
BY ROLLUP_CODE
WHERE ROLLUP_CODE EQ '&&ROLLUP.EVAL'
WHERE VENDOR_TYPE EQ 'A'
ON TABLE SET ASNAMES ON
ON TABLE HOLD AS NWBONUSA FORMAT FOCUS INDEX ROLLUP_CODE
END
-RUN

-SET &PAIRRECS=IF &LINES EQ 0 THEN 'N' ELSE 'Y';
-RUN 

JOIN CLEAR *
-RUN

JOIN ROLLUP_CODE IN XFOUR TO ALL ROLLUP_CODE IN NWBONUSA AS J1
-RUN


DEFINE FILE XFOUR
P2P1F/A1 = EDIT(P2P_PARMS1, '9');
CONNECT/A1=IF P2P1F EQ 'I' THEN 'I' ELSE 
           IF P2P1F EQ 'D' THEN 'D' ELSE ' ';
P2P2F/A1 = EDIT (P2P_PARMS2, '9');
DIRNON/A1 = IF P2P2F EQ 'D' THEN 'D' ELSE 
            IF P2P2F EQ 'N' THEN 'N' ELSE ' ';
            
CP/A7=EDIT(CITY_PAIR, '9999999');
BONUS_ALNA/I5 = IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE
                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ ' ') AND (DIRNON EQ ' ') THEN 1 ELSE 0;
-* Carrier with city-pairs on flights including connections non-directional
-*                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'I') AND (DIRECT EQ 'D' OR 'I') AND (DIRNON EQ 'N') AND (NDIR_APTS EQ CITY_PAIR) THEN 1 ELSE
-*                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'I') AND (DIRECT EQ 'D' OR 'I') AND (DIRNON EQ 'N') AND (DIR_APTS EQ CITY_PAIR) THEN 1 ELSE
-* Carrier with city-pairs on flights including connections directional
-*                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'I') AND (DIRECT EQ 'D' OR 'I') AND (DIRNON EQ 'D') AND (DIR_APTS EQ CITY_PAIR) THEN 1 ELSE               
-* Carrier with city-pairs on direct flights non-directional                
-*                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'D') AND (DIRECT EQ 'D') AND (DIRNON EQ 'N') AND (NDIR_APTS EQ CITY_PAIR) THEN 1 ELSE
-*                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'D') AND (DIRECT EQ 'D') AND (DIRNON EQ 'N') AND (DIR_APTS EQ CITY_PAIR) THEN 1 ELSE
-* Carrier with city-pairs on direct flights directional                
-*                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'D') AND (DIRECT EQ 'D') AND (DIRNON EQ 'D') AND (DIR_APTS EQ CITY_PAIR) THEN 1 ELSE 0;                
                                
                
BONUS_ALNB/I5 = IF '&PAIRRECS.EVAL' EQ 'N' THEN 0 ELSE  
-* Carrier with city-pairs on flights including connections non-directional
                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'I') AND (DIRECT EQ 'D' OR 'I') AND (DIRNON EQ 'N') AND (NDIR_APTS EQ CITY_PAIR) THEN 1 ELSE
                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'I') AND (DIRECT EQ 'D' OR 'I') AND (DIRNON EQ 'N') AND (DIR_APTS EQ CITY_PAIR) THEN 1 ELSE
-* Carrier with city-pairs on flights including connections directional
                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'I') AND (DIRECT EQ 'D' OR 'I') AND (DIRNON EQ 'D') AND (DIR_APTS EQ CITY_PAIR) THEN 1 ELSE               
-* Carrier with city-pairs on direct flights non-directional                
                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'D') AND (DIRECT EQ 'D') AND (DIRNON EQ 'N') AND (NDIR_APTS EQ CITY_PAIR) THEN 1 ELSE
                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'D') AND (DIRECT EQ 'D') AND (DIRNON EQ 'N') AND (DIR_APTS EQ CITY_PAIR) THEN 1 ELSE
-* Carrier with city-pairs on direct flights directional                
                IF (VENDOR EQ VAL_AIRLINE) AND (FST_DPT_DATE FROM BEGIN_DATE TO END_DATE) AND (CONNECT EQ 'D') AND (DIRECT EQ 'D') AND (DIRNON EQ 'D') AND (DIR_APTS EQ CITY_PAIR) THEN 1 ELSE 0;                
        

END


TABLE FILE XFOUR
SUM   EX_RF_FLAG
      EX_FLAG
      EXCHG_SALE
      BONUS_ALNA
-*      BONUS_ALNB
      RF_FLAG
      VENDOR
      FST_DPT_DATE
      C_ITIN
      TRN_DATE 
      VAL_AIRLINE
      NDIR_APTS
      DIR_APTS
      CITY_PAIR
      TKT_SORT
COMPUTE BONUS_ALN1/A1 = IF BONUS_ALNA GT 0 THEN 'Y' ELSE 'N'; 
COMPUTE BONUS_ALN2/A1 = IF BONUS_ALNB GT 0 THEN 'Y' ELSE 'N';
BY PNR_LOCATOR
BY TKT_NUM
-* BY TKT_SORT
BY RES_SYS
BY CAT_ID
BY VEND_DESC
ON TABLE HOLD AS RH1
END
-RUN


DEFINE FILE RH1
          
ABONUSA/I2 = IF BONUS_ALN1 EQ 'Y' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' THEN 1 ELSE
            IF BONUS_ALN1 EQ 'Y' AND EX_FLAG EQ 'F' THEN (-1) ELSE
            IF BONUS_ALN1 EQ 'Y' AND EXCHG_SALE NE ' ' THEN 1 ELSE
            IF BONUS_ALN1 EQ 'Y' AND RF_FLAG EQ 'F' THEN (-1) ELSE 0;
            
ABONUSB/I2= IF BONUS_ALN2 EQ 'Y' AND EX_FLAG EQ ' ' AND EXCHG_SALE EQ ' ' AND EX_RF_FLAG NE 'R' THEN 1 ELSE
            IF BONUS_ALN2 EQ 'Y' AND EX_FLAG EQ 'F' THEN (-1) ELSE
            IF BONUS_ALN2 EQ 'Y' AND EXCHG_SALE NE ' ' THEN 1 ELSE
            IF BONUS_ALN2 EQ 'Y' AND RF_FLAG EQ 'F' THEN (-1) ELSE 0;
            
ABONUS/I2 = IF BONUS_ALN1 EQ 'Y' THEN ABONUSA ELSE 
            IF BONUS_ALN2 EQ 'Y' THEN ABONUSB ELSE 0;
END 

TABLE FILE RH1
PRINT ABONUS EX_FLAG EXCHG_SALE TKT_SORT
BY PNR_LOCATOR
BY TKT_NUM
-* BY TKT_SORT
BY TRN_DATE
BY RES_SYS
BY CAT_ID
BY VEND_DESC
WHERE ABONUS NE 0
ON TABLE HOLD AS AIRHLD
END
-RUN
