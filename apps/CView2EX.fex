-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**

-* File CVIEW2EX.FEX
-********************************************************************
-* MODIFICAIONS:
-********************************************************************
-*
-* This program extracts data for the series of basic car verndor listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-*
-* 7/30/02   CHANGED DEFINE OF NBR_DAYS - DB
-*03/26/04   ADDED RNTL_TYP DEFINE - DV
-*11/22/04   ADDED CODE FOR GLOBAL CURRENCY - DEB
-*2/5/14 Updated the bookings define to use num_days instead of daily_rate - JK
-*7/14/16-JEM-S-17836 Added logic for new report abtpcar which a user selects a vendor and all other vendors besides the selection are show as other vendors
-* S-28840-JEM-2/16/17-Added logic for new report ABTPCDD
-*08/15/17- JEM - S-24416 - Added logic for new report GCTPCARB - produces seperate tabs per hierarchy selected 

-********************************************************************
-INCLUDE SETECHO 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN

-IF &&SETF EQ 'ABTPCDD' GOTO TOPCDD;


-SET &CARDATES = &&WEB_PATH || 'CARDATES.fex';


DEFINE FILE &&EXTRACT
  AVG_DLY_RATE/D9.2 = IF (RENTAL_AMT LT 0) AND (NUM_DAYS LT 0)
                      THEN ((RENTAL_AMT/NUM_DAYS)*(-100)) 
                      ELSE RENTAL_AMT/NUM_DAYS; 
  ASIA/A1 = IF PICK_CTY.COUNTRY_CODE EQ 'AM' OR 'AZ' OR 'BD' OR 'BN' OR
  'CN' OR 'GE' OR 'HK' OR 'ID' OR 'IN' OR 'JP' OR 'KG' OR 'KH' OR 'KR' OR
  'KZ' OR 'LA' OR 'LK' OR 'MM' OR 'MO' OR 'MV' OR 'MY' OR 'NP' OR 'PH' OR
  'PK' OR 'SG' OR 'TH' OR 'TM' OR 'TW' OR 'UZ' OR 'VN' THEN 'Y' ELSE 'N';
  
BOOKINGS/D12 = IF NUM_DAYS GT 0 THEN 1 ELSE IF NUM_DAYS LT 0 THEN (-1) ELSE 0;
  
  CITY_ST/A35 = PICK_CTY.CITY_NAME||(' '| PICK_CTY.STATE_CODE);
  CARD_NUM/A12 = EDIT(CREDIT_CARD, '$$999999999999$$$$');   
  CARD1_NUM/A4 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$$$9999');   
  DAY_OF_WK/W = PICKUP_DATE;    
  DROP_OFF_DT/MDYY = DROP_DATE; 
  EUROPE/A1 = IF PICK_CTY.COUNTRY_CODE EQ 'AL' OR 'AM' OR 'AT' OR 'AZ' OR
  'BA' OR 'BE' OR 'BG' OR 'BY' OR 'CH' OR 'CY' OR 'CZ' OR 'DE' OR 'DK' OR
  'EE' OR 'ES' OR 'FI' OR 'FR' OR 'GB' OR 'GE' OR 'GI' OR 'GL' OR 'GR' OR 
  'HR' OR 'HU' OR 'IE' OR 'IS' OR 'IT' OR 'LT' OR 'LU' OR 'LV' OR 'MC' OR
  'MD' OR 'MK' OR 'MN' OR 'MT' OR 'NL' OR 'NO' OR 'PL' OR 'PT' OR 'RO' OR
  'RU' OR 'SE' OR 'SI' OR 'SK' OR 'TR' OR 'UA' OR 'YU' THEN 'Y' ELSE 'N';
  INV_DATE/MDYY = INVOICE_DATE; 
  LEV_2/A15 = IF PASSNGR_NAME NE LAST PASSNGR_NAME THEN LEVEL2 ELSE ' ';
  LEVEL_DESC/A80 = &&LDESC;
  NBR_CARS/D12 = NUM_CARS;
-*  NBR_DAYS/D12 = NUM_DAYS;    
  NBR_DAYS/P12CS =  IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                  ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;  
                  

  NEW_STD_RATE/D14.2C = STD_RATE;
  NEW_RENTAL_AMT/P12.2CSM = RENTAL_AMT;
                  
  PICK_UP_DT/MDYY = PICKUP_DATE;    
  PREF_NON/A15 = IF CLIENT_PREF EQ 'P' THEN 'PREFERRED' ELSE 'NON-PREFERRED';

  REFUSE_CD/A2 = EDIT(REFUSE_KEY,'$$$$$$$$99');
  RNTL_TYP/A15 = IF CAR_MAIN.PICKUP_CITY NE CAR_MAIN.DROP_CITY THEN 'ONE WAY'
              ELSE 'LOCAL'; 
  XPICK_DOW/W   = PICKUP_DATE;
  XDROP_DOW/W   = DROP_DATE;

  
-* ****DEFINES ON PREVIOUS DEFINES****
  

  PICK_DAY/A3   = DECODE XPICK_DOW (1 'MON' 2 'TUE' 3 'WED'
                        4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
  DROP_DAY/A3   = DECODE XDROP_DOW (1 'MON' 2 'TUE' 3 'WED'
                        4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
                        
  TOTAL_STD/P12.2CSM = IF ((NBR_DAYS LT 0) AND (NEW_STD_RATE LT 0)) THEN 
                        ((NBR_DAYS * NEW_STD_RATE) * (-1)) ELSE 
                        (NBR_DAYS * NEW_STD_RATE);

 -****DEFINES FOR PREFERRED/NON-PREFERRED CAR STANDARD 
 NPREF_AMT/D12.2 = IF PREF_NON EQ 'NON-PREFERRED' THEN RENTAL_AMT ELSE 0;
 NPREF_DAY/D12 = IF PREF_NON EQ 'NON-PREFERRED' THEN NBR_DAYS ELSE 0;
 NPBOOK/D12 = IF PREF_NON EQ 'NON-PREFERRED' THEN BOOKINGS ELSE 0;
 PREF_AMT/D12.2 = IF PREF_NON EQ 'PREFERRED' THEN RENTAL_AMT ELSE 0;
 PREF_DAY/D12 = IF PREF_NON EQ 'PREFERRED' THEN NBR_DAYS ELSE 0;
 PRBOOK/D12 = IF PREF_NON EQ 'PREFERRED' THEN BOOKINGS ELSE 0;
 TOTAL_SLSAV/D12.2CS = TOTAL_STD - RENTAL_AMT;
 TTL_DAY/D12 = NPREF_DAY + PREF_DAY;
 

END
-RUN


TABLEF FILE &&EXTRACT
PRINT AIRPORT_CODE  
  AIRPORT_NAME  
  ALPHA_RATE    
  AR_BRANCH
  ASIA
  AVG_DLY_RATE
  BOOKINGS
  BR_CL_IDX 
  CAR_CAT   
  CAR_DESC  
  CAR_KEY   
  CAR_RATE  
  CAR_TYPE  
  CARD_NUM  
  CARD1_NUM 
  CCR_CONFIRM
  CITY_ST
  CLIENT_PREF
  CREDIT_CARD
  CURR_DATE 
  DAILY_RATE    
  DAY_OF_WK 
  DROP_CITY 
  DROP_CTY.CITY_NAME AS 'DROP_CTY_NAME'     
  DROP_DATE     
  DROP_DAY
  DROP_OFF_DT   
  EUROPE
  INV_DATE  
  INVOICE_DATE  
  INVOICE_NUM   
  LEV_2     
  LEVEL_DESC    
  LEVEL1    
  LEVEL2    
  LEVEL3    
  NBR_DAYS  
  NBR_CARS
  NEW_RENTAL_AMT
  NUM_CARS  
  NUM_DAYS  
  PASSNGR_NAME  
  PICK_CTY.CITY_CODE AS 'CITY_CODE'
  PICK_CTY.CITY_NAME AS 'PICK_CTY_NAME' 
  PICK_CTY.COUNTRY_CODE AS 'COUNTRY'
  PICK_DAY
  PICK_UP_DT    
  PICKUP_CITY   
  PICKUP_DATE   
  PNR_LOCATOR   
  REFUSAL_DESC  
  REFUSE_CD 
  REFUSE_KEY    
  RENTAL_AMT
  RNTL_TYP  
  PICK_CTY.STATE_CODE   
  STD_RATE  
  TICKET_BRANCH 
  TKT_NUM   
  VENDOR_CODE   
  VENDOR_NAME   
-* PREF/NON FIELDS ADDED
  NPREF_AMT
  NPREF_DAY
  PREF_AMT
  PREF_DAY
  PREF_NON
  TOTAL_SLSAV
  TTL_DAY
  NPBOOK
  PRBOOK
  

-INCLUDE &CARDATES    
-*WHERE INVOICE_DATE GE &&FROMDT.EVAL AND INVOICE_DATE LE &&TODT.EVAL
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS
ON TABLE HOLD AS CAR_HOLD
END


TABLE FILE CAR_HOLD
PRINT AIRPORT_CODE  
  AIRPORT_NAME  
  ALPHA_RATE    
  AR_BRANCH
  ASIA
  AVG_DLY_RATE
  BOOKINGS
  BR_CL_IDX 
  CAR_CAT   
  CAR_DESC  
  CAR_KEY   
  CAR_RATE  
  CAR_TYPE  
  CARD_NUM  
  CARD1_NUM 
  CCR_CONFIRM 
  CITY_ST
  CREDIT_CARD
  COUNTRY
  DAILY_RATE    
  DAY_OF_WK 
  DROP_CITY 
  DROP_CTY_NAME     
  DROP_DATE     
  DROP_DAY
  DROP_OFF_DT   
  EUROPE
  INV_DATE  
  INVOICE_DATE  
  INVOICE_NUM   
  LEV_2     
  LEVEL_DESC    
  LEVEL1    
  LEVEL2    
  LEVEL3    
  NBR_DAYS
  NBR_CARS
  NEW_RENTAL_AMT 
  NUM_CARS  
  NUM_DAYS  
  PASSNGR_NAME  
  PICK_CTY_NAME 
  PICK_DAY
  PICK_UP_DT    
  PICKUP_CITY   
  PICKUP_DATE   
  PNR_LOCATOR   
  REFUSAL_DESC  
  REFUSE_CD 
  REFUSE_KEY    
  RENTAL_AMT
  RNTL_TYP  
  STATE_CODE    
  STD_RATE  
  TICKET_BRANCH 
  TKT_NUM   
  VENDOR_CODE   
  VENDOR_NAME
  NPREF_AMT
  NPREF_DAY
  PREF_AMT
  PREF_DAY
  PREF_NON
  TOTAL_SLSAV
  TTL_DAY
  NPBOOK
  PRBOOK
BY CURR_DATE
ON TABLE HOLD AS CARHLD1 FORMAT FOCUS INDEX CURR_DATE
END
-RUN


-* Global Reporting JOIN
JOIN CARHLD1.CURR_DATE IN CARHLD1 TO GLOBAL.DATE IN GLOBAL AS J1
END

DEFINE FILE CARHLD1

 NAMEC/A30 = CNAME;

-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES
AMT_RENTALX/D20.6 = RENTAL_AMT * CURR1X;
RATE_DLYX/D20.6 = DAILY_RATE * CURR1X;

END

TABLE FILE CARHLD1
  PRINT 
  AIRPORT_CODE  
  AIRPORT_NAME  
  ALPHA_RATE    
  AR_BRANCH
  ASIA
  AVG_DLY_RATE
  BOOKINGS
  BR_CL_IDX 
  CAR_CAT   
  CAR_DESC  
  CAR_KEY   
  CAR_RATE  
  CAR_TYPE  
  CARD_NUM  
  CARD1_NUM 
  CCR_CONFIRM
  CITY_ST
  COUNTRY
  CREDIT_CARD
  CURR_DATE
  DAILY_RATE    
  DAY_OF_WK 
  DROP_CITY 
  DROP_CTY_NAME     
  DROP_DATE     
  DROP_DAY
  DROP_OFF_DT   
  EUROPE
  INV_DATE  
  INVOICE_DATE  
  INVOICE_NUM   
  LEV_2     
  LEVEL_DESC    
  LEVEL1    
  LEVEL2    
  LEVEL3    
  NBR_DAYS  
  NBR_CARS
  NEW_RENTAL_AMT
  NUM_CARS  
  NUM_DAYS  
  PASSNGR_NAME  
  PICK_CTY_NAME 
  PICK_DAY
  PICK_UP_DT    
  PICKUP_CITY   
  PICKUP_DATE   
  PNR_LOCATOR   
  REFUSAL_DESC  
  REFUSE_CD 
  REFUSE_KEY    
  RENTAL_AMT
  RNTL_TYP  
  STATE_CODE    
  STD_RATE  
  TICKET_BRANCH 
  TKT_NUM   
  VENDOR_CODE   
  VENDOR_NAME
  NAMEC
  AMT_RENTALX/D16.2CS
  RATE_DLYX/D16.2CS
  NPREF_AMT
  NPREF_DAY
  PREF_AMT
  PREF_DAY
  PREF_NON
  TOTAL_SLSAV
  TTL_DAY  
  NPBOOK
  PRBOOK
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS CARHLD2
END
-RUN


-GOTO XXIT;

-TOPCDD;

DEFINE FILE &&EXTRACT
  CURRENT/A1 = IF INVOICE_DATE GE &&FROMDT.EVAL AND
                  INVOICE_DATE LE &&TODT.EVAL THEN 'Y' ELSE 'N';
  PRIOR/A1 =   IF INVOICE_DATE GE &&FXDATE.EVAL AND
                INVOICE_DATE LE &&TXDATE.EVAL THEN 'Y' ELSE 'N';
                
  AVG_DLY_RATE/D9.2 = IF (RENTAL_AMT LT 0) AND (NUM_DAYS LT 0)
                      THEN ((RENTAL_AMT/NUM_DAYS)*(-100)) 
                      ELSE RENTAL_AMT/NUM_DAYS; 
  ASIA/A1 = IF PICK_CTY.COUNTRY_CODE EQ 'AM' OR 'AZ' OR 'BD' OR 'BN' OR
  'CN' OR 'GE' OR 'HK' OR 'ID' OR 'IN' OR 'JP' OR 'KG' OR 'KH' OR 'KR' OR
  'KZ' OR 'LA' OR 'LK' OR 'MM' OR 'MO' OR 'MV' OR 'MY' OR 'NP' OR 'PH' OR
  'PK' OR 'SG' OR 'TH' OR 'TM' OR 'TW' OR 'UZ' OR 'VN' THEN 'Y' ELSE 'N';
  
BOOKINGS/D12 = IF NUM_DAYS GT 0 THEN 1 ELSE IF NUM_DAYS LT 0 THEN (-1) ELSE 0;
  
  CITY_ST/A35 = PICK_CTY.CITY_NAME||(' '| PICK_CTY.STATE_CODE);
  CARD_NUM/A12 = EDIT(CREDIT_CARD, '$$999999999999$$$$');   
  CARD1_NUM/A4 = EDIT(CREDIT_CARD, '$$$$$$$$$$$$$$9999');   
  DAY_OF_WK/W = PICKUP_DATE;    
  DROP_OFF_DT/MDYY = DROP_DATE; 
  EUROPE/A1 = IF PICK_CTY.COUNTRY_CODE EQ 'AL' OR 'AM' OR 'AT' OR 'AZ' OR
  'BA' OR 'BE' OR 'BG' OR 'BY' OR 'CH' OR 'CY' OR 'CZ' OR 'DE' OR 'DK' OR
  'EE' OR 'ES' OR 'FI' OR 'FR' OR 'GB' OR 'GE' OR 'GI' OR 'GL' OR 'GR' OR 
  'HR' OR 'HU' OR 'IE' OR 'IS' OR 'IT' OR 'LT' OR 'LU' OR 'LV' OR 'MC' OR
  'MD' OR 'MK' OR 'MN' OR 'MT' OR 'NL' OR 'NO' OR 'PL' OR 'PT' OR 'RO' OR
  'RU' OR 'SE' OR 'SI' OR 'SK' OR 'TR' OR 'UA' OR 'YU' THEN 'Y' ELSE 'N';
  INV_DATE/MDYY = INVOICE_DATE; 
  LEV_2/A15 = IF PASSNGR_NAME NE LAST PASSNGR_NAME THEN LEVEL2 ELSE ' ';
  LEVEL_DESC/A60 = &&LDESC; 
  NBR_CARS/D12 = NUM_CARS;
-*  NBR_DAYS/D12 = NUM_DAYS;    
  NBR_DAYS/P12CS =  IF (NUM_DAYS LT 0) AND (NUM_CARS LT 0) THEN
                  ((NUM_DAYS * NUM_CARS) * (-1)) ELSE NUM_DAYS * NUM_CARS;  
                  

  NEW_STD_RATE/D14.2C = STD_RATE;
  NEW_RENTAL_AMT/P12.2CSM = RENTAL_AMT;
                  
  PICK_UP_DT/MDYY = PICKUP_DATE;    

  REFUSE_CD/A2 = EDIT(REFUSE_KEY,'$$$$$$$$99');
  RNTL_TYP/A15 = IF CAR_MAIN.PICKUP_CITY NE CAR_MAIN.DROP_CITY THEN 'ONE WAY'
              ELSE 'LOCAL'; 
  XPICK_DOW/W   = PICKUP_DATE;
  XDROP_DOW/W   = DROP_DATE;

  
-* ****DEFINES ON PREVIOUS DEFINES****
  CBOOK/P12 = IF CURRENT EQ 'Y' THEN BOOKINGS ELSE 0;
  PBOOK/P12 = IF PRIOR EQ 'Y' THEN BOOKINGS ELSE 0;
  CCAR_AMT/D12.2CSM = IF CURRENT EQ 'Y' THEN NEW_RENTAL_AMT ELSE 0;
  PCAR_AMT/D12.2CSM = IF PRIOR EQ 'Y' THEN NEW_RENTAL_AMT ELSE 0;
  CCAR_DAYS/P12 = IF CURRENT EQ 'Y' THEN NBR_DAYS ELSE 0;
  PCAR_DAYS/P12 = IF PRIOR EQ 'Y' THEN NBR_DAYS ELSE 0;

  PICK_DAY/A3   = DECODE XPICK_DOW (1 'MON' 2 'TUE' 3 'WED'
                        4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
  DROP_DAY/A3   = DECODE XDROP_DOW (1 'MON' 2 'TUE' 3 'WED'
                        4 'THU' 5 'FRI' 6 'SAT' 7 'SUN');
                        
  TOTAL_STD/P12.2CSM = IF ((NBR_DAYS LT 0) AND (NEW_STD_RATE LT 0)) THEN 
                        ((NBR_DAYS * NEW_STD_RATE) * (-1)) ELSE 
                        (NBR_DAYS * NEW_STD_RATE);

 -****DEFINES FOR PREFERRED/NON-PREFERRED CAR STANDARD 
  PERIOD/A7 = IF CURRENT EQ 'Y' THEN 'PERIOD1' ELSE 
              IF PRIOR EQ 'Y' THEN 'PERIOD2' ELSE ' '; 
  PREF_NON/A1 = IF CLIENT_PREF EQ 'P' THEN 'P' ELSE 'N';
  PREF_NON1/A15 = IF CLIENT_PREF EQ 'P' THEN 'PREFERRED' ELSE 'NON-PREFERRED';

 
 
 NPREF_AMT/D12.2 = IF PREF_NON1 EQ 'NON-PREFERRED' THEN RENTAL_AMT ELSE 0;
 NPREF_DAY/D12 = IF PREF_NON1 EQ 'NON-PREFERRED' THEN NBR_DAYS ELSE 0;
 NPBOOK/D12 = IF PREF_NON1 EQ 'NON-PREFERRED' THEN BOOKINGS ELSE 0;
 PREF_AMT/D12.2 = IF PREF_NON1 EQ 'PREFERRED' THEN RENTAL_AMT ELSE 0;
 PREF_DAY/D12 = IF PREF_NON1 EQ 'PREFERRED' THEN NBR_DAYS ELSE 0;
 PRBOOK/D12 = IF PREF_NON1 EQ 'PREFERRED' THEN BOOKINGS ELSE 0;
 TOTAL_SLSAV/D12.2CS = TOTAL_STD - RENTAL_AMT;
 TTL_DAY/D12 = NPREF_DAY + PREF_DAY;
 
 

END
-RUN


TABLEF FILE &&EXTRACT
PRINT AIRPORT_CODE  
  AIRPORT_NAME  
  ALPHA_RATE    
  AR_BRANCH
  ASIA
  AVG_DLY_RATE
  BOOKINGS
  BR_CL_IDX 
  CAR_CAT   
  CAR_DESC  
  CAR_KEY   
  CAR_RATE  
  CAR_TYPE  
  CARD_NUM  
  CARD1_NUM 
  CCR_CONFIRM
  CITY_ST
  CLIENT_PREF
  CREDIT_CARD
  CURR_DATE 
  DAILY_RATE    
  DAY_OF_WK 
  DROP_CITY 
  DROP_CTY.CITY_NAME AS 'DROP_CTY_NAME'     
  DROP_DATE     
  DROP_DAY
  DROP_OFF_DT   
  EUROPE
  INV_DATE  
  INVOICE_DATE  
  INVOICE_NUM   
  LEV_2     
  LEVEL_DESC    
  LEVEL1    
  LEVEL2    
  LEVEL3    
  NBR_DAYS AS 'NMBR_DAYS'
  NBR_CARS
  NEW_RENTAL_AMT AS 'CAR_AMT'
  NUM_CARS  
  NUM_DAYS  
  PASSNGR_NAME  
  PERIOD
  PICK_CTY.CITY_CODE AS 'CITY_CODE'
  PICK_CTY.CITY_NAME AS 'PICK_CTY_NAME' 
  PICK_CTY.COUNTRY_CODE AS 'COUNTRY'
  PICK_DAY
  PICK_UP_DT    
  PICKUP_CITY   
  PICKUP_DATE   
  PNR_LOCATOR   
  REFUSAL_DESC  
  REFUSE_CD 
  REFUSE_KEY    
  RENTAL_AMT
  RNTL_TYP  
  PICK_CTY.STATE_CODE   
  STD_RATE  
  TICKET_BRANCH 
  TKT_NUM   
  VENDOR_CODE   
  VENDOR_NAME   
-* PREF/NON FIELDS ADDED
  NPREF_AMT
  NPREF_DAY
  PREF_AMT
  PREF_DAY
  PREF_NON
  TOTAL_SLSAV
  TTL_DAY
  NPBOOK
  PRBOOK
  CCAR_AMT
  CCAR_DAYS
  PCAR_AMT
  PCAR_DAYS
  CBOOK
  PBOOK
  PREF_NON

-* -INCLUDE &CARDATES    
WHERE INVOICE_DATE GE &&FROMDT.EVAL AND INVOICE_DATE LE &&TODT.EVAL OR
      INVOICE_DATE GE &&FXDATE.EVAL AND INVOICE_DATE LE &&TXDATE.EVAL
-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
&&WHERE5
&&WHERE6
&&WHERE7
&&WHERE8
&&WHERE9
&&WHERE10


-INCLUDE RPTPARMS
ON TABLE HOLD AS CAR_HOLD
END
-RUN




-XXIT;