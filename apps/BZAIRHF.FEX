-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-* File BZAIRHF.FEX
-********************************************************************

-********************************************************************
-*
-* This program extracts data for the series of basic ticket listing
-* reports.  Based on the user profile selected, one of many report
-* formats will be produced.  
-* CREATED FROM TKTAIR 4/9/12 - DEB
-*1/28/14 UPDATED ONLINE/TRADITIONAL DEFINES TO USE ONLINE_TRADITIONAL FIELD INSTEAD OF DOD_TYPE
-* ADDED TRANTYPE INCLUDE - JK 12/16/14 STORY ID S-06492

-********************************************************************
-INCLUDE SETECHO
 

SET ASNAMES = ON
-SET HOLDATTR = ON;
-RUN


-SET &AIRDATES = &&WEB_PATH || 'AIRDATES.fex';
-SET &WHATDATE = IF '&&DATETYPE.EVAL' EQ 'I' THEN 'TRN_DATE' ELSE 'FST_DPT_DATE';
DEFINE FILE &&EXTRACT
  AIRLN/A30 = AIRLINE_NAME;
  CCA_CARD/A7 = EDIT(CREDIT_CARD, '99$$$$$$$$$$99999');
  CHG_COD/A47 = IF LEVEL3 NE ' ' AND LEVEL2 NE ' ' THEN
                    LEVEL1  || '-' || LEVEL2 || '-' ||LEVEL3 ELSE
                    IF LEVEL3 EQ ' ' AND LEVEL2 NE ' ' THEN
                    LEVEL1  || '-' || LEVEL2 ELSE
                    IF LEVEL3 EQ ' ' AND LEVEL2 EQ ' ' THEN LEVEL1;
  CC/A2 = EDIT(CREDIT_CARD, '99$$$$$$$$$$$$$$$$');
  CCNUM2/A4 = IF CC EQ 'AX' THEN EDIT(CREDIT_CARD,'$$$$$$$$$$$$$9999$')
             ELSE EDIT(CREDIT_CARD, '$$$$$$$$$$$$$$9999');
  CTY1/A25 = CITYPAIR.EMBARK;
  CTY2/A25 = CITYPAIR.ROUTE;
  FARE_PAID/D12.2CS   = SEG_AMT + SEG_TAX;
  LEVEL_DESC/A60 = &&LDESC;
  OTFLAG/A15 = IF ONLINE_TRADITIONAL EQ 'ONLINE' THEN 'ONLINE' ELSE 'TRADITIONAL';
  NET_TKT_CNT/D8CS    = IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (FARE_PAID GE 0) AND
                           (SEG_COUNT EQ 1) AND 
                           (CONJ_REL EQ 1) THEN 1 ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND 
                           (EX_FLAG EQ 'F') THEN (-1) ELSE 
                        IF (TICKET_CODE EQ '1') AND
                           (SEG_NBR EQ '01') AND
                           (RF_FLAG EQ 'F') THEN (-1) ELSE 0;
  NEW_ADV_PURCH/D9    = ADV_PURCH;
  NEW_SEG_DISC/D12.2CS = SEG_DISCOUNT;
                         
  TKT_TYPE/A4          = IF (SEG_COUNT LE 0) AND
                          (RF_FLAG EQ 'P') THEN 'P-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (RF_FLAG EQ 'F') THEN 'F-RF' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'P') THEN 'P-EX' ELSE
                        IF (SEG_COUNT LE 0) AND 
                          (EX_FLAG EQ 'F') THEN 'F-EX' ELSE ' ';
  XDPT_DT/MDYY         = DPT_DATE;
  XPSNGR_NM/A15        = 
    EDIT(PASSNGR_NAME,'999999999999999$$$$$$$$$$$$$$$$$$');
  XTRAN_DT/MDYY        = TRN_DATE;

-***DEFINES ON PREVIOUS DEFINES
  AIRLINE_FEE/D12.2CS = IF EMBARK EQ 'FP2' OR 'FP3' 
  THEN FARE_PAID ELSE 0;
WRCC4/A1 = IF CREDIT_CARD CONTAINS 'CA540510XXXXXX3300' OR 
               'CA540510XXXXXX6207' OR 'CA540510XXXXXX6199' OR
               'CA540510XXXXXX6181' THEN 'Y' ELSE 'N'; 
  DISSAVINGS/D11.2CS  = IF EMBARK EQ 'DT1' THEN 0 ELSE
                         FARE_PAID - SEG_LOWEST;               
  VASAVINGS/D12.2CS    = NEW_SEG_DISC - FARE_PAID;
FDATE/MDYY = FST_DPT_DATE;  

-INCLUDE TRANTYPE                         
END



TABLEF FILE &&EXTRACT
PRINT AIR_KEY 
  AIRCRAFT_TYPE AS 'AIRT'
  AIRLN  
  AIRLINE_FEE  
  AIRCRAFT_TYPE
  CCA_CARD
  CC_NUM
  CCNUM2
  CHG_COD
  CLASS
  CONJ_REL
  DISSAVINGS
  EMB_CTY.CITY_NAME AS 'CITY1' 
  EX_FLAG
  FARE_PAID
  FDATE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  LEVEL4
  NET_TKT_CNT 
  NEW_ADV_PURCH
  OTFLAG
  PASSNGR_NAME
  PNR_LOCATOR
  REFUSE_CODE
  RF_FLAG
  RTE_CTY.CITY_NAME AS 'CITY2'
  SEG_COUNT
  SEG_NBR
  SEG_LOWEST
  TICKET_CODE
  TKT_DATE
  TKT_NUM
  TKT_SORT
  TKT_TYPE
  TRN_DATE
  VASAVINGS
  &WHATDATE
  TRIP_PURPOSE
  XDPT_DT   
  XTRAN_DT   
  XPSNGR_NM
  EMB_APT.GEO_ZONE AS 'GEO_ZONE'

-INCLUDE BYHIERARCHY
-INCLUDE &AIRDATES
WHERE VOID_DATE EQ 0

-********************************************************************
-* Where statements to select data specified in user profile
-********************************************************************
&&WHERE1
&&WHERE2
&&WHERE3
&&WHERE4
-*&&WHERE5
-*&&WHERE6
-* &&WHERE7
-* &&WHERE8
-* &&WHERE9
-* &&WHERE10

-INCLUDE RPTPARMS
ON TABLE HOLD AS &&RPT_HOLD
END
-RUN


TABLE FILE &&RPT_HOLD
PRINT AIR_KEY
  AIRLN  
  AIRLINE_FEE
  AIRT
  CCA_CARD
  CC_NUM
  CCNUM2
  CHG_COD
  CLASS
  CONJ_REL  
  CITY1  
  DISSAVINGS
  EX_FLAG
  FARE_PAID
  FDATE
  GEO_ZONE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  LEVEL4
  NET_TKT_CNT 
  NEW_ADV_PURCH
  OTFLAG
  PASSNGR_NAME
  PNR_LOCATOR
  REFUSE_CODE
  RF_FLAG
  CITY2
  SEG_COUNT
  SEG_NBR
  SEG_LOWEST
  TICKET_CODE
  TRN_DATE
  TKT_NUM
  TKT_SORT
  TKT_TYPE 
  VASAVINGS
  &WHATDATE
  TRIP_PURPOSE
  XDPT_DT  
  XTRAN_DT  
  XPSNGR_NM
-INCLUDE BYHIERARCHY      
BY TKT_DATE 
ON TABLE HOLD AS AIRHOLD1 FORMAT FOCUS INDEX TKT_DATE
END
-RUN


-* Global Reporting JOIN
JOIN AIRHOLD1.TKT_DATE IN AIRHOLD1 TO GLOBAL.DATE IN GLOBAL AS J1
END

DEFINE FILE AIRHOLD1
NAMEC/A30 = CNAME;

-******************************************************************************
-*                         Global Currency Conversion Defines
-******************************************************************************
CURR1X/D20.6 = 1 / USDPU ;

-* DEFINES ON PREVIOUS DEFINES	
PAID_FAREX/D20.6 = FARE_PAID * CURR1X;
FEEX/D20.6 = AIRLINE_FEE * CURR1X;
END
 
TABLE FILE AIRHOLD1
PRINT 
  AIR_KEY
  AIRLN AS 'NAME'
  AIRLINE_FEE AS 'FEE'
  AIRT
  CCA_CARD
  CC_NUM
  CCNUM2
  CHG_COD
  CLASS
  CONJ_REL
  CITY1
  DISSAVINGS
  EX_FLAG
  FARE_PAID
  FDATE
  GEO_ZONE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3 
  LEVEL4
  NET_TKT_CNT 
  NEW_ADV_PURCH
  OTFLAG
  PASSNGR_NAME
  PNR_LOCATOR
  REFUSE_CODE
  RF_FLAG
  CITY2
  SEG_COUNT
  SEG_NBR
  SEG_LOWEST
  TICKET_CODE
  TKT_DATE
  TKT_NUM
  TKT_SORT
  TKT_TYPE AS 'TYPE'
  TRN_DATE
  &WHATDATE AS 'WHAT_DATE'
  TRIP_PURPOSE
  VASAVINGS
  XDPT_DT AS 'DATE'
  XTRAN_DT AS 'TRAN_DATE'
  XPSNGR_NM
  NAMEC
  PAID_FAREX
  FEEX
WHERE GLOBAL.COUNTRYCODE EQ '&&CURRENCY'
ON TABLE HOLD AS AIRHOLD2
END
-RUN
 

-INCLUDE RETUDID
-RUN

EX UDBOOZHF
-RUN

  


TABLE FILE HFHOLD
SUM FARE_PAID AS 'AMOUNT'
    PAID_FAREX/D16.2CS AS 'GAMOUNT'
    NET_TKT_CNT/D12 AS 'TTL_COUNT'
    DISSAVINGS AS 'LOST_AMT'
    SEG_LOWEST/D12.2CS AS 'LOW_AMT'
    VASAVINGS AS 'VASAV'
BY LEVEL_DESC 
BY PASSNGR_NAME
BY TKT_SORT
BY WHAT_DATE
ON TABLE HOLD AS HOLD3
END
-RUN


TABLE FILE HFHOLD
PRINT AIRT
  CCA_CARD
  CC_NUM
  CCNUM2
  CHG_COD
  CITY1
  CITY2
  CLASS
  CONJ_REL
  DATE
  EX_FLAG
  FARE_PAID
  FDATE
  FEE
  FEEX/D16.2CS
  GEO_ZONE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  NAME
  NET_TKT_CNT
  NEW_ADV_PURCH
  OTFLAG
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  REFUSE_CODE
  SEG_COUNT
  TICKET_CODE
  TKT_NUM
  TRAN_DATE  
  TRIP_PURPOSE
  TYPE
   NAMEC
  PAID_FAREX/D16.2CS 
  HOME_F1
BY LEVEL_DESC 
BY PASSNGR_NAME NOPRINT
BY TKT_SORT  
BY WHAT_DATE
BY SEG_NBR   
ON TABLE HOLD AS XTWO
END
-RUN


MATCH FILE XTWO
PRINT AIRT
  CCA_CARD
  CC_NUM
  CCNUM2
  CHG_COD
  CITY1
  CITY2
  CLASS
  CONJ_REL
  DATE
  EX_FLAG
  FARE_PAID
  FDATE
  FEE
  FEEX
  GEO_ZONE
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  NAME
  NET_TKT_CNT
  NEW_ADV_PURCH
  OTFLAG
  PASSNGR_NAME
  PNR_LOCATOR
  RF_FLAG
  REFUSE_CODE
  SEG_COUNT
  TICKET_CODE
  TKT_NUM
  TRAN_DATE  
  TRIP_PURPOSE
  TYPE
  NAMEC
  PAID_FAREX
  HOME_F1
BY LEVEL_DESC 
BY PASSNGR_NAME NOPRINT
BY TKT_SORT   
BY WHAT_DATE
BY SEG_NBR   
ON TABLE HOLD
RUN
FILE HOLD3
PRINT
  AMOUNT
  GAMOUNT
  LOST_AMT
  TTL_COUNT
  LOW_AMT
  VASAV
BY LEVEL_DESC 
BY PASSNGR_NAME   
BY TKT_SORT  
BY WHAT_DATE  
AFTER MATCH HOLD AS XTHREE OLD-OR-NEW
END
-RUN


DEFINE FILE XTHREE
 REC_CNT/D8CS = IF NET_TKT_CNT EQ 1 THEN 1 ELSE 0;
  TTLDAYS/D8 = NEW_ADV_PURCH*REC_CNT;
  
END                    
TABLE FILE XTHREE
SUM NET_TKT_CNT AS 'PTTKT'
REC_CNT
TTLDAYS
COMPUTE PADV1/P8 = IF ((REC_CNT LT 1) AND (REC_CNT GT (-1))) THEN 0 ELSE 
            (TTLDAYS/REC_CNT); 
BY LEVEL_DESC 
BY PASSNGR_NAME
BY TKT_NUM
ON TABLE HOLD AS PHOLDONE
END
-RUN

 



MATCH FILE XTHREE
PRINT AIRT
  AMOUNT
  CCA_CARD
  CC_NUM
  CCNUM2
  CHG_COD
  CITY1
  CITY2
  CLASS
  CONJ_REL
  DATE
  EX_FLAG
  FARE_PAID
  FDATE
  FEE
  FEEX
  GEO_ZONE
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LOST_AMT
  LOW_AMT
  NAME
  NET_TKT_CNT
  OTFLAG
  PNR_LOCATOR
  REFUSE_CODE
  RF_FLAG
  SEG_COUNT
  SEG_NBR
  TICKET_CODE
  TTL_COUNT
  TKT_SORT
  TRAN_DATE  
  TRIP_PURPOSE
  TYPE
  VASAV
  GAMOUNT
  NAMEC
  PAID_FAREX 
  HOME_F1
BY LEVEL_DESC  
BY PASSNGR_NAME  
BY TKT_NUM 
ON TABLE HOLD  
RUN
FILE PHOLDONE
SUM PADV1
BY LEVEL_DESC
BY PASSNGR_NAME
BY TKT_NUM
AFTER MATCH HOLD AS AIRHOLD3 OLD-OR-NEW
END
-RUN

DEFINE FILE AIRHOLD3

FLAG/A1 = 'A';
SEG/A2 = SEG_NBR;
TSORT/A11 = TKT_SORT;
PADV/P9S = IF TKT_NUM NE LAST TKT_NUM THEN PADV1 ELSE 0;
END
TABLE FILE AIRHOLD3
PRINT 
  PASSNGR_NAME
  PNR_LOCATOR
  TRAN_DATE
  TKT_NUM
  TSORT
  TYPE
  SEG
  NAME
  DATE
  AIRT
  CITY1
  CITY2
  FARE_PAID AS 'AMOUNT'
  FDATE
  GAMOUNT
  FEE
  FEEX
  TTL_COUNT
  LEVEL_DESC
  LEVEL1
  LEVEL2
  LEVEL3
  LEVEL4
  LOST_AMT
  LOW_AMT
  NAMEC
  GEO_ZONE
  TRIP_PURPOSE
  CHG_COD
  PADV 
  OTFLAG
  CCA_CARD
  CC_NUM
  REFUSE_CODE
  VASAV
  CLASS
  CCNUM2
  HOME_F1
BY FLAG 
ON TABLE HOLD AS HOLDA FORMAT FOCUS
END
-RUN





-SET &&BZNOAIR = IF &RECORDS EQ 0 THEN 'Y' ELSE 'N';