-*****************THIS HEADER REPRESENTS THE 80 CHARACTER MAXIUM FOR PROGRAMS**
-INCLUDE SETECHO
-* File HVIEW2SM.FEX
-**********************************************************************
-*DATE           NAME               DESCRIPTION
-*7/31/00      IBISTL-KR            ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERSM
-*8/18/00      IBISTL-KR            INCLUDE STYLESHEET PARAMS FOR 
-*                                  DRILLABLE REPORTS.
-*6/19/02      STEVE/DEB            COMMENTED OUT DRILLABLE STYLESHEET
-*07/03/02   STEVE              CHANGED TO eTTek Review and Copyright
-*9/20/04    JK                 ADDED PROP_NAME
-*12/16/04       Joy                Added code for Kwtopha to run seperate
-*12/30/04   DEB                ADDED CODE FOR GLOBAL CURRENCY
-*3/28/13    DEB                CARRIED THROUGH NBR_DAYS SO THE AVG STAY
-*                              COULD BE CHANGED IN SETFILE TO USE THIS FIELD
-*                              INSTEAD OF NNROOMS - 
-*11/25/15  Joy    S-07987  Corrected for running Currency Enabled Version

-**********************************************************************

SET ASNAMES = ON
-RUN

-* -SET &&RANK_METH = 'NBR_DAYS';
-* -SET &&RANK_LIMIT =  50;

-IF &&CURRENCY EQ 'USD' THEN GOTO NEXT;


-SET &&SUBHEAD = <NAMEC;
-SET &TAMT_CUR = 'TOTAL,ROOM,AMOUNT, (' | &&CURRENCY || ')';
-SET &CAVG_CUR = 'AVG,DAILY,RATE, (' | &&CURRENCY || ')';
-SET &CSV_CUR = 'SAVINGS, (' | &&CURRENCY || ')';
-SET &&S_SUBJ3='GTOTAL_AMT/D16.2CS AS ' | '''&TAMT_CUR.EVAL''' ;
-SET &&S_SUBJ8='COMPUTE AVGAMT/D12.2= IF (GTOTAL_AMT LT 0) AND';
-SET &&S_SUBJ9='(NNROOMS LT 0) THEN ((GTOTAL_AMT/NNROOMS)*(-1)) ELSE';
-SET &&S_SUBJ10='IF ((NNROOMS LT 1) AND (NNROOMS GT (-1))) THEN 0 ELSE';
-SET &&S_SUBJ11='GTOTAL_AMT/NNROOMS; AS ' | '''&CAVG_CUR.EVAL''';
-SET &&S_SUBJ13='TOTAL_SLSAV AS ' | '''&CSV_CUR.EVAL''' ;

-NEXT;


-IF &&SETF EQ 'ABTPGCHN' OR 'CGTPGCHN' THEN GOTO GROUP;

-IF &&SETF EQ 'KWTOPHA' THEN GOTO PROP ELSE GOTO CHAIN;


-CHAIN
TABLE FILE HTLTOPCH
SUM NNROOMS
    NBR_DAYS AS 'NUMDYS'
    NNROOMS AS 'NBR_DAYS'
    NEW_ROOM_RATE AS 'ROOM_RATE'
    TOTAL_ROOM_AMT AS 'TOTAL_AMT'
    AMT_TOTALX/D16.2CS AS 'GTOTAL_AMT'
    RATE_ROOMX/D16.2CS AS 'GROOM_RATE'
    TOTAL_SLSAV
    TOTAL_STD
    BOOKINGS
    NAMEC
BY CHAIN_NAME
ON TABLE HOLD AS HOLD1
END
-RUN



TABLE FILE HOLD1
PRINT NNROOMS
      NBR_DAYS
      NUMDYS
      ROOM_RATE
      TOTAL_AMT
      BOOKINGS
      CHAIN_NAME
      GROOM_RATE
      GTOTAL_AMT
      TOTAL_SLSAV
      TOTAL_STD
      NAMEC
RANKED BY HIGHEST &&RANK_METH
ON TABLE HOLD AS RNKHLD2
END
-RUN


DEFINE FILE RNKHLD2
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE  
                     IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                        ARANK;
  RANK_LABEL1/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2
                      ELSE ' ';
  RANK_LABEL3/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3
                      ELSE ' ';
NOWTOD/A8 WITH RANK = HHMMSS (NOWTOD);
END
-GOTO report;

-GROUP


JOIN CHAIN_GROUP IN HTLTOPCH TO CHAIN_GROUP IN HTL_CGRP AS J1
-RUN


TABLE FILE HTLTOPCH
SUM BOOKINGS	
    NBR_DAYS AS 'NUMDYS'
    NNROOMS	
    NNROOMS/D8 AS 'NBR_DAYS'	
    NEW_TOTAL_AMT/D12.2 AS 'ROOM_AMT'
    TOTAL_AMT/D12.2
   CHAIN_CODE
   GCHN_NAME
   PREF_NON
BY CHAIN_GROUP
BY CHAIN_NAME
-IF '&&SETF.EVAL' EQ 'CGTPGCHN' THEN GOTO SkipSort;
BY PREF_NON
-SkipSort
ON TABLE HOLD AS HOLD1
END
-RUN

JOIN CHAIN_GROUP IN HOLD1 TO CHAIN_GROUP IN HTL_CGRP AS J1
-RUN

DEFINE FILE HOLD1
CHN_GRP/A3 = IF CHAIN_GROUP EQ ' ' THEN 'XX' ELSE CHAIN_GROUP;
GRC_NAME/A30 = IF GCHN_NAME EQ ' ' THEN 'ALL OTHER' ELSE GCHN_NAME;
GCHN_NM/A30 = LCWORD (30, GRC_NAME, GCHN_NM);
END
TABLE FILE HOLD1
SUM BOOKINGS
    NUMDYS
    NNROOMS
    NBR_DAYS
    ROOM_AMT
    TOTAL_AMT
    CHN_GRP
    CHAIN_CODE
    GCHN_NM
    PREF_NON
BY CHAIN_NAME
-IF '&&SETF.EVAL' EQ 'CGTPGCHN' THEN GOTO SkipSort2;
BY PREF_NON
-SkipSort2
ON TABLE HOLD AS HOLD2
END
-RUN


TABLE FILE HOLD2
SUM &&RANK_METH  
BY GCHN_NM
ON TABLE HOLD AS RHOLD1 
END
-RUN


TABLE FILE RHOLD1
PRINT &&RANK_METH
RANKED BY HIGHEST &&RANK_METH AS 'DAYS_RANK'
BY GCHN_NM
ON TABLE HOLD AS RHOLD2
END
-RUN

 MATCH FILE HOLD2
 PRINT PREF_NON
     BOOKINGS
     NBR_DAYS 
     NUMDYS
     ROOM_AMT
     TOTAL_AMT
     CHN_GRP 
     NNROOMS
     GCHN_NM
     CHAIN_NAME
     CHAIN_CODE
 BY GCHN_NM
 ON TABLE HOLD
 RUN
 FILE RHOLD2
 SUM DAYS_RANK
 BY GCHN_NM
 AFTER MATCH HOLD AS HOLD2 OLD-OR-NEW
 END
-RUN

TABLE FILE HOLD2
PRINT PREF_NON
    BOOKINGS
    NBR_DAYS 
    NUMDYS
    ROOM_AMT
    TOTAL_AMT
    CHN_GRP 
     NNROOMS
    CHAIN_NAME
    GCHN_NM
    CHAIN_CODE
RANKED BY HIGHEST DAYS_RANK
ON TABLE HOLD AS RNKHLD1
END
-RUN



DEFINE FILE RNKHLD1
-*  ORG_LIMIT/I4 = &&RANK_LIMIT2 ;
  ORG_LIMIT/I4 = 19;
  OLIMIT/A4    = EDIT(ORG_LIMIT) ;
  CRANK/D5     = RANK;
  BRANK/A6     = FTOA(CRANK, '(D5)', 'A6');
  LIST/D6 = IF GCHN_NM NE LAST GCHN_NM THEN (LAST LIST + 1) 
    ELSE LAST LIST;
  FRANKX/A7 = FTOA(LIST, '(D6)', 'A7');
  FRANK/A6  = EDIT(FRANKX,'$999999'); 
  ORG_VALUE/A6 = IF ORG_LIMIT EQ 0 THEN BRANK ELSE
               IF LIST GT ORG_LIMIT THEN 'OTHER' ELSE FRANK;
 
       
END

TABLE FILE RNKHLD1
PRINT BOOKINGS
      NBR_DAYS
      NUMDYS
      NNROOMS
      ROOM_AMT
      TOTAL_AMT
      PREF_NON
      CHAIN_NAME
      DAYS_RANK
      OLIMIT	
      ORG_LIMIT
      CHN_GRP
      CHAIN_CODE
BY ORG_VALUE
BY GCHN_NM
ON TABLE HOLD AS RHOLD2
END
-RUN

TABLE FILE RHOLD2
SUM &&RANK_METH
RANKED BY HIGHEST &&RANK_METH AS 'HTL_RANK'
BY CHAIN_NAME
ON TABLE HOLD AS RHOLD3
END
-RUN


MATCH FILE RHOLD2
PRINT BOOKINGS
    NBR_DAYS 
    NUMDYS
    ROOM_AMT
    TOTAL_AMT
    CHN_GRP 
    NNROOMS
    PREF_NON
    ORG_VALUE
    DAYS_RANK
    OLIMIT
    ORG_LIMIT
    PREF_NON
    GCHN_NM
    CHAIN_CODE
BY CHAIN_NAME
ON TABLE HOLD
RUN
FILE RHOLD3
SUM HTL_RANK
BY CHAIN_NAME
AFTER MATCH HOLD AS XTWO OLD-OR-NEW
END
-RUN

TABLE FILE XTWO
PRINT *
BY GCHN_NM
RANKED BY HIGHEST HTL_RANK
BY CHAIN_NAME
ON TABLE HOLD AS HOLD3
END
-RUN

DEFINE FILE HOLD3
  DRANK/D5      = RANK ;
  ARANKX/A6     = FTOA(DRANK, '(D5)', 'A6');
  ARANK/A5      = EDIT(ARANKX,'$99999');
  RANK_LIMIT/I5 = &&RANK_LIMIT ;
  RANK_VALUE/A5 = IF (RANK_LIMIT EQ 0) THEN (ARANK) ELSE
                 IF RANK GT RANK_LIMIT THEN 'OTHER' ELSE ARANK;
  CHN_NM/A30 = IF RANK_VALUE NE 'OTHER' THEN CHAIN_NAME ELSE 'All Other';                 
  CHAIN_CD/A2 = IF RANK_VALUE NE 'OTHER' THEN CHAIN_CODE ELSE ' ';
END


TABLE FILE HOLD3
SUM
    BOOKINGS
    NBR_DAYS 
    NUMDYS
    ROOM_AMT 
    TOTAL_AMT
    CHN_GRP 
    NNROOMS
    DAYS_RANK
    OLIMIT
    ORG_LIMIT
    PREF_NON
    HTL_RANK
    CHAIN_CD
BY ORG_VALUE
BY GCHN_NM
BY RANK_VALUE
BY CHN_NM
BY PREF_NON
ON TABLE HOLD AS HOLD4
END
-RUN


TABLE FILE HOLD4
PRINT     BOOKINGS
    NBR_DAYS 
    NUMDYS
    ROOM_AMT
    TOTAL_AMT
    CHN_GRP 
    NNROOMS
    DAYS_RANK
    OLIMIT
    ORG_LIMIT
    PREF_NON
    HTL_RANK
    CHAIN_CD
    ORG_VALUE
    GCHN_NM
    RANK_VALUE
BY CHN_NM
RANKED BY HIGHEST &&RANK_METH
BY PREF_NON
ON TABLE HOLD AS RNKHLD2
END
-RUN
 

DEFINE FILE RNKHLD2
  DRANK/D5      = RANK ;
  ARANKX/A6     = FTOA(DRANK, '(D5)', 'A6');
  ARANK/A5      = EDIT(ARANKX,'$99999');
  HTL_LIMIT/I5 = &&RANK_LIMIT ;
  HTL_VAL/A5 = IF (HTL_LIMIT EQ 0) THEN (ARANK) ELSE
                 IF RANK GT HTL_LIMIT THEN 'OTHER' ELSE ARANK;
NOWTOD/A8 WITH RANK = HHMMSS (NOWTOD);
 
END
TABLE FILE RNKHLD2
PRINT     BOOKINGS
    NBR_DAYS 
    NUMDYS
    ROOM_AMT 
    TOTAL_AMT
    CHN_GRP 
    NNROOMS
    DAYS_RANK
    OLIMIT
    ORG_LIMIT

    HTL_RANK
    CHAIN_CD
    NOWTOD
BY ORG_VALUE
BY GCHN_NM
BY RANK_VALUE
BY CHN_NM
BY HTL_VAL
BY PREF_NON
ON TABLE HOLD AS DEBTEST
END
-RUN

-report

-**********************************************************************
-*DATE           NAME               DESCRIPTION
-*7/31/00      IBISTL-KR            ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERSM
-**********************************************************************


-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADER' ELSE 'HDREXLS'; 
-SET &&PASTYS = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE &&SMSTY;
-RUN 

TABLE FILE RNKHLD2
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
    &&S_SUBJ1
    &&S_SUBJ2
    &&S_SUBJ3
    &&S_SUBJ4
    &&S_SUBJ5
    &&S_SUBJ6
    &&S_SUBJ7
    &&S_SUBJ8
    &&S_SUBJ9
    &&S_SUBJ10
    &&S_SUBJ11
    &&S_SUBJ12
    &&S_SUBJ13
    &&S_SUBJ14
    &&S_SUBJ15
    &&S_SUBJ16
    &&S_SUBJ17
    &&S_SUBJ18
    &&S_SUBJ19
    &&S_SUBJ20
    
    
-*BY
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
-*ON
   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10


-INCLUDE FOOTERSM
ON TABLE COLUMN-TOTAL
-*ON TABLE SET STYLE &&SMSTY
-**********************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**********************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT

ON TABLE SET STYLE *

-INCLUDE &&PASTYS

-**********************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/18/00      IBISTL-KR            INCLUDE STYLESHEET PARAMS FOR 
-*                                  DRILLABLE REPORTS.
-**********************************************************************
-* -IF &&DRILLABLE EQ 'N' GOTO SKIP_DRILL;

-IF &&OUTFMT EQ 'EXCEL' THEN GOTO SKIPTHIS;


-INCLUDE &&DSTY

-SKIPTHIS

-SKIP_DRILL

ENDSTYLE
&&OUTLINE1
&&SUMMDEST
&&OUTLINE2
END
-RUN

-IF &&DRILLABLE EQ 'Y' GOTO SKIP_R3;

EX REPORT_3

-SKIP_R3
-GOTO XXIT

-PROP
TABLE FILE HTLTOPCH
SUM NNROOMS
    NNROOMS AS 'NBR_DAYS'
    NEW_ROOM_RATE AS 'ROOM_RATE'
    TOTAL_ROOM_AMT AS 'TOTAL_AMT'
    BOOKINGS
BY PROP_NAME
ON TABLE HOLD AS HOLD1
END
-RUN



TABLE FILE HOLD1
PRINT NNROOMS
      NBR_DAYS
      ROOM_RATE
      TOTAL_AMT
      BOOKINGS
      PROP_NAME
RANKED BY HIGHEST &&RANK_METH
ON TABLE HOLD AS RNKHLD2
END
-RUN


DEFINE FILE RNKHLD2
  DRANK/D9 = RANK;
  ARANKX/A11 = FTOA(DRANK, '(D9)', 'A11');
  ARANK/A9 = EDIT(ARANKX,'$$999999999');
  RANK_VALUE/A9 = IF &&RANK_LIMIT EQ 0 THEN ARANK ELSE  
                     IF RANK GT &&RANK_LIMIT THEN 'ALL OTHER' ELSE 
                        ARANK;
  RANK_LABEL1/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL1
                      ELSE ' ';
  RANK_LABEL2/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL2
                      ELSE ' ';
  RANK_LABEL3/A60 = IF RANK_VALUE NE 'ALL OTHER' THEN &&RANK_LABEL3
                      ELSE ' ';


-**********************************************************************
-*DATE           NAME               DESCRIPTION
-*7/31/00      IBISTL-KR            ADDED DEFINE FOR NOWTOD WHICH IS 
-*                                  USED IN FOOTERSM
-**********************************************************************
END

-SET &&PAHDR = IF '&&OUTFMT.EVAL' EQ 'PDF' OR 'PPT' OR 'COM' THEN 'HEADER' ELSE 'HDREXLS'; 
-SET &&PASTYS = IF '&&OUTFMT.EVAL' NE 'PDF' OR 'PPT' OR 'COM' THEN 'SMEXL' ELSE &&SMSTY;
-RUN

TABLE FILE RNKHLD2
-INCLUDE &&PAHDR
"&&SUBHEAD"
-IF &&PAHDR EQ 'HDREXLS' GOTO NOSPC;
"</2"
-NOSPC;
    &&S_SUBJ1
    &&S_SUBJ2
    &&S_SUBJ3
    &&S_SUBJ4
    &&S_SUBJ5
    &&S_SUBJ6
    &&S_SUBJ7
    &&S_SUBJ8
    &&S_SUBJ9
    &&S_SUBJ10
    
-*BY
   &&S_TARG1
   &&S_TARG2
   &&S_TARG3
   &&S_TARG4
   &&S_TARG5
   &&S_TARG6
   &&S_TARG7
   &&S_TARG8
   &&S_TARG9
   &&S_TARG10
-*ON
   &&SUMM_ON1
   &&SUMM_ON2
   &&SUMM_ON3
   &&SUMM_ON4
   &&SUMM_ON5
   &&SUMM_ON6
   &&SUMM_ON7
   &&SUMM_ON8
   &&SUMM_ON9
   &&SUMM_ON10

-INCLUDE FOOTERSM
ON TABLE COLUMN-TOTAL
-*ON TABLE SET STYLE &&SMSTY
-**********************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/11/00      IBISTL-SB            CHANGED THE SET STYLE STATEMENT 
-*                                  WITH AN INCLUDE
-**********************************************************************
ON TABLE PAGE-BREAK AND SUBFOOT
-INCLUDE SBFOOT

ON TABLE SET STYLE *

-INCLUDE &&PASTYS

-**********************************************************************
-*DATE           NAME               DESCRIPTION OF CHANGE
-*----           ----               ---------------------
-*8/18/00      IBISTL-KR            INCLUDE STYLESHEET PARAMS FOR 
-*                                  DRILLABLE REPORTS.
-**********************************************************************
-* -IF &&DRILLABLE EQ 'N' GOTO SKIP_DRILL;







-INCLUDE &&DSTY



-SKIP_DRILL

ENDSTYLE
&&OUTLINE1
&&SUMMDEST
&&OUTLINE2
END
-RUN

-IF &&DRILLABLE EQ 'Y' GOTO SKIP_R4;

EX REPORT_3

-SKIP_R4


-XXIT
